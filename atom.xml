<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Kyle&#39;s Blog</title>
  
  
  <link href="https://cyborg2077.github.io/atom.xml" rel="self"/>
  
  <link href="https://cyborg2077.github.io/"/>
  <updated>2024-11-24T11:19:48.293Z</updated>
  <id>https://cyborg2077.github.io/</id>
  
  <author>
    <name>Kyle Violet</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å¦‚ä½•DIYä¸€ä¸ªQQæ™ºèƒ½ä½“</title>
    <link href="https://cyborg2077.github.io/2024/11/16/QQAgentDIY/"/>
    <id>https://cyborg2077.github.io/2024/11/16/QQAgentDIY/</id>
    <published>2024-11-16T12:42:30.000Z</published>
    <updated>2024-11-24T11:19:48.293Z</updated>
    
    <content type="html"><![CDATA[<h1>èµ·å› </h1><ul><li>æ•…äº‹çš„èµ·å› æ˜¯è¿™æ ·çš„ï¼Œç¬¨è›‹æ¥ æ¥ ä¸å¥½å¥½å­¦ä¹ ï¼Œæ¯å¤©åˆ°å®¶å°±èººåºŠä¸Šç©æ‰‹æœºã€‚éœ€è¦æˆ‘æ¯å¤©ç£ä¿ƒå¥¹ã€‚äºæ˜¯ä¹å°±æƒ³çœ‹ä¸€ä¸‹QQæœºå™¨äººç›¸å…³æŠ€æœ¯ï¼Œç„¶ååšä¸ªå®šæ—¶ä»»åŠ¡å°±å¥½äº†ï¼Œæ¯•ç«Ÿæ‡’æ‰æ˜¯ç¬¬ä¸€ç”Ÿäº§åŠ›ï¼Œå¦‚æœè®©æˆ‘æ¯å¤©æ‰‹åŠ¨å‘çš„è¯ï¼Œé•¿æ­¤ä»¥å¾€ä¼šç´¯æ­»çš„ã€‚</li></ul><h1>åˆæ­¥è°ƒç ”</h1><h2 id="go-cqhttp">go-cqhttp</h2><div class="tag link"><a class="link-card" title="go-cqhttp" href="https://github.com/Mrs4s/go-cqhttp"><div class="left"><img src="https://github.githubassets.com/favicons/favicon.png"/></div><div class="right"><p class="text">go-cqhttp</p><p class="url">https://github.com/Mrs4s/go-cqhttp</p></div></a></div><blockquote><p>Mrs4s commented on Oct 10, 2023<br>ç”±äºQQå®˜æ–¹é’ˆå¯¹åè®®åº“çš„å›´è¿½å µæˆª æŒç»­ğŸ‘ŠğŸ” , ä¸æ–­æ›´æ–°åŠ å¯†æ–¹æ¡ˆ, æˆ‘ä»¬å·²æ— åŠ›ç»§ç»­ç»´æŠ¤æ­¤é¡¹ç›®.<br>åœ¨æœªæ¥ sign-server æ–¹æ¡ˆå½»åº•è¢«å®˜æ–¹å°æ­»ä¹‹å go-cqhttp å°†æ— æ³•ç»§ç»­ä½¿ç”¨.<br>åŒæ—¶NTQQçš„å‡ºç°è®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®˜æ–¹ å®Œç¾ å®ç°çš„åè®®å®ç°æ¥ç»§ç»­å¼€å‘Bot, ä¸å†æ‹…å¿ƒç”±äºåè®®å®ç°ä¸å®Œç¾è€Œå¯¼è‡´è¢«è¯†åˆ«.<br>æˆ‘ä»¬å»ºè®®æ‰€æœ‰QQBoté¡¹ç›®å¼€å§‹åšå¥½è¿ç§»è‡³æ— å¤´NTQQæˆ–ç±»ä¼¼åŸºäºå®˜æ–¹å®¢æˆ·ç«¯æŠ€æœ¯çš„å‡†å¤‡ä»¥åº”å¯¹æœªæ¥çš„å½»åº•å°é”,<br>å¦‚æœä½ çš„ go-cqhttp è¿˜èƒ½ç»§ç»­ä½¿ç”¨, ä¸å»ºè®®ç«‹å³è¿ç§», ä½†è¯·å¼€å§‹é˜…è¯»ç›¸å…³æ–‡æ¡£å¹¶åšå¥½è¿ç§»å‡†å¤‡</p><p>æ¨èé¡¹ç›®:</p><del>å¦‚æœä½ æƒ³åœ¨ç”µè„‘/æœåŠ¡å™¨ä¸Šéƒ¨ç½²bot -> https://chronocat.vercel.app/blog/0050</del><del>å¦‚æœä½ æƒ³åœ¨Android æ‰‹æœº/æ¨¡æ‹Ÿå™¨ä¸Šéƒ¨ç½²bot -> https://github.com/linxinrao/Shamrock</del><del>ä»¥ä¸Šé¡¹ç›®å‡ä¸ºè°ƒç”¨å®˜æ–¹åè®®å®ç°</del><p>ä»¥ä¸Šé¡¹ç›®å‡è¢«è¯·å–èŒ¶äº†ï¼Œåªèƒ½è¯´æœ‰ç¼˜å†è§äº†.</p><p>ç›¸å…³é—®é¢˜å¯ä»¥åœ¨è¿™ä¸ªissueä¸‹è®¨è®º</p><p>åè®®åº“çš„æ—¶ä»£å·²ç»è¿‡å», æ¥ä¸‹æ¥æ˜¯Hookå®˜æ–¹å®¢æˆ·ç«¯çš„æ—¶ä»£äº†, æ„Ÿè°¢å¤§å®¶ä¸‰å¹´æ¥çš„æ”¯æŒ</p><del>å…¶å®go-cqhttpé¡¹ç›®æœ€åˆåªæ˜¯æƒ³åšä¸€ä¸ªèƒ½åœ¨è·¯ç”±å™¨ä¸Šè·‘çš„é…·Q</del><p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>ä»€ä¹ˆæ˜¯æ— å¤´NTQQ?</p><p>ä¼—æ‰€å‘¨çŸ¥, QQå®˜æ–¹æœ€æ–°æ¨å‡ºçš„ NTQQ å®¢æˆ·ç«¯ä½¿ç”¨äº† electron æŠ€æœ¯, è¯¥æŠ€æœ¯å¯ä»¥éå¸¸æ–¹ä¾¿çš„è·¨å¹³å°åŒæ—¶ä½¿ç”¨å‰ç«¯å·²æœ‰çš„æŠ€æœ¯æ ˆè¿›è¡Œå®¢æˆ·ç«¯å¼€å‘.<br>NTQQ å®¢æˆ·ç«¯é¡¹ç›®åˆ†ä¸ºå‰åç«¯ä¸¤ä¸ªéƒ¨åˆ†, å‰ç«¯æ˜¯ä½¿ç”¨ Web æŠ€æœ¯å¼€å‘çš„ UI ç•Œé¢ä¾›ç”¨æˆ·äº¤äº’ï¼Œåç«¯ä½¿ç”¨ nodejs addons æŠ€æœ¯åŒ…è£…äº†ä¸€ä¸ªåº“æ¥å¤„ç†å®¢æˆ·ç«¯é€»è¾‘å’Œä¸æœåŠ¡ç«¯é€šä¿¡ (wrapper.node).<br>è¿™ä¸ªåº“çš„ä½œç”¨å’Œ go-cqhttp éå¸¸ç›¸ä¼¼, æ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥å°†å‰ç«¯åˆ é™¤åªä¸è¿™ä¸ªåº“äº¤äº’, å¹¶å¼•å‡º API æ¥ä¸ºæˆ‘ä»¬çš„BotæœåŠ¡.<br>ä»æœåŠ¡ç«¯è§†è§’æ¥è¯´æˆ‘ä»¬çš„ Bot å’Œæ­£å¸¸å®¢æˆ·ç«¯ä¸€æ ·, å› ä¸ºéƒ½æ˜¯é€šè¿‡ wrapper.node ä¸æœåŠ¡ç«¯é€šä¿¡. å¹¶ä¸”ç”±äºæ˜¯å®˜æ–¹æ ¹æ®å†…éƒ¨æ–‡æ¡£å¼€å‘çš„æ¨¡å—, æˆ‘ä»¬å¯ä»¥è¯´è¿™æ˜¯ä¸€ä¸ª å®Œç¾ çš„ go-cqhttp.</p><p>ä¼˜ç‚¹: æ— å¤´æ¨¡å¼ä¸‹ç›¸å¯¹ä½çš„å ç”¨.<br>ç¼ºç‚¹: å¯èƒ½ä¼šå—æœªæ¥QQæ›´æ–°çš„å½±å“.</p><p>Shamrocké¡¹ç›®æ˜¯ä»€ä¹ˆåŸç†?</p><p>Shamrock é¡¹ç›®ä½¿ç”¨ xposed çš„ hook æŠ€æœ¯æ¥å®ç°è¿œç¨‹æ“ä½œ AndroidQQ å®¢æˆ·ç«¯.<br>ä¼˜ç‚¹: ä¸å®¹æ˜“å—æœªæ¥æ›´æ–°å°å µçš„å½±å“.<br>ç¼ºç‚¹: éœ€è¦è¿è¡Œä¸€ä¸ªå®Œæ•´ AndroidOS ç¯å¢ƒ.</p><p>å¦‚æœä½ çš„æœåŠ¡å™¨èµ„æºè¶³å¤Ÿå……è¶³, æˆ‘ä¸ªäººå»ºè®®è§‚æœ›å¹¶è·Ÿè¿› Shamrock é¡¹ç›®. xposed æ˜¯ä¹…ç»è€ƒéªŒä¸”ç”Ÿæ€å®Œå–„çš„æŠ€æœ¯.</p></blockquote><h2 id="mirai">mirai</h2><div class="tag link"><a class="link-card" title="mirai" href="https://github.com/mamoe/mirai"><div class="left"><img src="https://github.githubassets.com/favicons/favicon.png"/></div><div class="right"><p class="text">mirai</p><p class="url">https://github.com/mamoe/mirai</p></div></a></div><ul><li>mirai æ˜¯ä¸€ä¸ªåœ¨å…¨å¹³å°ä¸‹è¿è¡Œï¼Œæä¾› QQ Android åè®®æ”¯æŒçš„é«˜æ•ˆç‡æœºå™¨äººåº“ã€‚</li><li>ä¹ä¸€çœ‹å¥½åƒè¿˜æ²¡å‡‰ï¼Œé‚å°è¯•äº†ä¸€ç•ªï¼Œç»è¿‡ç£•ç£•ç»Šç»Šä¹‹åï¼Œè™½è¯´å¯ä»¥æ”¶å‘æ¶ˆæ¯ï¼Œä½†æ˜¯ç›¸å½“ä¸ç¨³å®šï¼Œè€Œä¸”è¿˜æœ‰å°å·çš„é£é™©<br><img src="https://s21.ax1x.com/2024/11/16/pA2XQoj.png" alt=""></li><li>ä¸€çœ‹è®ºå›ï¼Œä¹Ÿæ˜¯é£ä¸­æ®‹çƒ›äº†ï¼Œé‚æ”¾å¼ƒã€‚</li></ul><h2 id="R-I-P">R.I.P</h2><ul><li>æ–°æ—¶ä»£å·²ç»æ²¡æœ‰èƒ½æ‰¿è½½ä»–ä»¬çš„èˆ¹äº†</li></ul><h1>LLOneBot</h1><div class="tag link"><a class="link-card" title="LLOneBot" href="https://github.com/LLOneBot/LLOneBot"><div class="left"><img src="https://github.githubassets.com/favicons/favicon.png"/></div><div class="right"><p class="text">LLOneBot</p><p class="url">https://github.com/LLOneBot/LLOneBot</p></div></a></div><ul><li>ç”±äºåœ¨go-cqhttpä¸­ï¼Œä½œè€…æåˆ°äº†QQæœ€æ–°é€€å‡ºçš„NTQQå®¢æˆ·ç«¯ï¼Œè€Œæˆ‘å¾ˆä¹…ä¹‹å‰å°±å·²ç»è£…è¿‡LiteLoaderQQNTè¿™ä¸ªæ’ä»¶äº†ã€‚é‚£ä¹ˆè‚¯å®šæœ‰åŸºäºè¿™ä¸ªæ–°å®¢æˆ·ç«¯å¼€å‘çš„æœºå™¨äººæŠ€æœ¯å§ï¼Œç„¶åå°±æ‰¾åˆ°äº†è¿™ä¸ªé¡¹ç›®ï¼ŒçœŸæ˜¯ç›¸è§æ¨æ™šå•Šï¼Œå‰é¢ä¸¤ä¸ªæ—§æ—¶ä»£çš„æ®‹å…šæˆ‘èŠ±äº†ä¸€ä¸ªæ™šä¸Šæ‹æ¸…äº†æ¥é¾™å»è„‰ï¼Œæµªè´¹äº†å®è´µçš„8å°æ—¶æ‰“æ¸¸æˆæ—¶é—´ï¼Œä¸‹æ¬¡æˆ‘è¦æ›´å¿«æ›´å¼ºã€‚</li><li>è£…å¥½æ’ä»¶é…ç½®å¥½åï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦ä¿®æ”¹è¿™å‡ ä¸ªåœ°æ–¹</li></ul><p><img src="https://s21.ax1x.com/2024/11/17/pARPvAf.png" alt=""></p><h2 id="æ”¶å‘æ¶ˆæ¯">æ”¶å‘æ¶ˆæ¯</h2><ul><li>è¿™ä¸ªæ˜¯LLOneBotç»™å‡ºçš„æ”¶å‘æ¶ˆæ¯çš„ç¤ºä¾‹</li></ul><div class="tabs" id="å‘é€æ¶ˆæ¯"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#å‘é€æ¶ˆæ¯-1">å‘é€æ¶ˆæ¯</button></li><li class="tab"><button type="button" data-href="#å‘é€æ¶ˆæ¯-2">æ¥å—æ¶ˆæ¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="å‘é€æ¶ˆæ¯-1"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">request: Request</span>):</span><br><span class="line">    data = <span class="keyword">await</span> request.json()  <span class="comment"># è·å–äº‹ä»¶æ•°æ®</span></span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    uvicorn.run(app, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure><ul><li>è¿è¡Œè¿™ä¸ª Python ä»£ç åï¼Œä¼šåœ¨æœ¬åœ° 8080 ç«¯å£å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡</li><li>å½“æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒLLOneBot ä¼šå‘ <a href="http://localhost:8080/">http://localhost:8080/</a> å‘é€ POST JSON è¯·æ±‚ï¼Œå…·ä½“äº‹ä»¶æ•°æ®å¯ä»¥æŸ¥çœ‹ äº‹ä»¶</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å‘é€æ¶ˆæ¯-2"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">requests.post(<span class="string">&#x27;http://localhost:3000/send_private_msg&#x27;</span>, json=&#123;</span><br><span class="line">    <span class="string">&#x27;user_id&#x27;</span>: <span class="number">123456</span>,</span><br><span class="line">    <span class="string">&#x27;message&#x27;</span>: [&#123;</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;text&#x27;</span>: <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>å…¶ä¸­ send_private_msg æ˜¯ OneBot V11 çš„ å‘é€ç§èŠæ¶ˆæ¯ APIï¼Œå…·ä½“ API å¯ä»¥æŸ¥çœ‹ API æ–‡æ¡£</li><li>user_id æ˜¯ QQ å·ï¼Œmessage æ˜¯æ¶ˆæ¯å†…å®¹</li><li>è¿™é‡Œä»¥æ–‡æœ¬æ¶ˆæ¯æ ¼å¼ä¸ºä¾‹ï¼Œtype è¡¨ç¤ºæ¶ˆæ¯ç±»å‹ï¼Œtype: text è¡¨ç¤ºæ–‡æœ¬æ¶ˆæ¯ï¼Œdata æ˜¯æ¶ˆæ¯å†…å®¹ï¼Œtext è¡¨ç¤ºæ–‡æœ¬å†…å®¹</li><li>æ›´å¤šçš„æ¶ˆæ¯å†…å®¹çš„æ ¼å¼å¯ä»¥æŸ¥çœ‹ æ¶ˆæ¯ç±»å‹</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>æœ‰äº†æœ€æœ€åŸºç¡€çš„æ”¶å‘æ¶ˆæ¯çš„èƒ½åŠ›äº†ï¼Œå‰©ä¸‹çš„å°±å¥½è¯´äº†ï¼Œæ¥æ”¶æ¥ æ¥ çš„æ¶ˆæ¯ï¼Œåˆ¤æ–­å…¶æ„å›¾ï¼Œå¦‚æœæ˜¯å·²ç»ä¸‹ç­åˆ°å®¶ï¼Œé‚£ä¹ˆå‘å»¶è¿Ÿé˜Ÿåˆ—ä¸­æ’å…¥ä¸€æ¡æé†’å­¦ä¹ çš„ä»»åŠ¡ï¼Œ2å°æ—¶åè§¦å‘å³å¯ã€‚å¯¹äºæ„å›¾åˆ¤æ–­ï¼Œå¯ä»¥æ¥å…¥å¤§æ¨¡å‹æ¥å®ç°ï¼ŒåŒæ—¶å¤§æ¨¡å‹ä¹Ÿä¼šç»™å‡ºæ›´æ¸©é¦¨çš„å›ç­”ï¼ˆå²‚å¯ä¿®ï¼Œé‚£æ¥ æ¥ åˆ°åº•æ˜¯ä¼šæ›´å–œæ¬¢AIä¸€ç‚¹è¿˜æ˜¯æ›´å–œæ¬¢æˆ‘ä¸€ç‚¹ï¼‰ã€‚</li></ul><h2 id="æ¥å…¥å¤§æ¨¡å‹">æ¥å…¥å¤§æ¨¡å‹</h2><ul><li>æ—¢ç„¶å·²ç»å¯ä»¥æ”¶å‘æ¶ˆæ¯äº†ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„å°±æ˜¯æ¥å…¥å¤§æ¨¡å‹APIï¼Œæ¸©é¦¨æé†’ä¸€ä¸‹æ¥ æ¥ è¯¥å­¦ä¹ å•¦ã€‚</li></ul><div class="tabs" id="ä»£ç å®ç°"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä»£ç å®ç°-1">main.py</button></li><li class="tab"><button type="button" data-href="#ä»£ç å®ç°-2">models.py</button></li><li class="tab"><button type="button" data-href="#ä»£ç å®ç°-3">logging_config.py</button></li><li class="tab"><button type="button" data-href="#ä»£ç å®ç°-4">config.yaml</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä»£ç å®ç°-1"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> Msg</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> logging_config <span class="keyword">import</span> setup_logging</span><br><span class="line"></span><br><span class="line">setup_logging()</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_config</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&quot;config.yaml&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        <span class="keyword">return</span> yaml.safe_load(file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_llm</span>(<span class="params">api_key</span>):</span><br><span class="line">    client = OpenAI(</span><br><span class="line">        api_key=api_key,</span><br><span class="line">        base_url=<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> client</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">config = load_config()</span><br><span class="line">llm = init_llm(api_key=config[<span class="string">&#x27;openai&#x27;</span>][<span class="string">&#x27;api_key&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">request: Request</span>):</span><br><span class="line">    data = <span class="keyword">await</span> request.json()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        msg_obj = Msg.parse_obj(data)</span><br><span class="line">        qq = msg_obj.user_id</span><br><span class="line">        logger.info(<span class="string">f&quot;QQ:<span class="subst">&#123;qq&#125;</span>ï¼ŒNickname -- <span class="subst">&#123;msg_obj.sender.nickname&#125;</span>ï¼š<span class="subst">&#123;msg_obj.raw_message&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> qq == config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;qq&#x27;</span>]:</span><br><span class="line">            logger.info(<span class="string">&quot;Received a message from girl friend&quot;</span>)</span><br><span class="line">            answer = llm_answer(msg_obj.raw_message, llm, config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;system_prompt&#x27;</span>])</span><br><span class="line">            send_message(qq, answer)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        logger.error(<span class="string">f&quot;data parse error:<span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_answer</span>(<span class="params">question, client, prompt</span>):</span><br><span class="line">    completion = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;qwen-max&quot;</span>,</span><br><span class="line">        messages=[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;system&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;content&#x27;</span>: prompt</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;æ¥ æ¥ å¯¹ä½ è¯´ï¼š&#x27;</span> + question&#125;</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    content = completion.choices[<span class="number">0</span>].message.content</span><br><span class="line">    logging.info(<span class="string">f&#x27;LLM Response:<span class="subst">&#123;content&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_message</span>(<span class="params">qq, message</span>):</span><br><span class="line">    url = config[<span class="string">&#x27;send_msg_url&#x27;</span>]</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;user_id&quot;</span>: qq,</span><br><span class="line">        <span class="string">&quot;message&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;text&quot;</span>: message</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(url, data=json.dumps(data))</span><br><span class="line">    logger.info(<span class="string">f&quot;send message to <span class="subst">&#123;qq&#125;</span> result:<span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    uvicorn.run(app, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä»£ç å®ç°-2"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sender</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    user_id: <span class="built_in">int</span></span><br><span class="line">    nickname: <span class="built_in">str</span></span><br><span class="line">    card: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageContent</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">str</span></span><br><span class="line">    data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Msg</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    self_id: <span class="built_in">int</span></span><br><span class="line">    user_id: <span class="built_in">int</span></span><br><span class="line">    time: <span class="built_in">int</span></span><br><span class="line">    message_id: <span class="built_in">int</span></span><br><span class="line">    real_id: <span class="built_in">int</span></span><br><span class="line">    message_seq: <span class="built_in">int</span></span><br><span class="line">    message_type: <span class="built_in">str</span></span><br><span class="line">    sender: Sender</span><br><span class="line">    raw_message: <span class="built_in">str</span></span><br><span class="line">    font: <span class="built_in">int</span></span><br><span class="line">    sub_type: <span class="built_in">str</span></span><br><span class="line">    message: <span class="type">List</span>[MessageContent]</span><br><span class="line">    message_format: <span class="built_in">str</span></span><br><span class="line">    post_type: <span class="built_in">str</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä»£ç å®ç°-3"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging</span>():</span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        level=logging.INFO,</span><br><span class="line">        <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s - %(name)s - %(levelname)s - %(message)s&quot;</span>,</span><br><span class="line">        datefmt=<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>,</span><br><span class="line">        handlers=[</span><br><span class="line">            logging.FileHandler(<span class="string">&quot;app.log&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>),</span><br><span class="line">            logging.StreamHandler(),</span><br><span class="line">        ],</span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä»£ç å®ç°-4"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">send_msg_url:</span> <span class="string">http://localhost:3000/send_private_msg</span>        <span class="comment"># å‘é€æ¶ˆæ¯çš„æ¥å£</span></span><br><span class="line"><span class="attr">openai:</span></span><br><span class="line">  <span class="attr">api_key:</span> <span class="string">YOUR_API_KEY</span>                                     <span class="comment"># æˆ‘è¿™é‡Œæ¥å…¥çš„æ˜¯é˜¿é‡Œç³»çš„é€šä¹‰åƒé—®ï¼Œæä¾›å¯¹åº”çš„API_KEYå³å¯</span></span><br><span class="line"></span><br><span class="line"><span class="attr">girl_friend:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">æ¥ æ¥ </span>                                                <span class="comment"># è®¾ç½®ç§°å‘¼ï¼Œå¯ä»¥è®©AIä»¥è¿™ä¸ªç§°å‘¼å¥¹</span></span><br><span class="line">  <span class="attr">qq:</span> <span class="string">XXX</span>                                                   <span class="comment"># è®¾ç½®QQå·</span></span><br><span class="line">  <span class="attr">system_prompt:</span> <span class="string">YOUR_SYSTEM_PROMPT</span>                         <span class="comment"># ä¸ºæ™ºèƒ½ä½“åˆå§‹åŒ–çš„prompt</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="åˆæ­¥æ•ˆæœ">åˆæ­¥æ•ˆæœ</h3><p><img src="https://s21.ax1x.com/2024/11/17/pARuo6K.png" alt=""></p><h2 id="å»¶è¿Ÿé˜Ÿåˆ—ä¸-Function-Call-å®ç°å®šæ—¶æé†’">å»¶è¿Ÿé˜Ÿåˆ—ä¸ Function Call å®ç°å®šæ—¶æé†’</h2><ul><li>ç›®æ ‡ï¼šæœŸæœ›çš„æ•ˆæœæ˜¯ï¼Œå¯¹å®ƒè¯´ä¸€å¥è¯ï¼Œä¾‹å¦‚â€œåŠå°æ—¶åæé†’æˆ‘å»æ´—æ¾¡â€ï¼Œå¸Œæœ›èƒ½ç†è§£è¯­ä¹‰ï¼Œå¹¶ä¸”åœ¨å¯¹åº”çš„æ—¶é—´åå‘ç›®æ ‡å‘é€æ¶ˆæ¯ã€‚</li><li>é‚£ä¹ˆåœ¨xxæ—¶é—´åå‘ç‰¹å®šç›®æ ‡å‘é€è¿™ä¸ªæ¶ˆæ¯ï¼Œå¯ä»¥ç”¨å»¶è¿Ÿé˜Ÿåˆ—æ¥å®ç°ï¼Œç­‰ä¸‹æˆ‘æ‰‹å†™ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—å‡ºæ¥å°±å¥½äº†ã€‚</li><li>éš¾ç‚¹ä¸»è¦æ˜¯åœ¨äºï¼Œå¦‚ä½•è®©å¤§æ¨¡å‹ç†è§£æˆ‘çš„è¯­æ„ï¼Œæ¥è°ƒç”¨æ·»åŠ å»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡çš„æ–¹æ³•ï¼Œè¿™ä¸ªå¯ä»¥ç”¨function callæ¥å®ç°ã€‚</li></ul><h3 id="æ‰‹å†™ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—">æ‰‹å†™ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—</h3><ol><li><p>å»¶è¿Ÿé˜Ÿåˆ—çš„æ¦‚å¿µ</p><ul><li>å»¶è¿Ÿé˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œå®ƒå°†ä»»åŠ¡æŒ‰æŒ‡å®šçš„å»¶è¿Ÿæ—¶é—´å­˜å‚¨ï¼Œä»»åŠ¡åœ¨æŒ‡å®šæ—¶é—´åˆ°è¾¾åæ‰ä¼šè¢«æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥è®¾ç½®ä¸€ä¸ªä»»åŠ¡ï¼Œè®©å®ƒåœ¨ä¸€åˆ†é’Ÿåæ‰§è¡Œï¼Œè€Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå®ƒä¼šå¤„äºç­‰å¾…çŠ¶æ€ã€‚å»¶è¿Ÿé˜Ÿåˆ—å¸¸ç”¨äºéœ€è¦å®šæ—¶æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¯”å¦‚å®šæ—¶æé†’ã€å®šæ—¶æ¸…ç†ç­‰ã€‚</li></ul></li><li><p>åº•å±‚æ•°æ®ç»“æ„</p><ul><li>åœ¨å®ç°å»¶è¿Ÿé˜Ÿåˆ—æ—¶ï¼Œå…³é”®æ˜¯å¦‚ä½•é«˜æ•ˆåœ°ç®¡ç†å’Œè°ƒåº¦ä»»åŠ¡ã€‚å¯ä»¥ä½¿ç”¨å¤šç§æ•°æ®ç»“æ„ï¼Œå¸¸è§çš„æœ‰ï¼š<ul><li>æ ˆï¼šä¸é€‚åˆå»¶è¿Ÿé˜Ÿåˆ—ï¼Œæ ˆæ˜¯åè¿›å…ˆå‡ºï¼Œéš¾ä»¥å®ç°æŒ‰æ—¶é—´é¡ºåºæ‰§è¡Œã€‚</li><li>é˜Ÿåˆ—ï¼šé˜Ÿåˆ—é€‚åˆæŒ‰é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œä½†å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ä¸åŒï¼Œé˜Ÿåˆ—æ— æ³•é«˜æ•ˆåœ°å¤„ç†ä¼˜å…ˆçº§ã€‚</li><li>å †ï¼šæœ€åˆé€‚çš„é€‰æ‹©ã€‚å †ï¼Œç‰¹åˆ«æ˜¯æœ€å°å †ï¼Œå¯ä»¥ä¿è¯å»¶è¿Ÿæ—¶é—´æœ€çŸ­çš„ä»»åŠ¡æ’åœ¨é˜Ÿåˆ—çš„æœ€å‰é¢ã€‚</li></ul></li></ul></li><li><p>ä¸ºä»€ä¹ˆé€‰æ‹©å †ï¼Ÿ</p><ul><li>å †æ˜¯ä¸€ä¸ªå®Œå…¨äºŒå‰æ ‘ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š<ol><li>æœ€å°å †ï¼šæ¯ä¸ªçˆ¶èŠ‚ç‚¹çš„å€¼éƒ½ä¸å¤§äºå…¶å­èŠ‚ç‚¹çš„å€¼ã€‚æœ€å°å †æ ¹èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯å½“å‰é˜Ÿåˆ—ä¸­å»¶è¿Ÿæ—¶é—´æœ€çŸ­çš„ä»»åŠ¡ã€‚</li><li>æ“ä½œæ•ˆç‡ï¼šæ’å…¥å’Œåˆ é™¤æ“ä½œæ—¶é—´å¤æ‚åº¦ä¸ºO(log n)ï¼Œå› æ­¤å †éå¸¸é€‚åˆç”¨æ¥é«˜æ•ˆåœ°ç®¡ç†å»¶è¿Ÿé˜Ÿåˆ—ã€‚</li></ol></li></ul></li><li><p>å¦‚ä½•å®ç°ï¼Ÿ</p><ul><li>æ¯ä¸ªä»»åŠ¡éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ï¼ˆå³ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼‰ã€‚</li><li>ä½¿ç”¨æœ€å°å †æ¥å­˜å‚¨è¿™äº›ä»»åŠ¡ï¼Œä»»åŠ¡æŒ‰å»¶è¿Ÿæ—¶é—´ä»å°åˆ°å¤§æ’åˆ—ã€‚</li><li>ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæ˜¯ä»å †é¡¶å¼€å§‹çš„ï¼Œå³æœ€çŸ­å»¶è¿Ÿæ—¶é—´çš„ä»»åŠ¡æœ€å…ˆæ‰§è¡Œã€‚</li><li>ç¤ºä¾‹ï¼šå‡è®¾æœ‰ä¸‰ä¸ªä»»åŠ¡ï¼Œå®ƒä»¬çš„å»¶è¿Ÿæ—¶é—´åˆ†åˆ«æ˜¯ 10 åˆ†é’Ÿã€1 åˆ†é’Ÿå’Œ5 åˆ†é’Ÿã€‚æœ€å°å †ä¼šä¿è¯ 1 åˆ†é’Ÿçš„ä»»åŠ¡åœ¨æœ€å‰é¢ï¼Œæ¥ç€æ˜¯ 5 åˆ†é’Ÿçš„ä»»åŠ¡ï¼Œæœ€åæ˜¯ 10 åˆ†é’Ÿçš„ä»»åŠ¡ã€‚</li></ul></li><li><p>å·¥ä½œåŸç†</p><ul><li>ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼š<ul><li>æ¯æ¬¡æ·»åŠ ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬å°†ä»»åŠ¡ä¸å…¶å»¶è¿Ÿæ—¶é—´ä¸€åŒæ’å…¥å †ä¸­ã€‚å †ä¼šè‡ªåŠ¨å°†ä»»åŠ¡æŒ‰å»¶è¿Ÿæ—¶é—´æ’åºï¼Œä½¿å¾—æœ€çŸ­å»¶è¿Ÿçš„ä»»åŠ¡å§‹ç»ˆä½äºå †é¡¶ã€‚</li></ul></li><li>ä»»åŠ¡æ‰§è¡Œï¼š<ul><li>ä½¿ç”¨ä¸€ä¸ªå¾ªç¯æŒç»­ç›‘å¬å †é¡¶ä»»åŠ¡çš„å»¶è¿Ÿæ—¶é—´ã€‚</li><li>æ¯æ¬¡å¾ªç¯æ£€æŸ¥å †é¡¶ä»»åŠ¡çš„å»¶è¿Ÿæ—¶é—´æ˜¯å¦åˆ°æœŸï¼ˆå³å½“å‰æ—¶é—´æ˜¯å¦è¶…è¿‡ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼‰ã€‚</li><li>å¦‚æœä»»åŠ¡æœªåˆ°æœŸï¼Œç¨‹åºå°±ä¼šä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œå†æ¬¡æ£€æŸ¥ã€‚å¦‚æœä»»åŠ¡å·²ç»åˆ°æœŸï¼Œåˆ™ä»å †ä¸­å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œã€‚</li></ul></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DelayQueue</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.queue = []</span><br><span class="line">        self.lock = threading.Lock()</span><br><span class="line">        self.condition = threading.Condition(self.lock)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_delay_task</span>(<span class="params">self, delay_msg, delay_time</span>):</span><br><span class="line">        execute_time = time.time() + delay_time</span><br><span class="line">        <span class="keyword">with</span> self.condition:</span><br><span class="line">            heapq.heappush(self.queue, (execute_time, delay_msg))</span><br><span class="line">            self.condition.notify()</span><br><span class="line">        logger.info(<span class="string">f&#x27;æ·»åŠ å»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡: <span class="subst">&#123;delay_msg&#125;</span>, å°†äº <span class="subst">&#123;delay_time&#125;</span> ç§’åæ‰§è¡Œ.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_task</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> self.condition:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">if</span> self.queue:</span><br><span class="line">                    execute_time, task = self.queue[<span class="number">0</span>]</span><br><span class="line">                    current_time = time.time()</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> current_time &gt;= execute_time:</span><br><span class="line">                        heapq.heappop(self.queue)</span><br><span class="line">                        <span class="keyword">return</span> task</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        self.condition.wait(timeout=execute_time - current_time)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.condition.wait()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_worker</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">worker</span>():</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    task = self.get_task()</span><br><span class="line">                    logger.info(</span><br><span class="line">                        <span class="string">f&#x27;Executing task: <span class="subst">&#123;task&#125;</span> at <span class="subst">&#123;time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, time.localtime())&#125;</span>&#x27;</span>)</span><br><span class="line">                    answer = llm_answer_delay_msg(task, [], llm, config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;system_prompt&#x27;</span>])</span><br><span class="line">                    send_message(config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;qq&#x27;</span>], answer, config[<span class="string">&#x27;send_msg_url&#x27;</span>])</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logger.error(<span class="string">f&quot;Worker encountered an error: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        threading.Thread(target=worker, daemon=<span class="literal">True</span>, name=<span class="string">&quot;DelayQueueWorker&quot;</span>).start()</span><br></pre></td></tr></table></figure><h3 id="Function-Call">Function Call</h3><ul><li><code>Function Call</code> æ˜¯ä¸€ç§æœºåˆ¶ï¼Œé€šè¿‡å¤§è¯­è¨€æ¨¡å‹æ¥å†³å®šæ˜¯å¦è§¦å‘æŸäº›é¢„å®šä¹‰çš„åŠŸèƒ½ã€‚ä¸ä¼ ç»Ÿçš„ <code>API</code> è°ƒç”¨ä¸åŒï¼Œ<code>Function Call</code> å…è®¸æ¨¡å‹æ ¹æ®ä¸Šä¸‹æ–‡å’Œç”¨æˆ·è¾“å…¥åŠ¨æ€åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡ŒæŸäº›æ“ä½œã€‚</li><li>åœ¨æœ¬æ¬¡åº”ç”¨ä¸­ï¼Œ<code>Function Call</code> ä¸»è¦ç”¨äºæ ¹æ®ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€è¾“å…¥ï¼Œå†³å®šæ˜¯å¦éœ€è¦å°†ä»»åŠ¡æ·»åŠ åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­ï¼Œå¹¶æŒ‡å®šå»¶è¿Ÿçš„æ—¶é—´ã€‚</li></ul><div class="tabs" id="function-call"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#function-call-1">function_definitions</button></li><li class="tab"><button type="button" data-href="#function-call-2">routers</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="function-call-1"><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function_definitions = <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;add_delay_task&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å°†ä»»åŠ¡æ·»åŠ åˆ°å»¶è¿Ÿé˜Ÿåˆ—ã€‚&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;delay_msg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å»¶è¿Ÿä»»åŠ¡çš„æ¶ˆæ¯å†…å®¹&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;delay_time&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å»¶è¿Ÿæ—¶é—´ï¼Œå•ä½æ˜¯ç§’&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;delay_msg&quot;</span><span class="punctuation">,</span> <span class="string">&quot;delay_time&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><ul><li>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º add_delay_task çš„å‡½æ•°ï¼Œè¡¨ç¤ºå°†ä»»åŠ¡æ·»åŠ åˆ°å»¶è¿Ÿé˜Ÿåˆ—ã€‚è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼š<ul><li>delay_msgï¼šä»»åŠ¡çš„æ¶ˆæ¯å†…å®¹ï¼Œç±»å‹ä¸ºå­—ç¬¦ä¸²ã€‚</li><li>delay_timeï¼šå»¶è¿Ÿçš„æ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼Œç±»å‹ä¸ºæ•´æ•°ã€‚</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="function-call-2"><ol><li><p>è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œæ¶ˆæ¯å¤„ç†</p><ul><li>æˆ‘ä»¬å°†åˆ©ç”¨å¤§è¯­è¨€æ¨¡å‹æ¥å¤„ç†ç”¨æˆ·çš„è¾“å…¥æ¶ˆæ¯ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨ <code>add_delay_task</code> å‡½æ•°ã€‚æ¨¡å‹æ ¹æ®è‡ªç„¶è¯­è¨€çš„ä¸Šä¸‹æ–‡æ¥å†³å®šæ˜¯å¦è°ƒç”¨å»¶è¿Ÿä»»åŠ¡åŠŸèƒ½ã€‚</li></ul> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">response = LLM_CLIENT.chat.completions.create(</span><br><span class="line">    model=<span class="string">&quot;qwen-plus&quot;</span>,</span><br><span class="line">    messages=[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">&quot;ä½ æ˜¯ä¸€ä½æ™ºèƒ½åŠ©æ‰‹ï¼Œå¸®åŠ©è§£æè‡ªç„¶è¯­è¨€ä»»åŠ¡å¹¶æ·»åŠ åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œä»…ä»…å½“æ˜ç¡®å‡ºç°æ—¶é—´å¹¶ä¸”éœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦æé†’çš„æ„æ„¿æ—¶ï¼Œæ‰éœ€è¦è°ƒç”¨ã€‚ä¾‹å¦‚ï¼šâ€˜ååˆ†é’Ÿåæé†’æˆ‘å»æ´—æ¾¡â€™ã€‚&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">f&quot;å¥³æœ‹å‹è¯´ï¼š<span class="subst">&#123;msg&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    functions=function_definitions,</span><br><span class="line">    function_call=<span class="string">&quot;auto&quot;</span>  <span class="comment"># è®©æ¨¡å‹å†³å®šæ˜¯å¦è°ƒç”¨åŠŸèƒ½</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li>å…¶ä¸­<code>function_call=&quot;auto&quot;</code> è®©æ¨¡å‹è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šã€‚</li></ul></li><li><p>å¤„ç†æ¨¡å‹å“åº”ç»“æœ</p><ul><li>å½“æ¨¡å‹å¤„ç†å®Œç”¨æˆ·æ¶ˆæ¯åï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª <code>response</code> å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†æ¨¡å‹çš„å›å¤ä»¥åŠæ˜¯å¦éœ€è¦è°ƒç”¨æŸä¸ªå‡½æ•°ã€‚å¦‚æœæ¨¡å‹å†³å®šè°ƒç”¨ <code>add_delay_task</code> å‡½æ•°ï¼Œå®ƒä¼šåœ¨ <code>response</code> ä¸­è¿”å› <code>function_call</code>ï¼ŒåŒ…å«äº†è¦è°ƒç”¨çš„å‡½æ•°åå’Œç›¸åº”çš„å‚æ•°ã€‚</li></ul> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> response.choices[<span class="number">0</span>].message.function_call:</span><br><span class="line">    func_name = response.choices[<span class="number">0</span>].message.function_call.name</span><br><span class="line">    arguments = json.loads(response.choices[<span class="number">0</span>].message.function_call.arguments)</span><br></pre></td></tr></table></figure></li><li><p>è§£æå¹¶è°ƒç”¨å‡½æ•°</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> func_name == <span class="string">&quot;add_delay_task&quot;</span>:</span><br><span class="line">    delay_queue.add_delay_task(**arguments)</span><br></pre></td></tr></table></figure></li><li><p>æ•´ä½“ç¤ºä¾‹</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">request: Request</span>):</span><br><span class="line">    data = <span class="keyword">await</span> request.json()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        msg_obj = Msg.parse_obj(data)</span><br><span class="line">        qq = msg_obj.user_id</span><br><span class="line">        logger.info(<span class="string">f&quot;QQ:<span class="subst">&#123;qq&#125;</span>ï¼ŒNickname -- <span class="subst">&#123;msg_obj.sender.nickname&#125;</span>ï¼š<span class="subst">&#123;msg_obj.raw_message&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> qq <span class="keyword">not</span> <span class="keyword">in</span> message_queue_cache:</span><br><span class="line">            message_queue_cache[qq] = deque(maxlen=MAX_QUEUE_SIZE)</span><br><span class="line">        <span class="keyword">if</span> qq == config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;qq&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> qq <span class="keyword">not</span> <span class="keyword">in</span> message_queue_cache:</span><br><span class="line">                message_queue_cache[qq] = deque(maxlen=MAX_QUEUE_SIZE)</span><br><span class="line">            msg = msg_obj.raw_message</span><br><span class="line">            message_queue_cache[qq].append(&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;message&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è°ƒç”¨å¤§æ¨¡å‹è§£ææ¶ˆæ¯</span></span><br><span class="line">            response = LLM_CLIENT.chat.completions.create(</span><br><span class="line">                model=<span class="string">&quot;qwen-plus&quot;</span>,</span><br><span class="line">                messages=[</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;content&quot;</span>: <span class="string">&quot;ä½ æ˜¯ä¸€ä½æ™ºèƒ½åŠ©æ‰‹ï¼Œå¸®åŠ©è§£æè‡ªç„¶è¯­è¨€ä»»åŠ¡å¹¶æ·»åŠ åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œä»…ä»…å½“æ˜ç¡®å‡ºç°æ—¶é—´å¹¶ä¸”éœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦æé†’çš„æ„æ„¿æ—¶ï¼Œæ‰éœ€è¦è°ƒç”¨ã€‚ä¾‹å¦‚ï¼šâ€˜ååˆ†é’Ÿåæé†’æˆ‘å»æ´—æ¾¡â€™ã€‚&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;content&quot;</span>: <span class="string">f&quot;å¥³æœ‹å‹è¯´ï¼š<span class="subst">&#123;msg&#125;</span>&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                functions=function_definitions,</span><br><span class="line">                function_call=<span class="string">&quot;auto&quot;</span>  <span class="comment"># è®©æ¨¡å‹å†³å®šæ˜¯å¦è°ƒç”¨åŠŸèƒ½</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å¦‚æœæ¨¡å‹è°ƒç”¨äº† Function</span></span><br><span class="line">            <span class="keyword">if</span> response.choices[<span class="number">0</span>].message.function_call:</span><br><span class="line">                func_name = response.choices[<span class="number">0</span>].message.function_call.name</span><br><span class="line">                arguments = json.loads(response.choices[<span class="number">0</span>].message.function_call.arguments)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> func_name == <span class="string">&quot;add_delay_task&quot;</span>:</span><br><span class="line">                    <span class="comment"># æ‰§è¡Œäº† add_delay_task æ–¹æ³•</span></span><br><span class="line">                    delay_queue.add_delay_task(**arguments)</span><br><span class="line">                    <span class="comment"># ç”Ÿæˆä¸€ä¸ªç«‹å³å›å¤</span></span><br><span class="line">                    answer = llm_received_delay_msg(msg, <span class="built_in">list</span>(message_queue_cache[qq]), llm,</span><br><span class="line">                                        config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;system_prompt&#x27;</span>],</span><br><span class="line">                                        config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">                    message_queue_cache[qq].append(&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;llm&quot;</span>, <span class="string">&quot;message&quot;</span>: answer&#125;)</span><br><span class="line">                    send_message(qq, answer, config[<span class="string">&#x27;send_msg_url&#x27;</span>])</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">            <span class="comment"># æ²¡æœ‰è°ƒç”¨Functionï¼Œç”Ÿæˆæ™®é€šå›å¤</span></span><br><span class="line">            answer = llm_answer(msg, <span class="built_in">list</span>(message_queue_cache[qq]), llm,</span><br><span class="line">                                config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;system_prompt&#x27;</span>],</span><br><span class="line">                                config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">            message_queue_cache[qq].append(&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;llm&quot;</span>, <span class="string">&quot;message&quot;</span>: answer&#125;)</span><br><span class="line">            send_message(qq, answer, config[<span class="string">&#x27;send_msg_url&#x27;</span>])</span><br><span class="line">            logger.info(<span class="string">f&quot;Queue for <span class="subst">&#123;qq&#125;</span>: cache message:<span class="subst">&#123;<span class="built_in">list</span>(message_queue_cache[qq])&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;data parse error:<span class="subst">&#123;data&#125;</span>, error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        logger.error(<span class="string">f&quot;Stack trace: <span class="subst">&#123;traceback.format_exc()&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1>ç»“è¯­</h1><ul><li>æ—¢ç„¶éƒ½çœ‹åˆ°è¿™é‡Œäº†ï¼Œä¸å¦¨ç»™è¿™ä¸ªé¡¹ç›®ç‚¹ä¸ªStarå§ï¼Œå¤šè°¢ï¼</li></ul><div class="tag link"><a class="link-card" title="NanBot" href="https://github.com/Cyborg2077/NanBot"><div class="left"><img src="https://github.githubassets.com/favicons/favicon.png"/></div><div class="right"><p class="text">NanBot</p><p class="url">https://github.com/Cyborg2077/NanBot</p></div></a></div>]]></content>
    
    
    <summary type="html">åˆè¡·å…¶å®æ˜¯ç»™æ¥ æ¥ åšä¸ªæ¯æ—¥æé†’æœºå™¨äººçš„ï¼Œç»“æœè¶Šèµ°è¶Šå...</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="LLM" scheme="https://cyborg2077.github.io/tags/LLM/"/>
    
  </entry>
  
  <entry>
    <title>åç¼–è¯‘jaråŒ…ç ´è§£ASPOSE</title>
    <link href="https://cyborg2077.github.io/2024/10/10/CrackAsposeHTML/"/>
    <id>https://cyborg2077.github.io/2024/10/10/CrackAsposeHTML/</id>
    <published>2024-10-10T11:48:09.000Z</published>
    <updated>2024-10-13T06:35:59.626Z</updated>
    
    <content type="html"><![CDATA[<h1>å‡†å¤‡å·¥ä½œ</h1><ol><li>ä¸‹è½½åŸå§‹jaråŒ…ï¼š<a href="https://releases.aspose.com/html/java/22-8/">aspose-html-22.8-jdk11.jar</a></li><li>å‡†å¤‡åç¼–è¯‘å·¥å…·ï¼Œè¿™é‡Œæ¨èä½¿ç”¨<a href="https://github.com/java-decompiler/jd-gui/tags">jd-gui</a>æˆ–è€…<a href="https://github.com/skylot/jadx/tags">jadx</a>ã€‚</li></ol><h1>ç ´è§£æ€è·¯</h1><ul><li>Aspose ç³»åˆ—äº§å“ä¸»è¦ä¾èµ–è®¸å¯è¯æ–‡ä»¶ï¼ˆlicense.xmlï¼‰çš„æ³¨å†Œæ¥å·¥ä½œã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ Aspose æ˜¯å¦‚ä½•æ³¨å†Œè®¸å¯è¯çš„ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">InputStream is;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    is = Files.newInputStream(Paths.get(<span class="string">&quot;C:\\xxx\\license.xml&quot;</span>));</span><br><span class="line">    <span class="type">License</span> <span class="variable">license</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">License</span>();</span><br><span class="line">    license.setLicense(is);</span><br><span class="line">    is.close();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>license.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">License</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Products</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Product</span>&gt;</span>Aspose.Total for Java<span class="tag">&lt;/<span class="name">Product</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Product</span>&gt;</span>Aspose.Words for Java<span class="tag">&lt;/<span class="name">Product</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Products</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">EditionType</span>&gt;</span>Enterprise<span class="tag">&lt;/<span class="name">EditionType</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SubscriptionExpiry</span>&gt;</span>20991231<span class="tag">&lt;/<span class="name">SubscriptionExpiry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">LicenseExpiry</span>&gt;</span>20991231<span class="tag">&lt;/<span class="name">LicenseExpiry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SerialNumber</span>&gt;</span>8bfe198c-7f0c-4ef8-8ff0-acc3237bf0d7<span class="tag">&lt;/<span class="name">SerialNumber</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Signature</span>&gt;</span></span><br><span class="line">        sNLLKGMUdF0r8O1kKilWAGdgfs2BvJb/2Xp8p5iuDVfZXmhppo+d0Ran1P9TKdjV4ABwAgKXxJ3jcQTqE/2IRfqwnPf8itN8aFZlV3TJPYeD3yWE7IT55Gz6EijUpC7aKeoohTb4w2fpox58wWoF3SNp6sK6jDfiAUGEHYJ9pjU=</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Signature</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">License</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><p>ç ´è§£çš„æ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯æŸ¥çœ‹ <code>setLicense</code> æ–¹æ³•ä¸­å®é™…åšäº†å“ªäº›æ“ä½œï¼Œç„¶åå¯¹æºç è¿›è¡Œä¿®æ”¹ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>JD-GUI</code> åç¼–è¯‘ jar åŒ…ï¼Œæ‰¾åˆ° <code>License</code> ç±»ï¼Œä½äº <code>com.aspose.html</code> åŒ…ä¸‹ã€‚<br><img src="https://s21.ax1x.com/2024/10/10/pAJoM1s.png" alt=""></p></li><li><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ª <code>setLicense</code> æ–¹æ³•ï¼Œè€Œä»£ç ä¸­è°ƒç”¨çš„æ˜¯ç¬¬äºŒç§å½¢å¼ã€‚<br><img src="https://s21.ax1x.com/2024/10/10/pAJo3n0.png" alt=""></p></li><li><p>è¿™é‡Œä½¿ç”¨äº†ä¼ å…¥çš„æ–‡ä»¶æµï¼Œæˆ‘ä»¬å¯ä»¥é‡ç‚¹æŸ¥çœ‹z16è°ƒç”¨çš„m1æ–¹æ³•ï¼š</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">z16.m1(byteArrayInputStream);</span><br></pre></td></tr></table></figure><ul><li><p>æˆ‘ä»¬è¿›å…¥ z16 ç±»ï¼Œé€æ­¥æŸ¥çœ‹é‡Œé¢çš„å®ç°ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯ç–‘çš„æ–¹æ³•ã€‚<br><img src="https://s21.ax1x.com/2024/10/13/pAYXhZ9.png" alt=""></p></li><li><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œm1 æ–¹æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯éªŒè¯è®¸å¯æ–‡ä»¶çš„ç­¾åï¼Œä»¥ç¡®ä¿æ–‡ä»¶çš„åˆæ³•æ€§å’Œæœªè¢«ç¯¡æ”¹ã€‚</p><ol><li>è·å–è®¸å¯ç±»å‹ï¼š</li></ol><ul><li>é€šè¿‡ switch è¯­å¥ï¼Œæ ¹æ®è®¸å¯çš„ç±»å‹ï¼ˆå¦‚ â€œProfessionalâ€ æˆ– â€œEnterpriseâ€ï¼‰è¿›è¡ŒåŒºåˆ†ï¼Œä»¥ç¡®å®šè®¸å¯æ–‡ä»¶çš„ç±»å‹ã€‚</li></ul><ol start="2"><li>å¤„ç†èŠ‚ç‚¹æ•°æ®ï¼š</li></ol><ul><li>å°†ä¼ å…¥çš„ XML Node æ•°æ®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²å¹¶ä»¥ UTF-16LE ç¼–ç è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ (arrayOfByte1)ã€‚</li><li>ä»ç¬¬äºŒä¸ªèŠ‚ç‚¹ paramNode2 ä¸­æå– Base64 ç¼–ç çš„ç­¾åï¼Œå¹¶å°†å…¶è§£ç ä¸ºå­—èŠ‚æ•°ç»„ (arrayOfByte2)ã€‚</li></ul><ol start="3"><li>é€‰æ‹©ç­¾åç®—æ³•ï¼š</li></ol><ul><li>æ ¹æ®è®¸å¯æ–‡ä»¶çš„å®‰å…¨è¦æ±‚ï¼Œé€‰æ‹©ä½¿ç”¨ SHA1withRSA æˆ– SHA256withRSA ä½œä¸ºç­¾åç®—æ³•ã€‚å¦‚æœç³»ç»Ÿå¯ç”¨äº† FIPS å®‰å…¨æ¨¡å¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨ FIPS è®¤è¯çš„æä¾›ç¨‹åº (m186)ã€‚</li></ul><ol start="4"><li>å…¬é’¥é€‰æ‹©ï¼š</li></ol><ul><li>arrayOfString1 å’Œ arrayOfString2 æ•°ç»„ä¸­å­˜å‚¨äº†å¤šä¸ªå¯èƒ½çš„å…¬é’¥æˆ–å…¬é’¥ç‰‡æ®µï¼Œé€šè¿‡ç´¢å¼•é€‰æ‹©åˆé€‚çš„å…¬é’¥ã€‚</li><li>ä½¿ç”¨ m5 æ–¹æ³•ä»å­—ç¬¦ä¸²ä¸­ç”Ÿæˆå…¬é’¥ (PublicKey)ã€‚</li></ul><ol start="5"><li>ç­¾åéªŒè¯ï¼š</li></ol><ul><li>ä½¿ç”¨ initVerify æ–¹æ³•åˆå§‹åŒ–å…¬é’¥éªŒè¯ã€‚</li><li>è°ƒç”¨ update æ–¹æ³•ä¼ å…¥å·²ç¼–ç çš„æ•°æ®å­—èŠ‚æ•°ç»„ (arrayOfByte1)ï¼Œç„¶åä½¿ç”¨ verify æ–¹æ³•éªŒè¯ Base64 è§£ç åçš„ç­¾å (arrayOfByte2) æ˜¯å¦åŒ¹é…ã€‚</li></ul><ol start="6"><li>è¿”å›ç»“æœï¼š</li></ol><ul><li>éªŒè¯æˆåŠŸåè¿”å›è®¸å¯çŠ¶æ€ paramz3ï¼Œå¦‚æœéªŒè¯å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸å¹¶è¿”å›å¤±è´¥çŠ¶æ€ (z3.m205)ã€‚</li></ul></li><li><p>é‚£ä¹ˆç ´è§£çš„æ€è·¯éå¸¸ç®€å•ï¼šç›´æ¥è®©è¿™ä¸ªæ–¹æ³•è¿”å› paramz3 å°±è¡Œäº†ã€‚</p></li></ul><h1>ä¿®æ”¹å­—èŠ‚ç æ–‡ä»¶</h1><ul><li>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>Javassist</code> ä¿®æ”¹å­—èŠ‚ç æ–‡ä»¶ã€‚é¦–å…ˆæ·»åŠ ä¾èµ–ï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.28.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬åªéœ€è¦éœ€è¦ä¿®æ”¹ <code>z16</code> ç±»ä¸­çš„ <code>m1(Node node, Node node2, z3 z3Var)</code> æ–¹æ³•ï¼Œè®©å®ƒç›´æ¥è¿”å› paramz3ã€‚ä¿®æ”¹çš„ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">jarPath</span> <span class="operator">=</span> <span class="string">&quot;D:\\html\\aspose-html-22.8-jdk11.jar&quot;</span>;</span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    classPool.insertClassPath(jarPath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// z16ç±»é‡Œçš„m1æ–¹æ³•ï¼ŒåŒæ—¶ä¸‰ä¸ªå‚æ•°ç±»å‹åˆ†åˆ«æ˜¯Node, Node, z3ï¼Œè¿™ä¸ªz3æˆ‘æ‰¾äº†ä¸€ä¸‹ï¼Œæ˜¯z16é‡Œçš„ä¸€ä¸ªæšä¸¾ç±»</span></span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.getCtClass(<span class="string">&quot;com.aspose.html.z16&quot;</span>);</span><br><span class="line">    CtClass[] paramTypes = <span class="keyword">new</span> <span class="title class_">CtClass</span>[<span class="number">3</span>];</span><br><span class="line">    paramTypes[<span class="number">0</span>] = classPool.get(<span class="string">&quot;org.w3c.dom.Node&quot;</span>);</span><br><span class="line">    paramTypes[<span class="number">1</span>] = classPool.get(<span class="string">&quot;org.w3c.dom.Node&quot;</span>);</span><br><span class="line">    paramTypes[<span class="number">2</span>] = classPool.get(<span class="string">&quot;com.aspose.html.z16f$z3&quot;</span>);</span><br><span class="line">    <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;m1&quot;</span>, paramTypes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿®æ”¹æ–¹æ³•ä½“ï¼Œä½¿å…¶ç›´æ¥è¿”å›ç¬¬ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line">    ctMethod.setBody(<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    return $3;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ctClass.writeFile(<span class="string">&quot;D:\\html\\&quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;Modification completed successfully.&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¼–è¯‘æ‰§è¡Œä¹‹åä¼šç”Ÿæˆä¸€ä¸ª.classæ–‡ä»¶ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ª.classæ–‡ä»¶æ›¿æ¢åˆ°åŸæ¥çš„jaråŒ…ä¸­ï¼Œå¹¶ä¸”åˆ é™¤jaråŒ…ä¸­åŸæœ¬çš„.RSAå’Œ.SFæ–‡ä»¶ï¼Œä½¿ç”¨mvn installå®‰è£…ä¸€ä¸‹è¿™ä¸ªjaråŒ…å°±å¯ä»¥è°ƒç”¨äº†ã€‚</li></ul><h1>æ³¨æ„äº‹é¡¹</h1><ul><li>ASPOSE.SLIDEã€ASPOSE.WORDSç­‰å…¶ä»–äº§å“ï¼Œç ´è§£æ€è·¯åŸºæœ¬éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯çœ‹setLicenseæ–¹æ³•çš„å®ç°ï¼Œç„¶åä¿®æ”¹æºç ã€‚</li><li>ç ´è§£ç‰ˆçš„ jar åŒ…å¯èƒ½å­˜åœ¨åå°å‘å¤–éƒ¨æœåŠ¡å™¨å‘é€æ•°æ®çš„é£é™©ï¼Œå› æ­¤æœ¬æ–‡ä»…é™äºå­¦ä¹ ç ”ç©¶ï¼Œä¸æ¶‰åŠå•†ä¸šç”¨é€”ã€‚è¯·å‹¿å°†å…¶ç”¨äºéæ³•æ´»åŠ¨ã€‚<br><img src="https://s21.ax1x.com/2024/10/13/pAYXJ8f.png" alt=""></li></ul><h1>æ€ä¹ˆå·å·ç”¨ï¼Ÿ</h1><ul><li>ä¸”å¬ä¸‹å›åˆ†è§£ï¼Œè¿™å‘¨å°±ä¼‘ä¸€å¤©ï¼Œæ­‡äº†</li></ul>]]></content>
    
    
    <summary type="html">ç ´è§£ç‰ˆæœ¬ä¸ºaspose-html-22.8-jdk11.jar</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="é€†å‘" scheme="https://cyborg2077.github.io/tags/%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºæ¨¡æ¿æ¨¡å¼ç®€åŒ–ä»£ç å¼€å‘</title>
    <link href="https://cyborg2077.github.io/2024/10/06/SimplifyCodeByTemplateMode/"/>
    <id>https://cyborg2077.github.io/2024/10/06/SimplifyCodeByTemplateMode/</id>
    <published>2024-10-06T05:03:58.000Z</published>
    <updated>2024-10-06T06:08:01.749Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œå¾€å¾€ä¼šé‡åˆ°å¤šä¸ªåŠŸèƒ½æ¨¡å—å­˜åœ¨é‡å¤çš„æµç¨‹æˆ–é€»è¾‘ï¼Œä½†å®ƒä»¬çš„ä¸šåŠ¡ç»†èŠ‚åˆæœ‰æ‰€ä¸åŒã€‚ä¸ºé¿å…ä»£ç å†—ä½™ï¼Œæå‡ä»£ç çš„å¤ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œè®¾è®¡æ¨¡å¼ç­‰æ–¹æ³•æä¾›äº†å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡è¯†åˆ«å’Œæå–é€šç”¨é€»è¾‘ï¼Œå¼€å‘è€…å¯ä»¥å°†ç›¸ä¼¼çš„ä»£ç æŠ½è±¡ä¸ºæ›´åŠ çµæ´»å’Œæ‰©å±•æ€§å¼ºçš„ç»“æ„ï¼Œé€‚ç”¨äºä¸åŒåœºæ™¯çš„éœ€æ±‚ã€‚</li><li>æœ¬æ–‡å°†å±•ç¤ºå¦‚ä½•ä»é‡å¤çš„ä¸šåŠ¡ä»£ç ä¸­æå–å…±æ€§ï¼Œé€æ­¥ä¼˜åŒ–å¹¶æå‡ä»£ç çš„å¯ç»´æŠ¤æ€§ä¸çµæ´»æ€§ï¼Œæœ€ç»ˆå½¢æˆä¸€ä¸ªæ›´åŠ é€šç”¨ã€æ‰©å±•æ€§å¼ºçš„è§£å†³æ–¹æ¡ˆã€‚</li><li>ä¸å¿…å…³å¿ƒæˆ‘è¿™é‡Œçš„ä¸šåŠ¡é€»è¾‘ï¼Œä»…ä»…å…³å¿ƒæ¨¡æ¿çš„æå–ã€‚</li></ul><h1>åŸå§‹ä»£ç </h1><ul><li>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘é‡åˆ°çš„åœºæ™¯æ˜¯ä¸åŒçš„åŠŸèƒ½æ¨¡å—å…·æœ‰ç›¸ä¼¼çš„å¤„ç†æµç¨‹ã€‚ä¾‹å¦‚ï¼Œåœ¨ç”Ÿæˆå„ç§æ–‡æ¡£æ—¶ï¼Œæ¯ç§æ–‡æ¡£çš„ç”Ÿæˆé€»è¾‘å„è‡ªç‹¬ç«‹ï¼Œä½†å¤„ç†æ–‡ä»¶è¾“å‡ºå’Œå“åº”çš„éƒ¨åˆ†å´é«˜åº¦é‡å¤ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/generateReferenceReview&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateReferenceReview</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// è¿™éƒ¨åˆ†å†…å®¹æ˜¯æ–‡æ¡£çš„ç”Ÿæˆé€»è¾‘</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> orderConsumerService.generateReferenceReview(JSONObject.parseObject(json));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™éƒ¨åˆ†å†…å®¹æ˜¯é‡å¤çš„</span></span><br><span class="line">    CommonUtil.setContentType(response, diskPath);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> +</span><br><span class="line">            java.net.URLEncoder.encode(FilenameUtils.getName(diskPath), <span class="string">&quot;UTF-8&quot;</span>).replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;%20&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">    FileUtils.copyFile(<span class="keyword">new</span> <span class="title class_">File</span>(diskPath), outputStream);</span><br><span class="line">    outputStream.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/generatePPT&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generatePPT</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> orderConsumerService.generatePPT(JSONObject.parseObject(json), orderId);</span><br><span class="line">    </span><br><span class="line">    CommonUtil.setContentType(response, diskPath);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> +</span><br><span class="line">            java.net.URLEncoder.encode(FilenameUtils.getName(diskPath), <span class="string">&quot;UTF-8&quot;</span>).replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;%20&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">    FileUtils.copyFile(<span class="keyword">new</span> <span class="title class_">File</span>(diskPath), outputStream);</span><br><span class="line">    outputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå°½ç®¡ <code>generateReferenceReview</code> å’Œ <code>generatePPT</code> æ–¹æ³•åœ¨ä¸šåŠ¡é€»è¾‘ä¸Šä¸åŒï¼Œä½†æ–‡ä»¶çš„å¤„ç†å’Œå“åº”é€»è¾‘æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚æ˜¾ç„¶ï¼Œè¿™ç§é‡å¤çš„ä»£ç å¢åŠ äº†ç»´æŠ¤æˆæœ¬ï¼Œä¹Ÿè¿èƒŒäº† DRYï¼ˆDonâ€™t Repeat Yourselfï¼‰åŸåˆ™ã€‚å› æ­¤ï¼Œé¦–å…ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æå–å…¬å…±ä»£ç æ¥å‡å°‘å†—ä½™ã€‚</li></ul><h1>ä¼˜åŒ–ä»£ç </h1><ul><li>é€šè¿‡å°†é‡å¤çš„å“åº”é€»è¾‘æŠ½è±¡ä¸ºä¸€ä¸ªé€šç”¨æ–¹æ³•ï¼Œå¯ä»¥å‡å°‘ä»£ç å†—ä½™ï¼Œæå‡å¯è¯»æ€§ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/generateReferenceReview&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateReferenceReview</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> orderConsumerService.generateReferenceReview(JSONObject.parseObject(json));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½†æ˜¯è¿™é‡Œè¿˜æ˜¯é‡å¤çš„ï¼Œåªä¸è¿‡å˜æˆäº†ä¸€è¡Œè°ƒç”¨ï¼Œæ²»æ ‡ä¸æ²»æœ¬</span></span><br><span class="line">    handleFileResponse(response, diskPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/generatePPT&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generatePPT</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> orderConsumerService.generatePPT(JSONObject.parseObject(json), orderId);</span><br><span class="line">    handleFileResponse(response, diskPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleFileResponse</span><span class="params">(HttpServletResponse response, String diskPath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    CommonUtil.setContentType(response, diskPath);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> +</span><br><span class="line">            java.net.URLEncoder.encode(FilenameUtils.getName(diskPath), <span class="string">&quot;UTF-8&quot;</span>).replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;%20&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">    FileUtils.copyFile(<span class="keyword">new</span> <span class="title class_">File</span>(diskPath), outputStream);</span><br><span class="line">    outputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>ä½¿ç”¨æ¨¡æ¿æ¨¡å¼ç®€åŒ–</h1><ul><li>ä¸ºäº†æå‡ä»£ç å¤ç”¨æ€§å’Œæ‰©å±•æ€§ï¼Œå¯ä»¥ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå°†ä¸šåŠ¡é€»è¾‘å’Œé€šç”¨çš„æµç¨‹å¤„ç†åˆ†ç¦»å¼€æ¥ã€‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ‰§è¡Œå™¨ç±» <code>DocGenerateExecutor</code> æ¥å°è£…é€šç”¨çš„æµç¨‹ï¼Œä¸šåŠ¡é€»è¾‘åˆ™é€šè¿‡å‡½æ•°å¼æ¥å£ä¼ é€’ç»™æ‰§è¡Œå™¨ã€‚è¿™æ ·å¯ä»¥åœ¨ä¸åŒåœºæ™¯ä¸‹å¤ç”¨ç›¸åŒçš„æµç¨‹ï¼Œä¸”ä¿è¯æ‰©å±•æ€§ã€‚</li></ul><div class="tabs" id="å°è£…æ¨¡æ¿æ¨¡å¼"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#å°è£…æ¨¡æ¿æ¨¡å¼-1">DocGenerateExecutor</button></li><li class="tab"><button type="button" data-href="#å°è£…æ¨¡æ¿æ¨¡å¼-2">DocController</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="å°è£…æ¨¡æ¿æ¨¡å¼-1"><ul><li>é€šè¿‡æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå°†ä¸šåŠ¡é€»è¾‘ä¸é€šç”¨çš„æµç¨‹ä»£ç è§£è€¦ã€‚é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªé€šç”¨çš„ä»»åŠ¡æ‰§è¡Œå™¨ <code>DocGenerateExecutor</code> ç±»ï¼Œå®ƒè´Ÿè´£æ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘å¹¶å¤„ç†é€šç”¨çš„åç»­é€»è¾‘ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocGenerateExecutor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DocGenerateFun</span> &#123;</span><br><span class="line">        String <span class="title function_">executor</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateDoc</span><span class="params">(DocGenerateFun fun, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> fun.executor();</span><br><span class="line">        CommonUtil.setContentType(response, diskPath);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> +</span><br><span class="line">                java.net.URLEncoder.encode(FilenameUtils.getName(diskPath), <span class="string">&quot;UTF-8&quot;</span>).replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;%20&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        FileUtils.copyFile(<span class="keyword">new</span> <span class="title class_">File</span>(diskPath), outputStream);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å°è£…æ¨¡æ¿æ¨¡å¼-2"><ul><li>ä¸šåŠ¡é€»è¾‘åˆ™é€šè¿‡ <code>DocGenerateFun</code> æ¥å£ä¼ é€’ç»™ <code>DocGenerateExecutor</code>ï¼Œä¸åŒçš„ä»»åŠ¡åªéœ€å®ç°å…¶ä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€å…³å¿ƒé€šç”¨æµç¨‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/doc&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DocGenerateExecutor docGenerateExecutor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/generateOpenReport&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateOpenReport</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">OpenReport</span> <span class="variable">openReport</span> <span class="operator">=</span> openReportMapper.selectOne(Wrappers.lambdaQuery(OpenReport.class).eq(OpenReport::getOrderId, orderId));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç°åœ¨åªéœ€è¦ä¸€è¡Œå¤„ç†äº†</span></span><br><span class="line">        docGenerateExecutor.generateDoc(() -&gt; orderConsumerService.generateOpenReport(JSONObject.parseObject(json), openReport.getEdu(), orderId), response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/generateOpenReportPPT&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateOpenReportPPT</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        docGenerateExecutor.generateDoc(() -&gt; orderConsumerService.generateOpenReportPPT(JSONObject.parseObject(json), orderId), response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>åœ¨æ­¤ä¼˜åŒ–ä¸­ï¼Œ<code>DocGenerateExecutor</code> æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¨¡æ¿æ–¹æ³• <code>generateDoc</code> æ¥å¤„ç†æ‰€æœ‰ç±»ä¼¼çš„æµç¨‹ï¼Œä¸šåŠ¡é€»è¾‘åªéœ€ä¸“æ³¨äºå„è‡ªçš„å®ç°ã€‚è¿™ä¸ä»…å‡å°‘äº†é‡å¤ä»£ç ï¼Œè¿˜ä½¿å¾—æ¡†æ¶æ›´åŠ çµæ´»ã€å¯æ‰©å±•ã€‚</li></ul><h1>æ€»ç»“</h1><ul><li>é€šè¿‡æœ¬æ–‡çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•ä»é‡å¤ä»£ç ä¸­æå–å…±æ€§ï¼Œä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å°†é€šç”¨é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦ï¼Œæå‡ä»£ç çš„å¤ç”¨æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚é‡‡ç”¨è¿™ç§è®¾è®¡æ€è·¯ï¼Œèƒ½å¤Ÿæ˜¾è‘—å‡å°‘ä»£ç çš„å†—ä½™ï¼Œæå‡ç³»ç»Ÿçš„æ‰©å±•æ€§å’Œçµæ´»æ€§ã€‚</li></ul>]]></content>
    
    
    <summary type="html">æ‡’æ˜¯ç¬¬ä¸€ç”Ÿäº§åŠ›</summary>
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://cyborg2077.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/tags/%E9%9A%8F%E5%86%99/"/>
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://cyborg2077.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºå›¾çš„ä»»åŠ¡è°ƒåº¦ç®—æ³•</title>
    <link href="https://cyborg2077.github.io/2024/08/17/GraphBasedTaskScheduling/"/>
    <id>https://cyborg2077.github.io/2024/08/17/GraphBasedTaskScheduling/</id>
    <published>2024-08-17T05:04:48.000Z</published>
    <updated>2024-10-06T06:24:54.294Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>æœ¬æ–‡çš„çµæ„Ÿæ¥æºäº</li></ul><div class="tag link"><a class="link-card" title="4.4 è®¡ç®—å›¾çš„è°ƒåº¦ â€”â€” æœºå™¨å­¦ä¹ ç³»ç»Ÿ" href="https://openmlsys.github.io/chapter_computational_graph/schedule_of_computational_graph.html"><div class="left"><img src="https://openmlsys.github.io/_static/favicon.png"/></div><div class="right"><p class="text">4.4 è®¡ç®—å›¾çš„è°ƒåº¦ â€”â€” æœºå™¨å­¦ä¹ ç³»ç»Ÿ</p><p class="url">https://openmlsys.github.io/chapter_computational_graph/schedule_of_computational_graph.html</p></div></a></div><ul><li>åŸºäºè¯¥æ–‡ä¸­çš„ä»»åŠ¡è°ƒåº¦æ€æƒ³ï¼Œæˆ‘è®¾è®¡å¹¶å®ç°äº†ä¸€å¥—åŸºäºå›¾ç»“æ„çš„ä»»åŠ¡è°ƒåº¦å™¨ï¼Œä¸»è¦åº”ç”¨äºå¤æ‚ç³»ç»Ÿä¸­çš„ä»»åŠ¡ç®¡ç†ä¸æ‰§è¡Œã€‚</li><li>ä¸‹æ–‡å°†è¯¦ç»†ä»‹ç»è¯¥è°ƒåº¦å™¨çš„è®¾è®¡ç†å¿µã€æ ¸å¿ƒå®ç°ä»¥åŠå¦‚ä½•å°†ä»»åŠ¡ä¾èµ–å…³ç³»å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œä»¥æå‡ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</li></ul><h1>ä»»åŠ¡è°ƒåº¦ç­–ç•¥ç®€ä»‹</h1><ul><li>åœ¨ä¼ ç»Ÿçš„ä»»åŠ¡æ‰§è¡Œç¯å¢ƒä¸­ï¼Œä»»åŠ¡é€šå¸¸æŒ‰åºæ‰§è¡Œï¼Œä¾èµ–å…³ç³»è¾ƒä¸ºç®€å•ï¼Œå› æ­¤å¯ä»¥é‡‡ç”¨çº¿æ€§æ‰§è¡Œçš„æ–¹å¼ã€‚ä½†åœ¨å¤æ‚ç³»ç»Ÿä¸­ï¼Œä»»åŠ¡ä¹‹é—´å¾€å¾€å­˜åœ¨å¤šå±‚æ¬¡çš„ä¾èµ–å…³ç³»ï¼Œå½¢æˆå¤æ‚çš„ä¾èµ–é“¾ã€‚å¦‚æœæ²¡æœ‰åˆç†çš„ä»»åŠ¡è°ƒåº¦ç­–ç•¥ï¼Œç³»ç»Ÿå®¹æ˜“å‡ºç°ç“¶é¢ˆï¼Œèµ„æºä¹Ÿéš¾ä»¥å¾—åˆ°å……åˆ†åˆ©ç”¨ã€‚å› æ­¤ï¼Œè®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿæœ‰æ•ˆç®¡ç†ä»»åŠ¡ä¾èµ–å…³ç³»çš„è°ƒåº¦å™¨è‡³å…³é‡è¦ï¼Œè¿™ä¸ä»…å¯ä»¥é¿å…èµ„æºæµªè´¹ï¼Œè¿˜èƒ½ä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰è®¡åˆ’é¡ºåˆ©å®Œæˆã€‚</li><li>æœ¬æ–‡å®ç°çš„ä»»åŠ¡è°ƒåº¦é€»è¾‘åŸºäºæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ï¼Œå°†æ¯ä¸ªä»»åŠ¡æŠ½è±¡ä¸ºå›¾ä¸­çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„è¾¹è¡¨ç¤ºä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥å¾ˆå¥½åœ°å»ºæ¨¡å¤æ‚çš„ä»»åŠ¡ä¾èµ–ç»“æ„ï¼Œæä¾›äº†å¤„ç†å¤æ‚è°ƒåº¦åœºæ™¯çš„è§£å†³æ–¹æ¡ˆã€‚</li></ul><h1>è°ƒåº¦å™¨çš„è®¾è®¡ä¸å®ç°</h1><h2 id="çº¿ç¨‹æ± ä¸å¼‚æ­¥æ‰§è¡Œ">çº¿ç¨‹æ± ä¸å¼‚æ­¥æ‰§è¡Œ</h2><ul><li>ä¸ºäº†æå‡ä»»åŠ¡è°ƒåº¦å™¨çš„æ‰§è¡Œæ•ˆç‡ï¼Œé‡‡ç”¨äº†Javaçš„çº¿ç¨‹æ± å’Œå¼‚æ­¥æ“ä½œæ¥å®ç°å¹¶å‘ä»»åŠ¡çš„æ‰§è¡Œ<ul><li><code>çº¿ç¨‹æ± </code>ï¼šè°ƒåº¦å™¨é€šè¿‡<code>ExecutorService</code>åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± çš„å¤§å°æ ¹æ®ç³»ç»Ÿçš„å¤„ç†å™¨æ ¸å¿ƒæ•°é‡åŠ¨æ€è°ƒæ•´ï¼ˆæ ¹æ®è‡ªèº«ä¸šåŠ¡éœ€æ±‚è°ƒæ•´ï¼‰ã€‚ç¡®ä¿ä»»åŠ¡èƒ½å¹¶è¡Œæ‰§è¡Œï¼Œä»è€Œæœ€å¤§é™åº¦åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œæå‡ä»»åŠ¡å¤„ç†æ•ˆç‡ã€‚</li><li><code>å¼‚æ­¥æ“ä½œ</code>ï¼šè°ƒåº¦è¿‡ç¨‹ä¸­ï¼Œä»»åŠ¡è¢«æäº¤åˆ°çº¿ç¨‹æ± ä¸­å¼‚æ­¥æ‰§è¡Œï¼Œä½¿ç”¨Futureå¯¹è±¡ç®¡ç†æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚å½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œä¼šè‡ªåŠ¨æ›´æ–°ä¾èµ–å…¶çš„å­ä»»åŠ¡çŠ¶æ€ï¼Œå¹¶å°†å‡†å¤‡å°±ç»ªçš„å­ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…è¿›ä¸€æ­¥å¤„ç†ã€‚</li></ul></li><li>ä»¥ä¸‹æ˜¯ä»»åŠ¡è°ƒåº¦å™¨çš„æ ¸å¿ƒå®ç°ä»£ç ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTaskScheduler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯æ ¹æ®æˆ‘è‡ªèº«ä¸šåŠ¡éœ€æ±‚ï¼Œè‡ªå®šä¹‰çš„ä»»åŠ¡æ‰§è¡Œå™¨</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MyTaskExecutor myTaskExecutor;</span><br><span class="line">    <span class="comment">// å›¾ç»“æ„ï¼Œkeyæ˜¯ä»»åŠ¡IDï¼Œvalueæ˜¯å…¶ä¸‹å±å­ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;String&gt;&gt; graph = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å…¥åº¦mapï¼Œkeyæ˜¯ä»»åŠ¡IDï¼Œvalueæ˜¯èŠ‚ç‚¹çš„åº¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; inDegree = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// ä»»åŠ¡å‡½æ•°mapï¼Œkeyæ˜¯ä»»åŠ¡IDï¼Œvalueæ˜¯è¯¥ä»»åŠ¡çš„æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, TaskFunction&gt; taskFunctions = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡½æ•°å¼æ¥å£</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TaskFunction</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(MyTaskExecutor myTaskExecutor)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ ä»»åŠ¡ï¼Œéœ€æŒ‡å®šä»»åŠ¡IDå’Œä»»åŠ¡æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTask</span><span class="params">(String taskId, TaskFunction taskFunction)</span> &#123;</span><br><span class="line">        <span class="comment">// å‘å›¾ç»“æ„ä¸­åŠ å…¥ä»»åŠ¡èŠ‚ç‚¹</span></span><br><span class="line">        graph.putIfAbsent(taskId, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        <span class="comment">// åˆå§‹åº¦ä¸º0ï¼Œå³æ²¡æœ‰ä¾èµ–</span></span><br><span class="line">        inDegree.putIfAbsent(taskId, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// å­˜å‚¨è¯¥ä»»åŠ¡çš„æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">        taskFunctions.put(taskId, taskFunction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ ä¾èµ–ï¼ŒtaskId ä»»åŠ¡ä¾èµ–äº dependencyTaskId ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDependency</span><span class="params">(String taskId, String dependencyTaskId)</span> &#123;</span><br><span class="line">        graph.putIfAbsent(dependencyTaskId, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        graph.get(dependencyTaskId).add(taskId);</span><br><span class="line">        <span class="comment">// å¢åŠ å­ä»»åŠ¡çš„å…¥åº¦</span></span><br><span class="line">        inDegree.put(taskId, inDegree.getOrDefault(taskId, <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ é™¤ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTask</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        graph.remove(taskId);</span><br><span class="line">        inDegree.remove(taskId);</span><br><span class="line">        taskFunctions.remove(taskId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// BFSéå†</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTasksInOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        Queue&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é˜Ÿåˆ—ä¸­æ·»åŠ æ‰€æœ‰åº¦ä¸º0çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡æ— éœ€ä¾èµ–ï¼Œå¯ç›´æ¥æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">for</span> (String task : inDegree.keySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (inDegree.get(task) == <span class="number">0</span>) &#123;</span><br><span class="line">                queue.add(task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¼€ä¸ªçº¿ç¨‹æ± ï¼Œè¿™é‡ŒæŒ‰éœ€è°ƒæ•´ä½ çš„çº¿ç¨‹æ± å¤§å°</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">            <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">                List&lt;Future&lt;String&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> queue.size();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    <span class="comment">// å–å‡ºä»»åŠ¡</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">task</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">                    Future&lt;String&gt; future = executorService.submit(() -&gt; &#123;</span><br><span class="line">                        <span class="comment">// å¼‚æ­¥æ‰§è¡Œ</span></span><br><span class="line">                        <span class="type">TaskFunction</span> <span class="variable">taskFunction</span> <span class="operator">=</span> taskFunctions.get(task);</span><br><span class="line">                        <span class="keyword">if</span> (taskFunction != <span class="literal">null</span>) &#123;</span><br><span class="line">                            taskFunction.execute(myTaskExecutor);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> task;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    futures.add(future);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡ç»“æŸå¹¶å¤„ç†ä¾èµ–å…³ç³»</span></span><br><span class="line">                <span class="keyword">for</span> (Future&lt;String&gt; future : futures) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// éå†æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">completedTask</span> <span class="operator">=</span> future.get();</span><br><span class="line">                        <span class="keyword">for</span> (String dependent : graph.get(completedTask)) &#123;</span><br><span class="line">                            <span class="comment">// å°†ä¾èµ–ä»»åŠ¡å…¥åº¦ -1</span></span><br><span class="line">                            inDegree.put(dependent, inDegree.get(dependent) - <span class="number">1</span>);</span><br><span class="line">                            <span class="comment">// å¦‚æœå…¥åº¦ä¸º0ï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—</span></span><br><span class="line">                            <span class="keyword">if</span> (inDegree.get(dependent) == <span class="number">0</span>) &#123;</span><br><span class="line">                                queue.add(dependent);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨">è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨</h2><ul><li>è¿™é‡Œéœ€è¦æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæ¥è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTaskExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CreateTaskExecutor</span> &#123;</span><br><span class="line">        String <span class="title function_">executor</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoopTaskExecutor</span> &#123;</span><br><span class="line">        Wrapper&lt;ReportVO&gt; <span class="title function_">executor</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æš´éœ²ç»™ä»»åŠ¡è°ƒåº¦å™¨çš„å‡½æ•°ï¼Œè¿™é‡Œé¢å†™ä½ è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å³å¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeAndMonitorTask</span><span class="params">(CreateTaskExecutor createTask, LoopTaskExecutor monitorTask, SubOrder subOrder, String taskName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        createTaskExecutor4SubOrder(createTask, subOrder, taskName);</span><br><span class="line">        loopTaskExecutor4SubOrder(monitorTask, subOrder, taskName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTaskExecutor4SubOrder</span><span class="params">(CreateTaskExecutor taskExecutor, SubOrder subOrder, String taskName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ›å»ºä»»åŠ¡é€»è¾‘</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loopTaskExecutor4SubOrder</span><span class="params">(LoopTaskExecutor taskExecutor, SubOrder subOrder, String taskName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œè½®è¯¢ä»»åŠ¡é€»è¾‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>æ•°æ®åº“å­˜å‚¨ä¾èµ–å…³ç³»</h1><ul><li>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸ºäº†ç¡®ä¿ä»»åŠ¡ä¾èµ–å…³ç³»åœ¨ç³»ç»Ÿé‡å¯åä¸ä¸¢å¤±ï¼Œæˆ‘ä»¬æœ€å¥½å°†ä¾èµ–å…³ç³»å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚åœ¨è¿™éƒ¨åˆ†ä»£ç ä¸­ï¼Œä¾èµ–å…³ç³»å’Œä»»åŠ¡ä¿¡æ¯è¢«æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚é€šè¿‡è¿™æ ·çš„è®¾è®¡ï¼Œå½“ç³»ç»Ÿé‡æ–°å¯åŠ¨æ—¶ï¼Œä»»åŠ¡è°ƒåº¦å™¨å¯ä»¥ä»æ•°æ®åº“ä¸­æ¢å¤ä»»åŠ¡çŠ¶æ€ï¼Œå¹¶ç»§ç»­æ‰§è¡Œæœªå®Œæˆçš„ä»»åŠ¡ã€‚</li></ul><div class="tabs" id="mytaskscheduler"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#mytaskscheduler-1">MyTaskScheduler</button></li><li class="tab"><button type="button" data-href="#mytaskscheduler-2">Tasks</button></li><li class="tab"><button type="button" data-href="#mytaskscheduler-3">TaskDependency</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="mytaskscheduler-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTaskScheduler</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TasksMapper tasksMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TaskDependencyMapper taskDependencyMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MyTaskExecutor myTaskExecutor;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubOrderMapper subOrderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, TaskFunction&gt; taskFunctionStrategies = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TaskFunction</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(MyTaskExecutor myTaskExecutor)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTask</span><span class="params">(String taskId, TaskFunction taskFunction)</span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²ç»å­˜åœ¨</span></span><br><span class="line">        <span class="type">SubOrder</span> <span class="variable">existingSubOrder</span> <span class="operator">=</span> subOrderMapper.selectOne(Wrappers.lambdaQuery(SubOrder.class).eq(SubOrder::getOrderId, taskId));</span><br><span class="line">            <span class="keyword">if</span> (existingSubOrder != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (existingSubOrder.getStatus() == Common.ORDER_FINISH_STATUS) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;ä»»åŠ¡ &#123;&#125; å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ã€‚&quot;</span>, taskId);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (existingSubOrder.getStatus() != Common.ORDER_FINISH_STATUS) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;ä»»åŠ¡ï¼š&#123;&#125;ï¼ŒçŠ¶æ€ï¼š&#123;&#125;ï¼Œæ·»åŠ åˆ°è°ƒåº¦ç³»ç»Ÿ&quot;</span>, taskId, existingSubOrder.getStatus());</span><br><span class="line">                existingSubOrder.setStatus(Common.ORDER_SUCCESS_PAY_STATUS);</span><br><span class="line">                subOrderMapper.updateById(existingSubOrder);</span><br><span class="line">                taskFunctionStrategies.put(taskId, taskFunction);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// ä»»åŠ¡å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        taskFunctionStrategies.put(taskId, taskFunction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ èŠ‚ç‚¹ä¾èµ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDependency</span><span class="params">(String taskId, String dependencyTaskId)</span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥ä¾èµ–æ˜¯å¦å·²ç»å­˜åœ¨</span></span><br><span class="line">        <span class="type">TaskDependency</span> <span class="variable">existingDependency</span> <span class="operator">=</span> taskDependencyMapper.selectOne(Wrappers.lambdaQuery(TaskDependency.class)</span><br><span class="line">                .eq(TaskDependency::getTaskId, taskId)</span><br><span class="line">                .eq(TaskDependency::getDependencyTaskId, dependencyTaskId));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (existingDependency != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;ä»»åŠ¡ &#123;&#125; çš„ä¾èµ– &#123;&#125; å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ã€‚&quot;</span>, taskId, dependencyTaskId);</span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// ä¾èµ–å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¾èµ–ä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°ä¾èµ–</span></span><br><span class="line">        <span class="type">TaskDependency</span> <span class="variable">dependency</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskDependency</span>()</span><br><span class="line">                .setTaskId(taskId)</span><br><span class="line">                .setDependencyTaskId(dependencyTaskId)</span><br><span class="line">                .setCreateTime(LocalDateTime.now())</span><br><span class="line">                .setUpdateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        taskDependencyMapper.insert(dependency);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTasks</span><span class="params">(String rootTaskId)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        Queue&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (isRootTask(rootTaskId)) &#123;</span><br><span class="line">            queue.add(rootTaskId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å½“å‰ä»»åŠ¡èŠ‚ç‚¹ä¸æ˜¯æ ¹èŠ‚ç‚¹ï¼š&#123;&#125;&quot;</span>, rootTaskId);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Root task ID is not valid or has dependencies.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">                List&lt;Future&lt;String&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> queue.size();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">task</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">                    Future&lt;String&gt; future = executorService.submit(() -&gt; &#123;</span><br><span class="line">                        <span class="type">TaskFunction</span> <span class="variable">taskFunction</span> <span class="operator">=</span> taskFunctionStrategies.get(task);</span><br><span class="line">                        <span class="keyword">if</span> (taskFunction != <span class="literal">null</span>) &#123;</span><br><span class="line">                            taskFunction.execute(myTaskExecutor);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> task;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    futures.add(future);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Future&lt;String&gt; future : futures) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">completedTask</span> <span class="operator">=</span> future.get();</span><br><span class="line">                    List&lt;String&gt; dependents = getDependentTasks(completedTask);</span><br><span class="line">                    <span class="keyword">for</span> (String dependent : dependents) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (allDependenciesMet(dependent)) &#123;</span><br><span class="line">                            queue.add(dependent);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isRootTask</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taskDependencyMapper.selectCount(Wrappers.lambdaQuery(TaskDependency.class)</span><br><span class="line">                .eq(TaskDependency::getTaskId, taskId)) == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; <span class="title function_">getDependentTasks</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taskDependencyMapper.selectList(Wrappers.lambdaQuery(TaskDependency.class)</span><br><span class="line">                        .eq(TaskDependency::getDependencyTaskId, taskId))</span><br><span class="line">                .stream().map(TaskDependency::getTaskId).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">allDependenciesMet</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        List&lt;String&gt; dependencyTaskIds = taskDependencyMapper.selectList(Wrappers.lambdaQuery(TaskDependency.class)</span><br><span class="line">                        .eq(TaskDependency::getTaskId, taskId))</span><br><span class="line">                .stream().map(TaskDependency::getDependencyTaskId).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; completedTaskIds = subOrderMapper.selectList(Wrappers.lambdaQuery(SubOrder.class)</span><br><span class="line">                        .eq(SubOrder::getStatus, Common.ORDER_FINISH_STATUS))</span><br><span class="line">                .stream().map(SubOrder::getOrderId).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dependencyTaskIds.stream().allMatch(completedTaskIds::contains);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mytaskscheduler-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tasks</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String taskName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mytaskscheduler-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskDependency</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String dependencyTaskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">åŸºäºDAGçš„å¹¶å‘ä»»åŠ¡è°ƒåº¦å®ç°</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/tags/%E9%9A%8F%E5%86%99/"/>
    
  </entry>
  
  <entry>
    <title>Win10 è§£å†³L2TPè¿æ¥å°è¯•å¤±è´¥ï¼Œå› ä¸ºå®‰å…¨å±‚åœ¨åˆå§‹åŒ–ä¸è¿œç¨‹è®¡ç®—æœºçš„åå•†æ—¶é‡åˆ°ä¸€ä¸ªå¤„ç†é”™è¯¯</title>
    <link href="https://cyborg2077.github.io/2024/08/08/L2TPConnError/"/>
    <id>https://cyborg2077.github.io/2024/08/08/L2TPConnError/</id>
    <published>2024-08-08T08:18:08.000Z</published>
    <updated>2024-08-09T07:33:09.206Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>é…äº†å°æ–°ç”µè„‘ï¼Œç»“æœVPNè¿æ¥æœ‰é—®é¢˜ï¼Œè¯•äº†å„ç§æ–¹æ¡ˆä¹‹åï¼Œæœ€ç»ˆè¿ä¸Šäº†ï¼Œè®°å½•ä¸€ä¸‹<br><img src="https://s21.ax1x.com/2024/08/08/pkztw6I.png" alt=""></li></ul><h1>ä¿®æ”¹æ³¨å†Œè¡¨</h1><ol><li><p>CMDè¾“å…¥regedit<br><img src="https://s21.ax1x.com/2024/08/08/pkzYvTS.png" alt=""></p></li><li><p>è®¿é—®è¿™ä¸ªç›®å½•ï¼š<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PolicyAgent</code>ï¼ˆå¯ä»¥ç›´æ¥CVï¼‰ï¼Œå¦‚æœè¯¥ç›®å½•ä¸‹æœ‰è¿™ä¸ªkeyï¼š<code>AssumeUDPEncapsulationContextOnSendRule</code>ï¼ŒæŠŠå€¼ä¿®æ”¹ä¸º2ï¼Œå¦‚æœä½ å·²ç»æ˜¯æ­£ç¡®çš„é…ç½®ï¼Œè¯·å¿½ç•¥è¿™ä¸ªæ­¥éª¤ã€‚<br><img src="https://s21.ax1x.com/2024/08/08/pkztCSs.png" alt=""></p></li><li><p>è®¿é—®è¿™ä¸ªç›®å½•ï¼š<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RasMan\Parameters</code>ï¼Œå°†<code>ProhibitIpSec</code>çš„å€¼æ”¹ä¸º1ï¼Œå°†<code>AllowL2TPWeakCrypto</code>çš„å€¼æ”¹ä¸º1ï¼Œå¦‚æœä½ å·²ç»æ˜¯æ­£ç¡®çš„é…ç½®ï¼Œè¯·å¿½ç•¥è¿™ä¸ªæ­¥éª¤ã€‚æ²¡æœ‰å¯¹åº”çš„keyçš„è¯ï¼Œè¯·åˆ›å»ºã€‚<br><img src="https://s21.ax1x.com/2024/08/08/pkztPln.png" alt=""></p></li></ol><h1>å¯åŠ¨æœåŠ¡</h1><ol><li><p>æ­¤ç”µè„‘ -&gt; å³é”® -&gt; ç®¡ç† -&gt; æœåŠ¡<br><img src="https://s21.ax1x.com/2024/08/08/pkztFO0.png" alt=""></p></li><li><p>å°†<code>IPsec Policy Agent</code>å’Œ<code>Routing and Remote Access</code>éƒ½æ”¹ä¸ºè‡ªåŠ¨ï¼Œé‡å¯æœåŠ¡ã€‚<br><img src="https://s21.ax1x.com/2024/08/08/pkzt80K.png" alt=""></p></li></ol><h1>é‡å¯ç”µè„‘</h1><ol><li>é‡å¯ç”µè„‘ï¼Œè¿æ¥VPNå³å¯ã€‚</li></ol>]]></content>
    
    
    <summary type="html">è£…æœºæ€»æ˜¯ä¼šé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/tags/%E9%9A%8F%E5%86%99/"/>
    
  </entry>
  
  <entry>
    <title>å±€åŸŸç½‘æ–‡ä»¶è¿ç§»</title>
    <link href="https://cyborg2077.github.io/2024/08/08/LANFileMigrationGuide/"/>
    <id>https://cyborg2077.github.io/2024/08/08/LANFileMigrationGuide/</id>
    <published>2024-08-08T05:24:24.000Z</published>
    <updated>2024-08-09T07:37:41.823Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>æœ€è¿‘è£…äº†å°æ–°æœºï¼Œé…ç½®å¥½äº†å„ç§å¼€å‘ç¯å¢ƒä¹‹åï¼Œéœ€è¦æŠŠä¸€äº›é‡è¦çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚æˆ‘çš„åšå®¢ç›®å½•ï¼‰è¿ç§»åˆ°æ–°æœºå™¨ä¸Šï¼Œä½†æ˜¯åˆæ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªå¥½çš„æ–¹æ³•ã€‚è¦æ˜¯èƒ½ä»æ–°ç”µè„‘è®¿é—®åˆ°è€ç”µè„‘ä¸Šçš„æ–‡ä»¶å°±å¥½äº†ï¼Œç„¶åæç„¶å¤§æ‚Ÿï¼Œæˆ‘ç‰¹å–µçš„å¯ä»¥é€šè¿‡å±€åŸŸç½‘ä¼ è¾“</li></ul><h1>å‡†å¤‡å·¥ä½œ</h1><ol><li>æ£€æŸ¥ä¸¤å°ç”µè„‘æ˜¯å¦åœ¨åŒä¸€å±€åŸŸç½‘å†…</li></ol><ul><li>åˆ†åˆ«è¿è¡Œipconfigï¼ŒæŸ¥çœ‹ä¸¤å°ç”µè„‘çš„IPå’Œå­ç½‘æ©ç </li><li>ç¡®ä¿ä¸¤å°ç”µè„‘çš„IPå¤„äºç›¸åŒå­ç½‘å†…</li><li>æµ‹è¯•ç½‘ç»œè¿æ¥ï¼šä¸¤å°ç”µè„‘äº’ç›¸pingä¸€ä¸‹ï¼Œä¾‹å¦‚<code>ping 192.168.0.104</code>ï¼Œå¦‚æœèƒ½pingé€šï¼Œè¯´æ˜ç½‘ç»œè¿æ¥æ­£å¸¸</li></ul><h1>è®¾ç½®å…±äº«æ–‡ä»¶å¤¹</h1><ol><li><p>åœ¨éœ€è¦è¢«å…±äº«æ–‡ä»¶çš„ç”µè„‘ä¸Šè¿›è¡Œè®¾ç½®<br><img src="https://s21.ax1x.com/2024/08/08/pkztL9J.png" alt=""></p></li><li><p>æˆ‘è¿™ç§æƒ…å†µä¸‹å¯ä»¥ç›´æ¥æŠŠæ•´ä¸ªCç›˜å’ŒDç›˜å…±äº«å‡ºæ¥ï¼ˆ<code>äº‹åä¸€å®šè¦å…³é—­å…±äº«ï¼ï¼</code>ï¼‰ï¼Œå…¶ä½™åœºæ™¯å¯ä»¥æŒ‰éœ€å…±äº«ç›®å½•<br><img src="https://s21.ax1x.com/2024/08/08/pkztzB6.png" alt=""></p></li><li><p>é…ç½®ç½‘ç»œå‘ç°</p></li></ol><ul><li>æ§åˆ¶é¢æ¿ -&gt; ç½‘ç»œå’ŒInternet -&gt; ç½‘ç»œå’Œå…±äº«ä¸­å¿ƒ -&gt; æ›´æ”¹é«˜çº§å…±äº«è®¾ç½®<br><img src="https://s21.ax1x.com/2024/08/09/pkzX9Zd.png" alt=""></li><li>å¯ç”¨ç½‘ç»œå‘ç°å’Œæ–‡ä»¶/æ‰“å°æœºå…±äº«ï¼Œå¹¶ä¿å­˜æ›´æ”¹ã€‚<br><img src="https://s21.ax1x.com/2024/08/09/pkzjN1f.png" alt=""></li></ul><h1>è®¿é—®å…±äº«æ–‡ä»¶å¤¹</h1><ul><li>åœ¨å¦ä¸€å°ç”µè„‘ä¸Šè®¿é—®<code>\\192.168.0.104</code>ï¼Œå¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå¯ä»¥çœ‹åˆ°å…±äº«æ–‡ä»¶å¤¹ã€‚é‚£ä¹ˆç°åœ¨å°±å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥CVä¸€äº›æ•°æ®äº†ã€‚<br><img src="https://s21.ax1x.com/2024/08/09/pkzjwng.png" alt=""></li></ul>]]></content>
    
    
    <summary type="html">è£…å®Œæ–°æœºï¼Œéœ€è¦è¿ç§»æ•°æ®</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/tags/%E9%9A%8F%E5%86%99/"/>
    
  </entry>
  
  <entry>
    <title>æ³°æ‹‰ç‘äºš-åéª‘Modå¼€å‘</title>
    <link href="https://cyborg2077.github.io/2024/07/20/PolWorldMountsDev/"/>
    <id>https://cyborg2077.github.io/2024/07/20/PolWorldMountsDev/</id>
    <published>2024-07-20T05:25:54.000Z</published>
    <updated>2024-11-03T01:31:44.894Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>å…¥é—¨çº§æ•™ç¨‹è¯·å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« </li><li>Gitä»“åº“ï¼š<a href="https://github.com/Cyborg2077/PolWorldMounts">https://github.com/Cyborg2077/PolWorldMounts</a></li><li>Steamåˆ›æ„å·¥åŠï¼š<a href="https://steamcommunity.com/sharedfiles/filedetails/?id=3292980622">https://steamcommunity.com/sharedfiles/filedetails/?id=3292980622</a></li><li>æœ¬æ–‡è¿›åº¦ä¼šç•¥å¾®è½åäºåˆ›æ„å·¥åŠç‰ˆæœ¬</li></ul><div class="note info no-icon flat"><p>v0.7æ›´æ–°</p><ol><li>ä¸ºç©ºæ¶¡é¾™å¢åŠ äº†ä¸‰ä¸ªæŠ€èƒ½ï¼šçƒˆç„°é£æš´ï¼ˆZé”®ï¼‰ã€å…‰æŸå½—æ˜Ÿï¼ˆXé”®ï¼‰ã€é¾™å½—æ˜Ÿï¼ˆCé”®ï¼‰ã€‚çƒˆç„°é£æš´ä¼šå¸é™„å‘¨å›´çš„æ•Œå¯¹NPCã€é¾™å½—æ˜Ÿä¼šæ²¿é¼ æ ‡æ–¹å‘å‘å°„ã€å…‰æŸå½—æ˜Ÿçš„åˆå§‹æ–¹å‘æ²¿é¼ æ ‡æ–¹å‘å‘å°„ï¼Œéšåè‡ªåŠ¨è¿½è¸ªå‘¨å›´æ•Œæ€ªã€‚</li><li>äº‘æµ·é¹¿å’Œè‰è½çŒªçš„å†²åˆºæ”¹ä¸ºZé”®ã€‚</li></ol></div><div class="note info no-icon flat"><p>v0.6æ›´æ–°</p><ol><li>å¢åŠ äº†ç©ºæ¶¡é¾™åéª‘ï¼Œåˆæˆé…æ–¹ï¼š10ä¸ªå¤œæ˜é”­ + 20ä¸ªä¸ç»¸ + 5ä¸ªè“ç‰ï¼Œéœ€è¦å¸•é²è£…ç½®åˆ¶ä½œå°</li><li>å¢åŠ äº†å¸•é²è£…ç½®åˆ¶ä½œå°ï¼Œåˆæˆææ–™ï¼š30ä¸ªæœ¨å¤´ + 10ä¸ªä¸ç»¸ + 10ä¸ªè“ç‰</li><li>ä¿®æ”¹äº†è‰è½çŒªå’Œäº‘æµ·é¹¿çš„åˆæˆé…æ–¹</li></ol><ul><li>è‰è½çŒªï¼š10ä¸ªæœ¨å¤´ + 10ä¸ªçŸ³å¤´ + 5ä¸ªè“ç‰ + 10ä¸ªçš®é© + 5ä¸ªæ¤éª¨ï¼Œå•å‡»å³é”®è¿›è¡Œå†²åˆºï¼Œå†²åˆºä¼šæ‘§æ¯æ²¿é€”è·¯ä¸Šçš„æ™®é€šæ ‘æœ¨ï¼ˆä¸€äº›ç‰¹æ®Šæ ‘æœ¨å¦‚æ¨±èŠ±æ ‘ç­‰é™¤å¤–ï¼‰</li><li>äº‘æµ·é¹¿ï¼š20ä¸ªç¥åœ£é”­ + 5ä¸ªé£ç¿”ä¹‹é­‚ + 5ä¸ªå…‰æ˜ä¹‹é­‚ + 5ä¸ªè“ç‰ï¼Œå¯ä»¥è¿›è¡ŒäºŒæ®µè·³ï¼Œå•å‡»å³é”®è¿›è¡Œå†²åˆº</li></ul></div><h1>å¦‚ä½•è‡ªå®šä¹‰åéª‘</h1><ul><li><p>åŸç‰ˆTerrariaé‡Œçš„åéª‘ï¼Œé¦–å…ˆéƒ½è¦æœ‰ä¸€ä¸ªå¬å”¤ç‰©ã€‚<br><img src="https://s21.ax1x.com/2024/07/20/pkTDrp6.png" alt=""></p></li><li><p>å…¶æ¬¡å°±æ˜¯æœ‰ä¸€ä¸ªbuffå›¾æ ‡<br><img src="https://s21.ax1x.com/2024/07/20/pkTDs1K.png" alt=""></p></li><li><p>æœ€åå°±æ˜¯åéª‘æœ¬ä½“<br><img src="https://s21.ax1x.com/2024/07/20/pkTDy6O.png" alt=""></p></li><li><p>æ‰€ä»¥é¦–å…ˆæˆ‘ä»¬è¦å…ˆæ¥åˆ¶ä½œè¿™ä¸ªå¬å”¤ç‰©ã€‚é‚£ä¹ˆç¬¬ä¸€æ­¥æˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€ä¸ªModé¡¹ç›®å§ã€‚<br><img src="https://s21.ax1x.com/2024/07/20/pkT00b9.png" alt=""></p></li></ul><h1>åˆ¶ä½œå¬å”¤ç‰©</h1><ul><li>å¬å”¤ç‰©çš„æœ¬è´¨å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªItemï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±»ï¼Œç»§æ‰¿ModItemå³å¯ã€‚</li><li>åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬æ¥å®šä¹‰å¬å”¤ç‰©çš„ä¸€äº›å±æ€§ï¼Œä»¥åŠåˆæˆææ–™</li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Mounts;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Items.Mounts</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FenglopeMountItem</span> : <span class="title">ModItem</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span> &#123;</span><br><span class="line">Item.width = <span class="number">20</span>;</span><br><span class="line">Item.height = <span class="number">30</span>;</span><br><span class="line">Item.useTime = <span class="number">20</span>;</span><br><span class="line">Item.useAnimation = <span class="number">20</span>;</span><br><span class="line">Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">Item.<span class="keyword">value</span> = Item.sellPrice(gold: <span class="number">3</span>);</span><br><span class="line">Item.rare = ItemRarityID.Green;</span><br><span class="line">Item.UseSound = SoundID.Item79;</span><br><span class="line">Item.noMelee = <span class="literal">true</span>;</span><br><span class="line">Item.mountType = ModContent.MountType&lt;FenglopeMount&gt;(); <span class="comment">// è¿™ä¸ªæ˜¯è°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„åéª‘</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œç®€å•ç”¨ä¸€ä¸ªæ³¥åœŸåˆæˆï¼Œå®é™…ä¸Šå¯ä»¥æ”¹æˆ10ä¸ªæœ¨æã€10ä¸ªçŸ³å¤´ã€5ä¸ªè“å®çŸ³æ¥è¿›è¡Œåˆæˆï¼Œè¿™æ ·çš„åˆæˆé…æ–¹å’Œå¸•é²ä¸­ç±»ä¼¼</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span> &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, <span class="number">1</span>);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç‰©å“åˆ¶ä½œå®Œæ¯•åï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ¶ä½œè´´å›¾ï¼Œè¿™é‡Œæˆ‘å°±ä»¥å¸•é²çƒä¸ºä¾‹åˆ¶ä½œè´´å›¾äº†ã€‚ç”»é£æœ€å¥½æ˜¯ç¬¦åˆæ³°æ‹‰ç‘äºšçš„åƒç´ é£ï¼Œè¿™æ ·çœ‹èµ·æ¥æ¯”è¾ƒèˆ’æœã€‚</li><li>é‚£æˆ‘ä»¬ç›´æ¥å¯åŠ¨å¹»å…½å¸•é²ï¼Œè¿›æ¸¸æˆæˆªä¸€å¼ å¸•é²çƒçš„å›¾<br><img src="https://s21.ax1x.com/2024/07/20/pkTDbng.png" alt=""></li><li>æ‹¿åˆ°å›¾è‚¯å®šä¸èƒ½ç›´æ¥ç”¨ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ‰£æ‰èƒŒæ™¯ï¼Œéšåè½¬ä¸ºåƒç´ é£ï¼Œè°ƒæ•´å°ºå¯¸ä¸º32*32ã€‚æ‰£èƒŒæ™¯æˆ‘è¿™é‡Œç›´æ¥ç”¨çš„ç™¾åº¦AIå›¾ç‰‡åŠ©æ‰‹ï¼Œæ‰£å¥½äº†ä¹‹åä¸‹è½½åˆ°æœ¬åœ°ï¼Œæˆ‘ä»¬æ¥è¿›ä¸€æ­¥å¤„ç†åƒç´ é£<br><img src="https://s21.ax1x.com/2024/07/20/pkTDL7j.png" alt=""></li><li>åƒç´ é£çš„å¤„ç†ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç”¨çš„Pythonçš„PILåº“æ¥è¿›è¡Œå¤„ç†</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pixelate</span>(<span class="params">image_path, block_size</span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">    w, h = img.size</span><br><span class="line">    img_small = img.resize((w // block_size, h // block_size), resample=Image.NEAREST)</span><br><span class="line">    result = img_small.resize(img.size, Image.NEAREST)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pixelated_image = pixelate(<span class="string">&#x27;å¸•é²çƒ.png&#x27;</span>, <span class="number">7</span>)</span><br><span class="line">pixelated_image.save(<span class="string">&#x27;pixelated.png&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>å¤„ç†åçš„æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ï¼Œé‚£ä¹ˆäº‘æµ·é¹¿å¬å”¤ç‰©çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±å¼€å‘å®Œæ¯•äº†<br><img src="https://s2.loli.net/2024/07/20/YzJrkLEFQVwUuxc.png" alt=""></li></ul><h1>åˆ¶ä½œåéª‘</h1><ul><li>åéª‘çš„åˆ›å»ºï¼Œæˆ‘ä»¬åŒæ ·éœ€è¦ç»§æ‰¿ModMountï¼Œéšåå°±æ˜¯å®šä¹‰åéª‘çš„åŸºæœ¬å±æ€§ï¼Œäº‘æµ·é¹¿çš„ç‰¹æ€§æœ‰äºŒæ®µè·³ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¸é˜»æ­¢ä½¿ç”¨é¢å¤–è·³è·ƒï¼Œåªè¦ä½ è£…å¤‡äº†äº‘æœµç“¶æˆ–è€…æ°”çƒæŸä¹‹ç±»çš„ä¼šäº§ç”Ÿé¢å¤–è·³è·ƒçš„é¥°å“ï¼Œå½“ä½ åœ¨éª‘è¡Œäº‘æµ·é¹¿çš„æ—¶å€™ï¼Œéƒ½å¯ä»¥æ­£å¸¸è§¦å‘ã€‚  <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FenglopeMount</span> : <span class="title">ModMount</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetStaticDefaults</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰åéª‘çš„åŸºæœ¬å±æ€§</span></span><br><span class="line">        MountData.jumpHeight = <span class="number">20</span>; <span class="comment">// åéª‘èƒ½è·³å¤šé«˜</span></span><br><span class="line">        MountData.acceleration = <span class="number">0.19f</span>; <span class="comment">// åŠ é€Ÿç‡ï¼Œå³åéª‘åŠ é€Ÿçš„é€Ÿåº¦</span></span><br><span class="line">        MountData.jumpSpeed = <span class="number">20f</span>; <span class="comment">// å½“æŒ‰ä¸‹è·³è·ƒé”®æ—¶ï¼Œåéª‘å’Œç©å®¶å‘ä¸Šè·³è·ƒçš„é€Ÿåº¦</span></span><br><span class="line">        MountData.blockExtraJumps = <span class="literal">false</span>; <span class="comment">// æ˜¯å¦é˜»æ­¢ä½¿ç”¨é¢å¤–è·³è·ƒï¼ˆå¦‚ç“¶å­ä¸­çš„äº‘ï¼‰</span></span><br><span class="line">        MountData.constantJump = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦å…è®¸æŒ‰ä½è·³è·ƒé”®è¿›è¡Œè¿ç»­è·³è·ƒ</span></span><br><span class="line">        MountData.heightBoost = <span class="number">20</span>; <span class="comment">// åéª‘ä¸åœ°é¢ä¹‹é—´çš„é«˜åº¦</span></span><br><span class="line">        MountData.fallDamage = <span class="number">0f</span>; <span class="comment">// ä»é«˜å¤„è·Œè½æ—¶å—åˆ°çš„ä¼¤å®³å€ç‡</span></span><br><span class="line">        MountData.runSpeed = <span class="number">11f</span>; <span class="comment">// åéª‘çš„å¥”è·‘é€Ÿåº¦</span></span><br><span class="line">        MountData.dashSpeed = <span class="number">8f</span>; <span class="comment">// å†²åˆºé€Ÿåº¦</span></span><br><span class="line">        MountData.flightTimeMax = <span class="number">0</span>; <span class="comment">// æœ€å¤§é£è¡Œæ—¶é—´ï¼Œ0è¡¨ç¤ºä¸èƒ½é£è¡Œ</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®ç–²åŠ³æœ€å¤§å€¼ä¸º0ï¼Œæ„å‘³ç€éª‘ä¹˜æ—¶ä¸ä¼šäº§ç”Ÿç–²åŠ³</span></span><br><span class="line">        MountData.fatigueMax = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³è”åéª‘çš„Buffï¼Œå³éª‘ä¹˜æ—¶ç©å®¶è·å¾—çš„çŠ¶æ€æ•ˆæœ</span></span><br><span class="line">        MountData.buff = ModContent.BuffType&lt;Buffs.FenglopeMountBuff&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ¨ç”»å¸§æ•°å’Œç©å®¶åç§»é‡è®¾ç½®</span></span><br><span class="line">        MountData.totalFrames = <span class="number">5</span>; <span class="comment">// æ€»å…±çš„åŠ¨ç”»å¸§æ•°ï¼Œå–å†³äºä½ è‡ªå·±çš„è´´å›¾</span></span><br><span class="line">        MountData.playerYOffsets = Enumerable.Repeat(<span class="number">20</span>, MountData.totalFrames).ToArray(); <span class="comment">// ç©å®¶ç›¸å¯¹äºåéª‘çš„Yè½´åç§»é‡æ•°ç»„ï¼Œç”¨äºå¾®è°ƒç©å®¶åœ¨åéª‘è´´å›¾çš„ä½ç½®</span></span><br><span class="line">        MountData.xOffset = <span class="number">20</span>; <span class="comment">// ç©å®¶ç›¸å¯¹äºåéª‘çš„Xè½´åç§»é‡ï¼Œç”¨äºå¾®è°ƒç©å®¶åœ¨åéª‘è´´å›¾ä¸Šçš„ä½ç½®</span></span><br><span class="line">        MountData.yOffset = <span class="number">-12</span>; <span class="comment">// ç©å®¶ç›¸å¯¹äºåéª‘çš„Yè½´åç§»é‡ï¼Œç”¨äºå¾®è°ƒç©å®¶åœ¨åéª‘è´´å›¾ä¸Šçš„ä½ç½®</span></span><br><span class="line">        MountData.playerHeadOffset = <span class="number">22</span>; <span class="comment">// ç©å®¶å¤´éƒ¨ç›¸å¯¹äºåéª‘çš„åç§»é‡ï¼Œç”¨äºå¾®è°ƒç©å®¶åœ¨åéª‘è´´å›¾ä¸Šçš„ä½ç½®</span></span><br><span class="line">        MountData.bodyFrame = <span class="number">3</span>; <span class="comment">// ç©å®¶èº«ä½“åœ¨åéª‘ä¸Šçš„å¸§å·</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸åŒçŠ¶æ€ä¸‹çš„åŠ¨ç”»è®¾ç½®</span></span><br><span class="line">        <span class="comment">// ç«™ç«‹</span></span><br><span class="line">        MountData.standingFrameCount = <span class="number">0</span>;</span><br><span class="line">        MountData.standingFrameDelay = <span class="number">12</span>;</span><br><span class="line">        MountData.standingFrameStart = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¥”è·‘</span></span><br><span class="line">        MountData.runningFrameCount = <span class="number">4</span>;</span><br><span class="line">        MountData.runningFrameDelay = <span class="number">120</span>;</span><br><span class="line">        MountData.runningFrameStart = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// é£è¡Œ</span></span><br><span class="line">        MountData.flyingFrameCount = <span class="number">0</span>;</span><br><span class="line">        MountData.flyingFrameDelay = <span class="number">0</span>;</span><br><span class="line">        MountData.flyingFrameStart = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// ç©ºä¸­</span></span><br><span class="line">        MountData.inAirFrameCount = <span class="number">1</span>;</span><br><span class="line">        MountData.inAirFrameDelay = <span class="number">12</span>;</span><br><span class="line">        MountData.inAirFrameStart = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// é—²ç½®</span></span><br><span class="line">        MountData.idleFrameCount = <span class="number">4</span>;</span><br><span class="line">        MountData.idleFrameDelay = <span class="number">12</span>;</span><br><span class="line">        MountData.idleFrameStart = <span class="number">0</span>;</span><br><span class="line">        MountData.idleFrameLoop = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// æ¸¸æ³³</span></span><br><span class="line">        MountData.swimFrameCount = MountData.inAirFrameCount;</span><br><span class="line">        MountData.swimFrameDelay = MountData.inAirFrameDelay;</span><br><span class="line">        MountData.swimFrameStart = MountData.inAirFrameStart;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>ç›´æ¥å«ä¸Šä¸€ä¸ªå¥½å…„å¼Ÿå½“å·¥å…·äººï¼Œå»æ¸¸æˆé‡Œç®€å•å½•ä¸€æ®µäº‘æµ·é¹¿çš„è·‘æ­¥åŠ¨ç”»ï¼Œç„¶åè‡ªå·±æˆªå›¾æ‰£ä¸‹æ¥<br><img src="https://s21.ax1x.com/2024/07/20/pkTrdKS.png" alt=""></li><li>æ•´ä¸ªModå¼€å‘è€—æ—¶æœ€ä¹…çš„å°±æ˜¯æŠ å›¾ï¼Œå“ˆå“ˆå“ˆå“ˆï¼Œä¸€å¼ ä¸€å¼ æ‰£å®Œä¹‹åï¼Œä¸‹è½½ä¿å­˜åˆ°æœ¬åœ°ï¼Œç„¶åæˆ‘ç®€å•å†™äº†ä¸ªåˆæˆè„šæœ¬ï¼ŒæŠŠå¤šå¼ å›¾å‚ç›´æ’åˆ—åˆå¹¶ï¼Œå¹¶ç¼©æ”¾ï¼Œä»£ç ç›®å½•ä¸‹æŒ‰ä½ çš„é¡ºåºå­˜æ”¾1.png~5.pngå³å¯</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pixelate</span>(<span class="params">image_path, block_size</span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">    w, h = img.size</span><br><span class="line">    img_small = img.resize((w // block_size, h // block_size), resample=Image.NEAREST)</span><br><span class="line">    result = img_small.resize(img.size, Image.NEAREST)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scale_image</span>(<span class="params">image, scale_factor</span>):</span><br><span class="line">    <span class="comment"># è·å–å½“å‰å›¾ç‰‡çš„å°ºå¯¸</span></span><br><span class="line">    width, height = image.size</span><br><span class="line">    <span class="comment"># è®¡ç®—æ–°çš„å°ºå¯¸</span></span><br><span class="line">    new_width = width // scale_factor</span><br><span class="line">    new_height = height // scale_factor</span><br><span class="line">    <span class="comment"># è¿”å›ç¼©æ”¾åçš„å›¾ç‰‡</span></span><br><span class="line">    <span class="keyword">return</span> image.resize((new_width, new_height), Image.ANTIALIAS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜å¤„ç†åçš„å›¾ç‰‡å¯¹è±¡å’Œå°ºå¯¸</span></span><br><span class="line">processed_images = []</span><br><span class="line">total_width = <span class="number">0</span></span><br><span class="line">total_height = <span class="number">0</span></span><br><span class="line">scale_factor = <span class="number">4</span>  <span class="comment"># ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç†å›¾ç‰‡å¹¶è®¡ç®—æ€»é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    pixelated_image = pixelate(<span class="string">f&#x27;<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>.png&#x27;</span>, <span class="number">10</span>)</span><br><span class="line">    scaled_image = scale_image(pixelated_image, scale_factor)</span><br><span class="line">    processed_images.append(scaled_image)</span><br><span class="line">    total_width = <span class="built_in">max</span>(total_width, scaled_image.width)</span><br><span class="line">    total_height += scaled_image.height</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€å¼ æ–°å›¾ç‰‡ï¼ŒèƒŒæ™¯é¢œè‰²ä¸ºé€æ˜</span></span><br><span class="line">new_image = Image.new(<span class="string">&#x27;RGBA&#x27;</span>, (total_width, total_height), color=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ¯å¼ å¤„ç†åçš„å›¾ç‰‡ç²˜è´´åˆ°æ–°å›¾ç‰‡ä¸Š</span></span><br><span class="line">y_offset = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> img <span class="keyword">in</span> processed_images:</span><br><span class="line">    new_image.paste(img, (<span class="number">0</span>, y_offset), img)</span><br><span class="line">    y_offset += img.height</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜æ–°å›¾ç‰‡</span></span><br><span class="line">new_image.save(<span class="string">&#x27;combined_pixelated.png&#x27;</span>, <span class="string">&#x27;PNG&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>æœ€ç»ˆçš„æ•ˆæœ<br><img src="https://s21.ax1x.com/2024/07/20/pkTrDEj.png" alt=""></li></ul><h1>åˆ¶ä½œåéª‘BUFF</h1><ul><li>ç©å®¶ä½¿ç”¨åéª‘ï¼Œå…¶å®æ˜¯å¯¹è‡ªèº«æ–½åŠ ä¸€ä¸ªbuffï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦ç¼–å†™ä¸€ä¸ªäº‘æµ·é¹¿çš„åéª‘BUFF</li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Mounts; <span class="comment">// å¼•å…¥æ¨¡ç»„ä¸­ Mounts ç›®å½•ä¸‹çš„å‘½åç©ºé—´</span></span><br><span class="line"><span class="keyword">using</span> Terraria; <span class="comment">// å¼•å…¥æ¸¸æˆä¸»å¼•æ“çš„å‘½åç©ºé—´</span></span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader; <span class="comment">// å¼•å…¥æ¨¡ç»„åŠ è½½å™¨çš„å‘½åç©ºé—´</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Buffs</span> &#123; <span class="comment">// å®šä¹‰æ¨¡ç»„ Buffs ç›®å½•ä¸‹çš„å‘½åç©ºé—´</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FenglopeMountBuff</span> : <span class="title">ModBuff</span> &#123; <span class="comment">// å®šä¹‰ä¸€ä¸ªç»§æ‰¿è‡ª ModBuff çš„å…¬å…±ç±» FenglopeMountBuff</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetStaticDefaults</span>()</span> &#123; <span class="comment">// é‡å†™çˆ¶ç±»çš„æ–¹æ³• SetStaticDefaults</span></span><br><span class="line">            Main.buffNoTimeDisplay[Type] = <span class="literal">true</span>; <span class="comment">// è®¾ç½®æ­¤Buffä¸ä¼šæ˜¾ç¤ºæŒç»­æ—¶é—´</span></span><br><span class="line">            Main.buffNoSave[Type] = <span class="literal">true</span>; <span class="comment">// è®¾ç½®æ­¤Buffä¸ä¼šè¢«ä¿å­˜ï¼Œå³åœ¨æ­»äº¡æˆ–é€€å‡ºä¸–ç•Œåæ¶ˆå¤±</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">Player player, <span class="keyword">ref</span> <span class="built_in">int</span> buffIndex</span>)</span> &#123; <span class="comment">// é‡å†™çˆ¶ç±»çš„æ–¹æ³• Updateï¼Œå½“Buffåº”ç”¨åˆ°ç©å®¶èº«ä¸Šæ—¶è¢«è°ƒç”¨</span></span><br><span class="line">            player.mount.SetMount(ModContent.MountType&lt;FenglopeMount&gt;(), player); <span class="comment">// è®¾ç½®ç©å®¶çš„åéª‘ä¸º FenglopeMount</span></span><br><span class="line">            player.buffTime[buffIndex] = <span class="number">10</span>; <span class="comment">// è®¾ç½®Buffçš„æŒç»­æ—¶é—´ä¸º10å¸§ï¼Œå®é™…ä½œç”¨æ˜¯æŒç»­åˆ·æ–°ï¼Œå› ä¸ºä¼šä¸æ–­è¢«é‡æ–°åº”ç”¨</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç®€å•åˆ¶ä½œä¸€ä¸ªBuffå›¾æ ‡ï¼ŒåŒæ ·æ˜¯ä½¿ç”¨ç™¾åº¦æŠ å›¾ï¼Œéšåå°†å›¾ç‰‡ä¸‹è½½åˆ°æœ¬åœ°ï¼Œéšååƒç´ åŒ–ï¼Œå¹¶ä¸”æŒ‡å®šå›¾ç‰‡å°ºå¯¸ä¸º32x32</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pixelate</span>(<span class="params">image_path, output_size</span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">    img_small = img.resize(output_size, resample=Image.NEAREST)</span><br><span class="line">    block_size_w = img.width // output_size[<span class="number">0</span>]</span><br><span class="line">    block_size_h = img.height // output_size[<span class="number">1</span>]</span><br><span class="line">    img_pixelated = img_small.resize((img.width // block_size_w, img.height // block_size_h), resample=Image.NEAREST)</span><br><span class="line">    result = img_pixelated.resize(output_size, Image.NEAREST)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pixelated_image = pixelate(<span class="string">&#x27;äº‘æµ·é¹¿.png&#x27;</span>, (<span class="number">32</span>, <span class="number">32</span>))</span><br><span class="line">pixelated_image.save(<span class="string">&#x27;pixelated_image_äº‘æµ·é¹¿.png&#x27;</span>)</span><br></pre></td></tr></table></figure><h1>æ³°æ‹‰ç‘äºš å¯åŠ¨ï¼</h1><ul><li>é‡æ–°ç”Ÿæˆå¹¶åŠ è½½Modï¼Œæˆ‘ä»¬çš„äº‘æµ·é¹¿å°±å·²ç»å¯ä»¥ä½¿ç”¨äº†ï¼Œåªéœ€è¦ä¸€å—æ³¥åœŸè¿›è¡Œåˆ¶ä½œï¼Œä¸éœ€è¦ä»»ä½•åˆæˆå°<br><img src="https://s2.loli.net/2024/07/20/4FNxEZub52QvhOi.png" alt=""></li></ul><h1>å¢å¼ºäº‘æµ·é¹¿</h1><h2 id="ä¸å†éœ€è¦äº‘ç“¶è¿›è¡ŒäºŒæ®µè·³">ä¸å†éœ€è¦äº‘ç“¶è¿›è¡ŒäºŒæ®µè·³</h2><ul><li>å¸¦ä¸ªäº‘ç“¶å¤ªéº»çƒ¦äº†ï¼Œèƒ½ä¸èƒ½è‡ªå·±æƒ³æƒ³åŠæ³•æ¥å®ç°äºŒæ®µè·³å‘¢ï¼Ÿå½“ç„¶æ˜¯æœ‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåˆ›å»ºä¸€ä¸ªäºŒæ®µè·³çš„æ ‡å¿—ä½ã€‚æ ‡è¯†ç©å®¶æ˜¯å¦å·²ç»è¿›è¡Œäº†äºŒæ®µè·³ã€‚</li><li>éšåæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­ç©å®¶çš„Yè½´é€Ÿåº¦æ˜¯å¦ä¸º0æ¥åˆ¤æ–­æ˜¯å¦å¤„äºåœ°é¢ã€‚<ul><li>å¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆé‡ç½®ä¸€ä¸‹äºŒæ®µè·³çš„æ ‡å¿—ä½ã€‚</li><li>å¦‚æœä¸æ˜¯çš„è¯ï¼Œå°±å¯ä»¥è¿›è¡ŒäºŒæ®µè·³äº†ã€‚</li></ul></li><li>é‚£ä¹ˆæ¥ä¸‹æ¥çœ‹ä»£ç é€»è¾‘</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">bool</span> hasDoubleJumped = <span class="literal">false</span>; <span class="comment">// æ ‡å¿—ä½ï¼šæ˜¯å¦å·²ç»äºŒæ®µè·³</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// äºŒæ®µè·³é€»è¾‘</span></span><br><span class="line"><span class="keyword">if</span> (player.controlJump) <span class="comment">// ç©å®¶æŒ‰ä¸‹äº†è·³è·ƒé”®</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (player.velocity.Y == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        hasDoubleJumped = <span class="literal">false</span>; <span class="comment">// é‡ç½®äºŒæ®µè·³æ ‡å¿—ä½</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!hasDoubleJumped &amp;&amp; player.releaseJump) <span class="comment">// ç¡®ä¿æ²¡æœ‰æ‰§è¡ŒäºŒæ®µè·³ä¸”ç©å®¶æ¾å¼€äº†è·³è·ƒé”®</span></span><br><span class="line">    &#123;</span><br><span class="line">        player.velocity.Y = <span class="number">-18</span>; <span class="comment">// è®¾ç½®è·³è·ƒé€Ÿåº¦</span></span><br><span class="line">        hasDoubleJumped = <span class="literal">true</span>; <span class="comment">// è®¾ç½®äºŒæ®µè·³æ ‡å¿—ä½ï¼Œé˜²æ­¢ç©å®¶æ— é™è·³è·ƒ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) <span class="comment">// è¿™é‡Œåªæ˜¯åŠ äº†ä¸€ä¸ªç²’å­ç‰¹æ•ˆï¼Œæ¨¡ä»¿äº‘ç“¶çš„äºŒæ®µè·³æ•ˆæœï¼Œåªæ˜¯ä¸ºäº†å¥½çœ‹ï¼Œæ²¡æœ‰å…¶ä»–ä½œç”¨</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 dustPosition = player.position;</span><br><span class="line">            Dust dust = Dust.NewDustDirect(dustPostion, player.width, player.height, DustID.Snow, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, Color.White, <span class="number">1.5f</span>);</span><br><span class="line">            dust.velocity *= <span class="number">1.2f</span>;</span><br><span class="line">            dust.color = Color.White; </span><br><span class="line">            dust.noGravity = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™æ ·çš„è¯ï¼Œå°±ä¸å†éœ€è¦äº‘ç“¶æ¥å®ç°äºŒæ®µè·³å•¦ã€‚</li></ul><h2 id="å¢åŠ å†²åˆºæŠ€èƒ½">å¢åŠ å†²åˆºæŠ€èƒ½</h2><ul><li>äº‘æµ·é¹¿çš„æ‹›ç‰ŒæŠ€èƒ½ï¼šé˜´äº‘ä¹‹å²šï¼Œè¿™é‡Œå½“ç„¶ä¹Ÿæ˜¯è¦å°½é‡è¿˜åŸä¸€ä¸‹çš„å•¦ï¼Œä¸è¿‡è´´å›¾å’Œç‰¹æ•ˆå°±è¿˜åŸä¸äº†äº†ï¼Œé™¤éèƒ½è®©æˆ‘ç™½å«–ä¸€ä¸ªç”»å¸ˆï¼Œå“ˆå“ˆå“ˆå“ˆã€‚</li><li>æŠ€èƒ½å®ç°æ–¹å¼å…¶å®å¾ˆç®€å•ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªBUFFæŠ€èƒ½ã€‚æ–½æ”¾æŠ€èƒ½åï¼Œç©å®¶ä¼šè¢«é™„åŠ ä¸€ä¸ªDEBUFFï¼ŒæŒç»­ä¸€æ®µæ—¶é—´ï¼Œåœ¨æ­¤æœŸé—´æ— æ³•å†æ¬¡é‡Šæ”¾æŠ€èƒ½ã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æŸ¥å†²åˆºå†·å´æ—¶é—´ï¼Œå¦‚æœå†·å´ä¸­ï¼Œå‡å°‘å†·å´æ—¶é—´</span></span><br><span class="line"><span class="keyword">if</span> (dashCooldown &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    dashCooldown--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥å†²åˆºæ—¶é—´æ˜¯å¦è¿˜å‰©ä½™</span></span><br><span class="line"><span class="keyword">if</span> (dashTimeLeft &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ä»åœ¨å†²åˆºä¸­ï¼Œå‡å°‘å‰©ä½™å†²åˆºæ—¶é—´</span></span><br><span class="line">    dashTimeLeft--;</span><br><span class="line">    <span class="comment">// è®¾ç½®ç©å®¶çš„é€Ÿåº¦ï¼Œæ ¹æ®å½“å‰æ–¹å‘å’Œå†²åˆºé€Ÿåº¦</span></span><br><span class="line">    player.velocity.X = player.direction * DashSpeed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆç©å®¶çš„å†²åˆºå‘½ä¸­æ¡†</span></span><br><span class="line">    Rectangle hitbox = <span class="keyword">new</span> Rectangle((<span class="built_in">int</span>)(player.position.X + player.velocity.X), </span><br><span class="line">                                      (<span class="built_in">int</span>)(player.position.Y + player.velocity.Y), </span><br><span class="line">                                      player.width, </span><br><span class="line">                                      player.height);</span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰NPCï¼Œæ£€æµ‹æ˜¯å¦ä¸å†²åˆºå‘½ä¸­æ¡†ç›¸äº¤</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Main.maxNPCs; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        NPC target = Main.npc[i];</span><br><span class="line">        <span class="comment">// æ£€æŸ¥NPCæ˜¯å¦æ´»è·ƒä¸”ä¸æ˜¯å‹å¥½çš„</span></span><br><span class="line">        <span class="keyword">if</span> (target.active &amp;&amp; !target.friendly &amp;&amp; target.Hitbox.Intersects(hitbox))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºå‡»ä¸­ä¿¡æ¯ï¼Œè®¾ç½®ä¼¤å®³ã€å‡»é€€å’Œå‘½ä¸­æ–¹å‘</span></span><br><span class="line">            NPC.HitInfo hitInfo = <span class="keyword">new</span> NPC.HitInfo</span><br><span class="line">            &#123;</span><br><span class="line">                Damage = DashDamage,</span><br><span class="line">                Knockback = DashKnockBack,</span><br><span class="line">                HitDirection = player.direction</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// å¯¹ç›®æ ‡NPCé€ æˆä¼¤å®³</span></span><br><span class="line">            target.StrikeNPC(hitInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆç²’å­ç‰¹æ•ˆ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) <span class="comment">// æ¯å¸§ç”Ÿæˆ10ä¸ªç²’å­</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ç”Ÿæˆç²’å­ä½ç½®ï¼ŒåŸºäºç©å®¶çš„ä¸­å¿ƒä½ç½®å¹¶æ·»åŠ éšæœºåç§»</span></span><br><span class="line">        Vector2 dustPosition = player.Center + <span class="keyword">new</span> Vector2(Main.rand.Next(<span class="number">-20</span>, <span class="number">5</span>), Main.rand.Next(<span class="number">-20</span>, <span class="number">5</span>));</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ–°ç²’å­ï¼Œè®¾ç½®é€Ÿåº¦å’Œç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">        Dust.NewDust(dustPosition, <span class="number">0</span>, <span class="number">0</span>, DustID.Snow, player.velocity.X * <span class="number">0.5f</span>, player.velocity.Y * <span class="number">0.5f</span>, <span class="number">100</span>, <span class="literal">default</span>, <span class="number">1.5f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœå†·å´æ—¶é—´ä¸º0ï¼Œå¹¶ä¸”ç©å®¶æ²¡æœ‰è¢«â€œç–²åŠ³â€BUFFå½±å“</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (dashCooldown == <span class="number">0</span> &amp;&amp; !player.HasBuff(ModContent.BuffType&lt;Buffs.FenglopeExhaustedBuff&gt;()))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è·å–å†²åˆºæŒ‰é”®çš„é…ç½®</span></span><br><span class="line">    mountDashKey = ModContent.GetInstance&lt;PolworldModConfig&gt;().MountDashKey;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥ç©å®¶æ˜¯å¦æŒ‰ä¸‹äº†å†²åˆºæŒ‰é”®</span></span><br><span class="line">    <span class="keyword">if</span> (Main.keyState.IsKeyDown(mountDashKey))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¼€å§‹å†²åˆºï¼Œè®¾ç½®å‰©ä½™å†²åˆºæ—¶é—´å’Œå†·å´æ—¶é—´</span></span><br><span class="line">        dashTimeLeft = DashDuration;</span><br><span class="line">        dashCooldown = DashCooldown;</span><br><span class="line">        <span class="comment">// ä¸ºç©å®¶æ·»åŠ ç–²åŠ³BUFFï¼ŒæŒç»­600å¸§ï¼ˆ10ç§’ï¼‰</span></span><br><span class="line">        player.AddBuff(ModContent.BuffType&lt;Buffs.FenglopeExhaustedBuff&gt;(), <span class="number">600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>è‰è½çŒª</h1><ul><li>è‰è½çŒªåªä¸è¿‡ç§»é€Ÿé™ä½äº†ä¸€ç‚¹ï¼ŒåŸç‰ˆèƒ½æŒ–çŸ¿ï¼Œä½†æ˜¯æ³°æ‹‰é‡Œæ²¡æœ‰çŸ³å¤´çŸ¿èƒ½æ’ï¼Œæ‰€ä»¥å°±æ”¹æˆäº†æ’æ–­æ²¿é€”çš„æ ‘æœ¨ã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.GameInput;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> Terraria.Audio;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Input;</span><br><span class="line"><span class="keyword">using</span> PolWorldMounts.Content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Mounts</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RushoarMount</span> : <span class="title">ModMount</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Keys mountDashKey;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> DashCooldown = <span class="number">60</span>; <span class="comment">// å†²åˆºå†·å´æ—¶é—´ï¼Œå•ä½ï¼šå¸§</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> DashDuration = <span class="number">90</span>; <span class="comment">// å†²åˆºæŒç»­æ—¶é—´ï¼Œå•ä½ï¼šå¸§</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> DashSpeed = <span class="number">12f</span>; <span class="comment">// å†²åˆºé€Ÿåº¦</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> DashDamage = <span class="number">50</span>; <span class="comment">// å†²åˆºé€ æˆçš„ä¼¤å®³</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> DashKnockBack = <span class="number">10f</span>; <span class="comment">// å†²åˆºé€ æˆçš„å‡»é€€åŠ›</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> dashTimeLeft = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> dashCooldown = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetStaticDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            MountData.jumpHeight = <span class="number">5</span>; <span class="comment">// How high the mount can jump.</span></span><br><span class="line">            MountData.acceleration = <span class="number">0.19f</span>; <span class="comment">// The rate at which the mount speeds up.</span></span><br><span class="line">            MountData.jumpSpeed = <span class="number">5f</span>; <span class="comment">// The rate at which the player and mount ascend towards (negative y velocity) the jump height when the jump button is pressed.</span></span><br><span class="line">            MountData.blockExtraJumps = <span class="literal">true</span>; <span class="comment">// é˜»æ­¢é¥°å“å¢åŠ è·³è·ƒæ¬¡æ•°</span></span><br><span class="line">            MountData.constantJump = <span class="literal">true</span>; <span class="comment">// Allows you to hold the jump button down.</span></span><br><span class="line">            MountData.heightBoost = <span class="number">-20</span>; <span class="comment">// Height between the mount and the ground</span></span><br><span class="line">            MountData.fallDamage = <span class="number">0f</span>; <span class="comment">// Fall damage multiplier.</span></span><br><span class="line">            MountData.runSpeed = <span class="number">8f</span>; <span class="comment">// The speed of the mount</span></span><br><span class="line">            MountData.dashSpeed = <span class="number">8f</span>; <span class="comment">// The speed the mount moves when in the state of dashing.</span></span><br><span class="line">            MountData.flightTimeMax = <span class="number">0</span>; <span class="comment">// The amount of time in frames a mount can be in the state of flying.</span></span><br><span class="line"></span><br><span class="line">            MountData.fatigueMax = <span class="number">0</span>;</span><br><span class="line">            MountData.buff = ModContent.BuffType&lt;Buffs.RushoarMountBuff&gt;(); <span class="comment">// The ID number of the buff assigned to the mount.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Effects</span></span><br><span class="line">            <span class="comment">// MountData.spawnDust = ModContent.DustType&lt;Dusts.Sparkle&gt;(); // The ID of the dust spawned when mounted or dismounted.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Frame data and player offsets</span></span><br><span class="line">            MountData.totalFrames = <span class="number">5</span>; <span class="comment">// Amount of animation frames for the mount</span></span><br><span class="line">            MountData.playerYOffsets = Enumerable.Repeat(<span class="number">20</span>, MountData.totalFrames).ToArray(); <span class="comment">// Fills an array with values for less repeating code</span></span><br><span class="line">            MountData.xOffset = <span class="number">20</span>;</span><br><span class="line">            MountData.yOffset = <span class="number">-12</span>;</span><br><span class="line">            MountData.playerHeadOffset = <span class="number">22</span>;</span><br><span class="line">            MountData.bodyFrame = <span class="number">3</span>;</span><br><span class="line">            <span class="comment">// Standing</span></span><br><span class="line">            MountData.standingFrameCount = <span class="number">0</span>;</span><br><span class="line">            MountData.standingFrameDelay = <span class="number">12</span>;</span><br><span class="line">            MountData.standingFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Running</span></span><br><span class="line">            MountData.runningFrameCount = <span class="number">4</span>;</span><br><span class="line">            MountData.runningFrameDelay = <span class="number">50</span>;</span><br><span class="line">            MountData.runningFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Flying</span></span><br><span class="line">            MountData.flyingFrameCount = <span class="number">0</span>;</span><br><span class="line">            MountData.flyingFrameDelay = <span class="number">0</span>;</span><br><span class="line">            MountData.flyingFrameStart = <span class="number">2</span>;</span><br><span class="line">            <span class="comment">// In-air</span></span><br><span class="line">            MountData.inAirFrameCount = <span class="number">1</span>;</span><br><span class="line">            MountData.inAirFrameDelay = <span class="number">12</span>;</span><br><span class="line">            MountData.inAirFrameStart = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// Idle</span></span><br><span class="line">            MountData.idleFrameCount = <span class="number">0</span>;</span><br><span class="line">            MountData.idleFrameDelay = <span class="number">12</span>;</span><br><span class="line">            MountData.idleFrameStart = <span class="number">0</span>;</span><br><span class="line">            MountData.idleFrameLoop = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// Swim</span></span><br><span class="line">            MountData.swimFrameCount = MountData.inAirFrameCount;</span><br><span class="line">            MountData.swimFrameDelay = MountData.inAirFrameDelay;</span><br><span class="line">            MountData.swimFrameStart = MountData.inAirFrameStart;</span><br><span class="line"></span><br><span class="line">            mountDashKey = ModContent.GetInstance&lt;PolworldModConfig&gt;().MountDashKey;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!Main.dedServ)</span><br><span class="line">            &#123;</span><br><span class="line">                MountData.textureWidth = MountData.backTexture.Width() + <span class="number">20</span>;</span><br><span class="line">                MountData.textureHeight = MountData.backTexture.Height();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateEffects</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dashCooldown &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dashCooldown--;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dashTimeLeft &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dashTimeLeft--;</span><br><span class="line">                player.velocity.X = player.direction * DashSpeed;</span><br><span class="line"></span><br><span class="line">                Rectangle hitbox = <span class="keyword">new</span> Rectangle((<span class="built_in">int</span>)(player.position.X + player.velocity.X), (<span class="built_in">int</span>)(player.position.Y + player.velocity.Y), player.width, player.height);</span><br><span class="line">                BreakTreesAlongPath(player, hitbox);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Main.maxNPCs; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    NPC target = Main.npc[i];</span><br><span class="line">                    <span class="keyword">if</span> (target.active &amp;&amp; !target.friendly &amp;&amp; target.Hitbox.Intersects(hitbox))</span><br><span class="line">                    &#123;</span><br><span class="line">                        NPC.HitInfo hitInfo = <span class="keyword">new</span> NPC.HitInfo</span><br><span class="line">                        &#123;</span><br><span class="line">                            Damage = DashDamage,</span><br><span class="line">                            Knockback = DashKnockBack,</span><br><span class="line">                            HitDirection = player.direction</span><br><span class="line">                        &#125;;</span><br><span class="line">                        target.StrikeNPC(hitInfo);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ç”Ÿæˆç²’å­ç‰¹æ•ˆ</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) <span class="comment">// æ¯å¸§ç”Ÿæˆ10ä¸ªç²’å­</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Vector2 dustPosition = player.Center + <span class="keyword">new</span> Vector2(Main.rand.Next(<span class="number">-20</span>, <span class="number">5</span>), Main.rand.Next(<span class="number">-20</span>, <span class="number">5</span>));</span><br><span class="line">                    Dust.NewDust(dustPosition, <span class="number">0</span>, <span class="number">0</span>, DustID.Dirt, player.velocity.X * <span class="number">0.5f</span>, player.velocity.Y * <span class="number">0.5f</span>, <span class="number">100</span>, <span class="literal">default</span>, <span class="number">1.5f</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (dashCooldown == <span class="number">0</span> &amp;&amp; !player.HasBuff(ModContent.BuffType&lt;Buffs.RushoarExhaustedBuff&gt;()))</span><br><span class="line">            &#123;</span><br><span class="line">                mountDashKey = ModContent.GetInstance&lt;PolworldModConfig&gt;().MountDashKey;</span><br><span class="line">                <span class="keyword">if</span> (Main.keyState.IsKeyDown(mountDashKey))</span><br><span class="line">                &#123;</span><br><span class="line">                    dashTimeLeft = DashDuration;</span><br><span class="line">                    dashCooldown = DashCooldown;</span><br><span class="line">                    player.AddBuff(ModContent.BuffType&lt;Buffs.RushoarExhaustedBuff&gt;(), <span class="number">600</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BreakTreesAlongPath</span>(<span class="params">Player player, Rectangle hitbox</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> tileStartX = hitbox.Left / <span class="number">16</span>;</span><br><span class="line">            <span class="built_in">int</span> tileEndX = hitbox.Right / <span class="number">16</span>;</span><br><span class="line">            <span class="built_in">int</span> tileStartY = hitbox.Top / <span class="number">16</span>;</span><br><span class="line">            <span class="built_in">int</span> tileEndY = hitbox.Bottom / <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> x = tileStartX; x &lt;= tileEndX; x++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> y = tileStartY; y &lt;= tileEndY; y++)</span><br><span class="line">                &#123;</span><br><span class="line">                    Tile tile = Framing.GetTileSafely(x, y);</span><br><span class="line">                    <span class="keyword">if</span> ((tile.TileType == TileID.Trees</span><br><span class="line">                    <span class="comment">//tile.TileType == TileID.PalmTree ||</span></span><br><span class="line">                    <span class="comment">//tile.TileType == TileID.VanityTreeSakura</span></span><br><span class="line">                    )</span><br><span class="line">                    &amp;&amp; tile.HasTile)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœæ˜¯æ ‘é¡¶</span></span><br><span class="line">                        <span class="keyword">if</span> (tile.TileFrameY == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            WorldGen.KillTile(x, y, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                            SoundEngine.PlaySound(SoundID.Item14);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// å¦‚æœæ˜¯æ ‘èº«</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (tile.TileFrameY % <span class="number">22</span> == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            WorldGen.KillTile(x, y, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                            SoundEngine.PlaySound(SoundID.Item14);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>ç©ºæ¶¡é¾™</h1><div class="tabs" id="ç©ºæ¶¡é¾™"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ç©ºæ¶¡é¾™-1">ç©ºæ¶¡é¾™</button></li><li class="tab"><button type="button" data-href="#ç©ºæ¶¡é¾™-2">å…‰æŸå½—æ˜Ÿ</button></li><li class="tab"><button type="button" data-href="#ç©ºæ¶¡é¾™-3">çƒˆç„°é£æš´</button></li><li class="tab"><button type="button" data-href="#ç©ºæ¶¡é¾™-4">é¾™å½—æ˜Ÿ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ç©ºæ¶¡é¾™-1"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Mounts</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JetragonMount</span> : <span class="title">ModMount</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> FlightAcceleration = <span class="number">0.8f</span>; <span class="comment">// é£è¡ŒåŠ é€Ÿåº¦</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> MaxVerticalSpeed = <span class="number">25f</span>; <span class="comment">// æœ€å¤§å‚ç›´é€Ÿåº¦</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> HorizontalAcceleration = <span class="number">0.1f</span>; <span class="comment">// æ°´å¹³åŠ é€Ÿåº¦</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> DecelerationFactor = <span class="number">0.95f</span>; <span class="comment">// å‡é€Ÿå› å­</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> isShooting = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> isShootingMeteor = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> isShootingFlareStorm = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetStaticDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            MountData.jumpHeight = <span class="number">15</span>; <span class="comment">// How high the mount can jump.</span></span><br><span class="line">            MountData.acceleration = HorizontalAcceleration; <span class="comment">// The rate at which the mount speeds up.</span></span><br><span class="line">            MountData.jumpSpeed = <span class="number">15f</span>; <span class="comment">// The rate at which the player and mount ascend towards (negative y velocity) the jump height when the jump button is pressed.</span></span><br><span class="line">            MountData.blockExtraJumps = <span class="literal">true</span>; <span class="comment">// é˜»æ­¢é¥°å“å¢åŠ è·³è·ƒæ¬¡æ•°</span></span><br><span class="line">            MountData.constantJump = <span class="literal">true</span>; <span class="comment">// Allows you to hold the jump button down.</span></span><br><span class="line">            MountData.heightBoost = <span class="number">20</span>; <span class="comment">// Height between the mount and the ground</span></span><br><span class="line">            MountData.fallDamage = <span class="number">0f</span>; <span class="comment">// Fall damage multiplier.</span></span><br><span class="line">            MountData.runSpeed = <span class="number">25f</span>; <span class="comment">// The speed of the mount</span></span><br><span class="line">            MountData.dashSpeed = <span class="number">15f</span>; <span class="comment">// The speed the mount moves when in the state of dashing.</span></span><br><span class="line">            MountData.flightTimeMax = <span class="number">999999</span>; <span class="comment">// å®ç°æŒç»­é£è¡Œ</span></span><br><span class="line"></span><br><span class="line">            MountData.fatigueMax = <span class="number">0</span>;</span><br><span class="line">            MountData.buff = ModContent.BuffType&lt;Buffs.JetragonMountBuff&gt;(); <span class="comment">// The ID number of the buff assigned to the mount.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Effects</span></span><br><span class="line">            <span class="comment">// MountData.spawnDust = ModContent.DustType&lt;Dusts.Sparkle&gt;(); // The ID of the dust spawned when mounted or dismounted.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Frame data and player offsets</span></span><br><span class="line">            MountData.totalFrames = <span class="number">3</span>; <span class="comment">// Amount of animation frames for the mount</span></span><br><span class="line">            MountData.playerYOffsets = Enumerable.Repeat(<span class="number">20</span>, MountData.totalFrames).ToArray(); <span class="comment">// Fills an array with values for less repeating code</span></span><br><span class="line">            MountData.xOffset = <span class="number">-10</span>;</span><br><span class="line">            MountData.yOffset = <span class="number">-12</span>;</span><br><span class="line">            MountData.playerHeadOffset = <span class="number">30</span>; <span class="comment">// ç¡®ä¿ç©å®¶å¤´éƒ¨ä¸è¢«é®æŒ¡</span></span><br><span class="line">            MountData.bodyFrame = <span class="number">4</span>; <span class="comment">// è°ƒæ•´è¿™ä¸ªå‚æ•°ï¼Œä»¥ç¡®ä¿ä¸ç©å®¶çš„åŠ¨ç”»å¸§å…¼å®¹</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Standing</span></span><br><span class="line">            MountData.standingFrameCount = <span class="number">3</span>;</span><br><span class="line">            MountData.standingFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.standingFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Running</span></span><br><span class="line">            MountData.runningFrameCount = <span class="number">3</span>;</span><br><span class="line">            MountData.runningFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.runningFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Flying</span></span><br><span class="line">            MountData.flyingFrameCount = <span class="number">3</span>;</span><br><span class="line">            MountData.flyingFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.flyingFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// In-air</span></span><br><span class="line">            MountData.inAirFrameCount = <span class="number">3</span>;</span><br><span class="line">            MountData.inAirFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.inAirFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Idle</span></span><br><span class="line">            MountData.idleFrameCount = <span class="number">0</span>;</span><br><span class="line">            MountData.idleFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.idleFrameStart = <span class="number">0</span>;</span><br><span class="line">            MountData.idleFrameLoop = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// Swim</span></span><br><span class="line">            MountData.swimFrameCount = MountData.inAirFrameCount;</span><br><span class="line">            MountData.swimFrameDelay = MountData.inAirFrameDelay;</span><br><span class="line">            MountData.swimFrameStart = MountData.inAirFrameStart;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!Main.dedServ)</span><br><span class="line">            &#123;</span><br><span class="line">                MountData.textureWidth = MountData.backTexture.Width() + <span class="number">20</span>;</span><br><span class="line">                MountData.textureHeight = MountData.backTexture.Height();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateEffects</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ä¸å—é‡åŠ›å½±å“</span></span><br><span class="line">            player.gravity = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ§åˆ¶ä¸Šå‡å’Œä¸‹é™</span></span><br><span class="line">            <span class="keyword">if</span> (player.controlJump)</span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.Y = MathHelper.Clamp(</span><br><span class="line">                    player.velocity.Y - FlightAcceleration,</span><br><span class="line">                    -MaxVerticalSpeed,</span><br><span class="line">                    MaxVerticalSpeed</span><br><span class="line">                ); <span class="comment">// ä¸Šå‡</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (player.controlDown)</span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.Y = MathHelper.Clamp(</span><br><span class="line">                    player.velocity.Y + FlightAcceleration,</span><br><span class="line">                    -MaxVerticalSpeed,</span><br><span class="line">                    MaxVerticalSpeed</span><br><span class="line">                ); <span class="comment">// ä¸‹é™</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.Y *= DecelerationFactor; <span class="comment">// ç¼“æ…¢å‡é€Ÿè‡³é™æ­¢</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ§åˆ¶å·¦å³ç§»åŠ¨</span></span><br><span class="line">            <span class="keyword">if</span> (player.controlLeft)</span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.X = MathHelper.Clamp(</span><br><span class="line">                    player.velocity.X - MountData.acceleration,</span><br><span class="line">                    -MountData.runSpeed,</span><br><span class="line">                    MountData.runSpeed</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (player.controlRight)</span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.X = MathHelper.Clamp(</span><br><span class="line">                    player.velocity.X + MountData.acceleration,</span><br><span class="line">                    -MountData.runSpeed,</span><br><span class="line">                    MountData.runSpeed</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.X *= DecelerationFactor; <span class="comment">// ç¼“æ…¢å‡é€Ÿè‡³é™æ­¢</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¸¸é©»ç²‰è‰²ç²’å­ç‰¹æ•ˆ</span></span><br><span class="line">            Vector2 pinkDustOffset = <span class="keyword">new</span> Vector2(<span class="number">-40</span> * player.direction, <span class="number">-30</span>); <span class="comment">// è®¾å®šåç§»é‡ï¼Œè¿™é‡Œä¹˜ä»¥ç©å®¶æ–¹å‘æ˜¯ä¸ºäº†å½“ç©å®¶é•œåƒç¿»è½¬æ—¶ï¼Œè´´å›¾ä¹Ÿä¼šé•œåƒç¿»è½¬</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) <span class="comment">// æ¯å¸§ç”Ÿæˆ3ä¸ªç²’å­</span></span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 pinkDustPosition =</span><br><span class="line">                    player.Center</span><br><span class="line">                    + pinkDustOffset</span><br><span class="line">                    + <span class="keyword">new</span> Vector2(Main.rand.Next(<span class="number">-10</span>, <span class="number">10</span>), Main.rand.Next(<span class="number">-10</span>, <span class="number">10</span>));</span><br><span class="line">                <span class="built_in">int</span> pinkDustIndex = Dust.NewDust(</span><br><span class="line">                    pinkDustPosition,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    DustID.PinkTorch,</span><br><span class="line">                    <span class="number">0f</span>,</span><br><span class="line">                    <span class="number">0f</span>,</span><br><span class="line">                    <span class="number">100</span>,</span><br><span class="line">                    <span class="literal">default</span>,</span><br><span class="line">                    <span class="number">1.5f</span></span><br><span class="line">                );</span><br><span class="line">                Main.dust[pinkDustIndex].noGravity = <span class="literal">true</span>; <span class="comment">// ç²‰è‰²ç²’å­ä¸å—é‡åŠ›å½±å“</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ æŠ€èƒ½æ£€æµ‹å’Œå†·å´é€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (!player.buffType.Contains(ModContent.BuffType&lt;Buffs.JetragonBeamCometBuff&gt;()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹Xé”®å¹¶ä¸”å½“å‰æ²¡æœ‰åœ¨å‘å°„å¼¹å¹•</span></span><br><span class="line">                <span class="keyword">if</span> (Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.X) &amp;&amp; !isShooting)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// å¯åŠ¨å¼‚æ­¥å‘å°„å¼¹å¹•</span></span><br><span class="line">                    isShooting = <span class="literal">true</span>;</span><br><span class="line">                    FireProjectiles(player);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!player.buffType.Contains(ModContent.BuffType&lt;Buffs.JetragonMeteorBuff&gt;()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.C) &amp;&amp; !isShootingMeteor)</span><br><span class="line">                &#123;</span><br><span class="line">                    isShootingMeteor = <span class="literal">true</span>;</span><br><span class="line">                    ShootMeteors(player);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!player.buffType.Contains(ModContent.BuffType&lt;Buffs.JetragonFlareStormBuff&gt;()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Z) &amp;&amp; !isShootingFlareStorm)</span><br><span class="line">                &#123;</span><br><span class="line">                    isShootingFlareStorm = <span class="literal">true</span>;</span><br><span class="line">                    FireFlareStorm(player);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Load</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.Load();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">FireProjectiles</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 mousePosition = Main.MouseWorld; <span class="comment">// è·å–é¼ æ ‡ä½ç½®</span></span><br><span class="line">            Vector2 playerPosition = player.Center; <span class="comment">// è·å–ç©å®¶ä½ç½®</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 offset = <span class="keyword">new</span> Vector2(player.direction * <span class="number">-20</span>, <span class="number">-20</span>); <span class="comment">// åœ¨Xè½´ä¸Šåç§»20ä¸ªå•ä½ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´åç§»é‡</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// åº”ç”¨åç§»é‡åˆ°player.Center</span></span><br><span class="line">                Vector2 spawnPosition = playerPosition + offset;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è®¡ç®—æ–¹å‘å‘é‡ï¼Œä»ç©å®¶åˆ°é¼ æ ‡</span></span><br><span class="line">                Vector2 directionToMouse = mousePosition - spawnPosition;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä»…ä¿ç•™æ°´å¹³åˆ†é‡ï¼Œå¿½ç•¥å‚ç›´æ–¹å‘</span></span><br><span class="line">                directionToMouse.Normalize(); <span class="comment">// å½’ä¸€åŒ–æ–¹å‘å‘é‡</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// è®¾ç½®é€Ÿåº¦ï¼Œè°ƒæ•´é€Ÿåº¦å¤§å°ä»¥é€‚åº”ä½ çš„éœ€æ±‚</span></span><br><span class="line">                Vector2 projectileVelocity = directionToMouse * <span class="number">10f</span>; <span class="comment">// 10f ä¸ºå¼¹å¹•é€Ÿåº¦çš„å¤§å°</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// åˆ›å»ºå¼¹å¹•</span></span><br><span class="line">                    Projectile.NewProjectile(player.GetSource_FromThis(), spawnPosition, projectileVelocity, ModContent.ProjectileType&lt;Projectiles.BeamCometProjectile&gt;(), <span class="number">200</span>, <span class="number">2</span>, player.whoAmI);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// å¤„ç†å¼‚å¸¸ï¼Œè®°å½•é”™è¯¯æˆ–é‡‡å–å…¶ä»–æªæ–½</span></span><br><span class="line">                    Main.NewText(<span class="string">$&quot;Error creating projectile: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ç­‰å¾…0.2ç§’ï¼ˆ200æ¯«ç§’ï¼‰</span></span><br><span class="line">                <span class="keyword">await</span> Task.Delay(<span class="number">200</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ å†·å´Buff</span></span><br><span class="line">            player.AddBuff(ModContent.BuffType&lt;Buffs.JetragonBeamCometBuff&gt;(), <span class="number">300</span>); <span class="comment">// 10ç§’</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®Œæˆå‘å°„åé‡ç½®çŠ¶æ€</span></span><br><span class="line">            isShooting = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">ShootMeteors</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 mousePosition = Main.MouseWorld;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> k = <span class="number">0</span>; k &lt; <span class="number">4</span>; k++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// éšæœºåç§»ä»¥æ¨¡æ‹Ÿä¸åŒçš„è½ç‚¹</span></span><br><span class="line">                    Vector2 offset = <span class="keyword">new</span> Vector2(Main.rand.Next(<span class="number">-100</span>, <span class="number">100</span>), Main.rand.Next(<span class="number">-100</span>, <span class="number">100</span>));</span><br><span class="line">                    Vector2 targetPosition = mousePosition + offset;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ä»ç©å®¶ä½ç½®åˆ°ç›®æ ‡ä½ç½®çš„æ–¹å‘</span></span><br><span class="line">                    Vector2 direction = targetPosition - player.Center;</span><br><span class="line">                    direction.Normalize();</span><br><span class="line">                    <span class="built_in">float</span> speed = <span class="number">10f</span>; <span class="comment">// é™¨çŸ³é€Ÿåº¦</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// éšæœºåŒ–åˆå§‹é€Ÿåº¦æ–¹å‘ï¼ˆæ²¿å¼§å½¢è·¯å¾„ï¼‰</span></span><br><span class="line">                    <span class="built_in">float</span> angle = Main.rand.NextFloat(-MathHelper.Pi / <span class="number">4</span>, MathHelper.Pi / <span class="number">4</span>); <span class="comment">// éšæœºå¼§å½¢è§’åº¦</span></span><br><span class="line">                    Vector2 initialVelocity = <span class="keyword">new</span> Vector2(</span><br><span class="line">                        direction.X * (<span class="built_in">float</span>)Math.Cos(angle) - direction.Y * (<span class="built_in">float</span>)Math.Sin(angle),</span><br><span class="line">                        direction.X * (<span class="built_in">float</span>)Math.Sin(angle) + direction.Y * (<span class="built_in">float</span>)Math.Cos(angle)</span><br><span class="line">                    ) * speed;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// åº”ç”¨åç§»é‡åˆ°player.Center</span></span><br><span class="line">                    Vector2 offsetProj = <span class="keyword">new</span> Vector2(</span><br><span class="line">                        (player.direction * <span class="number">-30</span>) + Main.rand.NextFloat(<span class="number">-10f</span>, <span class="number">10f</span>), <span class="comment">// éšæœºåŒ–Xåç§»é‡</span></span><br><span class="line">                        <span class="number">-60</span> + Main.rand.NextFloat(<span class="number">-10f</span>, <span class="number">10f</span>) <span class="comment">// éšæœºåŒ–Yåç§»é‡</span></span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                    Vector2 spawnPosition = player.Center + offsetProj;</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// åˆ›å»ºå¼¹å¹•</span></span><br><span class="line">                        <span class="built_in">int</span> projIndex = Projectile.NewProjectile(player.GetSource_FromThis(), spawnPosition, initialVelocity, ModContent.ProjectileType&lt;Projectiles.DragonMeteorProjectile&gt;(), <span class="number">200</span>, <span class="number">2</span>, player.whoAmI);</span><br><span class="line">                        <span class="comment">// è·å–åˆ›å»ºçš„å¼¹å¹•</span></span><br><span class="line">                        Projectile projectile = Main.projectile[projIndex];</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// è®¾ç½®å¼¹å¹•çš„åˆå§‹çŠ¶æ€ï¼Œç¡®ä¿å®ƒä¼šåœ¨å¼€å§‹æ—¶æ²¿å¼§å½¢è·¯å¾„è¿åŠ¨</span></span><br><span class="line">                        projectile.ai[<span class="number">0</span>] = <span class="number">1</span>; <span class="comment">// ä½¿ç”¨ ai[0] æ ‡è®°å¼¹å¹•å·²å¼€å§‹å¼§å½¢è¿åŠ¨</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (NullReferenceException ex)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// ç­‰å¾…0.1ç§’ï¼ˆ100æ¯«ç§’ï¼‰</span></span><br><span class="line">                    <span class="keyword">await</span> Task.Delay(<span class="number">50</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                isShootingMeteor = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// ç­‰å¾…0.3ç§’ï¼ˆ300æ¯«ç§’ï¼‰</span></span><br><span class="line">                <span class="keyword">await</span> Task.Delay(<span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            player.AddBuff(ModContent.BuffType&lt;Buffs.JetragonMeteorBuff&gt;(), <span class="number">1200</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">FireFlareStorm</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 mousePosition = Main.MouseWorld; <span class="comment">// è·å–é¼ æ ‡ä½ç½®</span></span><br><span class="line">            Vector2 playerPosition = player.Center; <span class="comment">// è·å–ç©å®¶ä½ç½®</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) <span class="comment">// ç”Ÿæˆ5ä¸ªFlareStormå¼¹å¹•</span></span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 spawnPosition = playerPosition + <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">10</span>); <span class="comment">// åœ¨ç©å®¶ä¸‹æ–¹ç”Ÿæˆå¼¹å¹•</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// è®¡ç®—æ–¹å‘å‘é‡ï¼Œä»ç©å®¶åˆ°é¼ æ ‡</span></span><br><span class="line">                Vector2 directionToMouse = mousePosition - spawnPosition;</span><br><span class="line">                directionToMouse.Y = <span class="number">0</span>;</span><br><span class="line">                directionToMouse.Normalize(); <span class="comment">// å½’ä¸€åŒ–æ–¹å‘å‘é‡</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// è®¾ç½®é€Ÿåº¦ï¼Œè°ƒæ•´é€Ÿåº¦å¤§å°ä»¥é€‚åº”ä½ çš„éœ€æ±‚</span></span><br><span class="line">                Vector2 velocity = directionToMouse * <span class="number">10f</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// åˆ›å»ºFlareStormå¼¹å¹•</span></span><br><span class="line">                    Projectile.NewProjectile(player.GetSource_FromThis(), spawnPosition, velocity, ModContent.ProjectileType&lt;Projectiles.FlareStormProjectile&gt;(), <span class="number">300</span>, <span class="number">2</span>, player.whoAmI);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (NullReferenceException ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// å¤„ç†å¼‚å¸¸ï¼Œè®°å½•é”™è¯¯æˆ–é‡‡å–å…¶ä»–æªæ–½</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ç­‰å¾…0.1ç§’ï¼ˆ100æ¯«ç§’ï¼‰</span></span><br><span class="line">                <span class="keyword">await</span> Task.Delay(<span class="number">100</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ å†·å´æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">            player.AddBuff(ModContent.BuffType&lt;Buffs.JetragonFlareStormBuff&gt;(), <span class="number">1800</span>); <span class="comment">// 10ç§’</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®Œæˆå‘å°„åé‡ç½®çŠ¶æ€</span></span><br><span class="line">            isShootingFlareStorm = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç©ºæ¶¡é¾™-2"><ul><li>å…‰æŸå½—æ˜Ÿä¸€å¼€å§‹ä¼šæ²¿ç€é¼ æ ‡æ–¹å‘å‘å°„ï¼Œéšåä¼šè‡ªåŠ¨è¿½è¸ª800åƒç´ èŒƒå›´å†…çš„æ•Œæ€ªã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BeamCometProjectile</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.width = <span class="number">10</span>; <span class="comment">// å¼¹å¹•å®½åº¦</span></span><br><span class="line">            Projectile.height = <span class="number">10</span>; <span class="comment">// å¼¹å¹•é«˜åº¦</span></span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦å¯¹ç©å®¶å‹å¥½</span></span><br><span class="line">            Projectile.hostile = <span class="literal">false</span>; <span class="comment">// æ˜¯å¦å¯¹æ•Œäººå‹å¥½</span></span><br><span class="line">            Projectile.tileCollide = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦ä¸ç“·ç –ç¢°æ’</span></span><br><span class="line">            Projectile.penetrate = <span class="number">5</span>; <span class="comment">// ç©¿é€æ•°é‡</span></span><br><span class="line">            Projectile.timeLeft = <span class="number">600</span>; <span class="comment">// å¼¹å¹•çš„å­˜æ´»æ—¶é—´ï¼ˆå¸§ï¼‰</span></span><br><span class="line">            Projectile.light = <span class="number">0.5f</span>; <span class="comment">// å¼¹å¹•çš„å…‰äº®åº¦</span></span><br><span class="line">            Projectile.ignoreWater = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦å¿½ç•¥æ°´</span></span><br><span class="line">            Projectile.extraUpdates = <span class="number">1</span>; <span class="comment">// æ¯å¸§æ›´æ–°æ¬¡æ•°</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AI</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Player player = Main.player[Projectile.owner];</span><br><span class="line">            Vector2 mousePosition = Main.MouseWorld;</span><br><span class="line">            NPC target = FindClosestNPC(<span class="number">800f</span>); <span class="comment">// è®¾å®šè¿½è¸ªèŒƒå›´ä¸º800åƒç´ </span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (target != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ‰¾åˆ°ç›®æ ‡ï¼Œè®¡ç®—å¼¹å¹•æœå‘ç›®æ ‡çš„æ–¹å‘</span></span><br><span class="line">                Vector2 directionToTarget = target.Center - Projectile.Center;</span><br><span class="line">                directionToTarget.Normalize();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¹³æ»‘è¿‡æ¸¡åˆ°ç›®æ ‡æ–¹å‘</span></span><br><span class="line">                <span class="built_in">float</span> smoothFactor = <span class="number">0.05f</span>; <span class="comment">// è°ƒæ•´å¹³æ»‘çš„å› å­ï¼Œ0åˆ°1ä¹‹é—´ï¼Œæ•°å€¼è¶Šå°è½¬å‘è¶Šå¹³æ»‘</span></span><br><span class="line">                Projectile.velocity = Vector2.Lerp(Projectile.velocity, directionToTarget * <span class="number">4f</span>, smoothFactor);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç²’å­æ•ˆæœ</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span>; i++) <span class="comment">// æ¯å¸§ç”Ÿæˆ1ä¸ªç²’å­</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Pink, Projectile.velocity.X * <span class="number">0.2f</span>, Projectile.velocity.Y * <span class="number">0.2f</span>, <span class="number">100</span>, <span class="keyword">new</span> Color(<span class="number">205</span>, <span class="number">71</span>, <span class="number">208</span>), <span class="number">0.7f</span>);</span><br><span class="line">                Dust dust = Main.dust[dustIndex];</span><br><span class="line">                dust.noGravity = <span class="literal">true</span>;</span><br><span class="line">                dust.velocity *= <span class="number">0.3f</span>;</span><br><span class="line">                dust.scale *= <span class="number">0.95f</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ å…‰æ•ˆ</span></span><br><span class="line">            Lighting.AddLight(Projectile.Center, <span class="number">0.84f</span>, <span class="number">0.48f</span>, <span class="number">0.73f</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¾…åŠ©æ–¹æ³•ï¼ŒæŸ¥æ‰¾æœ€è¿‘çš„æ•Œäºº</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> NPC <span class="title">FindClosestNPC</span>(<span class="params"><span class="built_in">float</span> maxDetectDistance</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            NPC closestNPC = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">float</span> sqrMaxDetectDistance = maxDetectDistance * maxDetectDistance;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Main.maxNPCs; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                NPC npc = Main.npc[i];</span><br><span class="line">                <span class="keyword">if</span> (npc.CanBeChasedBy(<span class="keyword">this</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">float</span> sqrDistanceToNPC = Vector2.DistanceSquared(npc.Center, Projectile.Center);</span><br><span class="line">                    <span class="keyword">if</span> (sqrDistanceToNPC &lt; sqrMaxDetectDistance)</span><br><span class="line">                    &#123;</span><br><span class="line">                        sqrMaxDetectDistance = sqrDistanceToNPC;</span><br><span class="line">                        closestNPC = npc;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> closestNPC;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnHitNPC</span>(<span class="params">NPC target, NPC.HitInfo hit, <span class="built_in">int</span> damageDone</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            target.AddBuff(BuffID.OnFire, <span class="number">300</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">PreDraw</span>(<span class="params"><span class="keyword">ref</span> Color lightColor</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰å¸§çš„æºçŸ©å½¢</span></span><br><span class="line">            Rectangle sourceRectangle = <span class="keyword">new</span> Rectangle(<span class="number">0</span>, Projectile.frame * Projectile.height, Projectile.width, Projectile.height);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–å¼¹å¹•çš„è´´å›¾</span></span><br><span class="line">            Texture2D texture = Terraria.GameContent.TextureAssets.Projectile[Projectile.type].Value;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ‹–å½±æ•ˆæœå‚æ•°</span></span><br><span class="line">            <span class="built_in">float</span> alpha = <span class="number">0.5f</span>; <span class="comment">// æ‹–å½±çš„é€æ˜åº¦</span></span><br><span class="line">            <span class="built_in">float</span> scale = Projectile.scale; <span class="comment">// æ‹“å½±çš„ç¼©æ”¾</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–å¼¹å¹•çš„é€Ÿåº¦æ–¹å‘</span></span><br><span class="line">            Vector2 velocity = Projectile.velocity;</span><br><span class="line">            velocity.Normalize(); <span class="comment">// å½’ä¸€åŒ–é€Ÿåº¦å‘é‡ï¼Œç”¨äºç¡®å®šæ‹–å½±çš„æ–¹å‘</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®¡ç®—æ‹–å½±åç§»é‡</span></span><br><span class="line">            <span class="built_in">float</span> offsetDistance = <span class="number">10f</span>; <span class="comment">// æ‹–å½±åç§»é‡çš„è·ç¦»ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç»˜åˆ¶æ‹–å½±</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) <span class="comment">// ç»˜åˆ¶5ä¸ªæ‹–å½±ï¼ˆå¯ä»¥è°ƒæ•´æ•°é‡ï¼‰</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// è®¡ç®—æ¯ä¸ªæ‹–å½±çš„ä½ç½®</span></span><br><span class="line">                Vector2 offset = velocity * offsetDistance * i; <span class="comment">// æ²¿ç€é€Ÿåº¦æ–¹å‘çš„åç§»é‡</span></span><br><span class="line">                Color color = Color.Lerp(lightColor, Color.Transparent, alpha / <span class="number">5f</span> * i); <span class="comment">// é€æ¸å˜é€æ˜çš„é¢œè‰²</span></span><br><span class="line"></span><br><span class="line">                Main.spriteBatch.Draw(</span><br><span class="line">                    texture,</span><br><span class="line">                    Projectile.Center - Main.screenPosition - offset,</span><br><span class="line">                    sourceRectangle,</span><br><span class="line">                    color,</span><br><span class="line">                    Projectile.rotation,</span><br><span class="line">                    <span class="keyword">new</span> Vector2(Projectile.width / <span class="number">2</span>, Projectile.height / <span class="number">2</span>),</span><br><span class="line">                    scale,</span><br><span class="line">                    SpriteEffects.None,</span><br><span class="line">                    <span class="number">0f</span></span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç»˜åˆ¶æ­£å¸¸çš„å¼¹å¹•</span></span><br><span class="line">            Main.spriteBatch.Draw(</span><br><span class="line">                texture,</span><br><span class="line">                Projectile.Center - Main.screenPosition,</span><br><span class="line">                sourceRectangle,</span><br><span class="line">                lightColor,</span><br><span class="line">                Projectile.rotation,</span><br><span class="line">                <span class="keyword">new</span> Vector2(Projectile.width / <span class="number">2</span>, Projectile.height / <span class="number">2</span>),</span><br><span class="line">                scale,</span><br><span class="line">                SpriteEffects.None,</span><br><span class="line">                <span class="number">0f</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// è¿”å›falseï¼Œè¡¨ç¤ºæˆ‘ä»¬è‡ªå·±ç»˜åˆ¶äº†å¼¹å¹•</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç©ºæ¶¡é¾™-3"><ul><li>çƒˆç„°é£æš´ä¸ªäººæ„Ÿè§‰è¿˜æ˜¯å¾ˆä¸é”™çš„ï¼ŒæŠ å›¾å°±æ‰£äº†è€åŠå¤©äº†ï¼Œä¼šèµ‹äºˆæ•Œäººç‡ƒçƒ§æ•ˆæœï¼Œå¹¶ä¸”ä¼šæœ‰å¸é™„æ•ˆæœï¼Œæ¸…å…µç¥å™¨ï¼Œè‡ªå·±è°ƒè¯•çš„æ—¶å€™ï¼ŒæŠŠCDæ”¹æˆ0.1ï¼Œç›´æ¥ç§’å¤©ç§’åœ°äº†ã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Projectiles;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlareStormProjectile</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.width = <span class="number">168</span>; <span class="comment">// å¼¹å¹•å®½åº¦</span></span><br><span class="line">            Projectile.height = <span class="number">164</span>; <span class="comment">// å¼¹å¹•é«˜åº¦</span></span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦å¯¹ç©å®¶å‹å¥½</span></span><br><span class="line">            Projectile.hostile = <span class="literal">false</span>; <span class="comment">// æ˜¯å¦å¯¹æ•Œäººå‹å¥½</span></span><br><span class="line">            Projectile.tileCollide = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦ä¸ç“·ç –ç¢°æ’</span></span><br><span class="line">            Projectile.penetrate = <span class="number">9999</span>; <span class="comment">// ç©¿é€æ•°é‡</span></span><br><span class="line">            Projectile.timeLeft = <span class="number">300</span>; <span class="comment">// å¼¹å¹•çš„å­˜æ´»æ—¶é—´ï¼ˆå¸§ï¼‰</span></span><br><span class="line">            Projectile.light = <span class="number">0.8f</span>; <span class="comment">// å¼¹å¹•çš„å…‰äº®åº¦</span></span><br><span class="line">            Projectile.ignoreWater = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦å¿½ç•¥æ°´</span></span><br><span class="line">            Projectile.extraUpdates = <span class="number">1</span>; <span class="comment">// æ¯å¸§æ›´æ–°æ¬¡æ•°</span></span><br><span class="line">            Projectile.aiStyle = <span class="number">-1</span>; <span class="comment">// è‡ªå®šä¹‰AI</span></span><br><span class="line">            Main.projFrames[Projectile.type] = <span class="number">4</span>; <span class="comment">// è®¾ç½®å¼¹å¹•çš„å¸§æ•°</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AI</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºç«ç„°ç²’å­ç‰¹æ•ˆ</span></span><br><span class="line">            <span class="keyword">if</span> (Main.rand.NextBool(<span class="number">3</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                Dust dust = Dust.NewDustDirect(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Yellow);</span><br><span class="line">                dust.noGravity = <span class="literal">true</span>; <span class="comment">// ç²’å­ä¸å—é‡åŠ›å½±å“</span></span><br><span class="line">                dust.velocity *= <span class="number">1.2f</span>; <span class="comment">// å¢åŠ ç²’å­é€Ÿåº¦</span></span><br><span class="line">                dust.scale *= <span class="number">1.5f</span>; <span class="comment">// å¢åŠ ç²’å­è§„æ¨¡</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®¾ç½®å¼¹å¹•æ²¿åœ°é¢å‰è¿›</span></span><br><span class="line">            <span class="keyword">if</span> (Projectile.velocity.Y == <span class="number">0f</span>) <span class="comment">// æ£€æŸ¥å¼¹å¹•æ˜¯å¦åœ¨åœ°é¢ä¸Š</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Projectile.velocity.X &gt; <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Projectile.velocity.X = Math.Max(Projectile.velocity.X - <span class="number">0.1f</span>, <span class="number">0</span>); <span class="comment">// å·¦ç§»å‡é€Ÿ</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Projectile.velocity.X &lt; <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Projectile.velocity.X = Math.Min(Projectile.velocity.X + <span class="number">0.1f</span>, <span class="number">0</span>); <span class="comment">// å³ç§»å‡é€Ÿ</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Math.Abs(Projectile.velocity.X) &lt; <span class="number">0.2f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Projectile.velocity.X = <span class="number">0f</span>; <span class="comment">// åœæ­¢ç§»åŠ¨</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Projectile.velocity.Y += <span class="number">0.2f</span>; <span class="comment">// é‡åŠ›ä½œç”¨</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ å…‰æ•ˆ</span></span><br><span class="line">            Lighting.AddLight(Projectile.Center, <span class="number">0.8f</span>, <span class="number">0.4f</span>, <span class="number">0.1f</span>); <span class="comment">// æ·»åŠ æ©™è‰²å…‰æ•ˆ</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ›´æ–°åŠ¨ç”»å¸§</span></span><br><span class="line">            Projectile.frameCounter++;</span><br><span class="line">            <span class="keyword">if</span> (Projectile.frameCounter &gt;= <span class="number">5</span>) <span class="comment">// æ¯5å¸§åˆ‡æ¢ä¸€æ¬¡å›¾ç‰‡</span></span><br><span class="line">            &#123;</span><br><span class="line">                Projectile.frame++;</span><br><span class="line">                Projectile.frame %= <span class="number">4</span>; <span class="comment">// å¾ªç¯å¸§åŠ¨ç”»</span></span><br><span class="line">                Projectile.frameCounter = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¸é™„æ•Œæ€ª</span></span><br><span class="line">            <span class="keyword">foreach</span> (NPC npc <span class="keyword">in</span> Main.npc)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (npc.active &amp;&amp; !npc.friendly &amp;&amp; !npc.dontTakeDamage &amp;&amp; Vector2.Distance(Projectile.Center, npc.Center) &lt; <span class="number">300f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Vector2 direction = Projectile.Center - npc.Center;</span><br><span class="line">                    direction.Normalize();</span><br><span class="line">                    npc.velocity += direction * <span class="number">0.1f</span>; <span class="comment">// å¸é™„æ•ˆæœ</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnHitNPC</span>(<span class="params">NPC target, NPC.HitInfo hit, <span class="built_in">int</span> damageDone</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            target.AddBuff(BuffID.OnFire, <span class="number">300</span>); <span class="comment">// é€ æˆç‡ƒçƒ§æ•ˆæœï¼ŒæŒç»­5ç§’</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">OnTileCollide</span>(<span class="params">Vector2 oldVelocity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.velocity = Vector2.Zero; <span class="comment">// åœæ­¢ç§»åŠ¨ï¼Œä½†ä¸æ¶ˆå¤±</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// ä¸æ‘§æ¯å¼¹å¹•</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Kill</span>(<span class="params"><span class="built_in">int</span> timeLeft</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å¯ä»¥åœ¨å¼¹å¹•æ‘§æ¯æ—¶æ·»åŠ ç‰¹æ•ˆ</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç©ºæ¶¡é¾™-4"><ul><li>é¾™å½—æ˜Ÿå€’æ˜¯æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæ„Ÿè§‰è¿™ä¸ªä¸æ˜¯å¾ˆå¥½è¿˜åŸçš„å…¶å®ï¼Œå¼¹å¹•ç”Ÿæˆçš„ä¸ä¼šå¾ˆä¸æ»‘ï¼Œè¿åŠ¨è½¨è¿¹ï¼Œemmm ä¹Ÿå¾ˆå¥‡æ€ªï¼Œå¯èƒ½æ˜¯ä¼šæœ‰æ›´å¹³æ»‘çš„å‡½æ•°å®ç°å§ã€‚</li><li>æ¯æ¬¡å‘å°„çš„æ—¶å€™éƒ½ä¼šæ²¿é¼ æ ‡æ–¹å‘ã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DragonMeteorProjectile</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> hasAccelerated = <span class="literal">false</span>; <span class="comment">// æ˜¯å¦å·²ç»å¼€å§‹åŠ é€Ÿ</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> hoverTime = <span class="number">60</span>; <span class="comment">// æ‚¬åœæ—¶é—´ï¼ˆå¸§ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.width = <span class="number">32</span>; <span class="comment">// å¼¹å¹•å®½åº¦</span></span><br><span class="line">            Projectile.height = <span class="number">32</span>; <span class="comment">// å¼¹å¹•é«˜åº¦</span></span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦å¯¹ç©å®¶å‹å¥½</span></span><br><span class="line">            Projectile.hostile = <span class="literal">false</span>; <span class="comment">// æ˜¯å¦å¯¹æ•Œäººå‹å¥½</span></span><br><span class="line">            Projectile.tileCollide = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦ä¸ç“·ç –ç¢°æ’</span></span><br><span class="line">            Projectile.penetrate = <span class="number">-1</span>; <span class="comment">// ç©¿é€æ•°é‡ï¼Œè®¾ç½®ä¸º-1è¡¨ç¤ºä¸ä¼šæ¶ˆå¤±</span></span><br><span class="line">            Projectile.timeLeft = <span class="number">300</span>; <span class="comment">// å¼¹å¹•çš„å­˜æ´»æ—¶é—´ï¼ˆå¸§ï¼‰</span></span><br><span class="line">            Projectile.light = <span class="number">0.8f</span>; <span class="comment">// å¼¹å¹•çš„å…‰äº®åº¦</span></span><br><span class="line">            Projectile.ignoreWater = <span class="literal">true</span>; <span class="comment">// æ˜¯å¦å¿½ç•¥æ°´</span></span><br><span class="line">            Projectile.extraUpdates = <span class="number">1</span>; <span class="comment">// æ¯å¸§æ›´æ–°æ¬¡æ•°</span></span><br><span class="line">            Main.projFrames[Projectile.type] = <span class="number">4</span>; <span class="comment">// è®¾ç½®å¼¹å¹•çš„å¸§æ•°</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AI</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (hoverTime &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                hoverTime--;</span><br><span class="line">                Projectile.velocity = Vector2.Zero; <span class="comment">// æ‚¬åœæ—¶é€Ÿåº¦ä¸ºé›¶</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä¸äº§ç”Ÿç²’å­ç‰¹æ•ˆ</span></span><br><span class="line">                <span class="keyword">if</span> (hoverTime % <span class="number">10</span> == <span class="number">0</span>) <span class="comment">// æ¯10å¸§äº§ç”Ÿä¸€æ¬¡ç²’å­ç‰¹æ•ˆï¼ˆå¯ä»¥è°ƒæ•´é¢‘ç‡ï¼‰</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Pink, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">1.0f</span>);</span><br><span class="line">                    Main.dust[dustIndex].velocity *= <span class="number">0.5f</span>;</span><br><span class="line">                    Main.dust[dustIndex].scale *= <span class="number">1.2f</span>;</span><br><span class="line">                    Main.dust[dustIndex].noGravity = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!hasAccelerated)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 targetPosition = Main.MouseWorld;</span><br><span class="line">                Vector2 direction = targetPosition - Projectile.Center;</span><br><span class="line">                direction.Normalize();</span><br><span class="line">                Projectile.velocity = direction * <span class="number">2f</span>; <span class="comment">// è®¾ç½®åˆå§‹é€Ÿåº¦</span></span><br><span class="line">                hasAccelerated = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Projectile.velocity *= <span class="number">1.05f</span>; <span class="comment">// ç¼“æ…¢åŠ é€Ÿ</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ ç²’å­æ•ˆæœæˆ–å…¶ä»–è§†è§‰æ•ˆæœ</span></span><br><span class="line">            <span class="keyword">if</span> (hoverTime &lt;= <span class="number">0</span>) <span class="comment">// åªæœ‰åœ¨åŠ é€Ÿé˜¶æ®µæ‰äº§ç”Ÿç²’å­ç‰¹æ•ˆ</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Red, Projectile.velocity.X * <span class="number">0.5f</span>, Projectile.velocity.Y * <span class="number">0.5f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">1.0f</span>);</span><br><span class="line">                Main.dust[dustIndex].velocity *= <span class="number">0.5f</span>;</span><br><span class="line">                Main.dust[dustIndex].scale *= <span class="number">1.2f</span>;</span><br><span class="line">                Main.dust[dustIndex].noGravity = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Kill</span>(<span class="params"><span class="built_in">int</span> timeLeft</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºçˆ†ç‚¸æ•ˆæœçš„èŒƒå›´ä¼¤å®³</span></span><br><span class="line">            <span class="built_in">float</span> explosionRadius = <span class="number">150f</span>; <span class="comment">// çˆ†ç‚¸èŒƒå›´</span></span><br><span class="line">            <span class="built_in">int</span> damage = <span class="number">300</span>; <span class="comment">// çˆ†ç‚¸ä¼¤å®³</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// æŸ¥æ‰¾çˆ†ç‚¸èŒƒå›´å†…çš„æ•Œäººå¹¶é€ æˆä¼¤å®³</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Main.maxNPCs; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                NPC npc = Main.npc[i];</span><br><span class="line">                <span class="keyword">if</span> (npc.CanBeChasedBy(<span class="keyword">this</span>) &amp;&amp; Vector2.Distance(npc.Center, Projectile.Center) &lt; explosionRadius)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// è®¡ç®—ä¼¤å®³å¹¶åº”ç”¨</span></span><br><span class="line">                    npc.SimpleStrikeNPC(damage, <span class="number">0</span>, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">null</span>, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">false</span>); <span class="comment">// hitDirection è®¾ç½®ä¸º -1 è¡¨ç¤ºæ— ç‰¹å®šæ–¹å‘</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ’­æ”¾éŸ³æ•ˆ</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Smoke, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">2f</span>);</span><br><span class="line">                Main.dust[dustIndex].velocity *= <span class="number">1.4f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Blue, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">3f</span>);</span><br><span class="line">                Main.dust[dustIndex].noGravity = <span class="literal">true</span>;</span><br><span class="line">                Main.dust[dustIndex].velocity *= <span class="number">5f</span>;</span><br><span class="line">                dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Red, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">2f</span>);</span><br><span class="line">                Main.dust[dustIndex].velocity *= <span class="number">3f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">PreDraw</span>(<span class="params"><span class="keyword">ref</span> Color lightColor</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰å¸§çš„æºçŸ©å½¢</span></span><br><span class="line">            Rectangle sourceRectangle = <span class="keyword">new</span> Rectangle(<span class="number">0</span>, Projectile.frame * Projectile.height, Projectile.width, Projectile.height);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç»˜åˆ¶å¼¹å¹•</span></span><br><span class="line">            Main.spriteBatch.Draw(</span><br><span class="line">                Terraria.GameContent.TextureAssets.Projectile[Projectile.type].Value,</span><br><span class="line">                Projectile.Center - Main.screenPosition,</span><br><span class="line">                sourceRectangle,</span><br><span class="line">                lightColor,</span><br><span class="line">                Projectile.rotation,</span><br><span class="line">                <span class="keyword">new</span> Vector2(Projectile.width / <span class="number">2</span>, Projectile.height / <span class="number">2</span>),</span><br><span class="line">                Projectile.scale,</span><br><span class="line">                SpriteEffects.None,</span><br><span class="line">                <span class="number">0f</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// è¿”å›falseï¼Œè¡¨ç¤ºæˆ‘ä»¬è‡ªå·±ç»˜åˆ¶äº†å¼¹å¹•</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1>å¸•é²å·¥ä½œå°</h1><ul><li>å·¥ä½œå°å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªç‰©å—è€Œå·²</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Items.WorkBench</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PolworldBasicWorkBenchItem</span> : <span class="title">ModItem</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Item.width = <span class="number">28</span>;</span><br><span class="line">            Item.height = <span class="number">14</span>;</span><br><span class="line">            Item.maxStack = <span class="number">99</span>;</span><br><span class="line">            Item.useTurn = <span class="literal">true</span>;</span><br><span class="line">            Item.autoReuse = <span class="literal">true</span>;</span><br><span class="line">            Item.useAnimation = <span class="number">15</span>;</span><br><span class="line">            Item.useTime = <span class="number">10</span>;</span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.consumable = <span class="literal">true</span>;</span><br><span class="line">            Item.createTile = ModContent.TileType&lt;Tiles.PolworldBasicWorkBench&gt;(); <span class="comment">// è®¾ç½®å¯¹åº”çš„Tile</span></span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span></span><br><span class="line">        &#123;          </span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.Wood, <span class="number">30</span>);</span><br><span class="line">            recipe.AddIngredient(ItemID.Sapphire, <span class="number">10</span>);</span><br><span class="line">            recipe.AddIngredient(ItemID.Silk, <span class="number">10</span>);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>éšååœ¨åˆ¶ä½œç‰©å“çš„æ—¶å€™ï¼ŒæŒ‡æ˜éœ€è¦çš„ç‰©å—å³å¯</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Mounts;</span><br><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Tiles;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Items.Mounts</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FenglopeMountItem</span> : <span class="title">ModItem</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span> &#123;</span><br><span class="line">Item.width = <span class="number">20</span>;</span><br><span class="line">Item.height = <span class="number">30</span>;</span><br><span class="line">Item.useTime = <span class="number">20</span>;</span><br><span class="line">Item.useAnimation = <span class="number">20</span>;</span><br><span class="line">Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">Item.<span class="keyword">value</span> = Item.sellPrice(gold: <span class="number">3</span>);</span><br><span class="line">Item.rare = ItemRarityID.Yellow;</span><br><span class="line">Item.UseSound = SoundID.Item79;</span><br><span class="line">Item.noMelee = <span class="literal">true</span>;</span><br><span class="line">Item.mountType = ModContent.MountType&lt;FenglopeMount&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span> &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">recipe.AddIngredient(ItemID.HallowedBar, <span class="number">20</span>);</span><br><span class="line">recipe.AddIngredient(ItemID.SoulofFlight, <span class="number">5</span>);</span><br><span class="line">recipe.AddIngredient(ItemID.SoulofLight, <span class="number">10</span>);</span><br><span class="line">            recipe.AddIngredient(ItemID.Sapphire, <span class="number">5</span>);</span><br><span class="line">recipe.AddTile(Mod, <span class="string">&quot;PolworldBasicWorkBench&quot;</span>);  <span class="comment">// è¿™é‡ŒæŒ‡æ˜éœ€è¦å¸•é²åŸºç¡€å·¥ä½œå°å°±å¥½å•¦ï¼Œè¿™æ ·çš„è¯å¿…é¡»ä½¿ç”¨å·¥ä½œå°æ‰èƒ½åˆ¶ä½œå“¦</span></span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æŒç»­æ›´æ–°ä¸­...</summary>
    
    
    
    <category term="Modå¼€å‘" scheme="https://cyborg2077.github.io/categories/Mod%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Modå¼€å‘" scheme="https://cyborg2077.github.io/tags/Mod%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>æ³°æ‹‰ç‘äºšModå¼€å‘æŒ‡å—</title>
    <link href="https://cyborg2077.github.io/2024/07/06/TModDev/"/>
    <id>https://cyborg2077.github.io/2024/07/06/TModDev/</id>
    <published>2024-07-06T06:21:01.000Z</published>
    <updated>2024-07-19T15:24:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1>Hello World</h1><ul><li>æ¬¢è¿æ¥åˆ°æ³°æ‹‰ç‘äºšçš„åˆ›æ„æ— é™ä¸–ç•Œï¼Œåœ¨è¿™é‡Œï¼Œä¸ä»…ä»…æ˜¯æ¢ç´¢ä¸å†’é™©ï¼Œæ›´æ˜¯åˆ›é€ ä¸å®ç°æ¢¦æƒ³çš„å¤©åœ°ã€‚ä½œä¸ºä¸€åå‹‡æ•¢çš„å¼€å‘è€…ï¼Œä½ å³å°†ä»–ä¸Šçš„æ—…ç¨‹ï¼Œä¸è¿‘è§†æ·±å…¥è¿™ä¸ªåƒç´ ä¸–ç•Œçš„è…¹åœ°ï¼Œæ›´æ˜¯è¦åœ¨å…¶åŸºç¡€ä¸Šæ„å»ºå±äºä½ è‡ªå·±çš„å¥‡è¿¹ã€‚æœ¬æŒ‡å—å°†æ˜¯ä½ å—ä¼—çš„ç½—ç›˜ï¼Œå¼•é¢†ä½ æ­¥å…¥æ³°æ‹‰ç‘äºšæ¨¡ç»„å¼€å‘çš„ç¥ç§˜å¤§é—¨ã€‚</li><li>æƒ³è±¡ä¸€ä¸‹ï¼Œå½“ä½ æ‰‹æŒä»£ç ä¹‹é—´ï¼Œæ¡¥ä¸‹ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œä¸€ä¸ªç®€å•çš„&quot;Hello World&quot;ä¾¿èƒ½åœ¨æ³°æ‹‰ç‘äºšå¹¿é˜”çš„å¤©åœ°é—´å›å“ï¼Œè¿™ä¸ä»…æ˜¯å˜æˆä¼ ç»Ÿçš„ç›´å¾„ï¼Œä¹Ÿæ˜¯ä½ æˆä¸ºæ¸¸æˆä¸–ç•Œé€ ç‰©ä¸»çš„ç¬¬ä¸€æ­¥ã€‚æ³°æ‹‰ç‘äºšmodå¼€å‘çš„é­…åŠ›ï¼Œåœ¨äºå®ƒèµ‹äºˆä½ é‡å¡‘ä¸–ç•Œè§„åˆ™çš„èƒ½åŠ›ï¼Œæ— è®ºæ˜¯æ–°å¥‡çš„æ­¦å™¨ã€ç‹¬ç‰¹çš„æ€ªç‰©ï¼Œè¿˜æ˜¯æ•´ä¸ªå¼‚ä¸–ç•Œçš„åˆ›é€ ï¼Œä¸€åˆ‡çš†æœ‰å¯èƒ½ã€‚</li><li>æœ¬æŒ‡å—å°†å¾ªåºæ¸è¿›ï¼Œä»æœ€åŸºç¡€çš„è®¾ç½®ç¯å¢ƒå¼€å§‹ï¼Œé€æ­¥æ·±å…¥å¦‚ä½•ä½¿ç”¨C#å’ŒTModLoaderæ¥ç¼–å†™ä½ çš„ç¬¬ä¸€ä¸ªmodï¼Œç†è§£èƒŒåçš„é€»è¾‘ä¸æŠ€å·§ï¼Œä¸ºä½ åç»­çš„åˆ›æ„å¼€å‘æ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚</li><li>æ— è®ºä½ æ˜¯ç¼–ç¨‹æ–°æ‰‹ï¼Œè¿˜æ˜¯ç»éªŒä¸°å¯Œçš„å¼€å‘è€…åˆæ¶‰æ¸¸æˆé¢†åŸŸï¼Œè¿™ç¯‡æŒ‡å—éƒ½åŠ›æ±‚è®©ä½ çš„æ¯ä¸€æ­¥å­¦ä¹ éƒ½å……æ»¡ä¹è¶£ä¸æˆå°±æ„Ÿã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼‚åŒæ­¥å…¥æ³°æ‹‰ç‘äºšçš„ç¼–ç¨‹ä»™å¢ƒï¼Œç”¨ä¸€è¡Œè¡Œä»£ç ç¼–åˆ¶å‡ºå±äºä½ çš„ä¼ å¥‡æ•…äº‹ã€‚</li><li>è®©æˆ‘ä»¬å¼€å§‹å§ï¼</li></ul><h1>Modåˆ¶ä½œå‡†å¤‡</h1><ol><li>ä¸€å°ç”µè„‘</li><li>ç©è¿‡æ³°æ‹‰ç‘äºšï¼ŒåŸç‰ˆæˆ–è€…ç¾å„è‡³å°‘é€šå…³è¿‡ä¸€æ¬¡ï¼ˆåšä¸»åŸç‰ˆå¤§å¸ˆã€ç¾å„æ­»äº¡å¤§å¸ˆéƒ½é€šå…³äº†ï¼‰</li><li>å®‰è£…IDEï¼Œå¼ºçƒˆå»ºè®®VSCodeï¼Œä¸»è¦æ˜¯å†™C#</li><li>ä¼šä½¿ç”¨ç”»å›¾è½¯ä»¶ï¼ˆPhotoshopç­‰ï¼‰</li></ol><h2 id="NETç¯å¢ƒå®‰è£…">.NETç¯å¢ƒå®‰è£…</h2><ul><li>å¼€å‘ç¯å¢ƒçš„å®‰è£…ï¼Œå¯ä»¥ç›´æ¥çœ‹å¾®è½¯å®˜æ–¹æ•™ç¨‹</li></ul><div class="tag link"><a class="link-card" title="" href="https://dotnet.microsoft.com/zh-cn/learn/dotnet/hello-world-tutorial/install"><div class="left"><img src="https://dotnet.microsoft.com/favicon.ico"/></div><div class="right"><p class="text"></p><p class="url">https://dotnet.microsoft.com/zh-cn/learn/dotnet/hello-world-tutorial/install</p></div></a></div><ul><li>è¿™é‡Œå†å»ºè®®å®‰è£…ä¸€ä¸ªé€šä¹‰çµç çš„æ’ä»¶ï¼Œç”¨èµ·æ¥è¿˜æ˜¯æŒºæ–¹ä¾¿çš„<br><img src="https://s21.ax1x.com/2024/07/07/pkWQOwq.png" alt=""></li></ul><h2 id="TModLoaderçš„ä»‹ç»ä¸å®‰è£…">TModLoaderçš„ä»‹ç»ä¸å®‰è£…</h2><h3 id="æºç Modå’ŒTML-Modçš„åŒºåˆ«">æºç Modå’ŒTML Modçš„åŒºåˆ«</h3><blockquote><ul><li>æºç Modçš„åˆ¶ä½œæ–¹æ³•æ˜¯é€šè¿‡åç¼–è¯‘æ³°æ‹‰ç‘äºšæºç ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šä¿®æ”¹è€Œåˆ¶ä½œçš„æ¨¡ç»„ã€‚ä¼˜ç‚¹æ˜¯è‡ªç”±åº¦é«˜ï¼Œå¯ä»¥å®ç°çš„åŠŸèƒ½å¤šã€‚ç¼ºç‚¹æ˜¯å¾ˆéš¾ç®¡ç†ï¼Œçµæ´»åº¦ä½ä¸‹ï¼Œå°¤å…¶æ˜¯å½“Modè§„æ¨¡æ‰©å¤§çš„æ—¶å€™ã€‚</li><li>TML Modé€šè¿‡æä¾›åŸç‰ˆçš„æ¥å£ä½¿å¾—å¼€å‘è€…å¯ä»¥åœ¨ä¸€ä¸ªä¸åŸç‰ˆç‹¬ç«‹çš„ç¯å¢ƒå¼€å‘Modï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¼€å‘è€…å¯ä»¥ä¸ç”¨å…³æ³¨åŸç‰ˆå†—é•¿çš„ä»£ç å®ç°ç»†èŠ‚ï¼Œè€Œæ˜¯ä¸æ¥å£è¿›è¡Œäº’åŠ¨ã€‚ä¼˜ç‚¹æ˜¯ç®¡ç†æ–¹ä¾¿ã€çµæ´»ã€‚ç¼ºç‚¹æ˜¯å®ç°çš„åŠŸèƒ½å…·æœ‰å±€é™æ€§ï¼Œæœ‰æ—¶å€™éœ€è¦ç­‰å¾…TMLå¼€å‘è€…æ·»åŠ äº†æŸäº›æ¥å£æ‰èƒ½å®ç°ç‰¹å®šçš„åŠŸèƒ½ã€‚ä½†æ˜¯éšç€TMLè¿™ä¹ˆå¤šå¹´åŠŸèƒ½çš„ä¸æ–­çš„å®Œå–„ï¼Œä»¥åŠåŸç‰ˆæ³°æ‹‰ç‘äºšä»£ç è¶Šæ¥è¶Šæ™¦æ¶©éš¾æ‡‚ï¼ŒTMLå¼€å‘æœ€ç»ˆå æ®äº†ä¸»å¯¼ã€‚</li></ul></blockquote><h3 id="TModLoaderçš„å®‰è£…">TModLoaderçš„å®‰è£…</h3><ul><li><p>å¦‚æœä½ ä¹‹å‰æ‰“è¿‡modç©ï¼Œé‚£ä¹ˆå…¶å®ä½ å·²ç»å®‰è£…å¥½äº†ï¼Œå¯¹å§</p></li><li><p>å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨modæ¸¸ç©ï¼Œç›´æ¥åœ¨Steamä¸Šä¸‹è½½å®‰è£…å³å¯<br><img src="https://s21.ax1x.com/2024/07/07/pkWlMXd.png" alt=""></p></li><li><p>å®‰è£…å®Œæˆä¹‹åï¼Œç›´æ¥TMODï¼Œå¯åŠ¨ï¼<br><img src="https://s21.ax1x.com/2024/07/07/pkWl37t.png" alt=""></p></li><li><p>ç‚¹å‡»åˆ›æ„å·¥åŠï¼Œè¿›å…¥åˆ›æ„å·¥åŠä¸­å¿ƒ<br><img src="https://s21.ax1x.com/2024/07/06/pkWi8uF.png" alt=""></p></li><li><p>ç‚¹å‡»å¼€å‘æ¨¡ç»„ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹é¡µé¢<br><img src="https://s21.ax1x.com/2024/07/07/pkWlD7q.png" alt=""></p></li></ul><h1>ç¬¬ä¸€ä¸ªMod</h1><ul><li><p>ç‚¹å‡»å³ä¸‹è§’åˆ›å»ºæ¨¡ç»„ï¼Œå¡«å†™æ¨¡ç»„ä¿¡æ¯æˆ‘ä»¬å°±å¯ä»¥åˆå§‹åŒ–ä¸€ä¸ªæ¨¡ç»„é¡¹ç›®äº†</p><ul><li>ModNameï¼šæ¨¡ç»„åç§°ï¼Œä¸è¦å¤¹æ‚ç©ºæ ¼</li><li>Mod DisplayNameï¼šæ¨¡ç»„æ˜¾ç¤ºåç§°</li><li>Mod Authorï¼šæ¨¡ç»„ä½œè€…</li><li>BasicSwordï¼šåˆå§‹ä¹‹å‰‘ï¼Œè¿™é‡Œå¡«å†™çš„æ˜¯å‰‘çš„åç§°ï¼Œåˆ›å»ºé¡¹ç›®æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆè¿™æŠŠå‰‘çš„åˆå§‹åŒ–ä»£ç <br><img src="https://s21.ax1x.com/2024/07/07/pkWlg9U.png" alt=""></li></ul></li><li><p>ç‚¹å‡»åˆ›å»ºåï¼Œåˆå§‹åŒ–çš„é¡¹ç›®å¦‚ä¸‹<br><img src="https://s21.ax1x.com/2024/07/07/pkW1SEt.png" alt=""></p></li><li><p>æˆ‘ä»¬åœ¨VSCodeé‡Œæ‰“å¼€è¿™ä¸ªé¡¹ç›®ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹ç›®å½•ç»“æ„<br><img src="https://s21.ax1x.com/2024/07/07/pkW1PC8.png" alt=""></p><ol><li><code>[ModName].cs</code>ï¼šè¿™æ˜¯Modç±»ã€‚å®ƒæ˜¯ä»»ä½•Modçš„æ ¸å¿ƒæ–‡ä»¶ï¼Œæ¯ä¸ªModåªèƒ½å­˜åœ¨ä¸€ä¸ªModç±»ï¼Œå¯¹äºç®€å•çš„Modï¼Œè¿™ä¸ªæ–‡ä»¶ä¼šéå¸¸ç®€æ´ï¼Œä½†æ˜¯è¿™ä¸ªç±»ä¸­å¯ä»¥å‘ç”Ÿå„ç§å…¨å±€æ€§çš„äº‹æƒ…ã€‚</li><li><code>description.txt</code>ï¼šåŒ…å«Modçš„æè¿°æ–‡æœ¬ï¼Œåœ¨Modèœå•ä¸­ç‚¹å‡»â€œæ›´å¤šä¿¡æ¯â€æŒ‰é’®å¯ä»¥åœ¨æ¸¸æˆä¸­æŸ¥çœ‹ã€‚å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰é¢å¤–BBCodeæ ¼å¼çš„description_workshop.txtæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†åœ¨Steamåˆ›æ„å·¥åŠç½‘ç«™ä¸Šæ˜¾ç¤ºã€‚</li><li><code>build.txt</code>ï¼šåŒ…å«Modçš„ç‰ˆæœ¬ã€ä½œè€…å’Œæ˜¾ç¤ºä¿¡æ¯ã€‚å¯ä»¥åŒ…å«å…¶ä»–å€¼ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯å¿…è¦çš„ã€‚</li><li><code>icon.png</code>ï¼šåœ¨æ¸¸æˆä¸­æ˜¾ç¤ºçš„80x80å›¾æ ‡ã€‚ä½ å¯ä»¥ä¸ºSteamåˆ›æ„å·¥åŠåˆ›å»ºä¸€ä¸ªæ›´è¯¦ç»†æˆ–æ›´é«˜åˆ†è¾¨ç‡çš„icon_workshop.pngå›¾æ ‡ï¼Œè¯¥æ–‡ä»¶å¯ä»¥è¾¾åˆ°512x512åƒç´ ã€‚</li><li><code>[ModName].csproj</code>ï¼šä¸ºVisual Studioè®¾ç½®çš„é¡¹ç›®æ–‡ä»¶ï¼Œç”¨äºè°ƒè¯•ä½ çš„Modã€‚è°ƒè¯•éå¸¸æœ‰ç”¨ï¼Œä½†éœ€è¦ä¸€äº›å­¦ä¹ ï¼Œä¸è¦åˆ é™¤å®ƒã€‚</li><li><code>Properties/launchSettings.json</code>ï¼šä¸ModName.csprojç›¸å…³ï¼ŒåŒ…å«ç”¨äºè°ƒè¯•tModLoaderæ–‡ä»¶è·¯å¾„ï¼Œä¸è¦åˆ é™¤ï¼Œéšç€ä½ çš„ç»éªŒç§¯ç´¯ï¼Œå®ƒä¼šå˜å¾—å¾ˆæœ‰ç”¨ã€‚</li><li><code>Content/Items/[ItemName].cs</code>ï¼šä¸€ä¸ªç®€å•çš„å‰‘ç‰©å“ã€‚ä»¥æ­¤ä½œä¸ºç¤ºä¾‹ï¼Œå­¦ä¹ å¦‚ä½•åˆ¶ä½œå…¶ä»–ModItemç±»ã€‚</li><li><code>Content/Items/[ItemName].png</code>ï¼šå¯¹åº”çš„ç‰©å“å›¾åƒã€‚</li><li><code>Localization/en-US_Mods.[ModName].hjson</code>ï¼šåŒ…å«Modä¸­å†…å®¹çš„è‹±æ–‡æ–‡æœ¬ã€‚å®ƒç›®å‰åŒ…å«ç”Ÿæˆçš„å‰‘çš„æ˜¾ç¤ºåç§°å’Œå·¥å…·æç¤ºã€‚è¿™ä¸ªæ–‡ä»¶ä¼šéšç€ä½ å‘Modæ·»åŠ æ–°å†…å®¹è€Œè‡ªåŠ¨æ›´æ–°æ¡ç›®ã€‚è¯·å‚é˜…<a href="https://github.com/tModLoader/tModLoader/wiki/Localization">Localization Wiki</a>äº†è§£æ›´å¤šæœ¬åœ°åŒ–åŠæ”¯æŒå…¶ä»–è¯­è¨€çš„ä¿¡æ¯ã€‚</li></ol></li><li><p>ä¸‹é¢æˆ‘ä»¬ç›´æ¥æ¥çœ‹åˆå§‹åŒ–å‰‘çš„ä»£ç ï¼Œä»¥åŠå¯¹åº”çš„é…ç½®æ–‡ä»¶ä¿¡æ¯ã€‚</p></li></ul><div class="tabs" id="åˆå§‹åŒ–å‰‘"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆå§‹åŒ–å‰‘-1">Excalibur.cs</button></li><li class="tab"><button type="button" data-href="#åˆå§‹åŒ–å‰‘-2">Localization.hjson</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆå§‹åŒ–å‰‘-1"><ul><li>ä¸‹é¢è¿™æ®µä»£ç å°±æ˜¯åˆå§‹ä¹‹å‰‘çš„ä»£ç ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹<code>SetDefaults()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯åˆå§‹åŒ–ç‰©å“çš„é…ç½®ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬é…ç½®äº†ç‰©å“çš„ä¼¤å®³ã€æ”»å‡»ç±»å‹ã€å®½é«˜ã€ä½¿ç”¨æ—¶é—´ã€ä½¿ç”¨åŠ¨ç”»ã€ä½¿ç”¨æ–¹å¼ã€å‡»é€€ã€ä»·å€¼ã€ç¨€æœ‰åº¦ã€éŸ³æ•ˆã€è‡ªåŠ¨ä½¿ç”¨ï¼ˆè¿‘æˆ˜æ­¦å™¨è‡ªåŠ¨æŒ¥èˆï¼‰ç­‰ã€‚</li><li>åŒæ—¶æˆ‘ä»¬éœ€è¦å…³æ³¨<code>AddRecipes()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ·»åŠ ç‰©å“çš„åˆæˆé…æ–¹ï¼Œè¿™é‡Œæˆ‘ä»¬æ·»åŠ äº†åˆæˆé…æ–¹ï¼Œéœ€è¦ç”¨10ä¸ªåœŸå—ï¼Œå¹¶ä¸”éœ€è¦å·¥ä½œå°æ‰å¯ä»¥åˆ¶ä½œã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// This is a basic item template.</span></span><br><span class="line">    <span class="comment">// Please see tModLoader&#x27;s ExampleMod for every other example:</span></span><br><span class="line">    <span class="comment">// https://github.com/tModLoader/tModLoader/tree/stable/ExampleMod</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Excalibur</span> : <span class="title">ModItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// The Display Name and Tooltip of this item can be edited in the &#x27;Localization/en-US_Mods.MyFirstMod.hjson&#x27; file.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span> &#123;</span><br><span class="line">            Item.damage = <span class="number">50</span>;</span><br><span class="line">            Item.DamageType = DamageClass.Melee;</span><br><span class="line">            Item.width = <span class="number">40</span>;</span><br><span class="line">            Item.height = <span class="number">40</span>;</span><br><span class="line">            Item.useTime = <span class="number">20</span>;</span><br><span class="line">            Item.useAnimation = <span class="number">20</span>;</span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.knockBack = <span class="number">6</span>;</span><br><span class="line">            Item.<span class="keyword">value</span> = Item.buyPrice(silver: <span class="number">1</span>);</span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">            Item.UseSound = SoundID.Item1;</span><br><span class="line">            Item.autoReuse = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span> &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, <span class="number">10</span>);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é‚£æˆ‘ä»¬ç°åœ¨åŠ è½½Modï¼Œå¹¶ä¸”è¿›å…¥æ¸¸æˆ<br><img src="https://s21.ax1x.com/2024/07/07/pkW3iIx.png" alt=""></li><li>å»ºé€ ä¸€ä¸ªå·¥ä½œå°ï¼Œå¹¶ä¸”ä½¿ç”¨10ä¸ªåœŸå—ï¼Œå³å¯åˆ¶é€ æˆ‘ä»¬çš„åˆå§‹ä¹‹å‰‘<br><img src="https://s21.ax1x.com/2024/07/07/pkW3AJK.png" alt=""></li><li>50ç‚¹ä¼¤å®³æœ‰ç‚¹ä¸å¤Ÿçœ‹å•Šï¼Œé‚£æˆ‘ä»¬ç°åœ¨ä¿®æ”¹ä¸€ä¸‹æ­¦å™¨ä¼¤å®³ä»¥åŠæ”»å‡»é—´éš”ï¼Œéšåé‡æ–°æ„å»ºå¹¶åŠ è½½æˆ‘ä»¬çš„Modï¼Œç„¶åå†æ¬¡è¿›å…¥æ¸¸æˆ</li></ul><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">using Terraria;</span><br><span class="line">using Terraria.ID;</span><br><span class="line">using Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line">namespace MyFirstMod.Content.Items</span><br><span class="line">&#123;</span><br><span class="line">    public class Excalibur : ModItem</span><br><span class="line">    &#123;</span><br><span class="line">        public override void SetDefaults() &#123;</span><br><span class="line"><span class="deletion">-           Item.damage = 50;</span></span><br><span class="line"><span class="addition">+           Item.damage = 99999999;</span></span><br><span class="line">            Item.DamageType = DamageClass.Melee;</span><br><span class="line">            Item.width = 40;</span><br><span class="line">            Item.height = 40;</span><br><span class="line"><span class="deletion">-           Item.useTime = 20;</span></span><br><span class="line"><span class="deletion">-           Item.useAnimation = 20;</span></span><br><span class="line"><span class="addition">+           Item.useTime = 5;</span></span><br><span class="line"><span class="addition">+           Item.useAnimation = 5;</span></span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.knockBack = 6;</span><br><span class="line">            Item.value = Item.buyPrice(silver: 1);</span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">            Item.UseSound = SoundID.Item1;</span><br><span class="line">            Item.autoReuse = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void AddRecipes() &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, 10);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s21.ax1x.com/2024/07/07/pkW3VzD.png" alt=""></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆå§‹åŒ–å‰‘-2"><ul><li>åœ¨è¿™é‡Œå¯ä»¥é…ç½®Modç‰©å“çš„æ˜¾ç¤ºåç§°å’Œæç¤ºä¿¡æ¯ã€‚</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># This file will automatically update with entries for new content after a build and reload.</span><br><span class="line"></span><br><span class="line">Items<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  Excalibur<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    DisplayName<span class="punctuation">:</span> <span class="string">&quot;Excalibur&quot;</span></span><br><span class="line">    Tooltip<span class="punctuation">:</span></span><br><span class="line">      &#x27;&#x27;&#x27;</span><br><span class="line">      Template of an item</span><br><span class="line">      Replacing this tooltip is duty </span><br><span class="line">      It&#x27;s snowing on Mt.Fuji</span><br><span class="line">      &#x27;&#x27;&#x27;</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹åˆå§‹ä¹‹å‰‘çš„åç§°ä»¥åŠæè¿°</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Items<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  Excalibur<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    DisplayName<span class="punctuation">:</span> Hello World!</span><br><span class="line">    Tooltip<span class="punctuation">:</span> ä»£ç ä¹‹åŠ›ï¼Œå°å­ï¼</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1><a href="https://github.com/tModLoader/tModLoader/wiki/Basic-Item">Basic Item</a></h1><ul><li>æœ¬å°èŠ‚æ—¨åœ¨è§£é‡Šæ‰€æœ‰Itemä¹‹é—´çš„å…±åŒç‚¹ã€‚</li></ul><h2 id="ä»€ä¹ˆæ˜¯ç‰©å“ï¼ˆWhat-is-an-Itemï¼‰ï¼Ÿ">ä»€ä¹ˆæ˜¯ç‰©å“ï¼ˆWhat is an Itemï¼‰ï¼Ÿ</h2><ul><li>äº†è§£ç‰©å“ï¼ˆItemï¼‰ã€æŠ›å°„ç‰©ï¼ˆProjectilesï¼‰å’Œæ–¹å—ï¼ˆTilesï¼‰ä¹‹é—´çš„åŒºåˆ«éå¸¸é‡è¦ã€‚åˆšå¼€å§‹æ—¶ï¼Œå¦‚æœä½ ä¸æ¸…æ¥šå®ƒä»¬çš„ä¸åŒä¹‹å¤„ï¼Œå¯èƒ½ä¼šæ— æ„ä¸­æ··æ·†æ¦‚å¿µã€‚ä¾‹å¦‚ï¼Œæœ‰äº›äººå¯èƒ½ä¼šæ··æ·†å¹¶è¯•å›¾å°†<code>å·¥ä½œå°ç‰©å“ï¼ˆItemï¼‰</code>æ·»åŠ åˆ°<code>é…æ–¹</code>ä¸­ï¼Œè€Œå®é™…ä¸Šä»–ä»¬æƒ³è¦æ·»åŠ çš„æ˜¯<code>å·¥ä½œå°æ–¹å—ï¼ˆTileï¼‰</code>ã€‚è¿˜éœ€è¦æ„è¯†åˆ°ï¼Œåƒå›æ—‹é•–æ­¦å™¨è¿™æ ·çš„ä¸œè¥¿å®é™…ä¸Šç”±ç‰©å“å’ŒæŠ›å°„ç‰©ç»„æˆã€‚è™½ç„¶è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ¦‚å¿µï¼Œä½†è¯·è®°ä½è¿™ä¸€ç‚¹ã€‚</li></ul><h2 id="åˆ¶ä½œç‰©å“ï¼ˆMaking-an-Itemï¼‰">åˆ¶ä½œç‰©å“ï¼ˆMaking an Itemï¼‰</h2><ul><li>è¦å°†ç‰©å“æ·»åŠ åˆ°æ³°æ‹‰ç‘äºšï¼Œæˆ‘ä»¬é¦–å…ˆå¿…é¡»åˆ›å»ºä¸€ä¸ªç±»ï¼Œè¯¥ç±»éœ€è¦ç»§æ‰¿<code>ModItem</code>ï¼Œå®é™…ä¸Šä¸Šé¢å°èŠ‚ä¸­çš„<code>[ModName].cs</code>å°±æ˜¯ä¸ªæ ·ä¾‹ï¼Œåœ¨åˆ›å»ºModçš„æ—¶å€™å·²ç»ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€æŠŠå‰‘çš„ç‰©å“ã€‚</li></ul><h3 id="è®¾ç½®é»˜è®¤å€¼">è®¾ç½®é»˜è®¤å€¼</h3><ul><li>ç‰©å“æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯ <code>SetDefaults</code>ã€‚<code>SetDefaults</code> æ˜¯è®¾ç½®ç‰©å“å±æ€§çš„åœ°æ–¹ï¼Œä¾‹å¦‚ç‰©å“ä½¿ç”¨ä»€ä¹ˆå¼¹è¯ã€ç‰©å“çš„å¤§å°ä»¥åŠç‰©å“æ”¾ç½®çš„æ˜¯å“ªä¸ªæ–¹å—ã€‚è¯·å‚é˜… <a href="https://github.com/tModLoader/tModLoader/wiki/Item-Class-Documentation">Item ç±»æ–‡æ¡£</a> ï¼Œäº†è§£åœ¨ SetDefaults ä¸­å¸¸è§çš„è®¾ç½®å€¼çš„å«ä¹‰ã€‚ä½ è¿˜å¯ä»¥é€šè¿‡è®¿é—® <a href="https://github.com/tModLoader/tModLoader/wiki/Vanilla-Item-Field-Values">Vanilla Item</a> æ¥æŸ¥çœ‹åŸç‰ˆç‰©å“å­—æ®µå€¼ã€‚</li></ul><h3 id="æœ¬åœ°åŒ–">æœ¬åœ°åŒ–</h3><ul><li>æ„å»ºä½ çš„ Mod åï¼Œæœ¬åœ°åŒ–æ–‡ä»¶é€šå¸¸ä½äº My Games\Terraria\tModLoader\ModSources\MyModName\Localization\en-US_Mods.MyModName.hjsonï¼Œå°†ä¼šå¡«å……æœ‰æ–°æ·»åŠ ç‰©å“çš„æ¡ç›®ã€‚å¯¹äºç‰©å“ï¼Œä½ ä¼šçœ‹åˆ° DisplayName å’Œ Tooltip çš„æ¡ç›®ã€‚DisplayName å°†é»˜è®¤ä¸ºç±»åï¼Œå•è¯ä¹‹é—´ç”¨å¤§å†™å­—æ¯åˆ†éš”ã€‚Tooltip é»˜è®¤ä¸ºç©ºã€‚ä½ å¯ä»¥ç¼–è¾‘æ­¤æ–‡ä»¶ä»¥è‡ªå®šä¹‰è¿™äº›æœ¬åœ°åŒ–å†…å®¹ï¼š</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Items<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  NameHere<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    DisplayName<span class="punctuation">:</span> Name Here</span><br><span class="line">    Tooltip<span class="punctuation">:</span> This is a modded item.</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1><a href="https://github.com/tModLoader/tModLoader/wiki/Basic-Projectile#what-is-ai">Basic Projectile</a></h1><ul><li>åœ¨å­¦ä¹ å‘é‡ä»¥åŠè®¡ç®—å‡ ä½•çš„çŸ¥è¯†ä¹‹å‰ï¼Œæœ€å¥½èƒ½å…ˆåˆ›å»ºä¸€ä¸ªè‡ªå·±çš„å¼¹å¹•ã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå¼¹å¹•è§‚å¯Ÿåˆ°æ•°å­¦æ˜¯å¦‚ä½•å‘æŒ¥ä½œç”¨çš„ã€‚</li></ul><h2 id="å¼¹å¹•åŸºç¡€">å¼¹å¹•åŸºç¡€</h2><h3 id="ä»€ä¹ˆæ˜¯Projectile">ä»€ä¹ˆæ˜¯Projectile</h3><ul><li>åœ¨å¼€å§‹ä¿®æ”¹å¼¹å¹•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ç‰©å“å’Œå¼¹å¹•ä¹‹é—´çš„åŒºåˆ«ã€‚ç‰©å“æ˜¯å¯ä»¥å­˜å‚¨åœ¨åº“å­˜ä¸­ï¼ˆä¾‹å¦‚èƒŒåŒ…ã€ç®±å­ç­‰ï¼‰çš„å¯¹è±¡ï¼Œè€Œå¼¹å¹•æ—¶ä»æ­¦å™¨æˆ–è€…æ•Œäººå°„å‡ºçš„å¯¹è±¡ï¼Œä¾‹å¦‚å­å¼¹ã€ç®­ç­‰ã€‚</li></ul><h3 id="ä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨å¼¹å¹•ï¼Ÿ">ä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨å¼¹å¹•ï¼Ÿ</h3><ul><li>åœ¨æ³°æ‹‰ç‘äºšä¸­ï¼Œè®¸å¤šç‰©å“å› ä¸ºå¼¹å¹•çš„å­˜åœ¨è€Œå…·æœ‰åŠŸèƒ½æ€§ï¼Œä¾‹å¦‚æªå’Œå¼“ï¼ˆå­å¼¹å’Œç®­ï¼‰ã€æ¿€å…‰ã€ç‚¸å¼¹å’Œå…¶ä»–æŠ•æ·ç‰©å“ï¼Œä»¥åŠå¤§å¤šæ•°é­”æ³•æ­¦å™¨ï¼Œç”šè‡³ä¸€äº›æŠ“é’©ã€è¿æ·ã€é•¿çŸ›ã€å® ç‰©ã€å¬å”¤ç‰©ã€é’»å¤´å’Œæ‚ æ‚ çƒï¼Œä¹Ÿä¼šç”Ÿæˆå¼¹å¹•ã€‚å¾ˆå¤šæ•Œæ€ªä¹Ÿå¯ä»¥ç”Ÿæˆå¼¹å¹•ã€‚</li></ul><h3 id="åˆ›å»ºåŸºæœ¬å¼¹å¹•">åˆ›å»ºåŸºæœ¬å¼¹å¹•</h3><ul><li>åœ¨åˆ›å»ºå¼¹å¹•ä¹‹å‰ï¼Œæˆ‘ä»¬æœ€å¥½å…ˆè§„èŒƒä¸€ä¸‹ç›®å½•ç»“æ„ï¼Œä¸ºåç»­æ‰€æœ‰çš„å¼¹å¹•å»ºç«‹ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹ï¼Œåä¸ºPorjectilesï¼›åŒæ—¶ä¹Ÿä¸ºåˆšåˆšçš„å‰‘åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹ï¼Œåä¸ºSowrdsã€‚<br><img src="https://s21.ax1x.com/2024/07/07/pkWNTpt.png" alt=""></li><li>éšååœ¨Projectilesç›®å½•ä¸‹åˆ›å»º<code>[ProjectileName].cs</code>å’Œ<code>[ProjectileName].png</code>ï¼ˆå¼¹å¹•è´´å›¾ï¼‰æ–‡ä»¶ã€‚åˆ›å»ºå¼¹å¹•æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç»§æ‰¿<code>ModProjectile</code>ç±»ï¼ŒåŒæ—¶éœ€è¦å®ç°<code>SetDefaults</code>æ–¹æ³•ï¼Œ<code>SetDefaults</code>æ–¹æ³•ä¸­éœ€è¦è®¾ç½®å¼¹å¹•çš„å±æ€§ï¼Œä¾‹å¦‚å¼¹å¹•çš„å¤§å°ã€å¼¹å¹•çš„é€Ÿåº¦ã€å¼¹å¹•çš„ä¼¤å®³ã€å¼¹å¹•çš„ä¼¤å®³ç±»å‹ç­‰ã€‚</li><li>ä¸‹é¢ä»£ç ä¸­çš„<code>namespace</code>éœ€è¦æ›¿æ¢ä¸ºä½ è‡ªå·±çš„æ¨¡ç»„æ–‡ä»¶å¤¹å/å‘½åç©ºé—´ã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">      Projectile.arrow = <span class="literal">true</span>;</span><br><span class="line">      Projectile.width = <span class="number">10</span>;</span><br><span class="line">      Projectile.height = <span class="number">10</span>;</span><br><span class="line">      Projectile.aiStyle = ProjAIStyleID.Arrow;</span><br><span class="line">      Projectile.friendly = <span class="literal">true</span>;</span><br><span class="line">      Projectile.DamageType = DamageClass.Ranged;</span><br><span class="line">      AIType = ProjectileID.WoodenArrowFriendly;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Additional hooks/methods here.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åº”ç”¨å¼¹å¹•">åº”ç”¨å¼¹å¹•</h3><div class="note info no-icon flat"><ul><li>è¯·è®°ä½ï¼Œç‰©å“å’Œå¼¹å¹•æ˜¯ä¸åŒçš„ã€‚ä¸€ä¸ªå¸¸è§çš„é”™è¯¯æ˜¯ï¼Œæ¨¡ç»„å¼€å‘è€…åˆ›å»ºäº†ä¸€ä¸ªå¼¹å¹•ï¼Œå´ä¸äº†è§£è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªä½¿ç”¨è¯¥å¼¹å¹•çš„ä¸œè¥¿ã€‚ä¾‹å¦‚ï¼Œå¯¹äºæŠ•æ·é£åˆ€æ­¦å™¨ï¼Œæ‚¨éœ€è¦åŒæ—¶åˆ›å»ºä¸€ä¸ªç‰©å“å’Œä¸€ä¸ªå¼¹å¹•ã€‚å¼¹è¯ç‰©å“ä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„å¼¹å¹•ä¸ä¹‹å…³è”ã€‚å¦‚æœå¼¹å¹•æ˜¯ç”±NPCç”Ÿæˆçš„ï¼Œæ‚¨ä¸æ€»æ˜¯éœ€è¦åŒæ—¶åˆ›å»ºç‰©å“å’Œå¼¹å¹•ã€‚æµ‹è¯•å¼¹å¹•çš„æœ€ç®€å•æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªç‰©å“ï¼Œå¹¶å°† Item.shoot è®¾ç½®ä¸ºå¼¹å¹•ã€‚<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Item.shoot = ModContent.ProjectileType&lt;MyProjectile&gt;();</span><br></pre></td></tr></table></figure></li></ul></div><ul><li>åœ¨åˆšåˆšæˆ‘ä»¬å·²å°†åˆ›å»ºå¥½äº†ä¸€ä¸ªå¼¹å¹•ï¼Œç°åœ¨æˆ‘ä»¬å°†å…¶ä½œç”¨äºæ­¦å™¨ä¸Š<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ using MyFirstMod.Content.Items.Projectiles;</span></span><br><span class="line">using Terraria;</span><br><span class="line">using Terraria.ID;</span><br><span class="line">using Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line">namespace MyFirstMod.Content.Items.Swords</span><br><span class="line">&#123;</span><br><span class="line">    public class Excalibur : ModItem</span><br><span class="line">    &#123;</span><br><span class="line">        public override void SetDefaults() &#123;</span><br><span class="line">            Item.damage = 99999999;</span><br><span class="line">            Item.DamageType = DamageClass.Melee;</span><br><span class="line">            Item.width = 40;</span><br><span class="line">            Item.height = 40;</span><br><span class="line">            Item.useTime = 5;</span><br><span class="line">            Item.useAnimation = 5;</span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.knockBack = 6;</span><br><span class="line">            Item.value = Item.buyPrice(silver: 1);</span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">            Item.UseSound = SoundID.Item1;</span><br><span class="line">            Item.autoReuse = true;</span><br><span class="line"><span class="addition">+           Item.shoot = ModContent.ProjectileType&lt;MyFirstProjectile&gt;();</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void AddRecipes() &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, 10);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>é‡æ–°ç¼–è¯‘å¹¶åŠ è½½Modï¼Œè¿›å…¥æ¸¸æˆï¼ŒæŒ¥èˆæ­¦å™¨ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšåˆšåˆ¶ä½œçš„å¼¹å¹•å·²ç»ç”Ÿæˆäº†ã€‚<br><img src="https://s21.ax1x.com/2024/07/07/pkWUdjf.png" alt=""></li></ul><h3 id="SetDefaults">SetDefaults</h3><ul><li>å¼¹å¹•æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯SetDefaultsæ–¹æ³•ã€‚è¯¥æ–¹æ³•æ˜¯è®¾ç½®å¼¹å¹•å€¼çš„åœ°æ–¹ï¼Œä¾‹å¦‚å‘½ä¸­å®½åº¦å’Œé«˜åº¦ã€å¼¹å¹•æ˜¯å‹å†›è¿˜æ˜¯æ•Œå†›ã€ä»¥åŠå¼¹å¹•å°†ä½¿ç”¨å“ªä¸ªAIã€‚è¯·å‚é˜…<a href="https://github.com/tModLoader/tModLoader/wiki/Projectile-Class-Documentation">å¼¹å¹•ç±»æ–‡æ¡£</a>ä»¥äº†è§£é€šå¸¸è®¾ç½®çš„å€¼çš„å«ä¹‰ã€‚è¿˜å¯ä»¥é€šè¿‡æ”¾æ¸©æš–<a href="https://github.com/tModLoader/tModLoader/wiki/Vanilla-Projectile-Field-Values">Vanillaå¼¹å¹•å­—æ®µå€¼</a>æ¥æŸ¥çœ‹Vanillaå¼¹å¹•å€¼ã€‚</li></ul><h4 id="Projectile-Damage">Projectile.Damage</h4><ul><li>ä¸€ä¸ªå¸¸è§çš„é”™è¯¯æ˜¯åœ¨SetDefaultsä¸­è®¾ç½®Projectiles.Damageï¼Œè¿™ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºå¼¹å¹•çš„ä¼¤å®³å€¼æ€»æ˜¯è¢«ç”Ÿæˆå¼¹å¹•æ—¶ä¼ é€’ç»™Projectile.NewProjectileçš„å€¼è¦†ç›–ã€‚é€šå¸¸ï¼Œç”Ÿæˆå¼¹å¹•çš„ç‰©å“æˆ–NPCå°†å†³å®šä¼¤å®³å€¼ã€‚</li></ul><h3 id="Other-Hooks-Methods">Other Hooks/Methods</h3><ul><li>ModProjectileæ–‡æ¡£åˆ—å‡ºäº†è®¸å¤šå…¶ä»–é’©å­/æ–¹æ³•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»¬ç”Ÿæˆç‹¬ç‰¹çš„å¼¹å¹•ã€‚ä¾‹å¦‚åœ¨å¼¹å¹•å‡»ä¸­æ•Œäººæ—¶æ–½åŠ å‡ç›Šæ•ˆæœï¼Œå¯ä»¥ä½¿ç”¨OnHitNpcæ–¹æ³•ï¼Œè¦åœ¨å¼¹å¹•å‡»ä¸­ç‰©å—æ—¶åšäº›äº‹æƒ…ï¼Œå¯ä»¥ä½¿ç”¨OnTileCollideæ–¹æ³•ã€‚</li></ul><h3 id="What-is-AI">What is AI</h3><ul><li>å¼¹å¹•çš„AIæ˜¯å¼¹å¹•æœ€é‡è¦çš„æ–¹é¢ï¼Œå®ƒæ§åˆ¶å¼¹å¹•åœ¨ç”Ÿæˆåå¦‚ä½•ç§»åŠ¨å’Œè¡ŒåŠ¨ï¼Œå¯¹äºæ–°æ‰‹æ¨¡ç»„å¼€å‘è€…æ¥è¯´ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯é€šè¿‡è®¾ç½®<code>Projectile.aiStyle = #</code>å’Œ<code>AIType = ProjectileID.NameHere</code>æ¥ä¸€æ¥å…¶ä»–åŸç‰ˆå¼¹å¹•å·²ç»ä½¿ç”¨çš„AIä»£ç ã€‚ä½ åˆ†é…ç»™<code>Projectile.aiStyle</code>çš„å€¼åº”è¯¥ä¸<code>ProjectileID.NameHere</code>çš„å€¼ç›¸åŒ¹é…ã€‚è¿™æ¯æˆä¸ºæ¨¡ä»¿åŸç‰ˆå¼¹å¹•ã€‚</li><li>éšç€ä½ å¯¹æ›´é«˜çº§çš„å¼¹å¹•ç§»åŠ¨è¡Œä¸ºçš„éœ€æ±‚ï¼Œä½ ä¼šå‘ç°æ¨¡ä»¿åŸç‰ˆå¼¹å¹•AIéå¸¸æœ‰é™ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•è‡ªå®šä¹‰AIã€‚</li></ul><h4 id="ä½¿ç”¨åŸç‰ˆAI">ä½¿ç”¨åŸç‰ˆAI</h4><ul><li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŸç‰ˆAIæ¥åˆå§‹åŒ–æˆ‘ä»¬çš„å¼¹å¹•ã€‚è®©æˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªå›æ—‹é•–ï¼Œä½¿ç”¨å’ŒåŸç‰ˆå›æ—‹é•–å¼¹å¹•ç›¸åŒçš„aiStyleã€‚æˆ‘ä»¬å¯ä»¥åœ¨<a href=""></a>ä¸­æŸ¥æ‰¾å›æ—‹é•–å¼¹å¹•ï¼Œå¯ä»¥çœ‹åˆ°åŸç‰ˆå›æ—‹é•–ä½¿ç”¨çš„aiStyleä¸º3ã€‚</li><li>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨<code>Projectile.aiStyle = 3;</code>ï¼Œæˆ–è€…å°†3æ”¹ä¸º<code>ProjectileID.Boomerang</code>ï¼Œå¢å¼ºä»£ç çš„å¯è¯»æ€§ã€‚</li><li>ä¸ºäº†è®©è¿™ä¸ªå›æ—‹é•–æ›´ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Projectile.CloneDefaults(ProjectileID.EnchantedBoomerang);</code>ï¼Œè¿™å°†å¤åˆ¶æ‰€æœ‰å…¶ä»–çš„é»˜è®¤å€¼ã€‚è¿™æ ·ï¼Œä½ å°†è·å¾—ä¸€ä¸ªä¸åŸç‰ˆå›æ—‹é•–è¡Œä¸ºç›¸åŒçš„å¼¹å¹•ã€‚</li><li>é€šè¿‡è®¾ç½®AITypeå¯ä»¥æ”¹å˜å¼¹å¹•çš„ç²’å­ç‰¹æ•ˆã€‚</li></ul><div class="tabs" id="åŸç‰ˆaiå›æ—‹é•–"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åŸç‰ˆaiå›æ—‹é•–-1">MyFirstBoomerang.cs</button></li><li class="tab"><button type="button" data-href="#åŸç‰ˆaiå›æ—‹é•–-2">BoomerangProjectileDemo.cs</button></li><li class="tab"><button type="button" data-href="#åŸç‰ˆaiå›æ—‹é•–-3">BoomerangProjectileDemo.cs Clone</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åŸç‰ˆaiå›æ—‹é•–-1"><ul><li>è¯·æ³¨æ„ï¼Œæ­¦å™¨è´´å›¾è¯·è‡ªè¡Œè§£å†³ã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyFirstMod.Content.Items.Projectiles;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Boomerangs</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyFirstBoomerang</span> : <span class="title">ModItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span> &#123;</span><br><span class="line">            Item.damage = <span class="number">99999999</span>;</span><br><span class="line">            Item.DamageType = DamageClass.Melee;</span><br><span class="line">            Item.width = <span class="number">40</span>;</span><br><span class="line">            Item.height = <span class="number">40</span>;</span><br><span class="line">            Item.useTime = <span class="number">5</span>;</span><br><span class="line">            Item.useAnimation = <span class="number">5</span>;</span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.knockBack = <span class="number">6</span>;</span><br><span class="line">            Item.<span class="keyword">value</span> = Item.buyPrice(silver: <span class="number">1</span>);</span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">            Item.UseSound = SoundID.Item1;</span><br><span class="line">            Item.autoReuse = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// é‡ç‚¹æ˜¯è¿™ä¸€è¡Œï¼ŒæŒ‡å®šå¼¹å¹•ç±»å‹</span></span><br><span class="line">            Item.shoot = ModContent.ProjectileType&lt;BoomerangProjectileDemo&gt;();</span><br><span class="line">            Item.shootSpeed = <span class="number">10f</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span> &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, <span class="number">10</span>);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åŸç‰ˆaiå›æ—‹é•–-2"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoomerangProjectileDemo</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.width = <span class="number">10</span>;</span><br><span class="line">            Projectile.height = <span class="number">10</span>;</span><br><span class="line">            Projectile.aiStyle = ProjAIStyleID.Boomerang;</span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>;</span><br><span class="line">            Projectile.DamageType = DamageClass.Ranged;</span><br><span class="line">            AIType = ProjectileID.WoodenArrowFriendly;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Additional hooks/methods here.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åŸç‰ˆaiå›æ—‹é•–-3"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoomerangProjectileDemo</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123; </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.CloneDefaults(ProjectileID.EnchantedBoomerang);</span><br><span class="line">            AIType = ProjectileID.EnchantedBoomerang;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Additional hooks/methods here.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>é‡æ–°ç¼–è¯‘å¹¶åŠ è½½Modï¼Œè¿›å…¥æ¸¸æˆï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨10ä¸ªåœŸå—åœ¨å·¥ä½œå°æ—åˆ¶ä½œæˆ‘ä»¬åˆšåˆšç¼–å†™çš„å›æ—‹é•–äº†ã€‚äº²æµ‹æ‰‹æ„Ÿå’ŒåŸç‰ˆå‡ ä¹æ— å¼‚ï¼ˆè™½ç„¶æˆ‘ä¹Ÿä¸æ€ä¹ˆç”¨å›æ—‹é•–æ­¦å™¨å°±æ˜¯äº†ï¼‰ã€‚</li></ul><h2 id="è‡ªå®šä¹‰AI">è‡ªå®šä¹‰AI</h2><ul><li>æœ¬å°èŠ‚å°†è®¨è®ºä½ å¯ä»¥åœ¨AIä¸­æ·»åŠ çš„å…ƒç´ ï¼Œè®°å¾—å¦‚æœä½¿ç”¨<code>Projectile.CloneDefaults</code>å¤åˆ¶å…¶ä»–å¼¹å¹•é»˜è®¤å€¼ï¼Œè¦å°†<code>Projectile.aiStyle</code>çš„å€¼è®¾å›<code>0</code>ã€‚æ‰€æœ‰è‡ªå®šä¹‰AIçš„ä»£ç éƒ½æ”¾åœ¨<code>ModProjectile.AI</code>æ–¹æ³•ä¸­ã€‚ä¹Ÿå°±æ˜¯é‡å†™AI()æ–¹æ³•</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyFirstProjectile</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.arrow = <span class="literal">true</span>;</span><br><span class="line">            Projectile.width = <span class="number">10</span>;</span><br><span class="line">            Projectile.height = <span class="number">10</span>;</span><br><span class="line">            Projectile.aiStyle = ProjAIStyleID.Arrow;</span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>;</span><br><span class="line">            Projectile.DamageType = DamageClass.Ranged;</span><br><span class="line">            AIType = ProjectileID.WoodenArrowFriendly;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Additional hooks/methods here.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡å†™æ­¤æ–¹æ³•ï¼Œè‡ªå®šä¹‰AI</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AI</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.AI();</span><br><span class="line">            <span class="comment">// Additional code here.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Timers">Timers</h3><ul><li>Timersï¼šè®¡æ—¶å™¨</li><li>è®¸å¤šå¼¹å¹•ä½¿ç”¨è®¡æ—¶å™¨æ¥å»¶è¿ŸåŠ¨ä½œã€‚é€šå¸¸æˆ‘ä»¬ä½¿ç”¨<code>Projectile.ai[0]</code>æˆ–<code>Projectile.ai[1]</code>ï¼Œå› ä¸ºè¿™äº›å€¼ä¼šè‡ªåŠ¨åŒæ­¥ï¼Œè¿™é‡Œæˆ‘ä»¬è®¡æ•°åˆ°30ï¼Œæ¢å¥è¯è¯´ï¼ŒåŠç§’ã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Projectile.ai[<span class="number">0</span>] += <span class="number">1f</span>;</span><br><span class="line"><span class="keyword">if</span> (Projectile.ai[<span class="number">0</span>] &gt;= <span class="number">30f</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// åŠç§’è¿‡å»äº†ã€‚é‡ç½®è®¡æ—¶å™¨ç­‰ã€‚</span></span><br><span class="line">    Projectile.ai[<span class="number">0</span>] = <span class="number">0f</span>;</span><br><span class="line">    Projectile.netUpdate = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// åœ¨è¿™é‡Œåšç‚¹ä»€ä¹ˆï¼Œä¹Ÿè®¸æ”¹å˜åˆ°æ–°çŠ¶æ€ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Gravity">Gravity</h3><ul><li>Gravityï¼šé‡åŠ›</li><li>å¼¹å¹•å®é™…ä¸Šæ²¡æœ‰é‡åŠ›ï¼Œæ¯ä¸ªå¸¦æœ‰é‡åŠ›ç§»åŠ¨çš„å¼¹å¹•å®é™…ä¸Šæ˜¯å®ƒä»¬çš„AIä»£ç å®ç°äº†é‡åŠ›ã€‚è¦å®ç°é‡åŠ›ï¼Œåªéœ€è¦åœ¨<code>Projectile.velovity.Y</code>ä¸­æ·»åŠ ä¸€ä¸ªå°å€¼ã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Projectile.velocity.Y = Projectile.velocity.Y + <span class="number">0.1f</span>; <span class="comment">// 0.1f æ˜¯ç®­çš„é‡åŠ›ï¼Œ0.4f æ˜¯é£åˆ€çš„é‡åŠ›</span></span><br><span class="line"><span class="keyword">if</span> (Projectile.velocity.Y &gt; <span class="number">16f</span>) <span class="comment">// è¿™ä¸ªæ£€æŸ¥å®ç°äº†â€œç»ˆç«¯é€Ÿåº¦â€ã€‚æˆ‘ä»¬ä¸å¸Œæœ›å¼¹å¹•è¶Šæ¥è¶Šå¿«ã€‚</span></span><br><span class="line">&#123;</span><br><span class="line">    Projectile.velocity.Y = <span class="number">16f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ ¹æ®ä¸Šè¿°çš„è®¡æ—¶å™¨å’Œé‡åŠ›çš„è®¾å®šï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å†™ä¸€ä¸ªå»¶è¿Ÿé‡åŠ›æ•ˆæœ</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Projectile.ai[<span class="number">0</span>] += <span class="number">1f</span>; <span class="comment">// ä½¿ç”¨è®¡æ—¶å™¨ç­‰å¾…15ä¸ªåˆ»åº¦åå†åº”ç”¨é‡åŠ›ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (Projectile.ai[<span class="number">0</span>] &gt;= <span class="number">15f</span>)</span><br><span class="line">&#123;</span><br><span class="line">    Projectile.ai[<span class="number">0</span>] = <span class="number">15f</span>;</span><br><span class="line">    Projectile.velocity.Y = Projectile.velocity.Y + <span class="number">0.1f</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (Projectile.velocity.Y &gt; <span class="number">16f</span>) <span class="comment">// ç»ˆç«¯é€Ÿåº¦æ£€æŸ¥ï¼Œè®¾ç½®å¼¹å¹•é€Ÿåº¦ä¸è¶…è¿‡16åƒç´ /å¸§ã€‚</span></span><br><span class="line">&#123;</span><br><span class="line">    Projectile.velocity.Y = <span class="number">16f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Wind-Resistance">Wind Resistance</h3><ul><li>Wind Resistanceï¼šé£é˜»</li><li>çºµå‘çš„åŠ é€Ÿåº¦æ˜¯é‡åŠ›æ§åˆ¶çš„ï¼Œé‚£ä¹ˆæ¨ªå‘çš„åŠ é€Ÿåº¦æ˜¯é£é˜»æ§åˆ¶çš„ã€‚</li><li>é€šè¿‡å‡å°‘<code>Projectile.velocity.X</code>çš„ä¹˜ç§¯ç³»æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾å®ç°é£é˜»ã€‚ç»“åˆè®¡æ—¶å™¨ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥è®©å¼¹å¹•è¶Šæ¥è¶Šæ…¢ï¼Œå®ç°ç±»ä¼¼èœœèœ‚æ‰‹é›·çš„æ•ˆæœã€‚ï¼ˆæ‰“è‚‰å±±çš„æ—¶å€™ï¼Œåœ¨å¹³å°æ‰”èœœèœ‚æ‰‹é›·ï¼Œä¸€å¼€å§‹é€Ÿåº¦è›®å¿«çš„ï¼Œä½†æ˜¯ä¼šè¶Šæ¥è¶Šæ…¢ï¼Œç›´è‡³çˆ†ç‚¸ï¼‰</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Projectile.ai[<span class="number">0</span>] += <span class="number">1f</span>;</span><br><span class="line"><span class="keyword">if</span> (Projectile.ai[<span class="number">0</span>] &gt;= <span class="number">15f</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„ç¤ºä¾‹æ²¡æœ‰åŠ ä¸Šé‡åŠ›ï¼Œæ— ä¼¤å¤§é›…</span></span><br><span class="line">    Projectile.velocity.X = Projectile.velocity.X * <span class="number">0.97f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Rotation">Rotation</h3><ul><li>Rotationï¼šæ—‹è½¬</li></ul><h4 id="æ’å®šæ—‹è½¬">æ’å®šæ—‹è½¬</h4><ul><li>æˆ‘ä»¬å¯ä»¥åœ¨AIä¸­æ·»åŠ <code>Projectile.rotation</code>ä½¿å…¶æƒ³å›æ—‹é•–ä¸€æ ·æ—‹è½¬ã€‚</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Projectile.rotation += <span class="number">0.4f</span> * Projectile.direction;</span><br></pre></td></tr></table></figure><h4 id="é¢å‘å‰æ–¹">é¢å‘å‰æ–¹</h4><h1>è‡ªå®šä¹‰åéª‘</h1>]]></content>
    
    
    <summary type="html">æŒç»­æ›´æ–°ä¸­ï¼Œå’•å’•å’•</summary>
    
    
    
    <category term="Modå¼€å‘" scheme="https://cyborg2077.github.io/categories/Mod%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Modå¼€å‘" scheme="https://cyborg2077.github.io/tags/Mod%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>æµ…è°ˆæ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜</title>
    <link href="https://cyborg2077.github.io/2024/02/25/OSVirtureMemory/"/>
    <id>https://cyborg2077.github.io/2024/02/25/OSVirtureMemory/</id>
    <published>2024-02-25T14:33:38.000Z</published>
    <updated>2024-02-25T15:00:32.000Z</updated>
    
    <content type="html"><![CDATA[<h1>ç®€ä»‹</h1><ul><li>è™šæ‹Ÿå†…å­˜æ˜¯è®¡ç®—æœºç³»ç»Ÿå†…å­˜ç®¡ç†çš„ä¸€ç§æŠ€æœ¯ã€‚å®ƒä½¿å¾—åº”ç”¨ç¨‹åºè®¤ä¸ºå®ƒæ‹¥æœ‰è¿ç»­çš„å¯ç”¨çš„å†…å­˜ï¼ˆä¸€ä¸ªè¿ç»­å®Œæ•´çš„åœ°å€ç©ºé—´ï¼‰ï¼Œè€Œå®é™…ä¸Šï¼Œå®ƒé€šå¸¸æ˜¯è¢«åˆ†éš”æˆå¤šä¸ªç‰©ç†å†…å­˜ç¢ç‰‡ï¼Œè¿˜æœ‰éƒ¨åˆ†æš‚æ—¶å­˜å‚¨åœ¨å¤–éƒ¨ç£ç›˜å­˜å‚¨å™¨ä¸Šï¼Œåœ¨éœ€è¦æ—¶è¿›è¡Œæ•°æ®äº¤æ¢ã€‚å¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½ä½¿ç”¨äº†è™šæ‹Ÿå†…å­˜ï¼Œå¦‚Windowså®¶æ—çš„â€œè™šæ‹Ÿå†…å­˜â€ï¼›Linuxçš„â€œäº¤æ¢ç©ºé—´â€ç­‰ã€‚</li></ul>]]></content>
    
    
    <summary type="html">æ–°éœ€æ±‚è¿˜æ²¡å‡ºæ¥ï¼Œåˆšå¥½å¯ä»¥ç³»ç»Ÿæ€§çš„å­¦ç‚¹ä¸œè¥¿ï¼Œæå‡ä¸€ä¸‹è‡ªå·±</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="OS" scheme="https://cyborg2077.github.io/tags/OS/"/>
    
  </entry>
  
  <entry>
    <title>å®ç°ä¸€ä¸ªCacheï¼ŒåŒ…æ‹¬LRUå’Œåœ¨Xç§’åè¿‡æœŸçš„é€»è¾‘</title>
    <link href="https://cyborg2077.github.io/2024/02/25/LRUCacheExpire/"/>
    <id>https://cyborg2077.github.io/2024/02/25/LRUCacheExpire/</id>
    <published>2024-02-25T06:56:38.000Z</published>
    <updated>2024-02-25T12:38:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1>LRUï¼ˆLeast Recently Usedï¼‰</h1><ul><li>æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œå®ƒçš„è®¾è®¡åŸåˆ™å€Ÿé‰´äº†<code>æ—¶é—´å±€éƒ¨æ€§åŸç†</code>ï¼Œè¯¥ç®—æ³•è®¤ä¸ºå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜ï¼Œåä¹‹äº¦ç„¶ã€‚å…¶åŸç†æ˜¯å°†æ•°æ®æŒ‰ç…§å…¶è¢«è®¿é—®çš„æ—¶é—´å½¢æˆä¸€ä¸ªæœ‰åºåºåˆ—ï¼Œæœ€ä¹…æœªè¢«ä½¿ç”¨çš„æ•°æ®åº”è¯¥æœ€æ—©è¢«æ·˜æ±°æ‰ï¼Œå³å½“ç¼“å­˜ç©ºé—´è¢«å æ»¡æ—¶ï¼Œç¼“å­˜å†…æœ€é•¿æ—¶é—´æœªè¢«ä½¿ç”¨çš„æ•°æ®å°†è¢«æ·˜æ±°æ‰ã€‚</li></ul><h1>å¤§è‡´æ€è·¯</h1><ul><li>å¯ä»¥ç®€å•çš„ç»´æŠ¤ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥å®ç°ï¼Œæ¯å½“æ•°æ®è¢«è®¿é—®æ—¶ï¼Œä½¿ç”¨å¤´æ’æ³•æ’å…¥åˆ°é˜Ÿé¦–ã€‚ç©ºé—´å æ»¡æ—¶ï¼Œå…ˆç§»é™¤æœ«å°¾å…ƒç´ ï¼Œéšåå¯¹æ–°å…ƒç´ ä½¿ç”¨å¤´æ’æ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        Node pre, next;</span><br><span class="line">        <span class="type">int</span> key, value;</span><br><span class="line">        Node(<span class="type">int</span> key, <span class="type">int</span> value) &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Node</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="type">Node</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    Map&lt;Integer, Node&gt; map;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æä¾›åˆå§‹åŒ–ç¼“å­˜çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LRUCache</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(size);</span><br><span class="line">        head.next = tail;</span><br><span class="line">        tail.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å‘½ä¸­ç¼“å­˜ï¼Œå°†å…¶ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            remove(node);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">            res = node.value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="comment">// å‘½ä¸­ç¼“å­˜ï¼Œä¿®æ”¹é”®å€¼ï¼Œå¹¶ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="comment">// 1. ä¿®æ”¹é”®å€¼</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            node.value = value;</span><br><span class="line">            <span class="comment">// ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">            remove(node);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœªå‘½ä¸­ç¼“å­˜ï¼Œåˆ¤æ–­ç¼“å­˜æ˜¯å¦å·²æ»¡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">mapSize</span> <span class="operator">=</span> map.size();</span><br><span class="line">            <span class="comment">// å·²æ»¡åˆ™ç§»é™¤é˜Ÿå°¾å…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> (mapSize == size) &#123;</span><br><span class="line">                map.remove(tail.pre.key);</span><br><span class="line">                remove(tail.pre);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ’å…¥æ–°å…ƒç´ </span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(key, value);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">            map.put(key, node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        node.pre.next = node.next;</span><br><span class="line">        node.next.pre = node.pre;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertToHead</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">firstNode</span> <span class="operator">=</span> head.next;</span><br><span class="line">        head.next = node;</span><br><span class="line">        firstNode.pre = node;</span><br><span class="line">        node.next = firstNode;</span><br><span class="line">        node.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åŸºæœ¬çš„ç¼“å­˜é€»è¾‘å†™å¥½äº†ï¼Œé‚£ä¹ˆå¦‚ä½•ç¼–å†™è¿‡æœŸé€»è¾‘å‘¢ï¼Ÿè¿™é‡Œé‡‡ç”¨çš„æ˜¯æƒ°æ€§åˆ é™¤ï¼Œå¦‚æœæŸ¥è¯¢è¯¥å…ƒç´ æ—¶ï¼Œå‘ç°è¯¥å…ƒç´ å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆç§»é™¤è¯¥å…ƒç´ ã€‚å½“æ’å…¥å…ƒç´ æ—¶ï¼Œéœ€è¦éå†æ‰€æœ‰çš„keyï¼Œç„¶ååˆ é™¤ï¼Œå½“ç„¶è¿™ä¸ªåˆ¤æ–­æ¡ä»¶ä¹Ÿå¯ä»¥æ˜¯å½“ç¼“å­˜æ»¡äº†çš„æ—¶å€™å†æ‰§è¡Œã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        Node pre, next;</span><br><span class="line">        <span class="type">int</span> key, value;</span><br><span class="line">        <span class="type">long</span> expireTime;</span><br><span class="line"></span><br><span class="line">        Node(<span class="type">int</span> key, <span class="type">int</span> value, <span class="type">long</span> expireTime) &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.expireTime = expireTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Node</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="type">Node</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    Map&lt;Integer, Node&gt; map;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æä¾›åˆå§‹åŒ–ç¼“å­˜çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LRUCache</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(size);</span><br><span class="line">        head.next = tail;</span><br><span class="line">        tail.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å‘½ä¸­ç¼“å­˜ï¼Œå°†å…¶ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            <span class="keyword">if</span> (node.expireTime &gt; System.currentTimeMillis()) &#123;</span><br><span class="line">                remove(node);</span><br><span class="line">                insertToHead(node);</span><br><span class="line">                res = node.value;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;å½“å‰èŠ‚ç‚¹è¿‡æœŸï¼š&quot;</span> + key);</span><br><span class="line">                remove(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value, <span class="type">long</span> expireTime)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ é™¤æ‰€æœ‰è¿‡æœŸçš„key</span></span><br><span class="line">        map.entrySet().removeIf(entry -&gt; &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> entry.getValue().expireTime &lt;= System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">if</span> (b) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ç§»é™¤keyï¼š&quot;</span> + entry.getValue().key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘½ä¸­ç¼“å­˜ï¼Œä¿®æ”¹é”®å€¼ï¼Œå¹¶ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="comment">// 1. ä¿®æ”¹é”®å€¼</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            node.value = value;</span><br><span class="line">            <span class="comment">// ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">            remove(node);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœªå‘½ä¸­ç¼“å­˜ï¼Œåˆ¤æ–­ç¼“å­˜æ˜¯å¦å·²æ»¡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">mapSize</span> <span class="operator">=</span> map.size();</span><br><span class="line">            <span class="comment">// å·²æ»¡åˆ™ç§»é™¤é˜Ÿå°¾å…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> (mapSize == size) &#123;</span><br><span class="line">                map.remove(tail.pre.key);</span><br><span class="line">                remove(tail.pre);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ’å…¥æ–°å…ƒç´ </span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(key, value, expireTime);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">            map.put(key, node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        node.pre.next = node.next;</span><br><span class="line">        node.next.pre = node.pre;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertToHead</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">firstNode</span> <span class="operator">=</span> head.next;</span><br><span class="line">        head.next = node;</span><br><span class="line">        firstNode.pre = node;</span><br><span class="line">        node.next = firstNode;</span><br><span class="line">        node.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸‹é¢ç®€å•å†™ä¸ªmainæ–¹æ³•éªŒè¯ä¸€ä¸‹ï¼ŒæŸ¥çœ‹æ—¥å¿—æ˜¯å¦ç¬¦åˆé¢„æœŸ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">LRUCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LRUCache</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¯·è¾“å…¥æ“ä½œï¼šget æˆ– put&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">operation</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;get&quot;</span>.equalsIgnoreCase(operation)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;è¯·è¾“å…¥è¦è·å–çš„é”®ï¼š&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> scanner.nextInt();</span><br><span class="line">                scanner.nextLine(); <span class="comment">// æ¸…é™¤ç¼“å†²åŒºä¸­çš„æ¢è¡Œç¬¦</span></span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line">                <span class="keyword">if</span> (value != -<span class="number">1</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;é”® &quot;</span> + key + <span class="string">&quot; å¯¹åº”çš„å€¼ä¸ºï¼š&quot;</span> + value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;é”® &quot;</span> + key + <span class="string">&quot; ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;put&quot;</span>.equalsIgnoreCase(operation)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;è¯·è¾“å…¥è¦æ”¾å…¥çš„é”®ï¼š&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> scanner.nextInt();</span><br><span class="line">                System.out.println(<span class="string">&quot;è¯·è¾“å…¥è¦æ”¾å…¥çš„å€¼ï¼š&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> scanner.nextInt();</span><br><span class="line">                System.out.println(<span class="string">&quot;è¯·è¾“å…¥è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼š&quot;</span>);</span><br><span class="line">                <span class="type">long</span> <span class="variable">expireTime</span> <span class="operator">=</span> scanner.nextLong();</span><br><span class="line">                scanner.nextLine();</span><br><span class="line"></span><br><span class="line">                cache.put(key, value, System.currentTimeMillis() + expireTime);</span><br><span class="line">                System.out.println(<span class="string">&quot;é”®å€¼å¯¹å·²æ”¾å…¥ç¼“å­˜&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ— æ•ˆçš„æ“ä½œï¼Œè¯·é‡æ–°è¾“å…¥&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ€è¿‘æœ‰äº›æ‡ˆæ€ äº†ï¼Œåˆ·åˆ·é¢˜ï¼Œè¿™ç§åº•å±‚å®ç°è¿˜æ˜¯æŒºæœ‰æ„æ€çš„</summary>
    
    
    
    <category term="è¸©å‘æ—¥è®°" scheme="https://cyborg2077.github.io/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Navicatåœ¨ç»“æ„åŒæ­¥æ—¶çš„æ³¨æ„äº‹é¡¹</title>
    <link href="https://cyborg2077.github.io/2024/02/07/NavicatSyncPit/"/>
    <id>https://cyborg2077.github.io/2024/02/07/NavicatSyncPit/</id>
    <published>2024-02-07T03:27:30.000Z</published>
    <updated>2024-02-24T05:54:32.000Z</updated>
    
    <content type="html"><![CDATA[<h1>æ¶‰åŠåˆ°åˆ—åä¿®æ”¹æ—¶ï¼Œä¸è¦ä½¿ç”¨Navicatç»“æ„åŒæ­¥å·¥å…·</h1><ul><li>æœ¬åœ°ç¯å¢ƒçš„è¡¨ç»“æ„å¦‚ä¸‹</li></ul><table><thead><tr><th>id</th><th>phone</th><th>invite_code</th></tr></thead><tbody><tr><td>1</td><td>123-456-789</td><td>ABC123</td></tr><tr><td>2</td><td>987-654-321</td><td>DEF456</td></tr><tr><td>3</td><td>555-555-555</td><td>GHI789</td></tr></tbody></table><ul><li>ç”Ÿäº§ç¯å¢ƒçš„è¡¨ç»“æ„å¦‚ä¸‹</li></ul><table><thead><tr><th>id</th><th>phone</th><th>user_id</th></tr></thead><tbody><tr><td>1</td><td>123-456-789</td><td>ABC123</td></tr><tr><td>2</td><td>987-654-321</td><td>DEF456</td></tr><tr><td>3</td><td>555-555-555</td><td>GHI789</td></tr></tbody></table><ul><li>è‹¥æ­¤æ—¶ä½¿ç”¨Navicatæä¾›çš„ç»“æ„åŒæ­¥å·¥å…·ï¼Œå®é™…ä¸Šæ‰§è¡Œçš„å‘½ä»¤ä¼šæ˜¯å°†åŸæœ‰çš„åˆ—åˆ é™¤ï¼Œç„¶åå†æ–°å¢ï¼Œä¼šå¯¼è‡´è¯¥åˆ—çš„å†…å®¹å®Œå…¨ä¸¢å¤±</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> `invite_code`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">DROP</span> INDEX `idx_invite_code`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> `user_id` <span class="type">varchar</span>(<span class="number">255</span>) AFTER `phone`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">ADD</span> INDEX `idx_invite_code`(`user_id` <span class="keyword">ASC</span>) <span class="keyword">USING</span> BTREE;</span><br></pre></td></tr></table></figure><ul><li>è‹¥ä»…ä¿®æ”¹å­—æ®µåï¼Œå»ºè®®ä½¿ç”¨RENAMEå‘½ä»¤</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> user_info </span><br><span class="line">RENAME <span class="keyword">COLUMN</span> invite_code <span class="keyword">TO</span> user_id</span><br></pre></td></tr></table></figure><ul><li>è‹¥è¿˜æ¶‰åŠåˆ°å­—æ®µå®šä¹‰ä¿®æ”¹ï¼Œå»ºè®®ä½¿ç”¨CHANGE COLUMNå‘½ä»¤</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> user_info</span><br><span class="line">CHANGE <span class="keyword">COLUMN</span> invite_code user_id <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">åœ¨ä¿®æ”¹å­—æ®µåæ—¶ï¼ŒNavicatæä¾›çš„SQLæ˜¯å…ˆåˆ é™¤è¿™åˆ—å†æ–°å¢</summary>
    
    
    
    <category term="è¸©å‘æ—¥è®°" scheme="https://cyborg2077.github.io/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>LangChainå…¥é—¨æŒ‡å—</title>
    <link href="https://cyborg2077.github.io/2024/01/26/LangChainPrimer/"/>
    <id>https://cyborg2077.github.io/2024/01/26/LangChainPrimer/</id>
    <published>2024-01-26T03:27:30.000Z</published>
    <updated>2024-02-24T05:54:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1>ä»€ä¹ˆæ˜¯LangChain</h1><ul><li>LangChainæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘äººå‘˜ä½¿ç”¨è¯­è¨€æ¨¡å‹æ„å»ºç«¯åˆ°ç«¯çš„åº”ç”¨ç¨‹åºã€‚å®ƒæä¾›äº†ä¸€å¥—å·¥å…·ã€ç»„ä»¶å’Œæ¥å£ï¼Œå¯ç®€åŒ–åˆ›å»ºç”±å¤§å‹è¯­è¨€æ¨¡å‹ (LLM) å’ŒèŠå¤©æ¨¡å‹æä¾›æ”¯æŒçš„åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ã€‚LangChain å¯ä»¥è½»æ¾ç®¡ç†ä¸è¯­è¨€æ¨¡å‹çš„äº¤äº’ï¼Œå°†å¤šä¸ªç»„ä»¶é“¾æ¥åœ¨ä¸€èµ·ï¼Œå¹¶é›†æˆé¢å¤–çš„èµ„æºï¼Œä¾‹å¦‚ API å’Œæ•°æ®åº“ã€‚</li><li>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://python.langchain.com/en/latest/">https://python.langchain.com/en/latest/</a></li></ul><h1>å¦‚ä½•ä½¿ç”¨LangChain</h1><ul><li>è¦ä½¿ç”¨ LangChainï¼Œå¼€å‘äººå‘˜é¦–å…ˆè¦å¯¼å…¥å¿…è¦çš„ç»„ä»¶å’Œå·¥å…·ï¼Œä¾‹å¦‚ LLMs, chat models, agents, chains, å†…å­˜åŠŸèƒ½ã€‚è¿™äº›ç»„ä»¶ç»„åˆèµ·æ¥åˆ›å»ºä¸€ä¸ªå¯ä»¥ç†è§£ã€å¤„ç†å’Œå“åº”ç”¨æˆ·è¾“å…¥çš„åº”ç”¨ç¨‹åºã€‚</li><li>LangChain ä¸ºç‰¹å®šç”¨ä¾‹æä¾›äº†å¤šç§ç»„ä»¶ï¼Œä¾‹å¦‚ä¸ªäººåŠ©ç†ã€æ–‡æ¡£é—®ç­”ã€èŠå¤©æœºå™¨äººã€æŸ¥è¯¢è¡¨æ ¼æ•°æ®ã€ä¸ API äº¤äº’ã€æå–ã€è¯„ä¼°å’Œæ±‡æ€»ã€‚</li></ul><h1>LangChainçš„æ¨¡å‹</h1><ul><li>LangChain model æ˜¯ä¸€ç§æŠ½è±¡ï¼Œè¡¨ç¤ºæ¡†æ¶ä¸­ä½¿ç”¨çš„ä¸åŒç±»å‹çš„æ¨¡å‹ã€‚LangChain ä¸­çš„æ¨¡å‹ä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š<ol><li>LLMï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼‰ï¼šè¿™äº›æ¨¡å‹å°†æ–‡æœ¬å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥å¹¶è¿”å›æ–‡æœ¬å­—ç¬¦ä¸²ä½œä¸ºè¾“å‡ºã€‚å®ƒä»¬æ˜¯è®¸å¤šè¯­è¨€æ¨¡å‹åº”ç”¨ç¨‹åºçš„æ”¯æŸ±ã€‚</li><li>èŠå¤©æ¨¡å‹( Chat Model)ï¼šèŠå¤©æ¨¡å‹ç”±è¯­è¨€æ¨¡å‹æ”¯æŒï¼Œä½†å…·æœ‰æ›´ç»“æ„åŒ–çš„ APIã€‚ä»–ä»¬å°†èŠå¤©æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºè¾“å…¥å¹¶è¿”å›èŠå¤©æ¶ˆæ¯ã€‚è¿™ä½¿å¾—ç®¡ç†å¯¹è¯å†å²è®°å½•å’Œç»´æŠ¤ä¸Šä¸‹æ–‡å˜å¾—å®¹æ˜“ã€‚</li><li>æ–‡æœ¬åµŒå…¥æ¨¡å‹(Text Embedding Models)ï¼šè¿™äº›æ¨¡å‹å°†æ–‡æœ¬ä½œä¸ºè¾“å…¥å¹¶è¿”å›è¡¨ç¤ºæ–‡æœ¬åµŒå…¥çš„æµ®ç‚¹åˆ—è¡¨ã€‚è¿™äº›åµŒå…¥å¯ç”¨äºæ–‡æ¡£æ£€ç´¢ã€èšç±»å’Œç›¸ä¼¼æ€§æ¯”è¾ƒç­‰ä»»åŠ¡ã€‚</li></ol></li></ul><h1>LangChain çš„ä¸»è¦ç‰¹ç‚¹</h1><ul><li>LangChain æ—¨åœ¨ä¸ºå…­ä¸ªä¸»è¦é¢†åŸŸçš„å¼€å‘äººå‘˜æä¾›æ”¯æŒï¼š<ol><li>LLM å’Œæç¤ºï¼šLangChain ä½¿ç®¡ç†æç¤ºã€ä¼˜åŒ–å®ƒä»¬ä»¥åŠä¸ºæ‰€æœ‰ LLM åˆ›å»ºé€šç”¨ç•Œé¢å˜å¾—å®¹æ˜“ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜åŒ…æ‹¬ä¸€äº›ç”¨äºå¤„ç† LLM çš„ä¾¿æ·å®ç”¨ç¨‹åºã€‚</li><li>é“¾(Chain)ï¼šè¿™äº›æ˜¯å¯¹ LLM æˆ–å…¶ä»–å®ç”¨ç¨‹åºçš„è°ƒç”¨åºåˆ—ã€‚LangChain ä¸ºé“¾æä¾›æ ‡å‡†æ¥å£ï¼Œä¸å„ç§å·¥å…·é›†æˆï¼Œä¸ºæµè¡Œåº”ç”¨æä¾›ç«¯åˆ°ç«¯çš„é“¾ã€‚</li><li>æ•°æ®å¢å¼ºç”Ÿæˆï¼šLangChain ä½¿é“¾èƒ½å¤Ÿä¸å¤–éƒ¨æ•°æ®æºäº¤äº’ä»¥æ”¶é›†ç”Ÿæˆæ­¥éª¤çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥å¸®åŠ©æ€»ç»“é•¿æ–‡æœ¬æˆ–ä½¿ç”¨ç‰¹å®šæ•°æ®æºå›ç­”é—®é¢˜ã€‚</li><li>Agentsï¼šAgents è®© LLM åšå‡ºæœ‰å…³è¡ŒåŠ¨çš„å†³å®šï¼Œé‡‡å–è¿™äº›è¡ŒåŠ¨ï¼Œæ£€æŸ¥ç»“æœï¼Œå¹¶ç»§ç»­å‰è¿›ç›´åˆ°å·¥ä½œå®Œæˆã€‚LangChain æä¾›äº†ä»£ç†çš„æ ‡å‡†æ¥å£ï¼Œå¤šç§ä»£ç†å¯ä¾›é€‰æ‹©ï¼Œä»¥åŠç«¯åˆ°ç«¯çš„ä»£ç†ç¤ºä¾‹ã€‚</li><li>å†…å­˜ï¼šLangChain æœ‰ä¸€ä¸ªæ ‡å‡†çš„å†…å­˜æ¥å£ï¼Œæœ‰åŠ©äºç»´æŠ¤é“¾æˆ–ä»£ç†è°ƒç”¨ä¹‹é—´çš„çŠ¶æ€ã€‚å®ƒè¿˜æä¾›äº†ä¸€ç³»åˆ—å†…å­˜å®ç°å’Œä½¿ç”¨å†…å­˜çš„é“¾æˆ–ä»£ç†çš„ç¤ºä¾‹ã€‚</li><li>è¯„ä¼°ï¼šå¾ˆéš¾ç”¨ä¼ ç»ŸæŒ‡æ ‡è¯„ä¼°ç”Ÿæˆæ¨¡å‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ LangChain æä¾›æç¤ºå’Œé“¾æ¥å¸®åŠ©å¼€å‘è€…è‡ªå·±ä½¿ç”¨ LLM è¯„ä¼°ä»–ä»¬çš„æ¨¡å‹ã€‚</li></ol></li></ul><h1>ä½¿ç”¨ç¤ºä¾‹</h1><h2 id="æç¤ºæ¨¡æ¿ï¼ˆPromptTemplateï¼‰">æç¤ºæ¨¡æ¿ï¼ˆPromptTemplateï¼‰</h2><ol><li>æ”¯æŒæˆ‘ä»¬æ¥è‡ªå®šä¹‰æç¤ºæ¨¡æ¿ï¼Œä¸ä¼šå°†ç”¨æˆ·è¾“å…¥ç›´æ¥å‘é€åˆ° LLMï¼Œè€Œæ˜¯æ¥æ”¶ç”¨æˆ·çš„è¾“å…¥ï¼Œç„¶åæ„é€ ä¸€ä¸ªpromptå°†å…¶å‘é€ç»™ LLMã€‚</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts import PromptTemplate</span><br><span class="line"></span><br><span class="line">prompt = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;paperTitle&quot;</span>, <span class="string">&quot;area&quot;</span>, <span class="string">&quot;nums&quot;</span>, <span class="string">&quot;keywords&quot;</span>],</span><br><span class="line">    <span class="attribute">template</span>=<span class="string">&quot;æˆ‘æƒ³è®©ä½ å……å½“&#123;area&#125;é¢†åŸŸçš„ä¸“å®¶ï¼Œé’ˆå¯¹äº&#123;paperTitle&#125;è¿™ä¸ªä¸»é¢˜ï¼Œå¸®æˆ‘æ’°å†™ä¸€ç¯‡&#123;nums&#125;å­—çš„æ–‡çŒ®ç»¼è¿°ã€‚åŒ…å«çš„å…³é”®å­—å¦‚ä¸‹ï¼š&#123;keywords&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(prompt.format(<span class="attribute">paperTitle</span>=<span class="string">&quot;å¤§å­¦ç”Ÿç½‘çº¢äº§å“æ¶ˆè´¹è¡Œä¸ºç ”ç©¶&quot;</span>, <span class="attribute">area</span>=<span class="string">&quot;ç»æµå­¦&quot;</span>, <span class="attribute">nums</span>=500, <span class="attribute">keywords</span>=<span class="string">&quot;å¤§å­¦ç”Ÿã€ç½‘çº¢ã€æ¶ˆè´¹ã€è¡Œä¸ºç ”ç©¶&quot;</span>))</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šæˆ‘æƒ³è®©ä½ å……å½“ç»æµå­¦é¢†åŸŸçš„ä¸“å®¶ï¼Œé’ˆå¯¹äºå¤§å­¦ç”Ÿç½‘çº¢äº§å“æ¶ˆè´¹è¡Œä¸ºç ”ç©¶è¿™ä¸ªä¸»é¢˜ï¼Œå¸®æˆ‘æ’°å†™ä¸€ç¯‡500å­—çš„æ–‡çŒ®ç»¼è¿°ã€‚åŒ…å«çš„å…³é”®å­—å¦‚ä¸‹ï¼šå¤§å­¦ç”Ÿã€ç½‘çº¢ã€æ¶ˆè´¹ã€è¡Œä¸ºç ”ç©¶</span></span><br></pre></td></tr></table></figure><h2 id="LLM-Chain">LLM Chain</h2><ul><li>æˆ‘ä»¬å¯ä»¥æŠŠåˆå§‹åŒ–å¥½çš„LLMå’ŒTemplateï¼Œç»„åˆæˆä¸€ä¸ªchain</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. åˆå§‹åŒ–llm</span></span><br><span class="line">llm = ChatOpenAI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œå…¶å®å°±å¯ä»¥ç›´æ¥è°ƒç”¨llmäº†</span></span><br><span class="line">llm.invoke(<span class="string">&quot;how can langsmith help with testing?&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. è¿™é‡Œå¯ä»¥åˆå§‹åŒ–ä¸€ä¸ªæ¨¡æ¿</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line">prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;ä½ æ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„ç§‘å¹»å°è¯´ä½œè€…&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. é‡‡ç”¨è¿™ç§æ–¹å¼å¯ä»¥å°†llmå’Œtemplateç»„åˆæˆä¸€ä¸ªchain</span></span><br><span class="line">chain = prompt | llm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. è°ƒç”¨ç»„åˆåçš„chain</span></span><br><span class="line">chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;ä½ å¯¹LangSmithäº†è§£å—ï¼Ÿ&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><h2 id="Retrieval-Chainï¼ˆåŸºäºæ£€ç´¢çš„chainï¼‰">Retrieval Chainï¼ˆåŸºäºæ£€ç´¢çš„chainï¼‰</h2><ul><li>å½“ä½ éœ€è¦è®©LLMå›ç­”ä¸€ä¸ªé—®é¢˜æ—¶ï¼ˆæ¯”å¦‚ â€œhow can langsmith help with testing?â€ï¼‰ï¼Œæœ‰æ—¶å€™ä½ è¦æä¾›çš„æç¤ºä¿¡æ¯å¯èƒ½å¤ªå¤šï¼Œç›´æ¥ä¼ é€’ç»™è¯­è¨€æ¨¡å‹å¯èƒ½ä¸å¤Ÿæœ‰æ•ˆã€‚ä¸ºäº†æä¾›æ›´å¤šä¸Šä¸‹æ–‡ï¼ŒLangChainæä¾›äº†é€šè¿‡æ£€ç´¢ï¼ˆretrievalï¼‰çš„æ–¹å¼è·å–ç›¸å…³çš„æ–‡æ¡£ï¼Œå¹¶å°†è¿™äº›æ–‡æ¡£ä¼ é€’ç»™è¯­è¨€æ¨¡å‹ã€‚</li><li>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ£€ç´¢å™¨ï¼ˆRetrieverï¼‰æ¥æŸ¥æ‰¾ç›¸å…³çš„æ–‡æ¡£ï¼Œç„¶åå°†è¿™äº›æ–‡æ¡£ä¼ é€’ç»™æç¤ºæ¨¡æ¿ã€‚æ£€ç´¢å™¨å¯ä»¥ç”±å„ç§æ•°æ®æ”¯æŒï¼Œæ¯”å¦‚ä¸€ä¸ª SQL è¡¨ã€äº’è”ç½‘ä¸Šçš„æ•°æ®ç­‰ï¼Œä½†åœ¨å®˜ç½‘çš„Demoé‡Œï¼Œå°†ä½¿ç”¨ä¸€ä¸ªå‘é‡å­˜å‚¨ï¼ˆvector storeï¼‰æ¥ä½œä¸ºæ£€ç´¢å™¨ã€‚</li><li>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åŠ è½½è¦ç´¢å¼•çš„æ•°æ®ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ WebBaseLoaderï¼ˆè¿™ä¸ªåº”è¯¥æ˜¯LangChainå†…éƒ¨å®ç°çš„ä¸€ä¸ªçˆ¬è™«å·¥å…·ï¼Œè¦ä¾èµ–äºBeautifulSoup<br>pip install beautifulsoup4</li><li>å¼•å…¥WebBaseLocderæ¥çˆ¬å–å†…å®¹</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> WebBaseLoader</span><br><span class="line"></span><br><span class="line">loader = WebBaseLoader(<span class="string">&quot;https://docs.smith.langchain.com/overview&quot;</span>)</span><br><span class="line">docs = loader.load()</span><br><span class="line"><span class="built_in">print</span>(docs)</span><br><span class="line"><span class="comment"># [Document(page_content=&#x27;\n\n\n\n\nLangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith\n\n\n\n\n\nSkip to main contentğŸ¦œï¸ğŸ› ï¸ LangSmith DocsPython DocsJS/TS DocsSearchGo to AppLangSmithOverviewTracingTesting &amp; EvaluationOrganizationsHubLangSmith CookbookOverviewOn this pageLangSmith Overview and User GuideBuilding reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.Over the past two months, we at LangChain have been building and using LangSmith with the goal of bridging this gap. This is our tactical user guide to outline effective ways to use LangSmith and maximize its benefits.On by default\u200bAt LangChain, all of us have LangSmithâ€™s tracing running in the background by default. On the Python side, this is achieved by setting environment variables, which we establish whenever we launch a virtual environment or open our bash shell and leave them set. The same principle applies to most JavaScript environments through process.env1.The benefit here is that all calls to LLMs, chains, agents, tools, and retrievers are logged to LangSmith. Around 90% of the time we donâ€™t even look at the traces, but the 10% of the time that we doâ€¦ itâ€™s so helpful. We can use LangSmith to debug:An unexpected end resultWhy an agent is loopingWhy a chain was slower than expectedHow many tokens an agent usedDebugging\u200bDebugging LLMs, chains, and agents can be tough. LangSmith helps solve the following pain points:What was the exact input to the LLM?\u200bLLM calls are often tricky and non-deterministic. The inputs/outputs may seem straightforward, given they are technically string â†’ string (or chat messages â†’ chat message), but this can be misleading as the input string is usually constructed from a combination of user input and auxiliary functions.Most inputs to an LLM call are a combination of some type of fixed template along with input variables. These input variables could come directly from user input or from an auxiliary function (like retrieval). By the time these input variables go into the LLM they will have been converted to a string format, but often times they are not naturally represented as a string (they could be a list, or a Document object). Therefore, it is important to have visibility into what exactly the final string going into the LLM is. This has helped us debug bugs in formatting logic, unexpected transformations to user input, and straight up missing user input.To a much lesser extent, this is also true of the output of an LLM. Oftentimes the output of an LLM is technically a string but that string may contain some structure (json, yaml) that is intended to be parsed into a structured representation. Understanding what the exact output is can help determine if there may be a need for different parsing.LangSmith provides a straightforward visualization of the exact inputs/outputs to all LLM calls, so you can easily understand them.If I edit the prompt, how does that affect the output?\u200bSo you notice a bad output, and you go into LangSmith to see what\&#x27;s going on. You find the faulty LLM call and are now looking at the exact input. You want to try changing a word or a phrase to see what happens -- what do you do?We constantly ran into this issue. Initially, we copied the prompt to a playground of sorts. But this got annoying, so we built a playground of our own! When examining an LLM call, you can click the Open in Playground button to access this playground. Here, you can modify the prompt and re-run it to observe the resulting changes to the output - as many times as needed!Currently, this feature supports only OpenAI and Anthropic models and works for LLM and Chat Model calls. We plan to extend its functionality to more LLM types, chains, agents, and retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith\&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we\&#x27;ve added a â€œShareâ€ button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it\&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, itâ€™s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you\&#x27;re wandering blind. You donâ€™t have any examples to benchmark your changes against.LangSmith addresses this problem by including an â€œAdd to Datasetâ€ button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different\ninputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat weâ€™ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If weâ€™re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.\nYou can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.Weâ€™ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing â€” mirroring the debug mode approach.Weâ€™ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We\&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these arenâ€™t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.â†©PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright Â© 2024 LangChain, Inc.\n\n\n\n&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)]</span></span><br><span class="line"><span class="comment"># è¿™é‡Œè¾“å‡ºçš„docså°±æ˜¯ç½‘é¡µä¸Šçš„å†…å®¹</span></span><br></pre></td></tr></table></figure><ul><li>ç„¶åæˆ‘ä»¬éœ€è¦å°†è¿™äº›æ–‡æ¡£ç´¢å¼•åˆ°ä¸€ä¸ªå‘é‡å­˜å‚¨ä¸­ã€‚è¿™éœ€è¦ä¸€äº›ç»„ä»¶ï¼ŒåŒ…æ‹¬åµŒå…¥æ¨¡å‹ï¼ˆembedding modelï¼‰å’Œå‘é‡å­˜å‚¨ã€‚<ol><li>æ£€ç´¢å™¨ï¼ˆRetrieverï¼‰ï¼š æƒ³è±¡ä¸€ä¸‹ä½ åœ¨å›¾ä¹¦é¦†æ‰¾ä¹¦çš„æ—¶å€™ï¼Œä½ å¯èƒ½ä¸ä¼šæŠŠæ•´ä¸ªå›¾ä¹¦é¦†çš„ä¹¦éƒ½æ‹¿å»çœ‹ã€‚ç›¸åï¼Œä½ å¯èƒ½ä¼šå’¨è¯¢å›¾ä¹¦ç®¡ç†å‘˜æˆ–è€…æŸ¥æ‰¾å›¾ä¹¦é¦†çš„ç›®å½•ï¼Œæ‰¾åˆ°ä¸ä½ é—®é¢˜ç›¸å…³çš„ä¹¦ç±ã€‚åœ¨è¿™é‡Œï¼Œæ£€ç´¢å™¨å°±åƒå›¾ä¹¦é¦†çš„ç›®å½•ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°ä¸é—®é¢˜ç›¸å…³çš„ä¿¡æ¯ã€‚</li><li>å‘é‡å­˜å‚¨ï¼ˆVector Storeï¼‰ï¼š è¿™å°±åƒä¸€ä¸ªå¤§ä»“åº“ï¼Œé‡Œé¢å­˜æ”¾ç€å„ç§å„æ ·çš„ä¿¡æ¯ã€‚æ¯ä¸ªä¿¡æ¯éƒ½ç”¨ä¸€ä¸ªå‘é‡è¡¨ç¤ºï¼Œå°±åƒæ˜¯ä»“åº“ä¸­çš„ä¸€ä¸ªç®±å­ã€‚é€šè¿‡è¿™äº›å‘é‡ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ‰¾åˆ°å­˜å‚¨åº“ä¸­ä¸æˆ‘ä»¬å…³å¿ƒçš„ä¸»é¢˜ç›¸å…³çš„ä¿¡æ¯ã€‚</li><li>åµŒå…¥æ¨¡å‹ï¼ˆEmbedding Modelï¼‰ï¼š è¿™å°±åƒæ˜¯ä¸€ä¸ªç¿»è¯‘å·¥äººï¼Œå®ƒå°†æ–‡æ¡£ä¸­çš„æ–‡å­—ç¿»è¯‘æˆè®¡ç®—æœºèƒ½å¤Ÿç†è§£çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯å‘é‡ã€‚è¿™æ ·ï¼Œè®¡ç®—æœºå°±èƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†å’Œæ¯”è¾ƒæ–‡æ¡£ï¼Œæ‰¾åˆ°æœ€ç›¸å…³çš„ä¿¡æ¯ã€‚</li></ol></li></ul><h2 id="æ ¹æ®æ–‡æ¡£æ„å»ºå‘é‡">æ ¹æ®æ–‡æ¡£æ„å»ºå‘é‡</h2><ol><li>ä½¿ç”¨ OpenAIEmbeddings åˆå§‹åŒ–ä¸€ä¸ªåµŒå…¥æ¨¡å‹ï¼Œç”¨äºå°†æ–‡æ¡£è½¬åŒ–ä¸ºå‘é‡ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"></span><br><span class="line">embeddings = OpenAIEmbeddings()</span><br></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æœ¬åœ°å‘é‡å­˜å‚¨ FAISS æ¥å»ºç«‹ç´¢å¼•.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install faiss-cpu</span><br></pre></td></tr></table></figure><ol start="3"><li>æ„å»ºå‘é‡å­˜å‚¨</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡æœ¬åˆ†å‰²å™¨</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter()</span><br><span class="line"><span class="comment"># å°†åˆšåˆšè·å–çš„docsåˆ†å‰²ï¼Œè¾“å‡ºæ˜¯ä¸€ä¸ªList&lt;String&gt;çš„ç±»å‹</span></span><br><span class="line">documents = text_splitter.split_documents(docs)</span><br><span class="line"><span class="comment"># æ ¹æ®åµŒå…¥æ¨¡å‹å’Œåˆ†å‰²åçš„æ–‡æ¡£ï¼Œè½¬æ¢ä¸ºå‘é‡</span></span><br><span class="line">vector = FAISS.from_documents(documents, embeddings)</span><br></pre></td></tr></table></figure><h2 id="æ„å»ºé“¾">æ„å»ºé“¾</h2><ol><li>æ„å»ºä¸€ä¸ªé“¾ï¼Œè¯¥é“¾æ¥å—é—®é¢˜å’Œæ£€ç´¢åˆ°çš„æ–‡æ¡£ï¼Œç”Ÿæˆç­”æ¡ˆï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.combine_documents <span class="keyword">import</span> create_stuff_documents_chain</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;Answer the following question based only on the provided context:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;context&gt;</span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string">&lt;/context&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Question: &#123;input&#125;&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">document_chain = create_stuff_documents_chain(llm, prompt)</span><br></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨æ£€ç´¢å™¨åŠ¨æ€é€‰æ‹©æœ€ç›¸å…³çš„æ–‡æ¡£å¹¶ä¼ é€’ç»™é“¾ï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_retrieval_chain</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œçš„vectoræ˜¯æˆ‘ä»¬ç¬¬ä¸€æ­¥æ„å»ºçš„å‘é‡ï¼Œå°†å…¶è½¬æ¢ä¸ºæ£€ç´¢å™¨</span></span><br><span class="line">retriever = vector.as_retriever()</span><br><span class="line">retrieval_chain = create_retrieval_chain(retriever, document_chain)</span><br></pre></td></tr></table></figure><ol start="3"><li>è°ƒç”¨è¿™ä¸ªé“¾ï¼Œæ¥è·å–å“åº”ç»“æœï¼Œè¿™ä¸ªç­”æ¡ˆåº”è¯¥æ›´åŠ å‡†ç¡®ï¼Œå› ä¸ºå®ƒç»“åˆäº†æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£å’ŒåŸå§‹é—®é¢˜ã€‚è¿™æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸ºäº†ä½¿å¾—è¯­è¨€æ¨¡å‹åœ¨å›ç­”é—®é¢˜æ—¶èƒ½å¤ŸåŸºäºæ›´å…¨é¢çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = retrieval_chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;how can langsmith help with testing?&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><h2 id="å®Œæ•´demo">å®Œæ•´demo</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_retrieval_chain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.combine_documents <span class="keyword">import</span> create_stuff_documents_chain</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> WebBaseLoader</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.ollama <span class="keyword">import</span> Ollama</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores.faiss <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> OllamaEmbeddings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">llm = Ollama(model=<span class="string">&quot;llama2&quot;</span>)</span><br><span class="line"><span class="comment"># åˆå§‹åŒ–åµŒå…¥æ¨¡å‹</span></span><br><span class="line"></span><br><span class="line">embeddings = OllamaEmbeddings()</span><br><span class="line"></span><br><span class="line"><span class="comment"># çˆ¬å–å†…å®¹</span></span><br><span class="line">loader = WebBaseLoader(<span class="string">&quot;https://docs.smith.langchain.com/overview&quot;</span>)</span><br><span class="line">docs = loader.load()</span><br><span class="line"><span class="built_in">print</span>(docs)</span><br><span class="line"><span class="comment"># æ–‡æœ¬åˆ†å‰²å™¨</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter()</span><br><span class="line"><span class="comment"># å°†åˆšåˆšè·å–çš„docsåˆ†å‰²</span></span><br><span class="line">documents = text_splitter.split_documents(docs)</span><br><span class="line"><span class="built_in">print</span>(documents)</span><br><span class="line"><span class="comment"># æ ¹æ®åµŒå…¥æ¨¡å‹å’Œåˆ†å‰²åçš„æ–‡æ¡£ï¼Œè½¬æ¢ä¸ºå‘é‡</span></span><br><span class="line">vector = FAISS.from_documents(documents, embeddings)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è½¬æ¢æˆå‘é‡å®Œæ¯•&quot;</span>)</span><br><span class="line"><span class="comment"># å°†å‘é‡è½¬æ¢ä¸ºæ£€ç´¢å™¨</span></span><br><span class="line">retriever = vector.as_retriever()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å°†å‘é‡è½¬æ¢ä¸ºæ£€ç´¢å™¨&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºé—®é¢˜é“¾</span></span><br><span class="line">prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;Answer the following question based only on the provided context:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;context&gt;</span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string">&lt;/context&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Question: &#123;input&#125;&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">document_chain = create_stuff_documents_chain(llm, prompt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ„å»ºé—®é¢˜å®Œæ¯•&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æ£€ç´¢å™¨åŠ¨æ€é€‰æ‹©æœ€ç›¸å…³çš„æ–‡æ¡£å¹¶ä¼ é€’ç»™é“¾ï¼š</span></span><br><span class="line">retrieval_chain = create_retrieval_chain(retriever, document_chain)</span><br><span class="line"><span class="comment"># æœ€ç»ˆè°ƒç”¨</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å¼€å§‹è°ƒç”¨&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = retrieval_chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;how can langsmith help with testing?&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è°ƒç”¨å®Œæ¯•&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡ºå¦‚ä¸‹</li></ul><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Document(page_content=<span class="comment">&#x27;\n\n\n\n\nLangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith\n\n\n\n\n\nSkip to main contentğŸ¦œï¸ğŸ› ï¸ LangSmith DocsPython DocsJS/TS DocsSearchGo to AppLangSmithOverviewTracingTesting &amp; EvaluationOrganizationsHubLangSmith CookbookOverviewOn this pageLangSmith Overview and User GuideBuilding reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.Over the past two months, we at LangChain have been building and using LangSmith with the goal of bridging this gap. This is our tactical user guide to outline effective ways to use LangSmith and maximize its benefits.On by default\u200bAt LangChain, all of us have LangSmithâ€™s tracing running in the background by default. On the Python side, this is achieved by setting environment variables, which we establish whenever we launch a virtual environment or open our bash shell and leave them set. The same principle applies to most JavaScript environments through process.env1.The benefit here is that all calls to LLMs, chains, agents, tools, and retrievers are logged to LangSmith. Around 90% of the time we donâ€™t even look at the traces, but the 10% of the time that we doâ€¦ itâ€™s so helpful. We can use LangSmith to de<span class="doctag">bug:</span>An unexpected end resultWhy an agent is loopingWhy a chain was slower than expectedHow many tokens an agent usedDebugging\u200bDebugging LLMs, chains, and agents can be tough. LangSmith helps solve the following pain points:What was the exact input to the LLM?\u200bLLM calls are often tricky and non-deterministic. The inputs/outputs may seem straightforward, given they are technically string â†’ string (or chat messages â†’ chat message), but this can be misleading as the input string is usually constructed from a combination of user input and auxiliary functions.Most inputs to an LLM call are a combination of some type of fixed template along with input variables. These input variables could come directly from user input or from an auxiliary function (like retrieval). By the time these input variables go into the LLM they will have been converted to a string format, but often times they are not naturally represented as a string (they could be a list, or a Document object). Therefore, it is important to have visibility into what exactly the final string going into the LLM is. This has helped us debug bugs in formatting logic, unexpected transformations to user input, and straight up missing user input.To a much lesser extent, this is also true of the output of an LLM. Oftentimes the output of an LLM is technically a string but that string may contain some structure (json, yaml) that is intended to be parsed into a structured representation. Understanding what the exact output is can help determine if there may be a need for different parsing.LangSmith provides a straightforward visualization of the exact inputs/outputs to all LLM calls, so you can easily understand them.If I edit the prompt, how does that affect the output?\u200bSo you notice a bad output, and you go into LangSmith to see what\&#x27;s going on. You find the faulty LLM call and are now looking at the exact input. You want to try changing a word or a phrase to see what happens -- what do you do?We constantly ran into this issue. Initially, we copied the prompt to a playground of sorts. But this got annoying, so we built a playground of our own! When examining an LLM call, you can click the Open in Playground button to access this playground. Here, you can modify the prompt and re-run it to observe the resulting changes to the output - as many times as needed!Currently, this feature supports only OpenAI and Anthropic models and works for LLM and Chat Model calls. We plan to extend its functionality to more LLM types, chains, agents, and retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith\&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we\&#x27;ve added a â€œShareâ€ button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it\&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, itâ€™s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you\&#x27;re wandering blind. You donâ€™t have any examples to benchmark your changes against.LangSmith addresses this problem by including an â€œAdd to Datasetâ€ button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different\ninputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat weâ€™ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If weâ€™re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.\nYou can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.Weâ€™ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing â€” mirroring the debug mode approach.Weâ€™ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We\&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these arenâ€™t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.â†©PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright Â© 2024 LangChain, Inc.\n\n\n\n&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)]</span></span><br><span class="line">[Document(page_content=<span class="comment">&#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;Skip to main contentğŸ¦œï¸ğŸ› ï¸ LangSmith DocsPython DocsJS/TS DocsSearchGo to AppLangSmithOverviewTracingTesting &amp; EvaluationOrganizationsHubLangSmith CookbookOverviewOn this pageLangSmith Overview and User GuideBuilding reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.Over the past two months, we at LangChain have been building and using LangSmith with the goal of bridging this gap. This is our tactical user guide to outline effective ways to use LangSmith and maximize its benefits.On by default\u200bAt LangChain, all of us have LangSmithâ€™s tracing running in the background by default. On the Python side, this is achieved by setting environment variables, which we establish whenever we launch a virtual environment or open our bash shell and leave them set. The same principle applies to most JavaScript environments through process.env1.The benefit here is that all calls to LLMs, chains, agents, tools, and retrievers are logged to LangSmith. Around 90% of the time we donâ€™t even look at the traces, but the 10% of the time that we doâ€¦ itâ€™s so helpful. We can use LangSmith to de<span class="doctag">bug:</span>An unexpected end resultWhy an agent is loopingWhy a chain was slower than expectedHow many tokens an agent usedDebugging\u200bDebugging LLMs, chains, and agents can be tough. LangSmith helps solve the following pain points:What was the exact input to the LLM?\u200bLLM calls are often tricky and non-deterministic. The inputs/outputs may seem straightforward, given they are technically string â†’ string (or chat messages â†’ chat message), but this can be misleading as the input string is usually constructed from a combination of user input and auxiliary functions.Most inputs to an LLM call are a combination of some type of fixed template along with input variables. These input variables could come directly from user input or from an auxiliary function (like retrieval). By the time these input variables go into the LLM they will have been converted to a string format, but often times they are not naturally represented as a string (they could be a list, or a Document object). Therefore, it is important to have visibility into what exactly the final string going into the LLM is. This has helped us debug bugs in formatting logic, unexpected transformations to user input, and straight up missing user input.To a much lesser extent, this is also true of the output of an LLM. Oftentimes the output of an LLM is technically a string but that string may contain some structure (json, yaml) that is intended to be parsed into a structured representation. Understanding what the exact output is can help determine if there may be a need for different parsing.LangSmith provides a straightforward visualization of the exact inputs/outputs to all LLM calls, so you can easily understand them.If I edit the prompt, how does that affect the output?\u200bSo you notice a bad output, and you go into LangSmith to see what&#x27;s going on. You find the faulty LLM call and are now looking at the exact input. You want to try changing a word or a phrase to see what happens -- what do you do?We constantly ran into this issue. Initially, we copied the prompt to a playground of sorts. But this got annoying, so we built a playground of our own! When examining an LLM call, you can click the Open in Playground button to access this playground. Here, you can modify the prompt and re-run it to observe the resulting changes to the output - as many times as needed!Currently, this feature supports only OpenAI and Anthropic models and works for LLM and Chat Model calls. We plan to extend its functionality to more LLM types, chains, agents, and retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we&#x27;ve added a â€œShareâ€ button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, itâ€™s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you&#x27;re wandering blind. You donâ€™t have any examples to benchmark your changes against.LangSmith addresses this problem by including an â€œAdd to Datasetâ€ button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&#x27;inputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat weâ€™ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If weâ€™re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;You can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.Weâ€™ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing â€” mirroring the debug mode approach.Weâ€™ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these arenâ€™t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.â†©PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright Â© 2024 LangChain, Inc.&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)]</span></span><br><span class="line">è½¬æ¢æˆå‘é‡å®Œæ¯•</span><br><span class="line">å°†å‘é‡è½¬æ¢ä¸ºæ£€ç´¢å™¨</span><br><span class="line">æ„å»ºé—®é¢˜å®Œæ¯•</span><br><span class="line">å¼€å§‹è°ƒç”¨</span><br><span class="line">è°ƒç”¨å®Œæ¯•</span><br><span class="line">&#123;<span class="comment">&#x27;input&#x27;: &#x27;how can langsmith help with testing?&#x27;, &#x27;context&#x27;: [Document(page_content=&quot;You can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.Weâ€™ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing â€” mirroring the debug mode approach.Weâ€™ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these arenâ€™t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.â†©PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright Â© 2024 LangChain, Inc.&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&#x27;inputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat weâ€™ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If weâ€™re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we&#x27;ve added a â€œShareâ€ button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, itâ€™s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you&#x27;re wandering blind. You donâ€™t have any examples to benchmark your changes against.LangSmith addresses this problem by including an â€œAdd to Datasetâ€ button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)], &#x27;answer&#x27;: &#x27;LangSmith can assist with testing by providing various features to simplify dataset uploading, running chains over the data points, visualizing the outputs, and evaluating the results. Here are some ways LangSmith can help with testing:\n\n1. Easy dataset uploading: LangSmith simplifies dataset uploading, making it easier to construct a small dataset by hand or use an existing one.\n2. Running chains over data points: Once you have a dataset, LangSmith allows you to run the chain over the data points and visualize the outputs. You can review the outputs directly in the web app by assigning feedback to runs and marking them as correct or incorrect.\n3. Evaluating results: LangSmith adds a set of evaluators to the open-source LangChain library, which can be specified when initiating a test run. These evaluators will evaluate the results once the test run completes, providing valuable information for guiding your eye to examples you should look at.\n4. Manual testing and annotation: LangSmith makes it easy to manually review and annotate runs through a visualization of the sequence of events, helping identify subjective qualities that automatic evaluators struggle with.\n5. Tracking token usage: LangSmith tracks the total token usage for a chain and the token usage of each step, making it easier to identify potentially costly parts of the chain.\n6. Collecting examples: LangSmith includes an &quot;Add to Dataset&quot; button for each run, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model. This feature is available at every step of a nested chain, making it easier to test the overall flow and individual components.\n\nBy leveraging these features, LangSmith can help streamline your testing process and provide valuable insights into your LLM application\&#x27;s performance.&#x27;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Conversation-Retrieval-Chainï¼ˆå¯¹è¯æ£€ç´¢é“¾ï¼‰">Conversation Retrieval Chainï¼ˆå¯¹è¯æ£€ç´¢é“¾ï¼‰</h2><ul><li>æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„é“¾åªèƒ½å›ç­”å•ä¸€çš„é—®é¢˜ï¼Œä½†æœ‰äº›åº”ç”¨åœºæ™¯éœ€è¦æ„å»ºå¯¹è¯å‹çš„èŠå¤©æœºå™¨äººã€‚</li><li>ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨create_retrieval_chainå‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ”¹å˜ä¸¤ä»¶äº‹ï¼š<ul><li>æ£€ç´¢æ–¹æ³•ç°åœ¨ä¸åº”ä»…é€‚ç”¨äºæœ€è¿‘çš„è¾“å…¥ï¼Œè€Œåº”è€ƒè™‘æ•´ä¸ªå†å²è®°å½•ã€‚</li><li>æœ€ç»ˆçš„ LLM é“¾åŒæ ·åº”è¯¥è€ƒè™‘æ•´ä¸ªå†å²<br>æ›´æ–°æ£€ç´¢ï¼ˆretrievalï¼‰<br>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„é“¾ï¼Œè¿™ä¸ªé“¾å°†æ¥å—æœ€è¿‘çš„ç”¨æˆ·è¾“å…¥ï¼ˆinputï¼‰å’Œæ•´ä¸ªå¯¹è¯å†å²ï¼ˆchat_historyï¼‰ï¼Œç„¶åä½¿ç”¨è¯­è¨€æ¨¡å‹ç”Ÿæˆä¸€ä¸ªæœç´¢æŸ¥è¯¢ã€‚è¿™é‡Œä½¿ç”¨äº† create_history_aware_retriever å‡½æ•°æ¥å®ç°è¿™ä¸ªæ–°é“¾ã€‚</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_history_aware_retriever</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> MessagesPlaceholder</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªæç¤ºæ¨¡æ¿ï¼Œç”¨äºæ ¹æ®å¯¹è¯å†å²ç”Ÿæˆæœç´¢æŸ¥è¯¢</span></span><br><span class="line">prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;chat_history&quot;</span>),  <span class="comment"># å¯¹è¯å†å²çš„å ä½ç¬¦</span></span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),  <span class="comment"># ç”¨æˆ·è¾“å…¥çš„å ä½ç¬¦</span></span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;åœ¨ä¸Šè¿°å¯¹è¯çš„åŸºç¡€ä¸Šï¼Œç”Ÿæˆä¸€ä¸ªæœç´¢æŸ¥è¯¢ï¼Œä»¥è·å–ä¸å¯¹è¯ç›¸å…³çš„ä¿¡æ¯&quot;</span>)  <span class="comment"># ç”Ÿæˆæœç´¢æŸ¥è¯¢çš„æŒ‡ä»¤ï¼ŒåŸºäºå¯¹è¯å†…å®¹</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ£€ç´¢å™¨é“¾ï¼Œæ•´åˆè¯­è¨€æ¨¡å‹ã€æ£€ç´¢å™¨å’Œå®šä¹‰çš„æç¤º</span></span><br><span class="line">retriever_chain = create_history_aware_retriever(llm, retriever, prompt)</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬å¯ä»¥ä¼ å…¥åç»­çš„é—®é¢˜å®ä¾‹æ¥æµ‹è¯•è¿™ä¸€ç‚¹</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage, AIMessage</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å¯¹è¯å†å²ï¼ŒåŒ…æ‹¬äººç±»æ¶ˆæ¯å’ŒAIæ¶ˆæ¯</span></span><br><span class="line">chat_history = [HumanMessage(content=<span class="string">&quot;LangSmithå¯ä»¥å¸®åŠ©æˆ‘æµ‹è¯•Appå—ï¼Ÿ&quot;</span>), AIMessage(content=<span class="string">&quot;Yes!&quot;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨æ£€ç´¢å™¨é“¾ï¼Œä¼ å…¥å¯¹è¯å†å²å’Œç”¨æˆ·è¾“å…¥</span></span><br><span class="line">retriever_chain.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;chat_history&quot;</span>: chat_history,</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;å‘Šè¯‰æˆ‘æ€ä¹ˆåš&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>æ­¤æ—¶çš„è¾“å‡ºåº”è¯¥æ˜¯ä¼šè¿”å›æœ‰å…³ LangSmith ä¸­æµ‹è¯•çš„æ–‡æ¡£ã€‚è¿™æ˜¯å› ä¸ºLLMç”Ÿæˆäº†ä¸€ä¸ªæ–°æŸ¥è¯¢ï¼Œå°†èŠå¤©å†å²è®°å½•ä¸åç»­é—®é¢˜ç›¸ç»“åˆã€‚</li><li>ç°åœ¨æˆ‘ä»¬æœ‰äº†è¿™ä¸ªæ–°çš„æ£€ç´¢å™¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„é“¾æ¥ç»§ç»­ä¸è¿™äº›æ£€ç´¢åˆ°çš„æ–‡æ¡£è¿›è¡Œå¯¹è¯ã€‚</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">prompt</span> = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;æ ¹æ®ä¸Šä¸‹æ–‡å›ç­”ç”¨æˆ·çš„é—®é¢˜\n\n&#123;context&#125;&quot;</span>),</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;chat_history&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="attr">document_chain</span> = create_stuff_documents_chain(llm, prompt)</span><br><span class="line"><span class="attr">retrieval_chain</span> = create_retrieval_chain(retriever_chain, document_chain)</span><br></pre></td></tr></table></figure><ul><li>ç°åœ¨è¿›è¡Œæ•´ä½“çš„æµ‹è¯•ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chat_history = [HumanMessage(content=<span class="string">&quot;LangSmithå¯ä»¥å¸®åŠ©æˆ‘æµ‹è¯•Appå—ï¼Ÿ&quot;</span>), AIMessage(content=<span class="string">&quot;Yes!&quot;</span>)]</span><br><span class="line"></span><br><span class="line">retriever_chain.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;chat_history&quot;</span>: chat_history,</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;å‘Šè¯‰æˆ‘æ€ä¹ˆåš&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>ä¼šå‡ºäº†ä¸€ä¸ªè¿è´¯çš„ç­”æ¡ˆï¼Œè¡¨æ˜æˆ‘ä»¬å·²ç»æˆåŠŸåœ°å°†æ£€ç´¢é“¾å˜æˆäº†èŠå¤©æœºå™¨äºº</li></ul><h2 id="Agent">Agent</h2><ul><li>æ„å»ºä»£ç†æ—¶è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å†³å®šå®ƒåº”è¯¥æœ‰æƒè®¿é—®å“ªäº›å·¥å…·ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ºä»£ç†æä¾›ä¸¤ä¸ªå·¥å…·çš„è®¿é—®æƒé™ï¼š<ol><li>æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ£€ç´¢å™¨ã€‚è¿™å°†è®©å®ƒè½»æ¾å›ç­”æœ‰å…³ LangSmith çš„é—®é¢˜</li></ol><ul><li>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¸ºåˆšåˆšåˆ›å»ºçš„æ£€ç´¢å™¨è®¾ç½®ä¸€ä¸ªå·¥å…·ï¼š</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.tools.retriever <span class="keyword">import</span> create_retriever_tool</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™ä¸ªæ£€ç´¢å™¨å°±æ˜¯åˆšåˆšçˆ¬å–LongSmithæ–‡æ¡£çš„å†…å®¹ï¼Œç”Ÿæˆçš„æ£€ç´¢å™¨</span></span><br><span class="line">retriever_tool = create_retriever_tool(</span><br><span class="line">    retriever,</span><br><span class="line">    <span class="string">&quot;langsmith_search&quot;</span>,</span><br><span class="line">    <span class="string">&quot;æœç´¢æœ‰å…³LangSmithçš„ä¿¡æ¯æˆ–è€…æœ‰å…³LangSmithçš„ä»»ä½•é—®é¢˜ï¼Œå¿…é¡»ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ol start="2"><li>ä¸€ä¸ªæœç´¢å·¥å…·ã€‚è¿™å°†ä½¿å®ƒèƒ½å¤Ÿè½»æ¾å›ç­”éœ€è¦æœ€æ–°ä¿¡æ¯çš„é—®é¢˜ã€‚<br>- å®˜ç½‘ç¤ºä¾‹ä¸­ä½¿ç”¨çš„æœç´¢å·¥å…·æ˜¯Tavilyï¼Œéœ€è¦ä¸€ä¸ª API å¯†é’¥ï¼ˆæœ‰å…è´¹å¥—é¤ï¼‰ã€‚åœ¨ä»–ä»¬çš„å¹³å°ä¸Šåˆ›å»ºåï¼Œéœ€è¦å°†å…¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡</li></ol><pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.tools.tavily_search <span class="keyword">import</span> TavilySearchResults</span><br><span class="line"></span><br><span class="line">search = TavilySearchResults()</span><br></pre></td></tr></table></figure>- æˆ‘ä»¬ç°åœ¨å¯ä»¥åˆ›å»ºæˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„å·¥å…·çš„åˆ—è¡¨ï¼š<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tools = [retriever_tool, search]</span><br></pre></td></tr></table></figure>- ç°åœ¨æˆ‘ä»¬æœ‰äº†å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªä»£ç†æ¥ä½¿ç”¨å®ƒä»¬ã€‚<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™ä¸ªå¯ä»¥æ‹‰å–é¢„å®šä¹‰å¥½çš„prompt</span></span><br><span class="line">pip install langchainhub</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> hub</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_openai_functions_agent</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–åˆ«äººé¢„å®šä¹‰å¥½çš„prompt</span></span><br><span class="line">prompt = hub.pull(<span class="string">&quot;hwchase17/openai-functions-agent&quot;</span>)</span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">agent = create_openai_functions_agent(llm, tools, prompt)</span><br><span class="line">agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>- è°ƒç”¨<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agent_executor.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;LangSmithå¯ä»¥å¸®åŠ©æˆ‘æµ‹è¯•Appå—ï¼Ÿ&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></code></pre><h2 id="æ„å»ºæœåŠ¡">æ„å»ºæœåŠ¡</h2><ul><li>LangServe å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å°† LangChain é“¾éƒ¨ç½²ä¸º REST APIã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> WebBaseLoader</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain.tools.retriever <span class="keyword">import</span> create_retriever_tool</span><br><span class="line"><span class="keyword">from</span> langchain_community.tools.tavily_search <span class="keyword">import</span> TavilySearchResults</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> hub</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_openai_functions_agent</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor</span><br><span class="line"><span class="keyword">from</span> langchain.pydantic_v1 <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"><span class="keyword">from</span> langserve <span class="keyword">import</span> add_routes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. åŠ è½½æ£€ç´¢å™¨ï¼ˆRetrieverï¼‰</span></span><br><span class="line"><span class="comment"># é¦–å…ˆï¼Œé€šè¿‡ WebBaseLoader ä» LangChain æ–‡æ¡£ç½‘ç«™åŠ è½½æ–‡æ¡£æ•°æ®ã€‚ç„¶åï¼Œä½¿ç”¨ RecursiveCharacterTextSplitter å°†æ–‡æ¡£åˆ†å‰²ä¸ºæ–‡æ¡£ç‰‡æ®µï¼Œå¹¶ä½¿ç”¨ OpenAIEmbeddings å°†æ–‡æ¡£ç‰‡æ®µåµŒå…¥ä¸ºå‘é‡ã€‚æœ€åï¼Œä½¿ç”¨ FAISS åˆ›å»ºä¸€ä¸ªå‘é‡å­˜å‚¨ä½œä¸ºæ£€ç´¢å™¨ã€‚</span></span><br><span class="line">loader = WebBaseLoader(<span class="string">&quot;https://docs.smith.langchain.com/overview&quot;</span>)</span><br><span class="line">docs = loader.load()</span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter()</span><br><span class="line">documents = text_splitter.split_documents(docs)</span><br><span class="line">embeddings = OpenAIEmbeddings()</span><br><span class="line">vector = FAISS.from_documents(documents, embeddings)</span><br><span class="line">retriever = vector.as_retriever()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆ›å»ºå·¥å…·ï¼ˆToolsï¼‰</span></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸¤ä¸ªå·¥å…·ï¼šä¸€ä¸ªæ˜¯ä¹‹å‰åˆ›å»ºçš„æ£€ç´¢å™¨å·¥å…· retriever_toolï¼Œå¦ä¸€ä¸ªæ˜¯ Tavily æœç´¢å·¥å…· searchã€‚</span></span><br><span class="line">retriever_tool = create_retriever_tool(</span><br><span class="line">    retriever,</span><br><span class="line">    <span class="string">&quot;langsmith_search&quot;</span>,</span><br><span class="line">    <span class="string">&quot;æœç´¢æœ‰å…³LangSmithçš„ä¿¡æ¯æˆ–è€…æœ‰å…³LangSmithçš„ä»»ä½•é—®é¢˜ï¼Œå¿…é¡»ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼&quot;</span>,</span><br><span class="line">)</span><br><span class="line">search = TavilySearchResults()</span><br><span class="line">tools = [retriever_tool, search]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. åˆ›å»ºä»£ç†</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ LangChain Hub ä¸­æä¾›çš„é¢„å®šä¹‰æç¤ºï¼ˆè‡ªå·±æ„å»ºä¹Ÿå¯ä»¥ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªä½¿ç”¨ OpenAI æ¨¡å‹å’Œå·¥å…·çš„ä»£ç†ã€‚è¿™ä¸ªä»£ç†è¢«è®¾ç½®ä¸ºèƒ½å¤Ÿå†³å®šåœ¨å¤„ç†é—®é¢˜æ—¶ä½¿ç”¨å“ªäº›å·¥å…·ã€‚</span></span><br><span class="line">prompt = hub.pull(<span class="string">&quot;hwchase17/openai-functions-agent&quot;</span>)</span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">agent = create_openai_functions_agent(llm, tools, prompt)</span><br><span class="line">agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. FastAPI å®šä¹‰</span></span><br><span class="line">app = FastAPI(</span><br><span class="line">  title=<span class="string">&quot;LangChain Server&quot;</span>,</span><br><span class="line">  version=<span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  description=<span class="string">&quot;A simple API server using LangChain&#x27;s Runnable interfaces&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. æ·»åŠ é“¾è·¯ç”±</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡è°ƒç”¨ add_routes å‡½æ•°ï¼Œå°†ä»£ç†é“¾æ·»åŠ ä¸º FastAPI åº”ç”¨çš„ä¸€ä¸ªè·¯ç”±ï¼Œä»è€Œå¯ä»¥é€šè¿‡ /agent è·¯å¾„è®¿é—®ä»£ç†é“¾ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Input</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">input</span>: <span class="built_in">str</span></span><br><span class="line">    chat_history: <span class="type">List</span>[BaseMessage] = Field(</span><br><span class="line">        ...,</span><br><span class="line">        extra=&#123;<span class="string">&quot;widget&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;chat&quot;</span>, <span class="string">&quot;input&quot;</span>: <span class="string">&quot;location&quot;</span>&#125;&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Output</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    output: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">add_routes(</span><br><span class="line">    app,</span><br><span class="line">    agent_executor.with_types(input_type=Input, output_type=Output),</span><br><span class="line">    path=<span class="string">&quot;/agent&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">    uvicorn.run(app, host=<span class="string">&quot;localhost&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><h1>é“¾çš„æ¦‚å¿µï¼ˆè¡¥å……ï¼‰</h1><ul><li>é“¾ï¼ˆChainsï¼‰é€šå¸¸å°†å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ä¸æç¤ºï¼ˆPromptï¼‰ç»“åˆåœ¨ä¸€èµ·ï¼ŒåŸºäºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ–‡æœ¬æˆ–æ•°æ®è¿›è¡Œä¸€ç³»åˆ—æ“ä½œã€‚é“¾ï¼ˆChainsï¼‰å¯ä»¥ä¸€æ¬¡æ€§æ¥å—å¤šä¸ªè¾“å…¥ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªé“¾ï¼Œè¯¥é“¾æ¥å—ç”¨æˆ·è¾“å…¥ï¼Œä½¿ç”¨æç¤ºæ¨¡æ¿å¯¹å…¶è¿›è¡Œæ ¼å¼åŒ–ï¼Œç„¶åå°†æ ¼å¼åŒ–çš„å“åº”ä¼ é€’ç»™ LLM ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å¤šä¸ªé“¾ç»„åˆåœ¨ä¸€èµ·ï¼Œæˆ–è€…é€šè¿‡å°†é“¾ä¸å…¶ä»–ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·æ¥æ„å»ºæ›´å¤æ‚çš„é“¾ã€‚</li></ul><h2 id="é¡ºåºé“¾ï¼ˆSequentialChainsï¼‰">é¡ºåºé“¾ï¼ˆSequentialChainsï¼‰</h2><ul><li>æ˜¯æŒ‰é¢„å®šä¹‰é¡ºåºæ‰§è¡Œå…¶é“¾æ¥çš„é“¾ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç®€å•é¡ºåºé“¾ï¼ˆSimpleSequentialChainï¼‰ï¼Œè¿™æ˜¯é¡ºåºé“¾çš„æœ€ç®€å•ç±»å‹ï¼Œå…¶ä¸­æ¯ä¸ªæ­¥éª¤éƒ½æœ‰ä¸€ä¸ªè¾“å…¥/è¾“å‡ºï¼Œä¸€ä¸ªæ­¥éª¤çš„è¾“å‡ºæ˜¯ä¸‹ä¸€ä¸ªæ­¥éª¤çš„è¾“å…¥ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms <span class="keyword">import</span> Tongyi</span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain, SimpleSequentialChain</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line">prompt1 = ChatPromptTemplate.from_template(<span class="string">&quot;ä½ ç°åœ¨æ˜¯å†™ä½œé¢†åŸŸçš„å¤§å¸ˆï¼Œç°åœ¨ä¸º&#123;title&#125;è¿™ç¯‡æ–‡ç« ç”Ÿæˆä¸€äº›å¤§çº²å§ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">chain_one = LLMChain(llm=llm, prompt=prompt1)</span><br><span class="line"></span><br><span class="line">prompt2 = ChatPromptTemplate.from_template(<span class="string">&quot;æ ¹æ®è¿™ä¸ªå¤§çº²ï¼š&#123;toc&#125;ï¼Œç”Ÿæˆæ¯ä¸ªç« èŠ‚å¯¹åº”çš„å†…å®¹å§ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">chain_two = LLMChain(llm=llm, prompt=prompt2)</span><br><span class="line"></span><br><span class="line">chain = SimpleSequentialChain(chains=[chain_one, chain_two], verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    title = <span class="built_in">input</span>(<span class="string">&quot;è¯·è¾“å…¥é¢˜ç›®ï¼š&quot;</span>)</span><br><span class="line">    res = chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: title&#125;)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(res, indent=<span class="number">4</span>))</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">å½“ç„¶å¯ä»¥ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªå…³äºâ€œå¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºåˆ†æâ€çš„æ–‡ç« å¤§çº²ï¼š</span><br><span class="line"></span><br><span class="line">I. å¼•è¨€</span><br><span class="line">   A. ç½‘çº¢ç»æµçš„å´›èµ·ä¸å¤§å­¦ç”Ÿæ¶ˆè´¹è€…çš„æ¦‚è¿°</span><br><span class="line">   B. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹ç°è±¡çš„é‡è¦æ€§åŠç ”ç©¶èƒŒæ™¯</span><br><span class="line">   C. æ–‡ç« çš„ç ”ç©¶ç›®çš„å’Œæ„ä¹‰</span><br><span class="line"></span><br><span class="line">II. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è€…ç¾¤ä½“ç‰¹å¾åˆ†æ</span><br><span class="line">   A. å¹´é¾„ã€æ€§åˆ«ã€ä¸“ä¸šç­‰äººå£ç»Ÿè®¡å­¦ç‰¹å¾</span><br><span class="line">   B. å¤§å­¦ç”Ÿçš„ç½‘ç»œä½¿ç”¨ä¹ æƒ¯ä¸ç¤¾äº¤åª’ä½“åå¥½</span><br><span class="line">   C. å¤§å­¦ç”Ÿå¯¹ç½‘çº¢çš„è®¤å¯åº¦ä¸ä¿¡ä»»åº¦</span><br><span class="line"></span><br><span class="line">III. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç‰¹ç‚¹</span><br><span class="line">   A. æ¶ˆè´¹åŠ¨æœºï¼šä»å¨±ä¹æ¶ˆé£åˆ°è´­ç‰©å†³ç­–çš„å½±å“</span><br><span class="line">   B. æ¶ˆè´¹å“ç±»åå‘ï¼šæ—¶å°šç©¿æ­ã€ç¾å¦†æŠ¤è‚¤ã€ç”µå­äº§å“ç­‰æ–¹é¢çš„æ¶ˆè´¹æƒ…å†µ</span><br><span class="line">   C. è·Ÿé£æ¶ˆè´¹ä¸ä¸ªæ€§åŒ–æ¶ˆè´¹éœ€æ±‚çš„å¹³è¡¡</span><br><span class="line">   D. æƒ…æ„Ÿå› ç´ åœ¨è´­ä¹°å†³ç­–ä¸­çš„ä½œç”¨</span><br><span class="line"></span><br><span class="line">IV. ç½‘çº¢å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹è¡Œä¸ºçš„å½±å“æœºåˆ¶</span><br><span class="line">   A. ç½‘çº¢çš„å½±å“åŠ›æ¥æºï¼šå†…å®¹åˆ›ä½œèƒ½åŠ›ã€äººæ ¼é­…åŠ›ã€å£ç¢‘æ•ˆåº”ç­‰</span><br><span class="line">   B. ç½‘çº¢è¥é”€ç­–ç•¥å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹å¿ƒç†çš„å½±å“ï¼šæƒ…æ„Ÿå…±é¸£ã€ç”Ÿæ´»æ–¹å¼å¡‘é€ ã€æ„è§é¢†è¢–è§’è‰²</span><br><span class="line">   C. ç½‘çº¢å¹¿å‘Šä¸è½¯æ€§æ¨å¹¿å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹é€‰æ‹©çš„å¼•å¯¼</span><br><span class="line"></span><br><span class="line">V. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç¤¾ä¼šæ–‡åŒ–å½±å“</span><br><span class="line">   A. å¯¹å¤§å­¦ç”Ÿä»·å€¼è§‚å¡‘é€ çš„å½±å“</span><br><span class="line">   B. ç¤¾ä¼šå®¡ç¾è¶‹åŠ¿ä¸æ¶ˆè´¹è§‚å¿µçš„å˜åŒ–</span><br><span class="line">   C. å¯¹æ ¡å›­æ–‡åŒ–å’Œå¸‚åœºç»æµå‘å±•çš„å¯ç¤º</span><br><span class="line"></span><br><span class="line">VI. ç»“è®º</span><br><span class="line">   A. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ä¸»è¦ç‰¹ç‚¹åŠå…¶æˆå› æ€»ç»“</span><br><span class="line">   B. å¯¹æ•™è‚²éƒ¨é—¨ã€ä¼ä¸šã€ç½‘çº¢è‡ªèº«ä»¥åŠç¤¾ä¼šå„æ–¹é¢åº”å¯¹å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºè¿›è¡Œåˆç†å¼•å¯¼å’Œè§„èŒƒçš„å»ºè®®</span><br><span class="line">   C. å±•æœ›æœªæ¥ç ”ç©¶æ–¹å‘ä¸å¯èƒ½æ€§</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªå¤§çº²æ—¨åœ¨å…¨é¢æ¢è®¨å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç°è±¡ã€ç‰¹ç‚¹ã€æˆå› ä»¥åŠå…¶èƒŒåçš„ç¤¾ä¼šæ–‡åŒ–å½±å“ï¼Œå¹¶é’ˆå¯¹ç›¸å…³å„æ–¹æå‡ºæœ‰é’ˆå¯¹æ€§çš„æ€è€ƒä¸å»ºè®®ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹é¢å°±æ˜¯æ¯ä¸ªç« èŠ‚å¯¹åº”çš„å†…å®¹</span></span><br><span class="line"></span><br><span class="line">I. å¼•è¨€</span><br><span class="line">A. ç½‘çº¢ç»æµçš„å´›èµ·ä¸å¤§å­¦ç”Ÿæ¶ˆè´¹è€…çš„æ¦‚è¿°</span><br><span class="line">éšç€äº’è”ç½‘æŠ€æœ¯çš„å‘å±•å’Œç¤¾äº¤åª’ä½“å¹³å°çš„æ™®åŠï¼Œç½‘çº¢ç»æµä½œä¸ºä¸€ç§æ–°å‹å•†ä¸šæ¨¡å¼åœ¨å…¨çƒèŒƒå›´å†…è¿…é€Ÿå´›èµ·ã€‚å¤§å­¦ç”Ÿä½œä¸ºç½‘ç»œä¸»åŠ›å†›å’Œæ–°å…´æ¶ˆè´¹ç¾¤ä½“ï¼Œä»–ä»¬å¯¹äºç½‘çº¢çš„è¿½æ§å’Œæ¶ˆè´¹è¡Œä¸ºæˆä¸ºå½“å‰å¸‚åœºå…³æ³¨çš„çƒ­ç‚¹ã€‚è¿™ä¸€ç°è±¡ä¸ä»…åæ˜ å‡ºäº†ç½‘çº¢ç»æµçš„å·¨å¤§æ½œåŠ›ï¼Œä¹Ÿæ­ç¤ºäº†å¤§å­¦ç”Ÿåœ¨æ¶ˆè´¹è§‚å¿µå’Œè¡Œä¸ºä¸Šçš„æ–°å˜åŒ–ã€‚</span><br><span class="line"></span><br><span class="line">B. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹ç°è±¡çš„é‡è¦æ€§åŠç ”ç©¶èƒŒæ™¯</span><br><span class="line">å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹ç°è±¡æ—¥ç›Šæ™®éï¼Œå…¶èƒŒåçš„æ¶ˆè´¹å¿ƒç†ã€æ¶ˆè´¹è¡Œä¸ºæ¨¡å¼ä»¥åŠå¯¹ç¤¾ä¼šæ–‡åŒ–çš„å½±å“å…·æœ‰é‡è¦ç ”ç©¶ä»·å€¼ã€‚é€šè¿‡æ·±å…¥æ¢ç©¶è¿™ä¸€ç°è±¡ï¼Œæœ‰åŠ©äºç†è§£æ–°ä¸€ä»£æ¶ˆè´¹è€…çš„æ¶ˆè´¹è¶‹åŠ¿ï¼Œä¸ºç›¸å…³ä¼ä¸šå’Œæ”¿ç­–åˆ¶å®šè€…æä¾›é’ˆå¯¹æ€§çš„ç­–ç•¥æŒ‡å¯¼ã€‚</span><br><span class="line"></span><br><span class="line">C. æ–‡ç« çš„ç ”ç©¶ç›®çš„å’Œæ„ä¹‰</span><br><span class="line">æœ¬æ–‡æ—¨åœ¨é€šè¿‡ç³»ç»Ÿåœ°ç ”ç©¶å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºï¼Œæ­ç¤ºå…¶ç‰¹å¾ã€æˆå› åŠå…¶ç¤¾ä¼šæ–‡åŒ–å½±å“ï¼Œä¸ºæ•™è‚²éƒ¨é—¨ã€ä¼ä¸šã€ç½‘çº¢è‡ªèº«ä¹ƒè‡³æ•´ä¸ªç¤¾ä¼šæä¾›ç†æ€§åº”å¯¹è¿™ä¸€ç°è±¡çš„æ€è·¯å’Œå»ºè®®ï¼ŒåŒæ—¶å¯¹æœªæ¥ç›¸å…³ç ”ç©¶é¢†åŸŸçš„å‘å±•æ–¹å‘è¿›è¡Œå±•æœ›ã€‚</span><br><span class="line"></span><br><span class="line">II. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è€…ç¾¤ä½“ç‰¹å¾åˆ†æ</span><br><span class="line">A. å¹´é¾„ã€æ€§åˆ«ã€ä¸“ä¸šç­‰äººå£ç»Ÿè®¡å­¦ç‰¹å¾</span><br><span class="line">ä»¥åœ¨æ ¡å¤§å­¦ç”Ÿä¸ºä¸»ä½“çš„å¹´è½»æ¶ˆè´¹äººç¾¤ä¸»è¦é›†ä¸­åœ¨<span class="number">18</span>-<span class="number">24</span>å²å¹´é¾„æ®µï¼Œç”·å¥³æ¯”ä¾‹ç›¸å¯¹å‡è¡¡ï¼Œä¸åŒä¸“ä¸šçš„å­¦ç”Ÿå¯èƒ½ç”±äºå…´è¶£çˆ±å¥½ã€å®¡ç¾å–å‘ç­‰å› ç´ ï¼Œåœ¨ç½‘çº¢æ¶ˆè´¹ä¸Šè¡¨ç°å‡ºä¸€å®šçš„å·®å¼‚ã€‚</span><br><span class="line"></span><br><span class="line">B. å¤§å­¦ç”Ÿçš„ç½‘ç»œä½¿ç”¨ä¹ æƒ¯ä¸ç¤¾äº¤åª’ä½“åå¥½</span><br><span class="line">å½“ä»£å¤§å­¦ç”Ÿæ˜¯äº’è”ç½‘çš„é‡åº¦ä½¿ç”¨è€…ï¼Œä»–ä»¬åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­å¹¿æ³›ä¾èµ–äºç¤¾äº¤åª’ä½“å¹³å°è·å–ä¿¡æ¯ã€äº¤æµäº’åŠ¨å’Œå¨±ä¹ä¼‘é—²ã€‚å°¤å…¶åçˆ±çŸ­è§†é¢‘ã€ç›´æ’­ã€å¾®åšç­‰æ–°åª’ä½“å½¢å¼ï¼Œè¿™ä¸ºç½‘çº¢ä¼ æ’­å†…å®¹æä¾›äº†å¹¿é˜”çš„å—ä¼—åŸºç¡€ã€‚</span><br><span class="line"></span><br><span class="line">C. å¤§å­¦ç”Ÿå¯¹ç½‘çº¢çš„è®¤å¯åº¦ä¸ä¿¡ä»»åº¦</span><br><span class="line">å¤§å­¦ç”Ÿæ™®éè®¤ä¸ºç½‘çº¢å…·å¤‡è¾ƒé«˜çš„æ½®æµå¼•é¢†åŠ›å’Œç¤¾äº¤å½±å“åŠ›ï¼Œå¯¹äºå…·æœ‰ä¸€å®šä¸“ä¸šç´ å…»å’Œäº²å’ŒåŠ›çš„ç½‘çº¢æ›´å®¹æ˜“äº§ç”Ÿè®¤åŒæ„Ÿå’Œä¿¡èµ–æ„Ÿï¼Œä»è€Œå°†å…¶æ¨èçš„äº§å“æˆ–æœåŠ¡çº³å…¥è‡ªå·±çš„æ¶ˆè´¹è€ƒè™‘èŒƒå›´ã€‚</span><br><span class="line"></span><br><span class="line">III. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç‰¹ç‚¹</span><br><span class="line">A. æ¶ˆè´¹åŠ¨æœºï¼šä»å¨±ä¹æ¶ˆé£åˆ°è´­ç‰©å†³ç­–çš„å½±å“</span><br><span class="line">å¤§å­¦ç”Ÿåœ¨å…³æ³¨ç½‘çº¢çš„è¿‡ç¨‹ä¸­ï¼Œæœ€åˆå¯èƒ½å‡ºäºå¨±ä¹æ¶ˆé£çš„éœ€æ±‚ï¼Œä½†é€æ¸åœ°ï¼Œç½‘çº¢æ‰€å±•ç¤ºçš„ç”Ÿæ´»æ–¹å¼ã€æ—¶å°šå“å‘³ä»¥åŠäº§å“ä½“éªŒç­‰å†…å®¹ä¼šå½±å“ä»–ä»¬çš„è´­ç‰©å†³ç­–ï¼Œä½¿å¾—æ¶ˆè´¹è¡Œä¸ºç”±å•çº¯çš„è§‚èµè½¬å˜ä¸ºå®é™…è´­ä¹°è¡Œä¸ºã€‚</span><br><span class="line"></span><br><span class="line">B. æ¶ˆè´¹å“ç±»åå‘ï¼šæ—¶å°šç©¿æ­ã€ç¾å¦†æŠ¤è‚¤ã€ç”µå­äº§å“ç­‰æ–¹é¢çš„æ¶ˆè´¹æƒ…å†µ</span><br><span class="line">å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºä¸­ï¼Œæ—¶å°šç©¿æ­ã€ç¾å¦†æŠ¤è‚¤å’Œä¸ªäººç”µå­äº§å“æ˜¯æœ€å¸¸è§çš„æ¶ˆè´¹ç±»åˆ«ã€‚è¿™äº›å•†å“å¾€å¾€ä¸å¹´è½»äººè¿½æ±‚ä¸ªæ€§åŒ–ã€æ—¶å°šåŒ–å’Œé«˜å“è´¨ç”Ÿæ´»çš„éœ€æ±‚ç›¸å¥‘åˆã€‚</span><br><span class="line"></span><br><span class="line">C. è·Ÿé£æ¶ˆè´¹ä¸ä¸ªæ€§åŒ–æ¶ˆè´¹éœ€æ±‚çš„å¹³è¡¡</span><br><span class="line">å¤§å­¦ç”Ÿåœ¨ç½‘çº¢æ¶ˆè´¹è¿‡ç¨‹ä¸­ï¼Œæ—¢å­˜åœ¨è·Ÿé£æ¨¡ä»¿çš„ç°è±¡ï¼Œä¹Ÿæ³¨é‡ä¸ªæ€§è¡¨è¾¾å’Œè‡ªæˆ‘é£æ ¼çš„å¡‘é€ ã€‚ä»–ä»¬ä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸Šæ¥å—ç½‘çº¢æ¨èçš„å•†å“å’ŒæœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿæ ¹æ®ä¸ªäººå–œå¥½å’Œå®é™…æƒ…å†µåšå‡ºé€‰æ‹©ï¼Œå®ç°è·Ÿé£ä¸ä¸ªæ€§éœ€æ±‚çš„åŠ¨æ€å¹³è¡¡ã€‚</span><br><span class="line"></span><br><span class="line">D. æƒ…æ„Ÿå› ç´ åœ¨è´­ä¹°å†³ç­–ä¸­çš„ä½œç”¨</span><br><span class="line">å¤§å­¦ç”Ÿæ¶ˆè´¹è€…åœ¨ç½‘çº¢è´­ç‰©å†³ç­–ä¸­æƒ…æ„Ÿå› ç´ å æ®è¾ƒå¤§æ¯”é‡ï¼ŒåŒ…æ‹¬å¯¹ç½‘çº¢æœ¬äººçš„æƒ…æ„Ÿè®¤åŒã€å¯¹ç½‘çº¢æ‰€æ„å»ºç”Ÿæ´»æ–¹å¼çš„å‘å¾€ä»¥åŠä¸å…¶ä»–ç²‰ä¸é—´çš„ç¤¾äº¤å…³ç³»ç­‰å› ç´ éƒ½ä¼šå½±å“åˆ°è´­ä¹°è¡Œä¸ºã€‚</span><br><span class="line"></span><br><span class="line">IV. ç½‘çº¢å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹è¡Œä¸ºçš„å½±å“æœºåˆ¶</span><br><span class="line">A. ç½‘çº¢çš„å½±å“åŠ›æ¥æºï¼šå†…å®¹åˆ›ä½œèƒ½åŠ›ã€äººæ ¼é­…åŠ›ã€å£ç¢‘æ•ˆåº”ç­‰</span><br><span class="line">ç½‘çº¢çš„å½±å“åŠ›æºäºå…¶ç‹¬ç‰¹çš„å†…å®¹åˆ›ä½œèƒ½åŠ›ã€é²œæ˜çš„ä¸ªæ€§ç‰¹è´¨ä»¥åŠè‰¯å¥½çš„å£ç¢‘æ•ˆåº”ã€‚ä»–ä»¬é€šè¿‡é«˜è´¨é‡çš„å†…å®¹è¾“å‡ºï¼Œå¸å¼•å¹¶ç»´ç³»ç²‰ä¸ç¾¤ä½“ï¼Œè¿›è€Œè½¬åŒ–ä¸ºå•†ä¸šä»·å€¼ã€‚</span><br><span class="line"></span><br><span class="line">B. ç½‘çº¢è¥é”€ç­–ç•¥å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹å¿ƒç†çš„å½±å“ï¼šæƒ…æ„Ÿå…±é¸£ã€ç”Ÿæ´»æ–¹å¼å¡‘é€ ã€æ„è§é¢†è¢–è§’è‰²</span><br><span class="line">ç½‘çº¢è¿ç”¨æƒ…æ„Ÿå…±é¸£ã€ç”Ÿæ´»æ–¹å¼å±•ç¤ºä»¥åŠæ„è§é¢†è¢–çš„è§’è‰²å®šä½ï¼Œå·§å¦™åœ°å°†äº§å“èå…¥å…¶ä¸­ï¼Œæ¿€å‘å¤§å­¦ç”Ÿæ¶ˆè´¹è€…çš„å¿ƒç†å…±é¸£ï¼Œå½¢æˆæ½œåœ¨è´­ä¹°æ„æ„¿ï¼Œå¹¶æ¨åŠ¨å®é™…æ¶ˆè´¹è¡Œä¸ºçš„å‘ç”Ÿã€‚</span><br><span class="line"></span><br><span class="line">C. ç½‘çº¢å¹¿å‘Šä¸è½¯æ€§æ¨å¹¿å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹é€‰æ‹©çš„å¼•å¯¼</span><br><span class="line">ç½‘çº¢å€ŸåŠ©å¹¿å‘Šæ¤å…¥ã€å“ç‰Œåˆä½œç­‰å½¢å¼è¿›è¡Œå•†å“æ¨å¹¿ï¼Œè¿™ç§éšæ€§ä¸”æ˜“äºæ¥å—çš„è¥é”€æ‰‹æ®µåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå·¦å³äº†å¤§å­¦ç”Ÿçš„æ¶ˆè´¹é€‰æ‹©ã€‚</span><br><span class="line"></span><br><span class="line">V. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç¤¾ä¼šæ–‡åŒ–å½±å“</span><br><span class="line">A. å¯¹å¤§å­¦ç”Ÿä»·å€¼è§‚å¡‘é€ çš„å½±å“</span><br><span class="line">å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºä¿ƒè¿›äº†ä»–ä»¬å¯¹ç¾çš„è¿½æ±‚ã€ä¸ªæ€§åŒ–æ„è¯†çš„è§‰é†’ä»¥åŠå¯¹å“è´¨ç”Ÿæ´»çš„å‘å¾€ï¼Œè¿›ä¸€æ­¥å¡‘é€ äº†æ–°ä¸€ä»£æ¶ˆè´¹è€…çš„æ¶ˆè´¹ä»·å€¼è§‚ã€‚</span><br><span class="line"></span><br><span class="line">B. ç¤¾ä¼šå®¡ç¾è¶‹åŠ¿ä¸æ¶ˆè´¹è§‚å¿µçš„å˜åŒ–</span><br><span class="line">éšç€å¤§å­¦ç”Ÿå¯¹ç½‘çº¢æ¶ˆè´¹çš„ç§¯æå‚ä¸ï¼Œä»–ä»¬çš„å®¡ç¾æƒ…è¶£å’Œæ¶ˆè´¹è§‚å¿µé€æ¸æˆä¸ºç¤¾ä¼šå®¡ç¾è¶‹åŠ¿çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè¿›ä¸€æ­¥æ¨åŠ¨ç€ç¤¾ä¼šæ•´ä½“æ¶ˆè´¹è§‚å¿µçš„å˜é©ä¸å‘å±•ã€‚</span><br><span class="line"></span><br><span class="line">C. å¯¹æ ¡å›­æ–‡åŒ–å’Œå¸‚åœºç»æµå‘å±•çš„å¯ç¤º</span><br><span class="line">å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºä¸ä»…åæ˜ äº†å½“å‰å¸‚åœºç»æµç¯å¢ƒä¸‹æ¶ˆè´¹ç»“æ„å’Œæ¶ˆè´¹è¡Œä¸ºçš„æ–°å˜åŒ–ï¼Œä¹Ÿä¸ºæ ¡å›­æ–‡åŒ–çš„å¤šå…ƒåŒ–å‘å±•æä¾›äº†æ–°çš„è§†è§’ä¸å¯ç¤ºã€‚</span><br><span class="line"></span><br><span class="line">VI. ç»“è®º</span><br><span class="line">A. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ä¸»è¦ç‰¹ç‚¹åŠå…¶æˆå› æ€»ç»“</span><br><span class="line">é€šè¿‡å¯¹å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç ”ç©¶ï¼Œæˆ‘ä»¬å‘ç°å…¶ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬é«˜åº¦æ´»è·ƒçš„ç¤¾äº¤åª’ä½“å‚ä¸ã€å¼ºçƒˆçš„æƒ…æ„Ÿé©±åŠ¨æ¶ˆè´¹ã€ç´§è·Ÿæ½®æµä¸”å…¼é¡¾ä¸ªæ€§åŒ–çš„æ¶ˆè´¹éœ€æ±‚ä»¥åŠæ·±å—ç½‘çº¢è¥é”€ç­–ç•¥çš„å½±å“ã€‚è¿™äº›ç‰¹ç‚¹çš„èƒŒåæˆå› ä¸»è¦åŒ…æ‹¬å¤§å­¦ç”Ÿç‹¬ç‰¹çš„å¹´é¾„ç‰¹å¾ã€ç½‘ç»œç¯å¢ƒä¸‹çš„ä¿¡æ¯æ¥æ”¶æ–¹å¼ä»¥åŠç½‘çº¢å½±å“åŠ›çš„å¤šé‡ä½œç”¨ã€‚</span><br><span class="line"></span><br><span class="line">B. å¯¹æ•™è‚²éƒ¨é—¨ã€ä¼ä¸šã€ç½‘çº¢è‡ªèº«ä»¥åŠç¤¾ä¼šå„æ–¹é¢åº”å¯¹å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºè¿›è¡Œåˆç†å¼•å¯¼å’Œè§„èŒƒçš„å»ºè®®</span><br><span class="line">æ•™è‚²éƒ¨é—¨åº”åŠ å¼ºå¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹è§‚çš„å¼•å¯¼æ•™è‚²ï¼ŒåŸ¹å…»ä»–ä»¬çš„ç†æ€§æ¶ˆè´¹æ„è¯†ï¼›ä¼ä¸šåº”å……åˆ†è®¤è¯†åˆ°ç½‘çº¢è¥é”€çš„ä»·å€¼ï¼Œåˆç†åˆ©ç”¨ç½‘çº¢èµ„æºï¼ŒåŒæ—¶ä¸¥æ ¼éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ï¼Œç¡®ä¿è¥é”€æ´»åŠ¨çš„åˆæ³•åˆè§„ï¼›ç½‘çº¢è‡ªèº«åˆ™éœ€ä¿æŒèŒä¸šæ“å®ˆï¼Œä¼ é€’æ­£èƒ½é‡ï¼Œå‘æŒ¥å¥½æ¦œæ ·ä½œç”¨ï¼›ç¤¾ä¼šå„ç•Œä¹Ÿåº”å¯¹ç½‘çº¢ç»æµæŒå¼€æ”¾åŒ…å®¹æ€åº¦ï¼Œå¼ºåŒ–ç›‘ç®¡ä¸è‡ªå¾‹ç›¸ç»“åˆï¼Œå…±åŒè¥é€ å¥åº·æœ‰åºçš„ç½‘çº¢æ¶ˆè´¹ç¯å¢ƒã€‚</span><br><span class="line"></span><br><span class="line">C. å±•æœ›æœªæ¥ç ”ç©¶æ–¹å‘ä¸å¯èƒ½æ€§</span><br><span class="line">æœªæ¥çš„ç ”ç©¶å¯ä»¥ä»æ›´å¾®è§‚çš„å±‚é¢æ·±å…¥å‰–æå¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„å†…åœ¨æœºç†ï¼Œæ¢ç©¶ä¸åŒä¸ªä½“ä¹‹é—´æ¶ˆè´¹å·®å¼‚çš„å…·ä½“åŸå› ï¼›ä¹Ÿå¯ä»¥ç€çœ¼äºå…¨çƒè§†é‡ï¼Œå¯¹æ¯”å›½å†…å¤–å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹ç°è±¡çš„å¼‚åŒå’Œå‘å±•è¶‹åŠ¿ï¼›æ­¤å¤–ï¼Œè¿˜å¯ä»¥æ¢è®¨å¦‚ä½•ç»“åˆæ–°æŠ€æœ¯åº”ç”¨ï¼Œå¦‚å¤§æ•°æ®ã€äººå·¥æ™ºèƒ½ç­‰ï¼Œæ›´å¥½åœ°ç†è§£å’Œå¼•å¯¼å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºã€‚</span><br></pre></td></tr></table></figure><h2 id="å¤šé“¾ç»„åˆ">å¤šé“¾ç»„åˆ</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains import LLMChain, SequentialChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi import Tongyi</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts import ChatPromptTemplate</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­é“¾1</span></span><br><span class="line"><span class="comment"># promptæ¨¡æ¿ 1: ç¿»è¯‘æˆè‹±è¯­ï¼ˆæŠŠä¸‹é¢çš„reviewç¿»è¯‘æˆè‹±è¯­ï¼‰</span></span><br><span class="line">first_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;æŠŠä¸‹é¢çš„è¯„è®ºreviewç¿»è¯‘æˆä¸­æ–‡:&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\n&#123;Review&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 1: è¾“å…¥ï¼šReview    è¾“å‡ºï¼šä¸­æ–‡çš„ Review</span></span><br><span class="line">chain_one = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=first_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;Chinese_Review&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­é“¾2</span></span><br><span class="line"><span class="comment"># promptæ¨¡æ¿ 2: ç”¨ä¸€å¥è¯æ€»ç»“ä¸‹é¢çš„ review</span></span><br><span class="line">second_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;è¯·ä½ ç”¨ä¸€å¥è¯æ¥æ€»ç»“ä¸‹é¢çš„è¯„è®ºreview:&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\n&#123;Chinese_Review&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 2: è¾“å…¥ï¼šä¸­æ–‡çš„Review   è¾“å‡ºï¼šæ€»ç»“</span></span><br><span class="line">chain_two = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=second_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;summary&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­é“¾3</span></span><br><span class="line"><span class="comment"># promptæ¨¡æ¿ 3: ä¸‹é¢reviewä½¿ç”¨çš„ä»€ä¹ˆè¯­è¨€</span></span><br><span class="line">third_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;ä¸‹é¢çš„è¯„è®ºreviewä½¿ç”¨çš„ä»€ä¹ˆè¯­è¨€:\n\n&#123;Review&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 3: è¾“å…¥ï¼šReview  è¾“å‡ºï¼šè¯­è¨€</span></span><br><span class="line">chain_three = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=third_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;language&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­é“¾4</span></span><br><span class="line"><span class="comment"># promptæ¨¡æ¿ 4: ä½¿ç”¨ç‰¹å®šçš„è¯­è¨€å¯¹ä¸‹é¢çš„æ€»ç»“å†™ä¸€ä¸ªåç»­å›å¤</span></span><br><span class="line">fourth_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;ä½¿ç”¨ç‰¹å®šçš„è¯­è¨€å¯¹ä¸‹é¢çš„æ€»ç»“å†™ä¸€ä¸ªåç»­å›å¤:&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\næ€»ç»“: &#123;summary&#125;\n\nè¯­è¨€: &#123;language&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 4: è¾“å…¥ï¼š æ€»ç»“, è¯­è¨€    è¾“å‡ºï¼š åç»­å›å¤</span></span><br><span class="line">chain_four = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=fourth_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;followup_message&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¾“å…¥ï¼šreview</span></span><br><span class="line"><span class="comment">#è¾“å‡ºï¼šä¸­æ–‡reviewï¼Œæ€»ç»“ï¼Œåç»­å›å¤</span></span><br><span class="line">overall_chain = SequentialChain(</span><br><span class="line">    chains=[chain_one, chain_two, chain_three, chain_four],</span><br><span class="line">    input_variables=[<span class="string">&quot;Review&quot;</span>],</span><br><span class="line">    output_variables=[<span class="string">&quot;Chinese_Review&quot;</span>, <span class="string">&quot;summary&quot;</span>, <span class="string">&quot;followup_message&quot;</span>, <span class="string">&quot;language&quot;</span>],</span><br><span class="line">    <span class="attribute">verbose</span>=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    text = input(<span class="string">&quot;è¯·è¾“å…¥å†…å®¹ï¼š&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(overall_chain.invoke(&#123;<span class="string">&quot;Review&quot;</span>: text&#125;))</span><br></pre></td></tr></table></figure><p><img src="https://s11.ax1x.com/2024/02/24/pFUftjf.png" alt=""></p><h2 id="è·¯ç”±é“¾">è·¯ç”±é“¾</h2><ul><li>å‰é¢çš„é“¾çš„è¾“å…¥é¡ºåºåŸºæœ¬ä¸Šéƒ½æ˜¯å›ºå®šçš„ï¼Œå¦‚æœæƒ³åšæ›´å¤æ‚çš„äº‹æƒ…ï¼Œå°±éœ€è¦æ ¹æ®è¾“å…¥å°†å…¶è·¯ç”±åˆ°ç‰¹å®šçš„é“¾ã€‚å‡è®¾ä½ æœ‰å¤šä¸ªå­é“¾ï¼Œæ¯ä¸ªå­é“¾éƒ½ä¸“é—¨ç”¨äºç‰¹å®šç±»å‹çš„è¾“å…¥ï¼Œé‚£ä¹ˆå¯ä»¥ç»„æˆä¸€ä¸ªè·¯ç”±é“¾</li><li>è·¯ç”±å™¨ç”±ä¸¤ä¸ªç»„ä»¶ç»„æˆï¼š<ol><li>è·¯ç”±é“¾ï¼ˆRouter Chainï¼‰ï¼šè·¯ç”±å™¨é“¾æœ¬èº«ï¼Œè´Ÿè´£é€‰æ‹©è¦è°ƒç”¨çš„ä¸‹ä¸€ä¸ªé“¾</li><li>destination_chainsï¼šè·¯ç”±å™¨é“¾å¯ä»¥è·¯ç”±åˆ°çš„é“¾</li></ol></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain, MultiPromptChain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.router.llm_router <span class="keyword">import</span> RouterOutputParser, LLMRouterChain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.router.multi_prompt_prompt <span class="keyword">import</span> MULTI_PROMPT_ROUTER_TEMPLATE</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi <span class="keyword">import</span> Tongyi</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate, PromptTemplate</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å¤šç§æç¤ºæ¨¡æ¿</span></span><br><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªæç¤ºé€‚åˆå›ç­”ç‰©ç†é—®é¢˜</span></span><br><span class="line">physics_template = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªéå¸¸èªæ˜çš„ç‰©ç†ä¸“å®¶ã€‚ \</span></span><br><span class="line"><span class="string">ä½ æ“…é•¿ç”¨ä¸€ç§ç®€æ´å¹¶ä¸”æ˜“äºç†è§£çš„æ–¹å¼å»å›ç­”é—®é¢˜ã€‚\</span></span><br><span class="line"><span class="string">å½“ä½ ä¸çŸ¥é“é—®é¢˜çš„ç­”æ¡ˆæ—¶ï¼Œä½ æ‰¿è®¤\</span></span><br><span class="line"><span class="string">ä½ ä¸çŸ¥é“.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿™æ˜¯ä¸€ä¸ªé—®é¢˜:</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒä¸ªæç¤ºé€‚åˆå›ç­”æ•°å­¦é—®é¢˜</span></span><br><span class="line">math_template = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„æ•°å­¦å®¶ã€‚ \</span></span><br><span class="line"><span class="string">ä½ æ“…é•¿å›ç­”æ•°å­¦é—®é¢˜ã€‚ \</span></span><br><span class="line"><span class="string">ä½ ä¹‹æ‰€ä»¥å¦‚æ­¤ä¼˜ç§€ï¼Œ \</span></span><br><span class="line"><span class="string">æ˜¯å› ä¸ºä½ èƒ½å¤Ÿå°†æ£˜æ‰‹çš„é—®é¢˜åˆ†è§£ä¸ºç»„æˆéƒ¨åˆ†ï¼Œ\</span></span><br><span class="line"><span class="string">å›ç­”ç»„æˆéƒ¨åˆ†ï¼Œç„¶åå°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ï¼Œå›ç­”æ›´å¹¿æ³›çš„é—®é¢˜ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿™æ˜¯ä¸€ä¸ªé—®é¢˜ï¼š</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬ä¸‰ä¸ªé€‚åˆå›ç­”å†å²é—®é¢˜</span></span><br><span class="line">history_template = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä»¥ä¸ºéå¸¸ä¼˜ç§€çš„å†å²å­¦å®¶ã€‚ \</span></span><br><span class="line"><span class="string">ä½ å¯¹ä¸€ç³»åˆ—å†å²æ—¶æœŸçš„äººç‰©ã€äº‹ä»¶å’ŒèƒŒæ™¯æœ‰ç€æå¥½çš„å­¦è¯†å’Œç†è§£\</span></span><br><span class="line"><span class="string">ä½ æœ‰èƒ½åŠ›æ€è€ƒã€åæ€ã€è¾©è¯ã€è®¨è®ºå’Œè¯„ä¼°è¿‡å»ã€‚\</span></span><br><span class="line"><span class="string">ä½ å°Šé‡å†å²è¯æ®ï¼Œå¹¶æœ‰èƒ½åŠ›åˆ©ç”¨å®ƒæ¥æ”¯æŒä½ çš„è§£é‡Šå’Œåˆ¤æ–­ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿™æ˜¯ä¸€ä¸ªé—®é¢˜:</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬å››ä¸ªé€‚åˆå›ç­”è®¡ç®—æœºé—®é¢˜</span></span><br><span class="line">computerscience_template = <span class="string">&quot;&quot;&quot; ä½ æ˜¯ä¸€ä¸ªæˆåŠŸçš„è®¡ç®—æœºç§‘å­¦ä¸“å®¶ã€‚\</span></span><br><span class="line"><span class="string">ä½ æœ‰åˆ›é€ åŠ›ã€åä½œç²¾ç¥ã€\</span></span><br><span class="line"><span class="string">å‰ç»æ€§æ€ç»´ã€è‡ªä¿¡ã€è§£å†³é—®é¢˜çš„èƒ½åŠ›ã€\</span></span><br><span class="line"><span class="string">å¯¹ç†è®ºå’Œç®—æ³•çš„ç†è§£ä»¥åŠå‡ºè‰²çš„æ²Ÿé€šæŠ€å·§ã€‚\</span></span><br><span class="line"><span class="string">ä½ éå¸¸æ“…é•¿å›ç­”ç¼–ç¨‹é—®é¢˜ã€‚\</span></span><br><span class="line"><span class="string">ä½ ä¹‹æ‰€ä»¥å¦‚æ­¤ä¼˜ç§€ï¼Œæ˜¯å› ä¸ºä½ çŸ¥é“  \</span></span><br><span class="line"><span class="string">å¦‚ä½•é€šè¿‡ä»¥æœºå™¨å¯ä»¥è½»æ¾è§£é‡Šçš„å‘½ä»¤å¼æ­¥éª¤æè¿°è§£å†³æ–¹æ¡ˆæ¥è§£å†³é—®é¢˜ï¼Œ\</span></span><br><span class="line"><span class="string">å¹¶ä¸”ä½ çŸ¥é“å¦‚ä½•é€‰æ‹©åœ¨æ—¶é—´å¤æ‚æ€§å’Œç©ºé—´å¤æ‚æ€§ä¹‹é—´å–å¾—è‰¯å¥½å¹³è¡¡çš„è§£å†³æ–¹æ¡ˆã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿™è¿˜æ˜¯ä¸€ä¸ªé—®é¢˜ï¼š</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºæ¯ä¸ªæ¨¡æ¿å‘½åï¼Œå¹¶ä¸”ç»™å‡ºå…·ä½“æè¿°ï¼Œå°†è¿™äº›ä¿¡æ¯ä¼ é€’ç»™è·¯ç”±é“¾ï¼Œè·¯ç”±é“¾å†³å®šä½•æ—¶è°ƒç”¨å­é“¾</span></span><br><span class="line">prompt_infos = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;åå­—&quot;</span>: <span class="string">&quot;ç‰©ç†å­¦&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æè¿°&quot;</span>: <span class="string">&quot;æ“…é•¿å›ç­”å…³äºç‰©ç†å­¦çš„é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>: physics_template</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;åå­—&quot;</span>: <span class="string">&quot;æ•°å­¦&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æè¿°&quot;</span>: <span class="string">&quot;æ“…é•¿å›ç­”æ•°å­¦é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>: math_template</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;åå­—&quot;</span>: <span class="string">&quot;å†å²&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æè¿°&quot;</span>: <span class="string">&quot;æ“…é•¿å›ç­”å†å²é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>: history_template</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;åå­—&quot;</span>: <span class="string">&quot;è®¡ç®—æœºç§‘å­¦&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æè¿°&quot;</span>: <span class="string">&quot;æ“…é•¿å›ç­”è®¡ç®—æœºç§‘å­¦é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>: computerscience_template</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸºäºæç¤ºæ¨¡ç‰ˆä¿¡æ¯åˆ›å»ºç›¸åº”ç›®æ ‡é“¾</span></span><br><span class="line">destination_chains = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> p_info <span class="keyword">in</span> prompt_infos:</span><br><span class="line">    name = p_info[<span class="string">&quot;åå­—&quot;</span>]</span><br><span class="line">    prompt_template = p_info[<span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>]</span><br><span class="line">    prompt = ChatPromptTemplate.from_template(template=prompt_template)</span><br><span class="line">    chain = LLMChain(llm=llm, prompt=prompt)</span><br><span class="line">    destination_chains[name] = chain</span><br><span class="line"></span><br><span class="line">destinations = [<span class="string">f&quot;<span class="subst">&#123;p[<span class="string">&#x27;åå­—&#x27;</span>]&#125;</span>: <span class="subst">&#123;p[<span class="string">&#x27;æè¿°&#x27;</span>]&#125;</span>&quot;</span> <span class="keyword">for</span> p <span class="keyword">in</span> prompt_infos]</span><br><span class="line">destinations_str = <span class="string">&quot;\n&quot;</span>.join(destinations)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºé»˜è®¤ç›®æ ‡é“¾ï¼Œå½“è·¯ç”±å™¨æ— æ³•å†³å®šä½¿ç”¨å“ªä¸ªå­é“¾æ—¶è°ƒç”¨çš„é“¾ã€‚</span></span><br><span class="line">default_prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&#123;input&#125;&quot;</span>)</span><br><span class="line">default_chain = LLMChain(llm=llm, prompt=default_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºè·¯ç”±é“¾</span></span><br><span class="line">router_template = MULTI_PROMPT_ROUTER_TEMPLATE.<span class="built_in">format</span>(destinations=destinations_str)</span><br><span class="line"></span><br><span class="line">router_prompt = PromptTemplate(</span><br><span class="line">    template=router_template,</span><br><span class="line">    input_variables=[<span class="string">&quot;input&quot;</span>],</span><br><span class="line">    output_parser=RouterOutputParser(),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">router_chain = LLMRouterChain.from_llm(llm, router_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºæ•´ä½“é“¾è·¯</span></span><br><span class="line">chain = MultiPromptChain(router_chain=router_chain,  <span class="comment"># è·¯ç”±é“¾è·¯</span></span><br><span class="line">                         destination_chains=destination_chains,  <span class="comment"># ç›®æ ‡é“¾è·¯</span></span><br><span class="line">                         default_chain=default_chain,  <span class="comment"># é»˜è®¤é“¾è·¯</span></span><br><span class="line">                         verbose=<span class="literal">True</span></span><br><span class="line">                         )</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    que = <span class="built_in">input</span>(<span class="string">&quot;è¯·è¾“å…¥é—®é¢˜ï¼š&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: que&#125;))</span><br></pre></td></tr></table></figure><ul><li>åç»­æˆ‘ä»¬å¯ä»¥é¢„å®šä¹‰éå¸¸å¤šçš„promptï¼Œç„¶åé€šè¿‡è·¯ç”±é“¾æ¥è¿›è¡Œä»»åŠ¡åˆ†å‘ï¼Œå°½å¯èƒ½æŠŠä»»åŠ¡ç»†åˆ†ï¼Œè¿™æ ·å‡ºç°é—®é¢˜æ—¶ï¼Œåªéœ€è¦å…³æ³¨å¯¹åº”çš„æŸä¸€ä¸ªpromptï¼Œè€Œä¸éœ€è¦æ•´ä½“çš„æ”¹åŠ¨ã€‚</li></ul><h1>ä»£ç†çš„æ¦‚å¿µï¼ˆè¡¥å……ï¼‰</h1><ul><li><p>å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰éå¸¸å¼ºå¤§ï¼Œä½†å®ƒä»¬ç¼ºä¹â€œæœ€ç¬¨â€çš„è®¡ç®—æœºç¨‹åºå¯ä»¥è½»æ¾å¤„ç†çš„ç‰¹å®šèƒ½åŠ›ã€‚LLM å¯¹é€»è¾‘æ¨ç†ã€è®¡ç®—å’Œæ£€ç´¢å¤–éƒ¨ä¿¡æ¯çš„èƒ½åŠ›è¾ƒå¼±ï¼Œè¿™ä¸æœ€ç®€å•çš„è®¡ç®—æœºç¨‹åºå½¢æˆå¯¹æ¯”ã€‚ä¾‹å¦‚ï¼Œè¯­è¨€æ¨¡å‹æ— æ³•å‡†ç¡®å›ç­”ç®€å•çš„è®¡ç®—é—®é¢˜ï¼Œè¿˜æœ‰å½“è¯¢é—®æœ€è¿‘å‘ç”Ÿçš„äº‹ä»¶æ—¶ï¼Œå…¶å›ç­”ä¹Ÿå¯èƒ½è¿‡æ—¶æˆ–é”™è¯¯ï¼Œå› ä¸ºæ— æ³•ä¸»åŠ¨è·å–æœ€æ–°ä¿¡æ¯ã€‚è¿™æ˜¯ç”±äºå½“å‰è¯­è¨€æ¨¡å‹ä»…ä¾èµ–é¢„è®­ç»ƒæ•°æ®ï¼Œä¸å¤–ç•Œâ€œæ–­å¼€â€ã€‚è¦å…‹æœè¿™ä¸€ç¼ºé™·ï¼ŒLangChainæ¡†æ¶æå‡ºäº†â€œä»£ç†â€(Agent)çš„è§£å†³æ–¹æ¡ˆã€‚</p></li><li><p>ä»£ç†ä½œä¸ºè¯­è¨€æ¨¡å‹çš„å¤–éƒ¨æ¨¡å—ï¼Œå¯æä¾›è®¡ç®—ã€é€»è¾‘ã€æ£€ç´¢ç­‰åŠŸèƒ½çš„æ”¯æŒï¼Œä½¿è¯­è¨€æ¨¡å‹è·å¾—å¼‚å¸¸å¼ºå¤§çš„æ¨ç†å’Œè·å–ä¿¡æ¯çš„è¶…èƒ½åŠ›ã€‚</p></li><li><p>è¦ä½¿ç”¨ä»£ç† (Agents) ï¼Œæˆ‘ä»¬éœ€è¦ä¸‰æ ·ä¸œè¥¿ï¼š</p><ol><li>ä¸€ä¸ªåŸºæœ¬çš„ LLM</li><li>æˆ‘ä»¬å°†è¦è¿›è¡Œäº¤äº’çš„å·¥å…· Tools</li><li>ä¸€ä¸ªæ§åˆ¶äº¤äº’çš„ä»£ç† (Agents) ã€‚</li></ol><ul><li>ç°åœ¨å°è¯•ä½¿ç”¨ä»£ç†æ¥è§£å†³æ•°å­¦é—®é¢˜</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> load_tools, initialize_agent, AgentType</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi <span class="keyword">import</span> Tongyi</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line">tools = load_tools(</span><br><span class="line">    [<span class="string">&quot;llm-math&quot;</span>, <span class="string">&quot;wikipedia&quot;</span>],</span><br><span class="line">    llm=llm</span><br><span class="line">)</span><br><span class="line">agent = initialize_agent(</span><br><span class="line">    tools,  <span class="comment"># ç¬¬äºŒæ­¥åŠ è½½çš„å·¥å…·</span></span><br><span class="line">    llm,  <span class="comment"># ç¬¬ä¸€æ­¥åˆå§‹åŒ–çš„æ¨¡å‹</span></span><br><span class="line">    agent=AgentType.CHAT_ZERO_SHOT_REACT_DESCRIPTION,  <span class="comment"># ä»£ç†ç±»å‹</span></span><br><span class="line">    handle_parsing_errors=<span class="literal">True</span>,  <span class="comment"># å¤„ç†è§£æé”™è¯¯</span></span><br><span class="line">    verbose=<span class="literal">True</span>  <span class="comment"># è¾“å‡ºä¸­é—´æ­¥éª¤</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">agent.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;2084çš„25%æ˜¯å¤šå°‘ï¼Ÿè¿˜æœ‰ï¼Œä½ çŸ¥é“Palworldè¿™æ¬¾æ¸¸æˆå—&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></li><li><p>è¾“å‡º</p><blockquote><p>Thought: ç¬¬ä¸€ä¸ªé—®é¢˜éœ€è¦è®¡ç®—2084çš„25%ï¼Œå¯ä»¥ä½¿ç”¨è®¡ç®—å™¨å·¥å…·ï¼›ç¬¬äºŒä¸ªé—®é¢˜è¯¢é—®å…³äºPalworldè¿™æ¬¾æ¸¸æˆçš„ä¿¡æ¯ï¼Œéœ€è¦ç”¨åˆ°Wikipediaå·¥å…·ã€‚</p><p>Action:</p> <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Calculator&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;action_input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2084 * 25%&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Observation: Answer: 521.0<br>Thought:å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘éœ€è¦ä½¿ç”¨Wikipediaå·¥å…·æ¥æŸ¥è¯¢Palworldè¿™æ¬¾æ¸¸æˆçš„ä¿¡æ¯ã€‚<br>Action:</p> <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wikipedia&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;action_input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Palworld&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Observation: Page: Palworld<br>Summary: Palworld is an action-adventure survival game by Japanese developer Pocket Pair. The game is set in an open world populated with animal-like creatures known as â€œPalsâ€. The players can battle and capture Pals in order to use them for base building, traversal, and combat. Palworld can be played either solo, or online by up to 32 players on one server. Announced in 2021, it was launched via early access for Windows, Xbox One, and Xbox Series X/S in January 2024.<br>The gameâ€™s comedic premise, which involves using firearms and equipping Pals with them, earned it the nickname â€œPokÃ©mon with gunsâ€. Other elements, such as using creatures for food or placing them to work in mines and factories, have also garnered attention. It was generally well received, with praise for its gameplay, content, and satirical premise, but criticism for its reliance on shock humor and use of unoriginal designs and mechanics.Palworld sold eight million units in the first six days of early access and reached two million concurrent players on Steam, making it the second-highest played game of all time on the platform.</p><p>Page: Brotato<br>Summary: Brotato is a 2023 shoot 'em up video game created by French independent developer Thomas Gervraud under the studio name Blobfish. It was first released via Steam early access in 2022, during which it sold over one million copies. Brotato received positive reviews from critics and players, and it was later ported to multiple platforms.</p><p>Page: List of video games in development<br>Summary: This is a confirmed list of video games in development, but are scheduled for release beyond 2024 or currently carry no release date at all.</p></blockquote></li><li><p>æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„æµç¨‹<br><img src="https://s11.ax1x.com/2024/02/24/pFUfYgP.png" alt=""></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;ä»€ä¹ˆæ˜¯LangChain&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;LangChainæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘äººå‘˜ä½¿ç”¨è¯­è¨€æ¨¡å‹æ„å»ºç«¯åˆ°ç«¯çš„åº”ç”¨ç¨‹åºã€‚å®ƒæä¾›äº†ä¸€å¥—å·¥å…·ã€ç»„ä»¶å’Œæ¥å£ï¼Œå¯ç®€åŒ–åˆ›å»ºç”±å¤§å‹è¯­è¨€æ¨¡å‹ (LLM) å’ŒèŠå¤©æ¨¡å‹æä¾›æ”¯æŒçš„åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ã€‚LangChain å¯ä»¥è½»æ¾</summary>
      
    
    
    
    <category term="å®ç”¨æ•™ç¨‹" scheme="https://cyborg2077.github.io/categories/%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="LangChain" scheme="https://cyborg2077.github.io/tags/LangChain/"/>
    
  </entry>
  
  <entry>
    <title>SELECT FOR UPDATEçš„é”ç²’åº¦</title>
    <link href="https://cyborg2077.github.io/2023/12/31/SelectForUpdate/"/>
    <id>https://cyborg2077.github.io/2023/12/31/SelectForUpdate/</id>
    <published>2023-12-31T14:59:55.000Z</published>
    <updated>2024-01-14T12:06:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>åœ¨æ•°æ®åº“äº‹åŠ¡å¤„ç†ä¸­ï¼Œå¤„ç†æ•°æ®åº“å¹¶å‘è®¿é—®çš„è¯·æ±‚ä¸€ä¸ªå¤æ‚ä¸”é‡è¦çš„é—®é¢˜ï¼Œå½“å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®å¹¶å°è¯•ä¿®æ”¹åŒä¸€è¡Œæ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œä¾‹å¦‚ä¸¢å¤±æ›´æ–°æˆ–è„è¯»çš„æƒ…å†µã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ•°æ®åº“æä¾›äº†ä¸€äº›æœºå¤„ç†å¹¶å‘äº‹åŠ¡ï¼Œå…¶ä¸­ä¹‹ä¸€ä¾¿æ˜¯<code>SELECT ... FOR UPDATE</code>è¯­å¥ã€‚</li><li>åœ¨å¹¶å‘è®¿é—®çš„ç¯å¢ƒä¸­ï¼Œ<code>SELECT ... FOR UPDATE</code>å…è®¸äº‹åŠ¡åœ¨é€‰æ‹©æ•°æ®çš„åŒæ—¶ï¼Œé”å®šè¿™äº›æ•°æ®ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡<code>ä¿®æ”¹</code>è¿™äº›æ•°æ®ï¼Œç›´åˆ°å½“å‰äº‹åŠ¡å®Œæˆå¹¶é‡Šæ”¾é”ã€‚ä»æœ¬è´¨ä¸Šï¼Œ<code>SELECT ... FOR UPDATE</code>æ˜¯ä¸€ç§æ‚²é”çš„ç”¨æ³•ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªä¼šé”ä½ä¸€è¡Œæ•°æ®ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰æ­£ç¡®ä½¿ç”¨çš„è¯ï¼Œä¼šæŠŠæ•´å¼ è¡¨éƒ½é”ä½çš„ã€‚</li><li>æˆ‘ä¹Ÿåœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨è¿‡ï¼Œä¾‹å¦‚å…è´¹å­—æ•°æŠµæ‰£é‡‘é¢ä¸‹å•çš„åœºæ™¯ã€‚</li></ul><h1>å®è·µ</h1><ul><li>è™½ç„¶åœ¨MySQLä¸­æ˜¯é€šè¿‡<code>SELECT ... FOR UPDATE</code>è¯­å¥æ¥å®ç°çš„è¡Œé”çš„åŠŸèƒ½ã€‚ä½†æ˜¯å¦‚æœä½ åœ¨å®é™…å·¥ä½œä¸­ä½¿ç”¨ä¸æ­£ç¡®ï¼Œä¹Ÿå®¹æ˜“æŠŠæ•´å¼ è¡¨é”ä½ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚<code>SELECT ... FOR UPDATE</code>è¯­å¥çš„ç”¨æ³•æ˜¯å¦æ­£ç¡®ï¼Œè·Ÿ<code>WHEREæ¡ä»¶</code>ä¸­çš„å‚æ•°æœ‰å¾ˆå¤§çš„å…³ç³»ã€‚æˆ‘ä»¬å…ˆæ¥ç®€å•å»ºä¸ªè¡¨ï¼Œç„¶ååˆ†æä¸€ä¸‹ä¸‹é¢å‡ ç§æƒ…å†µã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_info (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,             <span class="comment">-- ä¸»é”®</span></span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">UNIQUE</span>,   <span class="comment">-- å”¯ä¸€ç´¢å¼•</span></span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,    <span class="comment">-- æ™®é€šç´¢å¼•</span></span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),          <span class="comment">-- æ™®é€šå­—æ®µ</span></span><br><span class="line">    INDEX idx_email (email)         </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_info (id, username, email, amount)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">1</span>, <span class="string">&#x27;john_doe&#x27;</span>, <span class="string">&#x27;john.doe@example.com&#x27;</span>, <span class="number">500.00</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="string">&#x27;alice_smith&#x27;</span>, <span class="string">&#x27;alice.smith@example.com&#x27;</span>, <span class="number">1000.00</span>),</span><br><span class="line">  (<span class="number">3</span>, <span class="string">&#x27;bob_jones&#x27;</span>, <span class="string">&#x27;bob.jones@example.com&#x27;</span>, <span class="number">1500.00</span>),</span><br><span class="line">  (<span class="number">4</span>, <span class="string">&#x27;lisa_davis&#x27;</span>, <span class="string">&#x27;lisa.davis@example.com&#x27;</span>, <span class="number">2000.00</span>),</span><br><span class="line">  (<span class="number">5</span>, <span class="string">&#x27;charlie_brown&#x27;</span>, <span class="string">&#x27;charlie.brown@example.com&#x27;</span>, <span class="number">2500.00</span>);</span><br></pre></td></tr></table></figure><h2 id="ä¸»é”®å­—æ®µ">ä¸»é”®å­—æ®µ</h2><ul><li>å½“<code>WHERE</code>æ¡ä»¶ä½¿ç”¨ä¸»é”®æ—¶</li></ul><div class="tabs" id="ä¸»é”®"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä¸»é”®-1">äº‹åŠ¡ä¸€</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-2">äº‹åŠ¡äºŒ</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-3">äº‹åŠ¡ä¸‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä¸»é”®-1"><ul><li>åœ¨äº‹åŠ¡ä¸€ä¸­ä½¿ç”¨<code>FOR UPDATE</code>ï¼ŒåŠ ä¸€ä¸ªè¡Œé”ï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰<code>COMMIT</code>æäº¤äº‹åŠ¡</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;  <span class="comment">-- å¼€å¯äº‹åŠ¡</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;  <span class="comment">-- åŠ è¡Œé”</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-2"><ul><li>åœ¨äº‹åŠ¡äºŒä¸­å°è¯•ä¿®æ”¹è¯¥è¡Œï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡ä¸€é‡Šæ”¾é”ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœäº‹åŠ¡ä¸€ï¼Œä¸€ç›´éƒ½ä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆäº‹åŠ¡äºŒæœ€ç»ˆä¼šæŠ¥è¿™ä¸ªå¼‚å¸¸</li></ul><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 10000 WHERE id = 1</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1205</span> - <span class="title class_">Lock</span> wait timeout exceeded; <span class="keyword">try</span> restarting transaction</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">æŸ¥è¯¢æ—¶é—´: <span class="number">50.</span>086s</span></span><br></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡ä¸€æäº¤äº‹åŠ¡åï¼Œäº‹åŠ¡äºŒæ‰èƒ½æ­£å¸¸æ‰§è¡Œ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-3"><ul><li>å¦‚æœæ­¤æ—¶å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¸‰ï¼Œä¿®æ”¹å…¶ä»–è¡Œçš„å€¼ï¼Œé‚£ä¹ˆæ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 10000 WHERE id = 2</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="title class_">Affected</span> <span class="attr">rows</span>: <span class="number">1</span></span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">æŸ¥è¯¢æ—¶é—´: <span class="number">0.</span>009s</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="å”¯ä¸€ç´¢å¼•">å”¯ä¸€ç´¢å¼•</h2><ul><li>å½“<code>WHERE</code>æ¡ä»¶ä½¿ç”¨å”¯ä¸€ç´¢å¼•æ—¶</li></ul><div class="tabs" id="ä¸»é”®"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä¸»é”®-1">äº‹åŠ¡ä¸€</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-2">äº‹åŠ¡äºŒ</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-3">äº‹åŠ¡ä¸‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä¸»é”®-1"><ul><li>åœ¨äº‹åŠ¡ä¸€ä¸­ä½¿ç”¨<code>FOR UPDATE</code>ï¼ŒåŠ ä¸€ä¸ªè¡Œé”ï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰<code>COMMIT</code>æäº¤äº‹åŠ¡</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;john_doe&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-2"><ul><li>åœ¨äº‹åŠ¡äºŒä¸­å°è¯•ä¿®æ”¹è¯¥è¡Œï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡ä¸€é‡Šæ”¾é”ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;john_doe&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœäº‹åŠ¡ä¸€ï¼Œä¸€ç›´éƒ½ä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆäº‹åŠ¡äºŒæœ€ç»ˆä¼šæŠ¥è¿™ä¸ªå¼‚å¸¸</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount = <span class="number">10000</span> <span class="keyword">WHERE</span> username = <span class="string">&#x27;john_doe&#x27;</span></span><br><span class="line">&gt; <span class="number">1205</span> - <span class="keyword">Lock</span> wait timeout exceeded; try restarting <span class="keyword">transaction</span></span><br><span class="line">&gt; æŸ¥è¯¢æ—¶é—´: <span class="number">50.084</span>s</span><br></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡ä¸€æäº¤äº‹åŠ¡åï¼Œäº‹åŠ¡äºŒæ‰èƒ½æ­£å¸¸æ‰§è¡Œ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-3"><ul><li>å¦‚æœæ­¤æ—¶å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¸‰ï¼Œä¿®æ”¹å…¶ä»–è¡Œçš„å€¼ï¼Œé‚£ä¹ˆæ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice_smith&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice_smith&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> Affected <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line"><span class="operator">&gt;</span> æŸ¥è¯¢æ—¶é—´: <span class="number">0.002</span>s</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="æ™®é€šç´¢å¼•">æ™®é€šç´¢å¼•</h2><ul><li>å½“<code>WHERE</code>æ¡ä»¶ä½¿ç”¨æ™®é€šç´¢å¼•æ—¶</li></ul><div class="tabs" id="ä¸»é”®"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä¸»é”®-1">äº‹åŠ¡ä¸€</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-2">äº‹åŠ¡äºŒ</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-3">äº‹åŠ¡ä¸‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä¸»é”®-1"><ul><li>åœ¨äº‹åŠ¡ä¸€ä¸­ä½¿ç”¨<code>FOR UPDATE</code>ï¼ŒåŠ ä¸€ä¸ªè¡Œé”ï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰<code>COMMIT</code>æäº¤äº‹åŠ¡</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;john.doe@example.com&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-2"><ul><li>åœ¨äº‹åŠ¡äºŒä¸­å°è¯•ä¿®æ”¹è¯¥è¡Œï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡ä¸€é‡Šæ”¾é”ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;john.doe@example.com&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœäº‹åŠ¡ä¸€ï¼Œä¸€ç›´éƒ½ä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆäº‹åŠ¡äºŒæœ€ç»ˆä¼šæŠ¥è¿™ä¸ªå¼‚å¸¸</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount = <span class="number">1000</span> <span class="keyword">WHERE</span> email = <span class="string">&#x27;john.doe@example.com&#x27;</span></span><br><span class="line">&gt; <span class="number">1205</span> - <span class="keyword">Lock</span> wait timeout exceeded; try restarting <span class="keyword">transaction</span></span><br><span class="line">&gt; æŸ¥è¯¢æ—¶é—´: <span class="number">50.082</span>s</span><br></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡ä¸€æäº¤äº‹åŠ¡åï¼Œäº‹åŠ¡äºŒæ‰èƒ½æ­£å¸¸æ‰§è¡Œ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-3"><ul><li>å¦‚æœæ­¤æ—¶å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¸‰ï¼Œä¿®æ”¹å…¶ä»–è¡Œçš„å€¼ï¼Œé‚£ä¹ˆæ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;alice.smith@example.com&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;alice.smith@example.com&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> Affected <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line"><span class="operator">&gt;</span> æŸ¥è¯¢æ—¶é—´: <span class="number">0.003</span>s</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="æ™®é€šå­—æ®µ">æ™®é€šå­—æ®µ</h2><ul><li>å½“<code>WHERE</code>æ¡ä»¶ä½¿ç”¨æ™®é€šå­—æ®µæ—¶</li></ul><div class="tabs" id="ä¸»é”®"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä¸»é”®-1">äº‹åŠ¡ä¸€</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-2">äº‹åŠ¡äºŒ</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-3">äº‹åŠ¡ä¸‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä¸»é”®-1"><ul><li>åœ¨äº‹åŠ¡ä¸€ä¸­ä½¿ç”¨<code>FOR UPDATE</code>ï¼ŒåŠ ä¸€ä¸ªè¡Œé”ï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰<code>COMMIT</code>æäº¤äº‹åŠ¡</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> amount <span class="operator">=</span> <span class="number">2500</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-2"><ul><li>åœ¨äº‹åŠ¡äºŒä¸­å°è¯•ä¿®æ”¹è¯¥è¡Œï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡ä¸€é‡Šæ”¾é”ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> amount <span class="operator">=</span> <span class="number">2500</span>;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœäº‹åŠ¡ä¸€ï¼Œä¸€ç›´éƒ½ä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆäº‹åŠ¡äºŒæœ€ç»ˆä¼šæŠ¥è¿™ä¸ªå¼‚å¸¸</li></ul><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 1000 WHERE amount = 2500</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1205</span> - <span class="title class_">Lock</span> wait timeout exceeded; <span class="keyword">try</span> restarting transaction</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">æŸ¥è¯¢æ—¶é—´: <span class="number">50.</span>17s</span></span><br></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡ä¸€æäº¤äº‹åŠ¡åï¼Œäº‹åŠ¡äºŒæ‰èƒ½æ­£å¸¸æ‰§è¡Œ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-3"><ul><li>å¦‚æœæ­¤æ—¶å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¸‰ï¼Œä¿®æ”¹å…¶ä»–è¡Œçš„å€¼ï¼Œä¼šå‘ç°ä¹Ÿæ˜¯è¢«é˜»å¡äº†çš„</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> amount <span class="operator">=</span> <span class="number">2000</span>;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 1000 WHERE amount = 2000</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1205</span> - <span class="title class_">Lock</span> wait timeout exceeded; <span class="keyword">try</span> restarting transaction</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">æŸ¥è¯¢æ—¶é—´: <span class="number">50.</span>083s</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1>ç»“è®º</h1><ul><li>æ€»ç»“ä¸€ä¸‹<code>SELECT ... FOR UPDATE</code>åŠ é”çš„æƒ…å†µï¼š<ul><li>ä¸»é”®å­—æ®µï¼šåŠ è¡Œé”ã€‚</li><li>å”¯ä¸€ç´¢å¼•å­—æ®µï¼šåŠ è¡Œé”ã€‚</li><li>æ™®é€šç´¢å¼•å­—æ®µï¼šåŠ è¡Œé”ã€‚</li><li>æ™®é€šå­—æ®µï¼šåŠ è¡¨é”ã€‚</li></ul></li><li>å¦‚æœäº‹åŠ¡ä¸€åŠ äº†<code>è¡Œé”</code>ï¼Œä¸€ç›´æ²¡æœ‰é‡Šæ”¾é”ï¼Œäº‹åŠ¡äºŒæ“ä½œç›¸åŒè¡Œçš„æ•°æ®æ—¶ï¼Œä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¶…æ—¶ã€‚</li><li>å¦‚æœäº‹åŠ¡ä¸€åŠ äº†<code>è¡¨é”</code>ï¼Œä¸€ç›´æ²¡æœ‰é‡Šæ”¾é”ï¼Œäº‹åŠ¡äºŒä¸ç®¡æ“ä½œçš„æ˜¯å“ªä¸€è¡Œæ•°æ®ï¼Œéƒ½ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¶…æ—¶ã€‚</li></ul>]]></content>
    
    
    <summary type="html">SELECT ... FOR UPDATE åˆ°åº•æ˜¯åŠ äº†è¡Œé”è¿˜æ˜¯è¡¨é”ï¼Ÿ</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://cyborg2077.github.io/tags/%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB/"/>
    
  </entry>
  
  <entry>
    <title>æ¨¡æ‹ŸChatGPTæµå¼æ•°æ®ä¼ è¾“--SSEæœ€ä½³å®è·µï¼ˆé™„å¯è¿è¡Œå®ä¾‹ï¼‰</title>
    <link href="https://cyborg2077.github.io/2023/11/25/ServerSendEvents/"/>
    <id>https://cyborg2077.github.io/2023/11/25/ServerSendEvents/</id>
    <published>2023-11-25T04:21:49.000Z</published>
    <updated>2024-08-17T05:29:03.613Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>åœ¨ä½¿ç”¨ChatGPTçš„æ—¶å€™ï¼Œå‘ç°è¾“å…¥promptåï¼Œæ˜¯ä½¿ç”¨æµå¼çš„æ•ˆæœè¿”å›æ•°æ®ï¼Œç»™ç”¨æˆ·çš„æ˜¯ä¸€ä¸ªæ‰“å­—æœºçš„æ•ˆæœã€‚æŸ¥çœ‹å…¶ç½‘ç»œè¯·æ±‚ï¼Œå‘ç°è¿™ä¸ªæ¥å£çš„é€šå“åº”ç±»å‹æ˜¯<code>text/event-stream</code>ï¼Œä¸€ç§åŸºäºEventStreamçš„äº‹ä»¶æµã€‚<br><img src="https://z1.ax1x.com/2023/11/25/piwzPk8.png" alt=""></li><li>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦è¿™æ ·ä¼ è¾“å‘¢ï¼Ÿä»ä½¿ç”¨åœºæ™¯ä¸Šæ¥è¯´ï¼ŒChatGPTæ˜¯ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ çš„å¤§å‹è¯­è¨€æ¨¡å‹ï¼Œå¤„ç†è‡ªç„¶è¯­è¨€éœ€è¦å¤§é‡çš„è®¡ç®—èµ„æºå’Œæ—¶é—´ï¼Œé‚£ä¹ˆå“åº”é€Ÿåº¦è‚¯å®šæ˜¯æ¯”ä¸€èˆ¬ä¸šåŠ¡è¦æ…¢çš„ï¼Œé‚£ä¹ˆæ¥å£ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œæ˜¾ç„¶ä¹Ÿä¸åˆé€‚ï¼Œé‚£ä¹ˆå¯¹äºè¿™ç§å¯¹è¯åœºæ™¯ï¼Œé‡‡ç”¨SSEæŠ€æœ¯è¾¹è®¡ç®—è¾¹è¿”å›ï¼Œé¿å…ç”¨æˆ·å› ä¸ºç­‰å¾…æ—¶é—´è¿‡é•¿è€Œå…³é—­é¡µé¢ã€‚</li></ul><h1>æ¦‚è¿°</h1><div class="note info no-icon flat"><p>SSE(Server Sent Event)ï¼Œç›´è¯‘ä¸ºæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨ä¸»åŠ¨å‘é€äº‹ä»¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥è·å–åˆ°æœåŠ¡å™¨å‘é€çš„äº‹ä»¶ã€‚</p></div><ul><li>å¸¸è§çš„HTTPäº¤äº’æ–¹å¼ä¸»è¦æ˜¯å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œç„¶åæœåŠ¡ç«¯å“åº”ï¼Œç„¶åä¸€æ¬¡æ€§è¯·æ±‚å®Œæ¯•ã€‚ä½†æ˜¯åœ¨SSEçš„ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œç„¶åå»ºç«‹SSEè¿æ¥ä¸€ç›´ä¿æŒï¼ŒæœåŠ¡ç«¯å°±å¯ä»¥è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚</li><li>SSEç®€å•æ¥è¯´å°±æ˜¯æœåŠ¡å™¨ä¸»åŠ¨å‘å‰ç«¯æ¨é€æ•°æ®çš„ä¸€ç§æŠ€æœ¯ï¼Œå®ƒæ˜¯å•å‘çš„ã€‚SSEé€‚ç”¨äºæ¶ˆæ¯æ¨é€ã€ç›‘æ§ç­‰åªéœ€è¦æœåŠ¡ç«¯æ¨é€æ•°æ®çš„åœºæ™¯ä¸­ã€‚</li></ul><h1>ç‰¹ç‚¹</h1><ul><li>æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€<ol><li>HTML5æ–°æ ‡å‡†ï¼Œç”¨äºä»æœåŠ¡ç«¯è¯•è¯•æ¨é€æ•°æ®åˆ°æµè§ˆå™¨ç«¯ã€‚</li><li>ç›´æ¥å»ºç«‹åœ¨å½“å‰HTTPè¿æ¥ä¸Šï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªHTTPé•¿è¿æ¥ã€‚</li></ol></li></ul><h1>SSEä¸WebSocketçš„åŒºåˆ«</h1><ul><li>SSEæ˜¯å•å·¥çš„ï¼Œåªèƒ½ç”±æœåŠ¡ç«¯æƒ³å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼Œè€ŒWebSocketæ˜¯åŒå·¥çš„</li></ul><table><thead><tr><th style="text-align:center">SSE</th><th style="text-align:center">WebScoket</th></tr></thead><tbody><tr><td style="text-align:center">http åè®®</td><td style="text-align:center">ç‹¬ç«‹çš„ websocket åè®®</td></tr><tr><td style="text-align:center">è½»é‡ï¼Œä½¿ç”¨ç®€å•</td><td style="text-align:center">ç›¸å¯¹å¤æ‚</td></tr><tr><td style="text-align:center">é»˜è®¤æ”¯æŒæ–­çº¿é‡è¿</td><td style="text-align:center">éœ€è¦è‡ªå·±å®ç°æ–­çº¿é‡è¿</td></tr><tr><td style="text-align:center">æ–‡æœ¬ä¼ è¾“</td><td style="text-align:center">äºŒè¿›åˆ¶ä¼ è¾“</td></tr><tr><td style="text-align:center">æ”¯æŒè‡ªå®šä¹‰å‘é€çš„æ¶ˆæ¯ç±»å‹</td><td style="text-align:center">-</td></tr></tbody></table><h1>SSEè§„èŒƒ</h1><ul><li>åœ¨HTML5ä¸­ï¼ŒæœåŠ¡ç«¯SSEä¸€èˆ¬è¦éµå¾ªä»¥ä¸‹è¦æ±‚<ol><li>è¯·æ±‚å¤´ï¼šå¼€å¯é•¿è¿æ¥ + æµå¼ä¼ é€’</li></ol>  <figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-<span class="keyword">Type</span>: <span class="type">text</span>/event-stream;charset=UTF<span class="number">-8</span></span><br><span class="line"><span class="keyword">Cache</span>-Control: no-<span class="keyword">cache</span></span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure><ol start="2"><li>æ•°æ®æ ¼å¼ï¼šæœåŠ¡ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œç”±messageç»„æˆï¼Œå…¶æ ¼å¼å¦‚ä¸‹</li></ol>  <figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">field:</span>value</span><br></pre></td></tr></table></figure></li></ul><h1>SSEå®è·µ</h1><ul><li>è¿™é‡Œç®€å•åšä¸€ä¸ªæ—¶é’Ÿæ•ˆæœï¼Œæœ‰æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€å½“å‰æ—¶é—´æ•°æ®ç»™å‰ç«¯ï¼Œå‰ç«¯é¡µé¢æ¥æ”¶åå±•ç¤ºã€‚</li></ul><h2 id="SseEmitterç±»ç®€ä»‹">SseEmitterç±»ç®€ä»‹</h2><ul><li>SpringBootä½¿ç”¨SseEmitteræ¥æ”¯æŒSSEï¼Œå¹¶å¯¹SSEè§„èŒƒåšäº†ä¸€äº›å°è£…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ã€‚æˆ‘ä»¬åœ¨æ“ä½œSseEmitterå¯¹è±¡æ—¶ï¼Œåªéœ€è¦å…³æ³¨å‘é€çš„æ¶ˆæ¯æ–‡æœ¬å³å¯ã€‚</li><li>SseEmittterç±»çš„å‡ ä¸ªæ–¹æ³•ï¼š<ol><li>send()ï¼šå‘é€æ•°æ®ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªéSseEventBuilderå¯¹è±¡ï¼Œé‚£ä¹ˆä¼ é€’å‚æ•°ä¼šè¢«å°è£…åˆ°dataä¸­ã€‚</li><li>complete()ï¼šè¡¨ç¤ºæ‰§è¡Œå®Œæˆï¼Œä¼šæ–­å¼€è¿æ¥ï¼ˆå¦‚æœæ˜¯ä¸€äº›è½®è¯¢è¿›åº¦çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»åŠ¡è¿›åº¦å®Œæˆæ—¶ï¼Œä¸»åŠ¨æ–­å¼€è¿æ¥ï¼‰</li><li>onTimeout()ï¼šè¿æ¥è¶…æ—¶æ—¶å›è°ƒè§¦å‘ã€‚</li><li>onCompletion()ï¼šç»“æŸä¹‹åçš„å›è°ƒè§¦å‘ã€‚</li><li>onError()ï¼šæŠ¥é”™æ—¶çš„å›è°ƒè§¦å‘ã€‚</li></ol></li></ul><h2 id="ç¤ºä¾‹Demo">ç¤ºä¾‹Demo</h2><div class="tabs" id="sseæ—¶é’Ÿdemo"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#sseæ—¶é’Ÿdemo-1">å‰ç«¯HTML</button></li><li class="tab"><button type="button" data-href="#sseæ—¶é’Ÿdemo-2">åç«¯æ¥å£</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="sseæ—¶é’Ÿdemo-1"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;msg_from_server&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> sse = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="string">&quot;http://localhost/sse/hello&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    sse.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> eventVal = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;msg_from_server&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        eventVal.<span class="property">innerHTML</span> = event.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="sseæ—¶é’Ÿdemo-2"><ul><li>åç«¯æ¥å£</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sse&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">helloworld</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                    sseEmitter.send(SseEmitter.event().data(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>))));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Error in SSE: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                sseEmitter.completeWithError(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>å¤§åŠŸå‘Šæˆ<br><img src="https://z1.ax1x.com/2023/11/25/pi0EfLF.png" alt=""></li></ul><h2 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h2><ul><li>è¿™é‡Œçš„åè®®æ˜¯<code>http/1.1</code>ï¼Œä»…æ”¯æŒ6ä¸ªè¿æ¥æ•°ï¼Œè€Œ<code>HTTP/2</code>é»˜è®¤æ”¯æŒ100ä¸ªè¿æ¥æ•°ï¼ŒåŒæ—¶è¿™é‡Œæ¯30ç§’é‡æ–°å»ºç«‹äº†ä¸€ä¸ªæ–°è¿æ¥ï¼Œè¿™æ˜¯SSEé»˜è®¤çš„è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®è¿æ¥è¶…æ—¶æ—¶é—´æ¥è¾¾åˆ°ä¸è¿‡æœŸçš„ç›®çš„ï¼Œé‚£ä¹ˆå°±éœ€è¦æˆ‘ä»¬åœ¨ä¸šåŠ¡é€»è¾‘é‡Œ<code>æ‰‹åŠ¨å…³é—­è¿æ¥</code>ã€‚</li><li>åŒæ—¶ï¼Œæ¯å»ºç«‹ä¸€ä¸ªSSEè¿æ¥çš„æ—¶å€™ï¼Œéƒ½éœ€è¦ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± æ¥å¤„ç†å¹¶å‘é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿè¦æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡éœ€æ±‚æ¥åšå¥½å‹æµ‹ã€‚<br><img src="https://z1.ax1x.com/2023/11/25/pi0VFQf.png" alt=""></li><li>ä½†æ˜¯<code>HTTP/2</code>ä»…æ”¯æŒ<code>HTTPS</code>ï¼Œæˆ‘è¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å»äº†è§£ä¸€ä¸‹ä½¿ç”¨OpenSSLç”Ÿæˆä¸€ä¸ª<code>è‡ªç­¾åçš„SSLè¯ä¹¦</code></li></ul><h2 id="å·¥å…·ç±»å°è£…">å·¥å…·ç±»å°è£…</h2><ul><li>ä¸‹é¢æ˜¯æˆ‘å°è£…çš„ä¸€ä¸ªç®€å•çš„SseUtils</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SseUtils</span> &#123;</span><br><span class="line">    <span class="comment">// timeout -&gt; 0è¡¨ç¤ºä¸è¿‡æœŸï¼Œé»˜è®¤æ˜¯30ç§’ï¼Œè¶…è¿‡æ—¶é—´æœªå®Œæˆï¼ˆæ–­å¼€ï¼‰ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">DEFAULT_TIME_OUT</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// ä¼šè¯map, æ–¹ä¾¿ç®¡ç†è¿æ¥æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, SseEmitter&gt; conversationMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å»ºç«‹è¿æ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitter <span class="title function_">getConnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºSSE</span></span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>(DEFAULT_TIME_OUT);</span><br><span class="line">        <span class="comment">// å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®å‰ç«¯é‡è¯•æ—¶5s</span></span><br><span class="line">            sseEmitter.send(SseEmitter.event().reconnectTime(<span class="number">5_000L</span>).data(<span class="string">&quot;SSEå»ºç«‹æˆåŠŸ&quot;</span>));</span><br><span class="line">            <span class="comment">// è¿æ¥è¶…æ—¶</span></span><br><span class="line">            sseEmitter.onTimeout(() -&gt; SseUtils.timeout(conversationId));</span><br><span class="line">            <span class="comment">// è¿æ¥æ–­å¼€</span></span><br><span class="line">            sseEmitter.onCompletion(() -&gt; SseUtils.completion(conversationId));</span><br><span class="line">            <span class="comment">// é”™è¯¯</span></span><br><span class="line">            sseEmitter.onError((e) -&gt; SseUtils.error(conversationId, e.getMessage()));</span><br><span class="line">            <span class="comment">// æ·»åŠ sse</span></span><br><span class="line">            conversationMap.put(conversationId, sseEmitter);</span><br><span class="line">            <span class="comment">// è¿æ¥æˆåŠŸ</span></span><br><span class="line">            log.info(<span class="string">&quot;åˆ›å»ºsseè¿æ¥æˆåŠŸ ==&gt; å½“å‰è¿æ¥æ€»æ•°=&#123;&#125;ï¼Œ ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationMap.size(), conversationId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// æ—¥å¿—</span></span><br><span class="line">            log.error(<span class="string">&quot;å‰ç«¯é‡è¿å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * è·å–æ¶ˆæ¯å®ä¾‹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitter <span class="title function_">getInstance</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.get(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * æ–­å¼€è¿æ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">disconnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        SseUtils.getInstance(conversationId).complete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»™æŒ‡å®šä¼šè¯å‘é€æ¶ˆæ¯ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œè¿”å›false</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jsonMsg        - æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String conversationId, String jsonMsg)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¯¥ä¼šè¯æ˜¯å¦å·²å»ºç«‹è¿æ¥</span></span><br><span class="line">        <span class="comment">// å·²å»ºç«‹è¿æ¥</span></span><br><span class="line">        <span class="keyword">if</span> (SseUtils.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">                SseUtils.getInstance(conversationId).send(jsonMsg, MediaType.APPLICATION_JSON);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// æ—¥å¿—</span></span><br><span class="line">                SseUtils.removeClientId(conversationId);</span><br><span class="line">                log.error(<span class="string">&quot;å‘é€æ¶ˆæ¯å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœªå»ºç«‹è¿æ¥</span></span><br><span class="line">            log.error(<span class="string">&quot;è¿æ¥ä¸å­˜åœ¨æˆ–è€…è¶…æ—¶ ==&gt; ä¼šè¯Id=&#123;&#125;ä¼šè¯è‡ªåŠ¨å…³é—­&quot;</span>, conversationId);</span><br><span class="line">            SseUtils.removeClientId(conversationId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»é™¤ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨å­˜åœ¨ä¼šè¯</span></span><br><span class="line">        <span class="keyword">if</span> (!SseUtils.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ é™¤è¯¥ä¼šè¯</span></span><br><span class="line">        conversationMap.remove(conversationId);</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.info(<span class="string">&quot;ç§»é™¤ä¼šè¯æˆåŠŸ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ˜¯å¦å­˜åœ¨ä¼šè¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">getIsExistClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.containsKey(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å½“å‰è¿æ¥æ€»æ•°</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - è¿æ¥æ€»æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getConnectTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;å½“å‰è¿æ¥æ•°ï¼š&#123;&#125;&quot;</span>, conversationMap.size());</span><br><span class="line">        <span class="keyword">for</span> (String s : conversationMap.keySet()) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;è¾“å‡ºSSE-Mapï¼š&#123;&#125;&quot;</span>, conversationMap.get(s));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¶…æ—¶</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">timeout</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.error(<span class="string">&quot;sseè¿æ¥è¶…æ—¶ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtils.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®Œæˆ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">completion</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.info(<span class="string">&quot;sseè¿æ¥å·²æ–­å¼€ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtils.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”™è¯¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String conversationId, String message)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.error(<span class="string">&quot;sseæœåŠ¡å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, message);</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtils.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿˜æ˜¯ç”¨åˆšåˆšæ¨é€å½“å‰æ—¶é—´çš„ä¾‹å­ï¼Œè¿™é‡Œæˆ‘ä»¬åšä¸€ä¸‹ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œæˆ‘è¿™é‡Œç®€å•çš„é€»è¾‘å°±æ˜¯éå†åˆ°ä¸€ä¸ªæ•´åˆ†ï¼Œå°±åœæ­¢æ¨é€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">timeStamp</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line">    response.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    <span class="comment">// ç”Ÿæˆä¼šè¯ID</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">conversationId</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="comment">// å»ºç«‹è¿æ¥</span></span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> SseUtils.getConnect(conversationId);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                <span class="comment">// å‘ä¼šè¯å‘é€æ¶ˆæ¯</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">timeStamp</span> <span class="operator">=</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">                SseUtils.sendMessage(conversationId, timeStamp);</span><br><span class="line">                <span class="keyword">if</span> (timeStamp.endsWith(<span class="string">&quot;00&quot;</span>)) &#123;</span><br><span class="line">                    SseUtils.removeClientId(conversationId);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error in SSE: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            sseEmitter.completeWithError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">return</span> sseEmitter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>SSEå®æˆ˜</h1><ul><li>æˆ‘è¿™é‡Œä¹Ÿæ˜¯åœ¨æˆ‘é¡¹ç›®é‡Œçš„è½®è¯¢è®¢å•è¿›åº¦çš„æ—¶å€™å°è¯•ç”¨äº†ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘è¿™ä¸ªé¡¹ç›®ä¹Ÿæ˜¯æ–‡æœ¬ç”Ÿæˆæ–¹å‘çš„ï¼Œä¹‹å‰æ˜¯å‰ç«¯å®šæ—¶è½®è¯¢æˆ‘è¿™è¾¹çš„æ¥å£ï¼Œç°åœ¨æ¢æˆæˆ‘ä¸»åŠ¨å‘å‰ç«¯æ¨é€æ•°æ®ï¼Œç„¶åå‰ç«¯æ‹¿åˆ°æ•°æ®è‡ªå·±è§£æå†…å®¹å°±å¥½äº†ã€‚è¿™é‡Œç”¨çš„å·¥å…·ç±»å°±æ˜¯æˆ‘åˆšåˆšå°è£…çš„é‚£ä¸ª</li></ul><div class="tabs" id="å®æˆ˜"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#å®æˆ˜-1">Controllerå±‚</button></li><li class="tab"><button type="button" data-href="#å®æˆ˜-2">Serviceå±‚</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="å®æˆ˜-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderDetail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">getOrderDetailById</span><span class="params">(String orderId, HttpServletResponse httpServletResponse)</span> &#123;</span><br><span class="line">    httpServletResponse.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">    httpServletResponse.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> orderService.getOrderDetailById(orderId, httpServletResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å®æˆ˜-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®€å•æ¥ä¸ªçº¿ç¨‹æ± </span></span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">60</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">getOrderDetailById</span><span class="params">(String orderId, HttpServletResponse httpServletResponse)</span> &#123;</span><br><span class="line">    <span class="comment">// å»ºç«‹è¿æ¥</span></span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> SseUtils.getConnect(orderId);</span><br><span class="line">    executor.execute(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;=========SSEè½®è¯¢ä¸­=========&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ¯5ç§’æ¨é€ä¸€æ¬¡æ•°æ®</span></span><br><span class="line">                Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æŸ¥è¯¢è®¢å•æ•°æ®</span></span><br><span class="line">            <span class="type">Torder</span> <span class="variable">torder</span> <span class="operator">=</span> orderMapper.selectOne(Wrappers.lambdaQuery(Torder.class).eq(Torder::getOrderId, orderId));</span><br><span class="line">            <span class="keyword">if</span> (torder == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè®¢å•ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ï¼Œä¸»åŠ¨æ–­å¼€è¿æ¥</span></span><br><span class="line">                SseUtils.sendMessage(orderId, JSON.toJSONString(ErrorCodeEnum.ORDER_ID_NOT_EXIST));</span><br><span class="line">                SseUtils.removeClientId(orderId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">OrderDetailVO</span> <span class="variable">detailVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDetailVO</span>();</span><br><span class="line">            detailVO.setIsExpire(stringRedisTemplate.opsForValue().get(orderId) == <span class="literal">null</span>);</span><br><span class="line">            detailVO.setOrderId(orderId);</span><br><span class="line">            detailVO.setCreateTime(torder.getCreateTime());</span><br><span class="line">            detailVO.setOrderType(torder.getPolishType());</span><br><span class="line">            detailVO.setAmount(torder.getAmount().doubleValue());</span><br><span class="line">            <span class="comment">// æ ¹æ®ä¸åŒçš„è®¢å•ç±»å‹æ¥å°è£…ä¸åŒçš„å‚æ•°ï¼ˆè¿™é‡Œä¸ºäº†æ»¡è¶³äº§å“çš„éœ€æ±‚ï¼Œæƒ³ç”¨ä¸€ä¸ªæ¥å£æ˜¾ç¤ºä¸åŒç§ç±»è®¢å•çš„ä¿¡æ¯ï¼Œç”¨äº†SQLåæ¨¡å¼è®¾è®¡æ•°æ®åº“ï¼Œå¯¼è‡´ä»£ç å¾ˆä¸ä¼˜é›…ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (torder.getOrderType() == <span class="number">0</span>) &#123;</span><br><span class="line">                Wrapper&lt;Object&gt; statusByOrderId = getStatusByOrderId(orderId);</span><br><span class="line">                <span class="keyword">if</span> (statusByOrderId.getCode() != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// è®¢å•çŠ¶æ€æŸ¥è¯¢å¼‚å¸¸ï¼Œè¿”å›é”™è¯¯ï¼Œä¸»åŠ¨æ–­å¼€è¿æ¥</span></span><br><span class="line">                    SseUtils.sendMessage(orderId, JSON.toJSONString(ErrorCodeEnum.ASYNC_SERVICE_ERROR));</span><br><span class="line">                    SseUtils.removeClientId(orderId);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (torder.getPolishType() == Common.POLISH_TYPE_WITH_PAPER) &#123;</span><br><span class="line">                    <span class="type">PaperStatusByOrderIdVO</span> <span class="variable">paperVO</span> <span class="operator">=</span> (PaperStatusByOrderIdVO) statusByOrderId.getResult();</span><br><span class="line">                    BeanUtils.copyProperties(paperVO, detailVO);</span><br><span class="line">                    detailVO.setProgress(Double.valueOf(paperVO.getProgress()));</span><br><span class="line">                    detailVO.setTitle(paperVO.getPaperTitle());</span><br><span class="line">                    detailVO.setOrderStatus(paperVO.getStatus());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">TextStatusByOrderIdVO</span> <span class="variable">textVO</span> <span class="operator">=</span> (TextStatusByOrderIdVO) statusByOrderId.getResult();</span><br><span class="line">                    BeanUtils.copyProperties(textVO, detailVO);</span><br><span class="line">                    detailVO.setProgress(Double.valueOf(textVO.getProgress()));</span><br><span class="line">                    detailVO.setTitle(textVO.getPaperTitle());</span><br><span class="line">                    detailVO.setOrderStatus(textVO.getStatus());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (torder.getOrderType() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">CheckpassOrder</span> <span class="variable">checkpassOrder</span> <span class="operator">=</span> checkpassOrderMapper.selectOne(Wrappers.lambdaQuery(CheckpassOrder.class).eq(CheckpassOrder::getOrderId, orderId));</span><br><span class="line">                <span class="type">CheckpassReport</span> <span class="variable">checkpassReport</span> <span class="operator">=</span> checkpassReportMapper.selectOne(Wrappers.lambdaQuery(CheckpassReport.class).eq(CheckpassReport::getPaperId, checkpassOrder.getPaperId()));</span><br><span class="line">                detailVO.setOrderStatus(checkpassOrder.getStatus());</span><br><span class="line">                detailVO.setAuthor(checkpassReport.getAuthor());</span><br><span class="line">                detailVO.setTitle(checkpassReport.getTitle());</span><br><span class="line">                detailVO.setProgress(checkpassReport.getCopyPercent() == <span class="literal">null</span> ? <span class="number">0</span> : checkpassReport.getCopyPercent());</span><br><span class="line">                detailVO.setCheckVersion(CommonUtil.getCheckVersion(checkpassOrder.getJaneName()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> SseUtils.sendMessage(orderId, JSON.toJSONString(detailVO));</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (torder.getStatus() == Common.ORDER_FINISH_STATUS) &#123;</span><br><span class="line">                <span class="comment">// è®¢å•å®Œæˆï¼Œä¸»åŠ¨å…³é—­è¿æ¥</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    emitter.send(SseEmitter.event().reconnectTime(<span class="number">5000L</span>).data(<span class="string">&quot;SSEå…³é—­è¿æ¥&quot;</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                SseUtils.removeClientId(orderId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1>ä½¿ç”¨è¿‡ç¨‹ä¸­çš„ä¸€äº›å‘</h1><ol><li>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæµè§ˆå™¨ä¸­æŸ¥çœ‹æ¥å£ä¸€ç›´æ˜¾ç¤ºå¾…å¤„ç†çŠ¶æ€ï¼Œä½†æˆ‘çš„JavaæœåŠ¡ç¡®ç¡®å®å®å·²ç»æ¨é€äº†æ•°æ®ã€‚<ul><li>å¦‚æœä½ ç­‰å¾…äº†ä¸€ä¼šå„¿ï¼Œå‘ç°è¯·æ±‚å“åº”æˆåŠŸï¼Œä½†æ˜¯ä¸€æ¬¡æ€§æ¨é€äº†å¾ˆå¤šæ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯ç¼“å†²åŒºçš„é—®é¢˜ï¼Œå› ä¸ºSSEæ˜¯æµå¼è¾“å‡ºï¼Œæµå¼è¾“å‡ºé€šå¸¸ä¼šæ¶‰åŠåˆ°ç¼“å†²åŒºçš„ä½¿ç”¨ã€‚åœ¨Java Servletä¸­ï¼ŒHttpServletResponseå¯¹è±¡çš„è¾“å‡ºæµä¼šæœ‰ä¸€ä¸ªç¼“å†²åŒºã€‚å½“ä½¿ç”¨Servletçš„è¾“å‡ºæµå†™å…¥æ•°æ®æ—¶ï¼Œè¿™äº›æ•°æ®é¦–å…ˆä¼šè¢«å†™å…¥ç¼“å†²åŒºï¼Œç„¶åæ‰ä¼šè¢«å‘é€åˆ°å®¢æˆ·ç«¯ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å†ä»£ç ä¸­ç¦ç”¨æ‰ã€‚</li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpServletResponse.setHeader(<span class="string">&quot;X-Accel-Buffering&quot;</span>, <span class="string">&quot;no&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>åŒæ—¶Nginxé‡Œä¹Ÿè¦åŠ ä¸ŠåŒæ ·çš„é…ç½®ï¼Œå¦‚æœä½ ä¸­é—´ç»è¿‡äº†å¤šçº§Nginxï¼Œéœ€è¦æ¯ä¸€çº§Nginxéƒ½ç¦ç”¨æ­¤é¡¹ã€‚</li></ul> <figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_buffering</span> <span class="literal">off</span>;</span><br></pre></td></tr></table></figure></li><li>å¦‚æœä½ ä½¿ç”¨äº†é˜¿é‡Œäº‘çš„CDNæœåŠ¡ï¼Œé‚£ä¹ˆè¯·è®¾ç½®ä¸ºåŠ¨æ€åŠ é€Ÿ</li><li>æœåŠ¡ç«¯æ— æ³•åˆ°å®¢æˆ·ç«¯ç½‘ç»œä¸­æ–­ï¼šå®¢æˆ·ç«¯ç½‘ç»œä¸­æ–­åï¼ŒæœåŠ¡ç«¯æ— æ³•æ„ŸçŸ¥åˆ°å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œå°±ä¼šå¯¼è‡´æœåŠ¡ç«¯çš„çº¿ç¨‹ä¸­çš„ä»»åŠ¡ä¸€ç›´åœ¨è¿è¡Œï¼Œä¸æ–­åœ°ç»™è¿™ä¸ªå®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ã€‚è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š<ol><li>é€šè¿‡ç»™ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ç»™æœåŠ¡ç«¯è®¾ç½®ä¸åŒçš„æœ€å¤§è¿æ¥æ—¶é•¿ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é•¿ï¼ŒæœåŠ¡ç«¯ä¼šä¸»åŠ¨åœ°å»æ–­å¼€è¿™ä¸ªè¿æ¥ã€‚</li><li>å®¢æˆ·ç«¯æ„ŸçŸ¥æ–­å¼€è¿æ¥çš„é€šçŸ¥ä¹‹åï¼Œå¦‚æœå½“å‰è®¢å•ä»»åŠ¡è¿˜æœªç»“æŸï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šé‡æ–°å»ºç«‹è¿æ¥ï¼Œç›´åˆ°è®¢å•ä»»åŠ¡ç»“æŸï¼Œè¿™æ ·åšèƒ½é¿å…ä¸€äº›æ— æ•ˆä¼šè¯ä¸€ç›´åœ¨æ¨é€æ¶ˆæ¯çš„é—®é¢˜ã€‚</li></ol></li><li>å®¢æˆ·ç«¯é‡è¿æœºåˆ¶ï¼šå¦‚æœå®¢æˆ·ç«¯å› ä¸ºç½‘ç»œé—®é¢˜æˆ–è€…å…¶ä»–é—®é¢˜è¿›è¡Œäº†æ–­çº¿ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šæ ¹æ®æœåŠ¡ç«¯å‘é€çš„retryå‚æ•°è®¾ç½®çš„æ—¶é—´é—´éš”è¿›è¡Œé‡è¿ï¼Œè€Œè¿™ä¸ªæ—¶å€™æœåŠ¡ç«¯æ˜¯æš‚æ—¶æ— æ³•æ„ŸçŸ¥åˆ°å®¢æˆ·ç«¯å·²ç»æ–­çº¿äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šåœ¨æŒç»­åœ°å»ç»™å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ã€‚å‡å¦‚å®¢æˆ·ç«¯é‡è¿æˆåŠŸä¹‹åï¼Œå°±ä¼šå‡ºç°ä»¥ä¸‹ä¸¤ç§åœºæ™¯ï¼š<ol><li>æœåŠ¡ç«¯æœªæ–­å¼€è¿æ¥ï¼šå¤ç”¨ä¹‹å‰çš„è¿æ¥çº¿è·¯ï¼Œå®¢æˆ·ç«¯ä¼šä¸€æ¬¡æ€§æ”¶åˆ°å¤šæ¡æ–­çº¿æœŸé—´æœªæ”¶åˆ°çš„æ¶ˆæ¯å†…å®¹ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯ä½¿ç”¨é™æµï¼Œåªæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œå‡å°‘DOMæ¸²æŸ“ã€‚</li><li>æœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€äº†è¿æ¥ï¼ˆè®¢å•ä»»åŠ¡ç»“æŸæ–­å¼€/è¾¾åˆ°æœ€å¤§è¿æ¥æ—¶é•¿ï¼‰ï¼šé‡æ–°å»ºç«‹ä¸€æ¡çº¿è·¯ï¼ˆä¹‹å‰çš„é‚£æ¡çº¿è·¯å…¶å®è¿˜æ˜¯å­˜åœ¨çš„ï¼‰ï¼Œå› ä¸ºæ˜¯ä¸€æ¡æ–°çº¿è·¯æ‰€ä»¥ä¹‹å‰æ–­çº¿æ—¶ï¼ŒæœåŠ¡ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œæ˜¯æ”¶ä¸åˆ°çš„ã€‚</li></ol></li><li>å¦‚ä½•ä¿è¯ç”¨æˆ·åœ¨åŒä¸€ä¸ªä¸šåŠ¡åœºæ™¯ä¸‹åªä¼šå»ºç«‹ä¸€æ¡è¿æ¥ï¼Ÿ<ol><li>è¿™ä¹Ÿå°±æ˜¯ä¸Šé¢æ ‡é»„å¤„æåˆ°çš„é—®é¢˜ï¼Œä¹‹å‰çš„ä¼šè¯idéƒ½æ˜¯æœåŠ¡ç«¯æ¥ç”Ÿæˆï¼Œæœ€åä¿®æ”¹ä¸ºå®¢æˆ·ç«¯æ¥ç”Ÿæˆä¼šè¯idå¹¶ä¸”ä¸´æ—¶ä¿å­˜åœ¨æœ¬åœ°ç­–ç•¥å°±æ˜¯ï¼ˆä¸šåŠ¡ID - ç”¨æˆ·tokenå20ä½ - é¡µé¢RUNTIME_IDï¼‰ï¼Œè¿™ä¸ªæ ·åšçš„åŸå› ä¸»è¦è¿˜æ˜¯ç¡®ä¿ç”¨æˆ·åœ¨åŒä¸€ä¸ªä¸šåŠ¡åœºæ™¯ä¸‹æˆ–è€…åœ¨æ–­çº¿é‡è¿æ—¶ å®¢æˆ·ç«¯æ¯æ¬¡å‘æœåŠ¡ç«¯å»ºç«‹è¿æ¥çš„ä¼šè¯idéƒ½æ˜¯ç›¸åŒçš„ï¼Œä»è€Œæ–¹ä¾¿åé¢ æœåŠ¡ç«¯æ–­å¼€ä¹‹å‰çš„çº¿è·¯ã€‚</li><li>ç”±äºæœåŠ¡ç«¯é‡‡ç”¨çš„æ˜¯HashMapæ¥å­˜å‚¨æ¯ä¸ªSSEå¯¹è±¡ï¼Œæ‰€ä»¥åœ¨æ’å…¥idç›¸åŒçš„ä¼šè¯çš„æ—¶å€™ï¼Œä¼šç›´æ¥æ›¿æ¢mapä¸­å·²ç»å­˜åœ¨çš„ä¼šè¯ï¼Œè™½ç„¶ä¹‹å‰çš„ä¼šè¯å·²ç»ä¸å­˜åœ¨äº†ï¼Œä½†æ˜¯å…¶å»ºç«‹çš„è¿æ¥å¹¶æ²¡æœ‰çœŸæ­£çš„æ–­å¼€ï¼Œæ‰€ä»¥æœåŠ¡ç«¯åœ¨æ–°çš„ä¼šè¯æ’å…¥ä¹‹å‰ï¼Œå…ˆå»æ˜¾å¼åœ°å»å°†ä¹‹å‰çš„ä¼šè¯æ‰§è¡Œä¸€æ¬¡æ–­å¼€è¿æ¥çš„æ“ä½œï¼Œç„¶åå†å»æ‰§è¡Œåˆ›å»ºè¿æ¥æ“ä½œã€‚å¦åˆ™ï¼Œå½“å¤šä½™çš„çº¿è·¯è¾¾åˆ°ä¸€å®šçš„æ•°é‡ä¹‹åï¼Œå®¢æˆ·ç«¯ä¼šå‡ºç°çº¿è·¯é˜»å¡çš„é—®é¢˜ã€‚</li></ol></li><li>æ–°çš„ä¼šè¯åŠ å…¥ä¹‹åï¼Œå¦‚ä½•ä¸­æ–­æ—§ä¼šè¯å ç”¨çš„çº¿ç¨‹ï¼Ÿ<ul><li>ä¸€å¼€å§‹çš„é€»è¾‘æ˜¯å°†ä¼šè¯idä¿ç•™åœ¨çº¿ç¨‹ä¹‹ä¸­ï¼Œå…·ä½“æµç¨‹æ˜¯ï¼šåˆ¤æ–­å½“å‰ä¼šè¯æ˜¯å¦å­˜åœ¨ -&gt; å­˜åœ¨å°±æ¨é€æ¶ˆæ¯ -&gt; sleep nç§’ã€‚è¿™æ ·çš„å¤„ç†çš„è¯å°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨è¿™é‡Œåˆ¤æ–­äº†ä¼šè¯idæ˜¯å¦å­˜åœ¨ï¼Œä½†æ˜¯ç”±äºä¸Šé¢æˆ‘ä»¬åœ¨æ›¿æ¢æ—§ä¼šè¯çš„æ—¶å€™ï¼Œåˆé‡æ–°åˆ›å»ºäº†ä¸€ä¸ªç›¸åŒidçš„æ–°ä¼šè¯ï¼ˆåœ¨åŒä¸€ä¸ªä¸šåŠ¡åœºæ™¯ä¸‹å¤šæ¬¡å»ºç«‹è¿æ¥ï¼Œæ¯æ¬¡çš„ä¼šè¯idæ˜¯ä¸€æ ·çš„ï¼‰ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹sleepç»“æŸä¹‹åï¼Œä¼šå‘ç°è¿™ä¸ªä¼šè¯æ˜¯å­˜åœ¨çš„ï¼Œä»è€Œä¼šç»§ç»­ç»™è¿™ä¸ªä¼šè¯æ¨é€æ¶ˆæ¯ã€‚è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯ä¼šæ”¶åˆ°å¤šä¸ªä¸åŒçº¿ç¨‹å‘é€æ¥çš„æ¶ˆæ¯çš„é—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š<ol><li>åœ¨æ¯æ¬¡å»ºç«‹è¿æ¥çš„æ—¶å€™å°†ä¼šè¯å’Œè¯¥ä¼šè¯çš„æ‰€å±çº¿ç¨‹å…³è”åœ¨ä¸€èµ·ï¼Œä¹Ÿå°±æ˜¯å°†ç®¡ç†ä¼šè¯çš„mapç”±åŸæ¥çš„ <code>Map&lt;String, SseEmitter&gt;</code>ç±»å‹ï¼Œä¿®æ”¹ä¸ºï¼š <code>Map&lt;String, SseEmitterInfo&gt;</code>   ç±»å‹ï¼Œå…¶ä¸­SseEmitterInfoæ˜¯æˆ‘ä»¬è‡ªå·±å°è£…çš„ä¸€ä¸ªç±»ï¼Œå…¶ä¸­åŒ…å«SseEmitterå¯¹è±¡å’Œå»ºç«‹è¯¥è¿æ¥æ—¶çš„çº¿ç¨‹åã€‚</li><li>åœ¨å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œéœ€è¦åˆ¤æ–­å½“å‰ä¼šè¯æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”åˆ¤æ–­è¯¥ä¼šè¯æ‰€å±çš„çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶çš„è¯ï¼Œå°±æ¨é€æ¶ˆæ¯ï¼›å¦åˆ™ï¼Œä¸­æ–­çº¿ç¨‹ï¼›è¿™æ ·å°±å¯ä»¥ä¿è¯æ¯ä¸€ä¸ªä¼šè¯åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ¨é€æ¶ˆæ¯ã€‚</li></ol></li></ul></li></ol><p><img src="https://s11.ax1x.com/2024/02/24/pFUyKFP.png" alt=""></p><h1>ä¸€äº›è¡¥å……</h1><ul><li>åç»­å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘åˆå¯¹SseUtilsè¿›è¡Œäº†æ”¹è¿›ï¼Œæœ€ç»ˆç‰ˆæœ¬å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.aimc.paperreduction.common.wrapper.RWrappers;</span><br><span class="line"><span class="keyword">import</span> com.aimc.paperreduction.model.enums.ErrorCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SseUtil</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸ºäº†é¿å…å†…å­˜æ³„éœ²ï¼Œè¿™é‡Œæœ€å¥½è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">DEFAULT_TIME_OUT</span> <span class="operator">=</span> <span class="number">30L</span> * <span class="number">60</span> *  <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">// ä¼šè¯map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, SseEmitterInfo&gt; conversationMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * æ–­å¼€è¿æ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">disconnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="type">SseEmitterInfo</span> <span class="variable">instance</span> <span class="operator">=</span> SseUtil.getInstance(conversationId);</span><br><span class="line">        <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">            instance.getEmitter().complete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å»ºç«‹è¿æ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitter <span class="title function_">getConnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º SseEmitterInfo</span></span><br><span class="line">        <span class="type">SseEmitterInfo</span> <span class="variable">sseEmitterInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitterInfo</span>(conversationId);</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>(DEFAULT_TIME_OUT);</span><br><span class="line">        sseEmitterInfo.setEmitter(sseEmitter);</span><br><span class="line">        <span class="comment">// å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®å‰ç«¯é‡è¯•æ—¶5s</span></span><br><span class="line">            sseEmitter.send(SseEmitter.event().reconnectTime(<span class="number">5_000L</span>).data(JSONObject.toJSONString(RWrappers.Fail(ErrorCodeEnum.SSE_CONNECT_SUCCESS))));</span><br><span class="line">            <span class="comment">// è¿æ¥è¶…æ—¶</span></span><br><span class="line">            sseEmitter.onTimeout(() -&gt; SseUtil.timeout(conversationId));</span><br><span class="line">            <span class="comment">// è¿æ¥æ–­å¼€</span></span><br><span class="line">            sseEmitter.onCompletion(() -&gt; SseUtil.completion(conversationId));</span><br><span class="line">            <span class="comment">// é”™è¯¯</span></span><br><span class="line">            sseEmitter.onError((e) -&gt; SseUtil.error(conversationId, e.getMessage()));</span><br><span class="line">            <span class="comment">// æ·»åŠ sse</span></span><br><span class="line">            conversationMap.put(conversationId, sseEmitterInfo);</span><br><span class="line">            <span class="comment">// è¿æ¥æˆåŠŸ</span></span><br><span class="line">            log.info(<span class="string">&quot;åˆ›å»ºsseè¿æ¥æˆåŠŸ ==&gt; å½“å‰è¿æ¥æ€»æ•°=&#123;&#125;ï¼Œ ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationMap.size(), conversationId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// æ—¥å¿—</span></span><br><span class="line">            log.error(<span class="string">&quot;å‰ç«¯é‡è¿å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * è·å–æ¶ˆæ¯å®ä¾‹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitterInfo <span class="title function_">getInstance</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.get(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»™æŒ‡å®šä¼šè¯å‘é€æ¶ˆæ¯ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œè¿”å›false</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jsonMsg        - æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String conversationId, String jsonMsg)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¯¥ä¼šè¯æ˜¯å¦è¿˜åœ¨Mapä¸­ï¼Œä¸å­˜åœ¨åˆ™åˆ é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (!conversationMap.containsKey(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å·²å»ºç«‹è¿æ¥</span></span><br><span class="line">        <span class="keyword">if</span> (SseUtil.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">                SseUtil.getInstance(conversationId).getEmitter().send(jsonMsg, MediaType.APPLICATION_JSON);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// æ—¥å¿—</span></span><br><span class="line">                SseUtil.removeClientId(conversationId);</span><br><span class="line">                log.error(<span class="string">&quot;å‘é€æ¶ˆæ¯å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœªå»ºç«‹è¿æ¥</span></span><br><span class="line">            log.error(<span class="string">&quot;è¿æ¥ä¸å­˜åœ¨æˆ–è€…è¶…æ—¶ ==&gt; ä¼šè¯Id=&#123;&#125;ä¼šè¯è‡ªåŠ¨å…³é—­&quot;</span>, conversationId);</span><br><span class="line">            SseUtil.removeClientId(conversationId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»é™¤å¹¶æ–­å¼€ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨å­˜åœ¨ä¼šè¯</span></span><br><span class="line">        <span class="keyword">if</span> (!SseUtil.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ é™¤è¯¥ä¼šè¯</span></span><br><span class="line">        conversationMap.remove(conversationId);</span><br><span class="line">        SseUtil.disconnect(conversationId);</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">         log.info(<span class="string">&quot;ç§»é™¤ä¼šè¯æˆåŠŸ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ˜¯å¦å­˜åœ¨ä¼šè¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">getIsExistClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.containsKey(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å½“å‰è¿æ¥æ€»æ•°</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - è¿æ¥æ€»æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getConnectTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;å½“å‰è¿æ¥æ•°ï¼š&#123;&#125;&quot;</span>, conversationMap.size());</span><br><span class="line">        <span class="keyword">return</span> conversationMap.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¶…æ—¶</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">timeout</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.error(<span class="string">&quot;sseè¿æ¥è¶…æ—¶ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtil.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®Œæˆ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">completion</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.info(<span class="string">&quot;sseè¿æ¥å·²æ–­å¼€ ==&gt; ä¼šè¯Idï¼š&#123;&#125;ï¼Œå½“å‰å‰©ä½™è¿æ¥æ•°ï¼š&#123;&#125;&quot;</span>, conversationId, conversationMap.size());</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtil.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”™è¯¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String conversationId, String message)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line"><span class="comment">//        log.error(&quot;sseæœåŠ¡å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;, conversationId, message);</span></span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtil.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SseEmitterInfo</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> SseEmitter emitter;</span><br><span class="line">        <span class="keyword">private</span> String threadName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SseEmitterInfo</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.emitter = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">this</span>.threadName = Thread.currentThread().getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> SseEmitter <span class="title function_">getEmitter</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> emitter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmitter</span><span class="params">(SseEmitter emitter)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.emitter = emitter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getThreadName</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> threadName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setThreadName</span><span class="params">(String threadName)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.threadName = threadName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å®é™…ä½¿ç”¨å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/connSse&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">connSse</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> SseUtil.getConnect(conversationId);</span><br><span class="line">    executor.execute(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œéœ€è¦ä¿è¯åŒä¸€ä¸ªä¼šè¯IDåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¤„ç†</span></span><br><span class="line">        SseUtil.getInstance(conversationId).setThreadName(Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">while</span> (!Thread.interrupted() &amp;&amp; SseUtil.getInstance(conversationId) != <span class="literal">null</span> &amp;&amp; SseUtil.getInstance(conversationId).getThreadName().equals(Thread.currentThread().getName())) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">sendSuccess</span> <span class="operator">=</span> SseUtil.sendMessage(conversationId, JSONObject.toJSONString(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">10</span>]));</span><br><span class="line">            log.info(<span class="string">&quot;å‘ä¼šè¯ï¼š&#123;&#125;ï¼Œæ¨é€&quot;</span>, conversationId);</span><br><span class="line">            <span class="keyword">if</span> (!sendSuccess) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;=========è¿æ¥ä¸å­˜åœ¨ï¼ŒæœåŠ¡ç«¯ä¸»åŠ¨å…³é—­SSEè¿æ¥=========&quot;</span>);</span><br><span class="line">                SseUtil.removeClientId(conversationId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ¯ä¸€ç§’æ¨é€ä¸€æ¬¡æ•°æ®</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”±äºæˆ‘è¿™é‡Œçš„ä¸šåŠ¡é™åˆ¶ï¼Œåªèƒ½è¿™ä¹ˆç”¨SSEã€‚åŸæœ‰çš„ä¸šåŠ¡é€»è¾‘æ˜¯ï¼Œæˆ‘è½®è¯¢ç®—æ³•æ¥å£ï¼Œæ›´æ–°æ•°æ®ï¼Œç„¶åå‰ç«¯è½®è¯¢æˆ‘çš„æ¥å£ï¼Œæ›´æ–°é¡µé¢çŠ¶æ€ã€‚ä½¿ç”¨äº†SSEä¹‹åå˜æˆäº†ï¼Œæˆ‘è½®è¯¢ç®—æ³•æ¥å£ï¼Œæ›´æ–°æ•°æ®ï¼Œç„¶åå‘å‰ç«¯æ¨é€æ•°æ®ã€‚</li><li>ä½†æ˜¯æ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯ï¼Œæˆ‘è¿™è¾¹ç»™ç®—æ³•æä¾›ä¸€ä¸ªå›è°ƒçš„æ¥å£ï¼Œå½“ç®—æ³•æœ‰è¿›åº¦æ›´æ–°æ—¶ï¼Œè°ƒç”¨æˆ‘è¿™ä¸ªå›è°ƒæ¥å£ï¼Œç„¶åæˆ‘åœ¨è¿™ä¸ªå›è°ƒé€»è¾‘é‡Œå‘å‰ç«¯æ¨é€æ•°æ®ï¼Œè¿™æ ·é€»è¾‘ä¸Šå…¶å®æ˜¯æ›´é¡ºçš„ï¼Œåç»­æœ‰æ—¶é—´ï¼Œæ‰“ç®—å’Œç®—æ³•ä¾§èŠèŠè¿™å—ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚</li></ul>]]></content>
    
    
    <summary type="html">Server-Sent Events æœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼Œç®€ç§° SSEï¼Œæ˜¯ä¸€ç§æœåŠ¡ç«¯å®æ—¶ä¸»åŠ¨å‘æµè§ˆå™¨æ¨é€æ¶ˆæ¯çš„æŠ€æœ¯ã€‚</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SSE" scheme="https://cyborg2077.github.io/tags/SSE/"/>
    
  </entry>
  
  <entry>
    <title>Redissonå»¶è¿Ÿé˜Ÿåˆ—å®ç°å€’è®¡æ—¶ä»»åŠ¡</title>
    <link href="https://cyborg2077.github.io/2023/10/28/RDelayedQueue/"/>
    <id>https://cyborg2077.github.io/2023/10/28/RDelayedQueue/</id>
    <published>2023-10-28T12:14:25.000Z</published>
    <updated>2023-10-28T14:37:28.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜èƒŒæ™¯">é—®é¢˜èƒŒæ™¯</h2><ul><li>é¡¹ç›®é‡Œåˆšå¥½éœ€è¦å®ç°ä¸€ä¸ªå»¶è¿Ÿè®¢å•å–æ¶ˆä»»åŠ¡ã€‚å…·ä½“è€Œè¨€ï¼Œå¦‚æœä¸€ä»½è®¢å•åœ¨ç”Ÿæˆåçš„15åˆ†é’Ÿå†…æœªå®Œæˆæ”¯ä»˜ï¼Œç³»ç»Ÿéœ€è¦è‡ªåŠ¨å–æ¶ˆè¯¥è®¢å•ï¼Œå¹¶è¿”è¿˜ç›¸å…³è®¢å•æ‰€ä½¿ç”¨çš„ä¼˜æƒ åˆ¸æˆ–å…è´¹é¢åº¦ç­‰èµ„æºã€‚</li><li>è™½ç„¶å¼•å…¥MQæˆ–è€…Kafkaä¹Ÿæ˜¯ä¸€ç§è§£å†³æ–¹æ³•ï¼Œä½†å‡ºäºæœ€å¤§ç¨‹åº¦å‡å°‘ç³»ç»Ÿå¤æ‚æ€§çš„è§’åº¦è€ƒè™‘ï¼Œå¼ºçƒˆå»ºè®®å……åˆ†åˆ©ç”¨å·²æœ‰çš„Redisç»„ä»¶ï¼ˆä¾‹å¦‚Redissonï¼‰æ¥è§£å†³è¿™ä¸€é—®é¢˜ï¼Œè€Œä¸å¼•å…¥æ–°ç»„ä»¶ã€‚è¿™æ ·å¯ä»¥æé«˜æ•ˆç‡ã€å‡å°‘ç»´æŠ¤è´Ÿæ‹…ï¼Œå¹¶ç¡®ä¿å……åˆ†å‘æŒ¥å·²æœ‰æŠ€æœ¯çš„æ½œåŠ›ã€‚</li></ul><h2 id="å»¶è¿Ÿé˜Ÿåˆ—">å»¶è¿Ÿé˜Ÿåˆ—</h2><ul><li>Redissonä¸­å®šä¹‰äº†åˆ†å¸ƒå¼å»¶è¿Ÿé˜Ÿåˆ—RDelayedQueueï¼Œæ˜¯ä¸€ç§åŸºäºzsetç»“æ„å®ç°çš„å»¶æ—¶é˜Ÿåˆ—ï¼Œï¼Œå®ƒå…è®¸ä»¥æŒ‡å®šçš„å»¶è¿Ÿæ—¶é•¿ï¼Œå°†ä»»åŠ¡æ”¾åˆ°ç›®æ ‡é˜Ÿåˆ—ä¸­ã€‚</li><li>å…¶å®å°±æ˜¯åœ¨zsetçš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ªåŸºäºå†…å­˜çš„å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå½“æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªæ•°æ®åˆ°å»¶è¿Ÿé˜Ÿåˆ—çš„æ—¶å€™ï¼ŒRedissionä¼šæŠŠæ•°æ®å’Œè¶…æ—¶æ—¶é—´æ”¾åˆ°zsetä¸­ï¼Œå¹¶ä¸”èµ·ä¸€ä¸ªå»¶æ—¶ä»»åŠ¡ï¼Œå½“ä»»åŠ¡åˆ°æœŸæ—¶ï¼Œå†å»zsetä¸­æŠŠæ•°æ®å–å‡ºæ¥ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ä½¿ç”¨ã€‚</li></ul><h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2><ul><li>å…¶å®è¿™é‡Œçš„å®ç°å’Œæˆ‘ä¹‹å‰å†™çš„æ¶ˆæ¯é˜Ÿåˆ—å·®ä¸å¤šï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹æˆ‘å‰é¢é‚£ç¯‡æ–‡</li></ul><div class="tag link"><a class="link-card" title="æ‰‹å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—" href="https://cyborg2077.github.io/2023/10/03/DIYTaskQueue/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">æ‰‹å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</p><p class="url">https://cyborg2077.github.io/2023/10/03/DIYTaskQueue/</p></div></a></div><ol><li>å¯¼å…¥ä¾èµ–</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>ç¼–å†™é…ç½®ç±»</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String REDIS_HOST;  <span class="comment">//åœ°å€é…ç½®åœ¨é…ç½®æ–‡ä»¶ä¸Š</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String REDIS_PORT;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String REDIS_PASSWORD;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">createRedisAPi</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">redissonConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        redissonConfig.setCodec(<span class="keyword">new</span> <span class="title class_">org</span>.redisson.client.codec.StringCodec());</span><br><span class="line">        <span class="comment">//æˆ‘è¿™é‡Œå•èŠ‚ç‚¹æ¼”ç¤ºä¸€ä¸‹</span></span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">singleServerConfig</span> <span class="operator">=</span> redissonConfig.useSingleServer();</span><br><span class="line">        singleServerConfig.setAddress(String.format(<span class="string">&quot;redis://%s:%s&quot;</span>, REDIS_HOST, REDIS_PORT));</span><br><span class="line">        singleServerConfig.setPassword(REDIS_PASSWORD);</span><br><span class="line">        <span class="comment">//è®¾ç½®å‡ å·æ•°æ®åº“</span></span><br><span class="line">        singleServerConfig.setDatabase(<span class="number">0</span>);</span><br><span class="line">        singleServerConfig.setConnectTimeout(<span class="number">10000</span>);</span><br><span class="line">        singleServerConfig.setConnectionPoolSize(<span class="number">300</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(redissonConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>å»¶è¿Ÿé˜Ÿåˆ—æ‰§è¡Œå™¨</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayTaskQueueExecutor</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> RBlockingQueue&lt;T&gt; queue;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Thread msgLooper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DelayTaskQueueExecutor.Processor&lt;T&gt; processor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Processor</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(T task)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DelayTaskQueueExecutor</span><span class="params">(String threadName, RBlockingQueue&lt;T&gt; queue, DelayTaskQueueExecutor.Processor&lt;T&gt; processor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.queue = queue;</span><br><span class="line">        <span class="built_in">this</span>.processor = processor;</span><br><span class="line">        <span class="built_in">this</span>.msgLooper = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>::looper);</span><br><span class="line">        <span class="built_in">this</span>.msgLooper.setName(threadName);</span><br><span class="line">        <span class="built_in">this</span>.msgLooper.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">looper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">task</span> <span class="operator">=</span> queue.take();</span><br><span class="line">                processor.process(task);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(String.format(<span class="string">&quot;TaskQueueExecutor %s run task exception&quot;</span>,</span><br><span class="line">                        <span class="built_in">this</span>.msgLooper.getName()), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>æœåŠ¡ç±»</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayQueueService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoMapper userInfoMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BonusInfoMapper bonusInfoMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redisson;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RDelayedQueue&lt;String&gt; delayedQueue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initDelayQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        RBlockingQueue&lt;String&gt; blockingQueue = redisson.getBlockingQueue(<span class="string">&quot;orderDelayQueue&quot;</span>);</span><br><span class="line">        delayedQueue = redisson.getDelayedQueue(blockingQueue);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DelayTaskQueueExecutor</span>&lt;&gt;(<span class="string">&quot;ORDER_DELAY&quot;</span>, blockingQueue, <span class="built_in">this</span>::processOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†è®¢å•ä¿¡æ¯åŠ å…¥åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­ï¼Œå¹¶è®¾ç½®TTL</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderId è®¢å•ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addToDelayQueue</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">        delayedQueue.offer(orderId, <span class="number">2</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">        <span class="type">Torder</span> <span class="variable">order</span> <span class="operator">=</span> orderMapper.selectOne(Wrappers.lambdaQuery(Torder.class).eq(Torder::getOrderId, orderId));</span><br><span class="line">        <span class="keyword">if</span> (order != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> order.getStatus();</span><br><span class="line">            <span class="comment">// å¦‚æœè®¢å•ä»ç„¶æ˜¯æœªæ”¯ä»˜çŠ¶æ€ï¼Œå¹¶ä¸”å­—æ•°å·²ç»é¢„æ‰£äº†ï¼Œåˆ™è¿”è¿˜é¢„æ‰£çš„å­—æ•°ï¼Œå¹¶ä¸”å…³é—­è®¢å•</span></span><br><span class="line">            <span class="keyword">if</span> (status == Common.ORDER_ORIGINAL_STATUS) &#123;</span><br><span class="line">                order.setStatus(Common.ORDER_CLOSED_STATUS);</span><br><span class="line">                <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> order.getToken();</span><br><span class="line">                <span class="comment">// æŸ¥è¯¢æ˜¯å¦æ˜¯ç™»å½•ç”¨æˆ·</span></span><br><span class="line">                <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userInfoMapper.selectOneForUpdate(userId);</span><br><span class="line">                <span class="keyword">if</span> (userInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">UsedWordsBonusInfo</span> <span class="variable">wordsBonusInfo</span> <span class="operator">=</span> usedWordsBonusInfoMapper.selectOne(Wrappers.lambdaQuery(UsedWordsBonusInfo.class).eq(UsedWordsBonusInfo::getOrderId, order.getOrderId()));</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»é¢„æ‰£äº†</span></span><br><span class="line">                    <span class="keyword">if</span> (wordsBonusInfo.getSelfWordsDeducted() == Common.ALREADY_DEDUCTION) &#123;</span><br><span class="line">                        userInfo.setRegisterBonusWords(userInfo.getRegisterBonusWords() + wordsBonusInfo.getUsedRegisterBonus());</span><br><span class="line">                        userInfo.setInviteBonusWords(userInfo.getInviteBonusWords() + wordsBonusInfo.getUsedInviteBonus());</span><br><span class="line">                        log.info(<span class="string">&quot;è®¢å•ï¼š&#123;&#125;ï¼Œè¿”è¿˜æ³¨å†Œå­—æ•°ï¼š&#123;&#125;ï¼Œé‚€è¯·å­—æ•°ï¼š&#123;&#125;&quot;</span>, orderId, wordsBonusInfo.getUsedRegisterBonus(), wordsBonusInfo.getUsedInviteBonus());</span><br><span class="line">                        wordsBonusInfo.setSelfWordsDeducted(Common.ORIGIN_STATUS);</span><br><span class="line">                        usedWordsBonusInfoMapper.updateById(wordsBonusInfo);</span><br><span class="line">                        userInfoMapper.updateById(userInfo);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            orderMapper.updateById(order);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>ä½¿ç”¨æ–¹æ³•ï¼Œåˆ›å»ºè®¢å•çš„æ—¶å€™å°†è®¢å•å·åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œåˆ°æœŸåä¼šè‡ªåŠ¨æ‰§è¡Œå…³é—­è®¢å•çš„å¯¹åº”é€»è¾‘</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delayQueueService.addToDelayQueue(orderId);</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h2><ul><li>ç»†å¿ƒçš„åŒå­¦å¯èƒ½æ³¨æ„åˆ°äº†æˆ‘è¿™é‡Œçš„äº‹åŠ¡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">      <span class="type">Torder</span> <span class="variable">order</span> <span class="operator">=</span> orderMapper.selectOne(Wrappers.lambdaQuery(Torder.class).eq(Torder::getOrderId, orderId));</span><br><span class="line">      <span class="keyword">if</span> (order != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> order.getStatus();</span><br><span class="line">          <span class="comment">// å¦‚æœè®¢å•ä»ç„¶æ˜¯æœªæ”¯ä»˜çŠ¶æ€ï¼Œå¹¶ä¸”å­—æ•°å·²ç»é¢„æ‰£äº†ï¼Œåˆ™è¿”è¿˜é¢„æ‰£çš„å­—æ•°ï¼Œå¹¶ä¸”å…³é—­è®¢å•</span></span><br><span class="line">          <span class="keyword">if</span> (status == Common.ORDER_ORIGINAL_STATUS) &#123;</span><br><span class="line">              order.setStatus(Common.ORDER_CLOSED_STATUS);</span><br><span class="line">              <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> order.getToken();</span><br><span class="line">              <span class="comment">// æŸ¥è¯¢æ˜¯å¦æ˜¯ç™»å½•ç”¨æˆ·</span></span><br><span class="line">              <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userInfoMapper.selectOneForUpdate(userId);</span><br><span class="line">              <span class="keyword">if</span> (userInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                  <span class="type">UsedWordsBonusInfo</span> <span class="variable">wordsBonusInfo</span> <span class="operator">=</span> usedWordsBonusInfoMapper.selectOne(Wrappers.lambdaQuery(UsedWordsBonusInfo.class).eq(UsedWordsBonusInfo::getOrderId, order.getOrderId()));</span><br><span class="line">                  <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»é¢„æ‰£äº†</span></span><br><span class="line">                  <span class="keyword">if</span> (wordsBonusInfo.getSelfWordsDeducted() == Common.ALREADY_DEDUCTION) &#123;</span><br><span class="line">                      userInfo.setRegisterBonusWords(userInfo.getRegisterBonusWords() + wordsBonusInfo.getUsedRegisterBonus());</span><br><span class="line">                      userInfo.setInviteBonusWords(userInfo.getInviteBonusWords() + wordsBonusInfo.getUsedInviteBonus());</span><br><span class="line">                      log.info(<span class="string">&quot;è®¢å•ï¼š&#123;&#125;ï¼Œè¿”è¿˜æ³¨å†Œå­—æ•°ï¼š&#123;&#125;ï¼Œé‚€è¯·å­—æ•°ï¼š&#123;&#125;&quot;</span>, orderId, wordsBonusInfo.getUsedRegisterBonus(), wordsBonusInfo.getUsedInviteBonus());</span><br><span class="line">                      wordsBonusInfo.setSelfWordsDeducted(Common.ORIGIN_STATUS);</span><br><span class="line">                      usedWordsBonusInfoMapper.updateById(wordsBonusInfo);</span><br><span class="line">                      userInfoMapper.updateById(userInfo);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          orderMapper.updateById(order);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>é‡ç‚¹æ˜¯æˆ‘è¿™é‡Œçš„<code>userInfoMapper.selectOneForUpdate(userId);</code>ï¼Œè¿™å¥å…¶å®æ˜¯æˆ‘æ‰‹å†™çš„ä¸€ä¸ªSQLï¼Œ<code>SELECT XXX FROM user WHERE userId = xxx FOR UPDATE</code>ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ‰‹åŠ¨è§¦å‘è¡Œé”ã€‚è¿™é‡Œæ˜¯ä½¿ç”¨çš„é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå¯é‡å¤è¯»ã€‚å› ä¸ºäº‹åŠ¡é‡Œçš„è¯»æ“ä½œé»˜è®¤æ˜¯ä¸ä¼šè§¦å‘è¡Œé”çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯èƒ½ä¼šå‡ºç°å¦ä¸€ä¸ªäº‹åŠ¡å°†ç”¨æˆ·ä¿¡æ¯æ”¹äº†ï¼Œå¹¶ä¸”æäº¤äº†ï¼Œç”±äºå¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå½“å‰äº‹åŠ¡ä¸­è¯»å–åˆ°çš„ä»æ˜¯ä¿®æ”¹å‰çš„æ•°æ®ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°±ä¼šå°†å¦ä¸€ä¸ªäº‹åŠ¡çš„æäº¤ç»“æœè¦†ç›–æ‰ï¼Œå¦‚æœè¿™é‡Œä¸è§¦å‘è¡Œé”ï¼Œä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚</li><li>åŠ äº†è¡Œé”ä¹‹åï¼Œå¯ä»¥ç¡®ä¿åªæœ‰ä¸€ä¸ªä¼šè¯å¯ä»¥è®¿é—®è¯¥è®¢å•æ•°æ®ï¼Œä»è€Œé¿å…å¹¶å‘é—®é¢˜ã€‚ä½†æ˜¯ä¹Ÿä¸æ˜¯æ‰€æœ‰åœ¨äº‹åŠ¡é‡Œçš„è¯»æ“ä½œéƒ½è¦åŠ è¡Œé”ï¼Œæ¯•ç«Ÿé‚£æ ·çš„æ‰§è¡Œæ•ˆç‡å°±å¤ªæ…¢äº†ï¼Œåªæœ‰æ¶‰åŠåˆ°è¯»å–ä¿¡æ¯ï¼Œå¹¶ä¸”åç»­éœ€è¦å¯¹è¯¥ä¿¡æ¯è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œæ‰åŠ ä¸Šè¡Œé”ã€‚</li></ul>]]></content>
    
    
    <summary type="html">é¡¹ç›®é‡Œæœ‰ä¸ªåœºæ™¯éœ€è¦åšå»¶è¿Ÿä»»åŠ¡</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="Redis" scheme="https://cyborg2077.github.io/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>æ‰‹å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</title>
    <link href="https://cyborg2077.github.io/2023/10/03/DIYTaskQueue/"/>
    <id>https://cyborg2077.github.io/2023/10/03/DIYTaskQueue/</id>
    <published>2023-10-03T15:30:34.000Z</published>
    <updated>2023-10-05T03:02:32.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><ul><li>æœ¬æ–‡æ¶‰åŠåˆ°äº†å¤§é‡JDK 8çš„æ–°ç‰¹æ€§ï¼Œå¯¹è¿™éƒ¨åˆ†ä¸å¤ªäº†è§£çš„ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„è¿™ç¯‡æ–‡ç« </li></ul><div class="tag link"><a class="link-card" title="Java8 æ–°ç‰¹æ€§" href="https://cyborg2077.github.io/2022/11/05/NewFeaturesOfJava8/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">Java8 æ–°ç‰¹æ€§</p><p class="url">https://cyborg2077.github.io/2022/11/05/NewFeaturesOfJava8/</p></div></a></div><h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><ul><li>é¡¹ç›®é‡ŒåŸæœ¬æ˜¯ä½¿ç”¨Kafkaå½“æ¶ˆæ¯é˜Ÿåˆ—çš„ï¼Œä½†æ˜¯ç»„å†…å¤§å¸ˆè§‰å¾—Kafkaå¤ªé‡äº†ï¼Œåªè¦ç¡®ä¿è®¢å•ä¿¡æ¯éƒ½æŒä¹…åŒ–åˆ°æ•°æ®åº“é‡Œï¼Œæ¯æ¬¡é‡å¯çš„æ—¶å€™é‡æ–°åŠ è½½ä»»åŠ¡ï¼Œé‚£ä¹ˆå…¶å®æ˜¯å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ¥æ›¿ä»£Kafkaçš„</li></ul><div class="tabs" id="æ¶ˆæ¯é˜Ÿåˆ—"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#æ¶ˆæ¯é˜Ÿåˆ—-1">ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨</button></li><li class="tab"><button type="button" data-href="#æ¶ˆæ¯é˜Ÿåˆ—-2">QueueService</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="æ¶ˆæ¯é˜Ÿåˆ—-1"><ul><li>ä¸‹é¢æ˜¯æˆ‘è‡ªå·±å†™çš„ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ï¼Œä½¿ç”¨äº†<code>ArrayBlockingQueue</code>æ¥å­˜å‚¨ä»»åŠ¡ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚å¹¶ä¸”å…è®¸æŒ‡å®šå¤„ç†ä»»åŠ¡çš„å¤„ç†å™¨ï¼ˆProcessorï¼‰ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</li><li>å…³äºTaskQueueExecutorçš„æ„é€ å‡½æ•°ï¼Œæˆ‘è¿™é‡Œè‡ªå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œä½†æ˜¯å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥ç”¨Javaå†…ç½®çš„å‡½æ•°å¼æ¥å£ï¼šFunctionï¼Œå†™æ³•ç±»ä¼¼äº<code>public TaskQueueExecutor(String threadName, int queueSize, Function&lt;T, R&gt; processor) {}</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskQueueExecutor</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// ä¸ºè®°å½•æ¶ˆæ¯å’Œé”™è¯¯ä¿¡æ¯å®šä¹‰ä¸€ä¸ªæ—¥å¿—è®°å½•å™¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºå­˜å‚¨ç±»å‹ä¸ºTçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayBlockingQueue&lt;T&gt; queue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºå¤„ç†ä»»åŠ¡çš„ç‹¬ç«‹çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Thread msgLooper;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºå¤„ç†ä»»åŠ¡çš„å¤„ç†å™¨æ¥å£</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Processor&lt;T&gt; processor;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºè·Ÿè¸ªé˜Ÿåˆ—ä¸­ä»»åŠ¡çš„æ•°é‡çš„AtomicIntegeræ˜¯åŸå­æ•´æ•°ç±»å‹ï¼Œå¯ä»¥é¿å…å¹¶å‘ç¯å¢ƒä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger taskNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªå¤„ç†ä»»åŠ¡çš„æ¥å£</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Processor</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(T task)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°ç”¨äºåˆå§‹åŒ–TaskQueueExecutor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TaskQueueExecutor</span><span class="params">(String threadName, <span class="type">int</span> queueSize, Processor&lt;T&gt; processor)</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ç»™å®šçš„å¤§å°åˆå§‹åŒ–é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="built_in">this</span>.queue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;T&gt;(queueSize);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å­˜å‚¨ç”¨äºå¤„ç†ä»»åŠ¡çš„å¤„ç†å™¨</span></span><br><span class="line">        <span class="built_in">this</span>.processor = processor;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ç”¨äºæ¶ˆæ¯å¤„ç†</span></span><br><span class="line">        <span class="built_in">this</span>.msgLooper = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>::looper);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¾ç½®çº¿ç¨‹åç§°ï¼Œæˆ‘è¿™é‡Œæ˜¯æ ¹æ®ä¸šåŠ¡åç§°æ¥è®¾ç½®çš„ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜ä¼šæ¯”è¾ƒæ–¹ä¾¿</span></span><br><span class="line">        <span class="built_in">this</span>.msgLooper.setName(threadName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯åŠ¨æ¶ˆæ¯å¤„ç†çº¿ç¨‹</span></span><br><span class="line">        <span class="built_in">this</span>.msgLooper.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–taskNum</span></span><br><span class="line">        taskNum = <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•ç”¨äºå°†æ¶ˆæ¯ï¼ˆä»»åŠ¡ï¼‰å‘é€åˆ°é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(T task)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—</span></span><br><span class="line">            <span class="built_in">this</span>.queue.put(task);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¢åŠ ä»»åŠ¡è®¡æ•°</span></span><br><span class="line">            taskNum.incrementAndGet();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•ç”¨äºè·å–é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTaskNum</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taskNum.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸»è¦çš„æ¶ˆæ¯å¤„ç†å¾ªç¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">looper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼ˆå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡ï¼‰</span></span><br><span class="line">                <span class="type">T</span> <span class="variable">task</span> <span class="operator">=</span> queue.take();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// ä½¿ç”¨æä¾›çš„å¤„ç†å™¨å¤„ç†ä»»åŠ¡</span></span><br><span class="line">                processor.process(task);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™ä¸­æ–­å¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// å¤„ç†ä»»åŠ¡å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°çš„ä»»ä½•å¼‚å¸¸</span></span><br><span class="line">                log.error(String.format(<span class="string">&quot;TaskQueueExecutor %s run task exception&quot;</span>,</span><br><span class="line">                        <span class="built_in">this</span>.msgLooper.getName()), e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// å³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿä¼šåœ¨finallyå—ä¸­å‡å°‘ä»»åŠ¡è®¡æ•°</span></span><br><span class="line">                taskNum.decrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æ¶ˆæ¯é˜Ÿåˆ—-2"><ul><li><code>QueueService</code>ï¼šæ˜¯ç”¨äºç®¡ç†ä¸åŒç±»å‹çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚<del>ï¼ˆæˆ‘è¿™é‡Œç›®å‰å°±ä¿©ä»»åŠ¡é˜Ÿåˆ—ï¼‰</del></li><li><code>@PostConstruct init()</code>ï¼šä½¿ç”¨æ³¨è§£æ¥æ ‡è®°åˆå§‹åŒ–æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ç±»å®ä¾‹åŒ–åè‡ªåŠ¨è°ƒç”¨ï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–äº†ä¸¤ä¸ª<code>ArrayList</code>ï¼Œåˆ†åˆ«ç”¨äºå­˜å‚¨ä¸åŒç±»å‹çš„ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ï¼ŒåŒæ—¶å¯ä»¥é€šè¿‡é…ç½®é¡¹æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä»æ•°æ®åº“åŠ è½½æœªå®Œæˆä»»åŠ¡ã€‚</li><li><code>sendMessage()</code>ï¼šç”¨äºå°†è®¢å•æ·»åŠ åˆ°é€‚å½“çš„é˜Ÿåˆ—æ‰§è¡Œå™¨ï¼Œæ ¹æ®è®¢å•çš„ç±»å‹é€‰æ‹©åˆé€‚çš„æ‰§è¡Œå™¨åˆ—è¡¨ï¼Œè®¡ç®—ä»»åŠ¡æœ€å°‘çš„åˆ†åŒºå¹¶æ·»åŠ è®¢å•ã€‚</li><li><code>getQueueSize()</code>: ç”¨äºè·å–ç‰¹å®šè®¢å•çš„é˜Ÿåˆ—å¤§å°ï¼Œæ ¹æ®è®¢å•ç±»å‹é€‰æ‹©ç›¸åº”çš„é˜Ÿåˆ—æ‰§è¡Œå™¨åˆ—è¡¨å¹¶è¿”å›é˜Ÿåˆ—å¤§å°ã€‚</li><li><code>getTaskQueueExecutors()</code>ï¼šæ ¹æ®è®¢å•ç±»å‹è¿”å›ç›¸åº”çš„ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼•å…¥ä¾èµ–çš„æœåŠ¡å’Œç»„ä»¶</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ThirdManager thirdManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> QueueConfig queueConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderConsumerService orderConsumerService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸¤ä¸ªArrayListï¼Œç”¨äºå­˜å‚¨ä¸åŒç±»å‹çš„ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ï¼Œè¿™é‡Œå¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡éœ€æ±‚æ¥å®šä¹‰å¤šä¸ªã€‚</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;TaskQueueExecutor&lt;Torder&gt;&gt; paperTaskExecutors;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;TaskQueueExecutor&lt;Torder&gt;&gt; textTaskExecutors;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ–¹æ³•ï¼Œåœ¨ç±»å®ä¾‹åŒ–åè‡ªåŠ¨è°ƒç”¨ï¼Œåˆ›å»ºä¿¡æ¯ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–ã€‚</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åŠ è½½é…ç½®ï¼Œè®¾ç½®é˜Ÿåˆ—å¤§å°å’Œå¤„ç†å™¨</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> <span class="number">0</span>; idx &lt; queueConfig.getPaperTopicPartitionsNum(); idx++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> idx;</span><br><span class="line">            paperTaskExecutors.add(<span class="keyword">new</span> <span class="title class_">TaskQueueExecutor</span>&lt;&gt;(</span><br><span class="line">                String.format(<span class="string">&quot;%s-%d&quot;</span>, queueConfig.getPaperTopic(), partition),</span><br><span class="line">                <span class="number">1000</span>,</span><br><span class="line">                torder -&gt; &#123;</span><br><span class="line">                    orderConsumerService.paperConsumeMessage(torder, partition);</span><br><span class="line">                &#125;</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ è½½é…ç½®ï¼Œè®¾ç½®é˜Ÿåˆ—å¤§å°å’Œå¤„ç†å™¨</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> <span class="number">0</span>; idx &lt; queueConfig.getTextTopicPartitionsNum(); idx++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> idx;</span><br><span class="line">            textTaskExecutors.add(<span class="keyword">new</span> <span class="title class_">TaskQueueExecutor</span>&lt;&gt;(</span><br><span class="line">                String.format(<span class="string">&quot;%s-%d&quot;</span>, queueConfig.getTextTopic(), partition),</span><br><span class="line">                <span class="number">1000</span>,</span><br><span class="line">                torder -&gt; &#123;</span><br><span class="line">                    orderConsumerService.textConsumeMessage(torder, partition);</span><br><span class="line">                &#125;</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¯æ¬¡é‡å¯çš„æ—¶å€™ï¼Œä»æ•°æ®åº“åŠ è½½æœªå®Œæˆè®¢å•ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹é…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒåŠ è½½æœªå®Œæˆä»»åŠ¡ï¼Œå¼€å‘ç¯å¢ƒä¸åŠ è½½</span></span><br><span class="line">        <span class="keyword">if</span> (queueConfig.isNeedLoadFromDB()) &#123;</span><br><span class="line">            <span class="comment">// æŸ¥è¯¢æ•°æ®åº“ä¸­æœªå¤„ç†çš„è®¢å•ã€‚</span></span><br><span class="line">            List&lt;Torder&gt; orders = orderMapper.selectList(Wrappers.lambdaQuery(Torder.class).eq(Torder::getStatus, <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">for</span> (Torder torder : orders) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;æ·»åŠ æœªå¤„ç†è®¢å•ï¼š&#123;&#125;&quot;</span>, torder);</span><br><span class="line">                <span class="comment">// å°†è¿™äº›è®¢å•æ·»åŠ åˆ°é€‚å½“çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»¥ä¾¿åç»­å¤„ç†ã€‚</span></span><br><span class="line">                sendMessage(torder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºå°†è®¢å•æ¶ˆæ¯å‘é€åˆ°é€‚å½“çš„é˜Ÿåˆ—æ‰§è¡Œå™¨ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(Torder torder)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">executorOptional</span> <span class="operator">=</span> getTaskQueueExecutors(torder);</span><br><span class="line">        executorOptional.ifPresent(executors -&gt; &#123;</span><br><span class="line">            <span class="comment">// streamæ“ä½œï¼Œç”¨äºå¯»æ‰¾ä»»åŠ¡æ•°æœ€å°‘çš„é˜Ÿåˆ—ï¼Œé»˜è®¤å€¼ä¸º0</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> IntStream.range(<span class="number">0</span>, executors.size())</span><br><span class="line">                    .reduce((i, j) -&gt; executors.get(i).getTaskNum() &gt; executors.get(j).getTaskNum() ? j : i)</span><br><span class="line">                    .orElse(<span class="number">0</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">taskNum</span> <span class="operator">=</span> executors.get(partition).getTaskNum();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¿™é‡Œæ˜¯æˆ‘çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">            torder.setZone(partition);</span><br><span class="line">            orderMapper.updateById(torder);</span><br><span class="line">            log.info(<span class="string">&quot;å½“å‰æ¶ˆæ¯å…¥é˜Ÿåˆ—ï¼Œæ‰€åœ¨åˆ†åŒº&#123;&#125;, å½“å‰è®¢å•å·ä¸º&#123;&#125;, å‰é¢è¿˜æœ‰&#123;&#125;äººåœ¨æ’é˜Ÿ&quot;</span>,</span><br><span class="line">                    partition, torder.getOrderId(), executors.get(partition).getTaskNum());</span><br><span class="line">            <span class="keyword">if</span> (taskNum &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                thirdManager.sendExceptionToFeiShu(<span class="string">&quot;æŠ¥å‘Šé™é‡ï¼Œåˆ†åŒºï¼šã€&quot;</span> + partition + <span class="string">&quot;ã€‘å½“å‰æ’é˜Ÿäººæ•°å·²è¾¾ï¼šã€&quot;</span> + taskNum + <span class="string">&quot;ã€‘äººæ¬¡&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ è®¢å•åˆ°é€‰å®šçš„é˜Ÿåˆ—æ‰§è¡Œå™¨ã€‚</span></span><br><span class="line">            executors.get(partition).sendMessage(torder);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•ç”¨äºè·å–ç‰¹å®šè®¢å•çš„é˜Ÿåˆ—å¤§å°ï¼ˆå³é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†çš„è®¢å•æ•°é‡ï¼‰ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getQueueSize</span><span class="params">(Torder torder)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">executorOptional</span> <span class="operator">=</span> getTaskQueueExecutors(torder);</span><br><span class="line">        <span class="keyword">return</span> executorOptional.map(taskQueueExecutors -&gt;</span><br><span class="line">                        taskQueueExecutors.get(torder.getZone()).getTaskNum())</span><br><span class="line">                .orElse(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•ç”¨äºæ ¹æ®è®¢å•ç±»å‹è·å–ç›¸åº”çš„ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨åˆ—è¡¨ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> Optional&lt;ArrayList&lt;TaskQueueExecutor&lt;Torder&gt;&gt;&gt; <span class="title function_">getTaskQueueExecutors</span><span class="params">(Torder torder)</span> &#123;</span><br><span class="line">        ArrayList&lt;TaskQueueExecutor&lt;Torder&gt;&gt; executors;</span><br><span class="line">        <span class="keyword">if</span> (torder.getPolishType().equals(Common.POLISH_TYPE_WITH_PAPER)) &#123;</span><br><span class="line">            executors = paperTaskExecutors;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (torder.getPolishType().equals(Common.POLISH_TYPE_WITH_TEXT)) &#123;</span><br><span class="line">            executors = textTaskExecutors;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (torder.getPolishType().equals(Common.POLISH_TYPE_WITH_EXPAND)) &#123;</span><br><span class="line">            executors = textTaskExecutors;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (torder.getPolishType().equals(Common.POLISH_TYPE_WITH_RELINE)) &#123;</span><br><span class="line">            executors = textTaskExecutors;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error PolishType: &#123;&#125;&quot;</span>, torder.getPolishType());</span><br><span class="line">            <span class="keyword">return</span> Optional.empty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Optional.of(executors);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">æ‰‹å†™æ¶ˆæ¯é˜Ÿåˆ—æ›¿ä»£Kafka</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SpringBoot" scheme="https://cyborg2077.github.io/tags/SpringBoot/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://cyborg2077.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>AOPã€MDCå®ç°æ—¥å¿—è¿½è¸ª</title>
    <link href="https://cyborg2077.github.io/2023/10/03/MDCTraceLog/"/>
    <id>https://cyborg2077.github.io/2023/10/03/MDCTraceLog/</id>
    <published>2023-10-03T13:36:49.000Z</published>
    <updated>2023-10-03T15:17:14.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><ul><li>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæ—¥å¿—è¾“å‡ºæ˜¯éå¸¸é‡è¦çš„ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœ æ—¥å¿—æ‰“å¾—å¥½ï¼Œå¯ä»¥å¿«é€Ÿåœ°æ’æŸ¥é—®é¢˜ï¼Œä¸ºäº†æ›´å¥½çš„æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº›æ—¥å¿—ä¸²è”èµ·æ¥ï¼Œè¿™æ ·ä¼šä½¿æ’æŸ¥é—®é¢˜å˜å¾—æ›´åŠ è½»æ¾ã€‚æ­£å¥½æˆ‘å‰ä¸€ç¯‡æ–‡ä»‹ç»äº†ELKçš„æ­å»ºï¼Œé‚£ä¹ˆç°åœ¨æˆ‘ä»¬å†æ¥çœ‹çœ‹AOP+MDCå¦‚ä½•å®ç°æ—¥å¿—è¿½è¸ªã€‚</li><li>å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨æ—¥å¿—ä¸­è®°å½•ç”¨æˆ·çš„IPï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½åˆ†æè¯¥ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œæ—¥å¿—ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨æ—¥å¿—ä¸­è®°å½•è®¢å•IDï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬çš„è®¢å•å‡ºç°äº†é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«çš„æ¥æ ¹æ®è®¢å•IDåœ¨Kibanaä¸­æœç´¢ä¸è¯¥è®¢å•IDå…³è”çš„æ‰€æœ‰æ—¥å¿—ä¿¡æ¯ã€‚</li></ul><h2 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h2><ul><li>ä¸²è”çš„æ ¸å¿ƒåœ¨äºè¦æŠŠIDä½œä¸ºä¸€ä¸ªè¯·æ±‚å¿…ä¼ å‚æ•°ï¼Œä¾‹å¦‚æˆ‘ä»¬æ‰‹åŠ¨æ‰“å°æ—¥å¿—çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨æ—¥å¿—ä¸­åŠ ä¸Šæˆ‘ä»¬çš„ä¸šåŠ¡IDï¼Œä¾‹å¦‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;æäº¤è®¢å•å¼€å§‹ï¼š&#123;&#125;&quot;</span>, orderId);</span><br></pre></td></tr></table></figure><ul><li>ä½†æ˜¯æ­¤ç§æ–¹å¼è¾ƒä¸ºç¹çï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯æ¡æ—¥å¿—ä¸­éƒ½æ‰‹åŠ¨åŠ ä¸ŠorderIdçš„è¾“å‡ºï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰æ›´ç®€å•çš„æ–¹å¼å‘¢ï¼Ÿé¦–å…ˆæƒ³åˆ°çš„æ˜¯AOPï¼Œå› ä¸ºAOPå¯ä»¥å°†æ—¥å¿—è®°å½•çš„è¡Œä¸ºä»ä¸šåŠ¡çš„æ ¸å¿ƒé€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œè€ŒMDCæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å­˜æ”¾è¯Šæ–­æ—¥å¿—çš„å®¹å™¨ï¼Œåœ¨å¤„ç†è¯·æ±‚å‰å°†è¯·æ±‚çš„å”¯ä¸€æ ‡ç¤ºæ”¾åˆ°MDCå®¹å™¨ä¸­ï¼Œè¿™ä¸ªå”¯ä¸€æ ‡ç¤ºä¼šéšç€æ—¥å¿—ä¸€èµ·è¾“å‡ºï¼Œä»¥æ­¤æ¥åŒºåˆ†è¯¥æ¡æ—¥å¿—æ˜¯å±äºé‚£ä¸ªè¯·æ±‚çš„ã€‚å¹¶åœ¨è¯·æ±‚å¤„ç†å®Œæˆä¹‹åæ¸…é™¤MDCå®¹å™¨ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MDCAdapter</span> &#123;</span><br><span class="line">    <span class="comment">// å°†ä¸€ä¸ªk-vé”®å€¼å¯¹æ”¾åˆ°å®¹å™¨ï¼Œå…¶å®æ˜¯æ”¾åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalMapä¸­</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String var1, String var2)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®keyåœ¨å½“å‰çº¿ç¨‹çš„MDCå®¹å™¨ä¸­è·å–å¯¹åº”çš„å€¼</span></span><br><span class="line">    String <span class="title function_">get</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®keyç§»é™¤å®¹å™¨ä¸­çš„å€¼</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç©ºå½“å‰çº¿ç¨‹çš„MDCå®¹å™¨</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; <span class="title function_">getCopyOfContextMap</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setContextMap</span><span class="params">(Map&lt;String, String&gt; var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Logbacké…ç½®ï¼šä½¿ç”¨MDCæœºåˆ¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨logback.xmlæ—¥å¿—æ¨¡æ¿ä¸­è¿›è¡Œä¸€äº›é…ç½®ï¼Œé€šè¿‡ä½¿ç”¨å ä½ç¬¦<code>%X&#123;&#125;</code>æ¥å ä½ï¼Œæ›¿æ¢åˆ°å¯¹åº”MDCä¸­keyçš„å€¼ã€‚</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value=&quot;%clr(%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;)&#123;faint&#125; %clr($&#123;LOG_LEVEL_PATTERN:-%5p&#125;) %clr([$&#123;springAppName:-&#125;])&#123;yellow&#125; %clr(%X&#123;TRACE_ID&#125;)&#123;cyan&#125; %clr($&#123;PID:- &#125;)&#123;magenta&#125; %clr(---)&#123;faint&#125; %clr([%15.15t])&#123;faint&#125; %clr(%-40.40logger&#123;39&#125;)&#123;cyan&#125; %clr(:)&#123;faint&#125; %green([%X&#123;userIp&#125;]) %cyan([%X&#123;requestURI&#125;]) %green([%X&#123;orderId&#125;]) %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&quot;</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨ï¼Œå°†ç”¨æˆ·IPä¿¡æ¯è®°å½•åˆ°æ—¥å¿—ä¸­</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserIpFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_IP_MDC_KEY</span> <span class="operator">=</span> <span class="string">&quot;userIp&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_REQUEST_URI_MDC_KEY</span> <span class="operator">=</span> <span class="string">&quot;requestURI&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–ç”¨æˆ·IPå¹¶æ·»åŠ åˆ°MDC</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">userIp</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-Real-IP&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">            MDC.put(USER_IP_MDC_KEY, userIp);</span><br><span class="line">            MDC.put(USER_REQUEST_URI_MDC_KEY, requestURI);</span><br><span class="line">            <span class="comment">// ç»§ç»­è¯·æ±‚å¤„ç†</span></span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// æ¸…é™¤MDCï¼Œç¡®ä¿ä¸ä¼šå½±å“å…¶ä»–è¯·æ±‚</span></span><br><span class="line">            MDC.remove(USER_IP_MDC_KEY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="MDCç»“åˆAOP">MDCç»“åˆAOP</h2><ul><li>å› ä¸ºè¿™éƒ¨åˆ†å…¶å®æ˜¯åŠé“é‡ŒåŠ è¿›æ¥çš„ï¼Œæ‰€ä»¥å†™çš„æ¯”è¾ƒç²—ç³™ï¼Œä½†æ˜¯å®ç°æ€è·¯å°±æ˜¯ç”¨åˆ‡ç‚¹è¡¨è¾¾å¼æ¥åŒ¹é…è®¢å•ç›¸å…³ä¿¡æ¯ï¼Œä¸»è¦å°±æ˜¯Orderè¿™ä¸ªå®ä½“ç±»å’ŒorderIdè¿™ä¸ªå‚æ•°ï¼Œä½†æ˜¯åˆ‡ç‚¹ä¸æ”¯æŒåŒ¹é…å‚æ•°åï¼Œæ‰€ä»¥åŒ¹é…String orderIdçš„æ—¶å€™ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨åŒ¹é…ï¼ˆå› ä¸ºä¸æ”¯æŒå‚æ•°ååŒ¹é…ï¼ŒæŒ‰ç±»å‹åŒ¹é…ä¼šåŒ¹é…ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Stingçš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šåŒ¹é…é”™ï¼‰ã€‚</li><li>æˆ‘è¿™é‡Œçš„å»ºè®®æ˜¯é€šè¿‡æ–¹æ³•åè¿›è¡ŒåŒ¹é…ï¼Œé‚£ä¹ˆå°±éœ€è¦è®¢å•ç›¸å…³çš„æ–¹æ³•åçš„åç¼€è¿›è¡Œç»Ÿä¸€ï¼Œç„¶ååˆ‡ç‚¹è¡¨è¾¾å¼æŒ‰æ–¹æ³•ååç¼€åŒ¹é…å°±å¥½äº† <del>ï¼ˆåæœŸæœ‰ç©ºå†é‡æ„é‡æ„ä»£ç å§ï¼Œæ¯•ç«Ÿè¿™é‡Œå†™çš„å®åœ¨ä¸å¤ªå¥½ï¼‰</del></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderIdAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;(execution(* xxx.xxxx.xxx.service.OrderConsumerService.processText(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.getPaperJsonContent(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.getTextJsonObject(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.TextConsumeMessage*(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.PaperConsumeMessage*(..)))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;&amp;&amp; args(torder, ..)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderMethod1</span><span class="params">(Torder torder)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(value = &quot;orderMethod1(torder)&quot;, argNames = &quot;joinPoint,torder&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">logMethod1</span><span class="params">(ProceedingJoinPoint joinPoint, Torder torder)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Accessed method: &#123;&#125;&quot;</span>, joinPoint.getSignature().toShortString());</span><br><span class="line">        MDC.put(<span class="string">&quot;orderId&quot;</span>, torder.getOrderId());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            MDC.remove(<span class="string">&quot;orderId&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;(execution(* xxx.xxxx.xxx.web.controller.CommonController.commitJCInformation(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.impl.OrderServiceImpl.getAsyncErrorStatusOrder(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.web.controller.CommonController.getStatusByOrderId(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.web.controller.CommonController.userComment(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.impl.OrderServiceImpl.commitJCInformation(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.getTextStatusByOrderId(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.getPaperStatusByOrderId(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.manager.ThirdManager.getTaskProcessStatus(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.manager.ThirdManager.getTextTaskProcessStatus(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.manager.ThirdManager.createTextAlgorithmTask(..)))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;&amp;&amp; args(orderId, ..)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderMethod2</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(value = &quot;orderMethod2(orderId)&quot;, argNames = &quot;joinPoint,orderId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">logMethod2</span><span class="params">(ProceedingJoinPoint joinPoint, String orderId)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Accessed method: &#123;&#125;&quot;</span>, joinPoint.getSignature().toShortString());</span><br><span class="line">        MDC.put(<span class="string">&quot;orderId&quot;</span>, orderId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            MDC.remove(<span class="string">&quot;orderId&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å‰é¢å·²ç»æ­å»ºäº†ELKï¼Œé‚£ç°åœ¨å†æ¥è®²è®²æ€ä¹ˆå®ç°æ—¥å¿—è¿½è¸ª</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SpringBoot" scheme="https://cyborg2077.github.io/tags/SpringBoot/"/>
    
    <category term="AOP" scheme="https://cyborg2077.github.io/tags/AOP/"/>
    
    <category term="æ—¥å¿—åˆ†æ" scheme="https://cyborg2077.github.io/tags/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/"/>
    
    <category term="MDC" scheme="https://cyborg2077.github.io/tags/MDC/"/>
    
  </entry>
  
  <entry>
    <title>AOPå°è£…ä¸€ä¸ªè®°å½•è€—æ—¶çš„æ³¨è§£</title>
    <link href="https://cyborg2077.github.io/2023/10/03/TakeTimeLog/"/>
    <id>https://cyborg2077.github.io/2023/10/03/TakeTimeLog/</id>
    <published>2023-10-03T07:16:34.000Z</published>
    <updated>2023-10-03T08:38:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€è¿°">ç®€è¿°</h2><ul><li>ä¸Šç¯‡æ–‡ç« è¯´çš„æ˜¯ä½¿ç”¨Arthasæ¥åˆ†æè€—æ—¶ï¼Œä½†æ˜¯æ•´ä½“æµç¨‹è¿˜æ˜¯æŒºç¹ççš„ï¼Œé‚£è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±ç”¨AOPæ¥å°è£…ä¸€ä¸ªè®°å½•è€—æ—¶çš„æ³¨è§£å§ï¼Œè™½ç„¶åšä¸åˆ°åˆ†ææ•´ä¸ªè°ƒç”¨é“¾è·¯ä¸Šçš„è€—æ—¶æƒ…å†µï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬å¸Œæœ›è®°å½•è€—æ—¶çš„æ–¹æ³•ä¸ŠåŠ ä¸Šå¯¹åº”çš„æ³¨è§£ï¼Œæ¥è®°å½•å¯¹åº”çš„è€—æ—¶ã€‚</li></ul><h2 id="ä»£ç å®ç°">ä»£ç å®ç°</h2><ul><li>é‚£ç°åœ¨æˆ‘ä»¬æ¥ä»å¤´ç¼–å†™ä¸€ä¸ªTakeTimeAspectç±»ï¼Œè¯¥ç±»é€šè¿‡AOPçš„æ–¹å¼æ¥ç›‘æ§æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œå¹¶ä¸”è®°å½•ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯ã€‚é¦–å…ˆå¯¼å…¥AOPçš„ä¾èµ–</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ä»£ç å®ç°  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TakeTimeAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ThreadLocalå˜é‡ç”¨äºå­˜å‚¨å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´</span></span><br><span class="line">    ThreadLocal&lt;Long&gt; startTime = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    ThreadLocal&lt;Long&gt; endTime = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼ŒåŒ¹é…å¸¦æœ‰@TakeTimeLogæ³¨è§£çš„æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.aimc.paperreduction.common.annotation.TakeTimeLog)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">TakeTime</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‰ç½®å¢å¼ºæ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œå‰è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="meta">@Before(&quot;TakeTime()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBefore</span><span class="params">(JoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// è·å¾—æ³¨è§£</span></span><br><span class="line">        <span class="type">TakeTimeLog</span> <span class="variable">timeLog</span> <span class="operator">=</span> getAnnotationLog(joinPoint);</span><br><span class="line">        <span class="keyword">if</span> (timeLog == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        startTime.set(System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›åå¢å¼ºæ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œåè®°å½•ç»“æŸæ—¶é—´å’Œæ‰§è¡Œæ—¶é—´ï¼Œå¹¶è®°å½•æ—¥å¿—</span></span><br><span class="line">    <span class="meta">@AfterReturning(returning = &quot;ret&quot;, pointcut = &quot;TakeTime()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterReturning</span><span class="params">(JoinPoint joinPoint, Object ret)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        String[] names = ((CodeSignature) joinPoint.getSignature()).getParameterNames();</span><br><span class="line">        <span class="keyword">if</span> (names.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; names.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(joinPoint.getArgs()[i] <span class="keyword">instanceof</span> HttpServletRequest)) &#123;</span><br><span class="line">                    resultMap.put(names[i], joinPoint.getArgs()[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤„ç†å®Œè¯·æ±‚åï¼Œè¿”å›å†…å®¹</span></span><br><span class="line">        log.info(<span class="string">&quot;Return:&quot;</span> + JSON.toJSONString(ret));</span><br><span class="line">        endTime.set(System.currentTimeMillis());</span><br><span class="line">        log.info(<span class="string">&quot;Execution Time:&quot;</span> + (endTime.get() - startTime.get()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºè·å–æ–¹æ³•ä¸Šçš„æ³¨è§£</span></span><br><span class="line">    <span class="keyword">private</span> TakeTimeLog <span class="title function_">getAnnotationLog</span><span class="params">(JoinPoint joinPoint)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> joinPoint.getSignature();</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">methodSignature</span> <span class="operator">=</span> (MethodSignature) signature;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> methodSignature.getMethod();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.getAnnotation(TakeTimeLog.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>ThreadLocal&lt;Long&gt; startTime</code> å’Œ <code>ThreadLocal&lt;Long&gt; endTime</code>ï¼šè¿™ä¸¤ä¸ªæ˜¯ThreadLocalå˜é‡ï¼Œç”¨äºå­˜å‚¨æ–¹æ³•æ‰§è¡Œçš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼Œç”¨äºè®¡ç®—æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ã€‚ThreadLocalå…è®¸å­˜å‚¨æ¯ä¸ªçº¿ç¨‹ç‰¹å®šçš„æ•°æ®ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§ã€‚</li><li>åˆ‡ç‚¹è¡¨è¾¾å¼ï¼š<code>@Pointcut(&quot;@annotation(com.aimc.paperreduction.common.annotation.TakeTimeLog)&quot;)</code>ï¼ŒåŒ¹é…å¸¦æœ‰@TakeTimeLogæ³¨è§£çš„æ–¹æ³•ã€‚</li><li>å¢å¼ºæ–¹æ³•<ol><li><code>@Before(&quot;TakeTime()&quot;)</code>ï¼šåœ¨åŒ¹é…TakeTimeåˆ‡å…¥ç‚¹çš„æ–¹æ³•ä¹‹å‰æ‰§è¡Œã€‚å®ƒæ•è·æ–¹æ³•æ‰§è¡Œå¼€å§‹çš„æ—¶é—´ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥è·å–æ›´å¤šçš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ–¹æ³•å‚æ•°ä¹‹ç±»çš„ä¿¡æ¯éƒ½å¯ä»¥æ‹¿åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬æ ¹æ®è‡ªèº«é¡¹ç›®çš„éœ€æ±‚æ¥ç¼–å†™ã€‚</li><li>@<code>AfterReturning(returning = &quot;ret&quot;, pointcut = &quot;TakeTime()&quot;)</code>ï¼šè¿™æ˜¯ä¸€ä¸ªè¿”å›åå¢å¼ºæ–¹æ³•ã€‚å®ƒæ•è·æ–¹æ³•çš„ç»“æŸæ—¶é—´ï¼Œè®°å½•è¿”å›å€¼ï¼Œå¹¶è®¡ç®—å¹¶è®°å½•æ‰§è¡Œæ—¶é—´ã€‚</li></ol></li><li><code>getAnnotationLog</code>ï¼šè¿™æ˜¯ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œç”¨äºä»ç›®æ ‡æ–¹æ³•ä¸­è·å–TakeTimeLogæ³¨è§£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚</li></ul></li></ul><h2 id="ä½¿ç”¨æ–¹å¼">ä½¿ç”¨æ–¹å¼</h2><ul><li>æˆ‘ä»¬åœ¨éœ€è¦è®°å½•è€—æ—¶çš„æ–¹æ³•ä¸ŠåŠ ä¸Šæ­¤æ³¨è§£å³å¯</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TakeTimeLog</span></span><br><span class="line"><span class="keyword">public</span> Wrapper&lt;UploadPaperDTO&gt; <span class="title function_">uploadDoc</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ä½ çš„ä»£ç é€»è¾‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ç®€å•å†™ä¸ªå°ç©æ„</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SpringBoot" scheme="https://cyborg2077.github.io/tags/SpringBoot/"/>
    
    <category term="æ€§èƒ½åˆ†æ" scheme="https://cyborg2077.github.io/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"/>
    
    <category term="AOP" scheme="https://cyborg2077.github.io/tags/AOP/"/>
    
  </entry>
  
  <entry>
    <title>Arthasæ’æŸ¥SpringBootçš„è€—æ—¶</title>
    <link href="https://cyborg2077.github.io/2023/09/07/ArthasAnalyzing/"/>
    <id>https://cyborg2077.github.io/2023/09/07/ArthasAnalyzing/</id>
    <published>2023-09-07T07:16:34.000Z</published>
    <updated>2023-09-07T07:16:34.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€è¿°">ç®€è¿°</h2><ul><li>Arthaså®˜ç½‘ï¼š<a href="https://arthas.aliyun.com/">https://arthas.aliyun.com/</a></li><li>Arthasï¼ˆAlibaba Java Diagnostic Toolï¼‰æ˜¯ä¸€ä¸ªå¼ºå¤§çš„Javaè¯Šæ–­å·¥å…·ï¼Œå®ƒå¯ä»¥ç›‘æ§å’Œåˆ†æè¿è¡Œä¸­çš„Javaåº”ç”¨ç¨‹åºã€‚å®ƒé‡‡ç”¨äº†å­—èŠ‚ç æ³¨å…¥çš„æ–¹å¼æ¥å®ç°ç›‘æ§å’Œè°ƒè¯•åŠŸèƒ½ã€‚</li></ul><h2 id="åº•å±‚åŸç†">åº•å±‚åŸç†</h2><ol><li>å­—èŠ‚ç æ³¨å…¥ï¼šArthasä½¿ç”¨å­—èŠ‚ç æ³¨å…¥æŠ€æœ¯ï¼Œé€šè¿‡ä¿®æ”¹ç›®æ ‡Javaç¨‹åºçš„å­—èŠ‚ç æ¥åŠ¨æ€æ³¨å…¥ç›‘æ§ä»£ç å’Œæ”¶é›†æ€§èƒ½ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œé‡æ–°ç¼–è¯‘æˆ–è€…é‡å¯ï¼Œå› ä¸ºé‡å¯ä¹‹åé—®é¢˜å¯èƒ½ä¸å®¹æ˜“å¤ç°ï¼Œå› æ­¤å¯ä»¥åœ¨è¿è¡Œæ—¶å¯¹å…¶è¿›è¡Œè¯Šæ–­å’Œåˆ†æã€‚</li><li>Instrumentation APIï¼šArthasä½¿ç”¨Javaçš„Instrumentation APIæ¥å®ç°å­—èŠ‚ç æ³¨å…¥ã€‚è¿™ä¸ªAPIè¿è¡Œç±»åŠ è½½å™¨ä¼šåœ¨åŠ è½½ç±»æ—¶ï¼Œå¯¹ç±»çš„å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼ŒArthasé€šè¿‡è¿™ä¸ªAPIæ¥æ³¨å…¥è‡ªå·±çš„ç›‘æ§ä»£ç ï¼Œä»¥ä¾¿æ•è·æ–¹æ³•æ‰§è¡Œã€æ€§èƒ½ç»Ÿè®¡ç­‰ä¿¡æ¯ã€‚</li><li>Agentæ–¹å¼ï¼šArthasä»¥Java Agentçš„å½¢å¼è¿è¡Œï¼Œé€šè¿‡JVMçš„Agentæœºåˆ¶åŠ è½½åˆ°ç›®æ ‡åº”ç”¨ç¨‹åºä¸­ã€‚Java Agentæ˜¯ä¸€ç§è¿è¡Œåœ¨Javaç¨‹åºä¹‹å¤–çš„Javaç¨‹åºï¼Œå¯ä»¥åœ¨ç›®æ ‡åº”ç”¨è¿è¡Œæ—¶è¢«åŠ¨æ€åœ°é™„åŠ åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ï¼Œå¹¶ä¸ä¹‹äº¤äº’ã€‚</li></ol><h2 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h2><ul><li><p>ç”±äºæ‰§è¡ŒArthasç¨‹åºçš„ç”¨æˆ·éœ€è¦ä¸ç›®æ ‡è¿›ç¨‹å…·æœ‰ç›¸åŒçš„æƒé™ï¼Œç›®å‰å…¬å¸çš„é¡¹ç›®éƒ½æ˜¯é€šè¿‡å®¹å™¨å¯åŠ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦è¿›å…¥JavaæœåŠ¡å®¹å™¨çš„å†…éƒ¨ï¼Œç„¶åä¸‹è½½Arthasçš„jaråŒ…ï¼Œç„¶åå†å¯åŠ¨ï¼ˆWindowsç¯å¢ƒä¸‹ç›´æ¥åœ¨CMDçª—å£è¿è¡Œå³å¯ï¼‰</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://arthas.aliyun.com/arthas-boot.jar</span><br><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ä¹‹åå°±ä¼šåˆ—å‡ºå½“å‰æ‰€æœ‰çš„Javaè¿›ç¨‹ï¼Œæˆ‘ä»¬æ ¹æ®è‡ªèº«éœ€æ±‚æ¥é€‰æ‹©è¦ç›‘æ§çš„Javaè¿›ç¨‹</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@ff3c3ed00ac8:/data<span class="comment"># java -jar arthas-boot.jar </span></span><br><span class="line">    [INFO] JAVA_HOME: /usr/local/openjdk-8/jre</span><br><span class="line">    [INFO] arthas-boot version: 3.7.1</span><br><span class="line">    [INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class="line">    * [1]: 7 /data/PaperReduction.jar</span><br><span class="line">    <span class="comment"># æ‰¾åˆ°ä¸€ä¸ªJavaè¿›ç¨‹ï¼ŒæŒ‰ä¸‹å¯¹åº”çš„æ•°å­—é”®æ¥è¿›è¡Œç›‘æ§</span></span><br><span class="line">    1</span><br><span class="line">    [INFO] arthas home: /root/.arthas/lib/3.7.1/arthas</span><br><span class="line">    [INFO] The target process already listen port 3658, skip attach.</span><br><span class="line">    [INFO] arthas-client connect 127.0.0.1 3658</span><br><span class="line">    ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           </span><br><span class="line">    /  O  \ |  .--. <span class="string">&#x27;&#x27;</span>--.  .--<span class="string">&#x27;|  &#x27;</span>--<span class="string">&#x27;  | /  O  \ &#x27;</span>   .-<span class="string">&#x27;                          </span></span><br><span class="line"><span class="string">    |  .-.  ||  &#x27;</span>--<span class="string">&#x27;.&#x27;</span>   |  |   |  .--.  ||  .-.  |`.  `-.                          </span><br><span class="line">    |  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="string">&#x27;    |                         </span></span><br><span class="line"><span class="string">    `--&#x27;</span> `--<span class="string">&#x27;`--&#x27;</span> <span class="string">&#x27;--&#x27;</span>   `--<span class="string">&#x27;   `--&#x27;</span>  `--<span class="string">&#x27;`--&#x27;</span> `--<span class="string">&#x27;`-----&#x27;</span>                          </span><br><span class="line">    </span><br><span class="line">    wiki       https://arthas.aliyun.com/doc                                        </span><br><span class="line">    tutorials  https://arthas.aliyun.com/doc/arthas-tutorials.html                  </span><br><span class="line">    version    3.7.1                                                                </span><br><span class="line">    main_class                                                                      </span><br><span class="line">    pid        7                                                                    </span><br><span class="line">    time       2023-09-06 19:15:06        </span><br><span class="line"></span><br><span class="line">[arthas@7]$                                           </span><br></pre></td></tr></table></figure></li><li><p>é‚£ä¹ˆç°åœ¨çš„éœ€æ±‚æ˜¯åˆ†æä»Springæ¡†æ¶æ¥æ”¶åˆ°HTTPè¯·æ±‚ï¼Œç„¶ååˆ†æ´¾åˆ°å¯¹åº”çš„Controlleræ–¹æ³•ä¹‹é—´çš„è€—æ—¶ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨Arthasçš„ä¸€ä¸ªå°åŠŸèƒ½traceï¼Œå®ƒå¯ä»¥åŠ¨æ€åœ°è®¡ç®—æ–¹æ³•è°ƒç”¨è·¯å¾„å’Œè€—æ—¶ã€‚</p><ol><li>traceæ–¹æ³•å†…éƒ¨è°ƒç”¨è·¯å¾„ï¼Œå¹¶è¾“å‡ºæ–¹æ³•è·¯å¾„ä¸Šæ¯ä¸ªèŠ‚ç‚¹çš„è€—æ—¶ã€‚</li><li>traceå‘½ä»¤èƒ½ä¸»åŠ¨æœç´¢class-pattern/method-patternï¼Œå¯¹åº”çš„æ–¹æ³•å¸¦å“¦ç”¨è·¯å¾„ï¼Œæ¸²æŸ“å’Œç»Ÿè®¡æ•´ä¸ªè°ƒç”¨é“¾è·¯ä¸Šçš„æ‰€æœ‰æ€§èƒ½å¼€é”€å’Œè¿½è¸ªè°ƒç”¨é“¾è·¯ã€‚</li></ol></li><li><p>å†äº†è§£ä¸¤ä¸ªå°æ¦‚å¿µ</p><ol><li>DispatcherServletï¼ˆorg.springframework.web.servlet.DispatcherServletï¼‰ï¼šDispatcherServlet æ˜¯Spring MVCçš„æ ¸å¿ƒï¼Œå®ƒè´Ÿè´£æ¥æ”¶HTTPè¯·æ±‚å¹¶å°†è¯·æ±‚åˆ†æ´¾ç»™ç›¸åº”çš„Controllerã€‚æˆ‘ä»¬å¯ä»¥ä»DispatcherServletçš„è¯·æ±‚å¤„ç†æ–¹æ³•å…¥æ‰‹ï¼Œåˆ†æè¯·æ±‚çš„è°ƒç”¨é“¾å’Œå¤„ç†æ—¶é—´ã€‚</li><li>HandlerMappingï¼ˆorg.springframework.web.servlet.HandlerMappingï¼‰ï¼šHandlerMapping è´Ÿè´£å°†è¯·æ±‚æ˜ å°„åˆ°å…·ä½“çš„Controlleræ–¹æ³•ã€‚æ‚¨å¯ä»¥åˆ†æä¸åŒçš„HandlerMappingå®ç°ï¼Œä»¥äº†è§£è¯·æ±‚åˆ°Controlleræ–¹æ³•çš„æ˜ å°„è¿‡ç¨‹ã€‚</li></ol></li><li><p>é‚£æˆ‘ä»¬ç°åœ¨æ‰§è¡Œ <code>trace org.springframework.web.servlet.DispatcherServlet *</code> æ¥åˆ†æä¸€ä¸‹è°ƒç”¨é“¾ä¸Šéƒ½ç»è¿‡äº†ä»€ä¹ˆ</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">`---ts=2023-09-07 10:27:40;thread_name=http-nio-80-exec-5;<span class="built_in">id</span>=33;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[5.59488ms] org.springframework.web.servlet.DispatcherServlet:doService()</span><br><span class="line">        +---[0.63% 0.035364ms ] org.springframework.web.servlet.DispatcherServlet:logRequest() <span class="comment">#926</span></span><br><span class="line">        |   `---[59.32% 0.020979ms ] org.springframework.web.servlet.DispatcherServlet:logRequest()</span><br><span class="line">        |       `---[28.81% 0.006045ms ] org.springframework.core.log.LogFormatUtils:traceDebug() <span class="comment">#980</span></span><br><span class="line">        +---[0.12% 0.006831ms ] org.springframework.web.util.WebUtils:isIncludeRequest() <span class="comment">#931</span></span><br><span class="line">        +---[0.10% 0.005813ms ] org.springframework.web.servlet.DispatcherServlet:getWebApplicationContext() <span class="comment">#943</span></span><br><span class="line">        +---[0.07% 0.004058ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#943</span></span><br><span class="line">        +---[0.06% 0.003624ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#944</span></span><br><span class="line">        +---[0.06% 0.003435ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#945</span></span><br><span class="line">        +---[0.61% 0.034354ms ] org.springframework.web.servlet.DispatcherServlet:getThemeSource() <span class="comment">#946</span></span><br><span class="line">        |   `---[61.47% 0.021117ms ] org.springframework.web.servlet.DispatcherServlet:getThemeSource()</span><br><span class="line">        |       `---[46.43% min=0.0046ms,max=0.005205ms,total=0.009805ms,count=2] org.springframework.web.servlet.DispatcherServlet:getWebApplicationContext() <span class="comment">#806</span></span><br><span class="line">        +---[0.06% 0.003434ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#946</span></span><br><span class="line">        +---[0.22% 0.012272ms ] org.springframework.web.servlet.FlashMapManager:retrieveAndUpdate() <span class="comment">#949</span></span><br><span class="line">        +---[0.16% 0.008744ms ] org.springframework.web.servlet.FlashMap:&lt;init&gt;() <span class="comment">#953</span></span><br><span class="line">        +---[0.12% 0.006509ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#953</span></span><br><span class="line">        +---[0.09% 0.004867ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#954</span></span><br><span class="line">        +---[0.07% 0.003641ms ] javax.servlet.http.HttpServletRequest:getAttribute() <span class="comment">#959</span></span><br><span class="line">        +---[2.51% 0.140331ms ] org.springframework.web.util.ServletRequestPathUtils:parseAndCache() <span class="comment">#960</span></span><br><span class="line">        +---[92.44% 5.172017ms ] org.springframework.web.servlet.DispatcherServlet:doDispatch() <span class="comment">#964</span></span><br><span class="line">        |   `---[99.30% 5.136033ms ] org.springframework.web.servlet.DispatcherServlet:doDispatch()</span><br><span class="line">        |       +---[0.13% 0.006484ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#1036</span></span><br><span class="line">        |       +---[0.72% 0.036845ms ] org.springframework.web.servlet.DispatcherServlet:checkMultipart() <span class="comment">#1043</span></span><br><span class="line">        |       |   `---[55.87% 0.020586ms ] org.springframework.web.servlet.DispatcherServlet:checkMultipart()</span><br><span class="line">        |       |       `---[55.39% 0.011402ms ] org.springframework.web.multipart.MultipartResolver:isMultipart() <span class="comment">#1197</span></span><br><span class="line">        |       +---[5.09% 0.261359ms ] org.springframework.web.servlet.DispatcherServlet:getHandler() <span class="comment">#1047</span></span><br><span class="line">        |       |   `---[94.84% 0.247868ms ] org.springframework.web.servlet.DispatcherServlet:getHandler()</span><br><span class="line">        |       |       `---[94.99% 0.235439ms ] org.springframework.web.servlet.HandlerMapping:getHandler() <span class="comment">#1265</span></span><br><span class="line">        |       +---[0.11% 0.005579ms ] org.springframework.web.servlet.HandlerExecutionChain:getHandler() <span class="comment">#1054</span></span><br><span class="line">        |       +---[0.62% 0.031705ms ] org.springframework.web.servlet.DispatcherServlet:getHandlerAdapter() <span class="comment">#1054</span></span><br><span class="line">        |       |   `---[56.86% 0.018028ms ] org.springframework.web.servlet.DispatcherServlet:getHandlerAdapter()</span><br><span class="line">        |       |       `---[32.95% 0.005941ms ] org.springframework.web.servlet.HandlerAdapter:supports() <span class="comment">#1301</span></span><br><span class="line">        |       +---[0.06% 0.003195ms ] javax.servlet.http.HttpServletRequest:getMethod() <span class="comment">#1057</span></span><br><span class="line">        |       +---[0.11% 0.00577ms ] org.springframework.http.HttpMethod:matches() <span class="comment">#1058</span></span><br><span class="line">        |       +---[0.05% 0.00277ms ] org.springframework.http.HttpMethod:matches() <span class="comment">#1059</span></span><br><span class="line">        |       +---[40.64% 2.08729ms ] org.springframework.web.servlet.HandlerExecutionChain:applyPreHandle() <span class="comment">#1066</span></span><br><span class="line">        |       +---[0.08% 0.004206ms ] org.springframework.web.servlet.HandlerExecutionChain:getHandler() <span class="comment">#1071</span></span><br><span class="line">        |       +---[47.64% 2.44697ms ] org.springframework.web.servlet.HandlerAdapter:handle() <span class="comment">#1071</span></span><br><span class="line">        |       +---[0.11% 0.00578ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1073</span></span><br><span class="line">        |       +---[0.77% 0.039313ms ] org.springframework.web.servlet.DispatcherServlet:applyDefaultViewName() <span class="comment">#1077</span></span><br><span class="line">        |       |   `---[34.47% 0.01355ms ] org.springframework.web.servlet.DispatcherServlet:applyDefaultViewName()</span><br><span class="line">        |       +---[0.16% 0.008038ms ] org.springframework.web.servlet.HandlerExecutionChain:applyPostHandle() <span class="comment">#1078</span></span><br><span class="line">        |       +---[1.41% 0.072602ms ] org.springframework.web.servlet.DispatcherServlet:processDispatchResult() <span class="comment">#1088</span></span><br><span class="line">        |       |   `---[66.42% 0.04822ms ] org.springframework.web.servlet.DispatcherServlet:processDispatchResult()</span><br><span class="line">        |       |       +---[6.78% 0.003268ms ] org.apache.commons.logging.Log:isTraceEnabled() <span class="comment">#1155</span></span><br><span class="line">        |       |       +---[10.20% 0.004917ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#1160</span></span><br><span class="line">        |       |       +---[5.81% 0.0028ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1160</span></span><br><span class="line">        |       |       `---[16.01% 0.007718ms ] org.springframework.web.servlet.HandlerExecutionChain:triggerAfterCompletion() <span class="comment">#1167</span></span><br><span class="line">        |       `---[0.11% 0.00572ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1098</span></span><br><span class="line">        +---[0.09% 0.004919ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#967</span></span><br><span class="line">        +---[0.05% 0.002756ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#967</span></span><br><span class="line">        `---[0.20% 0.011002ms ] org.springframework.web.util.ServletRequestPathUtils:setParsedRequestPath() <span class="comment">#974</span></span><br></pre></td></tr></table></figure><ol><li><code>doService()</code> æ–¹æ³•ï¼šé¦–å…ˆï¼Œè¯·æ±‚è¿›å…¥ <code>DispatcherServlet</code> çš„ <code>doService()</code> æ–¹æ³•ã€‚è¿™æ˜¯è¯·æ±‚å¤„ç†çš„å…¥å£ç‚¹ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šè¿›è¡Œä»¥ä¸‹ä¸€äº›é‡è¦çš„æ“ä½œï¼š<ol><li><code>logRequest()</code> æ–¹æ³•ï¼šè¿™ä¸ªæ–¹æ³•ç”¨äºè®°å½•è¯·æ±‚çš„ä¿¡æ¯ï¼Œä¾‹å¦‚è¯·æ±‚çš„HTTPæ–¹æ³•ã€URIç­‰ã€‚å®ƒé€šå¸¸ç”¨äºè°ƒè¯•å’Œæ—¥å¿—è®°å½•ç›®çš„ã€‚</li><li><code>isIncludeRequest()</code> æ–¹æ³•ï¼šæ£€æŸ¥å½“å‰è¯·æ±‚æ˜¯å¦æ˜¯åŒ…å«ï¼ˆincludeï¼‰è¯·æ±‚ã€‚åŒ…å«è¯·æ±‚æ˜¯æŒ‡ä¸€ä¸ªServletå¯ä»¥åŒ…å«å¦ä¸€ä¸ªServletçš„å“åº”å†…å®¹ã€‚</li><li><code>getWebApplicationContext()</code> æ–¹æ³•ï¼šè·å–Springçš„Webåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œè¯¥ä¸Šä¸‹æ–‡åŒ…å«äº†Springåº”ç”¨ç¨‹åºä¸­çš„å„ç§beanå®šä¹‰å’Œé…ç½®ã€‚</li><li><code>setAttribute()</code> æ–¹æ³•ï¼šåœ¨ <code>HttpServletRequest</code> å¯¹è±¡ä¸­è®¾ç½®ä¸€äº›å±æ€§ï¼Œä»¥ä¾¿åç»­çš„å¤„ç†å¯ä»¥è®¿é—®è¿™äº›å±æ€§ã€‚è¿™é€šå¸¸ç”¨äºåœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ä¼ é€’æ•°æ®ã€‚</li><li><code>getThemeSource()</code> æ–¹æ³•ï¼šè·å–ä¸»é¢˜èµ„æºï¼Œä¸»é¢˜é€šå¸¸ç”¨äºå®šåˆ¶åº”ç”¨ç¨‹åºçš„å¤–è§‚ã€‚</li></ol></li><li><code>doDispatch()</code> æ–¹æ³•ï¼šåœ¨ <code>doService()</code> ä¸­ï¼Œ<code>DispatcherServlet</code> è°ƒç”¨ <code>doDispatch()</code> æ–¹æ³•ï¼Œè¿™æ˜¯å®é™…çš„è¯·æ±‚åˆ†å‘å’Œå¤„ç†çš„å…³é”®æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šè¿›è¡Œä»¥ä¸‹æ“ä½œï¼š<ol><li><code>getAsyncManager()</code> æ–¹æ³•ï¼šè·å–å¼‚æ­¥è¯·æ±‚ç®¡ç†å™¨ï¼Œç”¨äºå¤„ç†å¼‚æ­¥è¯·æ±‚ã€‚</li><li><code>checkMultipart()</code> æ–¹æ³•ï¼šæ£€æŸ¥è¯·æ±‚æ˜¯å¦åŒ…å«å¤šéƒ¨åˆ†ï¼ˆmultipartï¼‰å†…å®¹ï¼Œé€šå¸¸ç”¨äºæ–‡ä»¶ä¸Šä¼ ã€‚</li><li><code>getHandler()</code> æ–¹æ³•ï¼šè·å–ç”¨äºå¤„ç†è¯·æ±‚çš„å¤„ç†å™¨ï¼ˆHandlerï¼‰ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯å†³å®šå¦‚ä½•å¤„ç†è¯·æ±‚çš„å…³é”®ç‚¹ã€‚<ul><li><code>getHandlerMapping()</code> æ–¹æ³•ï¼šè·å–ç”¨äºæŸ¥æ‰¾å¤„ç†å™¨çš„Handler Mappingã€‚Handler Mapping æ ¹æ®è¯·æ±‚çš„URLæˆ–å…¶ä»–æ¡ä»¶ï¼Œå°†è¯·æ±‚æ˜ å°„åˆ°é€‚å½“çš„å¤„ç†å™¨æ–¹æ³•ã€‚</li><li>ä¸€æ—¦æ‰¾åˆ°äº†åˆé€‚çš„å¤„ç†å™¨ï¼Œå®ƒä¼šè¢«è¿”å›ï¼Œä»¥ä¾¿åç»­çš„è¯·æ±‚å¤„ç†ã€‚</li></ul></li></ol></li></ol><ul><li>ä¸‹é¢æ˜¯æˆ‘ä¸Šä¼ äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°è€—æ—¶ç»å¤§éƒ¨åˆ†éƒ½æ˜¯åœ¨checkMultipart()æ–¹æ³•ä¸Šï¼Œç­‰ä¸‹æ¬¡ä¸Šä¼ æ–‡ä»¶å¼‚å¸¸ç¼“æ…¢çš„æ—¶å€™ï¼Œå¯ä»¥ç»“åˆNginxæ—¥å¿—ä¸­çš„å“åº”è€—æ—¶å’Œè¿™é‡Œçš„è€—æ—¶æ¥åˆ†æåˆ°åº•æ˜¯å“ªä¸ªæ­¥éª¤æ…¢</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">`---ts=2023-09-07 11:00:24;thread_name=http-nio-80-exec-7;<span class="built_in">id</span>=35;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[725.449628ms] org.springframework.web.servlet.DispatcherServlet:doService()</span><br><span class="line">        +---[0.17% 1.209254ms ] org.springframework.web.servlet.DispatcherServlet:logRequest() <span class="comment">#926</span></span><br><span class="line">        |   `---[97.75% 1.182007ms ] org.springframework.web.servlet.DispatcherServlet:logRequest()</span><br><span class="line">        |       `---[6.82% 0.080573ms ] org.springframework.core.log.LogFormatUtils:traceDebug() <span class="comment">#980</span></span><br><span class="line">        +---[0.00% 0.014693ms ] org.springframework.web.util.WebUtils:isIncludeRequest() <span class="comment">#931</span></span><br><span class="line">        +---[0.00% 0.012721ms ] org.springframework.web.servlet.DispatcherServlet:getWebApplicationContext() <span class="comment">#943</span></span><br><span class="line">        +---[0.00% 0.016321ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#943</span></span><br><span class="line">        +---[0.00% 0.003773ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#944</span></span><br><span class="line">        +---[0.00% 0.005059ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#945</span></span><br><span class="line">        +---[0.01% 0.06607ms ] org.springframework.web.servlet.DispatcherServlet:getThemeSource() <span class="comment">#946</span></span><br><span class="line">        |   `---[62.24% 0.041121ms ] org.springframework.web.servlet.DispatcherServlet:getThemeSource()</span><br><span class="line">        |       `---[28.35% min=0.004431ms,max=0.007225ms,total=0.011656ms,count=2] org.springframework.web.servlet.DispatcherServlet:getWebApplicationContext() <span class="comment">#806</span></span><br><span class="line">        +---[0.00% 0.005496ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#946</span></span><br><span class="line">        +---[0.00% 0.021549ms ] org.springframework.web.servlet.FlashMapManager:retrieveAndUpdate() <span class="comment">#949</span></span><br><span class="line">        +---[0.00% 0.018169ms ] org.springframework.web.servlet.FlashMap:&lt;init&gt;() <span class="comment">#953</span></span><br><span class="line">        +---[0.00% 0.004453ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#953</span></span><br><span class="line">        +---[0.00% 0.007301ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#954</span></span><br><span class="line">        +---[0.00% 0.010647ms ] javax.servlet.http.HttpServletRequest:getAttribute() <span class="comment">#959</span></span><br><span class="line">        +---[0.09% 0.633634ms ] org.springframework.web.util.ServletRequestPathUtils:parseAndCache() <span class="comment">#960</span></span><br><span class="line">        +---[99.66% 722.964056ms ] org.springframework.web.servlet.DispatcherServlet:doDispatch() <span class="comment">#964</span></span><br><span class="line">        |   `---[100.00% 722.939122ms ] org.springframework.web.servlet.DispatcherServlet:doDispatch()</span><br><span class="line">        |       +---[0.00% 0.011085ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#1036</span></span><br><span class="line">        |       +---[4.74% 34.255344ms ] org.springframework.web.servlet.DispatcherServlet:checkMultipart() <span class="comment">#1043</span></span><br><span class="line">        |       |   `---[99.94% 34.235142ms ] org.springframework.web.servlet.DispatcherServlet:checkMultipart()</span><br><span class="line">        |       |       +---[0.05% 0.017859ms ] org.springframework.web.multipart.MultipartResolver:isMultipart() <span class="comment">#1197</span></span><br><span class="line">        |       |       +---[0.03% 0.010256ms ] org.springframework.web.util.WebUtils:getNativeRequest() <span class="comment">#1198</span></span><br><span class="line">        |       |       +---[0.13% 0.046108ms ] org.springframework.web.servlet.DispatcherServlet:hasMultipartException() <span class="comment">#1203</span></span><br><span class="line">        |       |       |   `---[65.16% 0.030045ms ] org.springframework.web.servlet.DispatcherServlet:hasMultipartException()</span><br><span class="line">        |       |       |       `---[18.36% 0.005515ms ] javax.servlet.http.HttpServletRequest:getAttribute() <span class="comment">#1230</span></span><br><span class="line">        |       |       `---[99.65% 34.116944ms ] org.springframework.web.multipart.MultipartResolver:resolveMultipart() <span class="comment">#1209</span></span><br><span class="line">        |       +---[0.12% 0.836273ms ] org.springframework.web.servlet.DispatcherServlet:getHandler() <span class="comment">#1047</span></span><br><span class="line">        |       |   `---[96.10% 0.803643ms ] org.springframework.web.servlet.DispatcherServlet:getHandler()</span><br><span class="line">        |       |       `---[88.91% 0.714557ms ] org.springframework.web.servlet.HandlerMapping:getHandler() <span class="comment">#1265</span></span><br><span class="line">        |       +---[0.00% 0.011929ms ] org.springframework.web.servlet.HandlerExecutionChain:getHandler() <span class="comment">#1054</span></span><br><span class="line">        |       +---[0.01% 0.05063ms ] org.springframework.web.servlet.DispatcherServlet:getHandlerAdapter() <span class="comment">#1054</span></span><br><span class="line">        |       |   `---[63.99% 0.032397ms ] org.springframework.web.servlet.DispatcherServlet:getHandlerAdapter()</span><br><span class="line">        |       |       `---[37.22% 0.012058ms ] org.springframework.web.servlet.HandlerAdapter:supports() <span class="comment">#1301</span></span><br><span class="line">        |       +---[0.00% 0.008964ms ] javax.servlet.http.HttpServletRequest:getMethod() <span class="comment">#1057</span></span><br><span class="line">        |       +---[0.00% 0.017054ms ] org.springframework.http.HttpMethod:matches() <span class="comment">#1058</span></span><br><span class="line">        |       +---[0.00% 0.003344ms ] org.springframework.http.HttpMethod:matches() <span class="comment">#1059</span></span><br><span class="line">        |       +---[0.63% 4.578389ms ] org.springframework.web.servlet.HandlerExecutionChain:applyPreHandle() <span class="comment">#1066</span></span><br><span class="line">        |       +---[0.00% 0.005151ms ] org.springframework.web.servlet.HandlerExecutionChain:getHandler() <span class="comment">#1071</span></span><br><span class="line">        |       +---[94.22% 681.164697ms ] org.springframework.web.servlet.HandlerAdapter:handle() <span class="comment">#1071</span></span><br><span class="line">        |       +---[0.00% 0.022867ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1073</span></span><br><span class="line">        |       +---[0.01% 0.046345ms ] org.springframework.web.servlet.DispatcherServlet:applyDefaultViewName() <span class="comment">#1077</span></span><br><span class="line">        |       |   `---[19.75% 0.009155ms ] org.springframework.web.servlet.DispatcherServlet:applyDefaultViewName()</span><br><span class="line">        |       +---[0.00% 0.023564ms ] org.springframework.web.servlet.HandlerExecutionChain:applyPostHandle() <span class="comment">#1078</span></span><br><span class="line">        |       +---[0.02% 0.122935ms ] org.springframework.web.servlet.DispatcherServlet:processDispatchResult() <span class="comment">#1088</span></span><br><span class="line">        |       |   `---[76.98% 0.09464ms ] org.springframework.web.servlet.DispatcherServlet:processDispatchResult()</span><br><span class="line">        |       |       +---[24.65% 0.023328ms ] org.apache.commons.logging.Log:isTraceEnabled() <span class="comment">#1155</span></span><br><span class="line">        |       |       +---[16.65% 0.015762ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#1160</span></span><br><span class="line">        |       |       +---[6.36% 0.006018ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1160</span></span><br><span class="line">        |       |       `---[14.57% 0.013792ms ] org.springframework.web.servlet.HandlerExecutionChain:triggerAfterCompletion() <span class="comment">#1167</span></span><br><span class="line">        |       +---[0.00% 0.004283ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1098</span></span><br><span class="line">        |       `---[0.23% 1.628707ms ] org.springframework.web.servlet.DispatcherServlet:cleanupMultipart() <span class="comment">#1107</span></span><br><span class="line">        |           `---[98.68% 1.607223ms ] org.springframework.web.servlet.DispatcherServlet:cleanupMultipart()</span><br><span class="line">        |               +---[0.50% 0.008005ms ] org.springframework.web.util.WebUtils:getNativeRequest() <span class="comment">#1248</span></span><br><span class="line">        |               `---[97.93% 1.574022ms ] org.springframework.web.multipart.MultipartResolver:cleanupMultipart() <span class="comment">#1250</span></span><br><span class="line">        +---[0.00% 0.009553ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#967</span></span><br><span class="line">        +---[0.00% 0.006599ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#967</span></span><br><span class="line">        `---[0.01% 0.10787ms ] org.springframework.web.util.ServletRequestPathUtils:setParsedRequestPath() <span class="comment">#974</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†æç‰¹å®šæ–¹æ³•çš„è€—æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ˜ç¡®æŒ‡å®šä¸€ä¸‹ç±»çš„å…¨é™å®šåä»¥åŠæ–¹æ³•åå³å¯ï¼Œä¾‹å¦‚ <code>trace com.aimc.paperreduction.web.controller.CommonController uploadPaper</code>ï¼Œè¿™é‡Œæ˜¯åˆ†æCommonControlleråŒ…ä¸‹çš„<code>uploadPaper</code>æ–¹æ³•ï¼Œæ­£å¥½ä¹‹å‰åŠ äº†é˜¿é‡Œäº‘çš„æ–‡æœ¬æ£€æµ‹ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å¯¹æ€§èƒ½çš„å½±å“</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[arthas@7]$ trace com.aimc.paperreduction.web.controller.CommonController uploadPaper</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 2 , method count: 2) cost <span class="keyword">in</span> 292 ms, listenerId: 20</span><br><span class="line">`---ts=2023-09-07 11:45:12;thread_name=http-nio-80-exec-5;<span class="built_in">id</span>=33;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[931.752981ms] com.aimc.paperreduction.web.controller.CommonController$$EnhancerBySpringCGLIB$<span class="variable">$864d4ba2</span>:uploadPaper()</span><br><span class="line">        `---[99.94% 931.15232ms ] org.springframework.cglib.proxy.MethodInterceptor:intercept()</span><br><span class="line">            `---[97.68% 909.537879ms ] com.aimc.paperreduction.web.controller.CommonController:uploadPaper()</span><br><span class="line">                +---[0.02% 0.160456ms ] org.slf4j.Logger:info() <span class="comment">#221</span></span><br><span class="line">                +---[0.00% 0.043686ms ] org.springframework.web.multipart.MultipartFile:isEmpty() <span class="comment">#224</span></span><br><span class="line">                +---[99.91% 908.687093ms ] com.aimc.paperreduction.service.OrderService:uploadPaper() <span class="comment">#227</span></span><br><span class="line">                +---[0.00% 0.021838ms ] com.aimc.paperreduction.common.wrapper.Wrapper:getCode() <span class="comment">#228</span></span><br><span class="line">                +---[0.04% 0.325031ms ] org.slf4j.Logger:info() <span class="comment">#232</span></span><br><span class="line">                +---[0.00% 0.017715ms ] com.aimc.paperreduction.common.wrapper.Wrapper:getResult() <span class="comment">#233</span></span><br><span class="line">                `---[0.00% 0.028309ms ] com.aimc.paperreduction.web.controller.CommonController:success() <span class="comment">#233</span></span><br><span class="line"></span><br><span class="line">[arthas@7]$ trace  com.aimc.paperreduction.service.OrderService uploadPaper</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 4 , method count: 3) cost <span class="keyword">in</span> 659 ms, listenerId: 21</span><br><span class="line">`---ts=2023-09-07 11:46:32;thread_name=http-nio-80-exec-9;<span class="built_in">id</span>=37;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[871.142915ms] com.aimc.paperreduction.service.impl.OrderServiceImpl$$EnhancerBySpringCGLIB$<span class="variable">$a91e94c</span>:uploadPaper()</span><br><span class="line">        `---[99.98% 871.000878ms ] org.springframework.cglib.proxy.MethodInterceptor:intercept()</span><br><span class="line">            `---[99.99% 870.908438ms ] com.aimc.paperreduction.service.impl.OrderServiceImpl:uploadPaper()</span><br><span class="line">                +---[0.01% 0.049453ms ] com.aimc.paperreduction.common.wrapper.Wrapper:&lt;init&gt;() <span class="comment">#1243</span></span><br><span class="line">                +---[0.00% 0.010567ms ] org.springframework.web.multipart.MultipartFile:getOriginalFilename() <span class="comment">#1246</span></span><br><span class="line">                +---[0.01% 0.064652ms ] com.aimc.paperreduction.utils.StringUtil:extractPathExt() <span class="comment">#1246</span></span><br><span class="line">                +---[0.01% 0.099063ms ] com.aimc.paperreduction.utils.PathUtil:getRealDiskPath() <span class="comment">#1263</span></span><br><span class="line">                +---[0.81% 7.026517ms ] com.aimc.paperreduction.service.impl.OrderServiceImpl:transferToDisk() <span class="comment">#1264</span></span><br><span class="line">                +---[6.17% 53.694128ms ] com.aspose.words.Document:&lt;init&gt;() <span class="comment">#1272</span></span><br><span class="line">                +---[41.01% 357.150979ms ] com.aspose.words.Document:save() <span class="comment">#1274</span></span><br><span class="line">                +---[0.22% 1.918176ms ] com.aspose.words.Document:cleanup() <span class="comment">#1277</span></span><br><span class="line">                +---[0.00% 0.010126ms ] com.aimc.paperreduction.model.entity.PaperInfo:&lt;init&gt;() <span class="comment">#1284</span></span><br><span class="line">                +---[14.27% 124.293242ms ] com.aimc.paperreduction.utils.CommonUtil:countWords() <span class="comment">#1286</span></span><br><span class="line">                +---[34.64% 301.714162ms ] com.aimc.paperreduction.utils.CommonUtil:isGreenDoc() <span class="comment">#1287</span></span><br><span class="line">                +---[0.01% 0.05563ms ] org.apache.commons.lang3.StringUtils:isNotBlank() <span class="comment">#1288</span></span><br></pre></td></tr></table></figure><ul><li>ä»ä¸Šé¢çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œé˜¿é‡Œçš„æ–‡æœ¬æ£€æµ‹å äº†ä¸‰åˆ†ä¹‹ä¸€çš„æ—¶é•¿ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä½¿ç”¨traceå‘½ä»¤æ¥çœ‹ä¸ºä»€ä¹ˆè€—æ—¶è¿™ä¹ˆä¹…</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 233 ms, listenerId: 22</span><br><span class="line">`---ts=2023-09-07 11:49:51;thread_name=http-nio-80-exec-10;<span class="built_in">id</span>=38;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[294.261119ms] com.aimc.paperreduction.utils.CommonUtil:isGreenDoc()</span><br><span class="line">        +---[25.88% 76.155345ms ] org.apache.poi.xwpf.usermodel.XWPFDocument:&lt;init&gt;() <span class="comment">#1700</span></span><br><span class="line">        +---[0.00% 0.006894ms ] org.apache.poi.xwpf.usermodel.XWPFDocument:getParagraphs() <span class="comment">#1701</span></span><br><span class="line">        +---[0.44% min=0.001325ms,max=0.124972ms,total=1.306473ms,count=39] org.apache.poi.xwpf.usermodel.XWPFParagraph:getText() <span class="comment">#1702</span></span><br><span class="line">        +---[73.52% 216.339053ms ] com.aimc.paperreduction.utils.TextReview:textReview() <span class="comment">#1709</span></span><br><span class="line">        +---[0.00% 0.012255ms ] com.aimc.paperreduction.utils.TextReview:textReview() <span class="comment">#1715</span></span><br><span class="line">        `---[0.02% 0.048882ms ] org.apache.poi.xwpf.usermodel.XWPFDocument:close() <span class="comment">#1717</span></span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ°ä¸»è¦æ˜¯TextReviewè€—æ—¶è¾ƒé•¿ï¼ŒåŒæ—¶XWPFDocumentå¯¹è±¡çš„åˆ›å»ºä¹Ÿå¾ˆåƒæ€§èƒ½ï¼Œä»£ç ä¸­è¦é¿å…é¢‘ç¹åˆ›å»ºé”€æ¯æ­¤å¯¹è±¡ï¼Œç»§ç»­çœ‹TextReview</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[arthas@7]$ trace com.aimc.paperreduction.utils.TextReview textReview</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 202 ms, listenerId: 23</span><br><span class="line">`---ts=2023-09-07 11:53:18;thread_name=http-nio-80-exec-1;<span class="built_in">id</span>=2f;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[209.523489ms] com.aimc.paperreduction.utils.TextReview:textReview()</span><br><span class="line">        +---[0.03% 0.0623ms ] org.apache.commons.lang3.StringUtils:isBlank() <span class="comment">#17</span></span><br><span class="line">        +---[0.01% 0.01229ms ] com.aliyun.teaopenapi.models.Config:&lt;init&gt;() <span class="comment">#21</span></span><br><span class="line">        +---[0.01% 0.011889ms ] com.aliyun.teaopenapi.models.Config:setAccessKeyId() <span class="comment">#22</span></span><br><span class="line">        +---[0.00% 0.007757ms ] com.aliyun.teaopenapi.models.Config:setAccessKeySecret() <span class="comment">#23</span></span><br><span class="line">        +---[0.00% 0.007802ms ] com.aliyun.teaopenapi.models.Config:setEndpoint() <span class="comment">#25</span></span><br><span class="line">        +---[0.00% 0.006391ms ] com.aliyun.teaopenapi.models.Config:setConnectTimeout() <span class="comment">#26</span></span><br><span class="line">        +---[0.00% 0.006966ms ] com.aliyun.teaopenapi.models.Config:setReadTimeout() <span class="comment">#27</span></span><br><span class="line">        +---[0.07% 0.154858ms ] com.aliyun.green20220302.Client:&lt;init&gt;() <span class="comment">#28</span></span><br><span class="line">        +---[0.01% 0.011248ms ] com.alibaba.fastjson.JSONObject:&lt;init&gt;() <span class="comment">#30</span></span><br><span class="line">        +---[0.01% 0.012672ms ] com.alibaba.fastjson.JSONObject:put() <span class="comment">#31</span></span><br><span class="line">        +---[0.01% 0.01861ms ] com.aliyun.green20220302.models.TextModerationRequest:&lt;init&gt;() <span class="comment">#33</span></span><br><span class="line">        +---[0.01% 0.012414ms ] com.aliyun.green20220302.models.TextModerationRequest:setService() <span class="comment">#34</span></span><br><span class="line">        +---[0.08% 0.160351ms ] com.alibaba.fastjson.JSONObject:toJSONString() <span class="comment">#35</span></span><br><span class="line">        +---[0.00% 0.009442ms ] com.aliyun.green20220302.models.TextModerationRequest:setServiceParameters() <span class="comment">#35</span></span><br><span class="line">        +---[99.33% 208.114925ms ] com.aliyun.green20220302.Client:textModeration() <span class="comment">#36</span></span><br><span class="line">        +---[0.01% 0.028103ms ] com.aliyun.green20220302.models.TextModerationResponse:getBody() <span class="comment">#37</span></span><br><span class="line">        +---[0.01% 0.013397ms ] com.aliyun.green20220302.models.TextModerationResponseBody:getCode() <span class="comment">#38</span></span><br><span class="line">        +---[0.01% 0.018539ms ] com.aliyun.green20220302.models.TextModerationResponseBody:getData() <span class="comment">#40</span></span><br><span class="line">        `---[0.02% 0.031569ms ] com.aliyun.green20220302.models.TextModerationResponseBody<span class="variable">$TextModerationResponseBodyData</span>:getLabels() <span class="comment">#41</span></span><br></pre></td></tr></table></figure><ul><li>å®šä½åˆ°ä»£ç ä¸­</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TextModerationResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.textModeration(textModerationRequest);</span><br></pre></td></tr></table></figure><ul><li>è¿™æ˜¯ä¸€ä¸ªåŒæ­¥è°ƒç”¨ï¼Œä¼šç­‰å¾…æœåŠ¡å™¨è¿”å›ç»“æœï¼Œç­‰å¾…æœŸé—´ä¼šé˜»å¡ï¼Œå¦‚æœæœåŠ¡ç«¯å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œè¿™ä¸ªä»£ç ä¼šå¯¼è‡´ç¨‹åºåœ¨è¿™é‡Œä¸€ç›´é˜»å¡ã€‚ä¼˜åŒ–æ–¹æ¡ˆå°±æ˜¯æŠŠè¿™é‡Œæ”¹æˆäº†å¼‚æ­¥å¤„ç†</li><li>å…¶å®è§£å†³å¾ˆç®€å•ï¼Œå…³é”®åœ¨äºæ€ä¹ˆå®šä½å¹¶æ‰¾åˆ°è§£å†³é—®é¢˜çš„æ–¹æ³•ï¼Œç‰¹æ„å†™äº†ç¯‡æ–‡ç« æ¥è®°å½•ä¸€ä¸‹</li></ul></li></ul>]]></content>
    
    
    <summary type="html">ä¹‹å‰é—²çš„æ—¶å€™ï¼Œè®©æˆ‘åˆ†æä¸€ä¸‹è€—æ—¶çš„é—®é¢˜ï¼Œç„¶åå°±æ‰¾åˆ°äº†Arthas</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SpringBoot" scheme="https://cyborg2077.github.io/tags/SpringBoot/"/>
    
    <category term="Arthas" scheme="https://cyborg2077.github.io/tags/Arthas/"/>
    
    <category term="æ€§èƒ½åˆ†æ" scheme="https://cyborg2077.github.io/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”</title>
    <link href="https://cyborg2077.github.io/2023/09/02/FairRWLock/"/>
    <id>https://cyborg2077.github.io/2023/09/02/FairRWLock/</id>
    <published>2023-09-02T10:10:01.000Z</published>
    <updated>2023-10-01T13:43:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="éœ€æ±‚">éœ€æ±‚</h2><ul><li>é¡¹ç›®é‡Œæœ‰ä¸ªåœºæ™¯ï¼Œè¯»çš„å¹¶å‘å¾ˆå¤§ï¼Œä½†ä»…ä»…æ¶‰åŠåˆ°å¾ˆå°‘çš„å†™æ“ä½œã€‚é‚£ä¹ˆæ­¤æ—¶é‡‡ç”¨è¯»å†™é”å°±æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†æ˜¯é»˜è®¤çš„è¯»å†™é”æ˜¯éå…¬å¹³é”ï¼Œå¦‚æœè¯»å¹¶å‘å¾ˆå¤§ï¼Œå†™è¯·æ±‚åˆ°è¾¾æ—¶å¯èƒ½æŠ¢ä¸åˆ°é”ï¼Œæ‰€ä»¥æ­¤æ—¶éœ€è¦ä½¿ç”¨å…¬å¹³è¯»å†™é”ï¼Œä¸ºäº†æå‡å¤ç”¨æ€§ï¼Œé‡‡å–æ³¨è§£çš„å½¢å¼è¿›è¡Œå°è£…ã€‚</li><li>å¦‚æœä¸€ä¸ªclassçš„objectéœ€è¦è¿™ä¸ªèƒ½åŠ›ï¼ŒåŠ å…¥æ³¨è§£<code>@ReadWriteResource</code></li><li>å…·ä½“çš„å‡½æ•°ï¼Œå¦‚æœåŠ <code>@ReadOnlyOperator</code>æ³¨è§£ï¼Œé‚£ä¹ˆè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªè¯»ä»»åŠ¡ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼›</li><li>å¦‚æœåŠ <code>@WriteOperator</code>ï¼Œé‚£ä¹ˆè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå†™ä»»åŠ¡ï¼Œå’Œè¯»ä»»åŠ¡ã€å†™ä»»åŠ¡äº’æ–¥æ‰§è¡Œï¼›</li></ul><div class="note info no-icon flat"><ul><li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œéœ€è¦æ§åˆ¶é”ç²’åº¦ä¸ºå¯¹è±¡çº§åˆ«çš„é”ã€‚</li></ul></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç å¦‚ä¸‹</span></span><br><span class="line"><span class="meta">@ReadWriteResource</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ManagedResource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ReadOnlyOperator</span></span><br><span class="line">    String <span class="title function_">getResource</span><span class="params">(<span class="type">int</span> key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ReadOnlyOperator</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getName</span><span class="params">(<span class="type">int</span> key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@WriteOperator</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateResource</span><span class="params">(<span class="type">int</span> key, String resource)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h2><ul><li><p>é‡‡ç”¨æ³¨è§£+åŠ¨æ€ä»£ç†çš„æ–¹å¼æ¥å®ç°ï¼Œæ€è·¯å°±æ˜¯æ ¹æ®<code>@ReadWriteResource</code>åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦éœ€è¦åŠ¨æ€ä»£ç†ï¼Œç„¶åæ‹¦æˆªå¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œå‰ååŠ é”é‡Šæ”¾ã€‚</p><ol><li>é¦–å…ˆåˆ›å»ºä¸‰ä¸ªæ³¨è§£</li></ol>  <div class="tabs" id="æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-1">ReadWriteResource</button></li><li class="tab"><button type="button" data-href="#æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-2">ReadOnlyOperator</button></li><li class="tab"><button type="button" data-href="#æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-3">WriteOperator</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ReadWriteResource &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ReadOnlyOperator &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> WriteOperator &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ol start="2"><li>ç„¶åç¼–å†™ä¸€ä¸ªä»£ç†å·¥å‚ç±»ï¼Œç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œé¦–å…ˆåˆ¤æ–­å¯¹è±¡çš„Classæ˜¯å¦æœ‰<code>@ReadWriteResource</code>æ³¨è§£ï¼Œä»¥æ­¤åˆ¤æ–­æ˜¯å¦è¦ä¸ºè¯¥å¯¹è±¡åˆ›å»ºä»£ç†å¯¹è±¡</li></ol>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadWriteResourceProxyFactory</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">createProxy</span><span class="params">(T target)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = target.getClass();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¯¥ç±»æ˜¯å¦æœ‰ReadWriteResourceæ³¨è§£</span></span><br><span class="line">        <span class="type">ReadWriteResource</span> <span class="variable">annotation</span> <span class="operator">=</span> clazz.getAnnotation(ReadWriteResource.class);</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰æ³¨è§£ï¼Œåˆ™åˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œå¹¶ä¸éœ€è¦å°†targetå¯¹è±¡ä¼ å…¥ï¼Œå› ä¸ºæ‹¦æˆªå™¨æ‹¦æˆªçš„æ˜¯ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯ç›®æ ‡å¯¹è±¡æœ¬èº«</span></span><br><span class="line">            <span class="type">ReadWriteResourceInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReadWriteResourceInterceptor</span>();</span><br><span class="line">            <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">            enhancer.setSuperclass(clazz);</span><br><span class="line">            enhancer.setCallback(interceptor);</span><br><span class="line">            <span class="keyword">return</span> (T) enhancer.create();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æ³¨è§£ï¼Œç›´æ¥è¿”å›åŸå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>æ„é€ å‡½æ•°å…ˆä¸ºå¯¹è±¡åˆå§‹åŒ–è¯»å†™é”ï¼Œæ‹¦æˆªé€»è¾‘ä¸­åˆ¤æ–­æ–¹æ³•ä¸Šæ˜¯å¦å­˜åœ¨<code>@ReadOnlyOperator</code>æˆ–<code>WriteOperator</code>æ³¨è§£ï¼Œæ¥ç¡®å®šæ˜¯è¯»æ“ä½œè¿˜æ˜¯å†™æ“ä½œï¼Œç„¶ååŠ ä¸Šå¯¹åº”çš„é”ã€‚</li></ol>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadWriteResourceInterceptor</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock readLock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock writeLock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReadWriteResourceInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ReentrantReadWriteLock</span> <span class="variable">readWriteLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">this</span>.readLock = readWriteLock.readLock();</span><br><span class="line">        <span class="built_in">this</span>.writeLock = readWriteLock.writeLock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ReadOnlyOperator</span> <span class="variable">readOnlyOperatorAnnotation</span> <span class="operator">=</span> method.getAnnotation(ReadOnlyOperator.class);</span><br><span class="line">        <span class="type">WriteOperator</span> <span class="variable">writeOperatorAnnotation</span> <span class="operator">=</span> method.getAnnotation(WriteOperator.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (readOnlyOperatorAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœåŒ…å«ReadOnlyOperatoræ³¨è§£ï¼ŒåŠ è¯»é”</span></span><br><span class="line">            readLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡ŒåŸæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾è¯»é”</span></span><br><span class="line">                readLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (writeOperatorAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœåŒ…å«WriteOperatoræ³¨è§£ï¼ŒåŠ å†™é”</span></span><br><span class="line">            writeLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡ŒåŸæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾å†™é”</span></span><br><span class="line">                writeLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ²¡åŠ æ³¨è§£çš„æ™®é€šæ–¹æ³•ï¼Œè¿”å›ç›´æ¥è°ƒç”¨åŸæ–¹æ³•</span></span><br><span class="line">            <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>åŸºæœ¬ä½¿ç”¨ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼Œæµ‹è¯•çš„æ—¶å€™å¯ä»¥åœ¨æ—¥å¿—ä¸­æ‰“å°å‡ºè¯»å†™é”åœ°å€</li></ol>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ReadWriteResourceProxyFactory&lt;ManagedResource&gt; proxyFactory = <span class="keyword">new</span> <span class="title class_">ReadWriteResourceProxyFactory</span>&lt;&gt;();</span><br><span class="line"><span class="type">ManagedResource</span> <span class="variable">proxy</span> <span class="operator">=</span> proxyFactory.createProxy(<span class="keyword">new</span> <span class="title class_">ManagedResource</span>());</span><br><span class="line">proxy.getName();</span><br><span class="line">proxy.updateResource();</span><br></pre></td></tr></table></figure><ul><li>å†™å®Œäº†æ‰“åŒ…ä¸Šä¼ è‡³mavenç§æœï¼Œä»¥åå°±æ˜¯å°è£…è‡ªå·±çš„å·¥å…·ç±»äº†</li></ul></li></ul><h2 id="AOPå®ç°">AOPå®ç°</h2><ul><li>ä¹‹å‰å…¶å®é‡‡ç”¨çš„æ˜¯æ³¨è§£+AOPæ¥å°è£…çš„ï¼Œç„¶åå†™ç€å†™ç€å°±å‘ç°äº†ç‚¹é—®é¢˜ï¼Œè¿™é‡Œä¹Ÿæ¥å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹å§ã€‚</li><li>é¦–å…ˆæ³¨è§£æ–¹é¢æ²¡æœ‰å˜åŒ–ï¼Œä¸è¿‡æˆ‘æ²¡ç”¨åˆ°<code>@ReadWriteResource</code>æ³¨è§£ï¼Œå› ä¸ºæ‰¾åˆ‡ç‚¹çš„æ—¶å€™å¯ä»¥ç›´æ¥æ ¹æ®æ–¹æ³•ä¸Šæ˜¯å¦æœ‰<code>@ReadOnlyOperator</code>å’Œ<code>@WriteOperator</code>æ¥åˆ¤æ–­ã€‚</li><li>AOPçš„é€»è¾‘å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜å¤©æ›´</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å·¥ä½œéœ€è¦é€ äº†ä¸ªå°è½®å­</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="Java" scheme="https://cyborg2077.github.io/tags/Java/"/>
    
  </entry>
  
</feed>
