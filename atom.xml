<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Kyle&#39;s Blog</title>
  
  
  <link href="https://cyborg2077.github.io/atom.xml" rel="self"/>
  
  <link href="https://cyborg2077.github.io/"/>
  <updated>2025-02-23T15:52:40.188Z</updated>
  <id>https://cyborg2077.github.io/</id>
  
  <author>
    <name>Kyle Violet</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>零成本自建碎碎念API</title>
    <link href="https://cyborg2077.github.io/2025/02/22/DIYMoments/"/>
    <id>https://cyborg2077.github.io/2025/02/22/DIYMoments/</id>
    <published>2025-02-22T03:58:54.000Z</published>
    <updated>2025-02-23T15:52:40.188Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li><p>未完待续，周末遇到了点紧急状况，所以先放着，后面再补上</p></li><li><p>一套碎碎念的API其实就是简单的CRUD，但是部署总是要成本的，本篇文章将提供一个轻量级的零成本方案，具体方案如下</p><ol><li>白嫖MongoDB作为数据库</li><li>部署Vercel API，提供CRUD接口</li><li>由于Vercel被墙了，但Cloudflare Workers是可以在大陆访问的，所以可以部署Cloudflare Worker作为代理（为什么不直接用Cloudflare提供API呢？</li></ol></li><li><p>最终效果请见</p><div class="tag link"><a class="link-card" title="闲言碎语" href="https://cyborg2077.github.io/moments"><div class="left"><img src="https://pic.imgdb.cn/item/6335135c16f2c2beb100182d.jpg"/></div><div class="right"><p class="text">闲言碎语</p><p class="url">https://cyborg2077.github.io/moments</p></div></a></div></li></ul><h1 id="白嫖MongoDB"><a href="#白嫖MongoDB" class="headerlink" title="白嫖MongoDB"></a>白嫖MongoDB</h1><ul><li>注册MongoDB账号：<a href="https://www.mongodb.com/zh-cn/cloud/atlas/register">https://www.mongodb.com/zh-cn/cloud/atlas/register</a><br><img src="https://s21.ax1x.com/2025/02/22/pElndt1.png" alt=""></li><li>创建集群<br><img src="https://s21.ax1x.com/2025/02/22/pElQYgx.png" alt=""></li><li>复制连接信息<br><img src="https://s21.ax1x.com/2025/02/22/pElQtv6.png" alt=""></li><li>我们可以先通过navicat连接MongoDB，便于我们后期管理博客内容<br><img src="https://s21.ax1x.com/2025/02/22/pElQUKK.png" alt=""></li></ul><h1 id="部署Vercel-API"><a href="#部署Vercel-API" class="headerlink" title="部署Vercel API"></a>部署Vercel API</h1><ol><li>注册Vercel：<a href="https://vercel.com/login">https://vercel.com/login</a></li><li>安装Vercel CLI并登录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g vercel</span><br><span class="line">vercel login</span><br></pre></td></tr></table></figure></li></ol><ul><li>选择自己的登录方式<br><img src="https://s21.ax1x.com/2025/02/22/pElQD5d.png" alt=""></li><li>如果选择了邮箱登录，在发验证码的时候有可能会失败，这里建议配置代理<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP_PROXY=http://127.0.0.1:7890</span><br><span class="line">HTTPS_PROXY=http://127.0.0.1:7890</span><br><span class="line">vercel login</span><br></pre></td></tr></table></figure></li><li>登录成功如下<br><img src="https://s21.ax1x.com/2025/02/22/pElQy8I.png" alt=""></li></ul><ol><li>创建项目文件夹并进入，安装依赖<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express mongoose cors</span><br></pre></td></tr></table></figure></li><li>创建api/index.js<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MongoDB 连接 URL</span></span><br><span class="line"><span class="keyword">const</span> uri = <span class="string">&quot;mongodb+srv://&lt;username&gt;:&lt;password&gt;.@&lt;endpoint&gt;/?retryWrites=true&amp;w=majority&amp;appName=Azure-Cluster-HongKong&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 MongoDB 客户端</span></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">MongoClient</span>(uri);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接数据库</span></span><br><span class="line"><span class="keyword">let</span> db;</span><br><span class="line"><span class="keyword">let</span> isConnected = <span class="literal">false</span>; <span class="comment">// 添加连接状态标志</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加根路由处理</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&quot;API 服务器正在运行&quot;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">connectToDatabase</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> client.<span class="title function_">connect</span>();</span><br><span class="line">    db = client.<span class="title function_">db</span>(<span class="string">&quot;kyle_blog_secret&quot;</span>);</span><br><span class="line">    isConnected = <span class="literal">true</span>; <span class="comment">// 设置连接状态</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;成功连接到 MongoDB&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;MongoDB 连接失败:&quot;</span>, error);</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加中间件来检查数据库连接</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isConnected) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">connectToDatabase</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&quot;数据库连接失败&quot;</span>, <span class="attr">error</span>: error.<span class="property">message</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改查询接口</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/query&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!db) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;数据库连接未就绪&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; item &#125; = req.<span class="property">query</span>;</span><br><span class="line">    <span class="keyword">const</span> filter = item ? &#123; item &#125; : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> db.<span class="title function_">collection</span>(<span class="string">&quot;kyle&quot;</span>).<span class="title function_">find</span>(filter).<span class="title function_">toArray</span>();</span><br><span class="line">    res.<span class="title function_">json</span>(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;查询失败:&quot;</span>, error);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&quot;查询失败&quot;</span>, <span class="attr">error</span>: error.<span class="property">message</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 心跳接口</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/health&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">status</span>: <span class="string">&quot;ok&quot;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误处理中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err.<span class="property">stack</span>);</span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&quot;服务器内部错误&quot;</span>, <span class="attr">error</span>: err.<span class="property">message</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动服务器</span></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`服务器运行在端口 <span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app; </span><br></pre></td></tr></table></figure></li><li>根目录创建vercel.json<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;builds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;src&quot;</span><span class="punctuation">:</span> <span class="string">&quot;api/index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;use&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@vercel/node&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;routes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;src&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/.*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;dest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;api/index.js&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li></ol><ul><li>最终的目录结构是这样的<br><img src="https://s21.ax1x.com/2025/02/22/pElQ4aQ.png" alt=""></li></ul><h1 id="部署Cloudflare-Worker作为代理"><a href="#部署Cloudflare-Worker作为代理" class="headerlink" title="部署Cloudflare Worker作为代理"></a>部署Cloudflare Worker作为代理</h1><h1 id="修改DNS"><a href="#修改DNS" class="headerlink" title="修改DNS"></a>修改DNS</h1>]]></content>
    
    
    <summary type="html">Vercel + Cloudflare Workers + MongoDB Atlas 零成本方案</summary>
    
    
    
    
    <category term=".NET" scheme="https://cyborg2077.github.io/tags/NET/"/>
    
  </entry>
  
  <entry>
    <title>Windows剪切板剖析</title>
    <link href="https://cyborg2077.github.io/2025/02/16/WindowsClipboard/"/>
    <id>https://cyborg2077.github.io/2025/02/16/WindowsClipboard/</id>
    <published>2025-02-16T04:37:25.000Z</published>
    <updated>2025-02-16T05:11:39.434Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><h2 id="问题发现"><a href="#问题发现" class="headerlink" title="问题发现"></a>问题发现</h2><h3 id="场景描述："><a href="#场景描述：" class="headerlink" title="场景描述："></a>场景描述：</h3><ul><li>我在复制消息准备粘贴到知乎进行搜索时，手误复制了多余的内容。<br><img src="https://s21.ax1x.com/2025/02/16/pEKfSQP.png" alt=""></li><li>粘贴到知乎时，内容变成了如下格式：<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">　ㅤ: 02-15 19:09:01</span><br><span class="line">我才没看</span><br><span class="line"></span><br><span class="line">ln: 02-15 19:09:26</span><br><span class="line">你在知乎每天搜一遍怎么哄女朋友开心</span><br></pre></td></tr></table></figure></li><li><p>进一步观察：将同样的内容粘贴到QQ聊天输入框时，内容却变成了转发消息的格式：<br><img src="https://s21.ax1x.com/2025/02/16/pEKfAij.png" alt=""></p></li><li><p>剪切板历史：按下 <code>Win + V</code> 打开Windows的剪切板历史，看到的内容与粘贴到知乎时一致：<br><img src="https://s21.ax1x.com/2025/02/16/pEKfQwF.png" alt=""></p></li></ul><h3 id="问题思考"><a href="#问题思考" class="headerlink" title="问题思考"></a>问题思考</h3><ul><li>剪切板中可能存在一些隐藏的数据格式，导致粘贴到不同应用程序时呈现不同的效果。联想到一些博客网站在复制内容时，会自动添加禁止转载的文案，或者在Word中粘贴时带有奇怪的格式和背景，这些现象进一步坚定了我的猜想。</li></ul><h2 id="技术探索"><a href="#技术探索" class="headerlink" title="技术探索"></a>技术探索</h2><h3 id="获取剪切板数据"><a href="#获取剪切板数据" class="headerlink" title="获取剪切板数据"></a>获取剪切板数据</h3><ul><li><p>为了验证猜想，我编写了一个Python脚本，使用 <code>win32clipboard</code> 模块来获取剪切板中的所有数据格式及其内容。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> win32clipboard</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_clipboard_data</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取剪贴板中所有格式的数据&quot;&quot;&quot;</span></span><br><span class="line">    win32clipboard.OpenClipboard()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        format_id = <span class="number">0</span></span><br><span class="line">        formats = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 枚举所有剪贴板格式</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n=== 剪贴板格式列表 ===&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            format_id = win32clipboard.EnumClipboardFormats(format_id)</span><br><span class="line">            <span class="keyword">if</span> format_id == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                format_name = win32clipboard.GetClipboardFormatName(format_id)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                format_name = <span class="string">f&quot;系统格式 <span class="subst">&#123;format_id&#125;</span>&quot;</span></span><br><span class="line">            formats.append((format_id, format_name))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;格式 ID: <span class="subst">&#123;format_id&#125;</span>, 名称: <span class="subst">&#123;format_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n=== 剪贴板数据内容 ===&quot;</span>)</span><br><span class="line">        <span class="comment"># 读取每种格式的数据</span></span><br><span class="line">        <span class="keyword">for</span> fmt, name <span class="keyword">in</span> formats:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = win32clipboard.GetClipboardData(fmt)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\n格式 ID: <span class="subst">&#123;fmt&#125;</span> (<span class="subst">&#123;name&#125;</span>)&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 处理文本数据</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>):</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        decoded_data = data.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;内容 (UTF-8 解码):\n<span class="subst">&#123;decoded_data&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;数据是字节流，无法用 UTF-8 解码 (<span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> 字节)&quot;</span>)</span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;内容 (字符串):\n<span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;未知数据类型: <span class="subst">&#123;<span class="built_in">type</span>(data)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;格式 ID <span class="subst">&#123;fmt&#125;</span> (<span class="subst">&#123;name&#125;</span>) 读取失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        win32clipboard.CloseClipboard()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_all_clipboard_data()</span><br></pre></td></tr></table></figure></li><li><p>输出结果</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">=== 剪贴板格式列表 ===</span><br><span class="line">格式 ID: 49914, 名称: QQ_MultiMsg_RichEdit_Format</span><br><span class="line">格式 ID: 13, 名称: 系统格式 13</span><br><span class="line">格式 ID: 49393, 名称: HTML Format</span><br><span class="line">格式 ID: 16, 名称: 系统格式 16</span><br><span class="line">格式 ID: 1, 名称: 系统格式 1</span><br><span class="line">格式 ID: 7, 名称: 系统格式 7</span><br><span class="line"></span><br><span class="line">=== 剪贴板数据内容 ===</span><br><span class="line"></span><br><span class="line">格式 ID: 49914 (QQ_MultiMsg_RichEdit_Format)</span><br><span class="line">数据是字节流，无法用 UTF-8 解码 (163 字节)</span><br><span class="line"></span><br><span class="line">格式 ID: 13 (系统格式 13)</span><br><span class="line">内容 (字符串):</span><br><span class="line">　ㅤ: 02-15 19:09:01</span><br><span class="line">我才没看</span><br><span class="line"></span><br><span class="line">ln: 02-15 19:09:26</span><br><span class="line">你在知乎每天搜一遍怎么哄女朋友开心</span><br><span class="line"></span><br><span class="line">格式 ID: 49393 (HTML Format)</span><br><span class="line">内容 (UTF-8 解码):</span><br><span class="line">Version:0.9</span><br><span class="line">StartHTML:0000000117</span><br><span class="line">EndHTML:0000000296</span><br><span class="line">StartFragment:0000000153</span><br><span class="line">EndFragment:0000000260</span><br><span class="line">SourceURL:</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;!--StartFragment--&gt;　ㅤ: 02-15 19:09:01</span><br><span class="line">我才没看</span><br><span class="line"></span><br><span class="line">ln: 02-15 19:09:26</span><br><span class="line">你在知乎每天搜一遍怎么哄女朋友开心&lt;!--EndFragment--&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt; </span><br><span class="line"></span><br><span class="line">格式 ID: 16 (系统格式 16)</span><br><span class="line">内容 (UTF-8 解码):</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">格式 ID: 1 (系统格式 1)</span><br><span class="line">数据是字节流，无法用 UTF-8 解码 (83 字节)</span><br><span class="line"></span><br><span class="line">格式 ID: 7 (系统格式 7)</span><br><span class="line">数据是字节流，无法用 UTF-8 解码 (83 字节)</span><br></pre></td></tr></table></figure></li><li>结果发现剪切板中存在一个名为 <code>QQ_MultiMsg_RichEdit_Format</code> 的格式，其内容为字节流，无法直接解码。这很可能是导致粘贴到QQ时渲染成消息卡片的原因。只解析出了部分内容，除非知道这个Format的定义，否则无法解析全部内容<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">��Å���g</span><br><span class="line"></span><br><span class="line">��������gu_WS9xyQOjT3nF6n_5GB_gNQ&quot; *^　ㅤ: 02-15 19:09:01</span><br><span class="line">我才没看</span><br><span class="line"></span><br><span class="line">ln: 02-15 19:09:26</span><br><span class="line">你在知乎每天搜一遍怎么哄女朋友开心</span><br></pre></td></tr></table></figure></li></ul><h3 id="Hook验证"><a href="#Hook验证" class="headerlink" title="Hook验证"></a>Hook验证</h3><ul><li>为了进一步验证QQ在粘贴时是否使用了这个格式，我使用 frida 工具对QQ的 GetClipboardData 函数进行了Hook。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_process_pid</span>(<span class="params">target_name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; 获取目标进程的 PID &quot;&quot;&quot;</span></span><br><span class="line">    device = frida.get_local_device()</span><br><span class="line">    processes = device.enumerate_processes()</span><br><span class="line"></span><br><span class="line">    matched_pids = [p.pid <span class="keyword">for</span> p <span class="keyword">in</span> processes <span class="keyword">if</span> p.name.lower() == target_name.lower()]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> matched_pids:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;未找到 <span class="subst">&#123;target_name&#125;</span> 进程&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(matched_pids) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> matched_pids[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;发现多个 <span class="subst">&#123;target_name&#125;</span> 进程，请选择一个 PID:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> idx, pid <span class="keyword">in</span> <span class="built_in">enumerate</span>(matched_pids):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;idx&#125;</span>] PID: <span class="subst">&#123;pid&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    selection = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;请输入索引选择目标进程: &quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> matched_pids[selection]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_clipboard</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Hook GetClipboardData 监听粘贴格式 &quot;&quot;&quot;</span></span><br><span class="line">    process_name = <span class="string">&quot;QQ.exe&quot;</span>  <span class="comment"># 目标进程，如 QQ</span></span><br><span class="line">    target_pid = get_process_pid(process_name)</span><br><span class="line"></span><br><span class="line">    session = frida.attach(target_pid)</span><br><span class="line"></span><br><span class="line">    script_code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    var user32 = Module.findExportByName(&quot;user32.dll&quot;, &quot;GetClipboardData&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Interceptor.attach(user32, &#123;</span></span><br><span class="line"><span class="string">        onEnter: function (args) &#123;</span></span><br><span class="line"><span class="string">            var format_id = args[0].toInt32();  // 获取 format_id</span></span><br><span class="line"><span class="string">            send(format_id);  // 发送给 Python 端</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">        <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;send&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[Hooked] 粘贴时获取的格式 ID:&quot;</span>, message[<span class="string">&quot;payload&quot;</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[Error]&quot;</span>, message)</span><br><span class="line"></span><br><span class="line">    script = session.create_script(script_code)</span><br><span class="line">    script.on(<span class="string">&quot;message&quot;</span>, on_message)</span><br><span class="line">    script.load()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;成功 Hook 进程 <span class="subst">&#123;process_name&#125;</span> (PID: <span class="subst">&#123;target_pid&#125;</span>), 等待粘贴操作...&quot;</span>)</span><br><span class="line">    <span class="built_in">input</span>(<span class="string">&quot;按回车退出监听...\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    hook_clipboard()</span><br></pre></td></tr></table></figure></li><li>Hook结果<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Hooked] 粘贴时获取的格式 ID: 13</span><br><span class="line">[Hooked] 粘贴时获取的格式 ID: 49815</span><br><span class="line">[Hooked] 粘贴时获取的格式 ID: 49393</span><br><span class="line">[Hooked] 粘贴时获取的格式 ID: 49815</span><br><span class="line">[Hooked] 粘贴时获取的格式 ID: 49914</span><br></pre></td></tr></table></figure></li><li>QQ在粘贴时确实使用了 <code>QQ_MultiMsg_RichEdit_Format</code> 格式，这验证了之前的猜想。</li></ul><h2 id="进一步探索"><a href="#进一步探索" class="headerlink" title="进一步探索"></a>进一步探索</h2><ul><li>为了更深入地了解剪切板的变化，我编写了一个简单的轮询脚本，用于监听剪切板格式的变化。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> win32clipboard</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_clipboard_formats</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取当前剪贴板中的所有格式&quot;&quot;&quot;</span></span><br><span class="line">    win32clipboard.OpenClipboard()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        format_id = <span class="number">0</span></span><br><span class="line">        formats = []</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            format_id = win32clipboard.EnumClipboardFormats(format_id)</span><br><span class="line">            <span class="keyword">if</span> format_id == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                format_name = win32clipboard.GetClipboardFormatName(format_id)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                format_name = <span class="string">f&quot;系统格式 <span class="subst">&#123;format_id&#125;</span>&quot;</span></span><br><span class="line">            formats.append((format_id, format_name))</span><br><span class="line">        <span class="keyword">return</span> formats</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        win32clipboard.CloseClipboard()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 轮询检测剪贴板的变化</span></span><br><span class="line">prev_formats = []</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    formats = get_clipboard_formats()</span><br><span class="line">    <span class="keyword">if</span> formats != prev_formats:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n剪贴板格式发生变化:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> fmt, name <span class="keyword">in</span> formats:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;格式 ID: <span class="subst">&#123;fmt&#125;</span>, 名称: <span class="subst">&#123;name&#125;</span>&quot;</span>)</span><br><span class="line">        prev_formats = formats</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li><li>该脚本可以实时监控剪切板格式的变化，帮助开发者更好地理解不同应用程序如何操作剪切板。<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">剪贴板格式发生变化:</span><br><span class="line">格式 ID: 49393, 名称: HTML Format</span><br><span class="line">格式 ID: 49292, 名称: Rich Text Format</span><br><span class="line">格式 ID: 13, 名称: 系统格式 13</span><br><span class="line">格式 ID: 1, 名称: 系统格式 1</span><br><span class="line">格式 ID: 49398, 名称: UniformResourceLocator</span><br><span class="line">格式 ID: 49918, 名称: JAVA_DATAFLAVOR:application/x-java-jvm-local-objectref; class=com.intellij.codeInsight.editorActions.FoldingData</span><br><span class="line">格式 ID: 49971, 名称: JAVA_DATAFLAVOR:application/x-java-jvm-local-objectref; class=com.intellij.codeInsight.editorActions.ReferenceData</span><br><span class="line">格式 ID: 49915, 名称: JAVA_DATAFLAVOR:application/x-java-serialized-object; class=com.intellij.openapi.editor.impl.EditorCopyPasteHelperImpl$CopyPasteOptionsTransferableData</span><br><span class="line">格式 ID: 16, 名称: 系统格式 16</span><br><span class="line">格式 ID: 7, 名称: 系统格式 7</span><br><span class="line"></span><br><span class="line">剪贴板格式发生变化:</span><br><span class="line">格式 ID: 49914, 名称: QQ_MultiMsg_RichEdit_Format</span><br><span class="line">格式 ID: 13, 名称: 系统格式 13</span><br><span class="line">格式 ID: 49393, 名称: HTML Format</span><br><span class="line">格式 ID: 16, 名称: 系统格式 16</span><br><span class="line">格式 ID: 1, 名称: 系统格式 1</span><br><span class="line">格式 ID: 7, 名称: 系统格式 7</span><br><span class="line"></span><br><span class="line">剪贴板格式发生变化:</span><br><span class="line">格式 ID: 49393, 名称: HTML Format</span><br><span class="line">格式 ID: 13, 名称: 系统格式 13</span><br><span class="line">格式 ID: 49815, 名称: Chromium internal source URL</span><br><span class="line">格式 ID: 16, 名称: 系统格式 16</span><br><span class="line">格式 ID: 1, 名称: 系统格式 1</span><br><span class="line">格式 ID: 7, 名称: 系统格式 7</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;h2 id=&quot;问题发现&quot;&gt;&lt;a href=&quot;#问题发现&quot; class=&quot;headerlink&quot; title=&quot;问题发现&quot;&gt;&lt;/a&gt;问题发现&lt;/h</summary>
      
    
    
    
    
    <category term="Python" scheme="https://cyborg2077.github.io/tags/Python/"/>
    
    <category term="Hook" scheme="https://cyborg2077.github.io/tags/Hook/"/>
    
  </entry>
  
  <entry>
    <title>并查集</title>
    <link href="https://cyborg2077.github.io/2025/01/15/UnionFind/"/>
    <id>https://cyborg2077.github.io/2025/01/15/UnionFind/</id>
    <published>2025-01-15T02:31:49.000Z</published>
    <updated>2025-02-16T05:24:04.904Z</updated>
    
    <content type="html"><![CDATA[<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><ul><li>在AB测试中，确保用户的一致性和唯一性是获得准确结果的关键。然而，在非强制登录的Web项目中，用户的唯一标识可能会因退出、登录、切换浏览器等行为而发生变化。这可能导致同一个用户被误认为是多个不同的用户，进而影响实验结果的准确性。本文将探讨如何解决这一问题，以提高AB测试的有效性。</li></ul><h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><ul><li>在Web应用中，如果简单地使用后端生成的用户token作为唯一用户标识，可能会遇到以下问题：用户在登录前后或退出登录时，会获取新的token。如果以token作为实验分流的唯一属性，可能会导致实验结果不准确。</li></ul><h2 id="具体原因"><a href="#具体原因" class="headerlink" title="具体原因"></a>具体原因</h2><ol><li>用户token变化：用户在登录前后或退出登录时，token会发生变化。如果仅依赖token作为唯一标识，同一个用户在不同状态下会被视为不同的用户。</li><li>前端尝试策略：前端生成一个唯一的客户端标识（client_id），并将其存储在cookie中。只要用户不清除浏览器缓存，无论登录状态如何变化，都能通过client_id唯一标识用户。但考虑到用户可能</li><li>后端订单创建：后端在创建订单时，使用token作为用户标识。前端的client_id与订单业务没有直接关联，导致token与client_id之间的关联缺失。</li></ol><ul><li>由于存在用户token会变化的问题，那么这里前端采取的策略是生成一个唯一的客户端标识，存到cookie里，只要用户不清除浏览器缓存，无论登录状态变化与否，都能唯一标识用户。</li><li><p>但是后端在创建订单的时候，是获取token作为用户标识的，前端的客户端标识与订单业务没有任何关联，那我们需要将用户的token关联起来。</p></li><li><p>实验记录表（experiment_record）结构如下</p></li></ul><div class="table-container"><table><thead><tr><th style="text-align:center">id</th><th style="text-align:center">主键</th></tr></thead><tbody><tr><td style="text-align:center">user_id</td><td style="text-align:center">用户的唯一标识</td></tr><tr><td style="text-align:center">client_id</td><td style="text-align:center">用户的客户端id，会随着不同浏览器变化</td></tr><tr><td style="text-align:center">feature_value</td><td style="text-align:center">触发实验的值</td></tr><tr><td style="text-align:center">…</td><td style="text-align:center">其余属性</td></tr></tbody></table></div><ul><li>订单表（order）结构如下</li></ul><div class="table-container"><table><thead><tr><th style="text-align:center">id</th><th style="text-align:center">主键</th></tr></thead><tbody><tr><td style="text-align:center">order_id</td><td style="text-align:center">订单id</td></tr><tr><td style="text-align:center">user_id</td><td style="text-align:center">用户的唯一标识</td></tr><tr><td style="text-align:center">amount</td><td style="text-align:center">金额</td></tr><tr><td style="text-align:center">…</td><td style="text-align:center">其余属性</td></tr></tbody></table></div><ul><li>实验触发流程如下<ol><li>首次进入网站，获取了一个未登录状态的token，触发了实验 -&gt; 向实验记录表中插入了一条记录<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> experiment_record (user_id, client_id, feature_value) <span class="keyword">VALUES</span> (<span class="number">5120</span>, <span class="number">9527</span>, &quot;cyan&quot;);</span><br></pre></td></tr></table></figure></li><li>用户登录，系统会为该用户分配一个新的token，但是客户端标识没有变，触发了实验 -&gt; 向实验记录表中插入了一条记录<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> experiment_record (user_id, client_id, feature_value) <span class="keyword">VALUES</span> (<span class="number">5210</span>, <span class="number">9527</span>, &quot;cyan&quot;);</span><br></pre></td></tr></table></figure></li></ol><ul><li>当然这里会存在feature_value不同的情况，对于相同用户看到了不同的实验变体的数据，我们在分析的时候需要排除掉。</li></ul><ol><li>同时这个人在登录状态下提交了一个订单，那么订单表中只会有1条记录<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">order</span> (order_id, user_id, amount) <span class="keyword">VALUES</span> (<span class="number">123456</span>, <span class="number">5210</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure></li><li>此时实验数据表中就会有2个token，但是其实是同一个人，计算转化率时，就会有误差。</li></ol></li></ul><h1 id="分析与解决方案"><a href="#分析与解决方案" class="headerlink" title="分析与解决方案"></a>分析与解决方案</h1><ul><li>为了最小化这种误差，这里考虑了一种轻量级的方法来关联同一用户的前后token。具体来说，我们引入了一张新的数据库表，用于记录用户的token变化情况。每当用户登录或登出时，我们会在这个表中添加一条记录，包含旧token、新token，以及变化的时间戳。</li><li>一个简单的表（token_changes）结构如下：</li></ul><div class="table-container"><table><thead><tr><th style="text-align:center">id</th><th style="text-align:center">主键</th></tr></thead><tbody><tr><td style="text-align:center">old_user_id</td><td style="text-align:center">表示未登录状态下的token</td></tr><tr><td style="text-align:center">new_user_id</td><td style="text-align:center">表示登录后的token</td></tr><tr><td style="text-align:center">change_time</td><td style="text-align:center">记录token变化的时间</td></tr></tbody></table></div><h1 id="数据处理逻辑"><a href="#数据处理逻辑" class="headerlink" title="数据处理逻辑"></a>数据处理逻辑</h1><ul><li>接下来，我们需要确保所有涉及用户行为的数据（如订单、实验参与等）都能正确地反映用户的身份一致性。</li><li>为此，我们需要先根据token_changes中的数据来建立并查集，划分出一个个集合。随后遍历实验数据表和订单表中的user_id，若在并查集中，则更新为根节点的值，保证所有相关联的token都指向同一个用户。</li></ul><h1 id="并查集"><a href="#并查集" class="headerlink" title="并查集"></a>并查集</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnionFindUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; parent = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); <span class="comment">// 记录每个token的父节点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; rank = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); <span class="comment">// 记录每个token的秩（树的高度）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find操作：找到某个token的根节点，并路径压缩</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">find</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="comment">// 如果token不在parent中，初始化自己为自己的父节点</span></span><br><span class="line">        parent.putIfAbsent(token, token);</span><br><span class="line">        rank.putIfAbsent(token, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 路径压缩</span></span><br><span class="line">        <span class="keyword">if</span> (!parent.get(token).equals(token)) &#123;</span><br><span class="line">            parent.put(token, find(parent.get(token))); <span class="comment">// 递归压缩路径</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> parent.get(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Union操作：合并两个token所在的集合</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">union</span><span class="params">(String token1, String token2)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">root1</span> <span class="operator">=</span> find(token1);</span><br><span class="line">        <span class="type">String</span> <span class="variable">root2</span> <span class="operator">=</span> find(token2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果两个根节点不同，合并集合</span></span><br><span class="line">        <span class="keyword">if</span> (!root1.equals(root2)) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">rank1</span> <span class="operator">=</span> rank.getOrDefault(root1, <span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">rank2</span> <span class="operator">=</span> rank.getOrDefault(root2, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 按秩合并</span></span><br><span class="line">            <span class="keyword">if</span> (rank1 &gt; rank2) &#123;</span><br><span class="line">                parent.put(root2, root1);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rank1 &lt; rank2) &#123;</span><br><span class="line">                parent.put(root1, root2);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parent.put(root2, root1);</span><br><span class="line">                rank.put(root1, rank1 + <span class="number">1</span>); <span class="comment">// 增加高度</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断两个token是否属于同一集合</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isConnected</span><span class="params">(String token1, String token2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> find(token1).equals(find(token2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;List&lt;String&gt;&gt; <span class="title function_">getGroupResult</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Map用于存储每个根节点对应的集合</span></span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; groups = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历所有的元素，将它们归类到对应的根节点集合中</span></span><br><span class="line">        <span class="keyword">for</span> (String token : parent.keySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">root</span> <span class="operator">=</span> find(token); <span class="comment">// 找到当前元素的根节点</span></span><br><span class="line">            groups.computeIfAbsent(root, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(token);</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;List&lt;String&gt;&gt; resList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 打印结果</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : groups.entrySet()) &#123;</span><br><span class="line">            resList.add(entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        UnionFindUtils.union(<span class="string">&quot;token1&quot;</span>, <span class="string">&quot;token2&quot;</span>); <span class="comment">// token1 -&gt; token2</span></span><br><span class="line">        UnionFindUtils.union(<span class="string">&quot;token3&quot;</span>, <span class="string">&quot;token2&quot;</span>); <span class="comment">// token2 -&gt; token3</span></span><br><span class="line">        UnionFindUtils.union(<span class="string">&quot;token4&quot;</span>, <span class="string">&quot;token5&quot;</span>); <span class="comment">// token4 -&gt; token5</span></span><br><span class="line">        UnionFindUtils.union(<span class="string">&quot;token6&quot;</span>, <span class="string">&quot;token7&quot;</span>); <span class="comment">// token6 -&gt; token7</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试查找</span></span><br><span class="line">        System.out.println(<span class="string">&quot;token1的根节点: &quot;</span> + UnionFindUtils.find(<span class="string">&quot;token1&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;token4的根节点: &quot;</span> + UnionFindUtils.find(<span class="string">&quot;token4&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试是否连接</span></span><br><span class="line">        System.out.println(<span class="string">&quot;token1和token3是否连接: &quot;</span> + UnionFindUtils.isConnected(<span class="string">&quot;token1&quot;</span>, <span class="string">&quot;token3&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;token1和token4是否连接: &quot;</span> + UnionFindUtils.isConnected(<span class="string">&quot;token1&quot;</span>, <span class="string">&quot;token4&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印集合个数及每个集合的元素</span></span><br><span class="line">        System.out.println(UnionFindUtils.getGroupResult());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="业务实现"><a href="#业务实现" class="headerlink" title="业务实现"></a>业务实现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unionFind</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 清空experimentTempInfo</span></span><br><span class="line">    experimentTempInfoMapper.delete(Wrappers.lambdaQuery(ExperimentTempInfo.class));</span><br><span class="line">    <span class="comment">// 清空tempTorderInfo</span></span><br><span class="line">    tempOrderMapper.delete(Wrappers.lambdaQuery(TempTorder.class));</span><br><span class="line"></span><br><span class="line">    List&lt;TokenChanges&gt; changesList = tokenChangesMapper.selectList(Wrappers.lambdaQuery(TokenChanges.class));</span><br><span class="line">    <span class="keyword">for</span> (TokenChanges changes : changesList) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">oldUserId</span> <span class="operator">=</span> changes.getOldUserId();</span><br><span class="line">        <span class="type">String</span> <span class="variable">newUserId</span> <span class="operator">=</span> changes.getNewUserId();</span><br><span class="line">        UnionFindUtils.union(oldUserId, newUserId);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;ExperimentInfo&gt; experimentInfoList = experimentInfoMapper.selectList(Wrappers.lambdaQuery(ExperimentInfo.class).eq(ExperimentInfo::getFeatureId, <span class="string">&quot;course-more-info-status&quot;</span>));</span><br><span class="line">    <span class="keyword">for</span> (ExperimentInfo experimentInfo : experimentInfoList) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> experimentInfo.getUserId();</span><br><span class="line">        <span class="type">String</span> <span class="variable">rootId</span> <span class="operator">=</span> UnionFindUtils.find(userId);</span><br><span class="line">        <span class="type">ExperimentTempInfo</span> <span class="variable">tempInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExperimentTempInfo</span>();</span><br><span class="line">        BeanUtils.copyProperties(experimentInfo, tempInfo);</span><br><span class="line">        tempInfo.setUserId(rootId);</span><br><span class="line">        experimentTempInfoMapper.insert(tempInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Torder&gt; courseOrderList = orderMapper.selectList(Wrappers.lambdaQuery(Torder.class).eq(Torder::getPolishType, Common.POLISH_TYPE_WITH_COURSE_PAPER));</span><br><span class="line">    <span class="keyword">for</span> (Torder torder : courseOrderList) &#123;</span><br><span class="line">        <span class="type">TempTorder</span> <span class="variable">tempTorder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TempTorder</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> torder.getToken();</span><br><span class="line">        <span class="type">String</span> <span class="variable">rootId</span> <span class="operator">=</span> UnionFindUtils.find(userId);</span><br><span class="line">        BeanUtils.copyProperties(torder, tempTorder);</span><br><span class="line">        tempTorder.setToken(rootId);</span><br><span class="line">        tempOrderMapper.insert(tempTorder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="结果与结论"><a href="#结果与结论" class="headerlink" title="结果与结论"></a>结果与结论</h1><ul><li>通过上述方法，我们可以显著降低由于用户身份变化而导致的AB测试误差。此方案不仅简单易行，而且有效地提高了实验结果的可靠性。同时，它也证明了即使是在没有强制登录的情况下，也可以通过合理的设计和技术手段保持用户的一致性和唯一性。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;引言&quot;&gt;&lt;a href=&quot;#引言&quot; class=&quot;headerlink&quot; title=&quot;引言&quot;&gt;&lt;/a&gt;引言&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;在AB测试中，确保用户的一致性和唯一性是获得准确结果的关键。然而，在非强制登录的Web项目中，用户的唯一标识可能会因退出、登录、</summary>
      
    
    
    
    
    <category term="并查集" scheme="https://cyborg2077.github.io/tags/%E5%B9%B6%E6%9F%A5%E9%9B%86/"/>
    
  </entry>
  
  <entry>
    <title>A/B测试</title>
    <link href="https://cyborg2077.github.io/2024/12/20/GrowthBook/"/>
    <id>https://cyborg2077.github.io/2024/12/20/GrowthBook/</id>
    <published>2024-12-20T03:20:00.000Z</published>
    <updated>2025-01-22T12:57:07.108Z</updated>
    
    <content type="html"><![CDATA[<h1 id="什么是A-B测试"><a href="#什么是A-B测试" class="headerlink" title="什么是A/B测试"></a>什么是A/B测试</h1><ul><li><p>想象一下，你是一位魔法师，手中握有两种不同配方的魔药。为了找出哪一种更能增强魔法力量，你决定在不知情的学徒中进行一场秘密测试。这就是A/B测试的概念源头——它源自生物医学领域的「双盲测试」，其中参与者被随机分为两组，分别接受安慰剂和实际药物，以此评估药物的效果。</p></li><li><p>在数字世界里，我们的“魔药”是APP或者Web应用的新功能或设计改动。我们会将用户随机分成两个群体：一组体验新策略（A），另一组则继续使用现有版本（B）。通过对比两组用户的互动数据，我们可以科学地判断新产品特性是否带来了预期的改进。如果新策略证明有效，那么就像发现了一种更强大的魔药一样，我们就会用它来替代旧有方案。</p></li></ul><h1 id="为什么要进行A-B测试"><a href="#为什么要进行A-B测试" class="headerlink" title="为什么要进行A/B测试"></a>为什么要进行A/B测试</h1><ul><li>假设你想要知道一款新的魔法书是否能提高学生的成绩。如果你只在同一群学生中先后测试不同的书籍，或者在不同班级同时测试，结果可能会受到时间变化或学生个体差异的影响。因此，不采用A/B测试的话：<ol><li>假设1：即使是对同一人群的前后比较，由于环境、心情等因素的变化，行为本身可能已经有所不同。</li><li>假设2：当面对不同人群时，即便是在相同的时间段内，各群体的行为模式也可能千差万别。</li></ol></li><li>A/B测试的强大之处在于它能够最大限度地减少这些外部因素对实验结果的干扰，提供最纯净的“因果效应”测量方法，确保我们真正了解所做改变的实际影响。</li></ul><h1 id="A-B测试流程"><a href="#A-B测试流程" class="headerlink" title="A/B测试流程"></a>A/B测试流程</h1><ul><li><p>要施展这个神奇的实验法术，你需要遵循以下步骤：</p><ol><li><code>设定咒语（假设）</code>：首先明确你想验证的问题或假设。</li><li><code>划分阵营（分配）</code>：接着，把你的用户像分院帽那样公平地分成几个小组。</li><li><code>施放幻象（变体）</code>：为每个小组展示独特的内容或体验。</li><li><code>记录预言（追踪）</code>：仔细观察并记录每组成员的行为轨迹。</li><li><code>揭示真相（结果）</code>：最后分析数据，得出结论。</li></ol></li><li>对于开发人员来说，这门技艺的关键在于两点：<ol><li><code>编织法阵（接入A/B Test）</code>：根据用户所属的实验组，编写代码以实现不同的逻辑路径。</li><li><code>封印卷轴（实验后处理）</code>：无论实验成功与否，都需要清理代码，移除不再需要的部分，以便维持系统的整洁与高效。</li></ol></li><li>记住，每一次成功的A/B测试都是通往更好用户体验的一块基石。</li></ul><h1 id="GrowthBook"><a href="#GrowthBook" class="headerlink" title="GrowthBook"></a>GrowthBook</h1><h2 id="集成GrowthBook-SDK"><a href="#集成GrowthBook-SDK" class="headerlink" title="集成GrowthBook SDK"></a>集成GrowthBook SDK</h2><ul><li>在数字产品的世界里，每一次更新都是一场冒险。为了确保新的特性和功能能为用户带来真正的价值，我们需要一个可靠的向导——这就是GrowthBook登场的时刻。</li></ul><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul><li>让我们以Java为例，探索如何将GrowthBook的SDK集成到我们的项目中。想象一下，你正在建立一座通往未知世界的桥梁：<br>  <img src="https://s21.ax1x.com/2025/01/16/pEFNsWF.png" alt=""></li></ul><ol><li>未连接状态：此时，你的应用程序就像是一座孤岛，与外界隔绝。<br><img src="https://s21.ax1x.com/2025/01/16/pEFNcQJ.png" alt=""></li><li>安装依赖并首次请求：一旦你安装了必要的依赖项，并成功发出获取激活特征接口的请求，这座桥梁便开始构建。通过下面的代码片段，你可以建立起与GrowthBook的第一次对话：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FEATURES_ENDPOINT</span> <span class="operator">=</span> <span class="string">&quot;http://10.211.10.238:3100/api/features/sdk-MYY3Wl3O5NFQYksN&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getFeatures</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(FEATURES_ENDPOINT)</span><br><span class="line">            .get()</span><br><span class="line">            .build();</span><br><span class="line">    <span class="keyword">return</span> JSONObject.parseObject(okHttpClient.newCall(request).execute().body().string()).getString(<span class="string">&quot;features&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="编写回调"><a href="#编写回调" class="headerlink" title="编写回调"></a>编写回调</h3><ul><li>每当有用户触发实验时，我们就需要捕捉这一刻的信息，并将其安全地保存起来。这不仅是对历史的铭记，也是对未来分析的基础。GrowthBook为我们提供了一个回调函数，可以用于处理每次实验触发时的数据存储逻辑：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">TrackingCallback</span> <span class="variable">trackingCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrackingCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ValueType&gt; <span class="keyword">void</span> <span class="title function_">onTrack</span><span class="params">(Experiment&lt;ValueType&gt; experiment, ExperimentResult&lt;ValueType&gt; result)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;用户触发了实验: &quot;</span> + experiment.toJson());</span><br><span class="line">        log.info(<span class="string">&quot;被分配到的变体: &quot;</span> + result.toJson());</span><br><span class="line">        experimentInfoMapper.insert(<span class="keyword">new</span> <span class="title class_">ExperimentInfo</span>()</span><br><span class="line">                .setUserId(result.getHashValue())</span><br><span class="line">                .setExperimentKey(experiment.getKey())</span><br><span class="line">                .setVariations(JSONObject.toJSONString(experiment.getVariations()))</span><br><span class="line">                .setWeights(JSONObject.toJSONString(experiment.getWeights()))</span><br><span class="line">                .setIsActive(experiment.getIsActive())</span><br><span class="line">                .setCoverage(experiment.getCoverage())</span><br><span class="line">                .setNamespace(JSONObject.toJSONString(experiment.getNamespace()))</span><br><span class="line">                .setForce(experiment.getForce())</span><br><span class="line">                .setHashAttribute(experiment.getHashAttribute())</span><br><span class="line">                .setFeatureId(result.getFeatureId())</span><br><span class="line">                .setVariationValue(JSONObject.toJSONString(result.getValue()))</span><br><span class="line">                .setVariationId(result.getVariationId())</span><br><span class="line">                .setInExperiment(result.getInExperiment())</span><br><span class="line">                .setHashUsed(result.getHashUsed())</span><br><span class="line">                .setHashValue(result.getHashValue())</span><br><span class="line">                .setTimestamp(LocalDateTime.now())</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h3 id="定制用户属性"><a href="#定制用户属性" class="headerlink" title="定制用户属性"></a>定制用户属性</h3><ul><li>为了让实验更加精准，我们需要为每位用户提供定制化的属性。这些属性不仅包括内置的基本信息，还可以包含自定义的标签，以便更好地理解和预测用户行为。例如，在后端项目中，我们可以使用用户的token作为ID，确保同一用户始终获得一致的实验体验<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JSONObject</span> <span class="variable">userAttributesObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">userAttributesObj.put(<span class="string">&quot;id&quot;</span>, JwtHelper.getUserId(request.getHeader(<span class="string">&quot;Authorization&quot;</span>))); <span class="comment">// 使用用户token</span></span><br><span class="line"><span class="comment">// 添加更多属性...</span></span><br><span class="line"><span class="type">String</span> <span class="variable">userAttributesJson</span> <span class="operator">=</span> userAttributesObj.toString();</span><br><span class="line">growthBook.setAttributes(userAttributesJson);</span><br></pre></td></tr></table></figure></li></ul><h3 id="构建GrowthBook实例"><a href="#构建GrowthBook实例" class="headerlink" title="构建GrowthBook实例"></a>构建GrowthBook实例</h3><ul><li>接下来，是时候创建GrowthBook实例了。这个步骤就像是给每个用户编织一条独一无二的命运之路，根据他们的特性决定他们将体验到的产品版本。我们将之前获取的特征JSON、用户属性以及回调函数组合在一起：</li><li>创建GrowthBook实例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">GBContext</span> <span class="variable">context</span> <span class="operator">=</span> GBContext.builder()</span><br><span class="line">    .featuresJson(featuresJson)                         <span class="comment">// 获取的开启特征JSON</span></span><br><span class="line">    .attributesJson(userAttributesObj.toString())       <span class="comment">// 用户属性</span></span><br><span class="line">    .trackingCallback(trackingCallback)                 <span class="comment">// 实验跟踪回调</span></span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="type">GrowthBook</span> <span class="variable">growthBook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GrowthBook</span>(context);</span><br></pre></td></tr></table></figure></li></ul><h3 id="调用getFeatureValue"><a href="#调用getFeatureValue" class="headerlink" title="调用getFeatureValue"></a>调用getFeatureValue</h3><ul><li>最后，当我们调用getFeatureValue方法时，GrowthBook会基于传入的用户属性和预设规则，智能地选择最适合的路径。这一过程如同解开命运的谜题，指引着产品的发展方向：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> growthBook.getFeatureValue(<span class="string">&quot;my-feature&quot;</span>, <span class="string">&quot;defaule_value&quot;</span>);</span><br></pre></td></tr></table></figure></li></ul><h3 id="后端落地方案"><a href="#后端落地方案" class="headerlink" title="后端落地方案"></a>后端落地方案</h3><ul><li>为了简化流程，建议在拦截器中初始化用户属性，这样可以确保每个请求都能自动携带正确的用户信息，而无需在每个接口中重复设置。这一步骤就像是给每个请求附上了一张隐形的通行证，使其顺利通行于系统的各个角落<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeaderInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> &#123;</span><br><span class="line">        <span class="comment">// 组装用户属性，可以从请求头中获取信息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">userAttributes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        userAttributes.put(<span class="string">&quot;id&quot;</span>, JwtHelper.getUserId(request.getHeader(<span class="string">&quot;Authorization&quot;</span>)));</span><br><span class="line">        request.setAttribute(<span class="string">&quot;userAttributes&quot;</span>, userAttributes.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="后端接口"><a href="#后端接口" class="headerlink" title="后端接口"></a>后端接口</h3><ul><li>当一切准备就绪，剩下的就是让GrowthBook带领我们进入实际的应用场景。通过以下示例代码，我们可以看到如何在一个简单的GET接口中实现A/B测试的逻辑：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/ab&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">runABTest</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">featuresJson</span> <span class="operator">=</span> getFeatures();</span><br><span class="line">    <span class="type">String</span> <span class="variable">userAttributesJson</span> <span class="operator">=</span> (String) request.getAttribute(<span class="string">&quot;userAttributes&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">GBContext</span> <span class="variable">context</span> <span class="operator">=</span> GBContext.builder()</span><br><span class="line">            .featuresJson(featuresJson)</span><br><span class="line">            .attributesJson(userAttributesJson)</span><br><span class="line">            .trackingCallback(trackingCallback)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="type">GrowthBook</span> <span class="variable">growthBook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GrowthBook</span>(context);</span><br><span class="line">    <span class="comment">// 这里的blue是当growthBook服务不可用时的默认值，不会因为growthBook挂掉导致严重问题</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">variant</span> <span class="operator">=</span> growthBook.getFeatureValue(<span class="string">&quot;special_button_color&quot;</span>, <span class="string">&quot;blue&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;输出结果：&#123;&#125;&quot;</span>, variant);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据variant执行不同的业务逻辑；这里也可以写if-else判断</span></span><br><span class="line">    your_method(variant);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> variant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在这个过程中，我们还考虑到了代码的可维护性，尽量减少硬编码的if-else结构，转而采用参数化的方式调用方法，既保持了灵活性，又降低了未来调整的成本。</p></li><li><p>通过以上步骤，你已经掌握了如何利用GrowthBook进行A/B测试的艺术。无论是优化用户体验还是推动业务增长，GrowthBook都将是你不可或缺的伙伴。</p></li></ul><h1 id="设计实验"><a href="#设计实验" class="headerlink" title="设计实验"></a>设计实验</h1><ul><li><p>设计一个成功的A/B测试，就像是精心策划一场魔法仪式，每个步骤都至关重要。让我们一步步揭开这个神秘的过程。</p><ol><li>创建特征：编织你的魔咒<br>首先，你需要定义你想要测试的新特性或改动。这一步骤如同选择魔法咒语中的关键词一样重要。你可以通过GrowthBook的界面来创建这些特征，并为它们赋予独特的标识符。<br><img src="https://s21.ax1x.com/2025/01/16/pEFN2LR.png" alt=""></li><li>指定规则：设定咒语的力量范围<br>接下来，为每一个特征指定激活条件。这意味着定义在什么情况下该特性应该对用户可见或生效。你可以根据用户的属性（如地理位置、设备类型等）来精细地控制这一过程。<br><img src="https://s21.ax1x.com/2025/01/16/pEFNfdx.png" alt=""></li><li>构建实验基础信息：建立魔法实验室<br>在开始实验之前，确保所有必要的信息都已经准备就绪。包括实验的目标、假设以及预期的结果。这些都是后续评估实验成功与否的重要依据。<br><img src="https://s21.ax1x.com/2025/01/16/pEFN5FK.png" alt=""></li><li>编写分流策略：规划命运的分岔路<br>这里是你决定如何将用户按比例分配到不同实验组的地方<br><img src="https://s21.ax1x.com/2025/01/16/pEFNoWD.png" alt=""></li><li>选择目标用户：召唤你的试验者<br>最后，确定哪些用户将参与此次实验。这可能涉及到筛选出特定类型的用户，或者简单地随机选取一部分人作为样本。<br><img src="https://s21.ax1x.com/2025/01/16/pEFN7Se.png" alt=""></li></ol></li><li><p>编写测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/ab&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">runABTest</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 获取并初始化 GrowthBook 实例</span></span><br><span class="line">    <span class="type">GBContext</span> <span class="variable">context</span> <span class="operator">=</span> GBContext.builder()</span><br><span class="line">            .featuresJson(getFeatures())</span><br><span class="line">            .attributesJson((String) request.getAttribute(<span class="string">&quot;userAttributes&quot;</span>))</span><br><span class="line">            .trackingCallback(trackingCallback)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="type">GrowthBook</span> <span class="variable">growthBook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GrowthBook</span>(context);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据用户属性和特征规则进行分流</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">variant</span> <span class="operator">=</span> growthBook.getFeatureValue(<span class="string">&quot;special_button_color&quot;</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;输出结果：&#123;&#125;&quot;</span>, variant);</span><br><span class="line">    <span class="keyword">return</span> variant;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/ab/stats&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Integer&gt; <span class="title function_">abTestStatistics</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">    Map&lt;String, Integer&gt; resultCount = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟100次请求以获取统计数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                    .url(<span class="string">&quot;http://localhost:8180/paperReduction/api/test/ab&quot;</span>)</span><br><span class="line">                    .header(<span class="string">&quot;X-Special-Header&quot;</span>, <span class="string">&quot;true&quot;</span>)</span><br><span class="line">                    .get()</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.newCall(request).execute();</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> response.body().string();</span><br><span class="line">            resultCount.merge(result, <span class="number">1</span>, Integer::sum);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;请求失败: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;A/B 测试分布结果: &#123;&#125;&quot;</span>, resultCount);</span><br><span class="line">    <span class="keyword">return</span> resultCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>根据上述代码运行的结果，我们观察到流量分配为50%，即只有半数的流量执行了实验，而另一半则保持默认设置（例如按钮颜色为蓝色）。这样的结果有助于我们初步了解不同变体之间的差异。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8180/paperReduction/api/test/ab/stats</span><br><span class="line">&#123;<span class="string">&quot;red&quot;</span>:9,<span class="string">&quot;green&quot;</span>:15,<span class="string">&quot;blue&quot;</span>:65,<span class="string">&quot;yellow&quot;</span>:11&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h1><ul><li>数据分析是理解实验影响的关键。它帮助我们将原始数据转化为有价值的见解，从而指导未来的决策。<h2 id="创建事实表"><a href="#创建事实表" class="headerlink" title="创建事实表"></a>创建事实表</h2></li><li>为了更好地组织和查询数据，我们需要构建一个包含所有相关信息的事实表。这就像是一本记录了每次实验细节的魔法之书。<br><img src="https://s21.ax1x.com/2025/01/16/pEFBVRf.png" alt=""></li><li>GrowthBook并没有准确的获取字段数据类型，我们需要调整某些字段<br><img src="https://s21.ax1x.com/2025/01/16/pEFBZz8.png" alt=""></li></ul><h2 id="创建指标"><a href="#创建指标" class="headerlink" title="创建指标"></a>创建指标</h2><ol><li><p>Proportion（比例）：衡量某个事件发生的频率，如点击率或转化率。它适用于二元事件，并能提供关于成功率的直接洞察。</p></li><li><p>Retention（留存率）：评估用户在一段时间内的持续活跃程度。这对于了解产品的粘性和用户忠诚度尤为重要。</p></li><li><p>Mean（平均值）：计算用户行为的平均水平，如订单金额或会话时长。它对于连续性数据非常有用，但需要注意的是，极值可能会扭曲结果。</p></li><li><p>Ratio（比率）：对比两个相关数值的比例关系，比如每次会话的平均点击数。这种方法能够揭示复杂的行为模式，超越简单的比例或平均值所能表达的内容。<br><img src="https://s21.ax1x.com/2025/01/16/pEFBAit.png" alt=""></p></li></ol><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><ol><li>创建一个用户支付金额总和的平均值<br><img src="https://s21.ax1x.com/2025/01/16/pEFBuLQ.png" alt=""></li><li><p>可以看到周期范围内的用户平均金额变化及分布<br><img src="https://s21.ax1x.com/2025/01/16/pEFBMZj.png" alt=""></p></li><li><p>从实验数据中，我们发现绿色按钮似乎更受用户欢迎。在统计学中，我们一般认为置信水平达到95%以上才能确认结果的有效性。<br><img src="https://s21.ax1x.com/2025/01/16/pEFBQds.png" alt=""></p></li><li>一旦实验结束，我们可以设置胜利的一方（在这里是绿色按钮）成为新的标准配置，所有流量都将被导向这一选项。<br><img src="https://s21.ax1x.com/2025/01/16/pEFBlon.png" alt=""><br>调用接口验证<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8180/paperReduction/api/test/ab/stats</span><br><span class="line">&#123;<span class="string">&quot;green&quot;</span>:100&#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li><p>在正式开展A/B测试之前，务必先进行AA测试，以保证实验系统的可靠性和准确性。AA测试的作用包括：</p><ol><li>分流均匀性检验：确保实验组和对照组之间的用户分配是公平且随机的。</li><li>埋点检查：验证数据收集机制是否正常工作，避免因数据质量问题导致误判。</li><li>历史数据重播：模拟真实场景下的数据流，检测系统性能并生成p值分布图，以此判断实验环境是否稳定。</li></ol></li><li>通过遵循这些最佳实践，我们可以确保每一次A/B测试都能带来有价值的成果，助力产品不断优化和发展。</li></ul>]]></content>
    
    
    <summary type="html">GrowthBook -- 一个免费的AB测试框架</summary>
    
    
    
    
    <category term="A/B测试" scheme="https://cyborg2077.github.io/tags/A-B%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>MathML转OMML写入Word，插入公式</title>
    <link href="https://cyborg2077.github.io/2024/12/16/MathMLToOOML/"/>
    <id>https://cyborg2077.github.io/2024/12/16/MathMLToOOML/</id>
    <published>2024-12-16T02:31:49.000Z</published>
    <updated>2025-02-16T13:10:40.712Z</updated>
    
    <content type="html"><![CDATA[<h1 id="业务背景"><a href="#业务背景" class="headerlink" title="业务背景"></a>业务背景</h1><ul><li>想在生成的文档中插入公式，丰富文档格式，提高专业度。但大模型输出的公式中，LaTeX 是最稳定的生成格式，但是也不排除生成错误的情况，导致 Word 无法正确渲染。因此，本文需要解决以下两个问题：<ol><li>将 <code>LaTeX</code> 公式转换为 <code>MathML</code>，然后转换为 <code>OMML</code>，并写入 <code>Word</code>。 目前，<code>LaTeX</code> 转 <code>MathML</code> 的方案较为成熟，因此本文重点探讨 <code>MathML</code> 转 <code>OMML</code> 的实现。</li><li>校验最终插入 <code>Word</code> 文档的 <code>OMML</code> 是否可以正常渲染。</li></ol></li></ul><h1 id="方案实现"><a href="#方案实现" class="headerlink" title="方案实现"></a>方案实现</h1><ul><li>经过我的一番搜索，在stackoverflow上找到了一个解决方案，微软提供了 XSLT 样式表，用于使用 XSLT 将 OMML 转换为 MathML.<br><img src="https://s21.ax1x.com/2025/02/15/pEKNCQI.png" alt=""></li><li>整体公式处理链路如下<ol><li>大模型生成LaTeX格式的公式，随后转为MathML</li><li>调用服务将MathML转为OOML，并写入Word文档</li><li>使用Open-Xml SDK 校验Word文档格式是否有误。</li></ol></li></ul><div class="tabs" id="可恶的公式啊啊啊啊"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#可恶的公式啊啊啊啊-1">Program.cs</button></li><li class="tab"><button type="button" data-href="#可恶的公式啊啊啊啊-2">startup.cs</button></li><li class="tab"><button type="button" data-href="#可恶的公式啊啊啊啊-3">ValidatorController.cs</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="可恶的公式啊啊啊啊-1"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">OpenXmlValidatorService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            CreateHostBuilder(args).Build().Run();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">            Host.CreateDefaultBuilder(args)</span><br><span class="line">                .ConfigureWebHostDefaults(webBuilder =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    webBuilder.UseStartup&lt;Startup&gt;();</span><br><span class="line">                &#125;)</span><br><span class="line">                .ConfigureLogging(logging =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    logging.ClearProviders(); <span class="comment">// 清除默认的日志提供者</span></span><br><span class="line">                    logging.AddConsole(options =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        options.TimestampFormat = <span class="string">&quot;yyyy-MM-dd HH:mm:ss &quot;</span>; <span class="comment">// 设置时间戳格式</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="可恶的公式啊啊啊啊-2"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">OpenXmlValidatorService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            services.AddControllers();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">            &#123;</span><br><span class="line">                app.UseDeveloperExceptionPage();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            app.UseRouting();</span><br><span class="line"></span><br><span class="line">            app.UseEndpoints(endpoints =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                endpoints.MapControllers();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="可恶的公式啊啊啊啊-3"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> DocumentFormat.OpenXml.Packaging;</span><br><span class="line"><span class="keyword">using</span> DocumentFormat.OpenXml.Validation;</span><br><span class="line"><span class="keyword">using</span> DocumentFormat.OpenXml.Wordprocessing;</span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br><span class="line"><span class="keyword">using</span> System.Xml.Xsl;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Xml.Linq;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConvertRequest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; MathmlList &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> OutputFilePath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">OpenXmlValidatorService.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ValidatorController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;ValidatorController&gt; _logger;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> DateTime _startTime;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ValidatorController</span>(<span class="params">ILogger&lt;ValidatorController&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger = logger;</span><br><span class="line">            _startTime = DateTime.Now;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpPost(<span class="string">&quot;validate&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">ValidateDocumentFromMathML</span>(<span class="params">[FromBody] <span class="built_in">string</span> mathml</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">$&quot;接收到参数：<span class="subst">&#123;mathml&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> outputDirectory = <span class="string">&quot;/app/mathml_doc/&quot;</span>;</span><br><span class="line">                <span class="built_in">string</span> fileName = Guid.NewGuid().ToString() + <span class="string">&quot;.docx&quot;</span>;</span><br><span class="line">                <span class="built_in">string</span> tempFilePath = Path.Combine(outputDirectory, fileName);</span><br><span class="line">                ConvertToDocx(mathml, tempFilePath);</span><br><span class="line"></span><br><span class="line">                _logger.LogInformation(<span class="string">&quot;文档生成成功，开始验证：&#123;FilePath&#125;&quot;</span>, tempFilePath);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用 OpenXmlValidator 验证文档</span></span><br><span class="line">                <span class="keyword">using</span> (<span class="keyword">var</span> doc = WordprocessingDocument.Open(tempFilePath, <span class="literal">false</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    OpenXmlValidator validator = <span class="keyword">new</span> OpenXmlValidator();</span><br><span class="line">                    <span class="keyword">var</span> errors = validator.Validate(doc);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (errors.Any())</span><br><span class="line">                    &#123;</span><br><span class="line">                        _logger.LogWarning(<span class="string">&quot;文档验证发现 &#123;ErrorCount&#125; 个错误&quot;</span>, errors.Count());</span><br><span class="line">                        <span class="keyword">foreach</span> (<span class="keyword">var</span> error <span class="keyword">in</span> errors)</span><br><span class="line">                        &#123;</span><br><span class="line">                            _logger.LogDebug(<span class="string">&quot;错误描述: &#123;Description&#125;, 节点路径: &#123;Node&#125;, 部件: &#123;Part&#125;&quot;</span>,</span><br><span class="line">                                error.Description, error.Node, error.Part?.Uri);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (error.Part != <span class="literal">null</span> &amp;&amp; error.Part.Uri.ToString() == <span class="string">&quot;/word/document.xml&quot;</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">if</span> (error.Description.Contains(<span class="string">&quot;math&quot;</span>) || error.Description.Contains(<span class="string">&quot;Math&quot;</span>))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    _logger.LogError(<span class="string">&quot;检测到公式渲染问题：&#123;Description&#125;&quot;</span>, error.Description);</span><br><span class="line">                                    <span class="keyword">return</span> Ok(<span class="keyword">new</span></span><br><span class="line">                                    &#123;</span><br><span class="line">                                        code = <span class="number">400</span>,</span><br><span class="line">                                        message = tempFilePath</span><br><span class="line">                                    &#125;);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    _logger.LogInformation(<span class="string">&quot;文档验证通过：&#123;FilePath&#125;&quot;</span>, tempFilePath);</span><br><span class="line">                    <span class="keyword">return</span> Ok(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, message = <span class="string">&quot;文档符合 Open XML 规范&quot;</span> &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogError(ex, <span class="string">&quot;验证时发生异常：&#123;Message&#125;&quot;</span>, ex.Message);</span><br><span class="line">                <span class="keyword">return</span> StatusCode(StatusCodes.Status500InternalServerError, <span class="keyword">new</span></span><br><span class="line">                &#123;</span><br><span class="line">                    code = <span class="number">500</span>,</span><br><span class="line">                    message = <span class="string">$&quot;验证时发生异常: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;health&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetHeartbeat</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> currentTime = DateTime.Now;</span><br><span class="line">            <span class="keyword">var</span> uptime = currentTime - _startTime;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">new</span></span><br><span class="line">            &#123;</span><br><span class="line">                serviceName = <span class="string">&quot;快降重 Open XML 文档校验 服务&quot;</span>,</span><br><span class="line">                statusCode = <span class="number">200</span>,</span><br><span class="line">                timestamp = currentTime.ToString(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>),</span><br><span class="line">                uptime = <span class="string">$&quot;<span class="subst">&#123;uptime.Hours&#125;</span>h <span class="subst">&#123;uptime.Minutes&#125;</span>m&quot;</span>,</span><br><span class="line">                version = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">$&quot;心跳正常：<span class="subst">&#123;result&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Ok(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpPost(<span class="string">&quot;convertMathml&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">ConvertToDocx</span>(<span class="params">[FromBody] ConvertRequest request</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (request == <span class="literal">null</span> || request.MathmlList == <span class="literal">null</span> || request.MathmlList.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Ok(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, message = <span class="string">&quot;请求体中缺少 MathML 列表或数据为空。&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(request.OutputFilePath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Ok(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, message = <span class="string">&quot;请求体中缺少输出文件路径。&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 调用已有方法生成文档</span></span><br><span class="line">                ConvertToDocxByList(request.MathmlList, request.OutputFilePath);</span><br><span class="line">                <span class="keyword">return</span> Ok(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, message = <span class="string">&quot;文档生成成功&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Ok(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, message = <span class="string">$&quot;文档生成失败：<span class="subst">&#123;ex.Message&#125;</span>&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConvertToDocx</span>(<span class="params"><span class="built_in">string</span> mathml, <span class="built_in">string</span> outputFilePath</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// XSLT 转换 MathML 到 OfficeMath</span></span><br><span class="line">            <span class="built_in">string</span> xsltPath = <span class="string">&quot;./MML2OMML.XSL&quot;</span>; <span class="comment">// 确保路径正确</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;xsltPath: &quot;</span> + xsltPath);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;currentPath: &quot;</span> + Directory.GetCurrentDirectory());</span><br><span class="line">            <span class="keyword">using</span> (XmlReader reader = XmlReader.Create(<span class="keyword">new</span> StringReader(mathml)))</span><br><span class="line">            &#123;</span><br><span class="line">                XslCompiledTransform xslTransform = <span class="keyword">new</span> XslCompiledTransform();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 加载 XSLT 转换文件</span></span><br><span class="line">                <span class="keyword">if</span> (System.IO.File.Exists(xsltPath))</span><br><span class="line">                &#123;</span><br><span class="line">                    xslTransform.Load(xsltPath);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;XSLT 文件未找到，请确保文件路径正确！&quot;</span> + Directory.GetCurrentDirectory());</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用 MemoryStream 存储转换后的内容</span></span><br><span class="line">                <span class="keyword">using</span> (MemoryStream ms = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">                &#123;</span><br><span class="line">                    XmlWriterSettings settings = <span class="keyword">new</span> XmlWriterSettings</span><br><span class="line">                    &#123;</span><br><span class="line">                        ConformanceLevel = ConformanceLevel.Fragment,</span><br><span class="line">                        OmitXmlDeclaration = <span class="literal">true</span></span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">using</span> (XmlWriter xw = XmlWriter.Create(ms, settings))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 执行转换</span></span><br><span class="line">                        xslTransform.Transform(reader, xw);</span><br><span class="line">                        ms.Seek(<span class="number">0</span>, SeekOrigin.Begin);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 从内存流读取转换后的内容</span></span><br><span class="line">                        StreamReader sr = <span class="keyword">new</span> StreamReader(ms, Encoding.UTF8);</span><br><span class="line">                        <span class="built_in">string</span> officeML = sr.ReadToEnd();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 创建 Word 文档并插入 OfficeMath</span></span><br><span class="line">                        <span class="keyword">using</span> (WordprocessingDocument wordDoc = WordprocessingDocument.Create(outputFilePath, DocumentFormat.OpenXml.WordprocessingDocumentType.Document))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">var</span> mainPart = wordDoc.AddMainDocumentPart();</span><br><span class="line">                            mainPart.Document = <span class="keyword">new</span> Document(<span class="keyword">new</span> Body());</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 创建 OfficeMath 对象</span></span><br><span class="line">                            <span class="comment">// Console.WriteLine(om.InnerXml);</span></span><br><span class="line">                            <span class="comment">// 将公式添加到文档中的段落</span></span><br><span class="line">                            DocumentFormat.OpenXml.Wordprocessing.Paragraph paragraph = <span class="keyword">new</span> DocumentFormat.OpenXml.Wordprocessing.Paragraph();</span><br><span class="line">                            DocumentFormat.OpenXml.Wordprocessing.Run run = <span class="keyword">new</span> DocumentFormat.OpenXml.Wordprocessing.Run();</span><br><span class="line">                            Console.WriteLine(<span class="string">&quot;OriginInnerXML: &quot;</span> + officeML);</span><br><span class="line">                            officeML = officeML.Replace(<span class="string">&quot;&lt;m:e /&gt;&quot;</span>, <span class="string">&quot;&lt;m:e&gt;&lt;m:r&gt;&lt;w:rPr&gt;&lt;w:rFonts w:ascii=&#x27;Cambria Math&#x27; w:hAnsi=&#x27;Cambria Math&#x27; /&gt;&lt;/w:rPr&gt;&lt;m:t xml:space=&#x27;preserve&#x27;&gt; &lt;/m:t&gt;&lt;/m:r&gt;&lt;/m:e&gt;&quot;</span>);</span><br><span class="line">                            paragraph.InnerXml = officeML;</span><br><span class="line">                            Console.WriteLine(<span class="string">&quot;InnerXML: &quot;</span> + officeML);</span><br><span class="line"></span><br><span class="line">                            DocumentFormat.OpenXml.Math.OfficeMath om = (DocumentFormat.OpenXml.Math.OfficeMath)paragraph.GetFirstChild&lt;DocumentFormat.OpenXml.Math.OfficeMath&gt;().Clone();</span><br><span class="line">                            DocumentFormat.OpenXml.Wordprocessing.Paragraph paragraph1 = <span class="keyword">new</span> DocumentFormat.OpenXml.Wordprocessing.Paragraph();</span><br><span class="line"></span><br><span class="line">                            paragraph1.Append(om);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 将段落添加到文档正文</span></span><br><span class="line">                            mainPart.Document.Body.Append(paragraph1);</span><br><span class="line">                            mainPart.Document.Save();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        Console.WriteLine(<span class="string">&quot;Word 文档生成成功！&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConvertToDocxByList</span>(<span class="params">List&lt;<span class="built_in">string</span>&gt; mathmlList, <span class="built_in">string</span> outputFilePath</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> directoryPath = Path.GetDirectoryName(outputFilePath);</span><br><span class="line">            <span class="keyword">if</span> (!Directory.Exists(directoryPath))</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;目录不存在，正在创建目录：<span class="subst">&#123;directoryPath&#125;</span>&quot;</span>);</span><br><span class="line">                Directory.CreateDirectory(directoryPath);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// XSLT 转换 MathML 到 OfficeMath</span></span><br><span class="line">            <span class="built_in">string</span> xsltPath = <span class="string">&quot;./MML2OMML.XSL&quot;</span>; <span class="comment">// 确保路径正确</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;xsltPath: &quot;</span> + xsltPath);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;currentPath: &quot;</span> + Directory.GetCurrentDirectory());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!System.IO.File.Exists(xsltPath))</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;XSLT 文件未找到，请确保文件路径正确！&quot;</span> + Directory.GetCurrentDirectory());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 加载 XSLT 转换文件</span></span><br><span class="line">            XslCompiledTransform xslTransform = <span class="keyword">new</span> XslCompiledTransform();</span><br><span class="line">            xslTransform.Load(xsltPath);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建 Word 文档</span></span><br><span class="line">            <span class="keyword">using</span> (WordprocessingDocument wordDoc = WordprocessingDocument.Create(outputFilePath, DocumentFormat.OpenXml.WordprocessingDocumentType.Document))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> mainPart = wordDoc.AddMainDocumentPart();</span><br><span class="line">                mainPart.Document = <span class="keyword">new</span> Document(<span class="keyword">new</span> Body());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="built_in">string</span> mathml <span class="keyword">in</span> mathmlList)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 将每个 MathML 转换为 OfficeMath</span></span><br><span class="line">                    <span class="keyword">using</span> (XmlReader reader = XmlReader.Create(<span class="keyword">new</span> StringReader(mathml)))</span><br><span class="line">                    <span class="keyword">using</span> (MemoryStream ms = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">                    &#123;</span><br><span class="line">                        XmlWriterSettings settings = <span class="keyword">new</span> XmlWriterSettings</span><br><span class="line">                        &#123;</span><br><span class="line">                            ConformanceLevel = ConformanceLevel.Fragment,</span><br><span class="line">                            OmitXmlDeclaration = <span class="literal">true</span></span><br><span class="line">                        &#125;;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">using</span> (XmlWriter xw = XmlWriter.Create(ms, settings))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// 执行转换</span></span><br><span class="line">                            xslTransform.Transform(reader, xw);</span><br><span class="line">                            ms.Seek(<span class="number">0</span>, SeekOrigin.Begin);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 从内存流读取转换后的内容</span></span><br><span class="line">                            <span class="keyword">using</span> (StreamReader sr = <span class="keyword">new</span> StreamReader(ms, Encoding.UTF8))</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">string</span> officeML = sr.ReadToEnd();</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 创建 OfficeMath 对象</span></span><br><span class="line">                                Console.WriteLine(<span class="string">&quot;OriginInnerXML: &quot;</span> + officeML);</span><br><span class="line">                                DocumentFormat.OpenXml.Wordprocessing.Paragraph tempParagraph = <span class="keyword">new</span> DocumentFormat.OpenXml.Wordprocessing.Paragraph();</span><br><span class="line">                                officeML = AddFontStyle(officeML);</span><br><span class="line">                                officeML = officeML.Replace(<span class="string">&quot;&lt;m:e /&gt;&quot;</span>, <span class="string">&quot;&lt;m:e&gt;&lt;m:r&gt;&lt;w:rPr&gt;&lt;w:rFonts w:ascii=&#x27;Cambria Math&#x27; w:hAnsi=&#x27;Cambria Math&#x27; /&gt;&lt;/w:rPr&gt;&lt;m:t xml:space=&#x27;preserve&#x27;&gt; &lt;/m:t&gt;&lt;/m:r&gt;&lt;/m:e&gt;&quot;</span>);</span><br><span class="line">                                tempParagraph.InnerXml = officeML;</span><br><span class="line">                                Console.WriteLine(<span class="string">&quot;InnerXML: &quot;</span> + officeML);</span><br><span class="line">                                <span class="comment">// 获取转换后的 OfficeMath</span></span><br><span class="line">                                DocumentFormat.OpenXml.Math.OfficeMath om = tempParagraph.GetFirstChild&lt;DocumentFormat.OpenXml.Math.OfficeMath&gt;();</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> (om != <span class="literal">null</span>)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    DocumentFormat.OpenXml.Wordprocessing.Paragraph paragraph = <span class="keyword">new</span> DocumentFormat.OpenXml.Wordprocessing.Paragraph();</span><br><span class="line">                                    paragraph.Append(om.CloneNode(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 将段落添加到文档正文</span></span><br><span class="line">                                    mainPart.Document.Body.Append(paragraph);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                    Console.WriteLine(<span class="string">&quot;OfficeMath 转换失败，跳过该公式。&quot;</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 保存文档</span></span><br><span class="line">                mainPart.Document.Save();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Word 文档生成成功！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">AddFontStyle</span>(<span class="params"><span class="built_in">string</span> inputOfficeML</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;接收到的inputOfficeML: &quot;</span> + inputOfficeML);</span><br><span class="line">            XDocument xmlDoc = XDocument.Parse(inputOfficeML);</span><br><span class="line">            XNamespace m = <span class="string">&quot;http://schemas.openxmlformats.org/officeDocument/2006/math&quot;</span>;</span><br><span class="line">            XNamespace w = <span class="string">&quot;http://schemas.openxmlformats.org/wordprocessingml/2006/main&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (xmlDoc.Root != <span class="literal">null</span> &amp;&amp; xmlDoc.Root.Name.Namespace != w)</span><br><span class="line">            &#123;</span><br><span class="line">                xmlDoc.Root.Add(<span class="keyword">new</span> XAttribute(XNamespace.Xmlns + <span class="string">&quot;w&quot;</span>, w.NamespaceName));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> rPrElements = xmlDoc.Descendants(m + <span class="string">&quot;rPr&quot;</span>).Where(rPr =&gt; !rPr.HasElements);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> rPr <span class="keyword">in</span> rPrElements.ToList())</span><br><span class="line">            &#123;</span><br><span class="line">                rPr.ReplaceWith(<span class="keyword">new</span> XElement(m + <span class="string">&quot;rPr&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> XElement(w + <span class="string">&quot;rFonts&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> XAttribute(w + <span class="string">&quot;ascii&quot;</span>, <span class="string">&quot;Cambria Math&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> XAttribute(w + <span class="string">&quot;hAnsi&quot;</span>, <span class="string">&quot;Cambria Math&quot;</span>))));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> xmlDoc.ToString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1 id="公式生成链路"><a href="#公式生成链路" class="headerlink" title="公式生成链路"></a>公式生成链路</h1><ul><li><p>该方案在Mac版WPS会存在兼容性问题，因WPS默认字体设置错误导致公式渲染异常，但Word底层XML结构中的公式节点字体设置是正确的。</p><ul><li>解决方案：在Windows系统上安装Office Word，使用命令行方式将文件另存一份后，再用Mac版WPS打开，公式即可正常显示。<div class="tabs" id="mac版wps兼容性问题"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#mac版wps兼容性问题-1">命令行方式</button></li><li class="tab"><button type="button" data-href="#mac版wps兼容性问题-2">接口封装</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="mac版wps兼容性问题-1"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">param (</span><br><span class="line">    [string]$inputPath,</span><br><span class="line">    [string]$outputPath</span><br><span class="line">)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 Word 应用程序对象</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">word = New-Object -ComObject Word.Application</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打开已有的 Word 文档</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">doc = <span class="variable">$word</span>.Documents.Open(<span class="variable">$inputPath</span>)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">另存为新的文件</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">doc.SaveAs([ref]<span class="variable">$outputPath</span>)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭文档并退出 Word</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">doc.Close()</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">word.Quit()</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mac版wps兼容性问题-2"><ul><li>简单封装一个接口，<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, send_file</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传目录和处理后的文件目录</span></span><br><span class="line">UPLOAD_FOLDER = <span class="string">&quot;uploads&quot;</span></span><br><span class="line">OUTPUT_FOLDER = <span class="string">&quot;outputs&quot;</span></span><br><span class="line">os.makedirs(UPLOAD_FOLDER, exist_ok=<span class="literal">True</span>)</span><br><span class="line">os.makedirs(OUTPUT_FOLDER, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/convert&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert</span>():</span><br><span class="line">    <span class="comment"># 接收上传的文件</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;No file uploaded&quot;</span>&#125;, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    uploaded_file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> uploaded_file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;No file selected&quot;</span>&#125;, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存上传的文件</span></span><br><span class="line">    input_path = os.path.join(UPLOAD_FOLDER, uploaded_file.filename)</span><br><span class="line">    uploaded_file.save(input_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成输出路径</span></span><br><span class="line">    output_path = os.path.join(OUTPUT_FOLDER, <span class="string">f&quot;converted_<span class="subst">&#123;uploaded_file.filename&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调用 PowerShell 脚本进行处理</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        subprocess.run([</span><br><span class="line">            <span class="string">&quot;powershell&quot;</span>, <span class="string">&quot;-ExecutionPolicy&quot;</span>, <span class="string">&quot;Bypass&quot;</span>, <span class="string">&quot;-File&quot;</span>, <span class="string">&quot;save_as.ps1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-inputPath&quot;</span>, input_path,</span><br><span class="line">            <span class="string">&quot;-outputPath&quot;</span>, output_path</span><br><span class="line">        ], check=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;PowerShell script failed: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>&#125;, <span class="number">500</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回处理后的文件</span></span><br><span class="line">    <span class="keyword">return</span> send_file(output_path, as_attachment=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul></li><li><p>生成公式的方案就是上述内容，但是更繁琐的是将生成的公式插入到docx文档中的正确位置，以及行内公式的展示，本文就不介绍了。</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;业务背景&quot;&gt;&lt;a href=&quot;#业务背景&quot; class=&quot;headerlink&quot; title=&quot;业务背景&quot;&gt;&lt;/a&gt;业务背景&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;想在生成的文档中插入公式，丰富文档格式，提高专业度。但大模型输出的公式中，LaTeX 是最稳定的生成格式，但是也</summary>
      
    
    
    
    
    <category term=".NET" scheme="https://cyborg2077.github.io/tags/NET/"/>
    
  </entry>
  
  <entry>
    <title>FastAPI</title>
    <link href="https://cyborg2077.github.io/2024/12/12/FastAPI/"/>
    <id>https://cyborg2077.github.io/2024/12/12/FastAPI/</id>
    <published>2024-12-12T14:23:49.000Z</published>
    <updated>2024-12-15T05:08:10.065Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>FastAPI，一个用于构建API的现代、快速（高性能）的web框架。<br>FsastAPI是建立在<a href="https://www.starlette.io/">Starlette</a>和<a href="https://docs.pydantic.dev/latest/">Pydantic</a>的基础上的。</p><ul><li>Pydantic是一个基于Python类型提示来定义数据验证、序列化和文档的苦。</li><li>Starlette是一种轻量级的ASGI(Asynchronous Server Gateway Interface)框架/工具包，是构建高性能<code>Asyncio</code>服务的理性选择。<br>依赖：Python3.6及更高的版本。<ul><li>我选择使用FastAPI的理由是，这个框架还支持<code>WebSocket</code>，而Flask和Django不支持</li></ul></li></ul><h1 id="预备知识点"><a href="#预备知识点" class="headerlink" title="预备知识点"></a>预备知识点</h1><h2 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h2><ul><li><p>在这小节，我们来彻底弄清楚一下HTTP协议，带着下面这四个问题来看：</p><ol><li>什么是请求头，请求体、响应头，响应体</li><li>URL地址包括什么</li><li>GET请求和POST请求到底是什么，有什么区别</li><li>Content-Type是什么</li></ol></li><li><p>把这些彻底弄清楚之后，学习其他语言的Web框架就会容易很多</p></li></ul><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><ul><li><p>虽然上学时期都听腻了HTTP协议是<code>Hyper Text Transfer Protocol</code>（超文本传输协议）的缩写，是用于万维网（WWW：World Wide Web）服务器与本地浏览器之间传输超文本的传输协议。HTTP是一个属于应用层的面向对象的协议（为什么是应用层？建议回顾一下OSI七层模型或者TCP/IP四层模型）。<br><img src="https://s21.ax1x.com/2024/12/14/pAqAkMd.png" alt=""></p></li><li><p>TCP/IP四层模型</p></li></ul><div class="table-container"><table><thead><tr><th style="text-align:center">层级</th><th style="text-align:center">功能</th><th style="text-align:center">示例协议</th></tr></thead><tbody><tr><td style="text-align:center">应用层</td><td style="text-align:center">提供应用程序的接口，定义数据的语义。</td><td style="text-align:center">HTTP, FTP, SMTP, DNS</td></tr><tr><td style="text-align:center">传输层</td><td style="text-align:center">提供端到端通信的可靠性和数据流管理。</td><td style="text-align:center">TCP, UDP</td></tr><tr><td style="text-align:center">网络层</td><td style="text-align:center">负责路由和逻辑地址（IP 地址）的管理。</td><td style="text-align:center">IP, ICMP</td></tr><tr><td style="text-align:center">链路层</td><td style="text-align:center">处理数据帧的传输及硬件地址（MAC 地址）。</td><td style="text-align:center">Ethernet, Wi-Fi</td></tr></tbody></table></div><ul><li>OSI七层模型</li></ul><div class="table-container"><table><thead><tr><th style="text-align:center">层级</th><th style="text-align:center">功能</th><th style="text-align:center">示例协议</th></tr></thead><tbody><tr><td style="text-align:center">应用层</td><td style="text-align:center">提供应用程序接口，支持网络应用程序的通信。</td><td style="text-align:center">HTTP, FTP, SMTP, DNS, Telnet</td></tr><tr><td style="text-align:center">表示层</td><td style="text-align:center">负责数据的格式化、加密、解密及压缩处理。</td><td style="text-align:center">JPEG, GIF, SSL/TLS, ASCII</td></tr><tr><td style="text-align:center">会话层</td><td style="text-align:center">管理应用程序之间的会话，包括建立、管理和终止。</td><td style="text-align:center">NetBIOS, PPTP, RPC</td></tr><tr><td style="text-align:center">传输层</td><td style="text-align:center">提供端到端的通信，负责可靠性和数据流控制。</td><td style="text-align:center">TCP, UDP</td></tr><tr><td style="text-align:center">网络层</td><td style="text-align:center">负责路由和逻辑地址管理，实现跨网络通信。</td><td style="text-align:center">IP, ICMP, ARP, RIP, OSPF</td></tr><tr><td style="text-align:center">数据链路层</td><td style="text-align:center">处理数据帧的传输及物理地址（MAC地址）。</td><td style="text-align:center">Ethernet, PPP, Wi-Fi, Frame Relay</td></tr><tr><td style="text-align:center">物理层</td><td style="text-align:center">负责比特流的传输，定义硬件电气及机械特性。</td><td style="text-align:center">RS-232, DSL, ISDN, IEEE 802.11</td></tr></tbody></table></div><ul><li>由于其简捷、快速的方式，适用于分布式超媒体信息系统。它于1990年提出，经过几年的使用和发展，得到不断的完善和扩展，HTTP协议工作于客户端-服务端架构上。浏览器作为HTTP客户端，通过URL向HTTP服务端即Web服务器发送所有请求。Web服务器根据接收到的请求，向客户端发送响应信息。</li></ul><h3 id="HTTP协议特性"><a href="#HTTP协议特性" class="headerlink" title="HTTP协议特性"></a>HTTP协议特性</h3><h4 id="基于TCP-IP协议"><a href="#基于TCP-IP协议" class="headerlink" title="基于TCP/IP协议"></a>基于TCP/IP协议</h4><ol><li><p>什么是基于TCP/IP</p><ul><li><code>HTTP</code> 依赖于 <code>TCP</code> 协议 来传输数据：</li><li><code>TCP</code> 是传输层协议，提供可靠的、面向连接的通信。</li><li><code>HTTP</code> 的每个请求和响应（例如 <code>GET</code> 请求）都通过 <code>TCP</code> 连接发送。</li><li><code>TCP</code> 使用 <code>IP</code> 协议（网络层）来确定数据的目的地：</li><li><code>IP</code> 负责将数据包路由到目标主机。</li><li><code>TCP</code> 和 <code>IP</code> 协作完成数据的分发和传输。</li><li><code>IP</code> 数据包通过 链路层协议（如 <code>Ethernet</code> 或 <code>Wi-Fi</code>）在实际的物理网络中传输。</li></ul></li><li><p>具体的工作流程</p><ul><li>应用层（HTTP）：用户在浏览器中输入网址（如www.baidu.com），浏览器通过HTTP发起请求。HTTP构建请求数据，调用传输层。</li><li>传输层（TCP）：HTTP请求糖果TCP建立一个连接（例如TCP三次握手）。TCP将数据分割为小的“段”，保证这些段可靠的传输。</li><li>网络层（IP）：TCP将数据包封装为IP数据包，通过IP协议将数据包通过路由器发送到目标主机。</li><li>链路层（Ethernet）：IP数据包通过链路层协议（如Ethernet或Wi-Fi）发送到目标主机。</li><li>返回响应：目标服务器接受请求并通过相同的层次返回响应，直至用户浏览器完成解析。</li></ul></li><li><p>总结</p><ul><li>TCP 提供可靠的数据传输。</li><li>IP 负责数据路由。<ul><li>HTTP 构建在这些基础之上，专注于实现 Web 通信的语义（如请求、响应、状态码等）。</li></ul></li></ul></li></ol><h4 id="基于请求-响应模式"><a href="#基于请求-响应模式" class="headerlink" title="基于请求-响应模式"></a>基于请求-响应模式</h4><ul><li>HTTP协议规定，请求从客户端发出，最后服务器响应该请求并返回。换句话说，肯定是先从客户端开始建立通信的，服务端在没有接收到请求之前不会发送响应数据。<ul><li>请求和响应是HTTP协议的核心组成部分。</li><li>请求（Request）：客户端发送的请求数据，包括请求方法、URL、请求头、请求体等。</li><li>响应（Response）：服务器返回的响应数据，包括状态码、响应头、响应体等。</li></ul></li></ul><h4 id="无状态保存"><a href="#无状态保存" class="headerlink" title="无状态保存"></a>无状态保存</h4><ul><li><p>在HTTP协议中，每次发送一个新的请求时，服务器都会杀横撑一个对应的新响应。这种请求-响应模式的设计中，协议不会记录之前的任何请求或响应内容。设计成无状态的主要目的是简化协议的实现，减少服务器的资源占用，从而能够快速处理大量事务。这种特性极大地提高了协议的可伸缩性，使其能够支持高并发和复杂的互联网应用场景。</p></li><li><p>由于HTTP自身无法保存状态，因此需要借助其他技术（如Cookie和Session）来实现状态管理和数据持久化，从而满足实际应用中的需求。</p></li><li>补充说明：<ol><li>Cookie是一种由服务器生成并存储在客户端浏览器中的小型数据，用于保存用户状态信息。例如登录会话或偏好设置，当用户再次访问同一网站时，浏览器会携带相应的Cookie信息，从而使浏览器能够识别用户身份或恢复之前的会话状态。</li><li>Session是一种由服务器端维护的状态管理机制，通过在服务器端为每个用户创建唯一的会话标识符（Session ID），来保存用户的状态信息。与Cookie不同，Session ID通常存储在服务器端，而不是客户端。</li></ol></li></ul><h4 id="短连接"><a href="#短连接" class="headerlink" title="短连接"></a>短连接</h4><ul><li>HTTP1.0默认使用的是短连接。浏览器和服务器每进行一次HTTP操作，就建立一次连接，任务结束就中断连接。<ul><li>但是这种方式存在性能为问题，因为每次请求都需要进行三次握手、数据传输以及连接断开，这样会消耗额外的时间和资源。</li></ul></li><li>HTTP/1.1引入了长连接（即复用TCP连接）。在默认情况下，HTTP/1.1会保持连接打开，允许在同一TCP连接上发送多个请求和响应。<ul><li>Connection: keep-alive是HTTP/1.1中的一个请求/响应头，表示链接不关闭。但在实际使用中，HTTP/1.1的keep-alive连接默认会保持连接打开，即使没有显示指定keep-alive</li><li>长连接的优势在于减少了重复建立和关闭连接的开销，提升了性能。</li></ul></li><li>SSE和WebSocket<ul><li>上面说的<code>长连接</code>需要和SSE和WebSocket的<code>持久连接</code>区分一下。</li><li>SSE是基于HTTP协议的单向通信技术，通常用于服务器主动推送实时数据到客户端（如新闻推送、实时通知等）。SSE是一种持久的HTTP连接，服务器可以不断的向客户端发送数据。</li><li>WebSocket是一种更为灵活的双向通信协议(所以ws连接的url是<code>ws://</code>，而http连接的url是<code>http://</code>)，客户端和服务器通过WebSocket建立持久连接后，双方可以随时互相发送数据，这种连接比SSE延迟更低，且实时性更强。WebSocket是独立于HTTP的，但是最初的握手是通过HTTP协议完成的。</li></ul></li></ul><h3 id="HTTP请求协议与响应协议"><a href="#HTTP请求协议与响应协议" class="headerlink" title="HTTP请求协议与响应协议"></a>HTTP请求协议与响应协议</h3><p><img src="https://s21.ax1x.com/2024/12/14/pAqABQJ.png" alt=""></p><ul><li>HTTP协议包含有浏览器发送数据到服务器需要遵循的请求协议和服务器发送数据到浏览器需要遵循的请求协议。</li><li>用户HTTP协议交互的信息被称为HTTP报文。请求端（客户端）的HTTP报文被称为请求报文，响应端（服务器）的HTTP报文被称为响应报文。</li><li>HTTP报文本身是有多行数据构成的文字文本，每行数据都是以<code>\r\n</code>结尾。</li></ul><p><img src="https://s21.ax1x.com/2024/12/14/pAqA6dx.png" alt=""></p><ul><li>一个完整的URL包括：协议、ip、端口、路径、参数<ul><li>例如：<code>http://www.baidu.com:80/s?wd=python</code>，其中<code>http</code>是协议，<code>www.baidu.com</code>是ip，<code>443</code>是端口，<code>/s</code>是路径，<code>wd=python</code>是参数。</li><li>例如：<code>ws://localhost:8000/ws</code>，其中<code>ws</code>是协议，<code>localhost</code>是ip，<code>8000</code>是端口，<code>/ws</code>是路径。</li></ul></li><li>GET和POST请求的区别<ul><li>GET请求提交的数据会放在URL之后，以?分割URL和传输数据，参数之间以&amp;相连。而POST请求则是把提交的数据放在HTTP请求报文的请求体中。</li><li>GET提交的数据大小有限制（因为浏览器对URL的长度有限制），而POST请求则没有此限制。</li></ul></li></ul><h3 id="测试HTTP协议格式"><a href="#测试HTTP协议格式" class="headerlink" title="测试HTTP协议格式"></a>测试HTTP协议格式</h3><ul><li>在这里，我们通过手写一个原生的 <code>socket</code> 程序来测试 <code>HTTP</code> 协议格式。常见的 Web 框架其实都是基于 <code>socket</code> 实现的，只不过框架已经封装了大部分细节，我们只需按照框架规则编写代码即可。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">sock = socket.socket()</span><br><span class="line"></span><br><span class="line">sock.bind((<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9571</span>))</span><br><span class="line">sock.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, addr = sock.accept()</span><br><span class="line">    data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    decode_data = data.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;接收到客户端发送的请求信息：<span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    lines = decode_data.split(<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="built_in">print</span>(line)</span><br></pre></td></tr></table></figure><ul><li>当我们用浏览器访问<code>http://127.0.0.1:9571/</code>时，浏览器会发送一个GET请求，此时打印的结果是<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">接收到客户端发送的请求信息：b&#x27;GET / HTTP/1.1\r\nHost: localhost:9571\r\nConnection: keep-alive\r\nCache-Control: max-age=0\r\nsec-ch-ua: &quot;Google Chrome&quot;;v=&quot;131&quot;, &quot;Chromium&quot;;v=&quot;131&quot;, &quot;Not_A Brand&quot;;v=&quot;24&quot;\r\nsec-ch-ua-mobile: ?0\r\nsec-ch-ua-platform: &quot;Windows&quot;\r\nUpgrade-Insecure-Requests: 1\r\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36\r\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\r\nSec-Fetch-Site: none\r\nSec-Fetch-Mode: navigate\r\nSec-Fetch-User: ?1\r\nSec-Fetch-Dest: document\r\nAccept-Encoding: gzip, deflate, br, zstd\r\nAccept-Language: zh-CN,zh-TW;q=0.9,zh;q=0.8,en;q=0.7\r\nCookie: Hm_lvt_d54c3018e5f620d2cda0f5ca52ff80cb=1732428640,1734018506,1734100966,1734138834; HMACCOUNT=6EC0BD1C42ED9962; Hm_lpvt_d54c3018e5f620d2cda0f5ca52ff80cb=1734152185\r\n\r\n&#x27;</span><br><span class="line">====================</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: localhost:9571</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">sec-ch-ua: &quot;Google Chrome&quot;;v=&quot;131&quot;, &quot;Chromium&quot;;v=&quot;131&quot;, &quot;Not_A Brand&quot;;v=&quot;24&quot;</span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">sec-ch-ua-platform: &quot;Windows&quot;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Sec-Fetch-Site: none</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Accept-Encoding: gzip, deflate, br, zstd</span><br><span class="line">Accept-Language: zh-CN,zh-TW;q=0.9,zh;q=0.8,en;q=0.7</span><br><span class="line">Cookie: Hm_lvt_d54c3018e5f620d2cda0f5ca52ff80cb=1732428640,1734018506,1734100966,1734138834; HMACCOUNT=6EC0BD1C42ED9962; Hm_lpvt_d54c3018e5f620d2cda0f5ca52ff80cb=1734152185</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">====================</span><br></pre></td></tr></table></figure></li><li>分析结果：<ol><li>请求首行：如 GET / HTTP/1.1，表示请求方法是 GET，路径是 /，协议版本是 HTTP/1.1。</li><li>请求头：每行以 key: value 形式存在，例如 Host: localhost:9571 表示目标主机和端口。</li><li>空行：空行标识请求头结束。</li><li>请求体：如果有请求体，空行后会跟随内容，此处因无请求体而为空。</li></ol></li><li><p>在浏览器中没有显示任何内容的原因是：服务器未返回任何数据。即便返回数据，也必须严格按照 HTTP 协议格式。<br><img src="https://s21.ax1x.com/2024/12/14/pAqVbRS.png" alt=""></p></li><li><p>那我们现在来修改一下代码，使其有响应数据。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import socket</span><br><span class="line"></span><br><span class="line">sock = socket.socket()</span><br><span class="line"></span><br><span class="line">sock.bind((&quot;127.0.0.1&quot;, 9571))</span><br><span class="line">sock.listen(5)</span><br><span class="line">while True:</span><br><span class="line">    conn, addr = sock.accept()</span><br><span class="line">    data = conn.recv(1024)</span><br><span class="line">    decode_data = data.decode(&#x27;utf-8&#x27;)</span><br><span class="line">    print(f&quot;接收到客户端发送的请求信息：&#123;data&#125;&quot;)</span><br><span class="line">    lines = decode_data.split(&#x27;\r\n&#x27;)</span><br><span class="line">    print(&#x27;=&#x27; * 20)</span><br><span class="line">    for line in lines:</span><br><span class="line">        print(line)</span><br><span class="line">    print(&#x27;=&#x27; * 20)</span><br><span class="line"></span><br><span class="line">    conn.send(b&#x27;HTTP/1.1 200 OK\r\n\r\nHello World&#x27;)</span><br></pre></td></tr></table></figure></li><li>浏览器收到响应后，正常显示 Hello World，因为我们遵循了 HTTP 协议格式，返回了以下内容：<ol><li>响应首行：HTTP/1.1 200 OK，表示状态码为 200，状态为 OK。</li><li>空行：标识响应头结束。</li><li>响应体：Hello World。<br><img src="https://s21.ax1x.com/2024/12/14/pAqeu0s.png" alt=""></li></ol></li></ul><h3 id="测试Content-Type"><a href="#测试Content-Type" class="headerlink" title="测试Content-Type"></a>测试Content-Type</h3><ul><li>在响应体中我们可以返回各种数据，但是浏览器怎么知道返回的数据是什么类型的呢？这就需要用到<code>Content-Type</code>。</li><li><code>Content-Type</code>是HTTP协议中用于描述响应体数据类型的头部字段。例如：<ul><li><code>Content-Type: text/html</code>，表示响应体是HTML格式的数据。</li><li><code>Content-Type: application/json</code>，表示响应体是JSON格式的数据。</li><li><code>Content-Type: text/plain</code>，表示响应体是纯文本格式的数据。</li><li><code>Content-Type: image/jpeg</code>，表示响应体是JPEG格式的图片。</li><li><code>Content-Type: application/octet-stream</code>，表示响应体是二进制流数据。</li></ul></li></ul><h4 id="请求时的Content-Type"><a href="#请求时的Content-Type" class="headerlink" title="请求时的Content-Type"></a>请求时的Content-Type</h4><ul><li>以下是用 Apifox 工具分别发送不同类型请求时的表现：<ol><li>GET 请求<ul><li>示例 URL：<a href="http://localhost:9571?name=kyle&amp;age=21">http://localhost:9571?name=kyle&amp;age=21</a></li><li>参数放在请求首行：<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">接收到客户端发送的请求信息：b&#x27;GET /?name=kyle&amp;age=21 HTTP/1.1\r\nUser-Agent: Apifox/1.0.0 (https://apifox.com)\r\nAccept: */*\r\nHost: localhost:9571\r\nAccept-Encoding: gzip, deflate, br\r\nConnection: keep-alive\r\n\r\n&#x27;</span><br><span class="line">====================</span><br><span class="line">GET /?name=kyle&amp;age=21 HTTP/1.1</span><br><span class="line">User-Agent: Apifox/1.0.0 (https://apifox.com)</span><br><span class="line">Accept: */*</span><br><span class="line">Host: localhost:9571</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">====================</span><br></pre></td></tr></table></figure></li></ul></li><li>POST 请求（application/x-www-form-urlencoded）<ul><li>参数以 key=value 格式放在请求体中：<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">接收到客户端发送的请求信息：b&#x27;POST / HTTP/1.1\r\nUser-Agent: Apifox/1.0.0 (https://apifox.com)\r\nAccept: */*\r\nHost: localhost:9571\r\nAccept-Encoding: gzip, deflate, br\r\nConnection: keep-alive\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 16\r\n\r\nname=kyle&amp;age=21&#x27;</span><br><span class="line">====================</span><br><span class="line">POST / HTTP/1.1</span><br><span class="line">User-Agent: Apifox/1.0.0 (https://apifox.com)</span><br><span class="line">Accept: */*</span><br><span class="line">Host: localhost:9571</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 16</span><br><span class="line"></span><br><span class="line">name=kyle&amp;age=21</span><br><span class="line">====================</span><br></pre></td></tr></table></figure></li></ul></li><li>POST 请求（application/json）<ul><li>参数为 JSON 格式：<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">接收到客户端发送的请求信息：b&#x27;POST / HTTP/1.1\r\nUser-Agent: Apifox/1.0.0 (https://apifox.com)\r\nContent-Type: application/json\r\nAccept: */*\r\nHost: localhost:9571\r\nAccept-Encoding: gzip, deflate, br\r\nConnection: keep-alive\r\nContent-Length: 27\r\n\r\n&#123;&quot;name&quot;: &quot;kyle&quot;, &quot;age&quot;: 21&#125;&#x27;</span><br><span class="line">====================</span><br><span class="line">POST / HTTP/1.1</span><br><span class="line">User-Agent: Apifox/1.0.0 (https://apifox.com)</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: */*</span><br><span class="line">Host: localhost:9571</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 27</span><br><span class="line"></span><br><span class="line">&#123;&quot;name&quot;: &quot;kyle&quot;, &quot;age&quot;: 21&#125;</span><br><span class="line">====================</span><br></pre></td></tr></table></figure></li></ul></li></ol></li></ul><h4 id="响应时的Content-Type"><a href="#响应时的Content-Type" class="headerlink" title="响应时的Content-Type"></a>响应时的Content-Type</h4><ul><li>如果服务器返回的 Content-Type 不正确，浏览器可能无法正确解析响应体。例如：<ol><li>错误的 Content-Type，以下代码返回了 HTML 内容，但设置了 Content-Type: text/plain：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conn.send(<span class="string">b&#x27;HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\n\r\n&lt;h1&gt;Hello World&lt;/h1&gt;&#x27;</span>)</span><br></pre></td></tr></table></figure>浏览器中惠当做纯文本显示<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;Hello World&lt;/h1&gt;</span><br></pre></td></tr></table></figure></li><li>正确的 <code>Content-Type</code>，将 <code>Content-Type</code> 改为 <code>text/html</code>：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conn.send(<span class="string">b&#x27;HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n&lt;h1&gt;Hello World&lt;/h1&gt;&#x27;</span>)</span><br></pre></td></tr></table></figure>浏览器中会正确显示 HTML 内容：<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello World</span><br></pre></td></tr></table></figure></li></ol></li></ul><h1 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h1><ul><li>安装fastapi和uvicorn库<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install fastapi</span><br><span class="line">pip install uvicorn</span><br></pre></td></tr></table></figure></li><li>创建一个main.py文件，并编写以下代码：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">first_api</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&#x27;main:app&#x27;</span>, host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">9421</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li><li>fastapi还内置了Swagger UI，可以通过<a href="http://127.0.0.1:9421/docs">http://127.0.0.1:9421/docs</a> 访问。<br><img src="https://s21.ax1x.com/2024/12/14/pAq8lqK.png" alt=""></li></ul><h1 id="路径操作"><a href="#路径操作" class="headerlink" title="路径操作"></a>路径操作</h1><ul><li>fastapi支持各种请求方式，但是实际使用中，建议只使用get和post方式。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.get()</span></span><br><span class="line"><span class="meta">@app.post()</span></span><br><span class="line"><span class="meta">@app.put()</span></span><br><span class="line"><span class="meta">@app.patch()</span></span><br><span class="line"><span class="meta">@app.delete()</span></span><br><span class="line"><span class="meta">@app.options()</span></span><br><span class="line"><span class="meta">@app.head()</span></span><br><span class="line"><span class="meta">@app.trace()</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="路径操作做装饰器参数"><a href="#路径操作做装饰器参数" class="headerlink" title="路径操作做装饰器参数"></a>路径操作做装饰器参数</h2><ul><li>这部分和Java里的Swagger注解类似，可以用来描述API的元数据。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> starlette <span class="keyword">import</span> status</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>,  <span class="comment"># 路径模板</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    response_model=Item,  <span class="comment"># 响应模型</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    status_code=status.HTTP_201_CREATED,  <span class="comment"># 创建成功的状态码</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    tags=[<span class="string">&quot;Items&quot;</span>],  <span class="comment"># 分类标签</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    summary=<span class="string">&quot;创建一个新的项目&quot;</span>,  <span class="comment"># 简短摘要</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    description=<span class="string">&quot;根据提供的信息创建一个新的项目实例。&quot;</span>,  <span class="comment"># 详细描述</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    response_description=<span class="string">&quot;新创建的项目的详细信息。&quot;</span>  <span class="comment"># 响应描述</span></span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">first_api</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&#x27;main:app&#x27;</span>, host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">9421</span>, reload=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>效果如下：<br><img src="https://s21.ax1x.com/2024/12/14/pAqGkQI.png" alt=""></li></ul><h2 id="路由分发include-router"><a href="#路由分发include-router" class="headerlink" title="路由分发include_router"></a>路由分发include_router</h2><ul><li>在实际开发中，我们可能需要将不同的功能模块拆分到不同的文件中，此时就需要用到路由分发。</li><li>路由分发需要使用<code>include_router</code>方法，该方法接收一个<code>APIRouter</code>对象，并将其添加到FastAPI应用中。<div class="tabs" id="路由分发"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#路由分发-1">order_route</button></li><li class="tab"><button type="button" data-href="#路由分发-2">user_route</button></li><li class="tab"><button type="button" data-href="#路由分发-3">main.py</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="路由分发-1"><ul><li>定义订单相关的路由<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"></span><br><span class="line">order_route = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@order_route.get(<span class="params"><span class="string">&#x27;/get_order_info&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_order_info</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;order_id&#x27;</span>: <span class="number">123</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="路由分发-2"><p>定义用户相关的路由<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"></span><br><span class="line">user_route = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_route.get(<span class="params"><span class="string">&#x27;/get_user_info&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_info</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: <span class="number">123</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;Lucy&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="路由分发-3"><ul><li>在main.py中引入路由分发，其中<code>prefix</code>参数用于指定路由的前缀，<code>tags</code>参数用于指定路由的标签，将在Swagger UI中显示。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> order.order_service <span class="keyword">import</span> order_route</span><br><span class="line"><span class="keyword">from</span> user.user_service <span class="keyword">import</span> user_route</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">app.include_router(user_route, prefix=<span class="string">&#x27;/user&#x27;</span>, tags=[<span class="string">&#x27;用户相关接口&#x27;</span>])</span><br><span class="line">app.include_router(order_route, prefix=<span class="string">&#x27;/order&#x27;</span>, tags=[<span class="string">&#x27;订单相关接口&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&#x27;main:app&#x27;</span>, host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">9421</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li><li><p>其中目录结构如图<br><img src="https://s21.ax1x.com/2024/12/14/pAqGrOx.png" alt=""></p></li><li><p>效果如下：<br><img src="https://s21.ax1x.com/2024/12/14/pAqGBlR.png" alt=""></p></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul><h1 id="请求与响应"><a href="#请求与响应" class="headerlink" title="请求与响应"></a>请求与响应</h1><h2 id="路径参数"><a href="#路径参数" class="headerlink" title="路径参数"></a>路径参数</h2><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><ul><li>路径参数是指在URL中定义的参数，例如：<code>/get_user_info/&#123;user_id&#125;</code>，其中<code>&#123;user_id&#125;</code>就是路径参数，同时路径参数会作为函数的参数传入。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"></span><br><span class="line">user_route = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_route.get(<span class="params"><span class="string">&#x27;/get_user_info/&#123;user_id&#125;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_info</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;Lucy&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li>当我们访问<code>http://127.0.0.1:9421/get_user_info/123</code>时，会返回<code>&#123;&#39;user_id&#39;: 123, &#39;username&#39;: &#39;Lucy&#39;&#125;</code>。</li></ul><h3 id="类型注解"><a href="#类型注解" class="headerlink" title="类型注解"></a>类型注解</h3><ul><li>在刚刚的代码中，路径参数user_id没有指定类型注解，所以甚至可以传入字符串作为参数。当我们访问<code>http://127.0.0.1:9421/user/get_user_info/qwe</code>时，会返回<code>&#123;&#39;user_id&#39;: &#39;qwe&#39;, &#39;username&#39;: &#39;Lucy&#39;&#125;</code>。</li><li>在实际开发中，我们大部分情况想回希望路径参数的类型是固定的，所以需要指定类型注解，例如：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"></span><br><span class="line">user_route = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_route.get(<span class="params"><span class="string">&#x27;/get_user_info/&#123;user_id&#125;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_info</span>(<span class="params">user_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;Lucy&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li>此时当我们访问<code>http://127.0.0.1:9421/user/get_user_info/qwe</code>时，就会报错<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int_parsing&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;path&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;user_id&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Input should be a valid integer, unable to parse string as an integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qwe&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="查询参数（Query-Parameters）"><a href="#查询参数（Query-Parameters）" class="headerlink" title="查询参数（Query Parameters）"></a>查询参数（Query Parameters）</h2><ul><li>查询参数是指在URL中定义的参数，例如：<code>/get_user_info?user_id=123</code>，其中<code>user_id</code>就是查询参数，同时查询参数会作为函数的参数传入。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"></span><br><span class="line">user_route = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_route.get(<span class="params"><span class="string">&#x27;/get_user_info&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_info</span>(<span class="params">user_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;Lucy&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>当我们访问<code>http://127.0.0.1:9421/user/get_user_info?user_id=123</code>时，会返回<code>&#123;&#39;user_id&#39;: 123, &#39;username&#39;: &#39;Lucy&#39;&#125;</code>。</p></li><li><p>自python3.5开始，PEP484引入了类型注解（Type Hints），用于在函数参数和返回值中指定类型。作用主要有：</p><ul><li>提高代码的可读性和可维护性。</li><li>在运行时进行类型检查，避免运行时错误。</li><li>在IDE中提供代码补全和错误检查功能。</li><li>在静态类型检查工具中进行类型检查，避免运行时错误。</li><li>在代码文档中提供类型信息，方便其他开发者理解代码。<br><code>Union</code>是当参数类型不确定时，可以使用<code>Union</code>类型注解，例如：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_info</span>(<span class="params">user_id: <span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>]</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;Lucy&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><code>Optional</code>是<code>Union</code>的一个简化，表示参数可以是<code>None</code>或指定类型，不需要显示的指定<code>None</code>。<code>Optional[int]</code>相当于<code>Union[int, None]</code>。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_info</span>(<span class="params">user_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;Lucy&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="请求体数据"><a href="#请求体数据" class="headerlink" title="请求体数据"></a>请求体数据</h2><ul><li>当你需要将数据从客户端发送给服务器时，就需要使用请求体数据。</li><li>FastAPI基于<code>pydantic</code>库，而<code>pydantic</code>库主要用来做类型强制检查，对于API服务，支持类型检查非常有用，会让服务更加健壮，也会加快开发速度，因为不用随时随地都要检查一下数据类型是否符合业务需求。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">user_route = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Addr</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    city: <span class="built_in">str</span> = <span class="literal">None</span></span><br><span class="line">    street: <span class="built_in">str</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = <span class="literal">None</span></span><br><span class="line">    age: <span class="built_in">int</span> = <span class="literal">None</span></span><br><span class="line">    birth: <span class="type">Optional</span>[date] = <span class="literal">None</span></span><br><span class="line">    friends: <span class="type">List</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span><br><span class="line">    addr: Addr = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Data</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    user_list: <span class="type">List</span>[User] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_route.post(<span class="params"><span class="string">&#x27;/get_user_info&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_info</span>(<span class="params">data: Data</span>):</span><br><span class="line">    <span class="keyword">return</span> data.user_list</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>POST方式请求url：<code>http://127.0.0.1:9421/user/get_user_info</code>，请求体数据：<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user_list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;birth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1994-05-20&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;friends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">2</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;addr&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alicetown&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tea Party Lane&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;David&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;birth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1984-01-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;friends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">1</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;addr&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Davidsville&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Invisible Cloak Road&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li>返回结果：<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;birth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1994-05-20&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;friends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">2</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;addr&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alicetown&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tea Party Lane&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;David&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;birth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1984-01-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;friends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">1</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;addr&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Davidsville&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Invisible Cloak Road&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h3><ul><li>在<code>Pydantic</code>中，<code>Field</code>方法还可以指定额外的验证规则和默认值，例如<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = <span class="literal">None</span>,</span><br><span class="line">    age: <span class="built_in">int</span> = Field(default=<span class="number">0</span>, gt=<span class="number">0</span>, lt=<span class="number">100</span>),</span><br><span class="line">    birth: <span class="type">Optional</span>[date] = <span class="literal">None</span>,</span><br><span class="line">    friends: <span class="type">List</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span><br><span class="line">    addr: Addr = <span class="literal">None</span></span><br></pre></td></tr></table></figure></li><li>关于 <code>Field</code> 中的参数： <ol><li><code>default=0</code>: 设置了 <code>age</code> 字段的默认值为 0。如果创建 <code>User</code> 实例时没有提供 <code>age</code> 的值，则它将被设置为 0。</li><li><code>lt=100</code>: <code>lt</code> 表示 <code>less than</code>（小于），这意味着 <code>age</code> 的值必须小于 100。</li><li><code>gt=0</code>: <code>gt</code> 表示 <code>greater than</code>（大于），这意味着 <code>age</code> 的值必须大于 0。</li></ol></li><li>当我们输出一个不符合范围的age时，就会报错<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;less_than&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;body&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;user_list&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Input should be less than 100&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ctx&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;lt&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;greater_than&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;body&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;user_list&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Input should be greater than 0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ctx&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;gt&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="自定义验证器"><a href="#自定义验证器" class="headerlink" title="自定义验证器"></a>自定义验证器</h3><ul><li><code>Pydantic</code>还支持自定义验证器来处理特定字段或者整个模型的数据验证，允许执行更复杂的逻辑检查，而不仅仅是简单的类型检查和范围限制。</li><li><code>Pydantic</code>提供了<code>@validator</code>装饰器和<code>@root_validator</code>装饰器来处理自定义验证逻辑。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = <span class="literal">None</span></span><br><span class="line">    age: <span class="built_in">int</span> = Field(default=<span class="number">0</span>, lt=<span class="number">100</span>, gt=<span class="number">0</span>)</span><br><span class="line">    birth: <span class="type">Optional</span>[date] = <span class="literal">None</span></span><br><span class="line">    friends: <span class="type">List</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span><br><span class="line">    addr: Addr = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @validator(<span class="params"><span class="string">&#x27;name&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_name</span>(<span class="params">cls, v</span>):</span><br><span class="line">        <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> v:  <span class="comment"># 检查是否为非空字符串</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> v[<span class="number">0</span>].isupper():  <span class="comment"># 正确的方法名</span></span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&#x27;姓名必须是大写字母开头&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> v</span><br></pre></td></tr></table></figure></li><li>当我们输出一个不符合条件的name时<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user_list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;birth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1994-05-20&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;friends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">2</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;addr&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alicetown&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tea Party Lane&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li>结果会报错<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value_error&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;body&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;user_list&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;name&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Value error, 姓名必须是大写字母开头&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ctx&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">感觉有必要系统性的学一遍</summary>
    
    
    
    
    <category term="Python" scheme="https://cyborg2077.github.io/tags/Python/"/>
    
    <category term="FastAPI" scheme="https://cyborg2077.github.io/tags/FastAPI/"/>
    
  </entry>
  
  <entry>
    <title>如何DIY一个QQ智能体</title>
    <link href="https://cyborg2077.github.io/2024/11/16/QQAgentDIY/"/>
    <id>https://cyborg2077.github.io/2024/11/16/QQAgentDIY/</id>
    <published>2024-11-16T12:42:30.000Z</published>
    <updated>2025-02-12T15:51:02.209Z</updated>
    
    <content type="html"><![CDATA[<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><ul><li>故事的起因是这样的，笨蛋楠楠不好好学习，每天到家就躺床上玩手机。需要我每天督促她。于是乎就想看一下QQ机器人相关技术，然后做个定时任务就好了，毕竟懒才是第一生产力，如果让我每天手动发的话，长此以往会累死的。</li></ul><h1 id="初步调研"><a href="#初步调研" class="headerlink" title="初步调研"></a>初步调研</h1><h2 id="go-cqhttp"><a href="#go-cqhttp" class="headerlink" title="go-cqhttp"></a>go-cqhttp</h2><div class="tag link"><a class="link-card" title="go-cqhttp" href="https://github.com/Mrs4s/go-cqhttp"><div class="left"><img src="https://github.githubassets.com/favicons/favicon.png"/></div><div class="right"><p class="text">go-cqhttp</p><p class="url">https://github.com/Mrs4s/go-cqhttp</p></div></a></div><blockquote><p>Mrs4s commented on Oct 10, 2023<br>由于QQ官方针对协议库的围追堵截 持续👊🐔 , 不断更新加密方案, 我们已无力继续维护此项目.<br>在未来 sign-server 方案彻底被官方封死之后 go-cqhttp 将无法继续使用.<br>同时NTQQ的出现让我们可以使用官方 完美 实现的协议实现来继续开发Bot, 不再担心由于协议实现不完美而导致被识别.<br>我们建议所有QQBot项目开始做好迁移至无头NTQQ或类似基于官方客户端技术的准备以应对未来的彻底封锁,<br>如果你的 go-cqhttp 还能继续使用, 不建议立即迁移, 但请开始阅读相关文档并做好迁移准备</p><p>推荐项目:<br><del>如果你想在电脑/服务器上部署bot -> https://chronocat.vercel.app/blog/0050</del><br><del>如果你想在Android 手机/模拟器上部署bot -> https://github.com/linxinrao/Shamrock</del><br><del>以上项目均为调用官方协议实现</del><br>以上项目均被请喝茶了，只能说有缘再见了.</p><p>相关问题可以在这个issue下讨论</p><p>协议库的时代已经过去, 接下来是Hook官方客户端的时代了, 感谢大家三年来的支持</p><del>其实go-cqhttp项目最初只是想做一个能在路由器上跑的酷Q</del><p>——————————————————————<br>什么是无头NTQQ?</p><p>众所周知, QQ官方最新推出的 NTQQ 客户端使用了 electron 技术, 该技术可以非常方便的跨平台同时使用前端已有的技术栈进行客户端开发.<br>NTQQ 客户端项目分为前后端两个部分, 前端是使用 Web 技术开发的 UI 界面供用户交互，后端使用 nodejs addons 技术包装了一个库来处理客户端逻辑和与服务端通信 (wrapper.node).<br>这个库的作用和 go-cqhttp 非常相似, 所以我们完全可以将前端删除只与这个库交互, 并引出 API 来为我们的Bot服务.<br>从服务端视角来说我们的 Bot 和正常客户端一样, 因为都是通过 wrapper.node 与服务端通信. 并且由于是官方根据内部文档开发的模块, 我们可以说这是一个 完美 的 go-cqhttp.</p><p>优点: 无头模式下相对低的占用.<br>缺点: 可能会受未来QQ更新的影响.</p><p>Shamrock项目是什么原理?</p><p>Shamrock 项目使用 xposed 的 hook 技术来实现远程操作 AndroidQQ 客户端.<br>优点: 不容易受未来更新封堵的影响.<br>缺点: 需要运行一个完整 AndroidOS 环境.</p><p>如果你的服务器资源足够充足, 我个人建议观望并跟进 Shamrock 项目. xposed 是久经考验且生态完善的技术.</p></blockquote><h2 id="mirai"><a href="#mirai" class="headerlink" title="mirai"></a>mirai</h2><div class="tag link"><a class="link-card" title="mirai" href="https://github.com/mamoe/mirai"><div class="left"><img src="https://github.githubassets.com/favicons/favicon.png"/></div><div class="right"><p class="text">mirai</p><p class="url">https://github.com/mamoe/mirai</p></div></a></div><ul><li>mirai 是一个在全平台下运行，提供 QQ Android 协议支持的高效率机器人库。</li><li>乍一看好像还没凉，遂尝试了一番，经过磕磕绊绊之后，虽说可以收发消息，但是相当不稳定，而且还有封号的风险<br><img src="https://s21.ax1x.com/2024/11/16/pA2XQoj.png" alt=""></li><li>一看论坛，也是风中残烛了，遂放弃。</li></ul><h2 id="R-I-P"><a href="#R-I-P" class="headerlink" title="R.I.P"></a>R.I.P</h2><ul><li>新时代已经没有能承载他们的船了</li></ul><h1 id="LLOneBot"><a href="#LLOneBot" class="headerlink" title="LLOneBot"></a>LLOneBot</h1><div class="tag link"><a class="link-card" title="LLOneBot" href="https://github.com/LLOneBot/LLOneBot"><div class="left"><img src="https://github.githubassets.com/favicons/favicon.png"/></div><div class="right"><p class="text">LLOneBot</p><p class="url">https://github.com/LLOneBot/LLOneBot</p></div></a></div><ul><li>由于在go-cqhttp中，作者提到了QQ最新退出的NTQQ客户端，而我很久之前就已经装过LiteLoaderQQNT这个插件了。那么肯定有基于这个新客户端开发的机器人技术吧，然后就找到了这个项目，真是相见恨晚啊，前面两个旧时代的残党我花了一个晚上捋清了来龙去脉，浪费了宝贵的8小时打游戏时间，下次我要更快更强。</li><li>装好插件配置好后，我们仅仅需要修改这几个地方</li></ul><p><img src="https://s21.ax1x.com/2024/11/17/pARPvAf.png" alt=""></p><h2 id="收发消息"><a href="#收发消息" class="headerlink" title="收发消息"></a>收发消息</h2><ul><li><p>这个是LLOneBot给出的收发消息的示例</p><div class="tabs" id="发送消息"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#发送消息-1">发送消息</button></li><li class="tab"><button type="button" data-href="#发送消息-2">接受消息</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="发送消息-1"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">request: Request</span>):</span><br><span class="line">    data = <span class="keyword">await</span> request.json()  <span class="comment"># 获取事件数据</span></span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    uvicorn.run(app, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure><ul><li>运行这个 Python 代码后，会在本地 8080 端口启动一个 HTTP 服务</li><li>当有事件发生时，LLOneBot 会向 <a href="http://localhost:8080/">http://localhost:8080/</a> 发送 POST JSON 请求，具体事件数据可以查看 事件</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="发送消息-2"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">requests.post(<span class="string">&#x27;http://localhost:3000/send_private_msg&#x27;</span>, json=&#123;</span><br><span class="line">    <span class="string">&#x27;user_id&#x27;</span>: <span class="number">123456</span>,</span><br><span class="line">    <span class="string">&#x27;message&#x27;</span>: [&#123;</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;text&#x27;</span>: <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>其中 send_private_msg 是 OneBot V11 的 发送私聊消息 API，具体 API 可以查看 API 文档</li><li>user_id 是 QQ 号，message 是消息内容</li><li>这里以文本消息格式为例，type 表示消息类型，type: text 表示文本消息，data 是消息内容，text 表示文本内容</li><li>更多的消息内容的格式可以查看 消息类型</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li><li><p>有了最最基础的收发消息的能力了，剩下的就好说了，接收楠楠的消息，判断其意图，如果是已经下班到家，那么向延迟队列中插入一条提醒学习的任务，2小时后触发即可。对于意图判断，可以接入大模型来实现，同时大模型也会给出更温馨的回答（岂可修，那楠楠到底是会更喜欢AI一点还是更喜欢我一点）。</p></li></ul><h2 id="接入大模型"><a href="#接入大模型" class="headerlink" title="接入大模型"></a>接入大模型</h2><ul><li>既然已经可以收发消息了，那么剩下的就是接入大模型API，温馨提醒一下楠楠该学习啦。<div class="tabs" id="代码实现"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#代码实现-1">main.py</button></li><li class="tab"><button type="button" data-href="#代码实现-2">models.py</button></li><li class="tab"><button type="button" data-href="#代码实现-3">logging_config.py</button></li><li class="tab"><button type="button" data-href="#代码实现-4">config.yaml</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="代码实现-1"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> Msg</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> logging_config <span class="keyword">import</span> setup_logging</span><br><span class="line"></span><br><span class="line">setup_logging()</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_config</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&quot;config.yaml&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        <span class="keyword">return</span> yaml.safe_load(file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_llm</span>(<span class="params">api_key</span>):</span><br><span class="line">    client = OpenAI(</span><br><span class="line">        api_key=api_key,</span><br><span class="line">        base_url=<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> client</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">config = load_config()</span><br><span class="line">llm = init_llm(api_key=config[<span class="string">&#x27;openai&#x27;</span>][<span class="string">&#x27;api_key&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">request: Request</span>):</span><br><span class="line">    data = <span class="keyword">await</span> request.json()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        msg_obj = Msg.parse_obj(data)</span><br><span class="line">        qq = msg_obj.user_id</span><br><span class="line">        logger.info(<span class="string">f&quot;QQ:<span class="subst">&#123;qq&#125;</span>，Nickname -- <span class="subst">&#123;msg_obj.sender.nickname&#125;</span>：<span class="subst">&#123;msg_obj.raw_message&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> qq == config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;qq&#x27;</span>]:</span><br><span class="line">            logger.info(<span class="string">&quot;Received a message from girl friend&quot;</span>)</span><br><span class="line">            answer = llm_answer(msg_obj.raw_message, llm, config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;system_prompt&#x27;</span>])</span><br><span class="line">            send_message(qq, answer)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        logger.error(<span class="string">f&quot;data parse error:<span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_answer</span>(<span class="params">question, client, prompt</span>):</span><br><span class="line">    completion = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;qwen-max&quot;</span>,</span><br><span class="line">        messages=[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;system&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;content&#x27;</span>: prompt</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;楠楠对你说：&#x27;</span> + question&#125;</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    content = completion.choices[<span class="number">0</span>].message.content</span><br><span class="line">    logging.info(<span class="string">f&#x27;LLM Response:<span class="subst">&#123;content&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_message</span>(<span class="params">qq, message</span>):</span><br><span class="line">    url = config[<span class="string">&#x27;send_msg_url&#x27;</span>]</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;user_id&quot;</span>: qq,</span><br><span class="line">        <span class="string">&quot;message&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;text&quot;</span>: message</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(url, data=json.dumps(data))</span><br><span class="line">    logger.info(<span class="string">f&quot;send message to <span class="subst">&#123;qq&#125;</span> result:<span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    uvicorn.run(app, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="代码实现-2"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sender</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    user_id: <span class="built_in">int</span></span><br><span class="line">    nickname: <span class="built_in">str</span></span><br><span class="line">    card: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageContent</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">str</span></span><br><span class="line">    data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Msg</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    self_id: <span class="built_in">int</span></span><br><span class="line">    user_id: <span class="built_in">int</span></span><br><span class="line">    time: <span class="built_in">int</span></span><br><span class="line">    message_id: <span class="built_in">int</span></span><br><span class="line">    real_id: <span class="built_in">int</span></span><br><span class="line">    message_seq: <span class="built_in">int</span></span><br><span class="line">    message_type: <span class="built_in">str</span></span><br><span class="line">    sender: Sender</span><br><span class="line">    raw_message: <span class="built_in">str</span></span><br><span class="line">    font: <span class="built_in">int</span></span><br><span class="line">    sub_type: <span class="built_in">str</span></span><br><span class="line">    message: <span class="type">List</span>[MessageContent]</span><br><span class="line">    message_format: <span class="built_in">str</span></span><br><span class="line">    post_type: <span class="built_in">str</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="代码实现-3"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging</span>():</span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        level=logging.INFO,</span><br><span class="line">        <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s - %(name)s - %(levelname)s - %(message)s&quot;</span>,</span><br><span class="line">        datefmt=<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>,</span><br><span class="line">        handlers=[</span><br><span class="line">            logging.FileHandler(<span class="string">&quot;app.log&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>),</span><br><span class="line">            logging.StreamHandler(),</span><br><span class="line">        ],</span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="代码实现-4"><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">send_msg_url:</span> <span class="string">http://localhost:3000/send_private_msg</span>        <span class="comment"># 发送消息的接口</span></span><br><span class="line"><span class="attr">openai:</span></span><br><span class="line">  <span class="attr">api_key:</span> <span class="string">YOUR_API_KEY</span>                                     <span class="comment"># 我这里接入的是阿里系的通义千问，提供对应的API_KEY即可</span></span><br><span class="line"></span><br><span class="line"><span class="attr">girl_friend:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">楠楠</span>                                                <span class="comment"># 设置称呼，可以让AI以这个称呼她</span></span><br><span class="line">  <span class="attr">qq:</span> <span class="string">XXX</span>                                                   <span class="comment"># 设置QQ号</span></span><br><span class="line">  <span class="attr">system_prompt:</span> <span class="string">YOUR_SYSTEM_PROMPT</span>                         <span class="comment"># 为智能体初始化的prompt</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul><h3 id="初步效果"><a href="#初步效果" class="headerlink" title="初步效果"></a>初步效果</h3><p><img src="https://s21.ax1x.com/2024/11/17/pARuo6K.png" alt=""></p><h2 id="延迟队列与-Function-Call-实现定时提醒"><a href="#延迟队列与-Function-Call-实现定时提醒" class="headerlink" title="延迟队列与 Function Call 实现定时提醒"></a>延迟队列与 Function Call 实现定时提醒</h2><ul><li>目标：期望的效果是，对它说一句话，例如“半小时后提醒我去洗澡”，希望能理解语义，并且在对应的时间后向目标发送消息。</li><li>那么在xx时间后向特定目标发送这个消息，可以用延迟队列来实现，等下我手写一个延迟队列出来就好了。</li><li>难点主要是在于，如何让大模型理解我的语意，来调用添加延迟队列任务的方法，这个可以用function call来实现。</li></ul><h3 id="手写一个延迟队列"><a href="#手写一个延迟队列" class="headerlink" title="手写一个延迟队列"></a>手写一个延迟队列</h3><ol><li><p>延迟队列的概念</p><ul><li>延迟队列是一种特殊的队列，它将任务按指定的延迟时间存储，任务在指定时间到达后才会被执行。例如，你可以设置一个任务，让它在一分钟后执行，而在这段时间内，它会处于等待状态。延迟队列常用于需要定时执行的任务，比如定时提醒、定时清理等。</li></ul></li><li><p>底层数据结构</p><ul><li>在实现延迟队列时，关键是如何高效地管理和调度任务。可以使用多种数据结构，常见的有：<ul><li>栈：不适合延迟队列，栈是后进先出，难以实现按时间顺序执行。</li><li>队列：队列适合按顺序执行任务，但如果任务的执行时间不同，队列无法高效地处理优先级。</li><li>堆：最合适的选择。堆，特别是最小堆，可以保证延迟时间最短的任务排在队列的最前面。</li></ul></li></ul></li><li>为什么选择堆？<ul><li>堆是一个完全二叉树，具有以下优点：<ol><li>最小堆：每个父节点的值都不大于其子节点的值。最小堆根节点存储的是当前队列中延迟时间最短的任务。</li><li>操作效率：插入和删除操作时间复杂度为O(log n)，因此堆非常适合用来高效地管理延迟队列。</li></ol></li></ul></li><li><p>如何实现？</p><ul><li>每个任务都会被分配一个延迟时间（即任务的执行时间）。</li><li>使用最小堆来存储这些任务，任务按延迟时间从小到大排列。</li><li>任务的执行顺序是从堆顶开始的，即最短延迟时间的任务最先执行。</li><li>示例：假设有三个任务，它们的延迟时间分别是 10 分钟、1 分钟和5 分钟。最小堆会保证 1 分钟的任务在最前面，接着是 5 分钟的任务，最后是 10 分钟的任务。</li></ul></li><li><p>工作原理</p><ul><li>任务加入队列：<ul><li>每次添加任务时，我们将任务与其延迟时间一同插入堆中。堆会自动将任务按延迟时间排序，使得最短延迟的任务始终位于堆顶。</li></ul></li><li>任务执行：<ul><li>使用一个循环持续监听堆顶任务的延迟时间。</li><li>每次循环检查堆顶任务的延迟时间是否到期（即当前时间是否超过任务的执行时间）。</li><li>如果任务未到期，程序就会休眠一段时间，再次检查。如果任务已经到期，则从堆中取出任务并执行。</li></ul></li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DelayQueue</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.queue = []</span><br><span class="line">        self.lock = threading.Lock()</span><br><span class="line">        self.condition = threading.Condition(self.lock)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_delay_task</span>(<span class="params">self, delay_msg, delay_time</span>):</span><br><span class="line">        execute_time = time.time() + delay_time</span><br><span class="line">        <span class="keyword">with</span> self.condition:</span><br><span class="line">            heapq.heappush(self.queue, (execute_time, delay_msg))</span><br><span class="line">            self.condition.notify()</span><br><span class="line">        logger.info(<span class="string">f&#x27;添加延迟队列任务: <span class="subst">&#123;delay_msg&#125;</span>, 将于 <span class="subst">&#123;delay_time&#125;</span> 秒后执行.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_task</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> self.condition:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">if</span> self.queue:</span><br><span class="line">                    execute_time, task = self.queue[<span class="number">0</span>]</span><br><span class="line">                    current_time = time.time()</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> current_time &gt;= execute_time:</span><br><span class="line">                        heapq.heappop(self.queue)</span><br><span class="line">                        <span class="keyword">return</span> task</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        self.condition.wait(timeout=execute_time - current_time)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.condition.wait()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_worker</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">worker</span>():</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    task = self.get_task()</span><br><span class="line">                    logger.info(</span><br><span class="line">                        <span class="string">f&#x27;Executing task: <span class="subst">&#123;task&#125;</span> at <span class="subst">&#123;time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, time.localtime())&#125;</span>&#x27;</span>)</span><br><span class="line">                    answer = llm_answer_delay_msg(task, [], llm, config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;system_prompt&#x27;</span>])</span><br><span class="line">                    send_message(config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;qq&#x27;</span>], answer, config[<span class="string">&#x27;send_msg_url&#x27;</span>])</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logger.error(<span class="string">f&quot;Worker encountered an error: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        threading.Thread(target=worker, daemon=<span class="literal">True</span>, name=<span class="string">&quot;DelayQueueWorker&quot;</span>).start()</span><br></pre></td></tr></table></figure><h3 id="Function-Call"><a href="#Function-Call" class="headerlink" title="Function Call"></a>Function Call</h3><ul><li><code>Function Call</code> 是一种机制，通过大语言模型来决定是否触发某些预定义的功能。与传统的 <code>API</code> 调用不同，<code>Function Call</code> 允许模型根据上下文和用户输入动态判断是否需要执行某些操作。</li><li>在本次应用中，<code>Function Call</code> 主要用于根据用户的自然语言输入，决定是否需要将任务添加到延迟队列中，并指定延迟的时间。</li></ul><div class="tabs" id="function-call"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#function-call-1">function_definitions</button></li><li class="tab"><button type="button" data-href="#function-call-2">routers</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="function-call-1"><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function_definitions = <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;add_delay_task&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;将任务添加到延迟队列。&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;delay_msg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;延迟任务的消息内容&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;delay_time&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;延迟时间，单位是秒&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;delay_msg&quot;</span><span class="punctuation">,</span> <span class="string">&quot;delay_time&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><ul><li>在这个示例中，我们定义了一个名为 add_delay_task 的函数，表示将任务添加到延迟队列。该函数有两个参数：<ul><li>delay_msg：任务的消息内容，类型为字符串。</li><li>delay_time：延迟的时间，单位为秒，类型为整数。</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="function-call-2"><ol><li><p>调用大语言模型进行消息处理</p><ul><li>我们将利用大语言模型来处理用户的输入消息，并判断是否需要调用 <code>add_delay_task</code> 函数。模型根据自然语言的上下文来决定是否调用延迟任务功能。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">response = LLM_CLIENT.chat.completions.create(</span><br><span class="line">    model=<span class="string">&quot;qwen-plus&quot;</span>,</span><br><span class="line">    messages=[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">&quot;你是一位智能助手，帮助解析自然语言任务并添加到延迟队列，仅仅当明确出现时间并且需要判断是否有需要提醒的意愿时，才需要调用。例如：‘十分钟后提醒我去洗澡’。&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">f&quot;女朋友说：<span class="subst">&#123;msg&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    functions=function_definitions,</span><br><span class="line">    function_call=<span class="string">&quot;auto&quot;</span>  <span class="comment"># 让模型决定是否调用功能</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li><li>其中<code>function_call=&quot;auto&quot;</code> 让模型自动判断是否需要调用功能，而不需要我们手动指定。</li></ul></li><li><p>处理模型响应结果</p><ul><li>当模型处理完用户消息后，它会返回一个 <code>response</code> 对象，其中包含了模型的回复以及是否需要调用某个函数。如果模型决定调用 <code>add_delay_task</code> 函数，它会在 <code>response</code> 中返回 <code>function_call</code>，包含了要调用的函数名和相应的参数。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> response.choices[<span class="number">0</span>].message.function_call:</span><br><span class="line">    func_name = response.choices[<span class="number">0</span>].message.function_call.name</span><br><span class="line">    arguments = json.loads(response.choices[<span class="number">0</span>].message.function_call.arguments)</span><br></pre></td></tr></table></figure></li></ul></li><li><p>解析并调用函数</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> func_name == <span class="string">&quot;add_delay_task&quot;</span>:</span><br><span class="line">    delay_queue.add_delay_task(**arguments)</span><br></pre></td></tr></table></figure></li><li><p>整体示例</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">request: Request</span>):</span><br><span class="line">    data = <span class="keyword">await</span> request.json()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        msg_obj = Msg.parse_obj(data)</span><br><span class="line">        qq = msg_obj.user_id</span><br><span class="line">        logger.info(<span class="string">f&quot;QQ:<span class="subst">&#123;qq&#125;</span>，Nickname -- <span class="subst">&#123;msg_obj.sender.nickname&#125;</span>：<span class="subst">&#123;msg_obj.raw_message&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> qq <span class="keyword">not</span> <span class="keyword">in</span> message_queue_cache:</span><br><span class="line">            message_queue_cache[qq] = deque(maxlen=MAX_QUEUE_SIZE)</span><br><span class="line">        <span class="keyword">if</span> qq == config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;qq&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> qq <span class="keyword">not</span> <span class="keyword">in</span> message_queue_cache:</span><br><span class="line">                message_queue_cache[qq] = deque(maxlen=MAX_QUEUE_SIZE)</span><br><span class="line">            msg = msg_obj.raw_message</span><br><span class="line">            message_queue_cache[qq].append(&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;message&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 调用大模型解析消息</span></span><br><span class="line">            response = LLM_CLIENT.chat.completions.create(</span><br><span class="line">                model=<span class="string">&quot;qwen-plus&quot;</span>,</span><br><span class="line">                messages=[</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;content&quot;</span>: <span class="string">&quot;你是一位智能助手，帮助解析自然语言任务并添加到延迟队列，仅仅当明确出现时间并且需要判断是否有需要提醒的意愿时，才需要调用。例如：‘十分钟后提醒我去洗澡’。&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;content&quot;</span>: <span class="string">f&quot;女朋友说：<span class="subst">&#123;msg&#125;</span>&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                functions=function_definitions,</span><br><span class="line">                function_call=<span class="string">&quot;auto&quot;</span>  <span class="comment"># 让模型决定是否调用功能</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果模型调用了 Function</span></span><br><span class="line">            <span class="keyword">if</span> response.choices[<span class="number">0</span>].message.function_call:</span><br><span class="line">                func_name = response.choices[<span class="number">0</span>].message.function_call.name</span><br><span class="line">                arguments = json.loads(response.choices[<span class="number">0</span>].message.function_call.arguments)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> func_name == <span class="string">&quot;add_delay_task&quot;</span>:</span><br><span class="line">                    <span class="comment"># 执行了 add_delay_task 方法</span></span><br><span class="line">                    delay_queue.add_delay_task(**arguments)</span><br><span class="line">                    <span class="comment"># 生成一个立即回复</span></span><br><span class="line">                    answer = llm_received_delay_msg(msg, <span class="built_in">list</span>(message_queue_cache[qq]), llm,</span><br><span class="line">                                        config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;system_prompt&#x27;</span>],</span><br><span class="line">                                        config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">                    message_queue_cache[qq].append(&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;llm&quot;</span>, <span class="string">&quot;message&quot;</span>: answer&#125;)</span><br><span class="line">                    send_message(qq, answer, config[<span class="string">&#x27;send_msg_url&#x27;</span>])</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">            <span class="comment"># 没有调用Function，生成普通回复</span></span><br><span class="line">            answer = llm_answer(msg, <span class="built_in">list</span>(message_queue_cache[qq]), llm,</span><br><span class="line">                                config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;system_prompt&#x27;</span>],</span><br><span class="line">                                config[<span class="string">&#x27;girl_friend&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">            message_queue_cache[qq].append(&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;llm&quot;</span>, <span class="string">&quot;message&quot;</span>: answer&#125;)</span><br><span class="line">            send_message(qq, answer, config[<span class="string">&#x27;send_msg_url&#x27;</span>])</span><br><span class="line">            logger.info(<span class="string">f&quot;Queue for <span class="subst">&#123;qq&#125;</span>: cache message:<span class="subst">&#123;<span class="built_in">list</span>(message_queue_cache[qq])&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;data parse error:<span class="subst">&#123;data&#125;</span>, error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        logger.error(<span class="string">f&quot;Stack trace: <span class="subst">&#123;traceback.format_exc()&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure></li></ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><ul><li>既然都看到这里了，不妨给这个项目点个Star吧，多谢！<div class="tag link"><a class="link-card" title="NanBot" href="https://github.com/Cyborg2077/NanBot"><div class="left"><img src="https://github.githubassets.com/favicons/favicon.png"/></div><div class="right"><p class="text">NanBot</p><p class="url">https://github.com/Cyborg2077/NanBot</p></div></a></div></li></ul>]]></content>
    
    
    <summary type="html">初衷其实是给楠楠做个每日提醒机器人的，结果越走越偏...</summary>
    
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="LLM" scheme="https://cyborg2077.github.io/tags/LLM/"/>
    
  </entry>
  
  <entry>
    <title>反编译jar包破解ASPOSE</title>
    <link href="https://cyborg2077.github.io/2024/10/10/CrackAsposeHTML/"/>
    <id>https://cyborg2077.github.io/2024/10/10/CrackAsposeHTML/</id>
    <published>2024-10-10T11:48:09.000Z</published>
    <updated>2025-02-16T12:56:21.154Z</updated>
    
    <content type="html"><![CDATA[<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ol><li>下载原始jar包：<a href="https://releases.aspose.com/html/java/22-8/">aspose-html-22.8-jdk11.jar</a></li><li>准备反编译工具，这里推荐使用<a href="https://github.com/java-decompiler/jd-gui/tags">jd-gui</a>或者<a href="https://github.com/skylot/jadx/tags">jadx</a>。</li></ol><h1 id="破解思路"><a href="#破解思路" class="headerlink" title="破解思路"></a>破解思路</h1><ul><li><p>Aspose 系列产品主要依赖许可证文件（license.xml）的注册来工作。首先，让我们看看 Aspose 是如何注册许可证的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">InputStream is;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    is = Files.newInputStream(Paths.get(<span class="string">&quot;C:\\xxx\\license.xml&quot;</span>));</span><br><span class="line">    <span class="type">License</span> <span class="variable">license</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">License</span>();</span><br><span class="line">    license.setLicense(is);</span><br><span class="line">    is.close();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>license.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">License</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Products</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Product</span>&gt;</span>Aspose.Total for Java<span class="tag">&lt;/<span class="name">Product</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Product</span>&gt;</span>Aspose.Words for Java<span class="tag">&lt;/<span class="name">Product</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Products</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">EditionType</span>&gt;</span>Enterprise<span class="tag">&lt;/<span class="name">EditionType</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SubscriptionExpiry</span>&gt;</span>20991231<span class="tag">&lt;/<span class="name">SubscriptionExpiry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">LicenseExpiry</span>&gt;</span>20991231<span class="tag">&lt;/<span class="name">LicenseExpiry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SerialNumber</span>&gt;</span>8bfe198c-7f0c-4ef8-8ff0-acc3237bf0d7<span class="tag">&lt;/<span class="name">SerialNumber</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Signature</span>&gt;</span></span><br><span class="line">        sNLLKGMUdF0r8O1kKilWAGdgfs2BvJb/2Xp8p5iuDVfZXmhppo+d0Ran1P9TKdjV4ABwAgKXxJ3jcQTqE/2IRfqwnPf8itN8aFZlV3TJPYeD3yWE7IT55Gz6EijUpC7aKeoohTb4w2fpox58wWoF3SNp6sK6jDfiAUGEHYJ9pjU=</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Signature</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">License</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>破解的思路很简单，就是查看 <code>setLicense</code> 方法中实际做了哪些操作，然后对源码进行修改。我们使用 <code>JD-GUI</code> 反编译 jar 包，找到 <code>License</code> 类，位于 <code>com.aspose.html</code> 包下。<br><img src="https://s21.ax1x.com/2024/10/10/pAJoM1s.png" alt=""></p></li><li><p>我们可以看到有两个 <code>setLicense</code> 方法，而代码中调用的是第二种形式。<br><img src="https://s21.ax1x.com/2024/10/10/pAJo3n0.png" alt=""></p></li><li><p>这里使用了传入的文件流，我们可以重点查看z16调用的m1方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">z16.m1(byteArrayInputStream);</span><br></pre></td></tr></table></figure></li><li>我们进入 z16 类，逐步查看里面的实现，找到一个可疑的方法。<br><img src="https://s21.ax1x.com/2024/10/13/pAYXhZ9.png" alt=""></li></ul><ul><li><p>在这段代码中，m1 方法的主要功能是验证许可文件的签名，以确保文件的合法性和未被篡改。</p><ol><li>获取许可类型：<ul><li>通过 switch 语句，根据许可的类型（如 “Professional” 或 “Enterprise”）进行区分，以确定许可文件的类型。</li></ul></li><li>处理节点数据： <ul><li>将传入的 XML Node 数据转化为字符串并以 UTF-16LE 编码转换为字节数组 (arrayOfByte1)。</li><li>从第二个节点 paramNode2 中提取 Base64 编码的签名，并将其解码为字节数组 (arrayOfByte2)。</li></ul></li><li>选择签名算法：<ul><li>根据许可文件的安全要求，选择使用 SHA1withRSA 或 SHA256withRSA 作为签名算法。如果系统启用了 FIPS 安全模式，则需要使用 FIPS 认证的提供程序 (m186)。</li></ul></li><li>公钥选择：<ul><li>arrayOfString1 和 arrayOfString2 数组中存储了多个可能的公钥或公钥片段，通过索引选择合适的公钥。</li><li>使用 m5 方法从字符串中生成公钥 (PublicKey)。</li></ul></li><li>签名验证：<ul><li>使用 initVerify 方法初始化公钥验证。</li><li>调用 update 方法传入已编码的数据字节数组 (arrayOfByte1)，然后使用 verify 方法验证 Base64 解码后的签名 (arrayOfByte2) 是否匹配。</li></ul></li><li>返回结果：<ul><li>验证成功后返回许可状态 paramz3，如果验证失败，则抛出异常并返回失败状态 (z3.m205)。</li></ul></li></ol></li><li><p>那么破解的思路非常简单：直接让这个方法返回 paramz3 就行了。</p></li></ul><h1 id="修改字节码文件"><a href="#修改字节码文件" class="headerlink" title="修改字节码文件"></a>修改字节码文件</h1><ul><li><p>接下来，我们使用 <code>Javassist</code> 修改字节码文件。首先添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.28.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>我们只需要需要修改 <code>z16</code> 类中的 <code>m1(Node node, Node node2, z3 z3Var)</code> 方法，让它直接返回 paramz3。修改的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">jarPath</span> <span class="operator">=</span> <span class="string">&quot;D:\\html\\aspose-html-22.8-jdk11.jar&quot;</span>;</span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    classPool.insertClassPath(jarPath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// z16类里的m1方法，同时三个参数类型分别是Node, Node, z3，这个z3我找了一下，是z16里的一个枚举类</span></span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.getCtClass(<span class="string">&quot;com.aspose.html.z16&quot;</span>);</span><br><span class="line">    CtClass[] paramTypes = <span class="keyword">new</span> <span class="title class_">CtClass</span>[<span class="number">3</span>];</span><br><span class="line">    paramTypes[<span class="number">0</span>] = classPool.get(<span class="string">&quot;org.w3c.dom.Node&quot;</span>);</span><br><span class="line">    paramTypes[<span class="number">1</span>] = classPool.get(<span class="string">&quot;org.w3c.dom.Node&quot;</span>);</span><br><span class="line">    paramTypes[<span class="number">2</span>] = classPool.get(<span class="string">&quot;com.aspose.html.z16$z3&quot;</span>);</span><br><span class="line">    <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;m1&quot;</span>, paramTypes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改方法体，使其直接返回第三个参数</span></span><br><span class="line">    ctMethod.setBody(<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    return $3;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ctClass.writeFile(<span class="string">&quot;D:\\html\\&quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;Modification completed successfully.&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>编译执行之后会生成一个.class文件，我们把这个.class文件替换到原来的jar包中，并且删除jar包中原本的.RSA和.SF文件，使用mvn install安装一下这个jar包就可以调用了。</p></li></ul><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li>ASPOSE.SLIDE、ASPOSE.WORDS等其他产品，破解思路基本都是一样的，都是看setLicense方法的实现，然后修改源码。</li><li>破解版的 jar 包可能存在后台向外部服务器发送数据的风险，因此本文仅限于学习研究，不涉及商业用途。请勿将其用于非法活动。<br><img src="https://s21.ax1x.com/2024/10/13/pAYXJ8f.png" alt=""></li></ul><h1 id="怎么偷偷用？"><a href="#怎么偷偷用？" class="headerlink" title="怎么偷偷用？"></a>怎么偷偷用？</h1><h2 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h2><h3 id="主要技术点"><a href="#主要技术点" class="headerlink" title="主要技术点"></a>主要技术点</h3><ol><li><p>参数化Java程序</p><ul><li>通过 main 方法接受参数，并规范参数顺序：<ul><li>args[0]：任务类型（如 report、summary）。</li><li>args[1]：统一业务参数（可为 JSON 等）。</li><li>args[2]：输出路径。</li><li>其余参数：不同任务类型独有的参数。</li></ul></li><li>运行时使用 java -jar xxx.jar args0 args1 args2 传递参数。</li><li>Java 程序只能有一个 main 方法，所有任务分发逻辑在 main 内实现。</li></ul></li><li><p>使用 Docker 进行环境隔离</p><ul><li>通过 Dockerfile` 创建独立的运行环境，确保所需的 Java 依赖完整可用。</li><li>运行时使用 <code>--network none</code> 选项断网，防止商业库进行外部联网验证。</li></ul></li><li>提供远程调用接口<ul><li>通过 <code>Python Flask</code> 创建 <code>HTTP API</code>，接收外部请求并执行 <code>Docker</code> 命令。</li><li>Java 代码通过 <code>OkHttpClient</code> 发送 <code>HTTP</code> 请求，实现远程文档生成任务。</li></ul></li></ol><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="Java代码"><a href="#Java代码" class="headerlink" title="Java代码"></a>Java代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocGenerateApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">            args[i] = args[i].replaceAll(<span class="string">&quot;\\r\\n|\\r|\\n&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        InputStream is;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            is = Files.newInputStream(Paths.get(<span class="string">&quot;/data/license.xml&quot;</span>));</span><br><span class="line">            <span class="type">License</span> <span class="variable">license</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">License</span>();</span><br><span class="line">            license.setLicense(is);</span><br><span class="line">            is.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// 读取文件内容</span></span><br><span class="line">        String base64Content;</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(type.equals(<span class="string">&quot;TransDoc&quot;</span>) || type.equals(<span class="string">&quot;TransDoc2PDF&quot;</span>))) &#123;</span><br><span class="line">            base64Content = <span class="keyword">new</span> <span class="title class_">String</span>(Files.readAllBytes(Paths.get(args[<span class="number">1</span>])), StandardCharsets.UTF_8);</span><br><span class="line">            <span class="type">byte</span>[] decodedBytes = Base64.getDecoder().decode(base64Content);</span><br><span class="line">            content = <span class="keyword">new</span> <span class="title class_">String</span>(decodedBytes, StandardCharsets.UTF_8);</span><br><span class="line">            System.out.println(<span class="string">&quot;base64转换：&quot;</span> + content);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">outputPath</span> <span class="operator">=</span> args[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;CareerPlan&quot;</span>:</span><br><span class="line">                CareerPlanUtils.generateCareerPlanReport(content, outputPath, args[<span class="number">3</span>]);</span><br><span class="line">                System.out.println(<span class="string">&quot;CareerPlan Success&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;CoursePaper&quot;</span>:</span><br><span class="line">                CoursePaperUtil.generateCoursePaper(content, outputPath, args[<span class="number">3</span>]);</span><br><span class="line">                System.out.println(<span class="string">&quot;CoursePaper Success&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;InternLog&quot;</span>:</span><br><span class="line">                InternLogUtils.generateInternLog(content, outputPath, args[<span class="number">3</span>], args[<span class="number">4</span>]);</span><br><span class="line">                System.out.println(<span class="string">&quot;InternLog Success&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                System.out.println(<span class="string">&quot;Unknown report type: &quot;</span> + type);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="核心命令"><a href="#核心命令" class="headerlink" title="核心命令"></a>核心命令</h3><ul><li>重点是<code>--network none</code>，随后在启动jar包的时候，传递自己需要的参数。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run --network none</span><br><span class="line">-e LANG = C.UTF - 8</span><br><span class="line">doc-generate-test java -jar /data/ppt.jar args0 args1 args2 args3 args4 ...</span><br></pre></td></tr></table></figure></li></ul><h3 id="Python代码"><a href="#Python代码" class="headerlink" title="Python代码"></a>Python代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="comment"># !/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line">LOG_PATH = <span class="string">&quot;aspose_proxy.log&quot;</span></span><br><span class="line"></span><br><span class="line">logger = logging.getLogger()  <span class="comment"># 不加名称设置root logger</span></span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line">formatter = logging.Formatter(</span><br><span class="line">    <span class="string">&#x27;%(asctime)s-%(levelname)s: %(message)s&#x27;</span>,</span><br><span class="line">    datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用FileHandler输出到文件</span></span><br><span class="line">fh = logging.FileHandler(LOG_PATH)</span><br><span class="line">fh.setLevel(logging.DEBUG)</span><br><span class="line">fh.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用StreamHandler输出到屏幕</span></span><br><span class="line">ch = logging.StreamHandler()</span><br><span class="line">ch.setLevel(logging.DEBUG)</span><br><span class="line">ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加两个Handler</span></span><br><span class="line">logger.addHandler(ch)</span><br><span class="line">logger.addHandler(fh)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/execute&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_command</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 从请求中获取参数</span></span><br><span class="line">        args = request.form.to_dict()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建命令行指令</span></span><br><span class="line">        cmd = [</span><br><span class="line">            <span class="string">&quot;docker&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;--network&quot;</span>, <span class="string">&quot;none&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-e&quot;</span>, <span class="string">&quot;LANG = C.UTF - 8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;doc-generate-test&quot;</span>, <span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/data/ppt.jar&quot;</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># cmd = [&quot;java&quot;, &quot;-jar&quot;, &quot;C:/WorkSpace/ppt/target/ppt-0.0.1-SNAPSHOT.jar&quot;]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 拼接参数</span></span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> args.values():</span><br><span class="line">            cmd.append(value)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 打印最终的命令行</span></span><br><span class="line">        logger.info(<span class="string">&quot;Executing command命令: &quot;</span> + <span class="string">&#x27; &#x27;</span>.join(cmd))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 启动进程</span></span><br><span class="line">        process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="literal">True</span>, encoding=<span class="string">&quot;UTF-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 读取输出</span></span><br><span class="line">        stdout, stderr = process.communicate()</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Command output: &quot;</span> + stdout)</span><br><span class="line">        logger.info(<span class="string">&quot;Command error: &quot;</span> + stderr)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;stdout.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">            fout.write(stdout)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;stderr.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">            fout.write(stderr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Command started&quot;</span>, <span class="string">&quot;pid&quot;</span>: process.pid, <span class="string">&quot;output&quot;</span>: stdout, <span class="string">&quot;error&quot;</span>: stderr&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">&quot;Exception:&quot;</span>, e)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8848</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><h3 id="调用代码"><a href="#调用代码" class="headerlink" title="调用代码"></a>调用代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendExecutorCMD</span><span class="params">(String ...args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8848/execute&quot;</span>;</span><br><span class="line">    MultipartBody.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultipartBody</span>.Builder().setType(MultipartBody.FORM);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;添加参数：&#123;&#125;&quot;</span>, args[i]);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> args[i].replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        builder.addFormDataPart(<span class="string">&quot;param&quot;</span> + (i + <span class="number">1</span>), s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span> builder.build();</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(url)</span><br><span class="line">            .post(requestBody)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> okHttpClient.newCall(request).execute();</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> response.body().string();</span><br><span class="line">    log.info(<span class="string">&quot;处理结果：&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">破解版本为aspose-html-22.8-jdk11.jar</summary>
    
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="逆向" scheme="https://cyborg2077.github.io/tags/%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>策略模式 + 函数式编程 简化代码</title>
    <link href="https://cyborg2077.github.io/2024/10/06/SimplifyCodeByTemplateMode/"/>
    <id>https://cyborg2077.github.io/2024/10/06/SimplifyCodeByTemplateMode/</id>
    <published>2024-10-06T05:03:58.000Z</published>
    <updated>2025-02-15T06:14:38.707Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>在软件开发中，往往会遇到多个功能模块存在重复的流程或逻辑，但它们的业务细节又有所不同。为避免代码冗余，提升代码的复用性和可维护性，设计模式等方法提供了很好的解决方案。通过识别和提取通用逻辑，开发者可以将相似的代码抽象为更加灵活和扩展性强的结构，适用于不同场景的需求。</li><li>本文将展示如何从重复的业务代码中提取共性，逐步优化并提升代码的可维护性与灵活性，最终形成一个更加通用、扩展性强的解决方案。</li><li>不必关心我这里的业务逻辑，仅仅关心模板的提取。</li></ul><h1 id="现状分析：重复代码的问题"><a href="#现状分析：重复代码的问题" class="headerlink" title="现状分析：重复代码的问题"></a>现状分析：重复代码的问题</h1><ul><li>在原有实现中，每个文档生成 API 都包含相同的文件下载处理逻辑，如下所示<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/generateReferenceReview&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateReferenceReview</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 这部分内容是文档的生成逻辑</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> orderConsumerService.generateReferenceReview(JSONObject.parseObject(json));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这部分内容是重复的</span></span><br><span class="line">    CommonUtil.setContentType(response, diskPath);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> +</span><br><span class="line">            java.net.URLEncoder.encode(FilenameUtils.getName(diskPath), <span class="string">&quot;UTF-8&quot;</span>).replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;%20&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">    FileUtils.copyFile(<span class="keyword">new</span> <span class="title class_">File</span>(diskPath), outputStream);</span><br><span class="line">    outputStream.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/generatePPT&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generatePPT</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> orderConsumerService.generatePPT(JSONObject.parseObject(json), orderId);</span><br><span class="line">    </span><br><span class="line">    CommonUtil.setContentType(response, diskPath);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> +</span><br><span class="line">            java.net.URLEncoder.encode(FilenameUtils.getName(diskPath), <span class="string">&quot;UTF-8&quot;</span>).replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;%20&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">    FileUtils.copyFile(<span class="keyword">new</span> <span class="title class_">File</span>(diskPath), outputStream);</span><br><span class="line">    outputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>即使抽取公共代码作为独立方法，依然会存在重复的逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/generateReferenceReview&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateReferenceReview</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> orderConsumerService.generateReferenceReview(JSONObject.parseObject(json));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 但是这里还是重复的，只不过变成了一行调用，治标不治本</span></span><br><span class="line">    handleFileResponse(response, diskPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/generatePPT&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generatePPT</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> orderConsumerService.generatePPT(JSONObject.parseObject(json), orderId);</span><br><span class="line">    handleFileResponse(response, diskPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleFileResponse</span><span class="params">(HttpServletResponse response, String diskPath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    CommonUtil.setContentType(response, diskPath);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> +</span><br><span class="line">            java.net.URLEncoder.encode(FilenameUtils.getName(diskPath), <span class="string">&quot;UTF-8&quot;</span>).replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;%20&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">    FileUtils.copyFile(<span class="keyword">new</span> <span class="title class_">File</span>(diskPath), outputStream);</span><br><span class="line">    outputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>存在的问题：</p><ol><li>代码重复：每个 API 都要写相同的文件下载逻辑，违反<code>DRY</code>（Don’t Repeat Yourself）原则。</li><li>扩展性差：如果需要修改文件下载方式，所有 API 代码都需要调整。</li><li>维护成本高：新增文档类型时，需要复制粘贴代码，容易出现不一致性问题。</li></ol></li></ul><h1 id="使用模板方法模式优化代码"><a href="#使用模板方法模式优化代码" class="headerlink" title="使用模板方法模式优化代码"></a>使用模板方法模式优化代码</h1><h2 id="什么是模板方法模式？"><a href="#什么是模板方法模式？" class="headerlink" title="什么是模板方法模式？"></a>什么是模板方法模式？</h2><ul><li>模板方法模式（Template Method Pattern）是一种行为设计模式，它定义一个算法的通用流程，并允许子类或外部方法提供具体实现。它的核心思想是将通用逻辑抽取到父类（或公共组件）中，让子类（或具体方法）实现可变部分。</li></ul><h2 id="代码优化：引入-DocGenerateExecutor"><a href="#代码优化：引入-DocGenerateExecutor" class="headerlink" title="代码优化：引入 DocGenerateExecutor"></a>代码优化：引入 DocGenerateExecutor</h2><ul><li>为了避免继承带来的复杂性，我采用了 <code>策略模式</code> + <code>函数式接口</code> 的方式，避免传统模板方法模式的局限性。核心思想是将文件下载逻辑封装到一个可复用的执行器 DocGenerateExecutor 中，并通过函数式接口让不同业务代码提供具体的文档生成逻辑。<ol><li>创建 DocGenerateExecutor 统一处理文档下载<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocGenerateExecutor</span> &#123;</span><br><span class="line">    <span class="comment">// 定义函数式接口，让外部提供具体文档生成逻辑</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DocGenerateFun</span> &#123;</span><br><span class="line">        String <span class="title function_">executor</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用的文档生成和下载逻辑</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateDoc</span><span class="params">(DocGenerateFun fun, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">diskPath</span> <span class="operator">=</span> fun.executor();</span><br><span class="line">        CommonUtil.setContentType(response, diskPath);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> +</span><br><span class="line">                java.net.URLEncoder.encode(FilenameUtils.getName(diskPath), <span class="string">&quot;UTF-8&quot;</span>).replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;%20&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        FileUtils.copyFile(<span class="keyword">new</span> <span class="title class_">File</span>(diskPath), outputStream);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>调用 DocGenerateExecutor 处理文档下载<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/generateOpenReport&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateOpenReport</span><span class="params">(String json, String orderId, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    docGenerateExecutor.generateDoc(() -&gt; orderConsumerService.generateOpenReport(JSONObject.parseObject(json), orderId), response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li></ul><h1 id="代码优化的效果与优势"><a href="#代码优化的效果与优势" class="headerlink" title="代码优化的效果与优势"></a>代码优化的效果与优势</h1><h2 id="优化后代码的优势"><a href="#优化后代码的优势" class="headerlink" title="优化后代码的优势"></a>优化后代码的优势</h2><div class="table-container"><table><thead><tr><th style="text-align:center">优化点</th><th style="text-align:center">传统实现</th><th style="text-align:center">优化后实现</th></tr></thead><tbody><tr><td style="text-align:center">代码复用性</td><td style="text-align:center">每个 API 复制相同的下载逻辑</td><td style="text-align:center">只需调用 DocGenerateExecutor</td></tr><tr><td style="text-align:center">扩展性</td><td style="text-align:center">需要修改多个 API 代码</td><td style="text-align:center">只需修改 DocGenerateExecutor</td></tr><tr><td style="text-align:center">可维护性</td><td style="text-align:center">代码冗余，容易引入 Bug</td><td style="text-align:center">代码简洁，降低维护成本</td></tr></tbody></table></div><h2 id="代码行数减少"><a href="#代码行数减少" class="headerlink" title="代码行数减少"></a>代码行数减少</h2><ol><li><p>传统代码需要在每个 API 里写一遍文件下载逻辑，而优化后只需调用 generateDoc()，减少了大量重复代码。</p></li><li><p>如果需要调整下载逻辑，比如支持流式下载、日志记录等，只需修改 DocGenerateExecutor 一处，所有 API 无需修改。</p></li></ol><h2 id="适配不同的文档生成逻辑"><a href="#适配不同的文档生成逻辑" class="headerlink" title="适配不同的文档生成逻辑"></a>适配不同的文档生成逻辑</h2><ol><li>只需要传入不同的 Lambda 表达式，即可适配不同的文档生成逻辑。</li><li><code>无须继承</code>，避免 Java 传统模板方法模式的<code>类爆炸</code>问题。</li></ol>]]></content>
    
    
    <summary type="html">基于模板方法模式的核心思想，但用 策略模式 + 函数式编程 进行优化</summary>
    
    
    
    <category term="设计模式" scheme="https://cyborg2077.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/tags/%E9%9A%8F%E5%86%99/"/>
    
    <category term="设计模式" scheme="https://cyborg2077.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>基于图的任务调度算法</title>
    <link href="https://cyborg2077.github.io/2024/08/17/GraphBasedTaskScheduling/"/>
    <id>https://cyborg2077.github.io/2024/08/17/GraphBasedTaskScheduling/</id>
    <published>2024-08-17T05:04:48.000Z</published>
    <updated>2024-10-06T06:24:54.294Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>本文的灵感来源于<div class="tag link"><a class="link-card" title="4.4 计算图的调度 —— 机器学习系统" href="https://openmlsys.github.io/chapter_computational_graph/schedule_of_computational_graph.html"><div class="left"><img src="https://openmlsys.github.io/_static/favicon.png"/></div><div class="right"><p class="text">4.4 计算图的调度 —— 机器学习系统</p><p class="url">https://openmlsys.github.io/chapter_computational_graph/schedule_of_computational_graph.html</p></div></a></div></li><li>基于该文中的任务调度思想，我设计并实现了一套基于图结构的任务调度器，主要应用于复杂系统中的任务管理与执行。</li><li>下文将详细介绍该调度器的设计理念、核心实现以及如何将任务依赖关系存储到数据库中，以提升系统的稳定性和可维护性。</li></ul><h1 id="任务调度策略简介"><a href="#任务调度策略简介" class="headerlink" title="任务调度策略简介"></a>任务调度策略简介</h1><ul><li>在传统的任务执行环境中，任务通常按序执行，依赖关系较为简单，因此可以采用线性执行的方式。但在复杂系统中，任务之间往往存在多层次的依赖关系，形成复杂的依赖链。如果没有合理的任务调度策略，系统容易出现瓶颈，资源也难以得到充分利用。因此，设计一个能够有效管理任务依赖关系的调度器至关重要，这不仅可以避免资源浪费，还能保证所有任务按计划顺利完成。</li><li>本文实现的任务调度逻辑基于有向无环图（DAG），将每个任务抽象为图中的节点，节点之间的边表示任务之间的依赖关系。通过这种方式，可以很好地建模复杂的任务依赖结构，提供了处理复杂调度场景的解决方案。</li></ul><h1 id="调度器的设计与实现"><a href="#调度器的设计与实现" class="headerlink" title="调度器的设计与实现"></a>调度器的设计与实现</h1><h2 id="线程池与异步执行"><a href="#线程池与异步执行" class="headerlink" title="线程池与异步执行"></a>线程池与异步执行</h2><ul><li>为了提升任务调度器的执行效率，采用了Java的线程池和异步操作来实现并发任务的执行<ul><li><code>线程池</code>：调度器通过<code>ExecutorService</code>创建了一个线程池，线程池的大小根据系统的处理器核心数量动态调整（根据自身业务需求调整）。确保任务能并行执行，从而最大限度利用系统资源，提升任务处理效率。</li><li><code>异步操作</code>：调度过程中，任务被提交到线程池中异步执行，使用Future对象管理每个任务的执行结果。当任务完成时，会自动更新依赖其的子任务状态，并将准备就绪的子任务加入队列，等待进一步处理。</li></ul></li><li>以下是任务调度器的核心实现代码：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTaskScheduler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里是根据我自身业务需求，自定义的任务执行器</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MyTaskExecutor myTaskExecutor;</span><br><span class="line">    <span class="comment">// 图结构，key是任务ID，value是其下属子任务</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;String&gt;&gt; graph = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 节点入度map，key是任务ID，value是节点的度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; inDegree = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 任务函数map，key是任务ID，value是该任务的执行函数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, TaskFunction&gt; taskFunctions = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 函数式接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TaskFunction</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(MyTaskExecutor myTaskExecutor)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加任务，需指定任务ID和任务执行函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTask</span><span class="params">(String taskId, TaskFunction taskFunction)</span> &#123;</span><br><span class="line">        <span class="comment">// 向图结构中加入任务节点</span></span><br><span class="line">        graph.putIfAbsent(taskId, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        <span class="comment">// 初始度为0，即没有依赖</span></span><br><span class="line">        inDegree.putIfAbsent(taskId, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 存储该任务的执行函数</span></span><br><span class="line">        taskFunctions.put(taskId, taskFunction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加依赖，taskId 任务依赖于 dependencyTaskId 任务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDependency</span><span class="params">(String taskId, String dependencyTaskId)</span> &#123;</span><br><span class="line">        graph.putIfAbsent(dependencyTaskId, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        graph.get(dependencyTaskId).add(taskId);</span><br><span class="line">        <span class="comment">// 增加子任务的入度</span></span><br><span class="line">        inDegree.put(taskId, inDegree.getOrDefault(taskId, <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除任务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTask</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        graph.remove(taskId);</span><br><span class="line">        inDegree.remove(taskId);</span><br><span class="line">        taskFunctions.remove(taskId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// BFS遍历</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTasksInOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        Queue&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 向队列中添加所有度为0的任务，这些任务无需依赖，可直接执行</span></span><br><span class="line">        <span class="keyword">for</span> (String task : inDegree.keySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (inDegree.get(task) == <span class="number">0</span>) &#123;</span><br><span class="line">                queue.add(task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 开个线程池，这里按需调整你的线程池大小</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 处理队列中的任务</span></span><br><span class="line">            <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">                List&lt;Future&lt;String&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> queue.size();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    <span class="comment">// 取出任务</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">task</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">                    Future&lt;String&gt; future = executorService.submit(() -&gt; &#123;</span><br><span class="line">                        <span class="comment">// 异步执行</span></span><br><span class="line">                        <span class="type">TaskFunction</span> <span class="variable">taskFunction</span> <span class="operator">=</span> taskFunctions.get(task);</span><br><span class="line">                        <span class="keyword">if</span> (taskFunction != <span class="literal">null</span>) &#123;</span><br><span class="line">                            taskFunction.execute(myTaskExecutor);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> task;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    futures.add(future);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 等待所有任务结束并处理依赖关系</span></span><br><span class="line">                <span class="keyword">for</span> (Future&lt;String&gt; future : futures) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 遍历所有已完成的任务</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">completedTask</span> <span class="operator">=</span> future.get();</span><br><span class="line">                        <span class="keyword">for</span> (String dependent : graph.get(completedTask)) &#123;</span><br><span class="line">                            <span class="comment">// 将依赖任务入度 -1</span></span><br><span class="line">                            inDegree.put(dependent, inDegree.get(dependent) - <span class="number">1</span>);</span><br><span class="line">                            <span class="comment">// 如果入度为0，添加到队列</span></span><br><span class="line">                            <span class="keyword">if</span> (inDegree.get(dependent) == <span class="number">0</span>) &#123;</span><br><span class="line">                                queue.add(dependent);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="自定义任务执行器"><a href="#自定义任务执行器" class="headerlink" title="自定义任务执行器"></a>自定义任务执行器</h2><ul><li>这里需要根据自身的业务需求，来自定义任务执行器。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTaskExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CreateTaskExecutor</span> &#123;</span><br><span class="line">        String <span class="title function_">executor</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoopTaskExecutor</span> &#123;</span><br><span class="line">        Wrapper&lt;ReportVO&gt; <span class="title function_">executor</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 暴露给任务调度器的函数，这里面写你自己的业务逻辑即可</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeAndMonitorTask</span><span class="params">(CreateTaskExecutor createTask, LoopTaskExecutor monitorTask, SubOrder subOrder, String taskName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        createTaskExecutor4SubOrder(createTask, subOrder, taskName);</span><br><span class="line">        loopTaskExecutor4SubOrder(monitorTask, subOrder, taskName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTaskExecutor4SubOrder</span><span class="params">(CreateTaskExecutor taskExecutor, SubOrder subOrder, String taskName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 执行创建任务逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loopTaskExecutor4SubOrder</span><span class="params">(LoopTaskExecutor taskExecutor, SubOrder subOrder, String taskName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 执行轮询任务逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="数据库存储依赖关系"><a href="#数据库存储依赖关系" class="headerlink" title="数据库存储依赖关系"></a>数据库存储依赖关系</h1><ul><li>在实际应用中，为了确保任务依赖关系在系统重启后不丢失，我们最好将依赖关系存储到数据库中。在这部分代码中，依赖关系和任务信息被持久化到数据库。通过这样的设计，当系统重新启动时，任务调度器可以从数据库中恢复任务状态，并继续执行未完成的任务。<div class="tabs" id="mytaskscheduler"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#mytaskscheduler-1">MyTaskScheduler</button></li><li class="tab"><button type="button" data-href="#mytaskscheduler-2">Tasks</button></li><li class="tab"><button type="button" data-href="#mytaskscheduler-3">TaskDependency</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="mytaskscheduler-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTaskScheduler</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TasksMapper tasksMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TaskDependencyMapper taskDependencyMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MyTaskExecutor myTaskExecutor;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubOrderMapper subOrderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, TaskFunction&gt; taskFunctionStrategies = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TaskFunction</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(MyTaskExecutor myTaskExecutor)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加任务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTask</span><span class="params">(String taskId, TaskFunction taskFunction)</span> &#123;</span><br><span class="line">        <span class="comment">// 检查任务是否已经存在</span></span><br><span class="line">        <span class="type">SubOrder</span> <span class="variable">existingSubOrder</span> <span class="operator">=</span> subOrderMapper.selectOne(Wrappers.lambdaQuery(SubOrder.class).eq(SubOrder::getOrderId, taskId));</span><br><span class="line">            <span class="keyword">if</span> (existingSubOrder != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (existingSubOrder.getStatus() == Common.ORDER_FINISH_STATUS) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;任务 &#123;&#125; 已存在，跳过添加。&quot;</span>, taskId);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (existingSubOrder.getStatus() != Common.ORDER_FINISH_STATUS) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;任务：&#123;&#125;，状态：&#123;&#125;，添加到调度系统&quot;</span>, taskId, existingSubOrder.getStatus());</span><br><span class="line">                existingSubOrder.setStatus(Common.ORDER_SUCCESS_PAY_STATUS);</span><br><span class="line">                subOrderMapper.updateById(existingSubOrder);</span><br><span class="line">                taskFunctionStrategies.put(taskId, taskFunction);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// 任务已存在，直接返回</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        taskFunctionStrategies.put(taskId, taskFunction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加节点依赖</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDependency</span><span class="params">(String taskId, String dependencyTaskId)</span> &#123;</span><br><span class="line">        <span class="comment">// 检查依赖是否已经存在</span></span><br><span class="line">        <span class="type">TaskDependency</span> <span class="variable">existingDependency</span> <span class="operator">=</span> taskDependencyMapper.selectOne(Wrappers.lambdaQuery(TaskDependency.class)</span><br><span class="line">                .eq(TaskDependency::getTaskId, taskId)</span><br><span class="line">                .eq(TaskDependency::getDependencyTaskId, dependencyTaskId));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (existingDependency != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;任务 &#123;&#125; 的依赖 &#123;&#125; 已存在，跳过添加。&quot;</span>, taskId, dependencyTaskId);</span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// 依赖已存在，直接返回</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 依赖不存在，添加新依赖</span></span><br><span class="line">        <span class="type">TaskDependency</span> <span class="variable">dependency</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskDependency</span>()</span><br><span class="line">                .setTaskId(taskId)</span><br><span class="line">                .setDependencyTaskId(dependencyTaskId)</span><br><span class="line">                .setCreateTime(LocalDateTime.now())</span><br><span class="line">                .setUpdateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        taskDependencyMapper.insert(dependency);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行任务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTasks</span><span class="params">(String rootTaskId)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        Queue&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (isRootTask(rootTaskId)) &#123;</span><br><span class="line">            queue.add(rootTaskId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;当前任务节点不是根节点：&#123;&#125;&quot;</span>, rootTaskId);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Root task ID is not valid or has dependencies.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">                List&lt;Future&lt;String&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> queue.size();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">task</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">                    Future&lt;String&gt; future = executorService.submit(() -&gt; &#123;</span><br><span class="line">                        <span class="type">TaskFunction</span> <span class="variable">taskFunction</span> <span class="operator">=</span> taskFunctionStrategies.get(task);</span><br><span class="line">                        <span class="keyword">if</span> (taskFunction != <span class="literal">null</span>) &#123;</span><br><span class="line">                            taskFunction.execute(myTaskExecutor);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> task;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    futures.add(future);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Future&lt;String&gt; future : futures) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">completedTask</span> <span class="operator">=</span> future.get();</span><br><span class="line">                    List&lt;String&gt; dependents = getDependentTasks(completedTask);</span><br><span class="line">                    <span class="keyword">for</span> (String dependent : dependents) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (allDependenciesMet(dependent)) &#123;</span><br><span class="line">                            queue.add(dependent);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isRootTask</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taskDependencyMapper.selectCount(Wrappers.lambdaQuery(TaskDependency.class)</span><br><span class="line">                .eq(TaskDependency::getTaskId, taskId)) == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; <span class="title function_">getDependentTasks</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taskDependencyMapper.selectList(Wrappers.lambdaQuery(TaskDependency.class)</span><br><span class="line">                        .eq(TaskDependency::getDependencyTaskId, taskId))</span><br><span class="line">                .stream().map(TaskDependency::getTaskId).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">allDependenciesMet</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        List&lt;String&gt; dependencyTaskIds = taskDependencyMapper.selectList(Wrappers.lambdaQuery(TaskDependency.class)</span><br><span class="line">                        .eq(TaskDependency::getTaskId, taskId))</span><br><span class="line">                .stream().map(TaskDependency::getDependencyTaskId).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; completedTaskIds = subOrderMapper.selectList(Wrappers.lambdaQuery(SubOrder.class)</span><br><span class="line">                        .eq(SubOrder::getStatus, Common.ORDER_FINISH_STATUS))</span><br><span class="line">                .stream().map(SubOrder::getOrderId).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dependencyTaskIds.stream().allMatch(completedTaskIds::contains);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mytaskscheduler-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tasks</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String taskName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mytaskscheduler-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskDependency</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String dependencyTaskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul>]]></content>
    
    
    <summary type="html">基于DAG的并发任务调度实现</summary>
    
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/tags/%E9%9A%8F%E5%86%99/"/>
    
  </entry>
  
  <entry>
    <title>Win10 解决L2TP连接尝试失败，因为安全层在初始化与远程计算机的协商时遇到一个处理错误</title>
    <link href="https://cyborg2077.github.io/2024/08/08/L2TPConnError/"/>
    <id>https://cyborg2077.github.io/2024/08/08/L2TPConnError/</id>
    <published>2024-08-08T08:18:08.000Z</published>
    <updated>2024-08-09T07:33:09.206Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>配了台新电脑，结果VPN连接有问题，试了各种方案之后，最终连上了，记录一下<br><img src="https://s21.ax1x.com/2024/08/08/pkztw6I.png" alt=""></li></ul><h1 id="修改注册表"><a href="#修改注册表" class="headerlink" title="修改注册表"></a>修改注册表</h1><ol><li><p>CMD输入regedit<br><img src="https://s21.ax1x.com/2024/08/08/pkzYvTS.png" alt=""></p></li><li><p>访问这个目录：<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PolicyAgent</code>（可以直接CV），如果该目录下有这个key：<code>AssumeUDPEncapsulationContextOnSendRule</code>，把值修改为2，如果你已经是正确的配置，请忽略这个步骤。<br><img src="https://s21.ax1x.com/2024/08/08/pkztCSs.png" alt=""></p></li><li><p>访问这个目录：<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RasMan\Parameters</code>，将<code>ProhibitIpSec</code>的值改为1，将<code>AllowL2TPWeakCrypto</code>的值改为1，如果你已经是正确的配置，请忽略这个步骤。没有对应的key的话，请创建。<br><img src="https://s21.ax1x.com/2024/08/08/pkztPln.png" alt=""></p></li></ol><h1 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h1><ol><li><p>此电脑 -&gt; 右键 -&gt; 管理 -&gt; 服务<br><img src="https://s21.ax1x.com/2024/08/08/pkztFO0.png" alt=""></p></li><li><p>将<code>IPsec Policy Agent</code>和<code>Routing and Remote Access</code>都改为自动，重启服务。<br><img src="https://s21.ax1x.com/2024/08/08/pkzt80K.png" alt=""></p></li></ol><h1 id="重启电脑"><a href="#重启电脑" class="headerlink" title="重启电脑"></a>重启电脑</h1><ol><li>重启电脑，连接VPN即可。</li></ol>]]></content>
    
    
    <summary type="html">装机总是会遇到各种各样的问题</summary>
    
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/tags/%E9%9A%8F%E5%86%99/"/>
    
  </entry>
  
  <entry>
    <title>局域网文件迁移</title>
    <link href="https://cyborg2077.github.io/2024/08/08/LANFileMigrationGuide/"/>
    <id>https://cyborg2077.github.io/2024/08/08/LANFileMigrationGuide/</id>
    <published>2024-08-08T05:24:24.000Z</published>
    <updated>2024-08-09T07:37:41.823Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>最近装了台新机，配置好了各种开发环境之后，需要把一些重要的文件（例如我的博客目录）迁移到新机器上，但是又没有找到一个好的方法。要是能从新电脑访问到老电脑上的文件就好了，然后恍然大悟，我特喵的可以通过局域网传输</li></ul><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ol><li>检查两台电脑是否在同一局域网内<ul><li>分别运行ipconfig，查看两台电脑的IP和子网掩码</li><li>确保两台电脑的IP处于相同子网内</li><li>测试网络连接：两台电脑互相ping一下，例如<code>ping 192.168.0.104</code>，如果能ping通，说明网络连接正常</li></ul></li></ol><h1 id="设置共享文件夹"><a href="#设置共享文件夹" class="headerlink" title="设置共享文件夹"></a>设置共享文件夹</h1><ol><li><p>在需要被共享文件的电脑上进行设置<br><img src="https://s21.ax1x.com/2024/08/08/pkztL9J.png" alt=""></p></li><li><p>我这种情况下可以直接把整个C盘和D盘共享出来（<code>事后一定要关闭共享！！</code>），其余场景可以按需共享目录<br><img src="https://s21.ax1x.com/2024/08/08/pkztzB6.png" alt=""> </p></li><li><p>配置网络发现</p><ul><li>控制面板 -&gt; 网络和Internet -&gt; 网络和共享中心 -&gt; 更改高级共享设置<br><img src="https://s21.ax1x.com/2024/08/09/pkzX9Zd.png" alt=""></li><li>启用网络发现和文件/打印机共享，并保存更改。<br><img src="https://s21.ax1x.com/2024/08/09/pkzjN1f.png" alt=""></li></ul></li></ol><h1 id="访问共享文件夹"><a href="#访问共享文件夹" class="headerlink" title="访问共享文件夹"></a>访问共享文件夹</h1><ul><li>在另一台电脑上访问<code>\\192.168.0.104</code>，如果一切正常，可以看到共享文件夹。那么现在就可以根据自己的需求来CV一些数据了。<br><img src="https://s21.ax1x.com/2024/08/09/pkzjwng.png" alt=""></li></ul>]]></content>
    
    
    <summary type="html">装完新机，需要迁移数据</summary>
    
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/tags/%E9%9A%8F%E5%86%99/"/>
    
  </entry>
  
  <entry>
    <title>泰拉瑞亚-坐骑Mod开发</title>
    <link href="https://cyborg2077.github.io/2024/07/20/PolWorldMountsDev/"/>
    <id>https://cyborg2077.github.io/2024/07/20/PolWorldMountsDev/</id>
    <published>2024-07-20T05:25:54.000Z</published>
    <updated>2024-11-03T01:31:44.894Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>入门级教程请参考上一篇文章</li><li>Git仓库：<a href="https://github.com/Cyborg2077/PolWorldMounts">https://github.com/Cyborg2077/PolWorldMounts</a></li><li>Steam创意工坊：<a href="https://steamcommunity.com/sharedfiles/filedetails/?id=3292980622">https://steamcommunity.com/sharedfiles/filedetails/?id=3292980622</a></li><li>本文进度会略微落后于创意工坊版本</li></ul><div class="note info no-icon flat"><p>v0.7更新</p><ol><li>为空涡龙增加了三个技能：烈焰风暴（Z键）、光束彗星（X键）、龙彗星（C键）。烈焰风暴会吸附周围的敌对NPC、龙彗星会沿鼠标方向发射、光束彗星的初始方向沿鼠标方向发射，随后自动追踪周围敌怪。</li><li>云海鹿和草莽猪的冲刺改为Z键。</li></ol></div><div class="note info no-icon flat"><p>v0.6更新</p><ol><li>增加了空涡龙坐骑，合成配方：10个夜明锭 + 20个丝绸 + 5个蓝玉，需要帕鲁装置制作台</li><li>增加了帕鲁装置制作台，合成材料：30个木头 + 10个丝绸 + 10个蓝玉</li><li>修改了草莽猪和云海鹿的合成配方</li></ol><ul><li>草莽猪：10个木头 + 10个石头 + 5个蓝玉 + 10个皮革 + 5个椎骨，单击右键进行冲刺，冲刺会摧毁沿途路上的普通树木（一些特殊树木如樱花树等除外）</li><li>云海鹿：20个神圣锭 + 5个飞翔之魂 + 5个光明之魂 + 5个蓝玉，可以进行二段跳，单击右键进行冲刺</li></ul></div><h1 id="如何自定义坐骑"><a href="#如何自定义坐骑" class="headerlink" title="如何自定义坐骑"></a>如何自定义坐骑</h1><ul><li>原版Terraria里的坐骑，首先都要有一个召唤物。<br><img src="https://s21.ax1x.com/2024/07/20/pkTDrp6.png" alt=""></li><li>其次就是有一个buff图标<br><img src="https://s21.ax1x.com/2024/07/20/pkTDs1K.png" alt=""></li><li><p>最后就是坐骑本体<br><img src="https://s21.ax1x.com/2024/07/20/pkTDy6O.png" alt=""></p></li><li><p>所以首先我们要先来制作这个召唤物。那么第一步我们先来创建一个Mod项目吧。<br><img src="https://s21.ax1x.com/2024/07/20/pkT00b9.png" alt=""></p></li></ul><h1 id="制作召唤物"><a href="#制作召唤物" class="headerlink" title="制作召唤物"></a>制作召唤物</h1><ul><li>召唤物的本质实际上就是一个Item，所以我们创建一个类，继承ModItem即可。 </li><li>在这个类中，我们来定义召唤物的一些属性，以及合成材料</li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Mounts;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Items.Mounts</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FenglopeMountItem</span> : <span class="title">ModItem</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span> &#123;</span><br><span class="line">Item.width = <span class="number">20</span>;</span><br><span class="line">Item.height = <span class="number">30</span>;</span><br><span class="line">Item.useTime = <span class="number">20</span>;</span><br><span class="line">Item.useAnimation = <span class="number">20</span>;</span><br><span class="line">Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">Item.<span class="keyword">value</span> = Item.sellPrice(gold: <span class="number">3</span>);</span><br><span class="line">Item.rare = ItemRarityID.Green;</span><br><span class="line">Item.UseSound = SoundID.Item79;</span><br><span class="line">Item.noMelee = <span class="literal">true</span>;</span><br><span class="line">Item.mountType = ModContent.MountType&lt;FenglopeMount&gt;(); <span class="comment">// 这个是调用我们自定义的坐骑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里简单用一个泥土合成，实际上可以改成10个木材、10个石头、5个蓝宝石来进行合成，这样的合成配方和帕鲁中类似</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span> &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, <span class="number">1</span>);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>物品制作完毕后，我们还需要制作贴图，这里我就以帕鲁球为例制作贴图了。画风最好是符合泰拉瑞亚的像素风，这样看起来比较舒服。</li><li>那我们直接启动幻兽帕鲁，进游戏截一张帕鲁球的图<br><img src="https://s21.ax1x.com/2024/07/20/pkTDbng.png" alt=""></li><li>拿到图肯定不能直接用，我们首先要扣掉背景，随后转为像素风，调整尺寸为32*32。扣背景我这里直接用的百度AI图片助手，扣好了之后下载到本地，我们来进一步处理像素风<br><img src="https://s21.ax1x.com/2024/07/20/pkTDL7j.png" alt=""></li><li>像素风的处理，我这里直接用的Python的PIL库来进行处理<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pixelate</span>(<span class="params">image_path, block_size</span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">    w, h = img.size</span><br><span class="line">    img_small = img.resize((w // block_size, h // block_size), resample=Image.NEAREST)</span><br><span class="line">    result = img_small.resize(img.size, Image.NEAREST)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pixelated_image = pixelate(<span class="string">&#x27;帕鲁球.png&#x27;</span>, <span class="number">7</span>)</span><br><span class="line">pixelated_image.save(<span class="string">&#x27;pixelated.png&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li>处理后的效果还是不错的，那么云海鹿召唤物的功能，我们就开发完毕了<br><img src="https://s2.loli.net/2024/07/20/YzJrkLEFQVwUuxc.png" alt=""></li></ul><h1 id="制作坐骑"><a href="#制作坐骑" class="headerlink" title="制作坐骑"></a>制作坐骑</h1><ul><li>坐骑的创建，我们同样需要继承ModMount，随后就是定义坐骑的基本属性，云海鹿的特性有二段跳，所以我们这里不阻止使用额外跳跃，只要你装备了云朵瓶或者气球束之类的会产生额外跳跃的饰品，当你在骑行云海鹿的时候，都可以正常触发。  <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FenglopeMount</span> : <span class="title">ModMount</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetStaticDefaults</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 定义坐骑的基本属性</span></span><br><span class="line">        MountData.jumpHeight = <span class="number">20</span>; <span class="comment">// 坐骑能跳多高</span></span><br><span class="line">        MountData.acceleration = <span class="number">0.19f</span>; <span class="comment">// 加速率，即坐骑加速的速度</span></span><br><span class="line">        MountData.jumpSpeed = <span class="number">20f</span>; <span class="comment">// 当按下跳跃键时，坐骑和玩家向上跳跃的速度</span></span><br><span class="line">        MountData.blockExtraJumps = <span class="literal">false</span>; <span class="comment">// 是否阻止使用额外跳跃（如瓶子中的云）</span></span><br><span class="line">        MountData.constantJump = <span class="literal">true</span>; <span class="comment">// 是否允许按住跳跃键进行连续跳跃</span></span><br><span class="line">        MountData.heightBoost = <span class="number">20</span>; <span class="comment">// 坐骑与地面之间的高度</span></span><br><span class="line">        MountData.fallDamage = <span class="number">0f</span>; <span class="comment">// 从高处跌落时受到的伤害倍率</span></span><br><span class="line">        MountData.runSpeed = <span class="number">11f</span>; <span class="comment">// 坐骑的奔跑速度</span></span><br><span class="line">        MountData.dashSpeed = <span class="number">8f</span>; <span class="comment">// 冲刺速度</span></span><br><span class="line">        MountData.flightTimeMax = <span class="number">0</span>; <span class="comment">// 最大飞行时间，0表示不能飞行</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置疲劳最大值为0，意味着骑乘时不会产生疲劳</span></span><br><span class="line">        MountData.fatigueMax = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关联坐骑的Buff，即骑乘时玩家获得的状态效果</span></span><br><span class="line">        MountData.buff = ModContent.BuffType&lt;Buffs.FenglopeMountBuff&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 动画帧数和玩家偏移量设置</span></span><br><span class="line">        MountData.totalFrames = <span class="number">5</span>; <span class="comment">// 总共的动画帧数，取决于你自己的贴图</span></span><br><span class="line">        MountData.playerYOffsets = Enumerable.Repeat(<span class="number">20</span>, MountData.totalFrames).ToArray(); <span class="comment">// 玩家相对于坐骑的Y轴偏移量数组，用于微调玩家在坐骑贴图的位置</span></span><br><span class="line">        MountData.xOffset = <span class="number">20</span>; <span class="comment">// 玩家相对于坐骑的X轴偏移量，用于微调玩家在坐骑贴图上的位置</span></span><br><span class="line">        MountData.yOffset = <span class="number">-12</span>; <span class="comment">// 玩家相对于坐骑的Y轴偏移量，用于微调玩家在坐骑贴图上的位置</span></span><br><span class="line">        MountData.playerHeadOffset = <span class="number">22</span>; <span class="comment">// 玩家头部相对于坐骑的偏移量，用于微调玩家在坐骑贴图上的位置</span></span><br><span class="line">        MountData.bodyFrame = <span class="number">3</span>; <span class="comment">// 玩家身体在坐骑上的帧号</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不同状态下的动画设置</span></span><br><span class="line">        <span class="comment">// 站立</span></span><br><span class="line">        MountData.standingFrameCount = <span class="number">0</span>;</span><br><span class="line">        MountData.standingFrameDelay = <span class="number">12</span>;</span><br><span class="line">        MountData.standingFrameStart = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 奔跑</span></span><br><span class="line">        MountData.runningFrameCount = <span class="number">4</span>;</span><br><span class="line">        MountData.runningFrameDelay = <span class="number">120</span>;</span><br><span class="line">        MountData.runningFrameStart = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 飞行</span></span><br><span class="line">        MountData.flyingFrameCount = <span class="number">0</span>;</span><br><span class="line">        MountData.flyingFrameDelay = <span class="number">0</span>;</span><br><span class="line">        MountData.flyingFrameStart = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// 空中</span></span><br><span class="line">        MountData.inAirFrameCount = <span class="number">1</span>;</span><br><span class="line">        MountData.inAirFrameDelay = <span class="number">12</span>;</span><br><span class="line">        MountData.inAirFrameStart = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// 闲置</span></span><br><span class="line">        MountData.idleFrameCount = <span class="number">4</span>;</span><br><span class="line">        MountData.idleFrameDelay = <span class="number">12</span>;</span><br><span class="line">        MountData.idleFrameStart = <span class="number">0</span>;</span><br><span class="line">        MountData.idleFrameLoop = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 游泳</span></span><br><span class="line">        MountData.swimFrameCount = MountData.inAirFrameCount;</span><br><span class="line">        MountData.swimFrameDelay = MountData.inAirFrameDelay;</span><br><span class="line">        MountData.swimFrameStart = MountData.inAirFrameStart;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>直接叫上一个好兄弟当工具人，去游戏里简单录一段云海鹿的跑步动画，然后自己截图扣下来<br><img src="https://s21.ax1x.com/2024/07/20/pkTrdKS.png" alt=""></li><li>整个Mod开发耗时最久的就是抠图，哈哈哈哈，一张一张扣完之后，下载保存到本地，然后我简单写了个合成脚本，把多张图垂直排列合并，并缩放，代码目录下按你的顺序存放1.png~5.png即可<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pixelate</span>(<span class="params">image_path, block_size</span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">    w, h = img.size</span><br><span class="line">    img_small = img.resize((w // block_size, h // block_size), resample=Image.NEAREST)</span><br><span class="line">    result = img_small.resize(img.size, Image.NEAREST)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scale_image</span>(<span class="params">image, scale_factor</span>):</span><br><span class="line">    <span class="comment"># 获取当前图片的尺寸</span></span><br><span class="line">    width, height = image.size</span><br><span class="line">    <span class="comment"># 计算新的尺寸</span></span><br><span class="line">    new_width = width // scale_factor</span><br><span class="line">    new_height = height // scale_factor</span><br><span class="line">    <span class="comment"># 返回缩放后的图片</span></span><br><span class="line">    <span class="keyword">return</span> image.resize((new_width, new_height), Image.ANTIALIAS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存处理后的图片对象和尺寸</span></span><br><span class="line">processed_images = []</span><br><span class="line">total_width = <span class="number">0</span></span><br><span class="line">total_height = <span class="number">0</span></span><br><span class="line">scale_factor = <span class="number">4</span>  <span class="comment"># 缩放比例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理图片并计算总高度和宽度</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    pixelated_image = pixelate(<span class="string">f&#x27;<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>.png&#x27;</span>, <span class="number">10</span>)</span><br><span class="line">    scaled_image = scale_image(pixelated_image, scale_factor)</span><br><span class="line">    processed_images.append(scaled_image)</span><br><span class="line">    total_width = <span class="built_in">max</span>(total_width, scaled_image.width)</span><br><span class="line">    total_height += scaled_image.height</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一张新图片，背景颜色为透明</span></span><br><span class="line">new_image = Image.new(<span class="string">&#x27;RGBA&#x27;</span>, (total_width, total_height), color=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将每张处理后的图片粘贴到新图片上</span></span><br><span class="line">y_offset = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> img <span class="keyword">in</span> processed_images:</span><br><span class="line">    new_image.paste(img, (<span class="number">0</span>, y_offset), img)</span><br><span class="line">    y_offset += img.height</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存新图片</span></span><br><span class="line">new_image.save(<span class="string">&#x27;combined_pixelated.png&#x27;</span>, <span class="string">&#x27;PNG&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li>最终的效果<br><img src="https://s21.ax1x.com/2024/07/20/pkTrDEj.png" alt=""></li></ul><h1 id="制作坐骑BUFF"><a href="#制作坐骑BUFF" class="headerlink" title="制作坐骑BUFF"></a>制作坐骑BUFF</h1><ul><li>玩家使用坐骑，其实是对自身施加一个buff，所以我们还要编写一个云海鹿的坐骑BUFF<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Mounts; <span class="comment">// 引入模组中 Mounts 目录下的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Terraria; <span class="comment">// 引入游戏主引擎的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader; <span class="comment">// 引入模组加载器的命名空间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Buffs</span> &#123; <span class="comment">// 定义模组 Buffs 目录下的命名空间</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FenglopeMountBuff</span> : <span class="title">ModBuff</span> &#123; <span class="comment">// 定义一个继承自 ModBuff 的公共类 FenglopeMountBuff</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetStaticDefaults</span>()</span> &#123; <span class="comment">// 重写父类的方法 SetStaticDefaults</span></span><br><span class="line">            Main.buffNoTimeDisplay[Type] = <span class="literal">true</span>; <span class="comment">// 设置此Buff不会显示持续时间</span></span><br><span class="line">            Main.buffNoSave[Type] = <span class="literal">true</span>; <span class="comment">// 设置此Buff不会被保存，即在死亡或退出世界后消失</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">Player player, <span class="keyword">ref</span> <span class="built_in">int</span> buffIndex</span>)</span> &#123; <span class="comment">// 重写父类的方法 Update，当Buff应用到玩家身上时被调用</span></span><br><span class="line">            player.mount.SetMount(ModContent.MountType&lt;FenglopeMount&gt;(), player); <span class="comment">// 设置玩家的坐骑为 FenglopeMount</span></span><br><span class="line">            player.buffTime[buffIndex] = <span class="number">10</span>; <span class="comment">// 设置Buff的持续时间为10帧，实际作用是持续刷新，因为会不断被重新应用</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>简单制作一个Buff图标，同样是使用百度抠图，随后将图片下载到本地，随后像素化，并且指定图片尺寸为32x32<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pixelate</span>(<span class="params">image_path, output_size</span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">    img_small = img.resize(output_size, resample=Image.NEAREST)</span><br><span class="line">    block_size_w = img.width // output_size[<span class="number">0</span>]</span><br><span class="line">    block_size_h = img.height // output_size[<span class="number">1</span>]</span><br><span class="line">    img_pixelated = img_small.resize((img.width // block_size_w, img.height // block_size_h), resample=Image.NEAREST)</span><br><span class="line">    result = img_pixelated.resize(output_size, Image.NEAREST)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pixelated_image = pixelate(<span class="string">&#x27;云海鹿.png&#x27;</span>, (<span class="number">32</span>, <span class="number">32</span>))</span><br><span class="line">pixelated_image.save(<span class="string">&#x27;pixelated_image_云海鹿.png&#x27;</span>)</span><br></pre></td></tr></table></figure></li></ul><h1 id="泰拉瑞亚-启动！"><a href="#泰拉瑞亚-启动！" class="headerlink" title="泰拉瑞亚 启动！"></a>泰拉瑞亚 启动！</h1><ul><li>重新生成并加载Mod，我们的云海鹿就已经可以使用了，只需要一块泥土进行制作，不需要任何合成台<br><img src="https://s2.loli.net/2024/07/20/4FNxEZub52QvhOi.png" alt=""></li></ul><h1 id="增强云海鹿"><a href="#增强云海鹿" class="headerlink" title="增强云海鹿"></a>增强云海鹿</h1><h2 id="不再需要云瓶进行二段跳"><a href="#不再需要云瓶进行二段跳" class="headerlink" title="不再需要云瓶进行二段跳"></a>不再需要云瓶进行二段跳</h2><ul><li>带个云瓶太麻烦了，能不能自己想想办法来实现二段跳呢？当然是有的，我们可以先创建一个二段跳的标志位。标识玩家是否已经进行了二段跳。</li><li>随后我们可以通过判断玩家的Y轴速度是否为0来判断是否处于地面。<ul><li>如果是的话，那么重置一下二段跳的标志位。</li><li>如果不是的话，就可以进行二段跳了。</li></ul></li><li>那么接下来看代码逻辑<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">bool</span> hasDoubleJumped = <span class="literal">false</span>; <span class="comment">// 标志位：是否已经二段跳</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 二段跳逻辑</span></span><br><span class="line"><span class="keyword">if</span> (player.controlJump) <span class="comment">// 玩家按下了跳跃键</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (player.velocity.Y == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        hasDoubleJumped = <span class="literal">false</span>; <span class="comment">// 重置二段跳标志位</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!hasDoubleJumped &amp;&amp; player.releaseJump) <span class="comment">// 确保没有执行二段跳且玩家松开了跳跃键</span></span><br><span class="line">    &#123;</span><br><span class="line">        player.velocity.Y = <span class="number">-18</span>; <span class="comment">// 设置跳跃速度</span></span><br><span class="line">        hasDoubleJumped = <span class="literal">true</span>; <span class="comment">// 设置二段跳标志位，防止玩家无限跳跃</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) <span class="comment">// 这里只是加了一个粒子特效，模仿云瓶的二段跳效果，只是为了好看，没有其他作用</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 dustPosition = player.position;</span><br><span class="line">            Dust dust = Dust.NewDustDirect(dustPostion, player.width, player.height, DustID.Snow, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, Color.White, <span class="number">1.5f</span>);</span><br><span class="line">            dust.velocity *= <span class="number">1.2f</span>;</span><br><span class="line">            dust.color = Color.White; </span><br><span class="line">            dust.noGravity = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>这样的话，就不再需要云瓶来实现二段跳啦。</li></ul><h2 id="增加冲刺技能"><a href="#增加冲刺技能" class="headerlink" title="增加冲刺技能"></a>增加冲刺技能</h2><ul><li>云海鹿的招牌技能：阴云之岚，这里当然也是要尽量还原一下的啦，不过贴图和特效就还原不了了，除非能让我白嫖一个画师，哈哈哈哈。</li><li>技能实现方式其实很简单，本质上就是一个BUFF技能。施放技能后，玩家会被附加一个DEBUFF，持续一段时间，在此期间无法再次释放技能。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查冲刺冷却时间，如果冷却中，减少冷却时间</span></span><br><span class="line"><span class="keyword">if</span> (dashCooldown &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    dashCooldown--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查冲刺时间是否还剩余</span></span><br><span class="line"><span class="keyword">if</span> (dashTimeLeft &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 仍在冲刺中，减少剩余冲刺时间</span></span><br><span class="line">    dashTimeLeft--;</span><br><span class="line">    <span class="comment">// 设置玩家的速度，根据当前方向和冲刺速度</span></span><br><span class="line">    player.velocity.X = player.direction * DashSpeed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成玩家的冲刺命中框</span></span><br><span class="line">    Rectangle hitbox = <span class="keyword">new</span> Rectangle((<span class="built_in">int</span>)(player.position.X + player.velocity.X), </span><br><span class="line">                                      (<span class="built_in">int</span>)(player.position.Y + player.velocity.Y), </span><br><span class="line">                                      player.width, </span><br><span class="line">                                      player.height);</span><br><span class="line">    <span class="comment">// 遍历所有NPC，检测是否与冲刺命中框相交</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Main.maxNPCs; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        NPC target = Main.npc[i];</span><br><span class="line">        <span class="comment">// 检查NPC是否活跃且不是友好的</span></span><br><span class="line">        <span class="keyword">if</span> (target.active &amp;&amp; !target.friendly &amp;&amp; target.Hitbox.Intersects(hitbox))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建击中信息，设置伤害、击退和命中方向</span></span><br><span class="line">            NPC.HitInfo hitInfo = <span class="keyword">new</span> NPC.HitInfo</span><br><span class="line">            &#123;</span><br><span class="line">                Damage = DashDamage,</span><br><span class="line">                Knockback = DashKnockBack,</span><br><span class="line">                HitDirection = player.direction</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 对目标NPC造成伤害</span></span><br><span class="line">            target.StrikeNPC(hitInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成粒子特效</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) <span class="comment">// 每帧生成10个粒子</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 生成粒子位置，基于玩家的中心位置并添加随机偏移</span></span><br><span class="line">        Vector2 dustPosition = player.Center + <span class="keyword">new</span> Vector2(Main.rand.Next(<span class="number">-20</span>, <span class="number">5</span>), Main.rand.Next(<span class="number">-20</span>, <span class="number">5</span>));</span><br><span class="line">        <span class="comment">// 创建新粒子，设置速度和生命周期</span></span><br><span class="line">        Dust.NewDust(dustPosition, <span class="number">0</span>, <span class="number">0</span>, DustID.Snow, player.velocity.X * <span class="number">0.5f</span>, player.velocity.Y * <span class="number">0.5f</span>, <span class="number">100</span>, <span class="literal">default</span>, <span class="number">1.5f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果冷却时间为0，并且玩家没有被“疲劳”BUFF影响</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (dashCooldown == <span class="number">0</span> &amp;&amp; !player.HasBuff(ModContent.BuffType&lt;Buffs.FenglopeExhaustedBuff&gt;()))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取冲刺按键的配置</span></span><br><span class="line">    mountDashKey = ModContent.GetInstance&lt;PolworldModConfig&gt;().MountDashKey;</span><br><span class="line">    <span class="comment">// 检查玩家是否按下了冲刺按键</span></span><br><span class="line">    <span class="keyword">if</span> (Main.keyState.IsKeyDown(mountDashKey))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 开始冲刺，设置剩余冲刺时间和冷却时间</span></span><br><span class="line">        dashTimeLeft = DashDuration;</span><br><span class="line">        dashCooldown = DashCooldown;</span><br><span class="line">        <span class="comment">// 为玩家添加疲劳BUFF，持续600帧（10秒）</span></span><br><span class="line">        player.AddBuff(ModContent.BuffType&lt;Buffs.FenglopeExhaustedBuff&gt;(), <span class="number">600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="草莽猪"><a href="#草莽猪" class="headerlink" title="草莽猪"></a>草莽猪</h1><ul><li>草莽猪只不过移速降低了一点，原版能挖矿，但是泰拉里没有石头矿能撞，所以就改成了撞断沿途的树木。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.GameInput;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> Terraria.Audio;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Input;</span><br><span class="line"><span class="keyword">using</span> PolWorldMounts.Content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Mounts</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RushoarMount</span> : <span class="title">ModMount</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Keys mountDashKey;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> DashCooldown = <span class="number">60</span>; <span class="comment">// 冲刺冷却时间，单位：帧</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> DashDuration = <span class="number">90</span>; <span class="comment">// 冲刺持续时间，单位：帧</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> DashSpeed = <span class="number">12f</span>; <span class="comment">// 冲刺速度</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> DashDamage = <span class="number">50</span>; <span class="comment">// 冲刺造成的伤害</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> DashKnockBack = <span class="number">10f</span>; <span class="comment">// 冲刺造成的击退力</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> dashTimeLeft = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> dashCooldown = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetStaticDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            MountData.jumpHeight = <span class="number">5</span>; <span class="comment">// How high the mount can jump.</span></span><br><span class="line">            MountData.acceleration = <span class="number">0.19f</span>; <span class="comment">// The rate at which the mount speeds up.</span></span><br><span class="line">            MountData.jumpSpeed = <span class="number">5f</span>; <span class="comment">// The rate at which the player and mount ascend towards (negative y velocity) the jump height when the jump button is pressed.</span></span><br><span class="line">            MountData.blockExtraJumps = <span class="literal">true</span>; <span class="comment">// 阻止饰品增加跳跃次数</span></span><br><span class="line">            MountData.constantJump = <span class="literal">true</span>; <span class="comment">// Allows you to hold the jump button down.</span></span><br><span class="line">            MountData.heightBoost = <span class="number">-20</span>; <span class="comment">// Height between the mount and the ground</span></span><br><span class="line">            MountData.fallDamage = <span class="number">0f</span>; <span class="comment">// Fall damage multiplier.</span></span><br><span class="line">            MountData.runSpeed = <span class="number">8f</span>; <span class="comment">// The speed of the mount</span></span><br><span class="line">            MountData.dashSpeed = <span class="number">8f</span>; <span class="comment">// The speed the mount moves when in the state of dashing.</span></span><br><span class="line">            MountData.flightTimeMax = <span class="number">0</span>; <span class="comment">// The amount of time in frames a mount can be in the state of flying.</span></span><br><span class="line"></span><br><span class="line">            MountData.fatigueMax = <span class="number">0</span>;</span><br><span class="line">            MountData.buff = ModContent.BuffType&lt;Buffs.RushoarMountBuff&gt;(); <span class="comment">// The ID number of the buff assigned to the mount.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Effects</span></span><br><span class="line">            <span class="comment">// MountData.spawnDust = ModContent.DustType&lt;Dusts.Sparkle&gt;(); // The ID of the dust spawned when mounted or dismounted.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Frame data and player offsets</span></span><br><span class="line">            MountData.totalFrames = <span class="number">5</span>; <span class="comment">// Amount of animation frames for the mount</span></span><br><span class="line">            MountData.playerYOffsets = Enumerable.Repeat(<span class="number">20</span>, MountData.totalFrames).ToArray(); <span class="comment">// Fills an array with values for less repeating code</span></span><br><span class="line">            MountData.xOffset = <span class="number">20</span>;</span><br><span class="line">            MountData.yOffset = <span class="number">-12</span>;</span><br><span class="line">            MountData.playerHeadOffset = <span class="number">22</span>;</span><br><span class="line">            MountData.bodyFrame = <span class="number">3</span>;</span><br><span class="line">            <span class="comment">// Standing</span></span><br><span class="line">            MountData.standingFrameCount = <span class="number">0</span>;</span><br><span class="line">            MountData.standingFrameDelay = <span class="number">12</span>;</span><br><span class="line">            MountData.standingFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Running</span></span><br><span class="line">            MountData.runningFrameCount = <span class="number">4</span>;</span><br><span class="line">            MountData.runningFrameDelay = <span class="number">50</span>;</span><br><span class="line">            MountData.runningFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Flying</span></span><br><span class="line">            MountData.flyingFrameCount = <span class="number">0</span>;</span><br><span class="line">            MountData.flyingFrameDelay = <span class="number">0</span>;</span><br><span class="line">            MountData.flyingFrameStart = <span class="number">2</span>;</span><br><span class="line">            <span class="comment">// In-air</span></span><br><span class="line">            MountData.inAirFrameCount = <span class="number">1</span>;</span><br><span class="line">            MountData.inAirFrameDelay = <span class="number">12</span>;</span><br><span class="line">            MountData.inAirFrameStart = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// Idle</span></span><br><span class="line">            MountData.idleFrameCount = <span class="number">0</span>;</span><br><span class="line">            MountData.idleFrameDelay = <span class="number">12</span>;</span><br><span class="line">            MountData.idleFrameStart = <span class="number">0</span>;</span><br><span class="line">            MountData.idleFrameLoop = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// Swim</span></span><br><span class="line">            MountData.swimFrameCount = MountData.inAirFrameCount;</span><br><span class="line">            MountData.swimFrameDelay = MountData.inAirFrameDelay;</span><br><span class="line">            MountData.swimFrameStart = MountData.inAirFrameStart;</span><br><span class="line"></span><br><span class="line">            mountDashKey = ModContent.GetInstance&lt;PolworldModConfig&gt;().MountDashKey;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!Main.dedServ)</span><br><span class="line">            &#123;</span><br><span class="line">                MountData.textureWidth = MountData.backTexture.Width() + <span class="number">20</span>;</span><br><span class="line">                MountData.textureHeight = MountData.backTexture.Height();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateEffects</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dashCooldown &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dashCooldown--;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dashTimeLeft &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dashTimeLeft--;</span><br><span class="line">                player.velocity.X = player.direction * DashSpeed;</span><br><span class="line"></span><br><span class="line">                Rectangle hitbox = <span class="keyword">new</span> Rectangle((<span class="built_in">int</span>)(player.position.X + player.velocity.X), (<span class="built_in">int</span>)(player.position.Y + player.velocity.Y), player.width, player.height);</span><br><span class="line">                BreakTreesAlongPath(player, hitbox);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Main.maxNPCs; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    NPC target = Main.npc[i];</span><br><span class="line">                    <span class="keyword">if</span> (target.active &amp;&amp; !target.friendly &amp;&amp; target.Hitbox.Intersects(hitbox))</span><br><span class="line">                    &#123;</span><br><span class="line">                        NPC.HitInfo hitInfo = <span class="keyword">new</span> NPC.HitInfo</span><br><span class="line">                        &#123;</span><br><span class="line">                            Damage = DashDamage,</span><br><span class="line">                            Knockback = DashKnockBack,</span><br><span class="line">                            HitDirection = player.direction</span><br><span class="line">                        &#125;;</span><br><span class="line">                        target.StrikeNPC(hitInfo);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 生成粒子特效</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) <span class="comment">// 每帧生成10个粒子</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Vector2 dustPosition = player.Center + <span class="keyword">new</span> Vector2(Main.rand.Next(<span class="number">-20</span>, <span class="number">5</span>), Main.rand.Next(<span class="number">-20</span>, <span class="number">5</span>));</span><br><span class="line">                    Dust.NewDust(dustPosition, <span class="number">0</span>, <span class="number">0</span>, DustID.Dirt, player.velocity.X * <span class="number">0.5f</span>, player.velocity.Y * <span class="number">0.5f</span>, <span class="number">100</span>, <span class="literal">default</span>, <span class="number">1.5f</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (dashCooldown == <span class="number">0</span> &amp;&amp; !player.HasBuff(ModContent.BuffType&lt;Buffs.RushoarExhaustedBuff&gt;()))</span><br><span class="line">            &#123;</span><br><span class="line">                mountDashKey = ModContent.GetInstance&lt;PolworldModConfig&gt;().MountDashKey;</span><br><span class="line">                <span class="keyword">if</span> (Main.keyState.IsKeyDown(mountDashKey))</span><br><span class="line">                &#123;</span><br><span class="line">                    dashTimeLeft = DashDuration;</span><br><span class="line">                    dashCooldown = DashCooldown;</span><br><span class="line">                    player.AddBuff(ModContent.BuffType&lt;Buffs.RushoarExhaustedBuff&gt;(), <span class="number">600</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BreakTreesAlongPath</span>(<span class="params">Player player, Rectangle hitbox</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> tileStartX = hitbox.Left / <span class="number">16</span>;</span><br><span class="line">            <span class="built_in">int</span> tileEndX = hitbox.Right / <span class="number">16</span>;</span><br><span class="line">            <span class="built_in">int</span> tileStartY = hitbox.Top / <span class="number">16</span>;</span><br><span class="line">            <span class="built_in">int</span> tileEndY = hitbox.Bottom / <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> x = tileStartX; x &lt;= tileEndX; x++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> y = tileStartY; y &lt;= tileEndY; y++)</span><br><span class="line">                &#123;</span><br><span class="line">                    Tile tile = Framing.GetTileSafely(x, y);</span><br><span class="line">                    <span class="keyword">if</span> ((tile.TileType == TileID.Trees</span><br><span class="line">                    <span class="comment">//tile.TileType == TileID.PalmTree ||</span></span><br><span class="line">                    <span class="comment">//tile.TileType == TileID.VanityTreeSakura</span></span><br><span class="line">                    )</span><br><span class="line">                    &amp;&amp; tile.HasTile)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 如果是树顶</span></span><br><span class="line">                        <span class="keyword">if</span> (tile.TileFrameY == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            WorldGen.KillTile(x, y, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                            SoundEngine.PlaySound(SoundID.Item14);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 如果是树身</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (tile.TileFrameY % <span class="number">22</span> == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            WorldGen.KillTile(x, y, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                            SoundEngine.PlaySound(SoundID.Item14);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="空涡龙"><a href="#空涡龙" class="headerlink" title="空涡龙"></a>空涡龙</h1><div class="tabs" id="空涡龙"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#空涡龙-1">空涡龙</button></li><li class="tab"><button type="button" data-href="#空涡龙-2">光束彗星</button></li><li class="tab"><button type="button" data-href="#空涡龙-3">烈焰风暴</button></li><li class="tab"><button type="button" data-href="#空涡龙-4">龙彗星</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="空涡龙-1"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Mounts</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JetragonMount</span> : <span class="title">ModMount</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> FlightAcceleration = <span class="number">0.8f</span>; <span class="comment">// 飞行加速度</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> MaxVerticalSpeed = <span class="number">25f</span>; <span class="comment">// 最大垂直速度</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> HorizontalAcceleration = <span class="number">0.1f</span>; <span class="comment">// 水平加速度</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> DecelerationFactor = <span class="number">0.95f</span>; <span class="comment">// 减速因子</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> isShooting = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> isShootingMeteor = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> isShootingFlareStorm = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetStaticDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            MountData.jumpHeight = <span class="number">15</span>; <span class="comment">// How high the mount can jump.</span></span><br><span class="line">            MountData.acceleration = HorizontalAcceleration; <span class="comment">// The rate at which the mount speeds up.</span></span><br><span class="line">            MountData.jumpSpeed = <span class="number">15f</span>; <span class="comment">// The rate at which the player and mount ascend towards (negative y velocity) the jump height when the jump button is pressed.</span></span><br><span class="line">            MountData.blockExtraJumps = <span class="literal">true</span>; <span class="comment">// 阻止饰品增加跳跃次数</span></span><br><span class="line">            MountData.constantJump = <span class="literal">true</span>; <span class="comment">// Allows you to hold the jump button down.</span></span><br><span class="line">            MountData.heightBoost = <span class="number">20</span>; <span class="comment">// Height between the mount and the ground</span></span><br><span class="line">            MountData.fallDamage = <span class="number">0f</span>; <span class="comment">// Fall damage multiplier.</span></span><br><span class="line">            MountData.runSpeed = <span class="number">25f</span>; <span class="comment">// The speed of the mount</span></span><br><span class="line">            MountData.dashSpeed = <span class="number">15f</span>; <span class="comment">// The speed the mount moves when in the state of dashing.</span></span><br><span class="line">            MountData.flightTimeMax = <span class="number">999999</span>; <span class="comment">// 实现持续飞行</span></span><br><span class="line"></span><br><span class="line">            MountData.fatigueMax = <span class="number">0</span>;</span><br><span class="line">            MountData.buff = ModContent.BuffType&lt;Buffs.JetragonMountBuff&gt;(); <span class="comment">// The ID number of the buff assigned to the mount.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Effects</span></span><br><span class="line">            <span class="comment">// MountData.spawnDust = ModContent.DustType&lt;Dusts.Sparkle&gt;(); // The ID of the dust spawned when mounted or dismounted.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Frame data and player offsets</span></span><br><span class="line">            MountData.totalFrames = <span class="number">3</span>; <span class="comment">// Amount of animation frames for the mount</span></span><br><span class="line">            MountData.playerYOffsets = Enumerable.Repeat(<span class="number">20</span>, MountData.totalFrames).ToArray(); <span class="comment">// Fills an array with values for less repeating code</span></span><br><span class="line">            MountData.xOffset = <span class="number">-10</span>;</span><br><span class="line">            MountData.yOffset = <span class="number">-12</span>;</span><br><span class="line">            MountData.playerHeadOffset = <span class="number">30</span>; <span class="comment">// 确保玩家头部不被遮挡</span></span><br><span class="line">            MountData.bodyFrame = <span class="number">4</span>; <span class="comment">// 调整这个参数，以确保与玩家的动画帧兼容</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Standing</span></span><br><span class="line">            MountData.standingFrameCount = <span class="number">3</span>;</span><br><span class="line">            MountData.standingFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.standingFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Running</span></span><br><span class="line">            MountData.runningFrameCount = <span class="number">3</span>;</span><br><span class="line">            MountData.runningFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.runningFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Flying</span></span><br><span class="line">            MountData.flyingFrameCount = <span class="number">3</span>;</span><br><span class="line">            MountData.flyingFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.flyingFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// In-air</span></span><br><span class="line">            MountData.inAirFrameCount = <span class="number">3</span>;</span><br><span class="line">            MountData.inAirFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.inAirFrameStart = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Idle</span></span><br><span class="line">            MountData.idleFrameCount = <span class="number">0</span>;</span><br><span class="line">            MountData.idleFrameDelay = <span class="number">8</span>;</span><br><span class="line">            MountData.idleFrameStart = <span class="number">0</span>;</span><br><span class="line">            MountData.idleFrameLoop = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// Swim</span></span><br><span class="line">            MountData.swimFrameCount = MountData.inAirFrameCount;</span><br><span class="line">            MountData.swimFrameDelay = MountData.inAirFrameDelay;</span><br><span class="line">            MountData.swimFrameStart = MountData.inAirFrameStart;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!Main.dedServ)</span><br><span class="line">            &#123;</span><br><span class="line">                MountData.textureWidth = MountData.backTexture.Width() + <span class="number">20</span>;</span><br><span class="line">                MountData.textureHeight = MountData.backTexture.Height();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateEffects</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 不受重力影响</span></span><br><span class="line">            player.gravity = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 控制上升和下降</span></span><br><span class="line">            <span class="keyword">if</span> (player.controlJump)</span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.Y = MathHelper.Clamp(</span><br><span class="line">                    player.velocity.Y - FlightAcceleration,</span><br><span class="line">                    -MaxVerticalSpeed,</span><br><span class="line">                    MaxVerticalSpeed</span><br><span class="line">                ); <span class="comment">// 上升</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (player.controlDown)</span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.Y = MathHelper.Clamp(</span><br><span class="line">                    player.velocity.Y + FlightAcceleration,</span><br><span class="line">                    -MaxVerticalSpeed,</span><br><span class="line">                    MaxVerticalSpeed</span><br><span class="line">                ); <span class="comment">// 下降</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.Y *= DecelerationFactor; <span class="comment">// 缓慢减速至静止</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 控制左右移动</span></span><br><span class="line">            <span class="keyword">if</span> (player.controlLeft)</span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.X = MathHelper.Clamp(</span><br><span class="line">                    player.velocity.X - MountData.acceleration,</span><br><span class="line">                    -MountData.runSpeed,</span><br><span class="line">                    MountData.runSpeed</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (player.controlRight)</span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.X = MathHelper.Clamp(</span><br><span class="line">                    player.velocity.X + MountData.acceleration,</span><br><span class="line">                    -MountData.runSpeed,</span><br><span class="line">                    MountData.runSpeed</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                player.velocity.X *= DecelerationFactor; <span class="comment">// 缓慢减速至静止</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 常驻粉色粒子特效</span></span><br><span class="line">            Vector2 pinkDustOffset = <span class="keyword">new</span> Vector2(<span class="number">-40</span> * player.direction, <span class="number">-30</span>); <span class="comment">// 设定偏移量，这里乘以玩家方向是为了当玩家镜像翻转时，贴图也会镜像翻转</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) <span class="comment">// 每帧生成3个粒子</span></span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 pinkDustPosition =</span><br><span class="line">                    player.Center</span><br><span class="line">                    + pinkDustOffset</span><br><span class="line">                    + <span class="keyword">new</span> Vector2(Main.rand.Next(<span class="number">-10</span>, <span class="number">10</span>), Main.rand.Next(<span class="number">-10</span>, <span class="number">10</span>));</span><br><span class="line">                <span class="built_in">int</span> pinkDustIndex = Dust.NewDust(</span><br><span class="line">                    pinkDustPosition,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    DustID.PinkTorch,</span><br><span class="line">                    <span class="number">0f</span>,</span><br><span class="line">                    <span class="number">0f</span>,</span><br><span class="line">                    <span class="number">100</span>,</span><br><span class="line">                    <span class="literal">default</span>,</span><br><span class="line">                    <span class="number">1.5f</span></span><br><span class="line">                );</span><br><span class="line">                Main.dust[pinkDustIndex].noGravity = <span class="literal">true</span>; <span class="comment">// 粉色粒子不受重力影响</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加技能检测和冷却逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (!player.buffType.Contains(ModContent.BuffType&lt;Buffs.JetragonBeamCometBuff&gt;()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 检查是否按下X键并且当前没有在发射弹幕</span></span><br><span class="line">                <span class="keyword">if</span> (Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.X) &amp;&amp; !isShooting)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 启动异步发射弹幕</span></span><br><span class="line">                    isShooting = <span class="literal">true</span>;</span><br><span class="line">                    FireProjectiles(player);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!player.buffType.Contains(ModContent.BuffType&lt;Buffs.JetragonMeteorBuff&gt;()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.C) &amp;&amp; !isShootingMeteor)</span><br><span class="line">                &#123;</span><br><span class="line">                    isShootingMeteor = <span class="literal">true</span>;</span><br><span class="line">                    ShootMeteors(player);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!player.buffType.Contains(ModContent.BuffType&lt;Buffs.JetragonFlareStormBuff&gt;()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Main.keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Z) &amp;&amp; !isShootingFlareStorm)</span><br><span class="line">                &#123;</span><br><span class="line">                    isShootingFlareStorm = <span class="literal">true</span>;</span><br><span class="line">                    FireFlareStorm(player);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Load</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.Load();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">FireProjectiles</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 mousePosition = Main.MouseWorld; <span class="comment">// 获取鼠标位置</span></span><br><span class="line">            Vector2 playerPosition = player.Center; <span class="comment">// 获取玩家位置</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 offset = <span class="keyword">new</span> Vector2(player.direction * <span class="number">-20</span>, <span class="number">-20</span>); <span class="comment">// 在X轴上偏移20个单位，可以根据需要调整偏移量</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 应用偏移量到player.Center</span></span><br><span class="line">                Vector2 spawnPosition = playerPosition + offset;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 计算方向向量，从玩家到鼠标</span></span><br><span class="line">                Vector2 directionToMouse = mousePosition - spawnPosition;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 仅保留水平分量，忽略垂直方向</span></span><br><span class="line">                directionToMouse.Normalize(); <span class="comment">// 归一化方向向量</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置速度，调整速度大小以适应你的需求</span></span><br><span class="line">                Vector2 projectileVelocity = directionToMouse * <span class="number">10f</span>; <span class="comment">// 10f 为弹幕速度的大小</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 创建弹幕</span></span><br><span class="line">                    Projectile.NewProjectile(player.GetSource_FromThis(), spawnPosition, projectileVelocity, ModContent.ProjectileType&lt;Projectiles.BeamCometProjectile&gt;(), <span class="number">200</span>, <span class="number">2</span>, player.whoAmI);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 处理异常，记录错误或采取其他措施</span></span><br><span class="line">                    Main.NewText(<span class="string">$&quot;Error creating projectile: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 等待0.2秒（200毫秒）</span></span><br><span class="line">                <span class="keyword">await</span> Task.Delay(<span class="number">200</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加冷却Buff</span></span><br><span class="line">            player.AddBuff(ModContent.BuffType&lt;Buffs.JetragonBeamCometBuff&gt;(), <span class="number">300</span>); <span class="comment">// 10秒</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 完成发射后重置状态</span></span><br><span class="line">            isShooting = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">ShootMeteors</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 mousePosition = Main.MouseWorld;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> k = <span class="number">0</span>; k &lt; <span class="number">4</span>; k++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 随机偏移以模拟不同的落点</span></span><br><span class="line">                    Vector2 offset = <span class="keyword">new</span> Vector2(Main.rand.Next(<span class="number">-100</span>, <span class="number">100</span>), Main.rand.Next(<span class="number">-100</span>, <span class="number">100</span>));</span><br><span class="line">                    Vector2 targetPosition = mousePosition + offset;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 从玩家位置到目标位置的方向</span></span><br><span class="line">                    Vector2 direction = targetPosition - player.Center;</span><br><span class="line">                    direction.Normalize();</span><br><span class="line">                    <span class="built_in">float</span> speed = <span class="number">10f</span>; <span class="comment">// 陨石速度</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 随机化初始速度方向（沿弧形路径）</span></span><br><span class="line">                    <span class="built_in">float</span> angle = Main.rand.NextFloat(-MathHelper.Pi / <span class="number">4</span>, MathHelper.Pi / <span class="number">4</span>); <span class="comment">// 随机弧形角度</span></span><br><span class="line">                    Vector2 initialVelocity = <span class="keyword">new</span> Vector2(</span><br><span class="line">                        direction.X * (<span class="built_in">float</span>)Math.Cos(angle) - direction.Y * (<span class="built_in">float</span>)Math.Sin(angle),</span><br><span class="line">                        direction.X * (<span class="built_in">float</span>)Math.Sin(angle) + direction.Y * (<span class="built_in">float</span>)Math.Cos(angle)</span><br><span class="line">                    ) * speed;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 应用偏移量到player.Center</span></span><br><span class="line">                    Vector2 offsetProj = <span class="keyword">new</span> Vector2(</span><br><span class="line">                        (player.direction * <span class="number">-30</span>) + Main.rand.NextFloat(<span class="number">-10f</span>, <span class="number">10f</span>), <span class="comment">// 随机化X偏移量</span></span><br><span class="line">                        <span class="number">-60</span> + Main.rand.NextFloat(<span class="number">-10f</span>, <span class="number">10f</span>) <span class="comment">// 随机化Y偏移量</span></span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                    Vector2 spawnPosition = player.Center + offsetProj;</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 创建弹幕</span></span><br><span class="line">                        <span class="built_in">int</span> projIndex = Projectile.NewProjectile(player.GetSource_FromThis(), spawnPosition, initialVelocity, ModContent.ProjectileType&lt;Projectiles.DragonMeteorProjectile&gt;(), <span class="number">200</span>, <span class="number">2</span>, player.whoAmI);</span><br><span class="line">                        <span class="comment">// 获取创建的弹幕</span></span><br><span class="line">                        Projectile projectile = Main.projectile[projIndex];</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 设置弹幕的初始状态，确保它会在开始时沿弧形路径运动</span></span><br><span class="line">                        projectile.ai[<span class="number">0</span>] = <span class="number">1</span>; <span class="comment">// 使用 ai[0] 标记弹幕已开始弧形运动</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (NullReferenceException ex)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 等待0.1秒（100毫秒）</span></span><br><span class="line">                    <span class="keyword">await</span> Task.Delay(<span class="number">50</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                isShootingMeteor = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// 等待0.3秒（300毫秒）</span></span><br><span class="line">                <span class="keyword">await</span> Task.Delay(<span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            player.AddBuff(ModContent.BuffType&lt;Buffs.JetragonMeteorBuff&gt;(), <span class="number">1200</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">FireFlareStorm</span>(<span class="params">Player player</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 mousePosition = Main.MouseWorld; <span class="comment">// 获取鼠标位置</span></span><br><span class="line">            Vector2 playerPosition = player.Center; <span class="comment">// 获取玩家位置</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) <span class="comment">// 生成5个FlareStorm弹幕</span></span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 spawnPosition = playerPosition + <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">10</span>); <span class="comment">// 在玩家下方生成弹幕</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 计算方向向量，从玩家到鼠标</span></span><br><span class="line">                Vector2 directionToMouse = mousePosition - spawnPosition;</span><br><span class="line">                directionToMouse.Y = <span class="number">0</span>;</span><br><span class="line">                directionToMouse.Normalize(); <span class="comment">// 归一化方向向量</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置速度，调整速度大小以适应你的需求</span></span><br><span class="line">                Vector2 velocity = directionToMouse * <span class="number">10f</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 创建FlareStorm弹幕</span></span><br><span class="line">                    Projectile.NewProjectile(player.GetSource_FromThis(), spawnPosition, velocity, ModContent.ProjectileType&lt;Projectiles.FlareStormProjectile&gt;(), <span class="number">300</span>, <span class="number">2</span>, player.whoAmI);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (NullReferenceException ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 处理异常，记录错误或采取其他措施</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 等待0.1秒（100毫秒）</span></span><br><span class="line">                <span class="keyword">await</span> Task.Delay(<span class="number">100</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加冷却时间</span></span><br><span class="line"></span><br><span class="line">            player.AddBuff(ModContent.BuffType&lt;Buffs.JetragonFlareStormBuff&gt;(), <span class="number">1800</span>); <span class="comment">// 10秒</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 完成发射后重置状态</span></span><br><span class="line">            isShootingFlareStorm = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="空涡龙-2"><ul><li>光束彗星一开始会沿着鼠标方向发射，随后会自动追踪800像素范围内的敌怪。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BeamCometProjectile</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.width = <span class="number">10</span>; <span class="comment">// 弹幕宽度</span></span><br><span class="line">            Projectile.height = <span class="number">10</span>; <span class="comment">// 弹幕高度</span></span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>; <span class="comment">// 是否对玩家友好</span></span><br><span class="line">            Projectile.hostile = <span class="literal">false</span>; <span class="comment">// 是否对敌人友好</span></span><br><span class="line">            Projectile.tileCollide = <span class="literal">true</span>; <span class="comment">// 是否与瓷砖碰撞</span></span><br><span class="line">            Projectile.penetrate = <span class="number">5</span>; <span class="comment">// 穿透数量</span></span><br><span class="line">            Projectile.timeLeft = <span class="number">600</span>; <span class="comment">// 弹幕的存活时间（帧）</span></span><br><span class="line">            Projectile.light = <span class="number">0.5f</span>; <span class="comment">// 弹幕的光亮度</span></span><br><span class="line">            Projectile.ignoreWater = <span class="literal">true</span>; <span class="comment">// 是否忽略水</span></span><br><span class="line">            Projectile.extraUpdates = <span class="number">1</span>; <span class="comment">// 每帧更新次数</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AI</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Player player = Main.player[Projectile.owner];</span><br><span class="line">            Vector2 mousePosition = Main.MouseWorld;</span><br><span class="line">            NPC target = FindClosestNPC(<span class="number">800f</span>); <span class="comment">// 设定追踪范围为800像素</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (target != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果找到目标，计算弹幕朝向目标的方向</span></span><br><span class="line">                Vector2 directionToTarget = target.Center - Projectile.Center;</span><br><span class="line">                directionToTarget.Normalize();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 平滑过渡到目标方向</span></span><br><span class="line">                <span class="built_in">float</span> smoothFactor = <span class="number">0.05f</span>; <span class="comment">// 调整平滑的因子，0到1之间，数值越小转向越平滑</span></span><br><span class="line">                Projectile.velocity = Vector2.Lerp(Projectile.velocity, directionToTarget * <span class="number">4f</span>, smoothFactor);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 粒子效果</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span>; i++) <span class="comment">// 每帧生成1个粒子</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Pink, Projectile.velocity.X * <span class="number">0.2f</span>, Projectile.velocity.Y * <span class="number">0.2f</span>, <span class="number">100</span>, <span class="keyword">new</span> Color(<span class="number">205</span>, <span class="number">71</span>, <span class="number">208</span>), <span class="number">0.7f</span>);</span><br><span class="line">                Dust dust = Main.dust[dustIndex];</span><br><span class="line">                dust.noGravity = <span class="literal">true</span>;</span><br><span class="line">                dust.velocity *= <span class="number">0.3f</span>;</span><br><span class="line">                dust.scale *= <span class="number">0.95f</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加光效</span></span><br><span class="line">            Lighting.AddLight(Projectile.Center, <span class="number">0.84f</span>, <span class="number">0.48f</span>, <span class="number">0.73f</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 辅助方法，查找最近的敌人</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> NPC <span class="title">FindClosestNPC</span>(<span class="params"><span class="built_in">float</span> maxDetectDistance</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            NPC closestNPC = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">float</span> sqrMaxDetectDistance = maxDetectDistance * maxDetectDistance;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Main.maxNPCs; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                NPC npc = Main.npc[i];</span><br><span class="line">                <span class="keyword">if</span> (npc.CanBeChasedBy(<span class="keyword">this</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">float</span> sqrDistanceToNPC = Vector2.DistanceSquared(npc.Center, Projectile.Center);</span><br><span class="line">                    <span class="keyword">if</span> (sqrDistanceToNPC &lt; sqrMaxDetectDistance)</span><br><span class="line">                    &#123;</span><br><span class="line">                        sqrMaxDetectDistance = sqrDistanceToNPC;</span><br><span class="line">                        closestNPC = npc;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> closestNPC;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnHitNPC</span>(<span class="params">NPC target, NPC.HitInfo hit, <span class="built_in">int</span> damageDone</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            target.AddBuff(BuffID.OnFire, <span class="number">300</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">PreDraw</span>(<span class="params"><span class="keyword">ref</span> Color lightColor</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取当前帧的源矩形</span></span><br><span class="line">            Rectangle sourceRectangle = <span class="keyword">new</span> Rectangle(<span class="number">0</span>, Projectile.frame * Projectile.height, Projectile.width, Projectile.height);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取弹幕的贴图</span></span><br><span class="line">            Texture2D texture = Terraria.GameContent.TextureAssets.Projectile[Projectile.type].Value;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拖影效果参数</span></span><br><span class="line">            <span class="built_in">float</span> alpha = <span class="number">0.5f</span>; <span class="comment">// 拖影的透明度</span></span><br><span class="line">            <span class="built_in">float</span> scale = Projectile.scale; <span class="comment">// 拓影的缩放</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取弹幕的速度方向</span></span><br><span class="line">            Vector2 velocity = Projectile.velocity;</span><br><span class="line">            velocity.Normalize(); <span class="comment">// 归一化速度向量，用于确定拖影的方向</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算拖影偏移量</span></span><br><span class="line">            <span class="built_in">float</span> offsetDistance = <span class="number">10f</span>; <span class="comment">// 拖影偏移量的距离（可以根据需要调整）</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 绘制拖影</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) <span class="comment">// 绘制5个拖影（可以调整数量）</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 计算每个拖影的位置</span></span><br><span class="line">                Vector2 offset = velocity * offsetDistance * i; <span class="comment">// 沿着速度方向的偏移量</span></span><br><span class="line">                Color color = Color.Lerp(lightColor, Color.Transparent, alpha / <span class="number">5f</span> * i); <span class="comment">// 逐渐变透明的颜色</span></span><br><span class="line"></span><br><span class="line">                Main.spriteBatch.Draw(</span><br><span class="line">                    texture,</span><br><span class="line">                    Projectile.Center - Main.screenPosition - offset,</span><br><span class="line">                    sourceRectangle,</span><br><span class="line">                    color,</span><br><span class="line">                    Projectile.rotation,</span><br><span class="line">                    <span class="keyword">new</span> Vector2(Projectile.width / <span class="number">2</span>, Projectile.height / <span class="number">2</span>),</span><br><span class="line">                    scale,</span><br><span class="line">                    SpriteEffects.None,</span><br><span class="line">                    <span class="number">0f</span></span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 绘制正常的弹幕</span></span><br><span class="line">            Main.spriteBatch.Draw(</span><br><span class="line">                texture,</span><br><span class="line">                Projectile.Center - Main.screenPosition,</span><br><span class="line">                sourceRectangle,</span><br><span class="line">                lightColor,</span><br><span class="line">                Projectile.rotation,</span><br><span class="line">                <span class="keyword">new</span> Vector2(Projectile.width / <span class="number">2</span>, Projectile.height / <span class="number">2</span>),</span><br><span class="line">                scale,</span><br><span class="line">                SpriteEffects.None,</span><br><span class="line">                <span class="number">0f</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 返回false，表示我们自己绘制了弹幕</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="空涡龙-3"><ul><li>烈焰风暴个人感觉还是很不错的，抠图就扣了老半天了，会赋予敌人燃烧效果，并且会有吸附效果，清兵神器，自己调试的时候，把CD改成0.1，直接秒天秒地了。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Projectiles;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlareStormProjectile</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.width = <span class="number">168</span>; <span class="comment">// 弹幕宽度</span></span><br><span class="line">            Projectile.height = <span class="number">164</span>; <span class="comment">// 弹幕高度</span></span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>; <span class="comment">// 是否对玩家友好</span></span><br><span class="line">            Projectile.hostile = <span class="literal">false</span>; <span class="comment">// 是否对敌人友好</span></span><br><span class="line">            Projectile.tileCollide = <span class="literal">true</span>; <span class="comment">// 是否与瓷砖碰撞</span></span><br><span class="line">            Projectile.penetrate = <span class="number">9999</span>; <span class="comment">// 穿透数量</span></span><br><span class="line">            Projectile.timeLeft = <span class="number">300</span>; <span class="comment">// 弹幕的存活时间（帧）</span></span><br><span class="line">            Projectile.light = <span class="number">0.8f</span>; <span class="comment">// 弹幕的光亮度</span></span><br><span class="line">            Projectile.ignoreWater = <span class="literal">true</span>; <span class="comment">// 是否忽略水</span></span><br><span class="line">            Projectile.extraUpdates = <span class="number">1</span>; <span class="comment">// 每帧更新次数</span></span><br><span class="line">            Projectile.aiStyle = <span class="number">-1</span>; <span class="comment">// 自定义AI</span></span><br><span class="line">            Main.projFrames[Projectile.type] = <span class="number">4</span>; <span class="comment">// 设置弹幕的帧数</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AI</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建火焰粒子特效</span></span><br><span class="line">            <span class="keyword">if</span> (Main.rand.NextBool(<span class="number">3</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                Dust dust = Dust.NewDustDirect(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Yellow);</span><br><span class="line">                dust.noGravity = <span class="literal">true</span>; <span class="comment">// 粒子不受重力影响</span></span><br><span class="line">                dust.velocity *= <span class="number">1.2f</span>; <span class="comment">// 增加粒子速度</span></span><br><span class="line">                dust.scale *= <span class="number">1.5f</span>; <span class="comment">// 增加粒子规模</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置弹幕沿地面前进</span></span><br><span class="line">            <span class="keyword">if</span> (Projectile.velocity.Y == <span class="number">0f</span>) <span class="comment">// 检查弹幕是否在地面上</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Projectile.velocity.X &gt; <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Projectile.velocity.X = Math.Max(Projectile.velocity.X - <span class="number">0.1f</span>, <span class="number">0</span>); <span class="comment">// 左移减速</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Projectile.velocity.X &lt; <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Projectile.velocity.X = Math.Min(Projectile.velocity.X + <span class="number">0.1f</span>, <span class="number">0</span>); <span class="comment">// 右移减速</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Math.Abs(Projectile.velocity.X) &lt; <span class="number">0.2f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Projectile.velocity.X = <span class="number">0f</span>; <span class="comment">// 停止移动</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Projectile.velocity.Y += <span class="number">0.2f</span>; <span class="comment">// 重力作用</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加光效</span></span><br><span class="line">            Lighting.AddLight(Projectile.Center, <span class="number">0.8f</span>, <span class="number">0.4f</span>, <span class="number">0.1f</span>); <span class="comment">// 添加橙色光效</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新动画帧</span></span><br><span class="line">            Projectile.frameCounter++;</span><br><span class="line">            <span class="keyword">if</span> (Projectile.frameCounter &gt;= <span class="number">5</span>) <span class="comment">// 每5帧切换一次图片</span></span><br><span class="line">            &#123;</span><br><span class="line">                Projectile.frame++;</span><br><span class="line">                Projectile.frame %= <span class="number">4</span>; <span class="comment">// 循环帧动画</span></span><br><span class="line">                Projectile.frameCounter = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 吸附敌怪</span></span><br><span class="line">            <span class="keyword">foreach</span> (NPC npc <span class="keyword">in</span> Main.npc)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (npc.active &amp;&amp; !npc.friendly &amp;&amp; !npc.dontTakeDamage &amp;&amp; Vector2.Distance(Projectile.Center, npc.Center) &lt; <span class="number">300f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Vector2 direction = Projectile.Center - npc.Center;</span><br><span class="line">                    direction.Normalize();</span><br><span class="line">                    npc.velocity += direction * <span class="number">0.1f</span>; <span class="comment">// 吸附效果</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnHitNPC</span>(<span class="params">NPC target, NPC.HitInfo hit, <span class="built_in">int</span> damageDone</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            target.AddBuff(BuffID.OnFire, <span class="number">300</span>); <span class="comment">// 造成燃烧效果，持续5秒</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">OnTileCollide</span>(<span class="params">Vector2 oldVelocity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.velocity = Vector2.Zero; <span class="comment">// 停止移动，但不消失</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 不摧毁弹幕</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Kill</span>(<span class="params"><span class="built_in">int</span> timeLeft</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 可以在弹幕摧毁时添加特效</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="空涡龙-4"><ul><li>龙彗星倒是没有什么特别的，感觉这个不是很好还原的其实，弹幕生成的不会很丝滑，运动轨迹，emmm 也很奇怪，可能是会有更平滑的函数实现吧。</li><li>每次发射的时候都会沿鼠标方向。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DragonMeteorProjectile</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> hasAccelerated = <span class="literal">false</span>; <span class="comment">// 是否已经开始加速</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> hoverTime = <span class="number">60</span>; <span class="comment">// 悬停时间（帧）</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.width = <span class="number">32</span>; <span class="comment">// 弹幕宽度</span></span><br><span class="line">            Projectile.height = <span class="number">32</span>; <span class="comment">// 弹幕高度</span></span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>; <span class="comment">// 是否对玩家友好</span></span><br><span class="line">            Projectile.hostile = <span class="literal">false</span>; <span class="comment">// 是否对敌人友好</span></span><br><span class="line">            Projectile.tileCollide = <span class="literal">true</span>; <span class="comment">// 是否与瓷砖碰撞</span></span><br><span class="line">            Projectile.penetrate = <span class="number">-1</span>; <span class="comment">// 穿透数量，设置为-1表示不会消失</span></span><br><span class="line">            Projectile.timeLeft = <span class="number">300</span>; <span class="comment">// 弹幕的存活时间（帧）</span></span><br><span class="line">            Projectile.light = <span class="number">0.8f</span>; <span class="comment">// 弹幕的光亮度</span></span><br><span class="line">            Projectile.ignoreWater = <span class="literal">true</span>; <span class="comment">// 是否忽略水</span></span><br><span class="line">            Projectile.extraUpdates = <span class="number">1</span>; <span class="comment">// 每帧更新次数</span></span><br><span class="line">            Main.projFrames[Projectile.type] = <span class="number">4</span>; <span class="comment">// 设置弹幕的帧数</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AI</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (hoverTime &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                hoverTime--;</span><br><span class="line">                Projectile.velocity = Vector2.Zero; <span class="comment">// 悬停时速度为零</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 不产生粒子特效</span></span><br><span class="line">                <span class="keyword">if</span> (hoverTime % <span class="number">10</span> == <span class="number">0</span>) <span class="comment">// 每10帧产生一次粒子特效（可以调整频率）</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Pink, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">1.0f</span>);</span><br><span class="line">                    Main.dust[dustIndex].velocity *= <span class="number">0.5f</span>;</span><br><span class="line">                    Main.dust[dustIndex].scale *= <span class="number">1.2f</span>;</span><br><span class="line">                    Main.dust[dustIndex].noGravity = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!hasAccelerated)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 targetPosition = Main.MouseWorld;</span><br><span class="line">                Vector2 direction = targetPosition - Projectile.Center;</span><br><span class="line">                direction.Normalize();</span><br><span class="line">                Projectile.velocity = direction * <span class="number">2f</span>; <span class="comment">// 设置初始速度</span></span><br><span class="line">                hasAccelerated = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Projectile.velocity *= <span class="number">1.05f</span>; <span class="comment">// 缓慢加速</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加粒子效果或其他视觉效果</span></span><br><span class="line">            <span class="keyword">if</span> (hoverTime &lt;= <span class="number">0</span>) <span class="comment">// 只有在加速阶段才产生粒子特效</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Red, Projectile.velocity.X * <span class="number">0.5f</span>, Projectile.velocity.Y * <span class="number">0.5f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">1.0f</span>);</span><br><span class="line">                Main.dust[dustIndex].velocity *= <span class="number">0.5f</span>;</span><br><span class="line">                Main.dust[dustIndex].scale *= <span class="number">1.2f</span>;</span><br><span class="line">                Main.dust[dustIndex].noGravity = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Kill</span>(<span class="params"><span class="built_in">int</span> timeLeft</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建爆炸效果的范围伤害</span></span><br><span class="line">            <span class="built_in">float</span> explosionRadius = <span class="number">150f</span>; <span class="comment">// 爆炸范围</span></span><br><span class="line">            <span class="built_in">int</span> damage = <span class="number">300</span>; <span class="comment">// 爆炸伤害</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查找爆炸范围内的敌人并造成伤害</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Main.maxNPCs; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                NPC npc = Main.npc[i];</span><br><span class="line">                <span class="keyword">if</span> (npc.CanBeChasedBy(<span class="keyword">this</span>) &amp;&amp; Vector2.Distance(npc.Center, Projectile.Center) &lt; explosionRadius)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 计算伤害并应用</span></span><br><span class="line">                    npc.SimpleStrikeNPC(damage, <span class="number">0</span>, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">null</span>, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">false</span>); <span class="comment">// hitDirection 设置为 -1 表示无特定方向</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 播放音效</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Smoke, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">2f</span>);</span><br><span class="line">                Main.dust[dustIndex].velocity *= <span class="number">1.4f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Blue, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">3f</span>);</span><br><span class="line">                Main.dust[dustIndex].noGravity = <span class="literal">true</span>;</span><br><span class="line">                Main.dust[dustIndex].velocity *= <span class="number">5f</span>;</span><br><span class="line">                dustIndex = Dust.NewDust(Projectile.position, Projectile.width, Projectile.height, DustID.Firework_Red, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">100</span>, <span class="literal">default</span>(Color), <span class="number">2f</span>);</span><br><span class="line">                Main.dust[dustIndex].velocity *= <span class="number">3f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">PreDraw</span>(<span class="params"><span class="keyword">ref</span> Color lightColor</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取当前帧的源矩形</span></span><br><span class="line">            Rectangle sourceRectangle = <span class="keyword">new</span> Rectangle(<span class="number">0</span>, Projectile.frame * Projectile.height, Projectile.width, Projectile.height);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 绘制弹幕</span></span><br><span class="line">            Main.spriteBatch.Draw(</span><br><span class="line">                Terraria.GameContent.TextureAssets.Projectile[Projectile.type].Value,</span><br><span class="line">                Projectile.Center - Main.screenPosition,</span><br><span class="line">                sourceRectangle,</span><br><span class="line">                lightColor,</span><br><span class="line">                Projectile.rotation,</span><br><span class="line">                <span class="keyword">new</span> Vector2(Projectile.width / <span class="number">2</span>, Projectile.height / <span class="number">2</span>),</span><br><span class="line">                Projectile.scale,</span><br><span class="line">                SpriteEffects.None,</span><br><span class="line">                <span class="number">0f</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 返回false，表示我们自己绘制了弹幕</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1 id="帕鲁工作台"><a href="#帕鲁工作台" class="headerlink" title="帕鲁工作台"></a>帕鲁工作台</h1><ul><li><p>工作台实际上就是一个物块而已</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Items.WorkBench</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PolworldBasicWorkBenchItem</span> : <span class="title">ModItem</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Item.width = <span class="number">28</span>;</span><br><span class="line">            Item.height = <span class="number">14</span>;</span><br><span class="line">            Item.maxStack = <span class="number">99</span>;</span><br><span class="line">            Item.useTurn = <span class="literal">true</span>;</span><br><span class="line">            Item.autoReuse = <span class="literal">true</span>;</span><br><span class="line">            Item.useAnimation = <span class="number">15</span>;</span><br><span class="line">            Item.useTime = <span class="number">10</span>;</span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.consumable = <span class="literal">true</span>;</span><br><span class="line">            Item.createTile = ModContent.TileType&lt;Tiles.PolworldBasicWorkBench&gt;(); <span class="comment">// 设置对应的Tile</span></span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span></span><br><span class="line">        &#123;          </span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.Wood, <span class="number">30</span>);</span><br><span class="line">            recipe.AddIngredient(ItemID.Sapphire, <span class="number">10</span>);</span><br><span class="line">            recipe.AddIngredient(ItemID.Silk, <span class="number">10</span>);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>随后在制作物品的时候，指明需要的物块即可</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Mounts;</span><br><span class="line"><span class="keyword">using</span> PolWorldMounts.Content.Tiles;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolWorldMounts.Content.Items.Mounts</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FenglopeMountItem</span> : <span class="title">ModItem</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span> &#123;</span><br><span class="line">Item.width = <span class="number">20</span>;</span><br><span class="line">Item.height = <span class="number">30</span>;</span><br><span class="line">Item.useTime = <span class="number">20</span>;</span><br><span class="line">Item.useAnimation = <span class="number">20</span>;</span><br><span class="line">Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">Item.<span class="keyword">value</span> = Item.sellPrice(gold: <span class="number">3</span>);</span><br><span class="line">Item.rare = ItemRarityID.Yellow;</span><br><span class="line">Item.UseSound = SoundID.Item79;</span><br><span class="line">Item.noMelee = <span class="literal">true</span>;</span><br><span class="line">Item.mountType = ModContent.MountType&lt;FenglopeMount&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span> &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">recipe.AddIngredient(ItemID.HallowedBar, <span class="number">20</span>);</span><br><span class="line">recipe.AddIngredient(ItemID.SoulofFlight, <span class="number">5</span>);</span><br><span class="line">recipe.AddIngredient(ItemID.SoulofLight, <span class="number">10</span>);</span><br><span class="line">            recipe.AddIngredient(ItemID.Sapphire, <span class="number">5</span>);</span><br><span class="line">recipe.AddTile(Mod, <span class="string">&quot;PolworldBasicWorkBench&quot;</span>);  <span class="comment">// 这里指明需要帕鲁基础工作台就好啦，这样的话必须使用工作台才能制作哦</span></span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">持续更新中...</summary>
    
    
    
    <category term="Mod开发" scheme="https://cyborg2077.github.io/categories/Mod%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Mod开发" scheme="https://cyborg2077.github.io/tags/Mod%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>泰拉瑞亚Mod开发指南</title>
    <link href="https://cyborg2077.github.io/2024/07/06/TModDev/"/>
    <id>https://cyborg2077.github.io/2024/07/06/TModDev/</id>
    <published>2024-07-06T06:21:01.000Z</published>
    <updated>2024-07-19T15:24:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><ul><li>欢迎来到泰拉瑞亚的创意无限世界，在这里，不仅仅是探索与冒险，更是创造与实现梦想的天地。作为一名勇敢的开发者，你即将他上的旅程，不近视深入这个像素世界的腹地，更是要在其基础上构建属于你自己的奇迹。本指南将是你受众的罗盘，引领你步入泰拉瑞亚模组开发的神秘大门。</li><li>想象一下，当你手持代码之间，桥下第一个字符，一个简单的”Hello World”便能在泰拉瑞亚广阔的天地间回响，这不仅是变成传统的直径，也是你成为游戏世界造物主的第一步。泰拉瑞亚mod开发的魅力，在于它赋予你重塑世界规则的能力，无论是新奇的武器、独特的怪物，还是整个异世界的创造，一切皆有可能。</li><li>本指南将循序渐进，从最基础的设置环境开始，逐步深入如何使用C#和TModLoader来编写你的第一个mod，理解背后的逻辑与技巧，为你后续的创意开发打下坚实的基础。</li><li>无论你是编程新手，还是经验丰富的开发者初涉游戏领域，这篇指南都力求让你的每一步学习都充满乐趣与成就感。准备好了吗？让我们异同步入泰拉瑞亚的编程仙境，用一行行代码编制出属于你的传奇故事。</li><li>让我们开始吧！</li></ul><h1 id="Mod制作准备"><a href="#Mod制作准备" class="headerlink" title="Mod制作准备"></a>Mod制作准备</h1><ol><li>一台电脑</li><li>玩过泰拉瑞亚，原版或者灾厄至少通关过一次（博主原版大师、灾厄死亡大师都通关了）</li><li>安装IDE，强烈建议VSCode，主要是写C#</li><li>会使用画图软件（Photoshop等）</li></ol><h2 id="NET环境安装"><a href="#NET环境安装" class="headerlink" title=".NET环境安装"></a>.NET环境安装</h2><ul><li>开发环境的安装，可以直接看微软官方教程</li></ul><div class="tag link"><a class="link-card" title="" href="https://dotnet.microsoft.com/zh-cn/learn/dotnet/hello-world-tutorial/install"><div class="left"><img src="https://dotnet.microsoft.com/favicon.ico"/></div><div class="right"><p class="text"></p><p class="url">https://dotnet.microsoft.com/zh-cn/learn/dotnet/hello-world-tutorial/install</p></div></a></div><ul><li>这里再建议安装一个通义灵码的插件，用起来还是挺方便的<br><img src="https://s21.ax1x.com/2024/07/07/pkWQOwq.png" alt=""></li></ul><h2 id="TModLoader的介绍与安装"><a href="#TModLoader的介绍与安装" class="headerlink" title="TModLoader的介绍与安装"></a>TModLoader的介绍与安装</h2><h3 id="源码Mod和TML-Mod的区别"><a href="#源码Mod和TML-Mod的区别" class="headerlink" title="源码Mod和TML Mod的区别"></a>源码Mod和TML Mod的区别</h3><blockquote><ul><li>源码Mod的制作方法是通过反编译泰拉瑞亚源码，并在此基础上修改而制作的模组。优点是自由度高，可以实现的功能多。缺点是很难管理，灵活度低下，尤其是当Mod规模扩大的时候。</li><li>TML Mod通过提供原版的接口使得开发者可以在一个与原版独立的环境开发Mod，也就是说，开发者可以不用关注原版冗长的代码实现细节，而是与接口进行互动。优点是管理方便、灵活。缺点是实现的功能具有局限性，有时候需要等待TML开发者添加了某些接口才能实现特定的功能。但是随着TML这么多年功能的不断的完善，以及原版泰拉瑞亚代码越来越晦涩难懂，TML开发最终占据了主导。</li></ul></blockquote><h3 id="TModLoader的安装"><a href="#TModLoader的安装" class="headerlink" title="TModLoader的安装"></a>TModLoader的安装</h3><ul><li><p>如果你之前打过mod玩，那么其实你已经安装好了，对吧</p></li><li><p>如果你是第一次使用mod游玩，直接在Steam上下载安装即可<br><img src="https://s21.ax1x.com/2024/07/07/pkWlMXd.png" alt=""></p></li><li><p>安装完成之后，直接TMOD，启动！<br><img src="https://s21.ax1x.com/2024/07/07/pkWl37t.png" alt=""></p></li><li><p>点击创意工坊，进入创意工坊中心<br><img src="https://s21.ax1x.com/2024/07/06/pkWi8uF.png" alt=""></p></li><li><p>点击开发模组，会看到如下页面<br><img src="https://s21.ax1x.com/2024/07/07/pkWlD7q.png" alt=""></p></li></ul><h1 id="第一个Mod"><a href="#第一个Mod" class="headerlink" title="第一个Mod"></a>第一个Mod</h1><ul><li>点击右下角创建模组，填写模组信息我们就可以初始化一个模组项目了<ul><li>ModName：模组名称，不要夹杂空格</li><li>Mod DisplayName：模组显示名称</li><li>Mod Author：模组作者</li><li>BasicSword：初始之剑，这里填写的是剑的名称，创建项目时，会自动生成这把剑的初始化代码<br><img src="https://s21.ax1x.com/2024/07/07/pkWlg9U.png" alt=""></li></ul></li><li>点击创建后，初始化的项目如下<br><img src="https://s21.ax1x.com/2024/07/07/pkW1SEt.png" alt=""></li><li><p>我们在VSCode里打开这个项目，首先看一下目录结构<br><img src="https://s21.ax1x.com/2024/07/07/pkW1PC8.png" alt=""></p><ol><li><code>[ModName].cs</code>：这是Mod类。它是任何Mod的核心文件，每个Mod只能存在一个Mod类，对于简单的Mod，这个文件会非常简洁，但是这个类中可以发生各种全局性的事情。</li><li><code>description.txt</code>：包含Mod的描述文本，在Mod菜单中点击“更多信息”按钮可以在游戏中查看。如果你愿意，可以创建一个带有额外BBCode格式的description_workshop.txt文件，该文件将在Steam创意工坊网站上显示。</li><li><code>build.txt</code>：包含Mod的版本、作者和显示信息。可以包含其他值。这个文件是必要的。</li><li><code>icon.png</code>：在游戏中显示的80x80图标。你可以为Steam创意工坊创建一个更详细或更高分辨率的icon_workshop.png图标，该文件可以达到512x512像素。</li><li><code>[ModName].csproj</code>：为Visual Studio设置的项目文件，用于调试你的Mod。调试非常有用，但需要一些学习，不要删除它。</li><li><code>Properties/launchSettings.json</code>：与ModName.csproj相关，包含用于调试tModLoader文件路径，不要删除，随着你的经验积累，它会变得很有用。</li><li><code>Content/Items/[ItemName].cs</code>：一个简单的剑物品。以此作为示例，学习如何制作其他ModItem类。</li><li><code>Content/Items/[ItemName].png</code>：对应的物品图像。</li><li><code>Localization/en-US_Mods.[ModName].hjson</code>：包含Mod中内容的英文文本。它目前包含生成的剑的显示名称和工具提示。这个文件会随着你向Mod添加新内容而自动更新条目。请参阅<a href="https://github.com/tModLoader/tModLoader/wiki/Localization">Localization Wiki</a>了解更多本地化及支持其他语言的信息。</li></ol></li><li><p>下面我们直接来看初始化剑的代码，以及对应的配置文件信息。</p><div class="tabs" id="初始化剑"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#初始化剑-1">Excalibur.cs</button></li><li class="tab"><button type="button" data-href="#初始化剑-2">Localization.hjson</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="初始化剑-1"><ul><li>下面这段代码就是初始之剑的代码，我们先来看<code>SetDefaults()</code>方法，这个方法就是初始化物品的配置信息，这里我们配置了物品的伤害、攻击类型、宽高、使用时间、使用动画、使用方式、击退、价值、稀有度、音效、自动使用（近战武器自动挥舞）等。</li><li><p>同时我们需要关注<code>AddRecipes()</code>方法，这个方法就是添加物品的合成配方，这里我们添加了合成配方，需要用10个土块，并且需要工作台才可以制作。</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// This is a basic item template.</span></span><br><span class="line">    <span class="comment">// Please see tModLoader&#x27;s ExampleMod for every other example:</span></span><br><span class="line">    <span class="comment">// https://github.com/tModLoader/tModLoader/tree/stable/ExampleMod</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Excalibur</span> : <span class="title">ModItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// The Display Name and Tooltip of this item can be edited in the &#x27;Localization/en-US_Mods.MyFirstMod.hjson&#x27; file.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span> &#123;</span><br><span class="line">            Item.damage = <span class="number">50</span>;</span><br><span class="line">            Item.DamageType = DamageClass.Melee;</span><br><span class="line">            Item.width = <span class="number">40</span>;</span><br><span class="line">            Item.height = <span class="number">40</span>;</span><br><span class="line">            Item.useTime = <span class="number">20</span>;</span><br><span class="line">            Item.useAnimation = <span class="number">20</span>;</span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.knockBack = <span class="number">6</span>;</span><br><span class="line">            Item.<span class="keyword">value</span> = Item.buyPrice(silver: <span class="number">1</span>);</span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">            Item.UseSound = SoundID.Item1;</span><br><span class="line">            Item.autoReuse = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span> &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, <span class="number">10</span>);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>那我们现在加载Mod，并且进入游戏<br><img src="https://s21.ax1x.com/2024/07/07/pkW3iIx.png" alt=""></p></li><li>建造一个工作台，并且使用10个土块，即可制造我们的初始之剑<br><img src="https://s21.ax1x.com/2024/07/07/pkW3AJK.png" alt=""></li><li>50点伤害有点不够看啊，那我们现在修改一下武器伤害以及攻击间隔，随后重新构建并加载我们的Mod，然后再次进入游戏<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">using Terraria;</span><br><span class="line">using Terraria.ID;</span><br><span class="line">using Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line">namespace MyFirstMod.Content.Items</span><br><span class="line">&#123;</span><br><span class="line">    public class Excalibur : ModItem</span><br><span class="line">    &#123;</span><br><span class="line">        public override void SetDefaults() &#123;</span><br><span class="line"><span class="deletion">-           Item.damage = 50;</span></span><br><span class="line"><span class="addition">+           Item.damage = 99999999;</span></span><br><span class="line">            Item.DamageType = DamageClass.Melee;</span><br><span class="line">            Item.width = 40;</span><br><span class="line">            Item.height = 40;</span><br><span class="line"><span class="deletion">-           Item.useTime = 20;</span></span><br><span class="line"><span class="deletion">-           Item.useAnimation = 20;</span></span><br><span class="line"><span class="addition">+           Item.useTime = 5;</span></span><br><span class="line"><span class="addition">+           Item.useAnimation = 5;</span></span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.knockBack = 6;</span><br><span class="line">            Item.value = Item.buyPrice(silver: 1);</span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">            Item.UseSound = SoundID.Item1;</span><br><span class="line">            Item.autoReuse = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void AddRecipes() &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, 10);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://s21.ax1x.com/2024/07/07/pkW3VzD.png" alt=""></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="初始化剑-2"><ul><li>在这里可以配置Mod物品的显示名称和提示信息。<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># This file will automatically update with entries for new content after a build and reload.</span><br><span class="line"></span><br><span class="line">Items<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  Excalibur<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    DisplayName<span class="punctuation">:</span> <span class="string">&quot;Excalibur&quot;</span></span><br><span class="line">    Tooltip<span class="punctuation">:</span></span><br><span class="line">      &#x27;&#x27;&#x27;</span><br><span class="line">      Template of an item</span><br><span class="line">      Replacing this tooltip is duty </span><br><span class="line">      It&#x27;s snowing on Mt.Fuji</span><br><span class="line">      &#x27;&#x27;&#x27;</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li>修改初始之剑的名称以及描述<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Items<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  Excalibur<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    DisplayName<span class="punctuation">:</span> Hello World!</span><br><span class="line">    Tooltip<span class="punctuation">:</span> 代码之力，小子！</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul><h1 id="Basic-Item"><a href="#Basic-Item" class="headerlink" title="Basic Item"></a><a href="https://github.com/tModLoader/tModLoader/wiki/Basic-Item">Basic Item</a></h1><ul><li>本小节旨在解释所有Item之间的共同点。</li></ul><h2 id="什么是物品（What-is-an-Item）？"><a href="#什么是物品（What-is-an-Item）？" class="headerlink" title="什么是物品（What is an Item）？"></a>什么是物品（What is an Item）？</h2><ul><li>了解物品（Item）、抛射物（Projectiles）和方块（Tiles）之间的区别非常重要。刚开始时，如果你不清楚它们的不同之处，可能会无意中混淆概念。例如，有些人可能会混淆并试图将<code>工作台物品（Item）</code>添加到<code>配方</code>中，而实际上他们想要添加的是<code>工作台方块（Tile）</code>。还需要意识到，像回旋镖武器这样的东西实际上由物品和抛射物组成。虽然这是一个简单的概念，但请记住这一点。</li></ul><h2 id="制作物品（Making-an-Item）"><a href="#制作物品（Making-an-Item）" class="headerlink" title="制作物品（Making an Item）"></a>制作物品（Making an Item）</h2><ul><li>要将物品添加到泰拉瑞亚，我们首先必须创建一个类，该类需要继承<code>ModItem</code>，实际上上面小节中的<code>[ModName].cs</code>就是个样例，在创建Mod的时候已经为我们生成了一把剑的物品。</li></ul><h3 id="设置默认值"><a href="#设置默认值" class="headerlink" title="设置默认值"></a>设置默认值</h3><ul><li>物品最重要的部分是 <code>SetDefaults</code>。<code>SetDefaults</code> 是设置物品属性的地方，例如物品使用什么弹药、物品的大小以及物品放置的是哪个方块。请参阅 <a href="https://github.com/tModLoader/tModLoader/wiki/Item-Class-Documentation">Item 类文档</a> ，了解在 SetDefaults 中常见的设置值的含义。你还可以通过访问 <a href="https://github.com/tModLoader/tModLoader/wiki/Vanilla-Item-Field-Values">Vanilla Item</a> 来查看原版物品字段值。</li></ul><h3 id="本地化"><a href="#本地化" class="headerlink" title="本地化"></a>本地化</h3><ul><li>构建你的 Mod 后，本地化文件通常位于 My Games\Terraria\tModLoader\ModSources\MyModName\Localization\en-US_Mods.MyModName.hjson，将会填充有新添加物品的条目。对于物品，你会看到 DisplayName 和 Tooltip 的条目。DisplayName 将默认为类名，单词之间用大写字母分隔。Tooltip 默认为空。你可以编辑此文件以自定义这些本地化内容：<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Items<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  NameHere<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    DisplayName<span class="punctuation">:</span> Name Here</span><br><span class="line">    Tooltip<span class="punctuation">:</span> This is a modded item.</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="Basic-Projectile"><a href="#Basic-Projectile" class="headerlink" title="Basic Projectile"></a><a href="https://github.com/tModLoader/tModLoader/wiki/Basic-Projectile#what-is-ai">Basic Projectile</a></h1><ul><li>在学习向量以及计算几何的知识之前，最好能先创建一个自己的弹幕。这样我们可以通过这个弹幕观察到数学是如何发挥作用的。</li></ul><h2 id="弹幕基础"><a href="#弹幕基础" class="headerlink" title="弹幕基础"></a>弹幕基础</h2><h3 id="什么是Projectile"><a href="#什么是Projectile" class="headerlink" title="什么是Projectile"></a>什么是Projectile</h3><ul><li>在开始修改弹幕之前，我们需要先了解物品和弹幕之间的区别。物品是可以存储在库存中（例如背包、箱子等）的对象，而弹幕时从武器或者敌人射出的对象，例如子弹、箭等。</li></ul><h3 id="什么情况下会使用弹幕？"><a href="#什么情况下会使用弹幕？" class="headerlink" title="什么情况下会使用弹幕？"></a>什么情况下会使用弹幕？</h3><ul><li>在泰拉瑞亚中，许多物品因为弹幕的存在而具有功能性，例如枪和弓（子弹和箭）、激光、炸弹和其他投掷物品，以及大多数魔法武器，甚至一些抓钩、连枷、长矛、宠物、召唤物、钻头和悠悠球，也会生成弹幕。很多敌怪也可以生成弹幕。</li></ul><h3 id="创建基本弹幕"><a href="#创建基本弹幕" class="headerlink" title="创建基本弹幕"></a>创建基本弹幕</h3><ul><li>在创建弹幕之前，我们最好先规范一下目录结构，为后续所有的弹幕建立一个单独的文件夹，名为Porjectiles；同时也为刚刚的剑创建一个单独的文件夹，名为Sowrds。<br><img src="https://s21.ax1x.com/2024/07/07/pkWNTpt.png" alt=""></li><li>随后在Projectiles目录下创建<code>[ProjectileName].cs</code>和<code>[ProjectileName].png</code>（弹幕贴图）文件。创建弹幕时，我们需要继承<code>ModProjectile</code>类，同时需要实现<code>SetDefaults</code>方法，<code>SetDefaults</code>方法中需要设置弹幕的属性，例如弹幕的大小、弹幕的速度、弹幕的伤害、弹幕的伤害类型等。</li><li>下面代码中的<code>namespace</code>需要替换为你自己的模组文件夹名/命名空间。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">      Projectile.arrow = <span class="literal">true</span>;</span><br><span class="line">      Projectile.width = <span class="number">10</span>;</span><br><span class="line">      Projectile.height = <span class="number">10</span>;</span><br><span class="line">      Projectile.aiStyle = ProjAIStyleID.Arrow;</span><br><span class="line">      Projectile.friendly = <span class="literal">true</span>;</span><br><span class="line">      Projectile.DamageType = DamageClass.Ranged;</span><br><span class="line">      AIType = ProjectileID.WoodenArrowFriendly;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Additional hooks/methods here.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="应用弹幕"><a href="#应用弹幕" class="headerlink" title="应用弹幕"></a>应用弹幕</h3><div class="note info no-icon flat"><ul><li>请记住，物品和弹幕是不同的。一个常见的错误是，模组开发者创建了一个弹幕，却不了解还需要创建一个使用该弹幕的东西。例如，对于投掷飞刀武器，您需要同时创建一个物品和一个弹幕。弹药物品也需要有一个独特的弹幕与之关联。如果弹幕是由NPC生成的，您不总是需要同时创建物品和弹幕。测试弹幕的最简单方法是创建一个物品，并将 Item.shoot 设置为弹幕。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Item.shoot = ModContent.ProjectileType&lt;MyProjectile&gt;();</span><br></pre></td></tr></table></figure></li></ul></div><ul><li>在刚刚我们已将创建好了一个弹幕，现在我们将其作用于武器上<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ using MyFirstMod.Content.Items.Projectiles;</span></span><br><span class="line">using Terraria;</span><br><span class="line">using Terraria.ID;</span><br><span class="line">using Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line">namespace MyFirstMod.Content.Items.Swords</span><br><span class="line">&#123;</span><br><span class="line">    public class Excalibur : ModItem</span><br><span class="line">    &#123;</span><br><span class="line">        public override void SetDefaults() &#123;</span><br><span class="line">            Item.damage = 99999999;</span><br><span class="line">            Item.DamageType = DamageClass.Melee;</span><br><span class="line">            Item.width = 40;</span><br><span class="line">            Item.height = 40;</span><br><span class="line">            Item.useTime = 5;</span><br><span class="line">            Item.useAnimation = 5;</span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.knockBack = 6;</span><br><span class="line">            Item.value = Item.buyPrice(silver: 1);</span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">            Item.UseSound = SoundID.Item1;</span><br><span class="line">            Item.autoReuse = true;</span><br><span class="line"><span class="addition">+           Item.shoot = ModContent.ProjectileType&lt;MyFirstProjectile&gt;();</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void AddRecipes() &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, 10);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>重新编译并加载Mod，进入游戏，挥舞武器，可以看到我们刚刚制作的弹幕已经生成了。<br><img src="https://s21.ax1x.com/2024/07/07/pkWUdjf.png" alt=""></li></ul><h3 id="SetDefaults"><a href="#SetDefaults" class="headerlink" title="SetDefaults"></a>SetDefaults</h3><ul><li>弹幕最重要的部分是SetDefaults方法。该方法是设置弹幕值的地方，例如命中宽度和高度、弹幕是友军还是敌军、以及弹幕将使用哪个AI。请参阅<a href="https://github.com/tModLoader/tModLoader/wiki/Projectile-Class-Documentation">弹幕类文档</a>以了解通常设置的值的含义。还可以通过放温暖<a href="https://github.com/tModLoader/tModLoader/wiki/Vanilla-Projectile-Field-Values">Vanilla弹幕字段值</a>来查看Vanilla弹幕值。</li></ul><h4 id="Projectile-Damage"><a href="#Projectile-Damage" class="headerlink" title="Projectile.Damage"></a>Projectile.Damage</h4><ul><li>一个常见的错误是在SetDefaults中设置Projectiles.Damage，这不起作用，因为弹幕的伤害值总是被生成弹幕时传递给Projectile.NewProjectile的值覆盖。通常，生成弹幕的物品或NPC将决定伤害值。</li></ul><h3 id="Other-Hooks-Methods"><a href="#Other-Hooks-Methods" class="headerlink" title="Other Hooks/Methods"></a>Other Hooks/Methods</h3><ul><li>ModProjectile文档列出了许多其他钩子/方法，您可以使用它们生成独特的弹幕。例如在弹幕击中敌人时施加减益效果，可以使用OnHitNpc方法，要在弹幕击中物块时做些事情，可以使用OnTileCollide方法。</li></ul><h3 id="What-is-AI"><a href="#What-is-AI" class="headerlink" title="What is AI"></a>What is AI</h3><ul><li>弹幕的AI是弹幕最重要的方面，它控制弹幕在生成后如何移动和行动，对于新手模组开发者来说，最简单的方法是通过设置<code>Projectile.aiStyle = #</code>和<code>AIType = ProjectileID.NameHere</code>来一来其他原版弹幕已经使用的AI代码。你分配给<code>Projectile.aiStyle</code>的值应该与<code>ProjectileID.NameHere</code>的值相匹配。这杯成为模仿原版弹幕。</li><li>随着你对更高级的弹幕移动行为的需求，你会发现模仿原版弹幕AI非常有限，所以下面我们将讨论如何自定义AI。</li></ul><h4 id="使用原版AI"><a href="#使用原版AI" class="headerlink" title="使用原版AI"></a>使用原版AI</h4><ul><li>我们可以使用原版AI来初始化我们的弹幕。让我们制作一个回旋镖，使用和原版回旋镖弹幕相同的aiStyle。我们可以在<a href=""></a>中查找回旋镖弹幕，可以看到原版回旋镖使用的aiStyle为3。</li><li>那么我们可以在代码中使用<code>Projectile.aiStyle = 3;</code>，或者将3改为<code>ProjectileID.Boomerang</code>，增强代码的可读性。</li><li>为了让这个回旋镖更简单，我们可以使用<code>Projectile.CloneDefaults(ProjectileID.EnchantedBoomerang);</code>，这将复制所有其他的默认值。这样，你将获得一个与原版回旋镖行为相同的弹幕。</li><li>通过设置AIType可以改变弹幕的粒子特效。<div class="tabs" id="原版ai回旋镖"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#原版ai回旋镖-1">MyFirstBoomerang.cs</button></li><li class="tab"><button type="button" data-href="#原版ai回旋镖-2">BoomerangProjectileDemo.cs</button></li><li class="tab"><button type="button" data-href="#原版ai回旋镖-3">BoomerangProjectileDemo.cs Clone</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="原版ai回旋镖-1"><ul><li>请注意，武器贴图请自行解决。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyFirstMod.Content.Items.Projectiles;</span><br><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Boomerangs</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyFirstBoomerang</span> : <span class="title">ModItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span> &#123;</span><br><span class="line">            Item.damage = <span class="number">99999999</span>;</span><br><span class="line">            Item.DamageType = DamageClass.Melee;</span><br><span class="line">            Item.width = <span class="number">40</span>;</span><br><span class="line">            Item.height = <span class="number">40</span>;</span><br><span class="line">            Item.useTime = <span class="number">5</span>;</span><br><span class="line">            Item.useAnimation = <span class="number">5</span>;</span><br><span class="line">            Item.useStyle = ItemUseStyleID.Swing;</span><br><span class="line">            Item.knockBack = <span class="number">6</span>;</span><br><span class="line">            Item.<span class="keyword">value</span> = Item.buyPrice(silver: <span class="number">1</span>);</span><br><span class="line">            Item.rare = ItemRarityID.Blue;</span><br><span class="line">            Item.UseSound = SoundID.Item1;</span><br><span class="line">            Item.autoReuse = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// 重点是这一行，指定弹幕类型</span></span><br><span class="line">            Item.shoot = ModContent.ProjectileType&lt;BoomerangProjectileDemo&gt;();</span><br><span class="line">            Item.shootSpeed = <span class="number">10f</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRecipes</span>()</span> &#123;</span><br><span class="line">            Recipe recipe = CreateRecipe();</span><br><span class="line">            recipe.AddIngredient(ItemID.DirtBlock, <span class="number">10</span>);</span><br><span class="line">            recipe.AddTile(TileID.WorkBenches);</span><br><span class="line">            recipe.Register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="原版ai回旋镖-2"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoomerangProjectileDemo</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.width = <span class="number">10</span>;</span><br><span class="line">            Projectile.height = <span class="number">10</span>;</span><br><span class="line">            Projectile.aiStyle = ProjAIStyleID.Boomerang;</span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>;</span><br><span class="line">            Projectile.DamageType = DamageClass.Ranged;</span><br><span class="line">            AIType = ProjectileID.WoodenArrowFriendly;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Additional hooks/methods here.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="原版ai回旋镖-3"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoomerangProjectileDemo</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123; </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.CloneDefaults(ProjectileID.EnchantedBoomerang);</span><br><span class="line">            AIType = ProjectileID.EnchantedBoomerang;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Additional hooks/methods here.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li><li>重新编译并加载Mod，进入游戏，我们就可以使用10个土块在工作台旁制作我们刚刚编写的回旋镖了。亲测手感和原版几乎无异（虽然我也不怎么用回旋镖武器就是了）。</li></ul><h2 id="自定义AI"><a href="#自定义AI" class="headerlink" title="自定义AI"></a>自定义AI</h2><ul><li>本小节将讨论你可以在AI中添加的元素，记得如果使用<code>Projectile.CloneDefaults</code>复制其他弹幕默认值，要将<code>Projectile.aiStyle</code>的值设回<code>0</code>。所有自定义AI的代码都放在<code>ModProjectile.AI</code>方法中。也就是重写AI()方法<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Terraria;</span><br><span class="line"><span class="keyword">using</span> Terraria.ID;</span><br><span class="line"><span class="keyword">using</span> Terraria.ModLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyFirstMod.Content.Items.Projectiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyFirstProjectile</span> : <span class="title">ModProjectile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetDefaults</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Projectile.arrow = <span class="literal">true</span>;</span><br><span class="line">            Projectile.width = <span class="number">10</span>;</span><br><span class="line">            Projectile.height = <span class="number">10</span>;</span><br><span class="line">            Projectile.aiStyle = ProjAIStyleID.Arrow;</span><br><span class="line">            Projectile.friendly = <span class="literal">true</span>;</span><br><span class="line">            Projectile.DamageType = DamageClass.Ranged;</span><br><span class="line">            AIType = ProjectileID.WoodenArrowFriendly;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Additional hooks/methods here.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重写此方法，自定义AI</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AI</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.AI();</span><br><span class="line">            <span class="comment">// Additional code here.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="Timers"><a href="#Timers" class="headerlink" title="Timers"></a>Timers</h3><ul><li>Timers：计时器</li><li>许多弹幕使用计时器来延迟动作。通常我们使用<code>Projectile.ai[0]</code>或<code>Projectile.ai[1]</code>，因为这些值会自动同步，这里我们计数到30，换句话说，半秒。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Projectile.ai[<span class="number">0</span>] += <span class="number">1f</span>;</span><br><span class="line"><span class="keyword">if</span> (Projectile.ai[<span class="number">0</span>] &gt;= <span class="number">30f</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 半秒过去了。重置计时器等。</span></span><br><span class="line">    Projectile.ai[<span class="number">0</span>] = <span class="number">0f</span>;</span><br><span class="line">    Projectile.netUpdate = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 在这里做点什么，也许改变到新状态。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="Gravity"><a href="#Gravity" class="headerlink" title="Gravity"></a>Gravity</h3><ul><li>Gravity：重力</li><li>弹幕实际上没有重力，每个带有重力移动的弹幕实际上是它们的AI代码实现了重力。要实现重力，只需要在<code>Projectile.velovity.Y</code>中添加一个小值。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Projectile.velocity.Y = Projectile.velocity.Y + <span class="number">0.1f</span>; <span class="comment">// 0.1f 是箭的重力，0.4f 是飞刀的重力</span></span><br><span class="line"><span class="keyword">if</span> (Projectile.velocity.Y &gt; <span class="number">16f</span>) <span class="comment">// 这个检查实现了“终端速度”。我们不希望弹幕越来越快。</span></span><br><span class="line">&#123;</span><br><span class="line">    Projectile.velocity.Y = <span class="number">16f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>根据上述的计时器和重力的设定，我们现在可以写一个延迟重力效果<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Projectile.ai[<span class="number">0</span>] += <span class="number">1f</span>; <span class="comment">// 使用计时器等待15个刻度后再应用重力。</span></span><br><span class="line"><span class="keyword">if</span> (Projectile.ai[<span class="number">0</span>] &gt;= <span class="number">15f</span>)</span><br><span class="line">&#123;</span><br><span class="line">    Projectile.ai[<span class="number">0</span>] = <span class="number">15f</span>;</span><br><span class="line">    Projectile.velocity.Y = Projectile.velocity.Y + <span class="number">0.1f</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (Projectile.velocity.Y &gt; <span class="number">16f</span>) <span class="comment">// 终端速度检查，设置弹幕速度不超过16像素/帧。</span></span><br><span class="line">&#123;</span><br><span class="line">    Projectile.velocity.Y = <span class="number">16f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="Wind-Resistance"><a href="#Wind-Resistance" class="headerlink" title="Wind Resistance"></a>Wind Resistance</h3><ul><li>Wind Resistance：风阻</li><li>纵向的加速度是重力控制的，那么横向的加速度是风阻控制的。</li><li>通过减少<code>Projectile.velocity.X</code>的乘积系数，我们可以轻松实现风阻。结合计时器，我们同样可以让弹幕越来越慢，实现类似蜜蜂手雷的效果。（打肉山的时候，在平台扔蜜蜂手雷，一开始速度蛮快的，但是会越来越慢，直至爆炸）<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Projectile.ai[<span class="number">0</span>] += <span class="number">1f</span>;</span><br><span class="line"><span class="keyword">if</span> (Projectile.ai[<span class="number">0</span>] &gt;= <span class="number">15f</span>) &#123;</span><br><span class="line">    <span class="comment">// 这里的示例没有加上重力，无伤大雅</span></span><br><span class="line">    Projectile.velocity.X = Projectile.velocity.X * <span class="number">0.97f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="Rotation"><a href="#Rotation" class="headerlink" title="Rotation"></a>Rotation</h3><ul><li>Rotation：旋转</li></ul><h4 id="恒定旋转"><a href="#恒定旋转" class="headerlink" title="恒定旋转"></a>恒定旋转</h4><ul><li>我们可以在AI中添加<code>Projectile.rotation</code>使其想回旋镖一样旋转。<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Projectile.rotation += <span class="number">0.4f</span> * Projectile.direction;</span><br></pre></td></tr></table></figure></li></ul><h4 id="面向前方"><a href="#面向前方" class="headerlink" title="面向前方"></a>面向前方</h4><h1 id="自定义坐骑"><a href="#自定义坐骑" class="headerlink" title="自定义坐骑"></a>自定义坐骑</h1>]]></content>
    
    
    <summary type="html">持续更新中，咕咕咕</summary>
    
    
    
    <category term="Mod开发" scheme="https://cyborg2077.github.io/categories/Mod%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Mod开发" scheme="https://cyborg2077.github.io/tags/Mod%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>浅谈操作系统的虚拟内存</title>
    <link href="https://cyborg2077.github.io/2024/02/25/OSVirtureMemory/"/>
    <id>https://cyborg2077.github.io/2024/02/25/OSVirtureMemory/</id>
    <published>2024-02-25T14:33:38.000Z</published>
    <updated>2024-02-25T15:00:32.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul><li>虚拟内存是计算机系统内存管理的一种技术。它使得应用程序认为它拥有连续的可用的内存（一个连续完整的地址空间），而实际上，它通常是被分隔成多个物理内存碎片，还有部分暂时存储在外部磁盘存储器上，在需要时进行数据交换。大多数操作系统都使用了虚拟内存，如Windows家族的“虚拟内存”；Linux的“交换空间”等。</li></ul>]]></content>
    
    
    <summary type="html">新需求还没出来，刚好可以系统性的学点东西，提升一下自己</summary>
    
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="OS" scheme="https://cyborg2077.github.io/tags/OS/"/>
    
  </entry>
  
  <entry>
    <title>实现一个Cache，包括LRU和在X秒后过期的逻辑</title>
    <link href="https://cyborg2077.github.io/2024/02/25/LRUCacheExpire/"/>
    <id>https://cyborg2077.github.io/2024/02/25/LRUCacheExpire/</id>
    <published>2024-02-25T06:56:38.000Z</published>
    <updated>2024-02-25T12:38:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LRU（Least-Recently-Used）"><a href="#LRU（Least-Recently-Used）" class="headerlink" title="LRU（Least Recently Used）"></a>LRU（Least Recently Used）</h1><ul><li>最近最少使用，它的设计原则借鉴了<code>时间局部性原理</code>，该算法认为如果数据最近被访问过，那么将来被访问的几率也更高，反之亦然。其原理是将数据按照其被访问的时间形成一个有序序列，最久未被使用的数据应该最早被淘汰掉，即当缓存空间被占满时，缓存内最长时间未被使用的数据将被淘汰掉。</li></ul><h1 id="大致思路"><a href="#大致思路" class="headerlink" title="大致思路"></a>大致思路</h1><ul><li><p>可以简单的维护一个双向链表来实现，每当数据被访问时，使用头插法插入到队首。空间占满时，先移除末尾元素，随后对新元素使用头插法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        Node pre, next;</span><br><span class="line">        <span class="type">int</span> key, value;</span><br><span class="line">        Node(<span class="type">int</span> key, <span class="type">int</span> value) &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Node</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="type">Node</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    Map&lt;Integer, Node&gt; map;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提供初始化缓存的大小</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LRUCache</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(size);</span><br><span class="line">        head.next = tail;</span><br><span class="line">        tail.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 命中缓存，将其移动到队首</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            remove(node);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">            res = node.value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="comment">// 命中缓存，修改键值，并移动到队首</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="comment">// 1. 修改键值</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            node.value = value;</span><br><span class="line">            <span class="comment">// 移动到队首</span></span><br><span class="line">            remove(node);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 未命中缓存，判断缓存是否已满</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">mapSize</span> <span class="operator">=</span> map.size();</span><br><span class="line">            <span class="comment">// 已满则移除队尾元素</span></span><br><span class="line">            <span class="keyword">if</span> (mapSize == size) &#123;</span><br><span class="line">                map.remove(tail.pre.key);</span><br><span class="line">                remove(tail.pre);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 插入新元素</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(key, value);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">            map.put(key, node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        node.pre.next = node.next;</span><br><span class="line">        node.next.pre = node.pre;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertToHead</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">firstNode</span> <span class="operator">=</span> head.next;</span><br><span class="line">        head.next = node;</span><br><span class="line">        firstNode.pre = node;</span><br><span class="line">        node.next = firstNode;</span><br><span class="line">        node.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>基本的缓存逻辑写好了，那么如何编写过期逻辑呢？这里采用的是惰性删除，如果查询该元素时，发现该元素已经过期，那么移除该元素。当插入元素时，需要遍历所有的key，然后删除，当然这个判断条件也可以是当缓存满了的时候再执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        Node pre, next;</span><br><span class="line">        <span class="type">int</span> key, value;</span><br><span class="line">        <span class="type">long</span> expireTime;</span><br><span class="line"></span><br><span class="line">        Node(<span class="type">int</span> key, <span class="type">int</span> value, <span class="type">long</span> expireTime) &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.expireTime = expireTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Node</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="type">Node</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    Map&lt;Integer, Node&gt; map;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提供初始化缓存的大小</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LRUCache</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(size);</span><br><span class="line">        head.next = tail;</span><br><span class="line">        tail.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 命中缓存，将其移动到队首</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            <span class="keyword">if</span> (node.expireTime &gt; System.currentTimeMillis()) &#123;</span><br><span class="line">                remove(node);</span><br><span class="line">                insertToHead(node);</span><br><span class="line">                res = node.value;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;当前节点过期：&quot;</span> + key);</span><br><span class="line">                remove(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value, <span class="type">long</span> expireTime)</span> &#123;</span><br><span class="line">        <span class="comment">// 删除所有过期的key</span></span><br><span class="line">        map.entrySet().removeIf(entry -&gt; &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> entry.getValue().expireTime &lt;= System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">if</span> (b) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;移除key：&quot;</span> + entry.getValue().key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 命中缓存，修改键值，并移动到队首</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="comment">// 1. 修改键值</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            node.value = value;</span><br><span class="line">            <span class="comment">// 移动到队首</span></span><br><span class="line">            remove(node);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 未命中缓存，判断缓存是否已满</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">mapSize</span> <span class="operator">=</span> map.size();</span><br><span class="line">            <span class="comment">// 已满则移除队尾元素</span></span><br><span class="line">            <span class="keyword">if</span> (mapSize == size) &#123;</span><br><span class="line">                map.remove(tail.pre.key);</span><br><span class="line">                remove(tail.pre);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 插入新元素</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(key, value, expireTime);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">            map.put(key, node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        node.pre.next = node.next;</span><br><span class="line">        node.next.pre = node.pre;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertToHead</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">firstNode</span> <span class="operator">=</span> head.next;</span><br><span class="line">        head.next = node;</span><br><span class="line">        firstNode.pre = node;</span><br><span class="line">        node.next = firstNode;</span><br><span class="line">        node.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>下面简单写个main方法验证一下，查看日志是否符合预期</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">LRUCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LRUCache</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请输入操作：get 或 put&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">operation</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;get&quot;</span>.equalsIgnoreCase(operation)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;请输入要获取的键：&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> scanner.nextInt();</span><br><span class="line">                scanner.nextLine(); <span class="comment">// 清除缓冲区中的换行符</span></span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line">                <span class="keyword">if</span> (value != -<span class="number">1</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;键 &quot;</span> + key + <span class="string">&quot; 对应的值为：&quot;</span> + value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;键 &quot;</span> + key + <span class="string">&quot; 不存在或已过期&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;put&quot;</span>.equalsIgnoreCase(operation)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;请输入要放入的键：&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> scanner.nextInt();</span><br><span class="line">                System.out.println(<span class="string">&quot;请输入要放入的值：&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> scanner.nextInt();</span><br><span class="line">                System.out.println(<span class="string">&quot;请输入过期时间（毫秒）：&quot;</span>);</span><br><span class="line">                <span class="type">long</span> <span class="variable">expireTime</span> <span class="operator">=</span> scanner.nextLong();</span><br><span class="line">                scanner.nextLine();</span><br><span class="line"></span><br><span class="line">                cache.put(key, value, System.currentTimeMillis() + expireTime);</span><br><span class="line">                System.out.println(<span class="string">&quot;键值对已放入缓存&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;无效的操作，请重新输入&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">最近有些懈怠了，刷刷题，这种底层实现还是挺有意思的</summary>
    
    
    
    <category term="踩坑日记" scheme="https://cyborg2077.github.io/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Navicat在结构同步时的注意事项</title>
    <link href="https://cyborg2077.github.io/2024/02/07/NavicatSyncPit/"/>
    <id>https://cyborg2077.github.io/2024/02/07/NavicatSyncPit/</id>
    <published>2024-02-07T03:27:30.000Z</published>
    <updated>2024-02-24T05:54:32.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="涉及到列名修改时，不要使用Navicat结构同步工具"><a href="#涉及到列名修改时，不要使用Navicat结构同步工具" class="headerlink" title="涉及到列名修改时，不要使用Navicat结构同步工具"></a>涉及到列名修改时，不要使用Navicat结构同步工具</h1><ul><li>本地环境的表结构如下</li></ul><div class="table-container"><table><thead><tr><th>id</th><th>phone</th><th>invite_code</th></tr></thead><tbody><tr><td>1</td><td>123-456-789</td><td>ABC123</td></tr><tr><td>2</td><td>987-654-321</td><td>DEF456</td></tr><tr><td>3</td><td>555-555-555</td><td>GHI789</td></tr></tbody></table></div><ul><li>生产环境的表结构如下</li></ul><div class="table-container"><table><thead><tr><th>id</th><th>phone</th><th>user_id</th></tr></thead><tbody><tr><td>1</td><td>123-456-789</td><td>ABC123</td></tr><tr><td>2</td><td>987-654-321</td><td>DEF456</td></tr><tr><td>3</td><td>555-555-555</td><td>GHI789</td></tr></tbody></table></div><ul><li><p>若此时使用Navicat提供的结构同步工具，实际上执行的命令会是将原有的列删除，然后再新增，会导致该列的内容完全丢失</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> `invite_code`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">DROP</span> INDEX `idx_invite_code`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> `user_id` <span class="type">varchar</span>(<span class="number">255</span>) AFTER `phone`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">ADD</span> INDEX `idx_invite_code`(`user_id` <span class="keyword">ASC</span>) <span class="keyword">USING</span> BTREE;</span><br></pre></td></tr></table></figure></li><li><p>若仅修改字段名，建议使用RENAME命令</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> user_info </span><br><span class="line">RENAME <span class="keyword">COLUMN</span> invite_code <span class="keyword">TO</span> user_id</span><br></pre></td></tr></table></figure></li><li>若还涉及到字段定义修改，建议使用CHANGE COLUMN命令<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> user_info</span><br><span class="line">CHANGE <span class="keyword">COLUMN</span> invite_code user_id <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">在修改字段名时，Navicat提供的SQL是先删除这列再新增</summary>
    
    
    
    <category term="踩坑日记" scheme="https://cyborg2077.github.io/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>LangChain入门指南</title>
    <link href="https://cyborg2077.github.io/2024/01/26/LangChainPrimer/"/>
    <id>https://cyborg2077.github.io/2024/01/26/LangChainPrimer/</id>
    <published>2024-01-26T03:27:30.000Z</published>
    <updated>2024-02-24T05:54:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="什么是LangChain"><a href="#什么是LangChain" class="headerlink" title="什么是LangChain"></a>什么是LangChain</h1><ul><li>LangChain是一个强大的框架，旨在帮助开发人员使用语言模型构建端到端的应用程序。它提供了一套工具、组件和接口，可简化创建由大型语言模型 (LLM) 和聊天模型提供支持的应用程序的过程。LangChain 可以轻松管理与语言模型的交互，将多个组件链接在一起，并集成额外的资源，例如 API 和数据库。</li><li>官方文档：<a href="https://python.langchain.com/en/latest/">https://python.langchain.com/en/latest/</a></li></ul><h1 id="如何使用LangChain"><a href="#如何使用LangChain" class="headerlink" title="如何使用LangChain"></a>如何使用LangChain</h1><ul><li>要使用 LangChain，开发人员首先要导入必要的组件和工具，例如 LLMs, chat models, agents, chains, 内存功能。这些组件组合起来创建一个可以理解、处理和响应用户输入的应用程序。</li><li>LangChain 为特定用例提供了多种组件，例如个人助理、文档问答、聊天机器人、查询表格数据、与 API 交互、提取、评估和汇总。</li></ul><h1 id="LangChain的模型"><a href="#LangChain的模型" class="headerlink" title="LangChain的模型"></a>LangChain的模型</h1><ul><li>LangChain model 是一种抽象，表示框架中使用的不同类型的模型。LangChain 中的模型主要分为三类：<ol><li>LLM（大型语言模型）：这些模型将文本字符串作为输入并返回文本字符串作为输出。它们是许多语言模型应用程序的支柱。</li><li>聊天模型( Chat Model)：聊天模型由语言模型支持，但具有更结构化的 API。他们将聊天消息列表作为输入并返回聊天消息。这使得管理对话历史记录和维护上下文变得容易。</li><li>文本嵌入模型(Text Embedding Models)：这些模型将文本作为输入并返回表示文本嵌入的浮点列表。这些嵌入可用于文档检索、聚类和相似性比较等任务。</li></ol></li></ul><h1 id="LangChain-的主要特点"><a href="#LangChain-的主要特点" class="headerlink" title="LangChain 的主要特点"></a>LangChain 的主要特点</h1><ul><li>LangChain 旨在为六个主要领域的开发人员提供支持：<ol><li>LLM 和提示：LangChain 使管理提示、优化它们以及为所有 LLM 创建通用界面变得容易。此外，它还包括一些用于处理 LLM 的便捷实用程序。</li><li>链(Chain)：这些是对 LLM 或其他实用程序的调用序列。LangChain 为链提供标准接口，与各种工具集成，为流行应用提供端到端的链。</li><li>数据增强生成：LangChain 使链能够与外部数据源交互以收集生成步骤的数据。例如，它可以帮助总结长文本或使用特定数据源回答问题。</li><li>Agents：Agents 让 LLM 做出有关行动的决定，采取这些行动，检查结果，并继续前进直到工作完成。LangChain 提供了代理的标准接口，多种代理可供选择，以及端到端的代理示例。</li><li>内存：LangChain 有一个标准的内存接口，有助于维护链或代理调用之间的状态。它还提供了一系列内存实现和使用内存的链或代理的示例。</li><li>评估：很难用传统指标评估生成模型。这就是为什么 LangChain 提供提示和链来帮助开发者自己使用 LLM 评估他们的模型。</li></ol></li></ul><h1 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h1><h2 id="提示模板（PromptTemplate）"><a href="#提示模板（PromptTemplate）" class="headerlink" title="提示模板（PromptTemplate）"></a>提示模板（PromptTemplate）</h2><ol><li>支持我们来自定义提示模板，不会将用户输入直接发送到 LLM，而是接收用户的输入，然后构造一个prompt将其发送给 LLM。<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts import PromptTemplate</span><br><span class="line"></span><br><span class="line">prompt = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;paperTitle&quot;</span>, <span class="string">&quot;area&quot;</span>, <span class="string">&quot;nums&quot;</span>, <span class="string">&quot;keywords&quot;</span>],</span><br><span class="line">    <span class="attribute">template</span>=<span class="string">&quot;我想让你充当&#123;area&#125;领域的专家，针对于&#123;paperTitle&#125;这个主题，帮我撰写一篇&#123;nums&#125;字的文献综述。包含的关键字如下：&#123;keywords&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(prompt.format(<span class="attribute">paperTitle</span>=<span class="string">&quot;大学生网红产品消费行为研究&quot;</span>, <span class="attribute">area</span>=<span class="string">&quot;经济学&quot;</span>, <span class="attribute">nums</span>=500, <span class="attribute">keywords</span>=<span class="string">&quot;大学生、网红、消费、行为研究&quot;</span>))</span><br><span class="line"><span class="comment"># 输出：我想让你充当经济学领域的专家，针对于大学生网红产品消费行为研究这个主题，帮我撰写一篇500字的文献综述。包含的关键字如下：大学生、网红、消费、行为研究</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="LLM-Chain"><a href="#LLM-Chain" class="headerlink" title="LLM Chain"></a>LLM Chain</h2><ul><li>我们可以把初始化好的LLM和Template，组合成一个chain<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 初始化llm</span></span><br><span class="line">llm = ChatOpenAI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里其实就可以直接调用llm了</span></span><br><span class="line">llm.invoke(<span class="string">&quot;how can langsmith help with testing?&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 这里可以初始化一个模板</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line">prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;你是世界上最好的科幻小说作者&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 采用这种方式可以将llm和template组合成一个chain</span></span><br><span class="line">chain = prompt | llm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 调用组合后的chain</span></span><br><span class="line">chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;你对LangSmith了解吗？&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></li></ul><h2 id="Retrieval-Chain（基于检索的chain）"><a href="#Retrieval-Chain（基于检索的chain）" class="headerlink" title="Retrieval Chain（基于检索的chain）"></a>Retrieval Chain（基于检索的chain）</h2><ul><li>当你需要让LLM回答一个问题时（比如 “how can langsmith help with testing?”），有时候你要提供的提示信息可能太多，直接传递给语言模型可能不够有效。为了提供更多上下文，LangChain提供了通过检索（retrieval）的方式获取相关的文档，并将这些文档传递给语言模型。</li><li>在这个过程中，我们使用一个检索器（Retriever）来查找相关的文档，然后将这些文档传递给提示模板。检索器可以由各种数据支持，比如一个 SQL 表、互联网上的数据等，但在官网的Demo里，将使用一个向量存储（vector store）来作为检索器。</li><li>首先，我们需要加载要索引的数据。为了做到这一点，我们将使用 WebBaseLoader（这个应该是LangChain内部实现的一个爬虫工具，要依赖于BeautifulSoup<br>pip install beautifulsoup4</li><li><p>引入WebBaseLocder来爬取内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> WebBaseLoader</span><br><span class="line"></span><br><span class="line">loader = WebBaseLoader(<span class="string">&quot;https://docs.smith.langchain.com/overview&quot;</span>)</span><br><span class="line">docs = loader.load()</span><br><span class="line"><span class="built_in">print</span>(docs)</span><br><span class="line"><span class="comment"># [Document(page_content=&#x27;\n\n\n\n\nLangSmith Overview and User Guide | 🦜️🛠️ LangSmith\n\n\n\n\n\nSkip to main content🦜️🛠️ LangSmith DocsPython DocsJS/TS DocsSearchGo to AppLangSmithOverviewTracingTesting &amp; EvaluationOrganizationsHubLangSmith CookbookOverviewOn this pageLangSmith Overview and User GuideBuilding reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.Over the past two months, we at LangChain have been building and using LangSmith with the goal of bridging this gap. This is our tactical user guide to outline effective ways to use LangSmith and maximize its benefits.On by default\u200bAt LangChain, all of us have LangSmith’s tracing running in the background by default. On the Python side, this is achieved by setting environment variables, which we establish whenever we launch a virtual environment or open our bash shell and leave them set. The same principle applies to most JavaScript environments through process.env1.The benefit here is that all calls to LLMs, chains, agents, tools, and retrievers are logged to LangSmith. Around 90% of the time we don’t even look at the traces, but the 10% of the time that we do… it’s so helpful. We can use LangSmith to debug:An unexpected end resultWhy an agent is loopingWhy a chain was slower than expectedHow many tokens an agent usedDebugging\u200bDebugging LLMs, chains, and agents can be tough. LangSmith helps solve the following pain points:What was the exact input to the LLM?\u200bLLM calls are often tricky and non-deterministic. The inputs/outputs may seem straightforward, given they are technically string → string (or chat messages → chat message), but this can be misleading as the input string is usually constructed from a combination of user input and auxiliary functions.Most inputs to an LLM call are a combination of some type of fixed template along with input variables. These input variables could come directly from user input or from an auxiliary function (like retrieval). By the time these input variables go into the LLM they will have been converted to a string format, but often times they are not naturally represented as a string (they could be a list, or a Document object). Therefore, it is important to have visibility into what exactly the final string going into the LLM is. This has helped us debug bugs in formatting logic, unexpected transformations to user input, and straight up missing user input.To a much lesser extent, this is also true of the output of an LLM. Oftentimes the output of an LLM is technically a string but that string may contain some structure (json, yaml) that is intended to be parsed into a structured representation. Understanding what the exact output is can help determine if there may be a need for different parsing.LangSmith provides a straightforward visualization of the exact inputs/outputs to all LLM calls, so you can easily understand them.If I edit the prompt, how does that affect the output?\u200bSo you notice a bad output, and you go into LangSmith to see what\&#x27;s going on. You find the faulty LLM call and are now looking at the exact input. You want to try changing a word or a phrase to see what happens -- what do you do?We constantly ran into this issue. Initially, we copied the prompt to a playground of sorts. But this got annoying, so we built a playground of our own! When examining an LLM call, you can click the Open in Playground button to access this playground. Here, you can modify the prompt and re-run it to observe the resulting changes to the output - as many times as needed!Currently, this feature supports only OpenAI and Anthropic models and works for LLM and Chat Model calls. We plan to extend its functionality to more LLM types, chains, agents, and retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith\&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we\&#x27;ve added a “Share” button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it\&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, it’s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you\&#x27;re wandering blind. You don’t have any examples to benchmark your changes against.LangSmith addresses this problem by including an “Add to Dataset” button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different\ninputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat we’ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If we’re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.\nYou can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.We’ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing — mirroring the debug mode approach.We’ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We\&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these aren’t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.↩PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright © 2024 LangChain, Inc.\n\n\n\n&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)]</span></span><br><span class="line"><span class="comment"># 这里输出的docs就是网页上的内容</span></span><br></pre></td></tr></table></figure></li><li><p>然后我们需要将这些文档索引到一个向量存储中。这需要一些组件，包括嵌入模型（embedding model）和向量存储。</p><ol><li>检索器（Retriever）： 想象一下你在图书馆找书的时候，你可能不会把整个图书馆的书都拿去看。相反，你可能会咨询图书管理员或者查找图书馆的目录，找到与你问题相关的书籍。在这里，检索器就像图书馆的目录，它帮助我们找到与问题相关的信息。</li><li>向量存储（Vector Store）： 这就像一个大仓库，里面存放着各种各样的信息。每个信息都用一个向量表示，就像是仓库中的一个箱子。通过这些向量，我们可以快速找到存储库中与我们关心的主题相关的信息。</li><li>嵌入模型（Embedding Model）： 这就像是一个翻译工人，它将文档中的文字翻译成计算机能够理解的形式，也就是向量。这样，计算机就能够更好地处理和比较文档，找到最相关的信息。</li></ol></li></ul><h2 id="根据文档构建向量"><a href="#根据文档构建向量" class="headerlink" title="根据文档构建向量"></a>根据文档构建向量</h2><ol><li><p>使用 OpenAIEmbeddings 初始化一个嵌入模型，用于将文档转化为向量。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"></span><br><span class="line">embeddings = OpenAIEmbeddings()</span><br></pre></td></tr></table></figure></li><li><p>使用一个简单的本地向量存储 FAISS 来建立索引.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install faiss-cpu</span><br></pre></td></tr></table></figure></li><li>构建向量存储<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文本分割器</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter()</span><br><span class="line"><span class="comment"># 将刚刚获取的docs分割，输出是一个List&lt;String&gt;的类型</span></span><br><span class="line">documents = text_splitter.split_documents(docs)</span><br><span class="line"><span class="comment"># 根据嵌入模型和分割后的文档，转换为向量</span></span><br><span class="line">vector = FAISS.from_documents(documents, embeddings)</span><br></pre></td></tr></table></figure></li></ol><h2 id="构建链"><a href="#构建链" class="headerlink" title="构建链"></a>构建链</h2><ol><li><p>构建一个链，该链接受问题和检索到的文档，生成答案：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.combine_documents <span class="keyword">import</span> create_stuff_documents_chain</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;Answer the following question based only on the provided context:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;context&gt;</span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string">&lt;/context&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Question: &#123;input&#125;&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">document_chain = create_stuff_documents_chain(llm, prompt)</span><br></pre></td></tr></table></figure></li><li><p>使用检索器动态选择最相关的文档并传递给链：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_retrieval_chain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里的vector是我们第一步构建的向量，将其转换为检索器</span></span><br><span class="line">retriever = vector.as_retriever()</span><br><span class="line">retrieval_chain = create_retrieval_chain(retriever, document_chain)</span><br></pre></td></tr></table></figure></li><li>调用这个链，来获取响应结果，这个答案应该更加准确，因为它结合了检索到的相关文档和原始问题。这整个过程就是为了使得语言模型在回答问题时能够基于更全面的上下文信息。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = retrieval_chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;how can langsmith help with testing?&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></li></ol><h2 id="完整demo"><a href="#完整demo" class="headerlink" title="完整demo"></a>完整demo</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_retrieval_chain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.combine_documents <span class="keyword">import</span> create_stuff_documents_chain</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> WebBaseLoader</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.ollama <span class="keyword">import</span> Ollama</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores.faiss <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> OllamaEmbeddings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">llm = Ollama(model=<span class="string">&quot;llama2&quot;</span>)</span><br><span class="line"><span class="comment"># 初始化嵌入模型</span></span><br><span class="line"></span><br><span class="line">embeddings = OllamaEmbeddings()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 爬取内容</span></span><br><span class="line">loader = WebBaseLoader(<span class="string">&quot;https://docs.smith.langchain.com/overview&quot;</span>)</span><br><span class="line">docs = loader.load()</span><br><span class="line"><span class="built_in">print</span>(docs)</span><br><span class="line"><span class="comment"># 文本分割器</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter()</span><br><span class="line"><span class="comment"># 将刚刚获取的docs分割</span></span><br><span class="line">documents = text_splitter.split_documents(docs)</span><br><span class="line"><span class="built_in">print</span>(documents)</span><br><span class="line"><span class="comment"># 根据嵌入模型和分割后的文档，转换为向量</span></span><br><span class="line">vector = FAISS.from_documents(documents, embeddings)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;转换成向量完毕&quot;</span>)</span><br><span class="line"><span class="comment"># 将向量转换为检索器</span></span><br><span class="line">retriever = vector.as_retriever()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;将向量转换为检索器&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建问题链</span></span><br><span class="line">prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;Answer the following question based only on the provided context:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;context&gt;</span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string">&lt;/context&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Question: &#123;input&#125;&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">document_chain = create_stuff_documents_chain(llm, prompt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;构建问题完毕&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用检索器动态选择最相关的文档并传递给链：</span></span><br><span class="line">retrieval_chain = create_retrieval_chain(retriever, document_chain)</span><br><span class="line"><span class="comment"># 最终调用</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;开始调用&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = retrieval_chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;how can langsmith help with testing?&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;调用完毕&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure><ul><li>输出如下<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Document(page_content=<span class="comment">&#x27;\n\n\n\n\nLangSmith Overview and User Guide | 🦜️🛠️ LangSmith\n\n\n\n\n\nSkip to main content🦜️🛠️ LangSmith DocsPython DocsJS/TS DocsSearchGo to AppLangSmithOverviewTracingTesting &amp; EvaluationOrganizationsHubLangSmith CookbookOverviewOn this pageLangSmith Overview and User GuideBuilding reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.Over the past two months, we at LangChain have been building and using LangSmith with the goal of bridging this gap. This is our tactical user guide to outline effective ways to use LangSmith and maximize its benefits.On by default\u200bAt LangChain, all of us have LangSmith’s tracing running in the background by default. On the Python side, this is achieved by setting environment variables, which we establish whenever we launch a virtual environment or open our bash shell and leave them set. The same principle applies to most JavaScript environments through process.env1.The benefit here is that all calls to LLMs, chains, agents, tools, and retrievers are logged to LangSmith. Around 90% of the time we don’t even look at the traces, but the 10% of the time that we do… it’s so helpful. We can use LangSmith to de<span class="doctag">bug:</span>An unexpected end resultWhy an agent is loopingWhy a chain was slower than expectedHow many tokens an agent usedDebugging\u200bDebugging LLMs, chains, and agents can be tough. LangSmith helps solve the following pain points:What was the exact input to the LLM?\u200bLLM calls are often tricky and non-deterministic. The inputs/outputs may seem straightforward, given they are technically string → string (or chat messages → chat message), but this can be misleading as the input string is usually constructed from a combination of user input and auxiliary functions.Most inputs to an LLM call are a combination of some type of fixed template along with input variables. These input variables could come directly from user input or from an auxiliary function (like retrieval). By the time these input variables go into the LLM they will have been converted to a string format, but often times they are not naturally represented as a string (they could be a list, or a Document object). Therefore, it is important to have visibility into what exactly the final string going into the LLM is. This has helped us debug bugs in formatting logic, unexpected transformations to user input, and straight up missing user input.To a much lesser extent, this is also true of the output of an LLM. Oftentimes the output of an LLM is technically a string but that string may contain some structure (json, yaml) that is intended to be parsed into a structured representation. Understanding what the exact output is can help determine if there may be a need for different parsing.LangSmith provides a straightforward visualization of the exact inputs/outputs to all LLM calls, so you can easily understand them.If I edit the prompt, how does that affect the output?\u200bSo you notice a bad output, and you go into LangSmith to see what\&#x27;s going on. You find the faulty LLM call and are now looking at the exact input. You want to try changing a word or a phrase to see what happens -- what do you do?We constantly ran into this issue. Initially, we copied the prompt to a playground of sorts. But this got annoying, so we built a playground of our own! When examining an LLM call, you can click the Open in Playground button to access this playground. Here, you can modify the prompt and re-run it to observe the resulting changes to the output - as many times as needed!Currently, this feature supports only OpenAI and Anthropic models and works for LLM and Chat Model calls. We plan to extend its functionality to more LLM types, chains, agents, and retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith\&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we\&#x27;ve added a “Share” button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it\&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, it’s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you\&#x27;re wandering blind. You don’t have any examples to benchmark your changes against.LangSmith addresses this problem by including an “Add to Dataset” button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different\ninputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat we’ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If we’re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.\nYou can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.We’ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing — mirroring the debug mode approach.We’ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We\&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these aren’t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.↩PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright © 2024 LangChain, Inc.\n\n\n\n&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)]</span></span><br><span class="line">[Document(page_content=<span class="comment">&#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;Skip to main content🦜️🛠️ LangSmith DocsPython DocsJS/TS DocsSearchGo to AppLangSmithOverviewTracingTesting &amp; EvaluationOrganizationsHubLangSmith CookbookOverviewOn this pageLangSmith Overview and User GuideBuilding reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.Over the past two months, we at LangChain have been building and using LangSmith with the goal of bridging this gap. This is our tactical user guide to outline effective ways to use LangSmith and maximize its benefits.On by default\u200bAt LangChain, all of us have LangSmith’s tracing running in the background by default. On the Python side, this is achieved by setting environment variables, which we establish whenever we launch a virtual environment or open our bash shell and leave them set. The same principle applies to most JavaScript environments through process.env1.The benefit here is that all calls to LLMs, chains, agents, tools, and retrievers are logged to LangSmith. Around 90% of the time we don’t even look at the traces, but the 10% of the time that we do… it’s so helpful. We can use LangSmith to de<span class="doctag">bug:</span>An unexpected end resultWhy an agent is loopingWhy a chain was slower than expectedHow many tokens an agent usedDebugging\u200bDebugging LLMs, chains, and agents can be tough. LangSmith helps solve the following pain points:What was the exact input to the LLM?\u200bLLM calls are often tricky and non-deterministic. The inputs/outputs may seem straightforward, given they are technically string → string (or chat messages → chat message), but this can be misleading as the input string is usually constructed from a combination of user input and auxiliary functions.Most inputs to an LLM call are a combination of some type of fixed template along with input variables. These input variables could come directly from user input or from an auxiliary function (like retrieval). By the time these input variables go into the LLM they will have been converted to a string format, but often times they are not naturally represented as a string (they could be a list, or a Document object). Therefore, it is important to have visibility into what exactly the final string going into the LLM is. This has helped us debug bugs in formatting logic, unexpected transformations to user input, and straight up missing user input.To a much lesser extent, this is also true of the output of an LLM. Oftentimes the output of an LLM is technically a string but that string may contain some structure (json, yaml) that is intended to be parsed into a structured representation. Understanding what the exact output is can help determine if there may be a need for different parsing.LangSmith provides a straightforward visualization of the exact inputs/outputs to all LLM calls, so you can easily understand them.If I edit the prompt, how does that affect the output?\u200bSo you notice a bad output, and you go into LangSmith to see what&#x27;s going on. You find the faulty LLM call and are now looking at the exact input. You want to try changing a word or a phrase to see what happens -- what do you do?We constantly ran into this issue. Initially, we copied the prompt to a playground of sorts. But this got annoying, so we built a playground of our own! When examining an LLM call, you can click the Open in Playground button to access this playground. Here, you can modify the prompt and re-run it to observe the resulting changes to the output - as many times as needed!Currently, this feature supports only OpenAI and Anthropic models and works for LLM and Chat Model calls. We plan to extend its functionality to more LLM types, chains, agents, and retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we&#x27;ve added a “Share” button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, it’s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you&#x27;re wandering blind. You don’t have any examples to benchmark your changes against.LangSmith addresses this problem by including an “Add to Dataset” button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&#x27;inputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat we’ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If we’re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;You can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.We’ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing — mirroring the debug mode approach.We’ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these aren’t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.↩PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright © 2024 LangChain, Inc.&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)]</span></span><br><span class="line">转换成向量完毕</span><br><span class="line">将向量转换为检索器</span><br><span class="line">构建问题完毕</span><br><span class="line">开始调用</span><br><span class="line">调用完毕</span><br><span class="line">&#123;<span class="comment">&#x27;input&#x27;: &#x27;how can langsmith help with testing?&#x27;, &#x27;context&#x27;: [Document(page_content=&quot;You can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.We’ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing — mirroring the debug mode approach.We’ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these aren’t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.↩PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright © 2024 LangChain, Inc.&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&#x27;inputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat we’ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If we’re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we&#x27;ve added a “Share” button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, it’s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you&#x27;re wandering blind. You don’t have any examples to benchmark your changes against.LangSmith addresses this problem by including an “Add to Dataset” button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | 🦜️🛠️ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)], &#x27;answer&#x27;: &#x27;LangSmith can assist with testing by providing various features to simplify dataset uploading, running chains over the data points, visualizing the outputs, and evaluating the results. Here are some ways LangSmith can help with testing:\n\n1. Easy dataset uploading: LangSmith simplifies dataset uploading, making it easier to construct a small dataset by hand or use an existing one.\n2. Running chains over data points: Once you have a dataset, LangSmith allows you to run the chain over the data points and visualize the outputs. You can review the outputs directly in the web app by assigning feedback to runs and marking them as correct or incorrect.\n3. Evaluating results: LangSmith adds a set of evaluators to the open-source LangChain library, which can be specified when initiating a test run. These evaluators will evaluate the results once the test run completes, providing valuable information for guiding your eye to examples you should look at.\n4. Manual testing and annotation: LangSmith makes it easy to manually review and annotate runs through a visualization of the sequence of events, helping identify subjective qualities that automatic evaluators struggle with.\n5. Tracking token usage: LangSmith tracks the total token usage for a chain and the token usage of each step, making it easier to identify potentially costly parts of the chain.\n6. Collecting examples: LangSmith includes an &quot;Add to Dataset&quot; button for each run, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model. This feature is available at every step of a nested chain, making it easier to test the overall flow and individual components.\n\nBy leveraging these features, LangSmith can help streamline your testing process and provide valuable insights into your LLM application\&#x27;s performance.&#x27;&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="Conversation-Retrieval-Chain（对话检索链）"><a href="#Conversation-Retrieval-Chain（对话检索链）" class="headerlink" title="Conversation Retrieval Chain（对话检索链）"></a>Conversation Retrieval Chain（对话检索链）</h2><ul><li>我们刚刚创建的链只能回答单一的问题，但有些应用场景需要构建对话型的聊天机器人。</li><li><p>为了实现这一点，我们仍然可以使用create_retrieval_chain函数，但是我们需要改变两件事：</p><ul><li>检索方法现在不应仅适用于最近的输入，而应考虑整个历史记录。</li><li>最终的 LLM 链同样应该考虑整个历史<br>更新检索（retrieval）<br>我们创建了一个新的链，这个链将接受最近的用户输入（input）和整个对话历史（chat_history），然后使用语言模型生成一个搜索查询。这里使用了 create_history_aware_retriever 函数来实现这个新链。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_history_aware_retriever</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> MessagesPlaceholder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个提示模板，用于根据对话历史生成搜索查询</span></span><br><span class="line">prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;chat_history&quot;</span>),  <span class="comment"># 对话历史的占位符</span></span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),  <span class="comment"># 用户输入的占位符</span></span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;在上述对话的基础上，生成一个搜索查询，以获取与对话相关的信息&quot;</span>)  <span class="comment"># 生成搜索查询的指令，基于对话内容</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个检索器链，整合语言模型、检索器和定义的提示</span></span><br><span class="line">retriever_chain = create_history_aware_retriever(llm, retriever, prompt)</span><br></pre></td></tr></table></figure></li></ul></li><li><p>我们可以传入后续的问题实例来测试这一点</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage, AIMessage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义对话历史，包括人类消息和AI消息</span></span><br><span class="line">chat_history = [HumanMessage(content=<span class="string">&quot;LangSmith可以帮助我测试App吗？&quot;</span>), AIMessage(content=<span class="string">&quot;Yes!&quot;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用检索器链，传入对话历史和用户输入</span></span><br><span class="line">retriever_chain.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;chat_history&quot;</span>: chat_history,</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;告诉我怎么做&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li>此时的输出应该是会返回有关 LangSmith 中测试的文档。这是因为LLM生成了一个新查询，将聊天历史记录与后续问题相结合。</li><li><p>现在我们有了这个新的检索器，我们可以创建一个新的链来继续与这些检索到的文档进行对话。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">prompt</span> = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;根据上下文回答用户的问题\n\n&#123;context&#125;&quot;</span>),</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;chat_history&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="attr">document_chain</span> = create_stuff_documents_chain(llm, prompt)</span><br><span class="line"><span class="attr">retrieval_chain</span> = create_retrieval_chain(retriever_chain, document_chain)</span><br></pre></td></tr></table></figure></li><li><p>现在进行整体的测试：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chat_history = [HumanMessage(content=<span class="string">&quot;LangSmith可以帮助我测试App吗？&quot;</span>), AIMessage(content=<span class="string">&quot;Yes!&quot;</span>)]</span><br><span class="line"></span><br><span class="line">retriever_chain.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;chat_history&quot;</span>: chat_history,</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;告诉我怎么做&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p>会出了一个连贯的答案，表明我们已经成功地将检索链变成了聊天机器人</p></li></ul><h2 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h2><ul><li><p>构建代理时要做的第一件事就是决定它应该有权访问哪些工具。在此示例中，我们将为代理提供两个工具的访问权限：</p><ol><li><p>我们刚刚创建的检索器。这将让它轻松回答有关 LangSmith 的问题</p><ul><li>首先，让我们为刚刚创建的检索器设置一个工具：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.tools.retriever <span class="keyword">import</span> create_retriever_tool</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个检索器就是刚刚爬取LongSmith文档的内容，生成的检索器</span></span><br><span class="line">retriever_tool = create_retriever_tool(</span><br><span class="line">    retriever,</span><br><span class="line">    <span class="string">&quot;langsmith_search&quot;</span>,</span><br><span class="line">    <span class="string">&quot;搜索有关LangSmith的信息或者有关LangSmith的任何问题，必须使用这个工具！&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li></ul></li><li><p>一个搜索工具。这将使它能够轻松回答需要最新信息的问题。</p><ul><li>官网示例中使用的搜索工具是Tavily，需要一个 API 密钥（有免费套餐）。在他们的平台上创建后，需要将其设置为环境变量<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.tools.tavily_search <span class="keyword">import</span> TavilySearchResults</span><br><span class="line"></span><br><span class="line">search = TavilySearchResults()</span><br></pre></td></tr></table></figure></li><li>我们现在可以创建我们想要使用的工具的列表：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tools = [retriever_tool, search]</span><br></pre></td></tr></table></figure></li><li>现在我们有了工具，我们可以创建一个代理来使用它们。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这个可以拉取预定义好的prompt</span></span><br><span class="line">pip install langchainhub</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> hub</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_openai_functions_agent</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取别人预定义好的prompt</span></span><br><span class="line">prompt = hub.pull(<span class="string">&quot;hwchase17/openai-functions-agent&quot;</span>)</span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">agent = create_openai_functions_agent(llm, tools, prompt)</span><br><span class="line">agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li><li>调用<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agent_executor.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;LangSmith可以帮助我测试App吗？&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></li></ul></li></ol></li></ul><h2 id="构建服务"><a href="#构建服务" class="headerlink" title="构建服务"></a>构建服务</h2><ul><li>LangServe 可以帮助开发人员将 LangChain 链部署为 REST API。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> WebBaseLoader</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain.tools.retriever <span class="keyword">import</span> create_retriever_tool</span><br><span class="line"><span class="keyword">from</span> langchain_community.tools.tavily_search <span class="keyword">import</span> TavilySearchResults</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> hub</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_openai_functions_agent</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor</span><br><span class="line"><span class="keyword">from</span> langchain.pydantic_v1 <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"><span class="keyword">from</span> langserve <span class="keyword">import</span> add_routes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 加载检索器（Retriever）</span></span><br><span class="line"><span class="comment"># 首先，通过 WebBaseLoader 从 LangChain 文档网站加载文档数据。然后，使用 RecursiveCharacterTextSplitter 将文档分割为文档片段，并使用 OpenAIEmbeddings 将文档片段嵌入为向量。最后，使用 FAISS 创建一个向量存储作为检索器。</span></span><br><span class="line">loader = WebBaseLoader(<span class="string">&quot;https://docs.smith.langchain.com/overview&quot;</span>)</span><br><span class="line">docs = loader.load()</span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter()</span><br><span class="line">documents = text_splitter.split_documents(docs)</span><br><span class="line">embeddings = OpenAIEmbeddings()</span><br><span class="line">vector = FAISS.from_documents(documents, embeddings)</span><br><span class="line">retriever = vector.as_retriever()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建工具（Tools）</span></span><br><span class="line"><span class="comment"># 创建两个工具：一个是之前创建的检索器工具 retriever_tool，另一个是 Tavily 搜索工具 search。</span></span><br><span class="line">retriever_tool = create_retriever_tool(</span><br><span class="line">    retriever,</span><br><span class="line">    <span class="string">&quot;langsmith_search&quot;</span>,</span><br><span class="line">    <span class="string">&quot;搜索有关LangSmith的信息或者有关LangSmith的任何问题，必须使用这个工具！&quot;</span>,</span><br><span class="line">)</span><br><span class="line">search = TavilySearchResults()</span><br><span class="line">tools = [retriever_tool, search]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 创建代理</span></span><br><span class="line"><span class="comment"># 使用 LangChain Hub 中提供的预定义提示（自己构建也可以），创建一个使用 OpenAI 模型和工具的代理。这个代理被设置为能够决定在处理问题时使用哪些工具。</span></span><br><span class="line">prompt = hub.pull(<span class="string">&quot;hwchase17/openai-functions-agent&quot;</span>)</span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">agent = create_openai_functions_agent(llm, tools, prompt)</span><br><span class="line">agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. FastAPI 定义</span></span><br><span class="line">app = FastAPI(</span><br><span class="line">  title=<span class="string">&quot;LangChain Server&quot;</span>,</span><br><span class="line">  version=<span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  description=<span class="string">&quot;A simple API server using LangChain&#x27;s Runnable interfaces&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 添加链路由</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过调用 add_routes 函数，将代理链添加为 FastAPI 应用的一个路由，从而可以通过 /agent 路径访问代理链。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Input</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">input</span>: <span class="built_in">str</span></span><br><span class="line">    chat_history: <span class="type">List</span>[BaseMessage] = Field(</span><br><span class="line">        ...,</span><br><span class="line">        extra=&#123;<span class="string">&quot;widget&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;chat&quot;</span>, <span class="string">&quot;input&quot;</span>: <span class="string">&quot;location&quot;</span>&#125;&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Output</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    output: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">add_routes(</span><br><span class="line">    app,</span><br><span class="line">    agent_executor.with_types(input_type=Input, output_type=Output),</span><br><span class="line">    path=<span class="string">&quot;/agent&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">    uvicorn.run(app, host=<span class="string">&quot;localhost&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure></li></ul><h1 id="链的概念（补充）"><a href="#链的概念（补充）" class="headerlink" title="链的概念（补充）"></a>链的概念（补充）</h1><ul><li>链（Chains）通常将大语言模型（LLM）与提示（Prompt）结合在一起，基于此，我们可以对文本或数据进行一系列操作。链（Chains）可以一次性接受多个输入。例如，我们可以创建一个链，该链接受用户输入，使用提示模板对其进行格式化，然后将格式化的响应传递给 LLM 。我们可以通过将多个链组合在一起，或者通过将链与其他组件组合在一起来构建更复杂的链。</li></ul><h2 id="顺序链（SequentialChains）"><a href="#顺序链（SequentialChains）" class="headerlink" title="顺序链（SequentialChains）"></a>顺序链（SequentialChains）</h2><ul><li><p>是按预定义顺序执行其链接的链。具体来说，我们将使用简单顺序链（SimpleSequentialChain），这是顺序链的最简单类型，其中每个步骤都有一个输入/输出，一个步骤的输出是下一个步骤的输入。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms <span class="keyword">import</span> Tongyi</span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain, SimpleSequentialChain</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line">prompt1 = ChatPromptTemplate.from_template(<span class="string">&quot;你现在是写作领域的大师，现在为&#123;title&#125;这篇文章生成一些大纲吧。&quot;</span>)</span><br><span class="line"></span><br><span class="line">chain_one = LLMChain(llm=llm, prompt=prompt1)</span><br><span class="line"></span><br><span class="line">prompt2 = ChatPromptTemplate.from_template(<span class="string">&quot;根据这个大纲：&#123;toc&#125;，生成每个章节对应的内容吧。&quot;</span>)</span><br><span class="line"></span><br><span class="line">chain_two = LLMChain(llm=llm, prompt=prompt2)</span><br><span class="line"></span><br><span class="line">chain = SimpleSequentialChain(chains=[chain_one, chain_two], verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    title = <span class="built_in">input</span>(<span class="string">&quot;请输入题目：&quot;</span>)</span><br><span class="line">    res = chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: title&#125;)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(res, indent=<span class="number">4</span>))</span><br></pre></td></tr></table></figure></li><li><p>执行结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">当然可以，以下是一个关于“大学生网红消费行为分析”的文章大纲：</span><br><span class="line"></span><br><span class="line">I. 引言</span><br><span class="line">   A. 网红经济的崛起与大学生消费者的概述</span><br><span class="line">   B. 大学生网红消费现象的重要性及研究背景</span><br><span class="line">   C. 文章的研究目的和意义</span><br><span class="line"></span><br><span class="line">II. 大学生网红消费者群体特征分析</span><br><span class="line">   A. 年龄、性别、专业等人口统计学特征</span><br><span class="line">   B. 大学生的网络使用习惯与社交媒体偏好</span><br><span class="line">   C. 大学生对网红的认可度与信任度</span><br><span class="line"></span><br><span class="line">III. 大学生网红消费行为的特点</span><br><span class="line">   A. 消费动机：从娱乐消遣到购物决策的影响</span><br><span class="line">   B. 消费品类偏向：时尚穿搭、美妆护肤、电子产品等方面的消费情况</span><br><span class="line">   C. 跟风消费与个性化消费需求的平衡</span><br><span class="line">   D. 情感因素在购买决策中的作用</span><br><span class="line"></span><br><span class="line">IV. 网红对大学生消费行为的影响机制</span><br><span class="line">   A. 网红的影响力来源：内容创作能力、人格魅力、口碑效应等</span><br><span class="line">   B. 网红营销策略对大学生消费心理的影响：情感共鸣、生活方式塑造、意见领袖角色</span><br><span class="line">   C. 网红广告与软性推广对大学生消费选择的引导</span><br><span class="line"></span><br><span class="line">V. 大学生网红消费行为的社会文化影响</span><br><span class="line">   A. 对大学生价值观塑造的影响</span><br><span class="line">   B. 社会审美趋势与消费观念的变化</span><br><span class="line">   C. 对校园文化和市场经济发展的启示</span><br><span class="line"></span><br><span class="line">VI. 结论</span><br><span class="line">   A. 大学生网红消费行为的主要特点及其成因总结</span><br><span class="line">   B. 对教育部门、企业、网红自身以及社会各方面应对大学生网红消费行为进行合理引导和规范的建议</span><br><span class="line">   C. 展望未来研究方向与可能性</span><br><span class="line"></span><br><span class="line">这个大纲旨在全面探讨大学生网红消费行为的现象、特点、成因以及其背后的社会文化影响，并针对相关各方提出有针对性的思考与建议。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面就是每个章节对应的内容</span></span><br><span class="line"></span><br><span class="line">I. 引言</span><br><span class="line">A. 网红经济的崛起与大学生消费者的概述</span><br><span class="line">随着互联网技术的发展和社交媒体平台的普及，网红经济作为一种新型商业模式在全球范围内迅速崛起。大学生作为网络主力军和新兴消费群体，他们对于网红的追捧和消费行为成为当前市场关注的热点。这一现象不仅反映出了网红经济的巨大潜力，也揭示了大学生在消费观念和行为上的新变化。</span><br><span class="line"></span><br><span class="line">B. 大学生网红消费现象的重要性及研究背景</span><br><span class="line">大学生网红消费现象日益普遍，其背后的消费心理、消费行为模式以及对社会文化的影响具有重要研究价值。通过深入探究这一现象，有助于理解新一代消费者的消费趋势，为相关企业和政策制定者提供针对性的策略指导。</span><br><span class="line"></span><br><span class="line">C. 文章的研究目的和意义</span><br><span class="line">本文旨在通过系统地研究大学生网红消费行为，揭示其特征、成因及其社会文化影响，为教育部门、企业、网红自身乃至整个社会提供理性应对这一现象的思路和建议，同时对未来相关研究领域的发展方向进行展望。</span><br><span class="line"></span><br><span class="line">II. 大学生网红消费者群体特征分析</span><br><span class="line">A. 年龄、性别、专业等人口统计学特征</span><br><span class="line">以在校大学生为主体的年轻消费人群主要集中在<span class="number">18</span>-<span class="number">24</span>岁年龄段，男女比例相对均衡，不同专业的学生可能由于兴趣爱好、审美取向等因素，在网红消费上表现出一定的差异。</span><br><span class="line"></span><br><span class="line">B. 大学生的网络使用习惯与社交媒体偏好</span><br><span class="line">当代大学生是互联网的重度使用者，他们在日常生活中广泛依赖于社交媒体平台获取信息、交流互动和娱乐休闲。尤其偏爱短视频、直播、微博等新媒体形式，这为网红传播内容提供了广阔的受众基础。</span><br><span class="line"></span><br><span class="line">C. 大学生对网红的认可度与信任度</span><br><span class="line">大学生普遍认为网红具备较高的潮流引领力和社交影响力，对于具有一定专业素养和亲和力的网红更容易产生认同感和信赖感，从而将其推荐的产品或服务纳入自己的消费考虑范围。</span><br><span class="line"></span><br><span class="line">III. 大学生网红消费行为的特点</span><br><span class="line">A. 消费动机：从娱乐消遣到购物决策的影响</span><br><span class="line">大学生在关注网红的过程中，最初可能出于娱乐消遣的需求，但逐渐地，网红所展示的生活方式、时尚品味以及产品体验等内容会影响他们的购物决策，使得消费行为由单纯的观赏转变为实际购买行为。</span><br><span class="line"></span><br><span class="line">B. 消费品类偏向：时尚穿搭、美妆护肤、电子产品等方面的消费情况</span><br><span class="line">大学生网红消费行为中，时尚穿搭、美妆护肤和个人电子产品是最常见的消费类别。这些商品往往与年轻人追求个性化、时尚化和高品质生活的需求相契合。</span><br><span class="line"></span><br><span class="line">C. 跟风消费与个性化消费需求的平衡</span><br><span class="line">大学生在网红消费过程中，既存在跟风模仿的现象，也注重个性表达和自我风格的塑造。他们会在一定程度上接受网红推荐的商品和服务，同时也根据个人喜好和实际情况做出选择，实现跟风与个性需求的动态平衡。</span><br><span class="line"></span><br><span class="line">D. 情感因素在购买决策中的作用</span><br><span class="line">大学生消费者在网红购物决策中情感因素占据较大比重，包括对网红本人的情感认同、对网红所构建生活方式的向往以及与其他粉丝间的社交关系等因素都会影响到购买行为。</span><br><span class="line"></span><br><span class="line">IV. 网红对大学生消费行为的影响机制</span><br><span class="line">A. 网红的影响力来源：内容创作能力、人格魅力、口碑效应等</span><br><span class="line">网红的影响力源于其独特的内容创作能力、鲜明的个性特质以及良好的口碑效应。他们通过高质量的内容输出，吸引并维系粉丝群体，进而转化为商业价值。</span><br><span class="line"></span><br><span class="line">B. 网红营销策略对大学生消费心理的影响：情感共鸣、生活方式塑造、意见领袖角色</span><br><span class="line">网红运用情感共鸣、生活方式展示以及意见领袖的角色定位，巧妙地将产品融入其中，激发大学生消费者的心理共鸣，形成潜在购买意愿，并推动实际消费行为的发生。</span><br><span class="line"></span><br><span class="line">C. 网红广告与软性推广对大学生消费选择的引导</span><br><span class="line">网红借助广告植入、品牌合作等形式进行商品推广，这种隐性且易于接受的营销手段在很大程度上左右了大学生的消费选择。</span><br><span class="line"></span><br><span class="line">V. 大学生网红消费行为的社会文化影响</span><br><span class="line">A. 对大学生价值观塑造的影响</span><br><span class="line">大学生网红消费行为促进了他们对美的追求、个性化意识的觉醒以及对品质生活的向往，进一步塑造了新一代消费者的消费价值观。</span><br><span class="line"></span><br><span class="line">B. 社会审美趋势与消费观念的变化</span><br><span class="line">随着大学生对网红消费的积极参与，他们的审美情趣和消费观念逐渐成为社会审美趋势的重要组成部分，进一步推动着社会整体消费观念的变革与发展。</span><br><span class="line"></span><br><span class="line">C. 对校园文化和市场经济发展的启示</span><br><span class="line">大学生网红消费行为不仅反映了当前市场经济环境下消费结构和消费行为的新变化，也为校园文化的多元化发展提供了新的视角与启示。</span><br><span class="line"></span><br><span class="line">VI. 结论</span><br><span class="line">A. 大学生网红消费行为的主要特点及其成因总结</span><br><span class="line">通过对大学生网红消费行为的研究，我们发现其主要特点包括高度活跃的社交媒体参与、强烈的情感驱动消费、紧跟潮流且兼顾个性化的消费需求以及深受网红营销策略的影响。这些特点的背后成因主要包括大学生独特的年龄特征、网络环境下的信息接收方式以及网红影响力的多重作用。</span><br><span class="line"></span><br><span class="line">B. 对教育部门、企业、网红自身以及社会各方面应对大学生网红消费行为进行合理引导和规范的建议</span><br><span class="line">教育部门应加强对大学生消费观的引导教育，培养他们的理性消费意识；企业应充分认识到网红营销的价值，合理利用网红资源，同时严格遵守相关法律法规，确保营销活动的合法合规；网红自身则需保持职业操守，传递正能量，发挥好榜样作用；社会各界也应对网红经济持开放包容态度，强化监管与自律相结合，共同营造健康有序的网红消费环境。</span><br><span class="line"></span><br><span class="line">C. 展望未来研究方向与可能性</span><br><span class="line">未来的研究可以从更微观的层面深入剖析大学生网红消费行为的内在机理，探究不同个体之间消费差异的具体原因；也可以着眼于全球视野，对比国内外大学生网红消费现象的异同和发展趋势；此外，还可以探讨如何结合新技术应用，如大数据、人工智能等，更好地理解和引导大学生网红消费行为。</span><br></pre></td></tr></table></figure></li></ul><h2 id="多链组合"><a href="#多链组合" class="headerlink" title="多链组合"></a>多链组合</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains import LLMChain, SequentialChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi import Tongyi</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts import ChatPromptTemplate</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子链1</span></span><br><span class="line"><span class="comment"># prompt模板 1: 翻译成英语（把下面的review翻译成英语）</span></span><br><span class="line">first_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;把下面的评论review翻译成中文:&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\n&#123;Review&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 1: 输入：Review    输出：中文的 Review</span></span><br><span class="line">chain_one = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=first_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;Chinese_Review&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子链2</span></span><br><span class="line"><span class="comment"># prompt模板 2: 用一句话总结下面的 review</span></span><br><span class="line">second_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;请你用一句话来总结下面的评论review:&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\n&#123;Chinese_Review&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 2: 输入：中文的Review   输出：总结</span></span><br><span class="line">chain_two = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=second_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;summary&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子链3</span></span><br><span class="line"><span class="comment"># prompt模板 3: 下面review使用的什么语言</span></span><br><span class="line">third_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;下面的评论review使用的什么语言:\n\n&#123;Review&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 3: 输入：Review  输出：语言</span></span><br><span class="line">chain_three = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=third_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;language&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子链4</span></span><br><span class="line"><span class="comment"># prompt模板 4: 使用特定的语言对下面的总结写一个后续回复</span></span><br><span class="line">fourth_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;使用特定的语言对下面的总结写一个后续回复:&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\n总结: &#123;summary&#125;\n\n语言: &#123;language&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 4: 输入： 总结, 语言    输出： 后续回复</span></span><br><span class="line">chain_four = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=fourth_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;followup_message&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#输入：review</span></span><br><span class="line"><span class="comment">#输出：中文review，总结，后续回复</span></span><br><span class="line">overall_chain = SequentialChain(</span><br><span class="line">    chains=[chain_one, chain_two, chain_three, chain_four],</span><br><span class="line">    input_variables=[<span class="string">&quot;Review&quot;</span>],</span><br><span class="line">    output_variables=[<span class="string">&quot;Chinese_Review&quot;</span>, <span class="string">&quot;summary&quot;</span>, <span class="string">&quot;followup_message&quot;</span>, <span class="string">&quot;language&quot;</span>],</span><br><span class="line">    <span class="attribute">verbose</span>=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    text = input(<span class="string">&quot;请输入内容：&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(overall_chain.invoke(&#123;<span class="string">&quot;Review&quot;</span>: text&#125;))</span><br></pre></td></tr></table></figure><p><img src="https://s11.ax1x.com/2024/02/24/pFUftjf.png" alt=""></p><h2 id="路由链"><a href="#路由链" class="headerlink" title="路由链"></a>路由链</h2><ul><li>前面的链的输入顺序基本上都是固定的，如果想做更复杂的事情，就需要根据输入将其路由到特定的链。假设你有多个子链，每个子链都专门用于特定类型的输入，那么可以组成一个路由链</li><li><p>路由器由两个组件组成：</p><ol><li>路由链（Router Chain）：路由器链本身，负责选择要调用的下一个链</li><li>destination_chains：路由器链可以路由到的链<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain, MultiPromptChain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.router.llm_router <span class="keyword">import</span> RouterOutputParser, LLMRouterChain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.router.multi_prompt_prompt <span class="keyword">import</span> MULTI_PROMPT_ROUTER_TEMPLATE</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi <span class="keyword">import</span> Tongyi</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate, PromptTemplate</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义多种提示模板</span></span><br><span class="line"><span class="comment"># 第一个提示适合回答物理问题</span></span><br><span class="line">physics_template = <span class="string">&quot;&quot;&quot;你是一个非常聪明的物理专家。 \</span></span><br><span class="line"><span class="string">你擅长用一种简洁并且易于理解的方式去回答问题。\</span></span><br><span class="line"><span class="string">当你不知道问题的答案时，你承认\</span></span><br><span class="line"><span class="string">你不知道.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这是一个问题:</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二个提示适合回答数学问题</span></span><br><span class="line">math_template = <span class="string">&quot;&quot;&quot;你是一个非常优秀的数学家。 \</span></span><br><span class="line"><span class="string">你擅长回答数学问题。 \</span></span><br><span class="line"><span class="string">你之所以如此优秀， \</span></span><br><span class="line"><span class="string">是因为你能够将棘手的问题分解为组成部分，\</span></span><br><span class="line"><span class="string">回答组成部分，然后将它们组合在一起，回答更广泛的问题。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这是一个问题：</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三个适合回答历史问题</span></span><br><span class="line">history_template = <span class="string">&quot;&quot;&quot;你是以为非常优秀的历史学家。 \</span></span><br><span class="line"><span class="string">你对一系列历史时期的人物、事件和背景有着极好的学识和理解\</span></span><br><span class="line"><span class="string">你有能力思考、反思、辩证、讨论和评估过去。\</span></span><br><span class="line"><span class="string">你尊重历史证据，并有能力利用它来支持你的解释和判断。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这是一个问题:</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第四个适合回答计算机问题</span></span><br><span class="line">computerscience_template = <span class="string">&quot;&quot;&quot; 你是一个成功的计算机科学专家。\</span></span><br><span class="line"><span class="string">你有创造力、协作精神、\</span></span><br><span class="line"><span class="string">前瞻性思维、自信、解决问题的能力、\</span></span><br><span class="line"><span class="string">对理论和算法的理解以及出色的沟通技巧。\</span></span><br><span class="line"><span class="string">你非常擅长回答编程问题。\</span></span><br><span class="line"><span class="string">你之所以如此优秀，是因为你知道  \</span></span><br><span class="line"><span class="string">如何通过以机器可以轻松解释的命令式步骤描述解决方案来解决问题，\</span></span><br><span class="line"><span class="string">并且你知道如何选择在时间复杂性和空间复杂性之间取得良好平衡的解决方案。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这还是一个问题：</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为每个模板命名，并且给出具体描述，将这些信息传递给路由链，路由链决定何时调用子链</span></span><br><span class="line">prompt_infos = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;名字&quot;</span>: <span class="string">&quot;物理学&quot;</span>,</span><br><span class="line">        <span class="string">&quot;描述&quot;</span>: <span class="string">&quot;擅长回答关于物理学的问题&quot;</span>,</span><br><span class="line">        <span class="string">&quot;提示模板&quot;</span>: physics_template</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;名字&quot;</span>: <span class="string">&quot;数学&quot;</span>,</span><br><span class="line">        <span class="string">&quot;描述&quot;</span>: <span class="string">&quot;擅长回答数学问题&quot;</span>,</span><br><span class="line">        <span class="string">&quot;提示模板&quot;</span>: math_template</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;名字&quot;</span>: <span class="string">&quot;历史&quot;</span>,</span><br><span class="line">        <span class="string">&quot;描述&quot;</span>: <span class="string">&quot;擅长回答历史问题&quot;</span>,</span><br><span class="line">        <span class="string">&quot;提示模板&quot;</span>: history_template</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;名字&quot;</span>: <span class="string">&quot;计算机科学&quot;</span>,</span><br><span class="line">        <span class="string">&quot;描述&quot;</span>: <span class="string">&quot;擅长回答计算机科学问题&quot;</span>,</span><br><span class="line">        <span class="string">&quot;提示模板&quot;</span>: computerscience_template</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于提示模版信息创建相应目标链</span></span><br><span class="line">destination_chains = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> p_info <span class="keyword">in</span> prompt_infos:</span><br><span class="line">    name = p_info[<span class="string">&quot;名字&quot;</span>]</span><br><span class="line">    prompt_template = p_info[<span class="string">&quot;提示模板&quot;</span>]</span><br><span class="line">    prompt = ChatPromptTemplate.from_template(template=prompt_template)</span><br><span class="line">    chain = LLMChain(llm=llm, prompt=prompt)</span><br><span class="line">    destination_chains[name] = chain</span><br><span class="line"></span><br><span class="line">destinations = [<span class="string">f&quot;<span class="subst">&#123;p[<span class="string">&#x27;名字&#x27;</span>]&#125;</span>: <span class="subst">&#123;p[<span class="string">&#x27;描述&#x27;</span>]&#125;</span>&quot;</span> <span class="keyword">for</span> p <span class="keyword">in</span> prompt_infos]</span><br><span class="line">destinations_str = <span class="string">&quot;\n&quot;</span>.join(destinations)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建默认目标链，当路由器无法决定使用哪个子链时调用的链。</span></span><br><span class="line">default_prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&#123;input&#125;&quot;</span>)</span><br><span class="line">default_chain = LLMChain(llm=llm, prompt=default_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建路由链</span></span><br><span class="line">router_template = MULTI_PROMPT_ROUTER_TEMPLATE.<span class="built_in">format</span>(destinations=destinations_str)</span><br><span class="line"></span><br><span class="line">router_prompt = PromptTemplate(</span><br><span class="line">    template=router_template,</span><br><span class="line">    input_variables=[<span class="string">&quot;input&quot;</span>],</span><br><span class="line">    output_parser=RouterOutputParser(),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">router_chain = LLMRouterChain.from_llm(llm, router_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建整体链路</span></span><br><span class="line">chain = MultiPromptChain(router_chain=router_chain,  <span class="comment"># 路由链路</span></span><br><span class="line">                         destination_chains=destination_chains,  <span class="comment"># 目标链路</span></span><br><span class="line">                         default_chain=default_chain,  <span class="comment"># 默认链路</span></span><br><span class="line">                         verbose=<span class="literal">True</span></span><br><span class="line">                         )</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    que = <span class="built_in">input</span>(<span class="string">&quot;请输入问题：&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: que&#125;))</span><br></pre></td></tr></table></figure></li></ol></li><li><p>后续我们可以预定义非常多的prompt，然后通过路由链来进行任务分发，尽可能把任务细分，这样出现问题时，只需要关注对应的某一个prompt，而不需要整体的改动。</p></li></ul><h1 id="代理的概念（补充）"><a href="#代理的概念（补充）" class="headerlink" title="代理的概念（补充）"></a>代理的概念（补充）</h1><ul><li>大型语言模型（LLMs）非常强大，但它们缺乏“最笨”的计算机程序可以轻松处理的特定能力。LLM 对逻辑推理、计算和检索外部信息的能力较弱，这与最简单的计算机程序形成对比。例如，语言模型无法准确回答简单的计算问题，还有当询问最近发生的事件时，其回答也可能过时或错误，因为无法主动获取最新信息。这是由于当前语言模型仅依赖预训练数据，与外界“断开”。要克服这一缺陷，LangChain框架提出了“代理”(Agent)的解决方案。</li><li>代理作为语言模型的外部模块，可提供计算、逻辑、检索等功能的支持，使语言模型获得异常强大的推理和获取信息的超能力。</li><li>要使用代理 (Agents) ，我们需要三样东西：<ol><li>一个基本的 LLM</li><li>我们将要进行交互的工具 Tools</li><li>一个控制交互的代理 (Agents) 。</li></ol><ul><li>现在尝试使用代理来解决数学问题<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> load_tools, initialize_agent, AgentType</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi <span class="keyword">import</span> Tongyi</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line">tools = load_tools(</span><br><span class="line">    [<span class="string">&quot;llm-math&quot;</span>, <span class="string">&quot;wikipedia&quot;</span>],</span><br><span class="line">    llm=llm</span><br><span class="line">)</span><br><span class="line">agent = initialize_agent(</span><br><span class="line">    tools,  <span class="comment"># 第二步加载的工具</span></span><br><span class="line">    llm,  <span class="comment"># 第一步初始化的模型</span></span><br><span class="line">    agent=AgentType.CHAT_ZERO_SHOT_REACT_DESCRIPTION,  <span class="comment"># 代理类型</span></span><br><span class="line">    handle_parsing_errors=<span class="literal">True</span>,  <span class="comment"># 处理解析错误</span></span><br><span class="line">    verbose=<span class="literal">True</span>  <span class="comment"># 输出中间步骤</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">agent.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;2084的25%是多少？还有，你知道Palworld这款游戏吗&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></li></ul></li><li><p>输出</p><blockquote><p> Thought: 第一个问题需要计算2084的25%，可以使用计算器工具；第二个问题询问关于Palworld这款游戏的信息，需要用到Wikipedia工具。</p><p> Action:</p> <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Calculator&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;action_input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2084 * 25%&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p> Observation: Answer: 521.0<br> Thought:对于第二个问题，我需要使用Wikipedia工具来查询Palworld这款游戏的信息。<br> Action:</p> <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wikipedia&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;action_input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Palworld&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p> Observation: Page: Palworld<br> Summary: Palworld is an action-adventure survival game by Japanese developer Pocket Pair. The game is set in an open world populated with animal-like creatures known as “Pals”. The players can battle and capture Pals in order to use them for base building, traversal, and combat. Palworld can be played either solo, or online by up to 32 players on one server. Announced in 2021, it was launched via early access for Windows, Xbox One, and Xbox Series X/S in January 2024.<br> The game’s comedic premise, which involves using firearms and equipping Pals with them, earned it the nickname “Pokémon with guns”. Other elements, such as using creatures for food or placing them to work in mines and factories, have also garnered attention. It was generally well received, with praise for its gameplay, content, and satirical premise, but criticism for its reliance on shock humor and use of unoriginal designs and mechanics.Palworld sold eight million units in the first six days of early access and reached two million concurrent players on Steam, making it the second-highest played game of all time on the platform.</p><p> Page: Brotato<br> Summary: Brotato is a 2023 shoot ‘em up video game created by French independent developer Thomas Gervraud under the studio name Blobfish. It was first released via Steam early access in 2022, during which it sold over one million copies. Brotato received positive reviews from critics and players, and it was later ported to multiple platforms.</p><p> Page: List of video games in development<br> Summary: This is a confirmed list of video games in development, but are scheduled for release beyond 2024 or currently carry no release date at all.</p></blockquote></li><li><p>总结一下上面的流程<br><img src="https://s11.ax1x.com/2024/02/24/pFUfYgP.png" alt=""></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;什么是LangChain&quot;&gt;&lt;a href=&quot;#什么是LangChain&quot; class=&quot;headerlink&quot; title=&quot;什么是LangChain&quot;&gt;&lt;/a&gt;什么是LangChain&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;LangChain是一个强大的框架，旨在帮助开发</summary>
      
    
    
    
    <category term="实用教程" scheme="https://cyborg2077.github.io/categories/%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="LangChain" scheme="https://cyborg2077.github.io/tags/LangChain/"/>
    
  </entry>
  
  <entry>
    <title>SELECT FOR UPDATE的锁粒度</title>
    <link href="https://cyborg2077.github.io/2023/12/31/SelectForUpdate/"/>
    <id>https://cyborg2077.github.io/2023/12/31/SelectForUpdate/</id>
    <published>2023-12-31T14:59:55.000Z</published>
    <updated>2024-01-14T12:06:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>在数据库事务处理中，处理数据库并发访问的请求一个复杂且重要的问题，当多个事务同时访问并尝试修改同一行数据时，可能会导致数据的一致性问题，例如丢失更新或脏读的情况。为了解决这些问题，数据库提供了一些机处理并发事务，其中之一便是<code>SELECT ... FOR UPDATE</code>语句。</li><li>在并发访问的环境中，<code>SELECT ... FOR UPDATE</code>允许事务在选择数据的同时，锁定这些数据，防止其他事务<code>修改</code>这些数据，直到当前事务完成并释放锁。从本质上，<code>SELECT ... FOR UPDATE</code>是一种悲锁的用法，一般情况下，只会锁住一行数据，但是如果没有正确使用的话，会把整张表都锁住的。</li><li>我也在实际项目中使用过，例如免费字数抵扣金额下单的场景。</li></ul><h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><ul><li>虽然在MySQL中是通过<code>SELECT ... FOR UPDATE</code>语句来实现的行锁的功能。但是如果你在实际工作中使用不正确，也容易把整张表锁住，严重影响性能。<code>SELECT ... FOR UPDATE</code>语句的用法是否正确，跟<code>WHERE条件</code>中的参数有很大的关系。我们先来简单建个表，然后分析一下下面几种情况。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_info (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,             <span class="comment">-- 主键</span></span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">UNIQUE</span>,   <span class="comment">-- 唯一索引</span></span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,    <span class="comment">-- 普通索引</span></span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),          <span class="comment">-- 普通字段</span></span><br><span class="line">    INDEX idx_email (email)         </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_info (id, username, email, amount)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">1</span>, <span class="string">&#x27;john_doe&#x27;</span>, <span class="string">&#x27;john.doe@example.com&#x27;</span>, <span class="number">500.00</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="string">&#x27;alice_smith&#x27;</span>, <span class="string">&#x27;alice.smith@example.com&#x27;</span>, <span class="number">1000.00</span>),</span><br><span class="line">  (<span class="number">3</span>, <span class="string">&#x27;bob_jones&#x27;</span>, <span class="string">&#x27;bob.jones@example.com&#x27;</span>, <span class="number">1500.00</span>),</span><br><span class="line">  (<span class="number">4</span>, <span class="string">&#x27;lisa_davis&#x27;</span>, <span class="string">&#x27;lisa.davis@example.com&#x27;</span>, <span class="number">2000.00</span>),</span><br><span class="line">  (<span class="number">5</span>, <span class="string">&#x27;charlie_brown&#x27;</span>, <span class="string">&#x27;charlie.brown@example.com&#x27;</span>, <span class="number">2500.00</span>);</span><br></pre></td></tr></table></figure></li></ul><h2 id="主键字段"><a href="#主键字段" class="headerlink" title="主键字段"></a>主键字段</h2><ul><li>当<code>WHERE</code>条件使用主键时<div class="tabs" id="主键"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#主键-1">事务一</button></li><li class="tab"><button type="button" data-href="#主键-2">事务二</button></li><li class="tab"><button type="button" data-href="#主键-3">事务三</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="主键-1"><ul><li>在事务一中使用<code>FOR UPDATE</code>，加一个行锁，注意此时没有<code>COMMIT</code>提交事务<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;  <span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;  <span class="comment">-- 加行锁</span></span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="主键-2"><ul><li>在事务二中尝试修改该行，那么在执行的过程中，会一直等待事务一释放锁。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li><li>如果事务一，一直都不释放锁，那么事务二最终会报这个异常<figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 10000 WHERE id = 1</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1205</span> - <span class="title class_">Lock</span> wait timeout exceeded; <span class="keyword">try</span> restarting transaction</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">查询时间: <span class="number">50.</span>086s</span></span><br></pre></td></tr></table></figure></li><li>当事务一提交事务后，事务二才能正常执行<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="主键-3"><ul><li>如果此时开启一个事务三，修改其他行的值，那么是可以正常执行的<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure></li><li>执行结果<figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 10000 WHERE id = 2</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="title class_">Affected</span> <span class="attr">rows</span>: <span class="number">1</span></span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">查询时间: <span class="number">0.</span>009s</span></span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul><h2 id="唯一索引"><a href="#唯一索引" class="headerlink" title="唯一索引"></a>唯一索引</h2><ul><li>当<code>WHERE</code>条件使用唯一索引时<div class="tabs" id="主键"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#主键-1">事务一</button></li><li class="tab"><button type="button" data-href="#主键-2">事务二</button></li><li class="tab"><button type="button" data-href="#主键-3">事务三</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="主键-1"><ul><li>在事务一中使用<code>FOR UPDATE</code>，加一个行锁，注意此时没有<code>COMMIT</code>提交事务<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;john_doe&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="主键-2"><ul><li>在事务二中尝试修改该行，那么在执行的过程中，会一直等待事务一释放锁。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;john_doe&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li>如果事务一，一直都不释放锁，那么事务二最终会报这个异常<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount = <span class="number">10000</span> <span class="keyword">WHERE</span> username = <span class="string">&#x27;john_doe&#x27;</span></span><br><span class="line">&gt; <span class="number">1205</span> - <span class="keyword">Lock</span> wait timeout exceeded; try restarting <span class="keyword">transaction</span></span><br><span class="line">&gt; 查询时间: <span class="number">50.084</span>s</span><br></pre></td></tr></table></figure></li><li>当事务一提交事务后，事务二才能正常执行<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="主键-3"><ul><li>如果此时开启一个事务三，修改其他行的值，那么是可以正常执行的<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice_smith&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li>执行结果<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice_smith&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> Affected <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line"><span class="operator">&gt;</span> 查询时间: <span class="number">0.002</span>s</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul><h2 id="普通索引"><a href="#普通索引" class="headerlink" title="普通索引"></a>普通索引</h2><ul><li>当<code>WHERE</code>条件使用普通索引时<div class="tabs" id="主键"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#主键-1">事务一</button></li><li class="tab"><button type="button" data-href="#主键-2">事务二</button></li><li class="tab"><button type="button" data-href="#主键-3">事务三</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="主键-1"><ul><li>在事务一中使用<code>FOR UPDATE</code>，加一个行锁，注意此时没有<code>COMMIT</code>提交事务<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;john.doe@example.com&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="主键-2"><ul><li>在事务二中尝试修改该行，那么在执行的过程中，会一直等待事务一释放锁。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;john.doe@example.com&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li>如果事务一，一直都不释放锁，那么事务二最终会报这个异常<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount = <span class="number">1000</span> <span class="keyword">WHERE</span> email = <span class="string">&#x27;john.doe@example.com&#x27;</span></span><br><span class="line">&gt; <span class="number">1205</span> - <span class="keyword">Lock</span> wait timeout exceeded; try restarting <span class="keyword">transaction</span></span><br><span class="line">&gt; 查询时间: <span class="number">50.082</span>s</span><br></pre></td></tr></table></figure></li><li>当事务一提交事务后，事务二才能正常执行<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="主键-3"><ul><li>如果此时开启一个事务三，修改其他行的值，那么是可以正常执行的<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;alice.smith@example.com&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li>执行结果<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;alice.smith@example.com&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> Affected <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line"><span class="operator">&gt;</span> 查询时间: <span class="number">0.003</span>s</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul><h2 id="普通字段"><a href="#普通字段" class="headerlink" title="普通字段"></a>普通字段</h2><ul><li>当<code>WHERE</code>条件使用普通字段时<div class="tabs" id="主键"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#主键-1">事务一</button></li><li class="tab"><button type="button" data-href="#主键-2">事务二</button></li><li class="tab"><button type="button" data-href="#主键-3">事务三</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="主键-1"><ul><li>在事务一中使用<code>FOR UPDATE</code>，加一个行锁，注意此时没有<code>COMMIT</code>提交事务<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> amount <span class="operator">=</span> <span class="number">2500</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="主键-2"><ul><li>在事务二中尝试修改该行，那么在执行的过程中，会一直等待事务一释放锁。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> amount <span class="operator">=</span> <span class="number">2500</span>;</span><br></pre></td></tr></table></figure></li><li>如果事务一，一直都不释放锁，那么事务二最终会报这个异常<figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 1000 WHERE amount = 2500</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1205</span> - <span class="title class_">Lock</span> wait timeout exceeded; <span class="keyword">try</span> restarting transaction</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">查询时间: <span class="number">50.</span>17s</span></span><br></pre></td></tr></table></figure></li><li>当事务一提交事务后，事务二才能正常执行<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="主键-3"><ul><li>如果此时开启一个事务三，修改其他行的值，会发现也是被阻塞了的<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> amount <span class="operator">=</span> <span class="number">2000</span>;</span><br></pre></td></tr></table></figure></li><li>执行结果<figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 1000 WHERE amount = 2000</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1205</span> - <span class="title class_">Lock</span> wait timeout exceeded; <span class="keyword">try</span> restarting transaction</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">查询时间: <span class="number">50.</span>083s</span></span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><ul><li>总结一下<code>SELECT ... FOR UPDATE</code>加锁的情况：<ul><li>主键字段：加行锁。</li><li>唯一索引字段：加行锁。</li><li>普通索引字段：加行锁。</li><li>普通字段：加表锁。</li></ul></li><li>如果事务一加了<code>行锁</code>，一直没有释放锁，事务二操作相同行的数据时，会一直等待直到超时。</li><li>如果事务一加了<code>表锁</code>，一直没有释放锁，事务二不管操作的是哪一行数据，都会一直等待直到超时。</li></ul>]]></content>
    
    
    <summary type="html">SELECT ... FOR UPDATE 到底是加了行锁还是表锁？</summary>
    
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
    <category term="知识分享" scheme="https://cyborg2077.github.io/tags/%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB/"/>
    
  </entry>
  
  <entry>
    <title>模拟ChatGPT流式数据传输--SSE最佳实践（附可运行实例）</title>
    <link href="https://cyborg2077.github.io/2023/11/25/ServerSendEvents/"/>
    <id>https://cyborg2077.github.io/2023/11/25/ServerSendEvents/</id>
    <published>2023-11-25T04:21:49.000Z</published>
    <updated>2024-08-17T05:29:03.613Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>在使用ChatGPT的时候，发现输入prompt后，是使用流式的效果返回数据，给用户的是一个打字机的效果。查看其网络请求，发现这个接口的通响应类型是<code>text/event-stream</code>，一种基于EventStream的事件流。<br><img src="https://z1.ax1x.com/2023/11/25/piwzPk8.png" alt=""></li><li>那么为什么要这样传输呢？从使用场景上来说，ChatGPT是一个基于深度学习的大型语言模型，处理自然语言需要大量的计算资源和时间，那么响应速度肯定是比一般业务要慢的，那么接口等待时间过长，显然也不合适，那么对于这种对话场景，采用SSE技术边计算边返回，避免用户因为等待时间过长而关闭页面。</li></ul><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><div class="note info no-icon flat"><p>SSE(Server Sent Event)，直译为服务器发送事件，也就是服务器主动发送事件，客户端可以获取到服务器发送的事件。</p></div><ul><li>常见的HTTP交互方式主要是客户端发起请求，然后服务端响应，然后一次性请求完毕。但是在SSE的使用场景下，客户端发起请求，然后建立SSE连接一直保持，服务端就可以返回数据给客户端。</li><li>SSE简单来说就是服务器主动向前端推送数据的一种技术，它是单向的。SSE适用于消息推送、监控等只需要服务端推送数据的场景中。</li></ul><h1 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h1><ul><li>服务端主动推送<ol><li>HTML5新标准，用于从服务端试试推送数据到浏览器端。</li><li>直接建立在当前HTTP连接上，本质上是一个HTTP长连接。</li></ol></li></ul><h1 id="SSE与WebSocket的区别"><a href="#SSE与WebSocket的区别" class="headerlink" title="SSE与WebSocket的区别"></a>SSE与WebSocket的区别</h1><ul><li>SSE是单工的，只能由服务端想客户端发送消息，而WebSocket是双工的</li></ul><div class="table-container"><table><thead><tr><th style="text-align:center">SSE</th><th style="text-align:center">WebScoket</th></tr></thead><tbody><tr><td style="text-align:center">http 协议</td><td style="text-align:center">独立的 websocket 协议</td></tr><tr><td style="text-align:center">轻量，使用简单</td><td style="text-align:center">相对复杂</td></tr><tr><td style="text-align:center">默认支持断线重连</td><td style="text-align:center">需要自己实现断线重连</td></tr><tr><td style="text-align:center">文本传输</td><td style="text-align:center">二进制传输</td></tr><tr><td style="text-align:center">支持自定义发送的消息类型</td><td style="text-align:center">-</td></tr></tbody></table></div><h1 id="SSE规范"><a href="#SSE规范" class="headerlink" title="SSE规范"></a>SSE规范</h1><ul><li>在HTML5中，服务端SSE一般要遵循以下要求<ol><li>请求头：开启长连接 + 流式传递<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-<span class="keyword">Type</span>: <span class="type">text</span>/event-stream;charset=UTF<span class="number">-8</span></span><br><span class="line"><span class="keyword">Cache</span>-Control: no-<span class="keyword">cache</span></span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure></li><li>数据格式：服务端发送的消息，由message组成，其格式如下<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">field:</span>value</span><br></pre></td></tr></table></figure></li></ol></li></ul><h1 id="SSE实践"><a href="#SSE实践" class="headerlink" title="SSE实践"></a>SSE实践</h1><ul><li>这里简单做一个时钟效果，有服务端主动推送当前时间数据给前端，前端页面接收后展示。</li></ul><h2 id="SseEmitter类简介"><a href="#SseEmitter类简介" class="headerlink" title="SseEmitter类简介"></a>SseEmitter类简介</h2><ul><li>SpringBoot使用SseEmitter来支持SSE，并对SSE规范做了一些封装，使用起来非常简单。我们在操作SseEmitter对象时，只需要关注发送的消息文本即可。</li><li>SseEmittter类的几个方法：<ol><li>send()：发送数据，如果传入的是一个非SseEventBuilder对象，那么传递参数会被封装到data中。</li><li>complete()：表示执行完成，会断开连接（如果是一些轮询进度的任务，我们可以在任务进度完成时，主动断开连接）</li><li>onTimeout()：连接超时时回调触发。</li><li>onCompletion()：结束之后的回调触发。</li><li>onError()：报错时的回调触发。</li></ol></li></ul><h2 id="示例Demo"><a href="#示例Demo" class="headerlink" title="示例Demo"></a>示例Demo</h2><div class="tabs" id="sse时钟demo"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#sse时钟demo-1">前端HTML</button></li><li class="tab"><button type="button" data-href="#sse时钟demo-2">后端接口</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="sse时钟demo-1"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;msg_from_server&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> sse = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="string">&quot;http://localhost/sse/hello&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    sse.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> eventVal = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;msg_from_server&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        eventVal.<span class="property">innerHTML</span> = event.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="sse时钟demo-2"><ul><li>后端接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sse&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">helloworld</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                    sseEmitter.send(SseEmitter.event().data(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>))));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Error in SSE: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                sseEmitter.completeWithError(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>大功告成<br><img src="https://z1.ax1x.com/2023/11/25/pi0EfLF.png" alt=""></li></ul><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul><li>这里的协议是<code>http/1.1</code>，仅支持6个连接数，而<code>HTTP/2</code>默认支持100个连接数，同时这里每30秒重新建立了一个新连接，这是SSE默认的连接超时时间，我们可以通过配置连接超时时间来达到不过期的目的，那么就需要我们在业务逻辑里<code>手动关闭连接</code>。</li><li>同时，每建立一个SSE连接的时候，都需要一个线程，那么这里就需要创建一个线程池来处理并发问题，同时也要根据自身的业务需求来做好压测。<br><img src="https://z1.ax1x.com/2023/11/25/pi0VFQf.png" alt=""></li><li>但是<code>HTTP/2</code>仅支持<code>HTTPS</code>，我这里就不演示了，感兴趣的小伙伴可以去了解一下使用OpenSSL生成一个<code>自签名的SSL证书</code></li></ul><h2 id="工具类封装"><a href="#工具类封装" class="headerlink" title="工具类封装"></a>工具类封装</h2><ul><li>下面是我封装的一个简单的SseUtils<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SseUtils</span> &#123;</span><br><span class="line">    <span class="comment">// timeout -&gt; 0表示不过期，默认是30秒，超过时间未完成（断开）会抛出异常</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">DEFAULT_TIME_OUT</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// 会话map, 方便管理连接数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, SseEmitter&gt; conversationMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 建立连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitter <span class="title function_">getConnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建SSE</span></span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>(DEFAULT_TIME_OUT);</span><br><span class="line">        <span class="comment">// 异常</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置前端重试时5s</span></span><br><span class="line">            sseEmitter.send(SseEmitter.event().reconnectTime(<span class="number">5_000L</span>).data(<span class="string">&quot;SSE建立成功&quot;</span>));</span><br><span class="line">            <span class="comment">// 连接超时</span></span><br><span class="line">            sseEmitter.onTimeout(() -&gt; SseUtils.timeout(conversationId));</span><br><span class="line">            <span class="comment">// 连接断开</span></span><br><span class="line">            sseEmitter.onCompletion(() -&gt; SseUtils.completion(conversationId));</span><br><span class="line">            <span class="comment">// 错误</span></span><br><span class="line">            sseEmitter.onError((e) -&gt; SseUtils.error(conversationId, e.getMessage()));</span><br><span class="line">            <span class="comment">// 添加sse</span></span><br><span class="line">            conversationMap.put(conversationId, sseEmitter);</span><br><span class="line">            <span class="comment">// 连接成功</span></span><br><span class="line">            log.info(<span class="string">&quot;创建sse连接成功 ==&gt; 当前连接总数=&#123;&#125;， 会话Id=&#123;&#125;&quot;</span>, conversationMap.size(), conversationId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// 日志</span></span><br><span class="line">            log.error(<span class="string">&quot;前端重连异常 ==&gt; 会话Id=&#123;&#125;, 异常信息=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回</span></span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 获取消息实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitter <span class="title function_">getInstance</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.get(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 断开连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">disconnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        SseUtils.getInstance(conversationId).complete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 给指定会话发送消息，如果发送失败，返回false</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jsonMsg        - 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String conversationId, String jsonMsg)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断该会话是否已建立连接</span></span><br><span class="line">        <span class="comment">// 已建立连接</span></span><br><span class="line">        <span class="keyword">if</span> (SseUtils.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 发送消息</span></span><br><span class="line">                SseUtils.getInstance(conversationId).send(jsonMsg, MediaType.APPLICATION_JSON);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// 日志</span></span><br><span class="line">                SseUtils.removeClientId(conversationId);</span><br><span class="line">                log.error(<span class="string">&quot;发送消息异常 ==&gt; 会话Id=&#123;&#125;, 异常信息=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 未建立连接</span></span><br><span class="line">            log.error(<span class="string">&quot;连接不存在或者超时 ==&gt; 会话Id=&#123;&#125;会话自动关闭&quot;</span>, conversationId);</span><br><span class="line">            SseUtils.removeClientId(conversationId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除会话Id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// 不存在存在会话</span></span><br><span class="line">        <span class="keyword">if</span> (!SseUtils.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 删除该会话</span></span><br><span class="line">        conversationMap.remove(conversationId);</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line">        log.info(<span class="string">&quot;移除会话成功 ==&gt; 会话Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取是否存在会话</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">getIsExistClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.containsKey(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前连接总数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - 连接总数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getConnectTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;当前连接数：&#123;&#125;&quot;</span>, conversationMap.size());</span><br><span class="line">        <span class="keyword">for</span> (String s : conversationMap.keySet()) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;输出SSE-Map：&#123;&#125;&quot;</span>, conversationMap.get(s));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 超时</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">timeout</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line">        log.error(<span class="string">&quot;sse连接超时 ==&gt; 会话Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">        <span class="comment">// 移除会话</span></span><br><span class="line">        SseUtils.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 完成</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">completion</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line">        log.info(<span class="string">&quot;sse连接已断开 ==&gt; 会话Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">        <span class="comment">// 移除会话</span></span><br><span class="line">        SseUtils.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String conversationId, String message)</span> &#123;</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line">        log.error(<span class="string">&quot;sse服务异常 ==&gt; 会话Id=&#123;&#125;, 异常信息=&#123;&#125;&quot;</span>, conversationId, message);</span><br><span class="line">        <span class="comment">// 移除会话</span></span><br><span class="line">        SseUtils.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>还是用刚刚推送当前时间的例子，这里我们做一下主动关闭连接，我这里简单的逻辑就是遍历到一个整分，就停止推送<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">timeStamp</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line">    response.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    <span class="comment">// 生成会话ID</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">conversationId</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="comment">// 建立连接</span></span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> SseUtils.getConnect(conversationId);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                <span class="comment">// 向会话发送消息</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">timeStamp</span> <span class="operator">=</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">                SseUtils.sendMessage(conversationId, timeStamp);</span><br><span class="line">                <span class="keyword">if</span> (timeStamp.endsWith(<span class="string">&quot;00&quot;</span>)) &#123;</span><br><span class="line">                    SseUtils.removeClientId(conversationId);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error in SSE: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            sseEmitter.completeWithError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">return</span> sseEmitter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="SSE实战"><a href="#SSE实战" class="headerlink" title="SSE实战"></a>SSE实战</h1><ul><li>我这里也是在我项目里的轮询订单进度的时候尝试用了一下，因为我这个项目也是文本生成方向的，之前是前端定时轮询我这边的接口，现在换成我主动向前端推送数据，然后前端拿到数据自己解析内容就好了。这里用的工具类就是我刚刚封装的那个<div class="tabs" id="实战"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#实战-1">Controller层</button></li><li class="tab"><button type="button" data-href="#实战-2">Service层</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="实战-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderDetail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">getOrderDetailById</span><span class="params">(String orderId, HttpServletResponse httpServletResponse)</span> &#123;</span><br><span class="line">    httpServletResponse.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">    httpServletResponse.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> orderService.getOrderDetailById(orderId, httpServletResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="实战-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简单来个线程池</span></span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">60</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">getOrderDetailById</span><span class="params">(String orderId, HttpServletResponse httpServletResponse)</span> &#123;</span><br><span class="line">    <span class="comment">// 建立连接</span></span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> SseUtils.getConnect(orderId);</span><br><span class="line">    executor.execute(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;=========SSE轮询中=========&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 每5秒推送一次数据</span></span><br><span class="line">                Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 查询订单数据</span></span><br><span class="line">            <span class="type">Torder</span> <span class="variable">torder</span> <span class="operator">=</span> orderMapper.selectOne(Wrappers.lambdaQuery(Torder.class).eq(Torder::getOrderId, orderId));</span><br><span class="line">            <span class="keyword">if</span> (torder == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果订单不存在，返回错误，主动断开连接</span></span><br><span class="line">                SseUtils.sendMessage(orderId, JSON.toJSONString(ErrorCodeEnum.ORDER_ID_NOT_EXIST));</span><br><span class="line">                SseUtils.removeClientId(orderId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">OrderDetailVO</span> <span class="variable">detailVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDetailVO</span>();</span><br><span class="line">            detailVO.setIsExpire(stringRedisTemplate.opsForValue().get(orderId) == <span class="literal">null</span>);</span><br><span class="line">            detailVO.setOrderId(orderId);</span><br><span class="line">            detailVO.setCreateTime(torder.getCreateTime());</span><br><span class="line">            detailVO.setOrderType(torder.getPolishType());</span><br><span class="line">            detailVO.setAmount(torder.getAmount().doubleValue());</span><br><span class="line">            <span class="comment">// 根据不同的订单类型来封装不同的参数（这里为了满足产品的需求，想用一个接口显示不同种类订单的信息，用了SQL反模式设计数据库，导致代码很不优雅）</span></span><br><span class="line">            <span class="keyword">if</span> (torder.getOrderType() == <span class="number">0</span>) &#123;</span><br><span class="line">                Wrapper&lt;Object&gt; statusByOrderId = getStatusByOrderId(orderId);</span><br><span class="line">                <span class="keyword">if</span> (statusByOrderId.getCode() != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 订单状态查询异常，返回错误，主动断开连接</span></span><br><span class="line">                    SseUtils.sendMessage(orderId, JSON.toJSONString(ErrorCodeEnum.ASYNC_SERVICE_ERROR));</span><br><span class="line">                    SseUtils.removeClientId(orderId);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (torder.getPolishType() == Common.POLISH_TYPE_WITH_PAPER) &#123;</span><br><span class="line">                    <span class="type">PaperStatusByOrderIdVO</span> <span class="variable">paperVO</span> <span class="operator">=</span> (PaperStatusByOrderIdVO) statusByOrderId.getResult();</span><br><span class="line">                    BeanUtils.copyProperties(paperVO, detailVO);</span><br><span class="line">                    detailVO.setProgress(Double.valueOf(paperVO.getProgress()));</span><br><span class="line">                    detailVO.setTitle(paperVO.getPaperTitle());</span><br><span class="line">                    detailVO.setOrderStatus(paperVO.getStatus());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">TextStatusByOrderIdVO</span> <span class="variable">textVO</span> <span class="operator">=</span> (TextStatusByOrderIdVO) statusByOrderId.getResult();</span><br><span class="line">                    BeanUtils.copyProperties(textVO, detailVO);</span><br><span class="line">                    detailVO.setProgress(Double.valueOf(textVO.getProgress()));</span><br><span class="line">                    detailVO.setTitle(textVO.getPaperTitle());</span><br><span class="line">                    detailVO.setOrderStatus(textVO.getStatus());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (torder.getOrderType() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">CheckpassOrder</span> <span class="variable">checkpassOrder</span> <span class="operator">=</span> checkpassOrderMapper.selectOne(Wrappers.lambdaQuery(CheckpassOrder.class).eq(CheckpassOrder::getOrderId, orderId));</span><br><span class="line">                <span class="type">CheckpassReport</span> <span class="variable">checkpassReport</span> <span class="operator">=</span> checkpassReportMapper.selectOne(Wrappers.lambdaQuery(CheckpassReport.class).eq(CheckpassReport::getPaperId, checkpassOrder.getPaperId()));</span><br><span class="line">                detailVO.setOrderStatus(checkpassOrder.getStatus());</span><br><span class="line">                detailVO.setAuthor(checkpassReport.getAuthor());</span><br><span class="line">                detailVO.setTitle(checkpassReport.getTitle());</span><br><span class="line">                detailVO.setProgress(checkpassReport.getCopyPercent() == <span class="literal">null</span> ? <span class="number">0</span> : checkpassReport.getCopyPercent());</span><br><span class="line">                detailVO.setCheckVersion(CommonUtil.getCheckVersion(checkpassOrder.getJaneName()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> SseUtils.sendMessage(orderId, JSON.toJSONString(detailVO));</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (torder.getStatus() == Common.ORDER_FINISH_STATUS) &#123;</span><br><span class="line">                <span class="comment">// 订单完成，主动关闭连接</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    emitter.send(SseEmitter.event().reconnectTime(<span class="number">5000L</span>).data(<span class="string">&quot;SSE关闭连接&quot;</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                SseUtils.removeClientId(orderId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li></ul><h1 id="使用过程中的一些坑"><a href="#使用过程中的一些坑" class="headerlink" title="使用过程中的一些坑"></a>使用过程中的一些坑</h1><ol><li>在使用过程中，浏览器中查看接口一直显示待处理状态，但我的Java服务确确实实已经推送了数据。<ul><li>如果你等待了一会儿，发现请求响应成功，但是一次性推送了很多条消息，那么大概率是缓冲区的问题，因为SSE是流式输出，流式输出通常会涉及到缓冲区的使用。在Java Servlet中，HttpServletResponse对象的输出流会有一个缓冲区。当使用Servlet的输出流写入数据时，这些数据首先会被写入缓冲区，然后才会被发送到客户端。所以我们需要再代码中禁用掉。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpServletResponse.setHeader(<span class="string">&quot;X-Accel-Buffering&quot;</span>, <span class="string">&quot;no&quot;</span>);</span><br></pre></td></tr></table></figure></li><li>同时Nginx里也要加上同样的配置，如果你中间经过了多级Nginx，需要每一级Nginx都禁用此项。<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_buffering</span> <span class="literal">off</span>;</span><br></pre></td></tr></table></figure></li></ul></li><li>如果你使用了阿里云的CDN服务，那么请设置为动态加速</li><li>服务端无法到客户端网络中断：客户端网络中断后，服务端无法感知到客户端断开连接，就会导致服务端的线程中的任务一直在运行，不断地给这个客户端推送消息。解决方案如下：<ol><li>通过给不同的业务场景给服务端设置不同的最大连接时长，超过这个时长，服务端会主动地去断开这个连接。</li><li>客户端感知断开连接的通知之后，如果当前订单任务还未结束，那么客户端会重新建立连接，直到订单任务结束，这样做能避免一些无效会话一直在推送消息的问题。</li></ol></li><li>客户端重连机制：如果客户端因为网络问题或者其他问题进行了断线，那么客户端会根据服务端发送的retry参数设置的时间间隔进行重连，而这个时候服务端是暂时无法感知到客户端已经断线了，所以还是会在持续地去给客户端推送消息。假如客户端重连成功之后，就会出现以下两种场景：<ol><li>服务端未断开连接：复用之前的连接线路，客户端会一次性收到多条断线期间未收到的消息内容，这个时候客户端使用限流，只更新最后一条消息，减少DOM渲染。</li><li>服务端主动断开了连接（订单任务结束断开/达到最大连接时长）：重新建立一条线路（之前的那条线路其实还是存在的），因为是一条新线路所以之前断线时，服务端发送的消息，是收不到的。</li></ol></li><li>如何保证用户在同一个业务场景下只会建立一条连接？<ol><li>这也就是上面标黄处提到的问题，之前的会话id都是服务端来生成，最后修改为客户端来生成会话id并且临时保存在本地策略就是（业务ID - 用户token后20位 - 页面RUNTIME_ID），这个样做的原因主要还是确保用户在同一个业务场景下或者在断线重连时 客户端每次向服务端建立连接的会话id都是相同的，从而方便后面 服务端断开之前的线路。</li><li>由于服务端采用的是HashMap来存储每个SSE对象，所以在插入id相同的会话的时候，会直接替换map中已经存在的会话，虽然之前的会话已经不存在了，但是其建立的连接并没有真正的断开，所以服务端在新的会话插入之前，先去显式地去将之前的会话执行一次断开连接的操作，然后再去执行创建连接操作。否则，当多余的线路达到一定的数量之后，客户端会出现线路阻塞的问题。</li></ol></li><li>新的会话加入之后，如何中断旧会话占用的线程？<ul><li>一开始的逻辑是将会话id保留在线程之中，具体流程是：判断当前会话是否存在 -&gt; 存在就推送消息 -&gt; sleep n秒。这样的处理的话就会出现一个问题，虽然我们在这里判断了会话id是否存在，但是由于上面我们在替换旧会话的时候，又重新创建了一个相同id的新会话（在同一个业务场景下多次建立连接，每次的会话id是一样的），所以当前线程sleep结束之后，会发现这个会话是存在的，从而会继续给这个会话推送消息。这个时候客户端会收到多个不同线程发送来的消息的问题。解决方案如下：<ol><li>在每次建立连接的时候将会话和该会话的所属线程关联在一起，也就是将管理会话的map由原来的 <code>Map&lt;String, SseEmitter&gt;</code>类型，修改为： <code>Map&lt;String, SseEmitterInfo&gt;</code>   类型，其中SseEmitterInfo是我们自己封装的一个类，其中包含SseEmitter对象和建立该连接时的线程名。</li><li>在发送消息之前，需要判断当前会话是否存在，并且判断该会话所属的线程是否是当前线程，如果满足上面两个条件的话，就推送消息；否则，中断线程；这样就可以保证每一个会话只会有一个线程在推送消息。</li></ol></li></ul></li></ol><p><img src="https://s11.ax1x.com/2024/02/24/pFUyKFP.png" alt=""></p><h1 id="一些补充"><a href="#一些补充" class="headerlink" title="一些补充"></a>一些补充</h1><ul><li>后续实际使用的时候，我又对SseUtils进行了改进，最终版本如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.aimc.paperreduction.common.wrapper.RWrappers;</span><br><span class="line"><span class="keyword">import</span> com.aimc.paperreduction.model.enums.ErrorCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SseUtil</span> &#123;</span><br><span class="line">    <span class="comment">// 为了避免内存泄露，这里最好设置一个超时时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">DEFAULT_TIME_OUT</span> <span class="operator">=</span> <span class="number">30L</span> * <span class="number">60</span> *  <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">// 会话map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, SseEmitterInfo&gt; conversationMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 断开连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">disconnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="type">SseEmitterInfo</span> <span class="variable">instance</span> <span class="operator">=</span> SseUtil.getInstance(conversationId);</span><br><span class="line">        <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">            instance.getEmitter().complete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 建立连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitter <span class="title function_">getConnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建 SseEmitterInfo</span></span><br><span class="line">        <span class="type">SseEmitterInfo</span> <span class="variable">sseEmitterInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitterInfo</span>(conversationId);</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>(DEFAULT_TIME_OUT);</span><br><span class="line">        sseEmitterInfo.setEmitter(sseEmitter);</span><br><span class="line">        <span class="comment">// 异常</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置前端重试时5s</span></span><br><span class="line">            sseEmitter.send(SseEmitter.event().reconnectTime(<span class="number">5_000L</span>).data(JSONObject.toJSONString(RWrappers.Fail(ErrorCodeEnum.SSE_CONNECT_SUCCESS))));</span><br><span class="line">            <span class="comment">// 连接超时</span></span><br><span class="line">            sseEmitter.onTimeout(() -&gt; SseUtil.timeout(conversationId));</span><br><span class="line">            <span class="comment">// 连接断开</span></span><br><span class="line">            sseEmitter.onCompletion(() -&gt; SseUtil.completion(conversationId));</span><br><span class="line">            <span class="comment">// 错误</span></span><br><span class="line">            sseEmitter.onError((e) -&gt; SseUtil.error(conversationId, e.getMessage()));</span><br><span class="line">            <span class="comment">// 添加sse</span></span><br><span class="line">            conversationMap.put(conversationId, sseEmitterInfo);</span><br><span class="line">            <span class="comment">// 连接成功</span></span><br><span class="line">            log.info(<span class="string">&quot;创建sse连接成功 ==&gt; 当前连接总数=&#123;&#125;， 会话Id=&#123;&#125;&quot;</span>, conversationMap.size(), conversationId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// 日志</span></span><br><span class="line">            log.error(<span class="string">&quot;前端重连异常 ==&gt; 会话Id=&#123;&#125;, 异常信息=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回</span></span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 获取消息实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitterInfo <span class="title function_">getInstance</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.get(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 给指定会话发送消息，如果发送失败，返回false</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jsonMsg        - 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String conversationId, String jsonMsg)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断该会话是否还在Map中，不存在则删除</span></span><br><span class="line">        <span class="keyword">if</span> (!conversationMap.containsKey(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 已建立连接</span></span><br><span class="line">        <span class="keyword">if</span> (SseUtil.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 发送消息</span></span><br><span class="line">                SseUtil.getInstance(conversationId).getEmitter().send(jsonMsg, MediaType.APPLICATION_JSON);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// 日志</span></span><br><span class="line">                SseUtil.removeClientId(conversationId);</span><br><span class="line">                log.error(<span class="string">&quot;发送消息异常 ==&gt; 会话Id=&#123;&#125;, 异常信息=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 未建立连接</span></span><br><span class="line">            log.error(<span class="string">&quot;连接不存在或者超时 ==&gt; 会话Id=&#123;&#125;会话自动关闭&quot;</span>, conversationId);</span><br><span class="line">            SseUtil.removeClientId(conversationId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除并断开会话Id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// 不存在存在会话</span></span><br><span class="line">        <span class="keyword">if</span> (!SseUtil.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 删除该会话</span></span><br><span class="line">        conversationMap.remove(conversationId);</span><br><span class="line">        SseUtil.disconnect(conversationId);</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line">         log.info(<span class="string">&quot;移除会话成功 ==&gt; 会话Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取是否存在会话</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">getIsExistClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.containsKey(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前连接总数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - 连接总数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getConnectTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;当前连接数：&#123;&#125;&quot;</span>, conversationMap.size());</span><br><span class="line">        <span class="keyword">return</span> conversationMap.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 超时</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">timeout</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line">        log.error(<span class="string">&quot;sse连接超时 ==&gt; 会话Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">        <span class="comment">// 移除会话</span></span><br><span class="line">        SseUtil.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 完成</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">completion</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line">        log.info(<span class="string">&quot;sse连接已断开 ==&gt; 会话Id：&#123;&#125;，当前剩余连接数：&#123;&#125;&quot;</span>, conversationId, conversationMap.size());</span><br><span class="line">        <span class="comment">// 移除会话</span></span><br><span class="line">        SseUtil.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String 会话Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String conversationId, String message)</span> &#123;</span><br><span class="line">        <span class="comment">// 日志</span></span><br><span class="line"><span class="comment">//        log.error(&quot;sse服务异常 ==&gt; 会话Id=&#123;&#125;, 异常信息=&#123;&#125;&quot;, conversationId, message);</span></span><br><span class="line">        <span class="comment">// 移除会话</span></span><br><span class="line">        SseUtil.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SseEmitterInfo</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> SseEmitter emitter;</span><br><span class="line">        <span class="keyword">private</span> String threadName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SseEmitterInfo</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.emitter = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">this</span>.threadName = Thread.currentThread().getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> SseEmitter <span class="title function_">getEmitter</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> emitter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmitter</span><span class="params">(SseEmitter emitter)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.emitter = emitter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getThreadName</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> threadName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setThreadName</span><span class="params">(String threadName)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.threadName = threadName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>实际使用如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/connSse&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">connSse</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> SseUtil.getConnect(conversationId);</span><br><span class="line">    executor.execute(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// 这里需要保证同一个会话ID只有一个线程处理</span></span><br><span class="line">        SseUtil.getInstance(conversationId).setThreadName(Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">while</span> (!Thread.interrupted() &amp;&amp; SseUtil.getInstance(conversationId) != <span class="literal">null</span> &amp;&amp; SseUtil.getInstance(conversationId).getThreadName().equals(Thread.currentThread().getName())) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">sendSuccess</span> <span class="operator">=</span> SseUtil.sendMessage(conversationId, JSONObject.toJSONString(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">10</span>]));</span><br><span class="line">            log.info(<span class="string">&quot;向会话：&#123;&#125;，推送&quot;</span>, conversationId);</span><br><span class="line">            <span class="keyword">if</span> (!sendSuccess) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;=========连接不存在，服务端主动关闭SSE连接=========&quot;</span>);</span><br><span class="line">                SseUtil.removeClientId(conversationId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 每一秒推送一次数据</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>由于我这里的业务限制，只能这么用SSE。原有的业务逻辑是，我轮询算法接口，更新数据，然后前端轮询我的接口，更新页面状态。使用了SSE之后变成了，我轮询算法接口，更新数据，然后向前端推送数据。</li><li>但是更好的处理方式是，我这边给算法提供一个回调的接口，当算法有进度更新时，调用我这个回调接口，然后我在这个回调逻辑里向前端推送数据，这样逻辑上其实是更顺的，后续有时间，打算和算法侧聊聊这块，进一步优化。</li></ul>]]></content>
    
    
    <summary type="html">Server-Sent Events 服务器推送事件，简称 SSE，是一种服务端实时主动向浏览器推送消息的技术。</summary>
    
    
    
    <category term="随写" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SSE" scheme="https://cyborg2077.github.io/tags/SSE/"/>
    
  </entry>
  
</feed>
