<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Kyle&#39;s Blog</title>
  
  
  <link href="https://cyborg2077.github.io/atom.xml" rel="self"/>
  
  <link href="https://cyborg2077.github.io/"/>
  <updated>2024-02-25T12:34:05.630Z</updated>
  <id>https://cyborg2077.github.io/</id>
  
  <author>
    <name>Kyle Violet</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å®ç°ä¸€ä¸ªCacheï¼ŒåŒ…æ‹¬LRUå’Œåœ¨Xç§’åè¿‡æœŸçš„é€»è¾‘</title>
    <link href="https://cyborg2077.github.io/2024/02/25/LRUCacheExpire/"/>
    <id>https://cyborg2077.github.io/2024/02/25/LRUCacheExpire/</id>
    <published>2024-02-25T06:56:38.000Z</published>
    <updated>2024-02-25T12:34:05.630Z</updated>
    
    <content type="html"><![CDATA[<h1>LRUï¼ˆLeast Recently Usedï¼‰</h1><ul><li>æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œå®ƒçš„è®¾è®¡åŸåˆ™å€Ÿé‰´äº†<code>æ—¶é—´å±€éƒ¨æ€§åŸç†</code>ï¼Œè¯¥ç®—æ³•è®¤ä¸ºå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜ï¼Œåä¹‹äº¦ç„¶ã€‚å…¶åŸç†æ˜¯å°†æ•°æ®æŒ‰ç…§å…¶è¢«è®¿é—®çš„æ—¶é—´å½¢æˆä¸€ä¸ªæœ‰åºåºåˆ—ï¼Œæœ€ä¹…æœªè¢«ä½¿ç”¨çš„æ•°æ®åº”è¯¥æœ€æ—©è¢«æ·˜æ±°æ‰ï¼Œå³å½“ç¼“å­˜ç©ºé—´è¢«å æ»¡æ—¶ï¼Œç¼“å­˜å†…æœ€é•¿æ—¶é—´æœªè¢«ä½¿ç”¨çš„æ•°æ®å°†è¢«æ·˜æ±°æ‰ã€‚</li></ul><h1>å¤§è‡´æ€è·¯</h1><ul><li>å¯ä»¥ç®€å•çš„ç»´æŠ¤ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥å®ç°ï¼Œæ¯å½“æ•°æ®è¢«è®¿é—®æ—¶ï¼Œä½¿ç”¨å¤´æ’æ³•æ’å…¥åˆ°é˜Ÿé¦–ã€‚ç©ºé—´å æ»¡æ—¶ï¼Œå…ˆç§»é™¤æœ«å°¾å…ƒç´ ï¼Œéšåå¯¹æ–°å…ƒç´ ä½¿ç”¨å¤´æ’æ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        Node pre, next;</span><br><span class="line">        <span class="type">int</span> key, value;</span><br><span class="line">        Node(<span class="type">int</span> key, <span class="type">int</span> value) &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Node</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="type">Node</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    Map&lt;Integer, Node&gt; map;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æä¾›åˆå§‹åŒ–ç¼“å­˜çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LRUCache</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(size);</span><br><span class="line">        head.next = tail;</span><br><span class="line">        tail.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å‘½ä¸­ç¼“å­˜ï¼Œå°†å…¶ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            remove(node);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">            res = node.value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="comment">// å‘½ä¸­ç¼“å­˜ï¼Œä¿®æ”¹é”®å€¼ï¼Œå¹¶ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="comment">// 1. ä¿®æ”¹é”®å€¼</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            node.value = value;</span><br><span class="line">            <span class="comment">// ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">            remove(node);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœªå‘½ä¸­ç¼“å­˜ï¼Œåˆ¤æ–­ç¼“å­˜æ˜¯å¦å·²æ»¡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">mapSize</span> <span class="operator">=</span> map.size();</span><br><span class="line">            <span class="comment">// å·²æ»¡åˆ™ç§»é™¤é˜Ÿå°¾å…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> (mapSize == size) &#123;</span><br><span class="line">                map.remove(tail.pre.key);</span><br><span class="line">                remove(tail.pre);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ’å…¥æ–°å…ƒç´ </span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(key, value);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">            map.put(key, node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        node.pre.next = node.next;</span><br><span class="line">        node.next.pre = node.pre;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertToHead</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">firstNode</span> <span class="operator">=</span> head.next;</span><br><span class="line">        head.next = node;</span><br><span class="line">        firstNode.pre = node;</span><br><span class="line">        node.next = firstNode;</span><br><span class="line">        node.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åŸºæœ¬çš„ç¼“å­˜é€»è¾‘å†™å¥½äº†ï¼Œé‚£ä¹ˆå¦‚ä½•ç¼–å†™è¿‡æœŸé€»è¾‘å‘¢ï¼Ÿè¿™é‡Œé‡‡ç”¨çš„æ˜¯æƒ°æ€§åˆ é™¤ï¼Œå¦‚æœæŸ¥è¯¢è¯¥å…ƒç´ æ—¶ï¼Œå‘ç°è¯¥å…ƒç´ å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆç§»é™¤è¯¥å…ƒç´ ã€‚å½“æ’å…¥å…ƒç´ æ—¶ï¼Œéœ€è¦éå†æ‰€æœ‰çš„keyï¼Œç„¶ååˆ é™¤ï¼Œå½“ç„¶è¿™ä¸ªåˆ¤æ–­æ¡ä»¶ä¹Ÿå¯ä»¥æ˜¯å½“ç¼“å­˜æ»¡äº†çš„æ—¶å€™å†æ‰§è¡Œã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        Node pre, next;</span><br><span class="line">        <span class="type">int</span> key, value;</span><br><span class="line">        <span class="type">long</span> expireTime;</span><br><span class="line"></span><br><span class="line">        Node(<span class="type">int</span> key, <span class="type">int</span> value, <span class="type">long</span> expireTime) &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.expireTime = expireTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Node</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="type">Node</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    Map&lt;Integer, Node&gt; map;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æä¾›åˆå§‹åŒ–ç¼“å­˜çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LRUCache</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(size);</span><br><span class="line">        head.next = tail;</span><br><span class="line">        tail.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å‘½ä¸­ç¼“å­˜ï¼Œå°†å…¶ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            <span class="keyword">if</span> (node.expireTime &gt; System.currentTimeMillis()) &#123;</span><br><span class="line">                remove(node);</span><br><span class="line">                insertToHead(node);</span><br><span class="line">                res = node.value;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;å½“å‰èŠ‚ç‚¹è¿‡æœŸï¼š&quot;</span> + key);</span><br><span class="line">                remove(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value, <span class="type">long</span> expireTime)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ é™¤æ‰€æœ‰è¿‡æœŸçš„key</span></span><br><span class="line">        map.entrySet().removeIf(entry -&gt; &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> entry.getValue().expireTime &lt;= System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">if</span> (b) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ç§»é™¤keyï¼š&quot;</span> + entry.getValue().key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘½ä¸­ç¼“å­˜ï¼Œä¿®æ”¹é”®å€¼ï¼Œå¹¶ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">            <span class="comment">// 1. ä¿®æ”¹é”®å€¼</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            node.value = value;</span><br><span class="line">            <span class="comment">// ç§»åŠ¨åˆ°é˜Ÿé¦–</span></span><br><span class="line">            remove(node);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœªå‘½ä¸­ç¼“å­˜ï¼Œåˆ¤æ–­ç¼“å­˜æ˜¯å¦å·²æ»¡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">mapSize</span> <span class="operator">=</span> map.size();</span><br><span class="line">            <span class="comment">// å·²æ»¡åˆ™ç§»é™¤é˜Ÿå°¾å…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> (mapSize == size) &#123;</span><br><span class="line">                map.remove(tail.pre.key);</span><br><span class="line">                remove(tail.pre);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ’å…¥æ–°å…ƒç´ </span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(key, value, expireTime);</span><br><span class="line">            insertToHead(node);</span><br><span class="line">            map.put(key, node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        node.pre.next = node.next;</span><br><span class="line">        node.next.pre = node.pre;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertToHead</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">firstNode</span> <span class="operator">=</span> head.next;</span><br><span class="line">        head.next = node;</span><br><span class="line">        firstNode.pre = node;</span><br><span class="line">        node.next = firstNode;</span><br><span class="line">        node.pre = head;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸‹é¢ç®€å•å†™ä¸ªmainæ–¹æ³•éªŒè¯ä¸€ä¸‹ï¼ŒæŸ¥çœ‹æ—¥å¿—æ˜¯å¦ç¬¦åˆé¢„æœŸ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">LRUCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LRUCache</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¯·è¾“å…¥æ“ä½œï¼šget æˆ– put&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">operation</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;get&quot;</span>.equalsIgnoreCase(operation)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;è¯·è¾“å…¥è¦è·å–çš„é”®ï¼š&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> scanner.nextInt();</span><br><span class="line">                scanner.nextLine(); <span class="comment">// æ¸…é™¤ç¼“å†²åŒºä¸­çš„æ¢è¡Œç¬¦</span></span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line">                <span class="keyword">if</span> (value != -<span class="number">1</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;é”® &quot;</span> + key + <span class="string">&quot; å¯¹åº”çš„å€¼ä¸ºï¼š&quot;</span> + value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;é”® &quot;</span> + key + <span class="string">&quot; ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;put&quot;</span>.equalsIgnoreCase(operation)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;è¯·è¾“å…¥è¦æ”¾å…¥çš„é”®ï¼š&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> scanner.nextInt();</span><br><span class="line">                System.out.println(<span class="string">&quot;è¯·è¾“å…¥è¦æ”¾å…¥çš„å€¼ï¼š&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> scanner.nextInt();</span><br><span class="line">                System.out.println(<span class="string">&quot;è¯·è¾“å…¥è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼š&quot;</span>);</span><br><span class="line">                <span class="type">long</span> <span class="variable">expireTime</span> <span class="operator">=</span> scanner.nextLong();</span><br><span class="line">                scanner.nextLine();</span><br><span class="line"></span><br><span class="line">                cache.put(key, value, System.currentTimeMillis() + expireTime);</span><br><span class="line">                System.out.println(<span class="string">&quot;é”®å€¼å¯¹å·²æ”¾å…¥ç¼“å­˜&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ— æ•ˆçš„æ“ä½œï¼Œè¯·é‡æ–°è¾“å…¥&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ€è¿‘æœ‰äº›æ‡ˆæ€ äº†ï¼Œåˆ·åˆ·é¢˜ï¼Œè¿™ç§åº•å±‚å®ç°è¿˜æ˜¯æŒºæœ‰æ„æ€çš„</summary>
    
    
    
    <category term="è¸©å‘æ—¥è®°" scheme="https://cyborg2077.github.io/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Navicatåœ¨ç»“æ„åŒæ­¥æ—¶çš„æ³¨æ„äº‹é¡¹</title>
    <link href="https://cyborg2077.github.io/2024/02/07/NavicatSyncPit/"/>
    <id>https://cyborg2077.github.io/2024/02/07/NavicatSyncPit/</id>
    <published>2024-02-07T03:27:30.000Z</published>
    <updated>2024-02-24T05:54:31.066Z</updated>
    
    <content type="html"><![CDATA[<h1>æ¶‰åŠåˆ°åˆ—åä¿®æ”¹æ—¶ï¼Œä¸è¦ä½¿ç”¨Navicatç»“æ„åŒæ­¥å·¥å…·</h1><ul><li>æœ¬åœ°ç¯å¢ƒçš„è¡¨ç»“æ„å¦‚ä¸‹</li></ul><table><thead><tr><th>id</th><th>phone</th><th>invite_code</th></tr></thead><tbody><tr><td>1</td><td>123-456-789</td><td>ABC123</td></tr><tr><td>2</td><td>987-654-321</td><td>DEF456</td></tr><tr><td>3</td><td>555-555-555</td><td>GHI789</td></tr></tbody></table><ul><li>ç”Ÿäº§ç¯å¢ƒçš„è¡¨ç»“æ„å¦‚ä¸‹</li></ul><table><thead><tr><th>id</th><th>phone</th><th>user_id</th></tr></thead><tbody><tr><td>1</td><td>123-456-789</td><td>ABC123</td></tr><tr><td>2</td><td>987-654-321</td><td>DEF456</td></tr><tr><td>3</td><td>555-555-555</td><td>GHI789</td></tr></tbody></table><ul><li>è‹¥æ­¤æ—¶ä½¿ç”¨Navicatæä¾›çš„ç»“æ„åŒæ­¥å·¥å…·ï¼Œå®é™…ä¸Šæ‰§è¡Œçš„å‘½ä»¤ä¼šæ˜¯å°†åŸæœ‰çš„åˆ—åˆ é™¤ï¼Œç„¶åå†æ–°å¢ï¼Œä¼šå¯¼è‡´è¯¥åˆ—çš„å†…å®¹å®Œå…¨ä¸¢å¤±</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> `invite_code`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">DROP</span> INDEX `idx_invite_code`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> `user_id` <span class="type">varchar</span>(<span class="number">255</span>) AFTER `phone`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `user_info` <span class="keyword">ADD</span> INDEX `idx_invite_code`(`user_id` <span class="keyword">ASC</span>) <span class="keyword">USING</span> BTREE;</span><br></pre></td></tr></table></figure><ul><li>è‹¥ä»…ä¿®æ”¹å­—æ®µåï¼Œå»ºè®®ä½¿ç”¨RENAMEå‘½ä»¤</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> user_info </span><br><span class="line">RENAME <span class="keyword">COLUMN</span> invite_code <span class="keyword">TO</span> user_id</span><br></pre></td></tr></table></figure><ul><li>è‹¥è¿˜æ¶‰åŠåˆ°å­—æ®µå®šä¹‰ä¿®æ”¹ï¼Œå»ºè®®ä½¿ç”¨CHANGE COLUMNå‘½ä»¤</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> user_info</span><br><span class="line">CHANGE <span class="keyword">COLUMN</span> invite_code user_id <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">åœ¨ä¿®æ”¹å­—æ®µåæ—¶ï¼ŒNavicatæä¾›çš„SQLæ˜¯å…ˆåˆ é™¤è¿™åˆ—å†æ–°å¢</summary>
    
    
    
    <category term="è¸©å‘æ—¥è®°" scheme="https://cyborg2077.github.io/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>LangChainå…¥é—¨æŒ‡å—</title>
    <link href="https://cyborg2077.github.io/2024/01/26/LangChainPrimer/"/>
    <id>https://cyborg2077.github.io/2024/01/26/LangChainPrimer/</id>
    <published>2024-01-26T03:27:30.000Z</published>
    <updated>2024-02-24T05:54:06.954Z</updated>
    
    <content type="html"><![CDATA[<h1>ä»€ä¹ˆæ˜¯LangChain</h1><ul><li>LangChainæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘äººå‘˜ä½¿ç”¨è¯­è¨€æ¨¡å‹æ„å»ºç«¯åˆ°ç«¯çš„åº”ç”¨ç¨‹åºã€‚å®ƒæä¾›äº†ä¸€å¥—å·¥å…·ã€ç»„ä»¶å’Œæ¥å£ï¼Œå¯ç®€åŒ–åˆ›å»ºç”±å¤§å‹è¯­è¨€æ¨¡å‹ (LLM) å’ŒèŠå¤©æ¨¡å‹æä¾›æ”¯æŒçš„åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ã€‚LangChain å¯ä»¥è½»æ¾ç®¡ç†ä¸è¯­è¨€æ¨¡å‹çš„äº¤äº’ï¼Œå°†å¤šä¸ªç»„ä»¶é“¾æ¥åœ¨ä¸€èµ·ï¼Œå¹¶é›†æˆé¢å¤–çš„èµ„æºï¼Œä¾‹å¦‚ API å’Œæ•°æ®åº“ã€‚</li><li>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://python.langchain.com/en/latest/">https://python.langchain.com/en/latest/</a></li></ul><h1>å¦‚ä½•ä½¿ç”¨LangChain</h1><ul><li>è¦ä½¿ç”¨ LangChainï¼Œå¼€å‘äººå‘˜é¦–å…ˆè¦å¯¼å…¥å¿…è¦çš„ç»„ä»¶å’Œå·¥å…·ï¼Œä¾‹å¦‚ LLMs, chat models, agents, chains, å†…å­˜åŠŸèƒ½ã€‚è¿™äº›ç»„ä»¶ç»„åˆèµ·æ¥åˆ›å»ºä¸€ä¸ªå¯ä»¥ç†è§£ã€å¤„ç†å’Œå“åº”ç”¨æˆ·è¾“å…¥çš„åº”ç”¨ç¨‹åºã€‚</li><li>LangChain ä¸ºç‰¹å®šç”¨ä¾‹æä¾›äº†å¤šç§ç»„ä»¶ï¼Œä¾‹å¦‚ä¸ªäººåŠ©ç†ã€æ–‡æ¡£é—®ç­”ã€èŠå¤©æœºå™¨äººã€æŸ¥è¯¢è¡¨æ ¼æ•°æ®ã€ä¸ API äº¤äº’ã€æå–ã€è¯„ä¼°å’Œæ±‡æ€»ã€‚</li></ul><h1>LangChainçš„æ¨¡å‹</h1><ul><li>LangChain model æ˜¯ä¸€ç§æŠ½è±¡ï¼Œè¡¨ç¤ºæ¡†æ¶ä¸­ä½¿ç”¨çš„ä¸åŒç±»å‹çš„æ¨¡å‹ã€‚LangChain ä¸­çš„æ¨¡å‹ä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š<ol><li>LLMï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼‰ï¼šè¿™äº›æ¨¡å‹å°†æ–‡æœ¬å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥å¹¶è¿”å›æ–‡æœ¬å­—ç¬¦ä¸²ä½œä¸ºè¾“å‡ºã€‚å®ƒä»¬æ˜¯è®¸å¤šè¯­è¨€æ¨¡å‹åº”ç”¨ç¨‹åºçš„æ”¯æŸ±ã€‚</li><li>èŠå¤©æ¨¡å‹( Chat Model)ï¼šèŠå¤©æ¨¡å‹ç”±è¯­è¨€æ¨¡å‹æ”¯æŒï¼Œä½†å…·æœ‰æ›´ç»“æ„åŒ–çš„ APIã€‚ä»–ä»¬å°†èŠå¤©æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºè¾“å…¥å¹¶è¿”å›èŠå¤©æ¶ˆæ¯ã€‚è¿™ä½¿å¾—ç®¡ç†å¯¹è¯å†å²è®°å½•å’Œç»´æŠ¤ä¸Šä¸‹æ–‡å˜å¾—å®¹æ˜“ã€‚</li><li>æ–‡æœ¬åµŒå…¥æ¨¡å‹(Text Embedding Models)ï¼šè¿™äº›æ¨¡å‹å°†æ–‡æœ¬ä½œä¸ºè¾“å…¥å¹¶è¿”å›è¡¨ç¤ºæ–‡æœ¬åµŒå…¥çš„æµ®ç‚¹åˆ—è¡¨ã€‚è¿™äº›åµŒå…¥å¯ç”¨äºæ–‡æ¡£æ£€ç´¢ã€èšç±»å’Œç›¸ä¼¼æ€§æ¯”è¾ƒç­‰ä»»åŠ¡ã€‚</li></ol></li></ul><h1>LangChain çš„ä¸»è¦ç‰¹ç‚¹</h1><ul><li>LangChain æ—¨åœ¨ä¸ºå…­ä¸ªä¸»è¦é¢†åŸŸçš„å¼€å‘äººå‘˜æä¾›æ”¯æŒï¼š<ol><li>LLM å’Œæç¤ºï¼šLangChain ä½¿ç®¡ç†æç¤ºã€ä¼˜åŒ–å®ƒä»¬ä»¥åŠä¸ºæ‰€æœ‰ LLM åˆ›å»ºé€šç”¨ç•Œé¢å˜å¾—å®¹æ˜“ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜åŒ…æ‹¬ä¸€äº›ç”¨äºå¤„ç† LLM çš„ä¾¿æ·å®ç”¨ç¨‹åºã€‚</li><li>é“¾(Chain)ï¼šè¿™äº›æ˜¯å¯¹ LLM æˆ–å…¶ä»–å®ç”¨ç¨‹åºçš„è°ƒç”¨åºåˆ—ã€‚LangChain ä¸ºé“¾æä¾›æ ‡å‡†æ¥å£ï¼Œä¸å„ç§å·¥å…·é›†æˆï¼Œä¸ºæµè¡Œåº”ç”¨æä¾›ç«¯åˆ°ç«¯çš„é“¾ã€‚</li><li>æ•°æ®å¢å¼ºç”Ÿæˆï¼šLangChain ä½¿é“¾èƒ½å¤Ÿä¸å¤–éƒ¨æ•°æ®æºäº¤äº’ä»¥æ”¶é›†ç”Ÿæˆæ­¥éª¤çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥å¸®åŠ©æ€»ç»“é•¿æ–‡æœ¬æˆ–ä½¿ç”¨ç‰¹å®šæ•°æ®æºå›ç­”é—®é¢˜ã€‚</li><li>Agentsï¼šAgents è®© LLM åšå‡ºæœ‰å…³è¡ŒåŠ¨çš„å†³å®šï¼Œé‡‡å–è¿™äº›è¡ŒåŠ¨ï¼Œæ£€æŸ¥ç»“æœï¼Œå¹¶ç»§ç»­å‰è¿›ç›´åˆ°å·¥ä½œå®Œæˆã€‚LangChain æä¾›äº†ä»£ç†çš„æ ‡å‡†æ¥å£ï¼Œå¤šç§ä»£ç†å¯ä¾›é€‰æ‹©ï¼Œä»¥åŠç«¯åˆ°ç«¯çš„ä»£ç†ç¤ºä¾‹ã€‚</li><li>å†…å­˜ï¼šLangChain æœ‰ä¸€ä¸ªæ ‡å‡†çš„å†…å­˜æ¥å£ï¼Œæœ‰åŠ©äºç»´æŠ¤é“¾æˆ–ä»£ç†è°ƒç”¨ä¹‹é—´çš„çŠ¶æ€ã€‚å®ƒè¿˜æä¾›äº†ä¸€ç³»åˆ—å†…å­˜å®ç°å’Œä½¿ç”¨å†…å­˜çš„é“¾æˆ–ä»£ç†çš„ç¤ºä¾‹ã€‚</li><li>è¯„ä¼°ï¼šå¾ˆéš¾ç”¨ä¼ ç»ŸæŒ‡æ ‡è¯„ä¼°ç”Ÿæˆæ¨¡å‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ LangChain æä¾›æç¤ºå’Œé“¾æ¥å¸®åŠ©å¼€å‘è€…è‡ªå·±ä½¿ç”¨ LLM è¯„ä¼°ä»–ä»¬çš„æ¨¡å‹ã€‚</li></ol></li></ul><h1>ä½¿ç”¨ç¤ºä¾‹</h1><h2 id="æç¤ºæ¨¡æ¿ï¼ˆPromptTemplateï¼‰">æç¤ºæ¨¡æ¿ï¼ˆPromptTemplateï¼‰</h2><ol><li>æ”¯æŒæˆ‘ä»¬æ¥è‡ªå®šä¹‰æç¤ºæ¨¡æ¿ï¼Œä¸ä¼šå°†ç”¨æˆ·è¾“å…¥ç›´æ¥å‘é€åˆ° LLMï¼Œè€Œæ˜¯æ¥æ”¶ç”¨æˆ·çš„è¾“å…¥ï¼Œç„¶åæ„é€ ä¸€ä¸ªpromptå°†å…¶å‘é€ç»™ LLMã€‚</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts import PromptTemplate</span><br><span class="line"></span><br><span class="line">prompt = PromptTemplate(</span><br><span class="line">    input_variables=[<span class="string">&quot;paperTitle&quot;</span>, <span class="string">&quot;area&quot;</span>, <span class="string">&quot;nums&quot;</span>, <span class="string">&quot;keywords&quot;</span>],</span><br><span class="line">    <span class="attribute">template</span>=<span class="string">&quot;æˆ‘æƒ³è®©ä½ å……å½“&#123;area&#125;é¢†åŸŸçš„ä¸“å®¶ï¼Œé’ˆå¯¹äº&#123;paperTitle&#125;è¿™ä¸ªä¸»é¢˜ï¼Œå¸®æˆ‘æ’°å†™ä¸€ç¯‡&#123;nums&#125;å­—çš„æ–‡çŒ®ç»¼è¿°ã€‚åŒ…å«çš„å…³é”®å­—å¦‚ä¸‹ï¼š&#123;keywords&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(prompt.format(<span class="attribute">paperTitle</span>=<span class="string">&quot;å¤§å­¦ç”Ÿç½‘çº¢äº§å“æ¶ˆè´¹è¡Œä¸ºç ”ç©¶&quot;</span>, <span class="attribute">area</span>=<span class="string">&quot;ç»æµå­¦&quot;</span>, <span class="attribute">nums</span>=500, <span class="attribute">keywords</span>=<span class="string">&quot;å¤§å­¦ç”Ÿã€ç½‘çº¢ã€æ¶ˆè´¹ã€è¡Œä¸ºç ”ç©¶&quot;</span>))</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šæˆ‘æƒ³è®©ä½ å……å½“ç»æµå­¦é¢†åŸŸçš„ä¸“å®¶ï¼Œé’ˆå¯¹äºå¤§å­¦ç”Ÿç½‘çº¢äº§å“æ¶ˆè´¹è¡Œä¸ºç ”ç©¶è¿™ä¸ªä¸»é¢˜ï¼Œå¸®æˆ‘æ’°å†™ä¸€ç¯‡500å­—çš„æ–‡çŒ®ç»¼è¿°ã€‚åŒ…å«çš„å…³é”®å­—å¦‚ä¸‹ï¼šå¤§å­¦ç”Ÿã€ç½‘çº¢ã€æ¶ˆè´¹ã€è¡Œä¸ºç ”ç©¶</span></span><br></pre></td></tr></table></figure><h2 id="LLM-Chain">LLM Chain</h2><ul><li>æˆ‘ä»¬å¯ä»¥æŠŠåˆå§‹åŒ–å¥½çš„LLMå’ŒTemplateï¼Œç»„åˆæˆä¸€ä¸ªchain</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. åˆå§‹åŒ–llm</span></span><br><span class="line">llm = ChatOpenAI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œå…¶å®å°±å¯ä»¥ç›´æ¥è°ƒç”¨llmäº†</span></span><br><span class="line">llm.invoke(<span class="string">&quot;how can langsmith help with testing?&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. è¿™é‡Œå¯ä»¥åˆå§‹åŒ–ä¸€ä¸ªæ¨¡æ¿</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line">prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;ä½ æ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„ç§‘å¹»å°è¯´ä½œè€…&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. é‡‡ç”¨è¿™ç§æ–¹å¼å¯ä»¥å°†llmå’Œtemplateç»„åˆæˆä¸€ä¸ªchain</span></span><br><span class="line">chain = prompt | llm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. è°ƒç”¨ç»„åˆåçš„chain</span></span><br><span class="line">chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;ä½ å¯¹LangSmithäº†è§£å—ï¼Ÿ&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><h2 id="Retrieval-Chainï¼ˆåŸºäºæ£€ç´¢çš„chainï¼‰">Retrieval Chainï¼ˆåŸºäºæ£€ç´¢çš„chainï¼‰</h2><ul><li>å½“ä½ éœ€è¦è®©LLMå›ç­”ä¸€ä¸ªé—®é¢˜æ—¶ï¼ˆæ¯”å¦‚ â€œhow can langsmith help with testing?â€ï¼‰ï¼Œæœ‰æ—¶å€™ä½ è¦æä¾›çš„æç¤ºä¿¡æ¯å¯èƒ½å¤ªå¤šï¼Œç›´æ¥ä¼ é€’ç»™è¯­è¨€æ¨¡å‹å¯èƒ½ä¸å¤Ÿæœ‰æ•ˆã€‚ä¸ºäº†æä¾›æ›´å¤šä¸Šä¸‹æ–‡ï¼ŒLangChainæä¾›äº†é€šè¿‡æ£€ç´¢ï¼ˆretrievalï¼‰çš„æ–¹å¼è·å–ç›¸å…³çš„æ–‡æ¡£ï¼Œå¹¶å°†è¿™äº›æ–‡æ¡£ä¼ é€’ç»™è¯­è¨€æ¨¡å‹ã€‚</li><li>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ£€ç´¢å™¨ï¼ˆRetrieverï¼‰æ¥æŸ¥æ‰¾ç›¸å…³çš„æ–‡æ¡£ï¼Œç„¶åå°†è¿™äº›æ–‡æ¡£ä¼ é€’ç»™æç¤ºæ¨¡æ¿ã€‚æ£€ç´¢å™¨å¯ä»¥ç”±å„ç§æ•°æ®æ”¯æŒï¼Œæ¯”å¦‚ä¸€ä¸ª SQL è¡¨ã€äº’è”ç½‘ä¸Šçš„æ•°æ®ç­‰ï¼Œä½†åœ¨å®˜ç½‘çš„Demoé‡Œï¼Œå°†ä½¿ç”¨ä¸€ä¸ªå‘é‡å­˜å‚¨ï¼ˆvector storeï¼‰æ¥ä½œä¸ºæ£€ç´¢å™¨ã€‚</li><li>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åŠ è½½è¦ç´¢å¼•çš„æ•°æ®ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ WebBaseLoaderï¼ˆè¿™ä¸ªåº”è¯¥æ˜¯LangChainå†…éƒ¨å®ç°çš„ä¸€ä¸ªçˆ¬è™«å·¥å…·ï¼Œè¦ä¾èµ–äºBeautifulSoup<br>pip install beautifulsoup4</li><li>å¼•å…¥WebBaseLocderæ¥çˆ¬å–å†…å®¹</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> WebBaseLoader</span><br><span class="line"></span><br><span class="line">loader = WebBaseLoader(<span class="string">&quot;https://docs.smith.langchain.com/overview&quot;</span>)</span><br><span class="line">docs = loader.load()</span><br><span class="line"><span class="built_in">print</span>(docs)</span><br><span class="line"><span class="comment"># [Document(page_content=&#x27;\n\n\n\n\nLangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith\n\n\n\n\n\nSkip to main contentğŸ¦œï¸ğŸ› ï¸ LangSmith DocsPython DocsJS/TS DocsSearchGo to AppLangSmithOverviewTracingTesting &amp; EvaluationOrganizationsHubLangSmith CookbookOverviewOn this pageLangSmith Overview and User GuideBuilding reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.Over the past two months, we at LangChain have been building and using LangSmith with the goal of bridging this gap. This is our tactical user guide to outline effective ways to use LangSmith and maximize its benefits.On by default\u200bAt LangChain, all of us have LangSmithâ€™s tracing running in the background by default. On the Python side, this is achieved by setting environment variables, which we establish whenever we launch a virtual environment or open our bash shell and leave them set. The same principle applies to most JavaScript environments through process.env1.The benefit here is that all calls to LLMs, chains, agents, tools, and retrievers are logged to LangSmith. Around 90% of the time we donâ€™t even look at the traces, but the 10% of the time that we doâ€¦ itâ€™s so helpful. We can use LangSmith to debug:An unexpected end resultWhy an agent is loopingWhy a chain was slower than expectedHow many tokens an agent usedDebugging\u200bDebugging LLMs, chains, and agents can be tough. LangSmith helps solve the following pain points:What was the exact input to the LLM?\u200bLLM calls are often tricky and non-deterministic. The inputs/outputs may seem straightforward, given they are technically string â†’ string (or chat messages â†’ chat message), but this can be misleading as the input string is usually constructed from a combination of user input and auxiliary functions.Most inputs to an LLM call are a combination of some type of fixed template along with input variables. These input variables could come directly from user input or from an auxiliary function (like retrieval). By the time these input variables go into the LLM they will have been converted to a string format, but often times they are not naturally represented as a string (they could be a list, or a Document object). Therefore, it is important to have visibility into what exactly the final string going into the LLM is. This has helped us debug bugs in formatting logic, unexpected transformations to user input, and straight up missing user input.To a much lesser extent, this is also true of the output of an LLM. Oftentimes the output of an LLM is technically a string but that string may contain some structure (json, yaml) that is intended to be parsed into a structured representation. Understanding what the exact output is can help determine if there may be a need for different parsing.LangSmith provides a straightforward visualization of the exact inputs/outputs to all LLM calls, so you can easily understand them.If I edit the prompt, how does that affect the output?\u200bSo you notice a bad output, and you go into LangSmith to see what\&#x27;s going on. You find the faulty LLM call and are now looking at the exact input. You want to try changing a word or a phrase to see what happens -- what do you do?We constantly ran into this issue. Initially, we copied the prompt to a playground of sorts. But this got annoying, so we built a playground of our own! When examining an LLM call, you can click the Open in Playground button to access this playground. Here, you can modify the prompt and re-run it to observe the resulting changes to the output - as many times as needed!Currently, this feature supports only OpenAI and Anthropic models and works for LLM and Chat Model calls. We plan to extend its functionality to more LLM types, chains, agents, and retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith\&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we\&#x27;ve added a â€œShareâ€ button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it\&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, itâ€™s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you\&#x27;re wandering blind. You donâ€™t have any examples to benchmark your changes against.LangSmith addresses this problem by including an â€œAdd to Datasetâ€ button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different\ninputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat weâ€™ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If weâ€™re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.\nYou can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.Weâ€™ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing â€” mirroring the debug mode approach.Weâ€™ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We\&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these arenâ€™t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.â†©PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright Â© 2024 LangChain, Inc.\n\n\n\n&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)]</span></span><br><span class="line"><span class="comment"># è¿™é‡Œè¾“å‡ºçš„docså°±æ˜¯ç½‘é¡µä¸Šçš„å†…å®¹</span></span><br></pre></td></tr></table></figure><ul><li>ç„¶åæˆ‘ä»¬éœ€è¦å°†è¿™äº›æ–‡æ¡£ç´¢å¼•åˆ°ä¸€ä¸ªå‘é‡å­˜å‚¨ä¸­ã€‚è¿™éœ€è¦ä¸€äº›ç»„ä»¶ï¼ŒåŒ…æ‹¬åµŒå…¥æ¨¡å‹ï¼ˆembedding modelï¼‰å’Œå‘é‡å­˜å‚¨ã€‚<ol><li>æ£€ç´¢å™¨ï¼ˆRetrieverï¼‰ï¼š æƒ³è±¡ä¸€ä¸‹ä½ åœ¨å›¾ä¹¦é¦†æ‰¾ä¹¦çš„æ—¶å€™ï¼Œä½ å¯èƒ½ä¸ä¼šæŠŠæ•´ä¸ªå›¾ä¹¦é¦†çš„ä¹¦éƒ½æ‹¿å»çœ‹ã€‚ç›¸åï¼Œä½ å¯èƒ½ä¼šå’¨è¯¢å›¾ä¹¦ç®¡ç†å‘˜æˆ–è€…æŸ¥æ‰¾å›¾ä¹¦é¦†çš„ç›®å½•ï¼Œæ‰¾åˆ°ä¸ä½ é—®é¢˜ç›¸å…³çš„ä¹¦ç±ã€‚åœ¨è¿™é‡Œï¼Œæ£€ç´¢å™¨å°±åƒå›¾ä¹¦é¦†çš„ç›®å½•ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°ä¸é—®é¢˜ç›¸å…³çš„ä¿¡æ¯ã€‚</li><li>å‘é‡å­˜å‚¨ï¼ˆVector Storeï¼‰ï¼š è¿™å°±åƒä¸€ä¸ªå¤§ä»“åº“ï¼Œé‡Œé¢å­˜æ”¾ç€å„ç§å„æ ·çš„ä¿¡æ¯ã€‚æ¯ä¸ªä¿¡æ¯éƒ½ç”¨ä¸€ä¸ªå‘é‡è¡¨ç¤ºï¼Œå°±åƒæ˜¯ä»“åº“ä¸­çš„ä¸€ä¸ªç®±å­ã€‚é€šè¿‡è¿™äº›å‘é‡ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ‰¾åˆ°å­˜å‚¨åº“ä¸­ä¸æˆ‘ä»¬å…³å¿ƒçš„ä¸»é¢˜ç›¸å…³çš„ä¿¡æ¯ã€‚</li><li>åµŒå…¥æ¨¡å‹ï¼ˆEmbedding Modelï¼‰ï¼š è¿™å°±åƒæ˜¯ä¸€ä¸ªç¿»è¯‘å·¥äººï¼Œå®ƒå°†æ–‡æ¡£ä¸­çš„æ–‡å­—ç¿»è¯‘æˆè®¡ç®—æœºèƒ½å¤Ÿç†è§£çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯å‘é‡ã€‚è¿™æ ·ï¼Œè®¡ç®—æœºå°±èƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†å’Œæ¯”è¾ƒæ–‡æ¡£ï¼Œæ‰¾åˆ°æœ€ç›¸å…³çš„ä¿¡æ¯ã€‚</li></ol></li></ul><h2 id="æ ¹æ®æ–‡æ¡£æ„å»ºå‘é‡">æ ¹æ®æ–‡æ¡£æ„å»ºå‘é‡</h2><ol><li>ä½¿ç”¨ OpenAIEmbeddings åˆå§‹åŒ–ä¸€ä¸ªåµŒå…¥æ¨¡å‹ï¼Œç”¨äºå°†æ–‡æ¡£è½¬åŒ–ä¸ºå‘é‡ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"></span><br><span class="line">embeddings = OpenAIEmbeddings()</span><br></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æœ¬åœ°å‘é‡å­˜å‚¨ FAISS æ¥å»ºç«‹ç´¢å¼•.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install faiss-cpu</span><br></pre></td></tr></table></figure><ol start="3"><li>æ„å»ºå‘é‡å­˜å‚¨</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡æœ¬åˆ†å‰²å™¨</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter()</span><br><span class="line"><span class="comment"># å°†åˆšåˆšè·å–çš„docsåˆ†å‰²ï¼Œè¾“å‡ºæ˜¯ä¸€ä¸ªList&lt;String&gt;çš„ç±»å‹</span></span><br><span class="line">documents = text_splitter.split_documents(docs)</span><br><span class="line"><span class="comment"># æ ¹æ®åµŒå…¥æ¨¡å‹å’Œåˆ†å‰²åçš„æ–‡æ¡£ï¼Œè½¬æ¢ä¸ºå‘é‡</span></span><br><span class="line">vector = FAISS.from_documents(documents, embeddings)</span><br></pre></td></tr></table></figure><h2 id="æ„å»ºé“¾">æ„å»ºé“¾</h2><ol><li>æ„å»ºä¸€ä¸ªé“¾ï¼Œè¯¥é“¾æ¥å—é—®é¢˜å’Œæ£€ç´¢åˆ°çš„æ–‡æ¡£ï¼Œç”Ÿæˆç­”æ¡ˆï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.combine_documents <span class="keyword">import</span> create_stuff_documents_chain</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;Answer the following question based only on the provided context:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;context&gt;</span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string">&lt;/context&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Question: &#123;input&#125;&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">document_chain = create_stuff_documents_chain(llm, prompt)</span><br></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨æ£€ç´¢å™¨åŠ¨æ€é€‰æ‹©æœ€ç›¸å…³çš„æ–‡æ¡£å¹¶ä¼ é€’ç»™é“¾ï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_retrieval_chain</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œçš„vectoræ˜¯æˆ‘ä»¬ç¬¬ä¸€æ­¥æ„å»ºçš„å‘é‡ï¼Œå°†å…¶è½¬æ¢ä¸ºæ£€ç´¢å™¨</span></span><br><span class="line">retriever = vector.as_retriever()</span><br><span class="line">retrieval_chain = create_retrieval_chain(retriever, document_chain)</span><br></pre></td></tr></table></figure><ol start="3"><li>è°ƒç”¨è¿™ä¸ªé“¾ï¼Œæ¥è·å–å“åº”ç»“æœï¼Œè¿™ä¸ªç­”æ¡ˆåº”è¯¥æ›´åŠ å‡†ç¡®ï¼Œå› ä¸ºå®ƒç»“åˆäº†æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£å’ŒåŸå§‹é—®é¢˜ã€‚è¿™æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸ºäº†ä½¿å¾—è¯­è¨€æ¨¡å‹åœ¨å›ç­”é—®é¢˜æ—¶èƒ½å¤ŸåŸºäºæ›´å…¨é¢çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = retrieval_chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;how can langsmith help with testing?&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><h2 id="å®Œæ•´demo">å®Œæ•´demo</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_retrieval_chain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.combine_documents <span class="keyword">import</span> create_stuff_documents_chain</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> WebBaseLoader</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.ollama <span class="keyword">import</span> Ollama</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores.faiss <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> OllamaEmbeddings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">llm = Ollama(model=<span class="string">&quot;llama2&quot;</span>)</span><br><span class="line"><span class="comment"># åˆå§‹åŒ–åµŒå…¥æ¨¡å‹</span></span><br><span class="line"></span><br><span class="line">embeddings = OllamaEmbeddings()</span><br><span class="line"></span><br><span class="line"><span class="comment"># çˆ¬å–å†…å®¹</span></span><br><span class="line">loader = WebBaseLoader(<span class="string">&quot;https://docs.smith.langchain.com/overview&quot;</span>)</span><br><span class="line">docs = loader.load()</span><br><span class="line"><span class="built_in">print</span>(docs)</span><br><span class="line"><span class="comment"># æ–‡æœ¬åˆ†å‰²å™¨</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter()</span><br><span class="line"><span class="comment"># å°†åˆšåˆšè·å–çš„docsåˆ†å‰²</span></span><br><span class="line">documents = text_splitter.split_documents(docs)</span><br><span class="line"><span class="built_in">print</span>(documents)</span><br><span class="line"><span class="comment"># æ ¹æ®åµŒå…¥æ¨¡å‹å’Œåˆ†å‰²åçš„æ–‡æ¡£ï¼Œè½¬æ¢ä¸ºå‘é‡</span></span><br><span class="line">vector = FAISS.from_documents(documents, embeddings)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è½¬æ¢æˆå‘é‡å®Œæ¯•&quot;</span>)</span><br><span class="line"><span class="comment"># å°†å‘é‡è½¬æ¢ä¸ºæ£€ç´¢å™¨</span></span><br><span class="line">retriever = vector.as_retriever()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å°†å‘é‡è½¬æ¢ä¸ºæ£€ç´¢å™¨&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºé—®é¢˜é“¾</span></span><br><span class="line">prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;Answer the following question based only on the provided context:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;context&gt;</span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string">&lt;/context&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Question: &#123;input&#125;&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">document_chain = create_stuff_documents_chain(llm, prompt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ„å»ºé—®é¢˜å®Œæ¯•&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æ£€ç´¢å™¨åŠ¨æ€é€‰æ‹©æœ€ç›¸å…³çš„æ–‡æ¡£å¹¶ä¼ é€’ç»™é“¾ï¼š</span></span><br><span class="line">retrieval_chain = create_retrieval_chain(retriever, document_chain)</span><br><span class="line"><span class="comment"># æœ€ç»ˆè°ƒç”¨</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å¼€å§‹è°ƒç”¨&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = retrieval_chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;how can langsmith help with testing?&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è°ƒç”¨å®Œæ¯•&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡ºå¦‚ä¸‹</li></ul><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Document(page_content=<span class="comment">&#x27;\n\n\n\n\nLangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith\n\n\n\n\n\nSkip to main contentğŸ¦œï¸ğŸ› ï¸ LangSmith DocsPython DocsJS/TS DocsSearchGo to AppLangSmithOverviewTracingTesting &amp; EvaluationOrganizationsHubLangSmith CookbookOverviewOn this pageLangSmith Overview and User GuideBuilding reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.Over the past two months, we at LangChain have been building and using LangSmith with the goal of bridging this gap. This is our tactical user guide to outline effective ways to use LangSmith and maximize its benefits.On by default\u200bAt LangChain, all of us have LangSmithâ€™s tracing running in the background by default. On the Python side, this is achieved by setting environment variables, which we establish whenever we launch a virtual environment or open our bash shell and leave them set. The same principle applies to most JavaScript environments through process.env1.The benefit here is that all calls to LLMs, chains, agents, tools, and retrievers are logged to LangSmith. Around 90% of the time we donâ€™t even look at the traces, but the 10% of the time that we doâ€¦ itâ€™s so helpful. We can use LangSmith to de<span class="doctag">bug:</span>An unexpected end resultWhy an agent is loopingWhy a chain was slower than expectedHow many tokens an agent usedDebugging\u200bDebugging LLMs, chains, and agents can be tough. LangSmith helps solve the following pain points:What was the exact input to the LLM?\u200bLLM calls are often tricky and non-deterministic. The inputs/outputs may seem straightforward, given they are technically string â†’ string (or chat messages â†’ chat message), but this can be misleading as the input string is usually constructed from a combination of user input and auxiliary functions.Most inputs to an LLM call are a combination of some type of fixed template along with input variables. These input variables could come directly from user input or from an auxiliary function (like retrieval). By the time these input variables go into the LLM they will have been converted to a string format, but often times they are not naturally represented as a string (they could be a list, or a Document object). Therefore, it is important to have visibility into what exactly the final string going into the LLM is. This has helped us debug bugs in formatting logic, unexpected transformations to user input, and straight up missing user input.To a much lesser extent, this is also true of the output of an LLM. Oftentimes the output of an LLM is technically a string but that string may contain some structure (json, yaml) that is intended to be parsed into a structured representation. Understanding what the exact output is can help determine if there may be a need for different parsing.LangSmith provides a straightforward visualization of the exact inputs/outputs to all LLM calls, so you can easily understand them.If I edit the prompt, how does that affect the output?\u200bSo you notice a bad output, and you go into LangSmith to see what\&#x27;s going on. You find the faulty LLM call and are now looking at the exact input. You want to try changing a word or a phrase to see what happens -- what do you do?We constantly ran into this issue. Initially, we copied the prompt to a playground of sorts. But this got annoying, so we built a playground of our own! When examining an LLM call, you can click the Open in Playground button to access this playground. Here, you can modify the prompt and re-run it to observe the resulting changes to the output - as many times as needed!Currently, this feature supports only OpenAI and Anthropic models and works for LLM and Chat Model calls. We plan to extend its functionality to more LLM types, chains, agents, and retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith\&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we\&#x27;ve added a â€œShareâ€ button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it\&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, itâ€™s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you\&#x27;re wandering blind. You donâ€™t have any examples to benchmark your changes against.LangSmith addresses this problem by including an â€œAdd to Datasetâ€ button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different\ninputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat weâ€™ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If weâ€™re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.\nYou can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.Weâ€™ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing â€” mirroring the debug mode approach.Weâ€™ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We\&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these arenâ€™t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.â†©PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright Â© 2024 LangChain, Inc.\n\n\n\n&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)]</span></span><br><span class="line">[Document(page_content=<span class="comment">&#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;Skip to main contentğŸ¦œï¸ğŸ› ï¸ LangSmith DocsPython DocsJS/TS DocsSearchGo to AppLangSmithOverviewTracingTesting &amp; EvaluationOrganizationsHubLangSmith CookbookOverviewOn this pageLangSmith Overview and User GuideBuilding reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.Over the past two months, we at LangChain have been building and using LangSmith with the goal of bridging this gap. This is our tactical user guide to outline effective ways to use LangSmith and maximize its benefits.On by default\u200bAt LangChain, all of us have LangSmithâ€™s tracing running in the background by default. On the Python side, this is achieved by setting environment variables, which we establish whenever we launch a virtual environment or open our bash shell and leave them set. The same principle applies to most JavaScript environments through process.env1.The benefit here is that all calls to LLMs, chains, agents, tools, and retrievers are logged to LangSmith. Around 90% of the time we donâ€™t even look at the traces, but the 10% of the time that we doâ€¦ itâ€™s so helpful. We can use LangSmith to de<span class="doctag">bug:</span>An unexpected end resultWhy an agent is loopingWhy a chain was slower than expectedHow many tokens an agent usedDebugging\u200bDebugging LLMs, chains, and agents can be tough. LangSmith helps solve the following pain points:What was the exact input to the LLM?\u200bLLM calls are often tricky and non-deterministic. The inputs/outputs may seem straightforward, given they are technically string â†’ string (or chat messages â†’ chat message), but this can be misleading as the input string is usually constructed from a combination of user input and auxiliary functions.Most inputs to an LLM call are a combination of some type of fixed template along with input variables. These input variables could come directly from user input or from an auxiliary function (like retrieval). By the time these input variables go into the LLM they will have been converted to a string format, but often times they are not naturally represented as a string (they could be a list, or a Document object). Therefore, it is important to have visibility into what exactly the final string going into the LLM is. This has helped us debug bugs in formatting logic, unexpected transformations to user input, and straight up missing user input.To a much lesser extent, this is also true of the output of an LLM. Oftentimes the output of an LLM is technically a string but that string may contain some structure (json, yaml) that is intended to be parsed into a structured representation. Understanding what the exact output is can help determine if there may be a need for different parsing.LangSmith provides a straightforward visualization of the exact inputs/outputs to all LLM calls, so you can easily understand them.If I edit the prompt, how does that affect the output?\u200bSo you notice a bad output, and you go into LangSmith to see what&#x27;s going on. You find the faulty LLM call and are now looking at the exact input. You want to try changing a word or a phrase to see what happens -- what do you do?We constantly ran into this issue. Initially, we copied the prompt to a playground of sorts. But this got annoying, so we built a playground of our own! When examining an LLM call, you can click the Open in Playground button to access this playground. Here, you can modify the prompt and re-run it to observe the resulting changes to the output - as many times as needed!Currently, this feature supports only OpenAI and Anthropic models and works for LLM and Chat Model calls. We plan to extend its functionality to more LLM types, chains, agents, and retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we&#x27;ve added a â€œShareâ€ button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, itâ€™s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you&#x27;re wandering blind. You donâ€™t have any examples to benchmark your changes against.LangSmith addresses this problem by including an â€œAdd to Datasetâ€ button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&#x27;inputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat weâ€™ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If weâ€™re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;You can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.Weâ€™ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing â€” mirroring the debug mode approach.Weâ€™ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these arenâ€™t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.â†©PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright Â© 2024 LangChain, Inc.&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)]</span></span><br><span class="line">è½¬æ¢æˆå‘é‡å®Œæ¯•</span><br><span class="line">å°†å‘é‡è½¬æ¢ä¸ºæ£€ç´¢å™¨</span><br><span class="line">æ„å»ºé—®é¢˜å®Œæ¯•</span><br><span class="line">å¼€å§‹è°ƒç”¨</span><br><span class="line">è°ƒç”¨å®Œæ¯•</span><br><span class="line">&#123;<span class="comment">&#x27;input&#x27;: &#x27;how can langsmith help with testing?&#x27;, &#x27;context&#x27;: [Document(page_content=&quot;You can also quickly edit examples and add them to datasets to expand the surface area of your evaluation sets or to fine-tune a model for improved quality or reduced costs.Monitoring\u200bAfter all this, your app might finally ready to go in production. LangSmith can also be used to monitor your application in much the same way that you used for debugging. You can log all traces, visualize latency and token usage statistics, and troubleshoot specific issues as they arise. Each run can also be assigned string tags or key-value metadata, allowing you to attach correlation ids or AB test variants, and filter runs accordingly.Weâ€™ve also made it possible to associate feedback programmatically with runs. This means that if your application has a thumbs up/down button on it, you can use that to log feedback back to LangSmith. This can be used to track performance over time and pinpoint under performing data points, which you can subsequently add to a dataset for future testing â€” mirroring the debug mode approach.Weâ€™ve provided several examples in the LangSmith documentation for extracting insights from logged runs. In addition to guiding you on performing this task yourself, we also provide examples of integrating with third parties for this purpose. We&#x27;re eager to expand this area in the coming months! If you have ideas for either -- an open-source way to evaluate, or are building a company that wants to do analytics over these runs, please reach out.Exporting datasets\u200bLangSmith makes it easy to curate datasets. However, these arenâ€™t just useful inside LangSmith; they can be exported for use in other contexts. Notable applications include exporting for use in OpenAI Evals or fine-tuning, such as with FireworksAI.To set up tracing in Deno, web browsers, or other runtime environments without access to the environment, check out the FAQs.â†©PreviousLangSmithNextTracingOn by defaultDebuggingWhat was the exact input to the LLM?If I edit the prompt, how does that affect the output?What is the exact sequence of events?Why did my chain take much longer than expected?How many tokens were used?Collaborative debuggingCollecting examplesTesting &amp; evaluationHuman EvaluationMonitoringExporting datasetsCommunityDiscordTwitterGitHubDocs CodeLangSmith SDKPythonJS/TSMoreHomepageBlogCopyright Â© 2024 LangChain, Inc.&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&#x27;inputs, and see what happens. At some point though, our application is performing\nwell and we want to be more rigorous about testing changes. We can use a dataset\nthat weâ€™ve constructed along the way (see above). Alternatively, we could spend some\ntime constructing a small dataset by hand. For these situations, LangSmith simplifies\ndataset uploading.Once we have a dataset, how can we use it to test changes to a prompt or chain? The most basic approach is to run the chain over the data points and visualize the outputs. Despite technological advancements, there still is no substitute for looking at outputs by eye. Currently, running the chain over the data points needs to be done client-side. The LangSmith client makes it easy to pull down a dataset and then run a chain over them, logging the results to a new project associated with the dataset. From there, you can review them. We\&#x27;ve made it easy to assign feedback to runs and mark them as correct or incorrect directly in the web app, displaying aggregate statistics for each test project.We also make it easier to evaluate these runs. To that end, we\&#x27;ve added a set of evaluators to the open-source LangChain library. These evaluators can be specified when initiating a test run and will evaluate the results once the test run completes. If weâ€™re being honest, most of these evaluators aren\&#x27;t perfect. We would not recommend that you trust them blindly. However, we do think they are useful for guiding your eye to examples you should look at. This becomes especially valuable as the number of data points increases and it becomes infeasible to look at each one manually.Human Evaluation\u200bAutomatic evaluation metrics are helpful for getting consistent and scalable information about model behavior;\nhowever, there is still no complete substitute for human review to get the utmost quality and reliability from your application.\nLangSmith makes it easy to manually review and annotate runs through annotation queues.These queues allow you to select any runs based on criteria like model type or automatic evaluation scores, and queue them up for human review. As a reviewer, you can then quickly step through the runs, viewing the input, output, and any existing tags before adding your own feedback.We often use this for a couple of reasons:To assess subjective qualities that automatic evaluators struggle with, like creativity or humorTo sample and validate a subset of runs that were auto-evaluated, ensuring the automatic metrics are still reliable and capturing the right informationAll the annotations made using the queue are assigned as &quot;feedback&quot; to the source runs, so you can easily filter and analyze them later.&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;), Document(page_content=&quot;retrievers in the future.What is the exact sequence of events?\u200bIn complicated chains and agents, it can often be hard to understand what is going on under the hood. What calls are being made? In what order? What are the inputs and outputs of each call?LangSmith&#x27;s built-in tracing feature offers a visualization to clarify these sequences. This tool is invaluable for understanding intricate and lengthy chains and agents. For chains, it can shed light on the sequence of calls and how they interact. For agents, where the sequence of calls is non-deterministic, it helps visualize the specific sequence for a given run -- something that is impossible to know ahead of time.Why did my chain take much longer than expected?\u200bIf a chain takes longer than expected, you need to identify the cause. By tracking the latency of each step, LangSmith lets you identify and possibly eliminate the slowest components.How many tokens were used?\u200bBuilding and prototyping LLM applications can be expensive. LangSmith tracks the total token usage for a chain and the token usage of each step. This makes it easy to identify potentially costly parts of the chain.Collaborative debugging\u200bIn the past, sharing a faulty chain with a colleague for debugging was challenging when performed locally. With LangSmith, we&#x27;ve added a â€œShareâ€ button that makes the chain and LLM runs accessible to anyone with the shared link.Collecting examples\u200bMost of the time we go to debug, it&#x27;s because something bad or unexpected outcome has happened in our application. These failures are valuable data points! By identifying how our chain can fail and monitoring these failures, we can test future chain versions against these known issues.Why is this so impactful? When building LLM applications, itâ€™s often common to start without a dataset of any kind. This is part of the power of LLMs! They are amazing zero-shot learners, making it possible to get started as easily as possible. But this can also be a curse -- as you adjust the prompt, you&#x27;re wandering blind. You donâ€™t have any examples to benchmark your changes against.LangSmith addresses this problem by including an â€œAdd to Datasetâ€ button for each run, making it easy to add the input/output examples a chosen dataset. You can edit the example before adding them to the dataset to include the expected result, which is particularly useful for bad examples.This feature is available at every step of a nested chain, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model.End-to-end chain examples are excellent for testing the overall flow, while single, modular LLM Chain or LLM/Chat Model examples can be beneficial for testing the simplest and most directly modifiable components.Testing &amp; evaluation\u200bInitially, we do most of our evaluation manually and ad hoc. We pass in different&quot;, metadata=&#123;&#x27;source&#x27;: &#x27;https://docs.smith.langchain.com/overview&#x27;, &#x27;title&#x27;: &#x27;LangSmith Overview and User Guide | ğŸ¦œï¸ğŸ› ï¸ LangSmith&#x27;, &#x27;description&#x27;: &#x27;Building reliable LLM applications can be challenging. LangChain simplifies the initial setup, but there is still work needed to bring the performance of prompts, chains and agents up the level where they are reliable enough to be used in production.&#x27;, &#x27;language&#x27;: &#x27;en&#x27;&#125;)], &#x27;answer&#x27;: &#x27;LangSmith can assist with testing by providing various features to simplify dataset uploading, running chains over the data points, visualizing the outputs, and evaluating the results. Here are some ways LangSmith can help with testing:\n\n1. Easy dataset uploading: LangSmith simplifies dataset uploading, making it easier to construct a small dataset by hand or use an existing one.\n2. Running chains over data points: Once you have a dataset, LangSmith allows you to run the chain over the data points and visualize the outputs. You can review the outputs directly in the web app by assigning feedback to runs and marking them as correct or incorrect.\n3. Evaluating results: LangSmith adds a set of evaluators to the open-source LangChain library, which can be specified when initiating a test run. These evaluators will evaluate the results once the test run completes, providing valuable information for guiding your eye to examples you should look at.\n4. Manual testing and annotation: LangSmith makes it easy to manually review and annotate runs through a visualization of the sequence of events, helping identify subjective qualities that automatic evaluators struggle with.\n5. Tracking token usage: LangSmith tracks the total token usage for a chain and the token usage of each step, making it easier to identify potentially costly parts of the chain.\n6. Collecting examples: LangSmith includes an &quot;Add to Dataset&quot; button for each run, enabling you to add examples for an end-to-end chain, an intermediary chain (such as a LLM Chain), or simply the LLM or Chat Model. This feature is available at every step of a nested chain, making it easier to test the overall flow and individual components.\n\nBy leveraging these features, LangSmith can help streamline your testing process and provide valuable insights into your LLM application\&#x27;s performance.&#x27;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Conversation-Retrieval-Chainï¼ˆå¯¹è¯æ£€ç´¢é“¾ï¼‰">Conversation Retrieval Chainï¼ˆå¯¹è¯æ£€ç´¢é“¾ï¼‰</h2><ul><li>æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„é“¾åªèƒ½å›ç­”å•ä¸€çš„é—®é¢˜ï¼Œä½†æœ‰äº›åº”ç”¨åœºæ™¯éœ€è¦æ„å»ºå¯¹è¯å‹çš„èŠå¤©æœºå™¨äººã€‚</li><li>ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨create_retrieval_chainå‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ”¹å˜ä¸¤ä»¶äº‹ï¼š<ul><li>æ£€ç´¢æ–¹æ³•ç°åœ¨ä¸åº”ä»…é€‚ç”¨äºæœ€è¿‘çš„è¾“å…¥ï¼Œè€Œåº”è€ƒè™‘æ•´ä¸ªå†å²è®°å½•ã€‚</li><li>æœ€ç»ˆçš„ LLM é“¾åŒæ ·åº”è¯¥è€ƒè™‘æ•´ä¸ªå†å²<br>æ›´æ–°æ£€ç´¢ï¼ˆretrievalï¼‰<br>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„é“¾ï¼Œè¿™ä¸ªé“¾å°†æ¥å—æœ€è¿‘çš„ç”¨æˆ·è¾“å…¥ï¼ˆinputï¼‰å’Œæ•´ä¸ªå¯¹è¯å†å²ï¼ˆchat_historyï¼‰ï¼Œç„¶åä½¿ç”¨è¯­è¨€æ¨¡å‹ç”Ÿæˆä¸€ä¸ªæœç´¢æŸ¥è¯¢ã€‚è¿™é‡Œä½¿ç”¨äº† create_history_aware_retriever å‡½æ•°æ¥å®ç°è¿™ä¸ªæ–°é“¾ã€‚</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_history_aware_retriever</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> MessagesPlaceholder</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªæç¤ºæ¨¡æ¿ï¼Œç”¨äºæ ¹æ®å¯¹è¯å†å²ç”Ÿæˆæœç´¢æŸ¥è¯¢</span></span><br><span class="line">prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;chat_history&quot;</span>),  <span class="comment"># å¯¹è¯å†å²çš„å ä½ç¬¦</span></span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),  <span class="comment"># ç”¨æˆ·è¾“å…¥çš„å ä½ç¬¦</span></span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;åœ¨ä¸Šè¿°å¯¹è¯çš„åŸºç¡€ä¸Šï¼Œç”Ÿæˆä¸€ä¸ªæœç´¢æŸ¥è¯¢ï¼Œä»¥è·å–ä¸å¯¹è¯ç›¸å…³çš„ä¿¡æ¯&quot;</span>)  <span class="comment"># ç”Ÿæˆæœç´¢æŸ¥è¯¢çš„æŒ‡ä»¤ï¼ŒåŸºäºå¯¹è¯å†…å®¹</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ£€ç´¢å™¨é“¾ï¼Œæ•´åˆè¯­è¨€æ¨¡å‹ã€æ£€ç´¢å™¨å’Œå®šä¹‰çš„æç¤º</span></span><br><span class="line">retriever_chain = create_history_aware_retriever(llm, retriever, prompt)</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬å¯ä»¥ä¼ å…¥åç»­çš„é—®é¢˜å®ä¾‹æ¥æµ‹è¯•è¿™ä¸€ç‚¹</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage, AIMessage</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å¯¹è¯å†å²ï¼ŒåŒ…æ‹¬äººç±»æ¶ˆæ¯å’ŒAIæ¶ˆæ¯</span></span><br><span class="line">chat_history = [HumanMessage(content=<span class="string">&quot;LangSmithå¯ä»¥å¸®åŠ©æˆ‘æµ‹è¯•Appå—ï¼Ÿ&quot;</span>), AIMessage(content=<span class="string">&quot;Yes!&quot;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨æ£€ç´¢å™¨é“¾ï¼Œä¼ å…¥å¯¹è¯å†å²å’Œç”¨æˆ·è¾“å…¥</span></span><br><span class="line">retriever_chain.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;chat_history&quot;</span>: chat_history,</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;å‘Šè¯‰æˆ‘æ€ä¹ˆåš&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>æ­¤æ—¶çš„è¾“å‡ºåº”è¯¥æ˜¯ä¼šè¿”å›æœ‰å…³ LangSmith ä¸­æµ‹è¯•çš„æ–‡æ¡£ã€‚è¿™æ˜¯å› ä¸ºLLMç”Ÿæˆäº†ä¸€ä¸ªæ–°æŸ¥è¯¢ï¼Œå°†èŠå¤©å†å²è®°å½•ä¸åç»­é—®é¢˜ç›¸ç»“åˆã€‚</li><li>ç°åœ¨æˆ‘ä»¬æœ‰äº†è¿™ä¸ªæ–°çš„æ£€ç´¢å™¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„é“¾æ¥ç»§ç»­ä¸è¿™äº›æ£€ç´¢åˆ°çš„æ–‡æ¡£è¿›è¡Œå¯¹è¯ã€‚</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">prompt</span> = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;æ ¹æ®ä¸Šä¸‹æ–‡å›ç­”ç”¨æˆ·çš„é—®é¢˜\n\n&#123;context&#125;&quot;</span>),</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;chat_history&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="attr">document_chain</span> = create_stuff_documents_chain(llm, prompt)</span><br><span class="line"><span class="attr">retrieval_chain</span> = create_retrieval_chain(retriever_chain, document_chain)</span><br></pre></td></tr></table></figure><ul><li>ç°åœ¨è¿›è¡Œæ•´ä½“çš„æµ‹è¯•ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chat_history = [HumanMessage(content=<span class="string">&quot;LangSmithå¯ä»¥å¸®åŠ©æˆ‘æµ‹è¯•Appå—ï¼Ÿ&quot;</span>), AIMessage(content=<span class="string">&quot;Yes!&quot;</span>)]</span><br><span class="line"></span><br><span class="line">retriever_chain.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;chat_history&quot;</span>: chat_history,</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;å‘Šè¯‰æˆ‘æ€ä¹ˆåš&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>ä¼šå‡ºäº†ä¸€ä¸ªè¿è´¯çš„ç­”æ¡ˆï¼Œè¡¨æ˜æˆ‘ä»¬å·²ç»æˆåŠŸåœ°å°†æ£€ç´¢é“¾å˜æˆäº†èŠå¤©æœºå™¨äºº</li></ul><h2 id="Agent">Agent</h2><ul><li>æ„å»ºä»£ç†æ—¶è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å†³å®šå®ƒåº”è¯¥æœ‰æƒè®¿é—®å“ªäº›å·¥å…·ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ºä»£ç†æä¾›ä¸¤ä¸ªå·¥å…·çš„è®¿é—®æƒé™ï¼š<ol><li>æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ£€ç´¢å™¨ã€‚è¿™å°†è®©å®ƒè½»æ¾å›ç­”æœ‰å…³ LangSmith çš„é—®é¢˜</li></ol><ul><li>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¸ºåˆšåˆšåˆ›å»ºçš„æ£€ç´¢å™¨è®¾ç½®ä¸€ä¸ªå·¥å…·ï¼š</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.tools.retriever <span class="keyword">import</span> create_retriever_tool</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™ä¸ªæ£€ç´¢å™¨å°±æ˜¯åˆšåˆšçˆ¬å–LongSmithæ–‡æ¡£çš„å†…å®¹ï¼Œç”Ÿæˆçš„æ£€ç´¢å™¨</span></span><br><span class="line">retriever_tool = create_retriever_tool(</span><br><span class="line">    retriever,</span><br><span class="line">    <span class="string">&quot;langsmith_search&quot;</span>,</span><br><span class="line">    <span class="string">&quot;æœç´¢æœ‰å…³LangSmithçš„ä¿¡æ¯æˆ–è€…æœ‰å…³LangSmithçš„ä»»ä½•é—®é¢˜ï¼Œå¿…é¡»ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ol start="2"><li>ä¸€ä¸ªæœç´¢å·¥å…·ã€‚è¿™å°†ä½¿å®ƒèƒ½å¤Ÿè½»æ¾å›ç­”éœ€è¦æœ€æ–°ä¿¡æ¯çš„é—®é¢˜ã€‚<br>- å®˜ç½‘ç¤ºä¾‹ä¸­ä½¿ç”¨çš„æœç´¢å·¥å…·æ˜¯Tavilyï¼Œéœ€è¦ä¸€ä¸ª API å¯†é’¥ï¼ˆæœ‰å…è´¹å¥—é¤ï¼‰ã€‚åœ¨ä»–ä»¬çš„å¹³å°ä¸Šåˆ›å»ºåï¼Œéœ€è¦å°†å…¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡</li></ol><pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.tools.tavily_search <span class="keyword">import</span> TavilySearchResults</span><br><span class="line"></span><br><span class="line">search = TavilySearchResults()</span><br></pre></td></tr></table></figure>- æˆ‘ä»¬ç°åœ¨å¯ä»¥åˆ›å»ºæˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„å·¥å…·çš„åˆ—è¡¨ï¼š<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tools = [retriever_tool, search]</span><br></pre></td></tr></table></figure>- ç°åœ¨æˆ‘ä»¬æœ‰äº†å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªä»£ç†æ¥ä½¿ç”¨å®ƒä»¬ã€‚<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™ä¸ªå¯ä»¥æ‹‰å–é¢„å®šä¹‰å¥½çš„prompt</span></span><br><span class="line">pip install langchainhub</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> hub</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_openai_functions_agent</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–åˆ«äººé¢„å®šä¹‰å¥½çš„prompt</span></span><br><span class="line">prompt = hub.pull(<span class="string">&quot;hwchase17/openai-functions-agent&quot;</span>)</span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">agent = create_openai_functions_agent(llm, tools, prompt)</span><br><span class="line">agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>- è°ƒç”¨<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agent_executor.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;LangSmithå¯ä»¥å¸®åŠ©æˆ‘æµ‹è¯•Appå—ï¼Ÿ&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></code></pre><h2 id="æ„å»ºæœåŠ¡">æ„å»ºæœåŠ¡</h2><ul><li>LangServe å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å°† LangChain é“¾éƒ¨ç½²ä¸º REST APIã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> WebBaseLoader</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain.tools.retriever <span class="keyword">import</span> create_retriever_tool</span><br><span class="line"><span class="keyword">from</span> langchain_community.tools.tavily_search <span class="keyword">import</span> TavilySearchResults</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> hub</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_openai_functions_agent</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor</span><br><span class="line"><span class="keyword">from</span> langchain.pydantic_v1 <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"><span class="keyword">from</span> langserve <span class="keyword">import</span> add_routes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. åŠ è½½æ£€ç´¢å™¨ï¼ˆRetrieverï¼‰</span></span><br><span class="line"><span class="comment"># é¦–å…ˆï¼Œé€šè¿‡ WebBaseLoader ä» LangChain æ–‡æ¡£ç½‘ç«™åŠ è½½æ–‡æ¡£æ•°æ®ã€‚ç„¶åï¼Œä½¿ç”¨ RecursiveCharacterTextSplitter å°†æ–‡æ¡£åˆ†å‰²ä¸ºæ–‡æ¡£ç‰‡æ®µï¼Œå¹¶ä½¿ç”¨ OpenAIEmbeddings å°†æ–‡æ¡£ç‰‡æ®µåµŒå…¥ä¸ºå‘é‡ã€‚æœ€åï¼Œä½¿ç”¨ FAISS åˆ›å»ºä¸€ä¸ªå‘é‡å­˜å‚¨ä½œä¸ºæ£€ç´¢å™¨ã€‚</span></span><br><span class="line">loader = WebBaseLoader(<span class="string">&quot;https://docs.smith.langchain.com/overview&quot;</span>)</span><br><span class="line">docs = loader.load()</span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter()</span><br><span class="line">documents = text_splitter.split_documents(docs)</span><br><span class="line">embeddings = OpenAIEmbeddings()</span><br><span class="line">vector = FAISS.from_documents(documents, embeddings)</span><br><span class="line">retriever = vector.as_retriever()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆ›å»ºå·¥å…·ï¼ˆToolsï¼‰</span></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸¤ä¸ªå·¥å…·ï¼šä¸€ä¸ªæ˜¯ä¹‹å‰åˆ›å»ºçš„æ£€ç´¢å™¨å·¥å…· retriever_toolï¼Œå¦ä¸€ä¸ªæ˜¯ Tavily æœç´¢å·¥å…· searchã€‚</span></span><br><span class="line">retriever_tool = create_retriever_tool(</span><br><span class="line">    retriever,</span><br><span class="line">    <span class="string">&quot;langsmith_search&quot;</span>,</span><br><span class="line">    <span class="string">&quot;æœç´¢æœ‰å…³LangSmithçš„ä¿¡æ¯æˆ–è€…æœ‰å…³LangSmithçš„ä»»ä½•é—®é¢˜ï¼Œå¿…é¡»ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼&quot;</span>,</span><br><span class="line">)</span><br><span class="line">search = TavilySearchResults()</span><br><span class="line">tools = [retriever_tool, search]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. åˆ›å»ºä»£ç†</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ LangChain Hub ä¸­æä¾›çš„é¢„å®šä¹‰æç¤ºï¼ˆè‡ªå·±æ„å»ºä¹Ÿå¯ä»¥ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªä½¿ç”¨ OpenAI æ¨¡å‹å’Œå·¥å…·çš„ä»£ç†ã€‚è¿™ä¸ªä»£ç†è¢«è®¾ç½®ä¸ºèƒ½å¤Ÿå†³å®šåœ¨å¤„ç†é—®é¢˜æ—¶ä½¿ç”¨å“ªäº›å·¥å…·ã€‚</span></span><br><span class="line">prompt = hub.pull(<span class="string">&quot;hwchase17/openai-functions-agent&quot;</span>)</span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">agent = create_openai_functions_agent(llm, tools, prompt)</span><br><span class="line">agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. FastAPI å®šä¹‰</span></span><br><span class="line">app = FastAPI(</span><br><span class="line">  title=<span class="string">&quot;LangChain Server&quot;</span>,</span><br><span class="line">  version=<span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  description=<span class="string">&quot;A simple API server using LangChain&#x27;s Runnable interfaces&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. æ·»åŠ é“¾è·¯ç”±</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡è°ƒç”¨ add_routes å‡½æ•°ï¼Œå°†ä»£ç†é“¾æ·»åŠ ä¸º FastAPI åº”ç”¨çš„ä¸€ä¸ªè·¯ç”±ï¼Œä»è€Œå¯ä»¥é€šè¿‡ /agent è·¯å¾„è®¿é—®ä»£ç†é“¾ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Input</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">input</span>: <span class="built_in">str</span></span><br><span class="line">    chat_history: <span class="type">List</span>[BaseMessage] = Field(</span><br><span class="line">        ...,</span><br><span class="line">        extra=&#123;<span class="string">&quot;widget&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;chat&quot;</span>, <span class="string">&quot;input&quot;</span>: <span class="string">&quot;location&quot;</span>&#125;&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Output</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    output: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">add_routes(</span><br><span class="line">    app,</span><br><span class="line">    agent_executor.with_types(input_type=Input, output_type=Output),</span><br><span class="line">    path=<span class="string">&quot;/agent&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">    uvicorn.run(app, host=<span class="string">&quot;localhost&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><h1>é“¾çš„æ¦‚å¿µï¼ˆè¡¥å……ï¼‰</h1><ul><li>é“¾ï¼ˆChainsï¼‰é€šå¸¸å°†å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ä¸æç¤ºï¼ˆPromptï¼‰ç»“åˆåœ¨ä¸€èµ·ï¼ŒåŸºäºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ–‡æœ¬æˆ–æ•°æ®è¿›è¡Œä¸€ç³»åˆ—æ“ä½œã€‚é“¾ï¼ˆChainsï¼‰å¯ä»¥ä¸€æ¬¡æ€§æ¥å—å¤šä¸ªè¾“å…¥ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªé“¾ï¼Œè¯¥é“¾æ¥å—ç”¨æˆ·è¾“å…¥ï¼Œä½¿ç”¨æç¤ºæ¨¡æ¿å¯¹å…¶è¿›è¡Œæ ¼å¼åŒ–ï¼Œç„¶åå°†æ ¼å¼åŒ–çš„å“åº”ä¼ é€’ç»™ LLM ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å¤šä¸ªé“¾ç»„åˆåœ¨ä¸€èµ·ï¼Œæˆ–è€…é€šè¿‡å°†é“¾ä¸å…¶ä»–ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·æ¥æ„å»ºæ›´å¤æ‚çš„é“¾ã€‚</li></ul><h2 id="é¡ºåºé“¾ï¼ˆSequentialChainsï¼‰">é¡ºåºé“¾ï¼ˆSequentialChainsï¼‰</h2><ul><li>æ˜¯æŒ‰é¢„å®šä¹‰é¡ºåºæ‰§è¡Œå…¶é“¾æ¥çš„é“¾ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç®€å•é¡ºåºé“¾ï¼ˆSimpleSequentialChainï¼‰ï¼Œè¿™æ˜¯é¡ºåºé“¾çš„æœ€ç®€å•ç±»å‹ï¼Œå…¶ä¸­æ¯ä¸ªæ­¥éª¤éƒ½æœ‰ä¸€ä¸ªè¾“å…¥/è¾“å‡ºï¼Œä¸€ä¸ªæ­¥éª¤çš„è¾“å‡ºæ˜¯ä¸‹ä¸€ä¸ªæ­¥éª¤çš„è¾“å…¥ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms <span class="keyword">import</span> Tongyi</span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain, SimpleSequentialChain</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line">prompt1 = ChatPromptTemplate.from_template(<span class="string">&quot;ä½ ç°åœ¨æ˜¯å†™ä½œé¢†åŸŸçš„å¤§å¸ˆï¼Œç°åœ¨ä¸º&#123;title&#125;è¿™ç¯‡æ–‡ç« ç”Ÿæˆä¸€äº›å¤§çº²å§ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">chain_one = LLMChain(llm=llm, prompt=prompt1)</span><br><span class="line"></span><br><span class="line">prompt2 = ChatPromptTemplate.from_template(<span class="string">&quot;æ ¹æ®è¿™ä¸ªå¤§çº²ï¼š&#123;toc&#125;ï¼Œç”Ÿæˆæ¯ä¸ªç« èŠ‚å¯¹åº”çš„å†…å®¹å§ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">chain_two = LLMChain(llm=llm, prompt=prompt2)</span><br><span class="line"></span><br><span class="line">chain = SimpleSequentialChain(chains=[chain_one, chain_two], verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    title = <span class="built_in">input</span>(<span class="string">&quot;è¯·è¾“å…¥é¢˜ç›®ï¼š&quot;</span>)</span><br><span class="line">    res = chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: title&#125;)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(res, indent=<span class="number">4</span>))</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">å½“ç„¶å¯ä»¥ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªå…³äºâ€œå¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºåˆ†æâ€çš„æ–‡ç« å¤§çº²ï¼š</span><br><span class="line"></span><br><span class="line">I. å¼•è¨€</span><br><span class="line">   A. ç½‘çº¢ç»æµçš„å´›èµ·ä¸å¤§å­¦ç”Ÿæ¶ˆè´¹è€…çš„æ¦‚è¿°</span><br><span class="line">   B. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹ç°è±¡çš„é‡è¦æ€§åŠç ”ç©¶èƒŒæ™¯</span><br><span class="line">   C. æ–‡ç« çš„ç ”ç©¶ç›®çš„å’Œæ„ä¹‰</span><br><span class="line"></span><br><span class="line">II. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è€…ç¾¤ä½“ç‰¹å¾åˆ†æ</span><br><span class="line">   A. å¹´é¾„ã€æ€§åˆ«ã€ä¸“ä¸šç­‰äººå£ç»Ÿè®¡å­¦ç‰¹å¾</span><br><span class="line">   B. å¤§å­¦ç”Ÿçš„ç½‘ç»œä½¿ç”¨ä¹ æƒ¯ä¸ç¤¾äº¤åª’ä½“åå¥½</span><br><span class="line">   C. å¤§å­¦ç”Ÿå¯¹ç½‘çº¢çš„è®¤å¯åº¦ä¸ä¿¡ä»»åº¦</span><br><span class="line"></span><br><span class="line">III. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç‰¹ç‚¹</span><br><span class="line">   A. æ¶ˆè´¹åŠ¨æœºï¼šä»å¨±ä¹æ¶ˆé£åˆ°è´­ç‰©å†³ç­–çš„å½±å“</span><br><span class="line">   B. æ¶ˆè´¹å“ç±»åå‘ï¼šæ—¶å°šç©¿æ­ã€ç¾å¦†æŠ¤è‚¤ã€ç”µå­äº§å“ç­‰æ–¹é¢çš„æ¶ˆè´¹æƒ…å†µ</span><br><span class="line">   C. è·Ÿé£æ¶ˆè´¹ä¸ä¸ªæ€§åŒ–æ¶ˆè´¹éœ€æ±‚çš„å¹³è¡¡</span><br><span class="line">   D. æƒ…æ„Ÿå› ç´ åœ¨è´­ä¹°å†³ç­–ä¸­çš„ä½œç”¨</span><br><span class="line"></span><br><span class="line">IV. ç½‘çº¢å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹è¡Œä¸ºçš„å½±å“æœºåˆ¶</span><br><span class="line">   A. ç½‘çº¢çš„å½±å“åŠ›æ¥æºï¼šå†…å®¹åˆ›ä½œèƒ½åŠ›ã€äººæ ¼é­…åŠ›ã€å£ç¢‘æ•ˆåº”ç­‰</span><br><span class="line">   B. ç½‘çº¢è¥é”€ç­–ç•¥å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹å¿ƒç†çš„å½±å“ï¼šæƒ…æ„Ÿå…±é¸£ã€ç”Ÿæ´»æ–¹å¼å¡‘é€ ã€æ„è§é¢†è¢–è§’è‰²</span><br><span class="line">   C. ç½‘çº¢å¹¿å‘Šä¸è½¯æ€§æ¨å¹¿å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹é€‰æ‹©çš„å¼•å¯¼</span><br><span class="line"></span><br><span class="line">V. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç¤¾ä¼šæ–‡åŒ–å½±å“</span><br><span class="line">   A. å¯¹å¤§å­¦ç”Ÿä»·å€¼è§‚å¡‘é€ çš„å½±å“</span><br><span class="line">   B. ç¤¾ä¼šå®¡ç¾è¶‹åŠ¿ä¸æ¶ˆè´¹è§‚å¿µçš„å˜åŒ–</span><br><span class="line">   C. å¯¹æ ¡å›­æ–‡åŒ–å’Œå¸‚åœºç»æµå‘å±•çš„å¯ç¤º</span><br><span class="line"></span><br><span class="line">VI. ç»“è®º</span><br><span class="line">   A. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ä¸»è¦ç‰¹ç‚¹åŠå…¶æˆå› æ€»ç»“</span><br><span class="line">   B. å¯¹æ•™è‚²éƒ¨é—¨ã€ä¼ä¸šã€ç½‘çº¢è‡ªèº«ä»¥åŠç¤¾ä¼šå„æ–¹é¢åº”å¯¹å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºè¿›è¡Œåˆç†å¼•å¯¼å’Œè§„èŒƒçš„å»ºè®®</span><br><span class="line">   C. å±•æœ›æœªæ¥ç ”ç©¶æ–¹å‘ä¸å¯èƒ½æ€§</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªå¤§çº²æ—¨åœ¨å…¨é¢æ¢è®¨å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç°è±¡ã€ç‰¹ç‚¹ã€æˆå› ä»¥åŠå…¶èƒŒåçš„ç¤¾ä¼šæ–‡åŒ–å½±å“ï¼Œå¹¶é’ˆå¯¹ç›¸å…³å„æ–¹æå‡ºæœ‰é’ˆå¯¹æ€§çš„æ€è€ƒä¸å»ºè®®ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹é¢å°±æ˜¯æ¯ä¸ªç« èŠ‚å¯¹åº”çš„å†…å®¹</span></span><br><span class="line"></span><br><span class="line">I. å¼•è¨€</span><br><span class="line">A. ç½‘çº¢ç»æµçš„å´›èµ·ä¸å¤§å­¦ç”Ÿæ¶ˆè´¹è€…çš„æ¦‚è¿°</span><br><span class="line">éšç€äº’è”ç½‘æŠ€æœ¯çš„å‘å±•å’Œç¤¾äº¤åª’ä½“å¹³å°çš„æ™®åŠï¼Œç½‘çº¢ç»æµä½œä¸ºä¸€ç§æ–°å‹å•†ä¸šæ¨¡å¼åœ¨å…¨çƒèŒƒå›´å†…è¿…é€Ÿå´›èµ·ã€‚å¤§å­¦ç”Ÿä½œä¸ºç½‘ç»œä¸»åŠ›å†›å’Œæ–°å…´æ¶ˆè´¹ç¾¤ä½“ï¼Œä»–ä»¬å¯¹äºç½‘çº¢çš„è¿½æ§å’Œæ¶ˆè´¹è¡Œä¸ºæˆä¸ºå½“å‰å¸‚åœºå…³æ³¨çš„çƒ­ç‚¹ã€‚è¿™ä¸€ç°è±¡ä¸ä»…åæ˜ å‡ºäº†ç½‘çº¢ç»æµçš„å·¨å¤§æ½œåŠ›ï¼Œä¹Ÿæ­ç¤ºäº†å¤§å­¦ç”Ÿåœ¨æ¶ˆè´¹è§‚å¿µå’Œè¡Œä¸ºä¸Šçš„æ–°å˜åŒ–ã€‚</span><br><span class="line"></span><br><span class="line">B. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹ç°è±¡çš„é‡è¦æ€§åŠç ”ç©¶èƒŒæ™¯</span><br><span class="line">å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹ç°è±¡æ—¥ç›Šæ™®éï¼Œå…¶èƒŒåçš„æ¶ˆè´¹å¿ƒç†ã€æ¶ˆè´¹è¡Œä¸ºæ¨¡å¼ä»¥åŠå¯¹ç¤¾ä¼šæ–‡åŒ–çš„å½±å“å…·æœ‰é‡è¦ç ”ç©¶ä»·å€¼ã€‚é€šè¿‡æ·±å…¥æ¢ç©¶è¿™ä¸€ç°è±¡ï¼Œæœ‰åŠ©äºç†è§£æ–°ä¸€ä»£æ¶ˆè´¹è€…çš„æ¶ˆè´¹è¶‹åŠ¿ï¼Œä¸ºç›¸å…³ä¼ä¸šå’Œæ”¿ç­–åˆ¶å®šè€…æä¾›é’ˆå¯¹æ€§çš„ç­–ç•¥æŒ‡å¯¼ã€‚</span><br><span class="line"></span><br><span class="line">C. æ–‡ç« çš„ç ”ç©¶ç›®çš„å’Œæ„ä¹‰</span><br><span class="line">æœ¬æ–‡æ—¨åœ¨é€šè¿‡ç³»ç»Ÿåœ°ç ”ç©¶å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºï¼Œæ­ç¤ºå…¶ç‰¹å¾ã€æˆå› åŠå…¶ç¤¾ä¼šæ–‡åŒ–å½±å“ï¼Œä¸ºæ•™è‚²éƒ¨é—¨ã€ä¼ä¸šã€ç½‘çº¢è‡ªèº«ä¹ƒè‡³æ•´ä¸ªç¤¾ä¼šæä¾›ç†æ€§åº”å¯¹è¿™ä¸€ç°è±¡çš„æ€è·¯å’Œå»ºè®®ï¼ŒåŒæ—¶å¯¹æœªæ¥ç›¸å…³ç ”ç©¶é¢†åŸŸçš„å‘å±•æ–¹å‘è¿›è¡Œå±•æœ›ã€‚</span><br><span class="line"></span><br><span class="line">II. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è€…ç¾¤ä½“ç‰¹å¾åˆ†æ</span><br><span class="line">A. å¹´é¾„ã€æ€§åˆ«ã€ä¸“ä¸šç­‰äººå£ç»Ÿè®¡å­¦ç‰¹å¾</span><br><span class="line">ä»¥åœ¨æ ¡å¤§å­¦ç”Ÿä¸ºä¸»ä½“çš„å¹´è½»æ¶ˆè´¹äººç¾¤ä¸»è¦é›†ä¸­åœ¨<span class="number">18</span>-<span class="number">24</span>å²å¹´é¾„æ®µï¼Œç”·å¥³æ¯”ä¾‹ç›¸å¯¹å‡è¡¡ï¼Œä¸åŒä¸“ä¸šçš„å­¦ç”Ÿå¯èƒ½ç”±äºå…´è¶£çˆ±å¥½ã€å®¡ç¾å–å‘ç­‰å› ç´ ï¼Œåœ¨ç½‘çº¢æ¶ˆè´¹ä¸Šè¡¨ç°å‡ºä¸€å®šçš„å·®å¼‚ã€‚</span><br><span class="line"></span><br><span class="line">B. å¤§å­¦ç”Ÿçš„ç½‘ç»œä½¿ç”¨ä¹ æƒ¯ä¸ç¤¾äº¤åª’ä½“åå¥½</span><br><span class="line">å½“ä»£å¤§å­¦ç”Ÿæ˜¯äº’è”ç½‘çš„é‡åº¦ä½¿ç”¨è€…ï¼Œä»–ä»¬åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­å¹¿æ³›ä¾èµ–äºç¤¾äº¤åª’ä½“å¹³å°è·å–ä¿¡æ¯ã€äº¤æµäº’åŠ¨å’Œå¨±ä¹ä¼‘é—²ã€‚å°¤å…¶åçˆ±çŸ­è§†é¢‘ã€ç›´æ’­ã€å¾®åšç­‰æ–°åª’ä½“å½¢å¼ï¼Œè¿™ä¸ºç½‘çº¢ä¼ æ’­å†…å®¹æä¾›äº†å¹¿é˜”çš„å—ä¼—åŸºç¡€ã€‚</span><br><span class="line"></span><br><span class="line">C. å¤§å­¦ç”Ÿå¯¹ç½‘çº¢çš„è®¤å¯åº¦ä¸ä¿¡ä»»åº¦</span><br><span class="line">å¤§å­¦ç”Ÿæ™®éè®¤ä¸ºç½‘çº¢å…·å¤‡è¾ƒé«˜çš„æ½®æµå¼•é¢†åŠ›å’Œç¤¾äº¤å½±å“åŠ›ï¼Œå¯¹äºå…·æœ‰ä¸€å®šä¸“ä¸šç´ å…»å’Œäº²å’ŒåŠ›çš„ç½‘çº¢æ›´å®¹æ˜“äº§ç”Ÿè®¤åŒæ„Ÿå’Œä¿¡èµ–æ„Ÿï¼Œä»è€Œå°†å…¶æ¨èçš„äº§å“æˆ–æœåŠ¡çº³å…¥è‡ªå·±çš„æ¶ˆè´¹è€ƒè™‘èŒƒå›´ã€‚</span><br><span class="line"></span><br><span class="line">III. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç‰¹ç‚¹</span><br><span class="line">A. æ¶ˆè´¹åŠ¨æœºï¼šä»å¨±ä¹æ¶ˆé£åˆ°è´­ç‰©å†³ç­–çš„å½±å“</span><br><span class="line">å¤§å­¦ç”Ÿåœ¨å…³æ³¨ç½‘çº¢çš„è¿‡ç¨‹ä¸­ï¼Œæœ€åˆå¯èƒ½å‡ºäºå¨±ä¹æ¶ˆé£çš„éœ€æ±‚ï¼Œä½†é€æ¸åœ°ï¼Œç½‘çº¢æ‰€å±•ç¤ºçš„ç”Ÿæ´»æ–¹å¼ã€æ—¶å°šå“å‘³ä»¥åŠäº§å“ä½“éªŒç­‰å†…å®¹ä¼šå½±å“ä»–ä»¬çš„è´­ç‰©å†³ç­–ï¼Œä½¿å¾—æ¶ˆè´¹è¡Œä¸ºç”±å•çº¯çš„è§‚èµè½¬å˜ä¸ºå®é™…è´­ä¹°è¡Œä¸ºã€‚</span><br><span class="line"></span><br><span class="line">B. æ¶ˆè´¹å“ç±»åå‘ï¼šæ—¶å°šç©¿æ­ã€ç¾å¦†æŠ¤è‚¤ã€ç”µå­äº§å“ç­‰æ–¹é¢çš„æ¶ˆè´¹æƒ…å†µ</span><br><span class="line">å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºä¸­ï¼Œæ—¶å°šç©¿æ­ã€ç¾å¦†æŠ¤è‚¤å’Œä¸ªäººç”µå­äº§å“æ˜¯æœ€å¸¸è§çš„æ¶ˆè´¹ç±»åˆ«ã€‚è¿™äº›å•†å“å¾€å¾€ä¸å¹´è½»äººè¿½æ±‚ä¸ªæ€§åŒ–ã€æ—¶å°šåŒ–å’Œé«˜å“è´¨ç”Ÿæ´»çš„éœ€æ±‚ç›¸å¥‘åˆã€‚</span><br><span class="line"></span><br><span class="line">C. è·Ÿé£æ¶ˆè´¹ä¸ä¸ªæ€§åŒ–æ¶ˆè´¹éœ€æ±‚çš„å¹³è¡¡</span><br><span class="line">å¤§å­¦ç”Ÿåœ¨ç½‘çº¢æ¶ˆè´¹è¿‡ç¨‹ä¸­ï¼Œæ—¢å­˜åœ¨è·Ÿé£æ¨¡ä»¿çš„ç°è±¡ï¼Œä¹Ÿæ³¨é‡ä¸ªæ€§è¡¨è¾¾å’Œè‡ªæˆ‘é£æ ¼çš„å¡‘é€ ã€‚ä»–ä»¬ä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸Šæ¥å—ç½‘çº¢æ¨èçš„å•†å“å’ŒæœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿæ ¹æ®ä¸ªäººå–œå¥½å’Œå®é™…æƒ…å†µåšå‡ºé€‰æ‹©ï¼Œå®ç°è·Ÿé£ä¸ä¸ªæ€§éœ€æ±‚çš„åŠ¨æ€å¹³è¡¡ã€‚</span><br><span class="line"></span><br><span class="line">D. æƒ…æ„Ÿå› ç´ åœ¨è´­ä¹°å†³ç­–ä¸­çš„ä½œç”¨</span><br><span class="line">å¤§å­¦ç”Ÿæ¶ˆè´¹è€…åœ¨ç½‘çº¢è´­ç‰©å†³ç­–ä¸­æƒ…æ„Ÿå› ç´ å æ®è¾ƒå¤§æ¯”é‡ï¼ŒåŒ…æ‹¬å¯¹ç½‘çº¢æœ¬äººçš„æƒ…æ„Ÿè®¤åŒã€å¯¹ç½‘çº¢æ‰€æ„å»ºç”Ÿæ´»æ–¹å¼çš„å‘å¾€ä»¥åŠä¸å…¶ä»–ç²‰ä¸é—´çš„ç¤¾äº¤å…³ç³»ç­‰å› ç´ éƒ½ä¼šå½±å“åˆ°è´­ä¹°è¡Œä¸ºã€‚</span><br><span class="line"></span><br><span class="line">IV. ç½‘çº¢å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹è¡Œä¸ºçš„å½±å“æœºåˆ¶</span><br><span class="line">A. ç½‘çº¢çš„å½±å“åŠ›æ¥æºï¼šå†…å®¹åˆ›ä½œèƒ½åŠ›ã€äººæ ¼é­…åŠ›ã€å£ç¢‘æ•ˆåº”ç­‰</span><br><span class="line">ç½‘çº¢çš„å½±å“åŠ›æºäºå…¶ç‹¬ç‰¹çš„å†…å®¹åˆ›ä½œèƒ½åŠ›ã€é²œæ˜çš„ä¸ªæ€§ç‰¹è´¨ä»¥åŠè‰¯å¥½çš„å£ç¢‘æ•ˆåº”ã€‚ä»–ä»¬é€šè¿‡é«˜è´¨é‡çš„å†…å®¹è¾“å‡ºï¼Œå¸å¼•å¹¶ç»´ç³»ç²‰ä¸ç¾¤ä½“ï¼Œè¿›è€Œè½¬åŒ–ä¸ºå•†ä¸šä»·å€¼ã€‚</span><br><span class="line"></span><br><span class="line">B. ç½‘çº¢è¥é”€ç­–ç•¥å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹å¿ƒç†çš„å½±å“ï¼šæƒ…æ„Ÿå…±é¸£ã€ç”Ÿæ´»æ–¹å¼å¡‘é€ ã€æ„è§é¢†è¢–è§’è‰²</span><br><span class="line">ç½‘çº¢è¿ç”¨æƒ…æ„Ÿå…±é¸£ã€ç”Ÿæ´»æ–¹å¼å±•ç¤ºä»¥åŠæ„è§é¢†è¢–çš„è§’è‰²å®šä½ï¼Œå·§å¦™åœ°å°†äº§å“èå…¥å…¶ä¸­ï¼Œæ¿€å‘å¤§å­¦ç”Ÿæ¶ˆè´¹è€…çš„å¿ƒç†å…±é¸£ï¼Œå½¢æˆæ½œåœ¨è´­ä¹°æ„æ„¿ï¼Œå¹¶æ¨åŠ¨å®é™…æ¶ˆè´¹è¡Œä¸ºçš„å‘ç”Ÿã€‚</span><br><span class="line"></span><br><span class="line">C. ç½‘çº¢å¹¿å‘Šä¸è½¯æ€§æ¨å¹¿å¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹é€‰æ‹©çš„å¼•å¯¼</span><br><span class="line">ç½‘çº¢å€ŸåŠ©å¹¿å‘Šæ¤å…¥ã€å“ç‰Œåˆä½œç­‰å½¢å¼è¿›è¡Œå•†å“æ¨å¹¿ï¼Œè¿™ç§éšæ€§ä¸”æ˜“äºæ¥å—çš„è¥é”€æ‰‹æ®µåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå·¦å³äº†å¤§å­¦ç”Ÿçš„æ¶ˆè´¹é€‰æ‹©ã€‚</span><br><span class="line"></span><br><span class="line">V. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç¤¾ä¼šæ–‡åŒ–å½±å“</span><br><span class="line">A. å¯¹å¤§å­¦ç”Ÿä»·å€¼è§‚å¡‘é€ çš„å½±å“</span><br><span class="line">å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºä¿ƒè¿›äº†ä»–ä»¬å¯¹ç¾çš„è¿½æ±‚ã€ä¸ªæ€§åŒ–æ„è¯†çš„è§‰é†’ä»¥åŠå¯¹å“è´¨ç”Ÿæ´»çš„å‘å¾€ï¼Œè¿›ä¸€æ­¥å¡‘é€ äº†æ–°ä¸€ä»£æ¶ˆè´¹è€…çš„æ¶ˆè´¹ä»·å€¼è§‚ã€‚</span><br><span class="line"></span><br><span class="line">B. ç¤¾ä¼šå®¡ç¾è¶‹åŠ¿ä¸æ¶ˆè´¹è§‚å¿µçš„å˜åŒ–</span><br><span class="line">éšç€å¤§å­¦ç”Ÿå¯¹ç½‘çº¢æ¶ˆè´¹çš„ç§¯æå‚ä¸ï¼Œä»–ä»¬çš„å®¡ç¾æƒ…è¶£å’Œæ¶ˆè´¹è§‚å¿µé€æ¸æˆä¸ºç¤¾ä¼šå®¡ç¾è¶‹åŠ¿çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè¿›ä¸€æ­¥æ¨åŠ¨ç€ç¤¾ä¼šæ•´ä½“æ¶ˆè´¹è§‚å¿µçš„å˜é©ä¸å‘å±•ã€‚</span><br><span class="line"></span><br><span class="line">C. å¯¹æ ¡å›­æ–‡åŒ–å’Œå¸‚åœºç»æµå‘å±•çš„å¯ç¤º</span><br><span class="line">å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºä¸ä»…åæ˜ äº†å½“å‰å¸‚åœºç»æµç¯å¢ƒä¸‹æ¶ˆè´¹ç»“æ„å’Œæ¶ˆè´¹è¡Œä¸ºçš„æ–°å˜åŒ–ï¼Œä¹Ÿä¸ºæ ¡å›­æ–‡åŒ–çš„å¤šå…ƒåŒ–å‘å±•æä¾›äº†æ–°çš„è§†è§’ä¸å¯ç¤ºã€‚</span><br><span class="line"></span><br><span class="line">VI. ç»“è®º</span><br><span class="line">A. å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ä¸»è¦ç‰¹ç‚¹åŠå…¶æˆå› æ€»ç»“</span><br><span class="line">é€šè¿‡å¯¹å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„ç ”ç©¶ï¼Œæˆ‘ä»¬å‘ç°å…¶ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬é«˜åº¦æ´»è·ƒçš„ç¤¾äº¤åª’ä½“å‚ä¸ã€å¼ºçƒˆçš„æƒ…æ„Ÿé©±åŠ¨æ¶ˆè´¹ã€ç´§è·Ÿæ½®æµä¸”å…¼é¡¾ä¸ªæ€§åŒ–çš„æ¶ˆè´¹éœ€æ±‚ä»¥åŠæ·±å—ç½‘çº¢è¥é”€ç­–ç•¥çš„å½±å“ã€‚è¿™äº›ç‰¹ç‚¹çš„èƒŒåæˆå› ä¸»è¦åŒ…æ‹¬å¤§å­¦ç”Ÿç‹¬ç‰¹çš„å¹´é¾„ç‰¹å¾ã€ç½‘ç»œç¯å¢ƒä¸‹çš„ä¿¡æ¯æ¥æ”¶æ–¹å¼ä»¥åŠç½‘çº¢å½±å“åŠ›çš„å¤šé‡ä½œç”¨ã€‚</span><br><span class="line"></span><br><span class="line">B. å¯¹æ•™è‚²éƒ¨é—¨ã€ä¼ä¸šã€ç½‘çº¢è‡ªèº«ä»¥åŠç¤¾ä¼šå„æ–¹é¢åº”å¯¹å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºè¿›è¡Œåˆç†å¼•å¯¼å’Œè§„èŒƒçš„å»ºè®®</span><br><span class="line">æ•™è‚²éƒ¨é—¨åº”åŠ å¼ºå¯¹å¤§å­¦ç”Ÿæ¶ˆè´¹è§‚çš„å¼•å¯¼æ•™è‚²ï¼ŒåŸ¹å…»ä»–ä»¬çš„ç†æ€§æ¶ˆè´¹æ„è¯†ï¼›ä¼ä¸šåº”å……åˆ†è®¤è¯†åˆ°ç½‘çº¢è¥é”€çš„ä»·å€¼ï¼Œåˆç†åˆ©ç”¨ç½‘çº¢èµ„æºï¼ŒåŒæ—¶ä¸¥æ ¼éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ï¼Œç¡®ä¿è¥é”€æ´»åŠ¨çš„åˆæ³•åˆè§„ï¼›ç½‘çº¢è‡ªèº«åˆ™éœ€ä¿æŒèŒä¸šæ“å®ˆï¼Œä¼ é€’æ­£èƒ½é‡ï¼Œå‘æŒ¥å¥½æ¦œæ ·ä½œç”¨ï¼›ç¤¾ä¼šå„ç•Œä¹Ÿåº”å¯¹ç½‘çº¢ç»æµæŒå¼€æ”¾åŒ…å®¹æ€åº¦ï¼Œå¼ºåŒ–ç›‘ç®¡ä¸è‡ªå¾‹ç›¸ç»“åˆï¼Œå…±åŒè¥é€ å¥åº·æœ‰åºçš„ç½‘çº¢æ¶ˆè´¹ç¯å¢ƒã€‚</span><br><span class="line"></span><br><span class="line">C. å±•æœ›æœªæ¥ç ”ç©¶æ–¹å‘ä¸å¯èƒ½æ€§</span><br><span class="line">æœªæ¥çš„ç ”ç©¶å¯ä»¥ä»æ›´å¾®è§‚çš„å±‚é¢æ·±å…¥å‰–æå¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºçš„å†…åœ¨æœºç†ï¼Œæ¢ç©¶ä¸åŒä¸ªä½“ä¹‹é—´æ¶ˆè´¹å·®å¼‚çš„å…·ä½“åŸå› ï¼›ä¹Ÿå¯ä»¥ç€çœ¼äºå…¨çƒè§†é‡ï¼Œå¯¹æ¯”å›½å†…å¤–å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹ç°è±¡çš„å¼‚åŒå’Œå‘å±•è¶‹åŠ¿ï¼›æ­¤å¤–ï¼Œè¿˜å¯ä»¥æ¢è®¨å¦‚ä½•ç»“åˆæ–°æŠ€æœ¯åº”ç”¨ï¼Œå¦‚å¤§æ•°æ®ã€äººå·¥æ™ºèƒ½ç­‰ï¼Œæ›´å¥½åœ°ç†è§£å’Œå¼•å¯¼å¤§å­¦ç”Ÿç½‘çº¢æ¶ˆè´¹è¡Œä¸ºã€‚</span><br></pre></td></tr></table></figure><h2 id="å¤šé“¾ç»„åˆ">å¤šé“¾ç»„åˆ</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains import LLMChain, SequentialChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi import Tongyi</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts import ChatPromptTemplate</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­é“¾1</span></span><br><span class="line"><span class="comment"># promptæ¨¡æ¿ 1: ç¿»è¯‘æˆè‹±è¯­ï¼ˆæŠŠä¸‹é¢çš„reviewç¿»è¯‘æˆè‹±è¯­ï¼‰</span></span><br><span class="line">first_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;æŠŠä¸‹é¢çš„è¯„è®ºreviewç¿»è¯‘æˆä¸­æ–‡:&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\n&#123;Review&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 1: è¾“å…¥ï¼šReview    è¾“å‡ºï¼šä¸­æ–‡çš„ Review</span></span><br><span class="line">chain_one = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=first_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;Chinese_Review&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­é“¾2</span></span><br><span class="line"><span class="comment"># promptæ¨¡æ¿ 2: ç”¨ä¸€å¥è¯æ€»ç»“ä¸‹é¢çš„ review</span></span><br><span class="line">second_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;è¯·ä½ ç”¨ä¸€å¥è¯æ¥æ€»ç»“ä¸‹é¢çš„è¯„è®ºreview:&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\n&#123;Chinese_Review&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 2: è¾“å…¥ï¼šä¸­æ–‡çš„Review   è¾“å‡ºï¼šæ€»ç»“</span></span><br><span class="line">chain_two = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=second_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;summary&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­é“¾3</span></span><br><span class="line"><span class="comment"># promptæ¨¡æ¿ 3: ä¸‹é¢reviewä½¿ç”¨çš„ä»€ä¹ˆè¯­è¨€</span></span><br><span class="line">third_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;ä¸‹é¢çš„è¯„è®ºreviewä½¿ç”¨çš„ä»€ä¹ˆè¯­è¨€:\n\n&#123;Review&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 3: è¾“å…¥ï¼šReview  è¾“å‡ºï¼šè¯­è¨€</span></span><br><span class="line">chain_three = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=third_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;language&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­é“¾4</span></span><br><span class="line"><span class="comment"># promptæ¨¡æ¿ 4: ä½¿ç”¨ç‰¹å®šçš„è¯­è¨€å¯¹ä¸‹é¢çš„æ€»ç»“å†™ä¸€ä¸ªåç»­å›å¤</span></span><br><span class="line">fourth_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;ä½¿ç”¨ç‰¹å®šçš„è¯­è¨€å¯¹ä¸‹é¢çš„æ€»ç»“å†™ä¸€ä¸ªåç»­å›å¤:&quot;</span></span><br><span class="line">    <span class="string">&quot;\n\næ€»ç»“: &#123;summary&#125;\n\nè¯­è¨€: &#123;language&#125;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># chain 4: è¾“å…¥ï¼š æ€»ç»“, è¯­è¨€    è¾“å‡ºï¼š åç»­å›å¤</span></span><br><span class="line">chain_four = LLMChain(<span class="attribute">llm</span>=llm, <span class="attribute">prompt</span>=fourth_prompt, <span class="attribute">output_key</span>=<span class="string">&quot;followup_message&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¾“å…¥ï¼šreview</span></span><br><span class="line"><span class="comment">#è¾“å‡ºï¼šä¸­æ–‡reviewï¼Œæ€»ç»“ï¼Œåç»­å›å¤</span></span><br><span class="line">overall_chain = SequentialChain(</span><br><span class="line">    chains=[chain_one, chain_two, chain_three, chain_four],</span><br><span class="line">    input_variables=[<span class="string">&quot;Review&quot;</span>],</span><br><span class="line">    output_variables=[<span class="string">&quot;Chinese_Review&quot;</span>, <span class="string">&quot;summary&quot;</span>, <span class="string">&quot;followup_message&quot;</span>, <span class="string">&quot;language&quot;</span>],</span><br><span class="line">    <span class="attribute">verbose</span>=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    text = input(<span class="string">&quot;è¯·è¾“å…¥å†…å®¹ï¼š&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(overall_chain.invoke(&#123;<span class="string">&quot;Review&quot;</span>: text&#125;))</span><br></pre></td></tr></table></figure><p><img src="https://s11.ax1x.com/2024/02/24/pFUftjf.png" alt=""></p><h2 id="è·¯ç”±é“¾">è·¯ç”±é“¾</h2><ul><li>å‰é¢çš„é“¾çš„è¾“å…¥é¡ºåºåŸºæœ¬ä¸Šéƒ½æ˜¯å›ºå®šçš„ï¼Œå¦‚æœæƒ³åšæ›´å¤æ‚çš„äº‹æƒ…ï¼Œå°±éœ€è¦æ ¹æ®è¾“å…¥å°†å…¶è·¯ç”±åˆ°ç‰¹å®šçš„é“¾ã€‚å‡è®¾ä½ æœ‰å¤šä¸ªå­é“¾ï¼Œæ¯ä¸ªå­é“¾éƒ½ä¸“é—¨ç”¨äºç‰¹å®šç±»å‹çš„è¾“å…¥ï¼Œé‚£ä¹ˆå¯ä»¥ç»„æˆä¸€ä¸ªè·¯ç”±é“¾</li><li>è·¯ç”±å™¨ç”±ä¸¤ä¸ªç»„ä»¶ç»„æˆï¼š<ol><li>è·¯ç”±é“¾ï¼ˆRouter Chainï¼‰ï¼šè·¯ç”±å™¨é“¾æœ¬èº«ï¼Œè´Ÿè´£é€‰æ‹©è¦è°ƒç”¨çš„ä¸‹ä¸€ä¸ªé“¾</li><li>destination_chainsï¼šè·¯ç”±å™¨é“¾å¯ä»¥è·¯ç”±åˆ°çš„é“¾</li></ol></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain, MultiPromptChain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.router.llm_router <span class="keyword">import</span> RouterOutputParser, LLMRouterChain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.router.multi_prompt_prompt <span class="keyword">import</span> MULTI_PROMPT_ROUTER_TEMPLATE</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi <span class="keyword">import</span> Tongyi</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate, PromptTemplate</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å¤šç§æç¤ºæ¨¡æ¿</span></span><br><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªæç¤ºé€‚åˆå›ç­”ç‰©ç†é—®é¢˜</span></span><br><span class="line">physics_template = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªéå¸¸èªæ˜çš„ç‰©ç†ä¸“å®¶ã€‚ \</span></span><br><span class="line"><span class="string">ä½ æ“…é•¿ç”¨ä¸€ç§ç®€æ´å¹¶ä¸”æ˜“äºç†è§£çš„æ–¹å¼å»å›ç­”é—®é¢˜ã€‚\</span></span><br><span class="line"><span class="string">å½“ä½ ä¸çŸ¥é“é—®é¢˜çš„ç­”æ¡ˆæ—¶ï¼Œä½ æ‰¿è®¤\</span></span><br><span class="line"><span class="string">ä½ ä¸çŸ¥é“.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿™æ˜¯ä¸€ä¸ªé—®é¢˜:</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒä¸ªæç¤ºé€‚åˆå›ç­”æ•°å­¦é—®é¢˜</span></span><br><span class="line">math_template = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„æ•°å­¦å®¶ã€‚ \</span></span><br><span class="line"><span class="string">ä½ æ“…é•¿å›ç­”æ•°å­¦é—®é¢˜ã€‚ \</span></span><br><span class="line"><span class="string">ä½ ä¹‹æ‰€ä»¥å¦‚æ­¤ä¼˜ç§€ï¼Œ \</span></span><br><span class="line"><span class="string">æ˜¯å› ä¸ºä½ èƒ½å¤Ÿå°†æ£˜æ‰‹çš„é—®é¢˜åˆ†è§£ä¸ºç»„æˆéƒ¨åˆ†ï¼Œ\</span></span><br><span class="line"><span class="string">å›ç­”ç»„æˆéƒ¨åˆ†ï¼Œç„¶åå°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ï¼Œå›ç­”æ›´å¹¿æ³›çš„é—®é¢˜ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿™æ˜¯ä¸€ä¸ªé—®é¢˜ï¼š</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬ä¸‰ä¸ªé€‚åˆå›ç­”å†å²é—®é¢˜</span></span><br><span class="line">history_template = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä»¥ä¸ºéå¸¸ä¼˜ç§€çš„å†å²å­¦å®¶ã€‚ \</span></span><br><span class="line"><span class="string">ä½ å¯¹ä¸€ç³»åˆ—å†å²æ—¶æœŸçš„äººç‰©ã€äº‹ä»¶å’ŒèƒŒæ™¯æœ‰ç€æå¥½çš„å­¦è¯†å’Œç†è§£\</span></span><br><span class="line"><span class="string">ä½ æœ‰èƒ½åŠ›æ€è€ƒã€åæ€ã€è¾©è¯ã€è®¨è®ºå’Œè¯„ä¼°è¿‡å»ã€‚\</span></span><br><span class="line"><span class="string">ä½ å°Šé‡å†å²è¯æ®ï¼Œå¹¶æœ‰èƒ½åŠ›åˆ©ç”¨å®ƒæ¥æ”¯æŒä½ çš„è§£é‡Šå’Œåˆ¤æ–­ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿™æ˜¯ä¸€ä¸ªé—®é¢˜:</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬å››ä¸ªé€‚åˆå›ç­”è®¡ç®—æœºé—®é¢˜</span></span><br><span class="line">computerscience_template = <span class="string">&quot;&quot;&quot; ä½ æ˜¯ä¸€ä¸ªæˆåŠŸçš„è®¡ç®—æœºç§‘å­¦ä¸“å®¶ã€‚\</span></span><br><span class="line"><span class="string">ä½ æœ‰åˆ›é€ åŠ›ã€åä½œç²¾ç¥ã€\</span></span><br><span class="line"><span class="string">å‰ç»æ€§æ€ç»´ã€è‡ªä¿¡ã€è§£å†³é—®é¢˜çš„èƒ½åŠ›ã€\</span></span><br><span class="line"><span class="string">å¯¹ç†è®ºå’Œç®—æ³•çš„ç†è§£ä»¥åŠå‡ºè‰²çš„æ²Ÿé€šæŠ€å·§ã€‚\</span></span><br><span class="line"><span class="string">ä½ éå¸¸æ“…é•¿å›ç­”ç¼–ç¨‹é—®é¢˜ã€‚\</span></span><br><span class="line"><span class="string">ä½ ä¹‹æ‰€ä»¥å¦‚æ­¤ä¼˜ç§€ï¼Œæ˜¯å› ä¸ºä½ çŸ¥é“  \</span></span><br><span class="line"><span class="string">å¦‚ä½•é€šè¿‡ä»¥æœºå™¨å¯ä»¥è½»æ¾è§£é‡Šçš„å‘½ä»¤å¼æ­¥éª¤æè¿°è§£å†³æ–¹æ¡ˆæ¥è§£å†³é—®é¢˜ï¼Œ\</span></span><br><span class="line"><span class="string">å¹¶ä¸”ä½ çŸ¥é“å¦‚ä½•é€‰æ‹©åœ¨æ—¶é—´å¤æ‚æ€§å’Œç©ºé—´å¤æ‚æ€§ä¹‹é—´å–å¾—è‰¯å¥½å¹³è¡¡çš„è§£å†³æ–¹æ¡ˆã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿™è¿˜æ˜¯ä¸€ä¸ªé—®é¢˜ï¼š</span></span><br><span class="line"><span class="string">&#123;input&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºæ¯ä¸ªæ¨¡æ¿å‘½åï¼Œå¹¶ä¸”ç»™å‡ºå…·ä½“æè¿°ï¼Œå°†è¿™äº›ä¿¡æ¯ä¼ é€’ç»™è·¯ç”±é“¾ï¼Œè·¯ç”±é“¾å†³å®šä½•æ—¶è°ƒç”¨å­é“¾</span></span><br><span class="line">prompt_infos = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;åå­—&quot;</span>: <span class="string">&quot;ç‰©ç†å­¦&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æè¿°&quot;</span>: <span class="string">&quot;æ“…é•¿å›ç­”å…³äºç‰©ç†å­¦çš„é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>: physics_template</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;åå­—&quot;</span>: <span class="string">&quot;æ•°å­¦&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æè¿°&quot;</span>: <span class="string">&quot;æ“…é•¿å›ç­”æ•°å­¦é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>: math_template</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;åå­—&quot;</span>: <span class="string">&quot;å†å²&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æè¿°&quot;</span>: <span class="string">&quot;æ“…é•¿å›ç­”å†å²é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>: history_template</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;åå­—&quot;</span>: <span class="string">&quot;è®¡ç®—æœºç§‘å­¦&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æè¿°&quot;</span>: <span class="string">&quot;æ“…é•¿å›ç­”è®¡ç®—æœºç§‘å­¦é—®é¢˜&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>: computerscience_template</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸºäºæç¤ºæ¨¡ç‰ˆä¿¡æ¯åˆ›å»ºç›¸åº”ç›®æ ‡é“¾</span></span><br><span class="line">destination_chains = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> p_info <span class="keyword">in</span> prompt_infos:</span><br><span class="line">    name = p_info[<span class="string">&quot;åå­—&quot;</span>]</span><br><span class="line">    prompt_template = p_info[<span class="string">&quot;æç¤ºæ¨¡æ¿&quot;</span>]</span><br><span class="line">    prompt = ChatPromptTemplate.from_template(template=prompt_template)</span><br><span class="line">    chain = LLMChain(llm=llm, prompt=prompt)</span><br><span class="line">    destination_chains[name] = chain</span><br><span class="line"></span><br><span class="line">destinations = [<span class="string">f&quot;<span class="subst">&#123;p[<span class="string">&#x27;åå­—&#x27;</span>]&#125;</span>: <span class="subst">&#123;p[<span class="string">&#x27;æè¿°&#x27;</span>]&#125;</span>&quot;</span> <span class="keyword">for</span> p <span class="keyword">in</span> prompt_infos]</span><br><span class="line">destinations_str = <span class="string">&quot;\n&quot;</span>.join(destinations)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºé»˜è®¤ç›®æ ‡é“¾ï¼Œå½“è·¯ç”±å™¨æ— æ³•å†³å®šä½¿ç”¨å“ªä¸ªå­é“¾æ—¶è°ƒç”¨çš„é“¾ã€‚</span></span><br><span class="line">default_prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&#123;input&#125;&quot;</span>)</span><br><span class="line">default_chain = LLMChain(llm=llm, prompt=default_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºè·¯ç”±é“¾</span></span><br><span class="line">router_template = MULTI_PROMPT_ROUTER_TEMPLATE.<span class="built_in">format</span>(destinations=destinations_str)</span><br><span class="line"></span><br><span class="line">router_prompt = PromptTemplate(</span><br><span class="line">    template=router_template,</span><br><span class="line">    input_variables=[<span class="string">&quot;input&quot;</span>],</span><br><span class="line">    output_parser=RouterOutputParser(),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">router_chain = LLMRouterChain.from_llm(llm, router_prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºæ•´ä½“é“¾è·¯</span></span><br><span class="line">chain = MultiPromptChain(router_chain=router_chain,  <span class="comment"># è·¯ç”±é“¾è·¯</span></span><br><span class="line">                         destination_chains=destination_chains,  <span class="comment"># ç›®æ ‡é“¾è·¯</span></span><br><span class="line">                         default_chain=default_chain,  <span class="comment"># é»˜è®¤é“¾è·¯</span></span><br><span class="line">                         verbose=<span class="literal">True</span></span><br><span class="line">                         )</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    que = <span class="built_in">input</span>(<span class="string">&quot;è¯·è¾“å…¥é—®é¢˜ï¼š&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: que&#125;))</span><br></pre></td></tr></table></figure><ul><li>åç»­æˆ‘ä»¬å¯ä»¥é¢„å®šä¹‰éå¸¸å¤šçš„promptï¼Œç„¶åé€šè¿‡è·¯ç”±é“¾æ¥è¿›è¡Œä»»åŠ¡åˆ†å‘ï¼Œå°½å¯èƒ½æŠŠä»»åŠ¡ç»†åˆ†ï¼Œè¿™æ ·å‡ºç°é—®é¢˜æ—¶ï¼Œåªéœ€è¦å…³æ³¨å¯¹åº”çš„æŸä¸€ä¸ªpromptï¼Œè€Œä¸éœ€è¦æ•´ä½“çš„æ”¹åŠ¨ã€‚</li></ul><h1>ä»£ç†çš„æ¦‚å¿µï¼ˆè¡¥å……ï¼‰</h1><ul><li><p>å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰éå¸¸å¼ºå¤§ï¼Œä½†å®ƒä»¬ç¼ºä¹â€œæœ€ç¬¨â€çš„è®¡ç®—æœºç¨‹åºå¯ä»¥è½»æ¾å¤„ç†çš„ç‰¹å®šèƒ½åŠ›ã€‚LLM å¯¹é€»è¾‘æ¨ç†ã€è®¡ç®—å’Œæ£€ç´¢å¤–éƒ¨ä¿¡æ¯çš„èƒ½åŠ›è¾ƒå¼±ï¼Œè¿™ä¸æœ€ç®€å•çš„è®¡ç®—æœºç¨‹åºå½¢æˆå¯¹æ¯”ã€‚ä¾‹å¦‚ï¼Œè¯­è¨€æ¨¡å‹æ— æ³•å‡†ç¡®å›ç­”ç®€å•çš„è®¡ç®—é—®é¢˜ï¼Œè¿˜æœ‰å½“è¯¢é—®æœ€è¿‘å‘ç”Ÿçš„äº‹ä»¶æ—¶ï¼Œå…¶å›ç­”ä¹Ÿå¯èƒ½è¿‡æ—¶æˆ–é”™è¯¯ï¼Œå› ä¸ºæ— æ³•ä¸»åŠ¨è·å–æœ€æ–°ä¿¡æ¯ã€‚è¿™æ˜¯ç”±äºå½“å‰è¯­è¨€æ¨¡å‹ä»…ä¾èµ–é¢„è®­ç»ƒæ•°æ®ï¼Œä¸å¤–ç•Œâ€œæ–­å¼€â€ã€‚è¦å…‹æœè¿™ä¸€ç¼ºé™·ï¼ŒLangChainæ¡†æ¶æå‡ºäº†â€œä»£ç†â€(Agent)çš„è§£å†³æ–¹æ¡ˆã€‚</p></li><li><p>ä»£ç†ä½œä¸ºè¯­è¨€æ¨¡å‹çš„å¤–éƒ¨æ¨¡å—ï¼Œå¯æä¾›è®¡ç®—ã€é€»è¾‘ã€æ£€ç´¢ç­‰åŠŸèƒ½çš„æ”¯æŒï¼Œä½¿è¯­è¨€æ¨¡å‹è·å¾—å¼‚å¸¸å¼ºå¤§çš„æ¨ç†å’Œè·å–ä¿¡æ¯çš„è¶…èƒ½åŠ›ã€‚</p></li><li><p>è¦ä½¿ç”¨ä»£ç† (Agents) ï¼Œæˆ‘ä»¬éœ€è¦ä¸‰æ ·ä¸œè¥¿ï¼š</p><ol><li>ä¸€ä¸ªåŸºæœ¬çš„ LLM</li><li>æˆ‘ä»¬å°†è¦è¿›è¡Œäº¤äº’çš„å·¥å…· Tools</li><li>ä¸€ä¸ªæ§åˆ¶äº¤äº’çš„ä»£ç† (Agents) ã€‚</li></ol><ul><li>ç°åœ¨å°è¯•ä½¿ç”¨ä»£ç†æ¥è§£å†³æ•°å­¦é—®é¢˜</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> load_tools, initialize_agent, AgentType</span><br><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi <span class="keyword">import</span> Tongyi</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-1903ddb520ac4637a1d36b2f93e0aa4c&quot;</span></span><br><span class="line"></span><br><span class="line">llm = Tongyi()</span><br><span class="line"></span><br><span class="line">tools = load_tools(</span><br><span class="line">    [<span class="string">&quot;llm-math&quot;</span>, <span class="string">&quot;wikipedia&quot;</span>],</span><br><span class="line">    llm=llm</span><br><span class="line">)</span><br><span class="line">agent = initialize_agent(</span><br><span class="line">    tools,  <span class="comment"># ç¬¬äºŒæ­¥åŠ è½½çš„å·¥å…·</span></span><br><span class="line">    llm,  <span class="comment"># ç¬¬ä¸€æ­¥åˆå§‹åŒ–çš„æ¨¡å‹</span></span><br><span class="line">    agent=AgentType.CHAT_ZERO_SHOT_REACT_DESCRIPTION,  <span class="comment"># ä»£ç†ç±»å‹</span></span><br><span class="line">    handle_parsing_errors=<span class="literal">True</span>,  <span class="comment"># å¤„ç†è§£æé”™è¯¯</span></span><br><span class="line">    verbose=<span class="literal">True</span>  <span class="comment"># è¾“å‡ºä¸­é—´æ­¥éª¤</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">agent.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;2084çš„25%æ˜¯å¤šå°‘ï¼Ÿè¿˜æœ‰ï¼Œä½ çŸ¥é“Palworldè¿™æ¬¾æ¸¸æˆå—&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></li><li><p>è¾“å‡º</p><blockquote><p>Thought: ç¬¬ä¸€ä¸ªé—®é¢˜éœ€è¦è®¡ç®—2084çš„25%ï¼Œå¯ä»¥ä½¿ç”¨è®¡ç®—å™¨å·¥å…·ï¼›ç¬¬äºŒä¸ªé—®é¢˜è¯¢é—®å…³äºPalworldè¿™æ¬¾æ¸¸æˆçš„ä¿¡æ¯ï¼Œéœ€è¦ç”¨åˆ°Wikipediaå·¥å…·ã€‚</p><p>Action:</p> <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Calculator&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;action_input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2084 * 25%&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Observation: Answer: 521.0<br>Thought:å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘éœ€è¦ä½¿ç”¨Wikipediaå·¥å…·æ¥æŸ¥è¯¢Palworldè¿™æ¬¾æ¸¸æˆçš„ä¿¡æ¯ã€‚<br>Action:</p> <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wikipedia&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;action_input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Palworld&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Observation: Page: Palworld<br>Summary: Palworld is an action-adventure survival game by Japanese developer Pocket Pair. The game is set in an open world populated with animal-like creatures known as â€œPalsâ€. The players can battle and capture Pals in order to use them for base building, traversal, and combat. Palworld can be played either solo, or online by up to 32 players on one server. Announced in 2021, it was launched via early access for Windows, Xbox One, and Xbox Series X/S in January 2024.<br>The gameâ€™s comedic premise, which involves using firearms and equipping Pals with them, earned it the nickname â€œPokÃ©mon with gunsâ€. Other elements, such as using creatures for food or placing them to work in mines and factories, have also garnered attention. It was generally well received, with praise for its gameplay, content, and satirical premise, but criticism for its reliance on shock humor and use of unoriginal designs and mechanics.Palworld sold eight million units in the first six days of early access and reached two million concurrent players on Steam, making it the second-highest played game of all time on the platform.</p><p>Page: Brotato<br>Summary: Brotato is a 2023 shoot 'em up video game created by French independent developer Thomas Gervraud under the studio name Blobfish. It was first released via Steam early access in 2022, during which it sold over one million copies. Brotato received positive reviews from critics and players, and it was later ported to multiple platforms.</p><p>Page: List of video games in development<br>Summary: This is a confirmed list of video games in development, but are scheduled for release beyond 2024 or currently carry no release date at all.</p></blockquote></li><li><p>æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„æµç¨‹<br><img src="https://s11.ax1x.com/2024/02/24/pFUfYgP.png" alt=""></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;ä»€ä¹ˆæ˜¯LangChain&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;LangChainæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘äººå‘˜ä½¿ç”¨è¯­è¨€æ¨¡å‹æ„å»ºç«¯åˆ°ç«¯çš„åº”ç”¨ç¨‹åºã€‚å®ƒæä¾›äº†ä¸€å¥—å·¥å…·ã€ç»„ä»¶å’Œæ¥å£ï¼Œå¯ç®€åŒ–åˆ›å»ºç”±å¤§å‹è¯­è¨€æ¨¡å‹ (LLM) å’ŒèŠå¤©æ¨¡å‹æä¾›æ”¯æŒçš„åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ã€‚LangChain å¯ä»¥è½»æ¾</summary>
      
    
    
    
    <category term="å®ç”¨æ•™ç¨‹" scheme="https://cyborg2077.github.io/categories/%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="LangChain" scheme="https://cyborg2077.github.io/tags/LangChain/"/>
    
  </entry>
  
  <entry>
    <title>SELECT FOR UPDATEçš„é”ç²’åº¦</title>
    <link href="https://cyborg2077.github.io/2023/12/31/SelectForUpdate/"/>
    <id>https://cyborg2077.github.io/2023/12/31/SelectForUpdate/</id>
    <published>2023-12-31T14:59:55.000Z</published>
    <updated>2024-01-14T12:06:36.159Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>åœ¨æ•°æ®åº“äº‹åŠ¡å¤„ç†ä¸­ï¼Œå¤„ç†æ•°æ®åº“å¹¶å‘è®¿é—®çš„è¯·æ±‚ä¸€ä¸ªå¤æ‚ä¸”é‡è¦çš„é—®é¢˜ï¼Œå½“å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®å¹¶å°è¯•ä¿®æ”¹åŒä¸€è¡Œæ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œä¾‹å¦‚ä¸¢å¤±æ›´æ–°æˆ–è„è¯»çš„æƒ…å†µã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ•°æ®åº“æä¾›äº†ä¸€äº›æœºå¤„ç†å¹¶å‘äº‹åŠ¡ï¼Œå…¶ä¸­ä¹‹ä¸€ä¾¿æ˜¯<code>SELECT ... FOR UPDATE</code>è¯­å¥ã€‚</li><li>åœ¨å¹¶å‘è®¿é—®çš„ç¯å¢ƒä¸­ï¼Œ<code>SELECT ... FOR UPDATE</code>å…è®¸äº‹åŠ¡åœ¨é€‰æ‹©æ•°æ®çš„åŒæ—¶ï¼Œé”å®šè¿™äº›æ•°æ®ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡<code>ä¿®æ”¹</code>è¿™äº›æ•°æ®ï¼Œç›´åˆ°å½“å‰äº‹åŠ¡å®Œæˆå¹¶é‡Šæ”¾é”ã€‚ä»æœ¬è´¨ä¸Šï¼Œ<code>SELECT ... FOR UPDATE</code>æ˜¯ä¸€ç§æ‚²é”çš„ç”¨æ³•ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªä¼šé”ä½ä¸€è¡Œæ•°æ®ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰æ­£ç¡®ä½¿ç”¨çš„è¯ï¼Œä¼šæŠŠæ•´å¼ è¡¨éƒ½é”ä½çš„ã€‚</li><li>æˆ‘ä¹Ÿåœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨è¿‡ï¼Œä¾‹å¦‚å…è´¹å­—æ•°æŠµæ‰£é‡‘é¢ä¸‹å•çš„åœºæ™¯ã€‚</li></ul><h1>å®è·µ</h1><ul><li>è™½ç„¶åœ¨MySQLä¸­æ˜¯é€šè¿‡<code>SELECT ... FOR UPDATE</code>è¯­å¥æ¥å®ç°çš„è¡Œé”çš„åŠŸèƒ½ã€‚ä½†æ˜¯å¦‚æœä½ åœ¨å®é™…å·¥ä½œä¸­ä½¿ç”¨ä¸æ­£ç¡®ï¼Œä¹Ÿå®¹æ˜“æŠŠæ•´å¼ è¡¨é”ä½ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚<code>SELECT ... FOR UPDATE</code>è¯­å¥çš„ç”¨æ³•æ˜¯å¦æ­£ç¡®ï¼Œè·Ÿ<code>WHEREæ¡ä»¶</code>ä¸­çš„å‚æ•°æœ‰å¾ˆå¤§çš„å…³ç³»ã€‚æˆ‘ä»¬å…ˆæ¥ç®€å•å»ºä¸ªè¡¨ï¼Œç„¶ååˆ†æä¸€ä¸‹ä¸‹é¢å‡ ç§æƒ…å†µã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_info (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,             <span class="comment">-- ä¸»é”®</span></span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">UNIQUE</span>,   <span class="comment">-- å”¯ä¸€ç´¢å¼•</span></span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,    <span class="comment">-- æ™®é€šç´¢å¼•</span></span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),          <span class="comment">-- æ™®é€šå­—æ®µ</span></span><br><span class="line">    INDEX idx_email (email)         </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_info (id, username, email, amount)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">1</span>, <span class="string">&#x27;john_doe&#x27;</span>, <span class="string">&#x27;john.doe@example.com&#x27;</span>, <span class="number">500.00</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="string">&#x27;alice_smith&#x27;</span>, <span class="string">&#x27;alice.smith@example.com&#x27;</span>, <span class="number">1000.00</span>),</span><br><span class="line">  (<span class="number">3</span>, <span class="string">&#x27;bob_jones&#x27;</span>, <span class="string">&#x27;bob.jones@example.com&#x27;</span>, <span class="number">1500.00</span>),</span><br><span class="line">  (<span class="number">4</span>, <span class="string">&#x27;lisa_davis&#x27;</span>, <span class="string">&#x27;lisa.davis@example.com&#x27;</span>, <span class="number">2000.00</span>),</span><br><span class="line">  (<span class="number">5</span>, <span class="string">&#x27;charlie_brown&#x27;</span>, <span class="string">&#x27;charlie.brown@example.com&#x27;</span>, <span class="number">2500.00</span>);</span><br></pre></td></tr></table></figure><h2 id="ä¸»é”®å­—æ®µ">ä¸»é”®å­—æ®µ</h2><ul><li>å½“<code>WHERE</code>æ¡ä»¶ä½¿ç”¨ä¸»é”®æ—¶</li></ul><div class="tabs" id="ä¸»é”®"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä¸»é”®-1">äº‹åŠ¡ä¸€</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-2">äº‹åŠ¡äºŒ</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-3">äº‹åŠ¡ä¸‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä¸»é”®-1"><ul><li>åœ¨äº‹åŠ¡ä¸€ä¸­ä½¿ç”¨<code>FOR UPDATE</code>ï¼ŒåŠ ä¸€ä¸ªè¡Œé”ï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰<code>COMMIT</code>æäº¤äº‹åŠ¡</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;  <span class="comment">-- å¼€å¯äº‹åŠ¡</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;  <span class="comment">-- åŠ è¡Œé”</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-2"><ul><li>åœ¨äº‹åŠ¡äºŒä¸­å°è¯•ä¿®æ”¹è¯¥è¡Œï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡ä¸€é‡Šæ”¾é”ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœäº‹åŠ¡ä¸€ï¼Œä¸€ç›´éƒ½ä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆäº‹åŠ¡äºŒæœ€ç»ˆä¼šæŠ¥è¿™ä¸ªå¼‚å¸¸</li></ul><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 10000 WHERE id = 1</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1205</span> - <span class="title class_">Lock</span> wait timeout exceeded; <span class="keyword">try</span> restarting transaction</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">æŸ¥è¯¢æ—¶é—´: <span class="number">50.</span>086s</span></span><br></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡ä¸€æäº¤äº‹åŠ¡åï¼Œäº‹åŠ¡äºŒæ‰èƒ½æ­£å¸¸æ‰§è¡Œ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-3"><ul><li>å¦‚æœæ­¤æ—¶å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¸‰ï¼Œä¿®æ”¹å…¶ä»–è¡Œçš„å€¼ï¼Œé‚£ä¹ˆæ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 10000 WHERE id = 2</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="title class_">Affected</span> <span class="attr">rows</span>: <span class="number">1</span></span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">æŸ¥è¯¢æ—¶é—´: <span class="number">0.</span>009s</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="å”¯ä¸€ç´¢å¼•">å”¯ä¸€ç´¢å¼•</h2><ul><li>å½“<code>WHERE</code>æ¡ä»¶ä½¿ç”¨å”¯ä¸€ç´¢å¼•æ—¶</li></ul><div class="tabs" id="ä¸»é”®"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä¸»é”®-1">äº‹åŠ¡ä¸€</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-2">äº‹åŠ¡äºŒ</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-3">äº‹åŠ¡ä¸‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä¸»é”®-1"><ul><li>åœ¨äº‹åŠ¡ä¸€ä¸­ä½¿ç”¨<code>FOR UPDATE</code>ï¼ŒåŠ ä¸€ä¸ªè¡Œé”ï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰<code>COMMIT</code>æäº¤äº‹åŠ¡</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;john_doe&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-2"><ul><li>åœ¨äº‹åŠ¡äºŒä¸­å°è¯•ä¿®æ”¹è¯¥è¡Œï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡ä¸€é‡Šæ”¾é”ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;john_doe&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœäº‹åŠ¡ä¸€ï¼Œä¸€ç›´éƒ½ä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆäº‹åŠ¡äºŒæœ€ç»ˆä¼šæŠ¥è¿™ä¸ªå¼‚å¸¸</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount = <span class="number">10000</span> <span class="keyword">WHERE</span> username = <span class="string">&#x27;john_doe&#x27;</span></span><br><span class="line">&gt; <span class="number">1205</span> - <span class="keyword">Lock</span> wait timeout exceeded; try restarting <span class="keyword">transaction</span></span><br><span class="line">&gt; æŸ¥è¯¢æ—¶é—´: <span class="number">50.084</span>s</span><br></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡ä¸€æäº¤äº‹åŠ¡åï¼Œäº‹åŠ¡äºŒæ‰èƒ½æ­£å¸¸æ‰§è¡Œ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-3"><ul><li>å¦‚æœæ­¤æ—¶å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¸‰ï¼Œä¿®æ”¹å…¶ä»–è¡Œçš„å€¼ï¼Œé‚£ä¹ˆæ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice_smith&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice_smith&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> Affected <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line"><span class="operator">&gt;</span> æŸ¥è¯¢æ—¶é—´: <span class="number">0.002</span>s</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="æ™®é€šç´¢å¼•">æ™®é€šç´¢å¼•</h2><ul><li>å½“<code>WHERE</code>æ¡ä»¶ä½¿ç”¨æ™®é€šç´¢å¼•æ—¶</li></ul><div class="tabs" id="ä¸»é”®"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä¸»é”®-1">äº‹åŠ¡ä¸€</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-2">äº‹åŠ¡äºŒ</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-3">äº‹åŠ¡ä¸‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä¸»é”®-1"><ul><li>åœ¨äº‹åŠ¡ä¸€ä¸­ä½¿ç”¨<code>FOR UPDATE</code>ï¼ŒåŠ ä¸€ä¸ªè¡Œé”ï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰<code>COMMIT</code>æäº¤äº‹åŠ¡</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;john.doe@example.com&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-2"><ul><li>åœ¨äº‹åŠ¡äºŒä¸­å°è¯•ä¿®æ”¹è¯¥è¡Œï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡ä¸€é‡Šæ”¾é”ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;john.doe@example.com&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœäº‹åŠ¡ä¸€ï¼Œä¸€ç›´éƒ½ä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆäº‹åŠ¡äºŒæœ€ç»ˆä¼šæŠ¥è¿™ä¸ªå¼‚å¸¸</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount = <span class="number">1000</span> <span class="keyword">WHERE</span> email = <span class="string">&#x27;john.doe@example.com&#x27;</span></span><br><span class="line">&gt; <span class="number">1205</span> - <span class="keyword">Lock</span> wait timeout exceeded; try restarting <span class="keyword">transaction</span></span><br><span class="line">&gt; æŸ¥è¯¢æ—¶é—´: <span class="number">50.082</span>s</span><br></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡ä¸€æäº¤äº‹åŠ¡åï¼Œäº‹åŠ¡äºŒæ‰èƒ½æ­£å¸¸æ‰§è¡Œ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-3"><ul><li>å¦‚æœæ­¤æ—¶å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¸‰ï¼Œä¿®æ”¹å…¶ä»–è¡Œçš„å€¼ï¼Œé‚£ä¹ˆæ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;alice.smith@example.com&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;alice.smith@example.com&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> Affected <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line"><span class="operator">&gt;</span> æŸ¥è¯¢æ—¶é—´: <span class="number">0.003</span>s</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="æ™®é€šå­—æ®µ">æ™®é€šå­—æ®µ</h2><ul><li>å½“<code>WHERE</code>æ¡ä»¶ä½¿ç”¨æ™®é€šå­—æ®µæ—¶</li></ul><div class="tabs" id="ä¸»é”®"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä¸»é”®-1">äº‹åŠ¡ä¸€</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-2">äº‹åŠ¡äºŒ</button></li><li class="tab"><button type="button" data-href="#ä¸»é”®-3">äº‹åŠ¡ä¸‰</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä¸»é”®-1"><ul><li>åœ¨äº‹åŠ¡ä¸€ä¸­ä½¿ç”¨<code>FOR UPDATE</code>ï¼ŒåŠ ä¸€ä¸ªè¡Œé”ï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰<code>COMMIT</code>æäº¤äº‹åŠ¡</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_info <span class="keyword">WHERE</span> amount <span class="operator">=</span> <span class="number">2500</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-2"><ul><li>åœ¨äº‹åŠ¡äºŒä¸­å°è¯•ä¿®æ”¹è¯¥è¡Œï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸€ç›´ç­‰å¾…äº‹åŠ¡ä¸€é‡Šæ”¾é”ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> amount <span class="operator">=</span> <span class="number">2500</span>;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœäº‹åŠ¡ä¸€ï¼Œä¸€ç›´éƒ½ä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆäº‹åŠ¡äºŒæœ€ç»ˆä¼šæŠ¥è¿™ä¸ªå¼‚å¸¸</li></ul><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 1000 WHERE amount = 2500</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1205</span> - <span class="title class_">Lock</span> wait timeout exceeded; <span class="keyword">try</span> restarting transaction</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">æŸ¥è¯¢æ—¶é—´: <span class="number">50.</span>17s</span></span><br></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡ä¸€æäº¤äº‹åŠ¡åï¼Œäº‹åŠ¡äºŒæ‰èƒ½æ­£å¸¸æ‰§è¡Œ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸»é”®-3"><ul><li>å¦‚æœæ­¤æ—¶å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¸‰ï¼Œä¿®æ”¹å…¶ä»–è¡Œçš„å€¼ï¼Œä¼šå‘ç°ä¹Ÿæ˜¯è¢«é˜»å¡äº†çš„</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> user_info <span class="keyword">SET</span> amount <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">WHERE</span> amount <span class="operator">=</span> <span class="number">2000</span>;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user_info SET amount = 1000 WHERE amount = 2000</span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript"><span class="number">1205</span> - <span class="title class_">Lock</span> wait timeout exceeded; <span class="keyword">try</span> restarting transaction</span></span><br><span class="line"><span class="meta prompt_">&gt;</span> <span class="language-javascript">æŸ¥è¯¢æ—¶é—´: <span class="number">50.</span>083s</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1>ç»“è®º</h1><ul><li>æ€»ç»“ä¸€ä¸‹<code>SELECT ... FOR UPDATE</code>åŠ é”çš„æƒ…å†µï¼š<ul><li>ä¸»é”®å­—æ®µï¼šåŠ è¡Œé”ã€‚</li><li>å”¯ä¸€ç´¢å¼•å­—æ®µï¼šåŠ è¡Œé”ã€‚</li><li>æ™®é€šç´¢å¼•å­—æ®µï¼šåŠ è¡Œé”ã€‚</li><li>æ™®é€šå­—æ®µï¼šåŠ è¡¨é”ã€‚</li></ul></li><li>å¦‚æœäº‹åŠ¡ä¸€åŠ äº†<code>è¡Œé”</code>ï¼Œä¸€ç›´æ²¡æœ‰é‡Šæ”¾é”ï¼Œäº‹åŠ¡äºŒæ“ä½œç›¸åŒè¡Œçš„æ•°æ®æ—¶ï¼Œä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¶…æ—¶ã€‚</li><li>å¦‚æœäº‹åŠ¡ä¸€åŠ äº†<code>è¡¨é”</code>ï¼Œä¸€ç›´æ²¡æœ‰é‡Šæ”¾é”ï¼Œäº‹åŠ¡äºŒä¸ç®¡æ“ä½œçš„æ˜¯å“ªä¸€è¡Œæ•°æ®ï¼Œéƒ½ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¶…æ—¶ã€‚</li></ul>]]></content>
    
    
    <summary type="html">SELECT ... FOR UPDATE åˆ°åº•æ˜¯åŠ äº†è¡Œé”è¿˜æ˜¯è¡¨é”ï¼Ÿ</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://cyborg2077.github.io/tags/%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB/"/>
    
  </entry>
  
  <entry>
    <title>æ¨¡æ‹ŸChatGPTæµå¼æ•°æ®--SSEæœ€ä½³å®è·µï¼ˆé™„å¯è¿è¡Œå®ä¾‹ï¼‰</title>
    <link href="https://cyborg2077.github.io/2023/11/25/ServerSendEvents/"/>
    <id>https://cyborg2077.github.io/2023/11/25/ServerSendEvents/</id>
    <published>2023-11-25T04:21:49.000Z</published>
    <updated>2024-02-24T03:18:26.518Z</updated>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>åœ¨ä½¿ç”¨ChatGPTçš„æ—¶å€™ï¼Œå‘ç°è¾“å…¥promptåï¼Œæ˜¯ä½¿ç”¨æµå¼çš„æ•ˆæœè¿”å›æ•°æ®ï¼Œç»™ç”¨æˆ·çš„æ˜¯ä¸€ä¸ªæ‰“å­—æœºçš„æ•ˆæœã€‚æŸ¥çœ‹å…¶ç½‘ç»œè¯·æ±‚ï¼Œå‘ç°è¿™ä¸ªæ¥å£çš„é€šå“åº”ç±»å‹æ˜¯<code>text/event-stream</code>ï¼Œä¸€ç§åŸºäºEventStreamçš„äº‹ä»¶æµã€‚<br><img src="https://z1.ax1x.com/2023/11/25/piwzPk8.png" alt=""></li><li>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦è¿™æ ·ä¼ è¾“å‘¢ï¼Ÿä»ä½¿ç”¨åœºæ™¯ä¸Šæ¥è¯´ï¼ŒChatGPTæ˜¯ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ çš„å¤§å‹è¯­è¨€æ¨¡å‹ï¼Œå¤„ç†è‡ªç„¶è¯­è¨€éœ€è¦å¤§é‡çš„è®¡ç®—èµ„æºå’Œæ—¶é—´ï¼Œé‚£ä¹ˆå“åº”é€Ÿåº¦è‚¯å®šæ˜¯æ¯”ä¸€èˆ¬ä¸šåŠ¡è¦æ…¢çš„ï¼Œé‚£ä¹ˆæ¥å£ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œæ˜¾ç„¶ä¹Ÿä¸åˆé€‚ï¼Œé‚£ä¹ˆå¯¹äºè¿™ç§å¯¹è¯åœºæ™¯ï¼Œé‡‡ç”¨SSEæŠ€æœ¯è¾¹è®¡ç®—è¾¹è¿”å›ï¼Œé¿å…ç”¨æˆ·å› ä¸ºç­‰å¾…æ—¶é—´è¿‡é•¿è€Œå…³é—­é¡µé¢ã€‚</li></ul><h1>æ¦‚è¿°</h1><div class="note info no-icon flat"><p>SSE(Server Sent Event)ï¼Œç›´è¯‘ä¸ºæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨ä¸»åŠ¨å‘é€äº‹ä»¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥è·å–åˆ°æœåŠ¡å™¨å‘é€çš„äº‹ä»¶ã€‚</p></div><ul><li>å¸¸è§çš„HTTPäº¤äº’æ–¹å¼ä¸»è¦æ˜¯å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œç„¶åæœåŠ¡ç«¯å“åº”ï¼Œç„¶åä¸€æ¬¡æ€§è¯·æ±‚å®Œæ¯•ã€‚ä½†æ˜¯åœ¨SSEçš„ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œç„¶åå»ºç«‹SSEè¿æ¥ä¸€ç›´ä¿æŒï¼ŒæœåŠ¡ç«¯å°±å¯ä»¥è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚</li><li>SSEç®€å•æ¥è¯´å°±æ˜¯æœåŠ¡å™¨ä¸»åŠ¨å‘å‰ç«¯æ¨é€æ•°æ®çš„ä¸€ç§æŠ€æœ¯ï¼Œå®ƒæ˜¯å•å‘çš„ã€‚SSEé€‚ç”¨äºæ¶ˆæ¯æ¨é€ã€ç›‘æ§ç­‰åªéœ€è¦æœåŠ¡ç«¯æ¨é€æ•°æ®çš„åœºæ™¯ä¸­ã€‚</li></ul><h1>ç‰¹ç‚¹</h1><ul><li>æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€<ol><li>HTML5æ–°æ ‡å‡†ï¼Œç”¨äºä»æœåŠ¡ç«¯è¯•è¯•æ¨é€æ•°æ®åˆ°æµè§ˆå™¨ç«¯ã€‚</li><li>ç›´æ¥å»ºç«‹åœ¨å½“å‰HTTPè¿æ¥ä¸Šï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªHTTPé•¿è¿æ¥ã€‚</li></ol></li></ul><h1>SSEä¸WebSocketçš„åŒºåˆ«</h1><ul><li>SSEæ˜¯å•å·¥çš„ï¼Œåªèƒ½ç”±æœåŠ¡ç«¯æƒ³å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼Œè€ŒWebSocketæ˜¯åŒå·¥çš„</li></ul><table><thead><tr><th style="text-align:center">SSE</th><th style="text-align:center">WebScoket</th></tr></thead><tbody><tr><td style="text-align:center">http åè®®</td><td style="text-align:center">ç‹¬ç«‹çš„ websocket åè®®</td></tr><tr><td style="text-align:center">è½»é‡ï¼Œä½¿ç”¨ç®€å•</td><td style="text-align:center">ç›¸å¯¹å¤æ‚</td></tr><tr><td style="text-align:center">é»˜è®¤æ”¯æŒæ–­çº¿é‡è¿</td><td style="text-align:center">éœ€è¦è‡ªå·±å®ç°æ–­çº¿é‡è¿</td></tr><tr><td style="text-align:center">æ–‡æœ¬ä¼ è¾“</td><td style="text-align:center">äºŒè¿›åˆ¶ä¼ è¾“</td></tr><tr><td style="text-align:center">æ”¯æŒè‡ªå®šä¹‰å‘é€çš„æ¶ˆæ¯ç±»å‹</td><td style="text-align:center">-</td></tr></tbody></table><h1>SSEè§„èŒƒ</h1><ul><li>åœ¨HTML5ä¸­ï¼ŒæœåŠ¡ç«¯SSEä¸€èˆ¬è¦éµå¾ªä»¥ä¸‹è¦æ±‚<ol><li>è¯·æ±‚å¤´ï¼šå¼€å¯é•¿è¿æ¥ + æµå¼ä¼ é€’</li></ol>  <figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-<span class="keyword">Type</span>: <span class="type">text</span>/event-stream;charset=UTF<span class="number">-8</span></span><br><span class="line"><span class="keyword">Cache</span>-Control: no-<span class="keyword">cache</span></span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure><ol start="2"><li>æ•°æ®æ ¼å¼ï¼šæœåŠ¡ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œç”±messageç»„æˆï¼Œå…¶æ ¼å¼å¦‚ä¸‹</li></ol>  <figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">field:</span>value</span><br></pre></td></tr></table></figure></li></ul><h1>SSEå®è·µ</h1><ul><li>è¿™é‡Œç®€å•åšä¸€ä¸ªæ—¶é’Ÿæ•ˆæœï¼Œæœ‰æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€å½“å‰æ—¶é—´æ•°æ®ç»™å‰ç«¯ï¼Œå‰ç«¯é¡µé¢æ¥æ”¶åå±•ç¤ºã€‚</li></ul><h2 id="SseEmitterç±»ç®€ä»‹">SseEmitterç±»ç®€ä»‹</h2><ul><li>SpringBootä½¿ç”¨SseEmitteræ¥æ”¯æŒSSEï¼Œå¹¶å¯¹SSEè§„èŒƒåšäº†ä¸€äº›å°è£…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ã€‚æˆ‘ä»¬åœ¨æ“ä½œSseEmitterå¯¹è±¡æ—¶ï¼Œåªéœ€è¦å…³æ³¨å‘é€çš„æ¶ˆæ¯æ–‡æœ¬å³å¯ã€‚</li><li>SseEmittterç±»çš„å‡ ä¸ªæ–¹æ³•ï¼š<ol><li>send()ï¼šå‘é€æ•°æ®ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªéSseEventBuilderå¯¹è±¡ï¼Œé‚£ä¹ˆä¼ é€’å‚æ•°ä¼šè¢«å°è£…åˆ°dataä¸­ã€‚</li><li>complete()ï¼šè¡¨ç¤ºæ‰§è¡Œå®Œæˆï¼Œä¼šæ–­å¼€è¿æ¥ï¼ˆå¦‚æœæ˜¯ä¸€äº›è½®è¯¢è¿›åº¦çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»åŠ¡è¿›åº¦å®Œæˆæ—¶ï¼Œä¸»åŠ¨æ–­å¼€è¿æ¥ï¼‰</li><li>onTimeout()ï¼šè¿æ¥è¶…æ—¶æ—¶å›è°ƒè§¦å‘ã€‚</li><li>onCompletion()ï¼šç»“æŸä¹‹åçš„å›è°ƒè§¦å‘ã€‚</li><li>onError()ï¼šæŠ¥é”™æ—¶çš„å›è°ƒè§¦å‘ã€‚</li></ol></li></ul><h2 id="ç¤ºä¾‹Demo">ç¤ºä¾‹Demo</h2><div class="tabs" id="sseæ—¶é’Ÿdemo"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#sseæ—¶é’Ÿdemo-1">å‰ç«¯HTML</button></li><li class="tab"><button type="button" data-href="#sseæ—¶é’Ÿdemo-2">åç«¯æ¥å£</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="sseæ—¶é’Ÿdemo-1"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;msg_from_server&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> sse = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="string">&quot;http://localhost/sse/hello&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    sse.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> eventVal = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;msg_from_server&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        eventVal.<span class="property">innerHTML</span> = event.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="sseæ—¶é’Ÿdemo-2"><ul><li>åç«¯æ¥å£</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sse&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">helloworld</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                    sseEmitter.send(SseEmitter.event().data(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>))));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Error in SSE: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                sseEmitter.completeWithError(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>å¤§åŠŸå‘Šæˆ<br><img src="https://z1.ax1x.com/2023/11/25/pi0EfLF.png" alt=""></li></ul><h2 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h2><ul><li>è¿™é‡Œçš„åè®®æ˜¯<code>http/1.1</code>ï¼Œä»…æ”¯æŒ6ä¸ªè¿æ¥æ•°ï¼Œè€Œ<code>HTTP/2</code>é»˜è®¤æ”¯æŒ100ä¸ªè¿æ¥æ•°ï¼ŒåŒæ—¶è¿™é‡Œæ¯30ç§’é‡æ–°å»ºç«‹äº†ä¸€ä¸ªæ–°è¿æ¥ï¼Œè¿™æ˜¯SSEé»˜è®¤çš„è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®è¿æ¥è¶…æ—¶æ—¶é—´æ¥è¾¾åˆ°ä¸è¿‡æœŸçš„ç›®çš„ï¼Œé‚£ä¹ˆå°±éœ€è¦æˆ‘ä»¬åœ¨ä¸šåŠ¡é€»è¾‘é‡Œ<code>æ‰‹åŠ¨å…³é—­è¿æ¥</code>ã€‚</li><li>åŒæ—¶ï¼Œæ¯å»ºç«‹ä¸€ä¸ªSSEè¿æ¥çš„æ—¶å€™ï¼Œéƒ½éœ€è¦ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± æ¥å¤„ç†å¹¶å‘é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿè¦æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡éœ€æ±‚æ¥åšå¥½å‹æµ‹ã€‚<br><img src="https://z1.ax1x.com/2023/11/25/pi0VFQf.png" alt=""></li><li>ä½†æ˜¯<code>HTTP/2</code>ä»…æ”¯æŒ<code>HTTPS</code>ï¼Œæˆ‘è¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å»äº†è§£ä¸€ä¸‹ä½¿ç”¨OpenSSLç”Ÿæˆä¸€ä¸ª<code>è‡ªç­¾åçš„SSLè¯ä¹¦</code></li></ul><h2 id="å·¥å…·ç±»å°è£…">å·¥å…·ç±»å°è£…</h2><ul><li>ä¸‹é¢æ˜¯æˆ‘å°è£…çš„ä¸€ä¸ªç®€å•çš„SseUtils</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SseUtils</span> &#123;</span><br><span class="line">    <span class="comment">// timeout -&gt; 0è¡¨ç¤ºä¸è¿‡æœŸï¼Œé»˜è®¤æ˜¯30ç§’ï¼Œè¶…è¿‡æ—¶é—´æœªå®Œæˆï¼ˆæ–­å¼€ï¼‰ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">DEFAULT_TIME_OUT</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// ä¼šè¯map, æ–¹ä¾¿ç®¡ç†è¿æ¥æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, SseEmitter&gt; conversationMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å»ºç«‹è¿æ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitter <span class="title function_">getConnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºSSE</span></span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>(DEFAULT_TIME_OUT);</span><br><span class="line">        <span class="comment">// å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®å‰ç«¯é‡è¯•æ—¶5s</span></span><br><span class="line">            sseEmitter.send(SseEmitter.event().reconnectTime(<span class="number">5_000L</span>).data(<span class="string">&quot;SSEå»ºç«‹æˆåŠŸ&quot;</span>));</span><br><span class="line">            <span class="comment">// è¿æ¥è¶…æ—¶</span></span><br><span class="line">            sseEmitter.onTimeout(() -&gt; SseUtils.timeout(conversationId));</span><br><span class="line">            <span class="comment">// è¿æ¥æ–­å¼€</span></span><br><span class="line">            sseEmitter.onCompletion(() -&gt; SseUtils.completion(conversationId));</span><br><span class="line">            <span class="comment">// é”™è¯¯</span></span><br><span class="line">            sseEmitter.onError((e) -&gt; SseUtils.error(conversationId, e.getMessage()));</span><br><span class="line">            <span class="comment">// æ·»åŠ sse</span></span><br><span class="line">            conversationMap.put(conversationId, sseEmitter);</span><br><span class="line">            <span class="comment">// è¿æ¥æˆåŠŸ</span></span><br><span class="line">            log.info(<span class="string">&quot;åˆ›å»ºsseè¿æ¥æˆåŠŸ ==&gt; å½“å‰è¿æ¥æ€»æ•°=&#123;&#125;ï¼Œ ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationMap.size(), conversationId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// æ—¥å¿—</span></span><br><span class="line">            log.error(<span class="string">&quot;å‰ç«¯é‡è¿å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * è·å–æ¶ˆæ¯å®ä¾‹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitter <span class="title function_">getInstance</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.get(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * æ–­å¼€è¿æ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">disconnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        SseUtils.getInstance(conversationId).complete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»™æŒ‡å®šä¼šè¯å‘é€æ¶ˆæ¯ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œè¿”å›false</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jsonMsg        - æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String conversationId, String jsonMsg)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¯¥ä¼šè¯æ˜¯å¦å·²å»ºç«‹è¿æ¥</span></span><br><span class="line">        <span class="comment">// å·²å»ºç«‹è¿æ¥</span></span><br><span class="line">        <span class="keyword">if</span> (SseUtils.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">                SseUtils.getInstance(conversationId).send(jsonMsg, MediaType.APPLICATION_JSON);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// æ—¥å¿—</span></span><br><span class="line">                SseUtils.removeClientId(conversationId);</span><br><span class="line">                log.error(<span class="string">&quot;å‘é€æ¶ˆæ¯å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœªå»ºç«‹è¿æ¥</span></span><br><span class="line">            log.error(<span class="string">&quot;è¿æ¥ä¸å­˜åœ¨æˆ–è€…è¶…æ—¶ ==&gt; ä¼šè¯Id=&#123;&#125;ä¼šè¯è‡ªåŠ¨å…³é—­&quot;</span>, conversationId);</span><br><span class="line">            SseUtils.removeClientId(conversationId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»é™¤ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨å­˜åœ¨ä¼šè¯</span></span><br><span class="line">        <span class="keyword">if</span> (!SseUtils.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ é™¤è¯¥ä¼šè¯</span></span><br><span class="line">        conversationMap.remove(conversationId);</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.info(<span class="string">&quot;ç§»é™¤ä¼šè¯æˆåŠŸ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ˜¯å¦å­˜åœ¨ä¼šè¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">getIsExistClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.containsKey(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å½“å‰è¿æ¥æ€»æ•°</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - è¿æ¥æ€»æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getConnectTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;å½“å‰è¿æ¥æ•°ï¼š&#123;&#125;&quot;</span>, conversationMap.size());</span><br><span class="line">        <span class="keyword">for</span> (String s : conversationMap.keySet()) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;è¾“å‡ºSSE-Mapï¼š&#123;&#125;&quot;</span>, conversationMap.get(s));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¶…æ—¶</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">timeout</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.error(<span class="string">&quot;sseè¿æ¥è¶…æ—¶ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtils.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®Œæˆ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">completion</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.info(<span class="string">&quot;sseè¿æ¥å·²æ–­å¼€ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtils.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”™è¯¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String conversationId, String message)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.error(<span class="string">&quot;sseæœåŠ¡å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, message);</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtils.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿˜æ˜¯ç”¨åˆšåˆšæ¨é€å½“å‰æ—¶é—´çš„ä¾‹å­ï¼Œè¿™é‡Œæˆ‘ä»¬åšä¸€ä¸‹ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œæˆ‘è¿™é‡Œç®€å•çš„é€»è¾‘å°±æ˜¯éå†åˆ°ä¸€ä¸ªæ•´åˆ†ï¼Œå°±åœæ­¢æ¨é€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">timeStamp</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line">    response.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    <span class="comment">// ç”Ÿæˆä¼šè¯ID</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">conversationId</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="comment">// å»ºç«‹è¿æ¥</span></span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> SseUtils.getConnect(conversationId);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                <span class="comment">// å‘ä¼šè¯å‘é€æ¶ˆæ¯</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">timeStamp</span> <span class="operator">=</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">                SseUtils.sendMessage(conversationId, timeStamp);</span><br><span class="line">                <span class="keyword">if</span> (timeStamp.endsWith(<span class="string">&quot;00&quot;</span>)) &#123;</span><br><span class="line">                    SseUtils.removeClientId(conversationId);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error in SSE: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            sseEmitter.completeWithError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">return</span> sseEmitter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>SSEå®æˆ˜</h1><ul><li>æˆ‘è¿™é‡Œä¹Ÿæ˜¯åœ¨æˆ‘é¡¹ç›®é‡Œçš„è½®è¯¢è®¢å•è¿›åº¦çš„æ—¶å€™å°è¯•ç”¨äº†ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘è¿™ä¸ªé¡¹ç›®ä¹Ÿæ˜¯æ–‡æœ¬ç”Ÿæˆæ–¹å‘çš„ï¼Œä¹‹å‰æ˜¯å‰ç«¯å®šæ—¶è½®è¯¢æˆ‘è¿™è¾¹çš„æ¥å£ï¼Œç°åœ¨æ¢æˆæˆ‘ä¸»åŠ¨å‘å‰ç«¯æ¨é€æ•°æ®ï¼Œç„¶åå‰ç«¯æ‹¿åˆ°æ•°æ®è‡ªå·±è§£æå†…å®¹å°±å¥½äº†ã€‚è¿™é‡Œç”¨çš„å·¥å…·ç±»å°±æ˜¯æˆ‘åˆšåˆšå°è£…çš„é‚£ä¸ª</li></ul><div class="tabs" id="å®æˆ˜"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#å®æˆ˜-1">Controllerå±‚</button></li><li class="tab"><button type="button" data-href="#å®æˆ˜-2">Serviceå±‚</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="å®æˆ˜-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderDetail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">getOrderDetailById</span><span class="params">(String orderId, HttpServletResponse httpServletResponse)</span> &#123;</span><br><span class="line">    httpServletResponse.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">    httpServletResponse.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> orderService.getOrderDetailById(orderId, httpServletResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å®æˆ˜-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®€å•æ¥ä¸ªçº¿ç¨‹æ± </span></span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">60</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">getOrderDetailById</span><span class="params">(String orderId, HttpServletResponse httpServletResponse)</span> &#123;</span><br><span class="line">    <span class="comment">// å»ºç«‹è¿æ¥</span></span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> SseUtils.getConnect(orderId);</span><br><span class="line">    executor.execute(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;=========SSEè½®è¯¢ä¸­=========&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ¯5ç§’æ¨é€ä¸€æ¬¡æ•°æ®</span></span><br><span class="line">                Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æŸ¥è¯¢è®¢å•æ•°æ®</span></span><br><span class="line">            <span class="type">Torder</span> <span class="variable">torder</span> <span class="operator">=</span> orderMapper.selectOne(Wrappers.lambdaQuery(Torder.class).eq(Torder::getOrderId, orderId));</span><br><span class="line">            <span class="keyword">if</span> (torder == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè®¢å•ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ï¼Œä¸»åŠ¨æ–­å¼€è¿æ¥</span></span><br><span class="line">                SseUtils.sendMessage(orderId, JSON.toJSONString(ErrorCodeEnum.ORDER_ID_NOT_EXIST));</span><br><span class="line">                SseUtils.removeClientId(orderId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">OrderDetailVO</span> <span class="variable">detailVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDetailVO</span>();</span><br><span class="line">            detailVO.setIsExpire(stringRedisTemplate.opsForValue().get(orderId) == <span class="literal">null</span>);</span><br><span class="line">            detailVO.setOrderId(orderId);</span><br><span class="line">            detailVO.setCreateTime(torder.getCreateTime());</span><br><span class="line">            detailVO.setOrderType(torder.getPolishType());</span><br><span class="line">            detailVO.setAmount(torder.getAmount().doubleValue());</span><br><span class="line">            <span class="comment">// æ ¹æ®ä¸åŒçš„è®¢å•ç±»å‹æ¥å°è£…ä¸åŒçš„å‚æ•°ï¼ˆè¿™é‡Œä¸ºäº†æ»¡è¶³äº§å“çš„éœ€æ±‚ï¼Œæƒ³ç”¨ä¸€ä¸ªæ¥å£æ˜¾ç¤ºä¸åŒç§ç±»è®¢å•çš„ä¿¡æ¯ï¼Œç”¨äº†SQLåæ¨¡å¼è®¾è®¡æ•°æ®åº“ï¼Œå¯¼è‡´ä»£ç å¾ˆä¸ä¼˜é›…ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (torder.getOrderType() == <span class="number">0</span>) &#123;</span><br><span class="line">                Wrapper&lt;Object&gt; statusByOrderId = getStatusByOrderId(orderId);</span><br><span class="line">                <span class="keyword">if</span> (statusByOrderId.getCode() != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// è®¢å•çŠ¶æ€æŸ¥è¯¢å¼‚å¸¸ï¼Œè¿”å›é”™è¯¯ï¼Œä¸»åŠ¨æ–­å¼€è¿æ¥</span></span><br><span class="line">                    SseUtils.sendMessage(orderId, JSON.toJSONString(ErrorCodeEnum.ASYNC_SERVICE_ERROR));</span><br><span class="line">                    SseUtils.removeClientId(orderId);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (torder.getPolishType() == Common.POLISH_TYPE_WITH_PAPER) &#123;</span><br><span class="line">                    <span class="type">PaperStatusByOrderIdVO</span> <span class="variable">paperVO</span> <span class="operator">=</span> (PaperStatusByOrderIdVO) statusByOrderId.getResult();</span><br><span class="line">                    BeanUtils.copyProperties(paperVO, detailVO);</span><br><span class="line">                    detailVO.setProgress(Double.valueOf(paperVO.getProgress()));</span><br><span class="line">                    detailVO.setTitle(paperVO.getPaperTitle());</span><br><span class="line">                    detailVO.setOrderStatus(paperVO.getStatus());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">TextStatusByOrderIdVO</span> <span class="variable">textVO</span> <span class="operator">=</span> (TextStatusByOrderIdVO) statusByOrderId.getResult();</span><br><span class="line">                    BeanUtils.copyProperties(textVO, detailVO);</span><br><span class="line">                    detailVO.setProgress(Double.valueOf(textVO.getProgress()));</span><br><span class="line">                    detailVO.setTitle(textVO.getPaperTitle());</span><br><span class="line">                    detailVO.setOrderStatus(textVO.getStatus());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (torder.getOrderType() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">CheckpassOrder</span> <span class="variable">checkpassOrder</span> <span class="operator">=</span> checkpassOrderMapper.selectOne(Wrappers.lambdaQuery(CheckpassOrder.class).eq(CheckpassOrder::getOrderId, orderId));</span><br><span class="line">                <span class="type">CheckpassReport</span> <span class="variable">checkpassReport</span> <span class="operator">=</span> checkpassReportMapper.selectOne(Wrappers.lambdaQuery(CheckpassReport.class).eq(CheckpassReport::getPaperId, checkpassOrder.getPaperId()));</span><br><span class="line">                detailVO.setOrderStatus(checkpassOrder.getStatus());</span><br><span class="line">                detailVO.setAuthor(checkpassReport.getAuthor());</span><br><span class="line">                detailVO.setTitle(checkpassReport.getTitle());</span><br><span class="line">                detailVO.setProgress(checkpassReport.getCopyPercent() == <span class="literal">null</span> ? <span class="number">0</span> : checkpassReport.getCopyPercent());</span><br><span class="line">                detailVO.setCheckVersion(CommonUtil.getCheckVersion(checkpassOrder.getJaneName()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> SseUtils.sendMessage(orderId, JSON.toJSONString(detailVO));</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (torder.getStatus() == Common.ORDER_FINISH_STATUS) &#123;</span><br><span class="line">                <span class="comment">// è®¢å•å®Œæˆï¼Œä¸»åŠ¨å…³é—­è¿æ¥</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    emitter.send(SseEmitter.event().reconnectTime(<span class="number">5000L</span>).data(<span class="string">&quot;SSEå…³é—­è¿æ¥&quot;</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                SseUtils.removeClientId(orderId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h1>ä½¿ç”¨è¿‡ç¨‹ä¸­çš„ä¸€äº›å‘</h1><ol><li>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæµè§ˆå™¨ä¸­æŸ¥çœ‹æ¥å£ä¸€ç›´æ˜¾ç¤ºå¾…å¤„ç†çŠ¶æ€ï¼Œä½†æˆ‘çš„JavaæœåŠ¡ç¡®ç¡®å®å®å·²ç»æ¨é€äº†æ•°æ®ã€‚<ul><li>å¦‚æœä½ ç­‰å¾…äº†ä¸€ä¼šå„¿ï¼Œå‘ç°è¯·æ±‚å“åº”æˆåŠŸï¼Œä½†æ˜¯ä¸€æ¬¡æ€§æ¨é€äº†å¾ˆå¤šæ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯ç¼“å†²åŒºçš„é—®é¢˜ï¼Œå› ä¸ºSSEæ˜¯æµå¼è¾“å‡ºï¼Œæµå¼è¾“å‡ºé€šå¸¸ä¼šæ¶‰åŠåˆ°ç¼“å†²åŒºçš„ä½¿ç”¨ã€‚åœ¨Java Servletä¸­ï¼ŒHttpServletResponseå¯¹è±¡çš„è¾“å‡ºæµä¼šæœ‰ä¸€ä¸ªç¼“å†²åŒºã€‚å½“ä½¿ç”¨Servletçš„è¾“å‡ºæµå†™å…¥æ•°æ®æ—¶ï¼Œè¿™äº›æ•°æ®é¦–å…ˆä¼šè¢«å†™å…¥ç¼“å†²åŒºï¼Œç„¶åæ‰ä¼šè¢«å‘é€åˆ°å®¢æˆ·ç«¯ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å†ä»£ç ä¸­ç¦ç”¨æ‰ã€‚</li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpServletResponse.setHeader(<span class="string">&quot;X-Accel-Buffering&quot;</span>, <span class="string">&quot;no&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>åŒæ—¶Nginxé‡Œä¹Ÿè¦åŠ ä¸ŠåŒæ ·çš„é…ç½®ï¼Œå¦‚æœä½ ä¸­é—´ç»è¿‡äº†å¤šçº§Nginxï¼Œéœ€è¦æ¯ä¸€çº§Nginxéƒ½ç¦ç”¨æ­¤é¡¹ã€‚</li></ul> <figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_buffering</span> <span class="literal">off</span>;</span><br></pre></td></tr></table></figure></li><li>å¦‚æœä½ ä½¿ç”¨äº†é˜¿é‡Œäº‘çš„CDNæœåŠ¡ï¼Œé‚£ä¹ˆè¯·è®¾ç½®ä¸ºåŠ¨æ€åŠ é€Ÿ</li><li>æœåŠ¡ç«¯æ— æ³•åˆ°å®¢æˆ·ç«¯ç½‘ç»œä¸­æ–­ï¼šå®¢æˆ·ç«¯ç½‘ç»œä¸­æ–­åï¼ŒæœåŠ¡ç«¯æ— æ³•æ„ŸçŸ¥åˆ°å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œå°±ä¼šå¯¼è‡´æœåŠ¡ç«¯çš„çº¿ç¨‹ä¸­çš„ä»»åŠ¡ä¸€ç›´åœ¨è¿è¡Œï¼Œä¸æ–­åœ°ç»™è¿™ä¸ªå®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ã€‚è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š<ol><li>é€šè¿‡ç»™ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ç»™æœåŠ¡ç«¯è®¾ç½®ä¸åŒçš„æœ€å¤§è¿æ¥æ—¶é•¿ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é•¿ï¼ŒæœåŠ¡ç«¯ä¼šä¸»åŠ¨åœ°å»æ–­å¼€è¿™ä¸ªè¿æ¥ã€‚</li><li>å®¢æˆ·ç«¯æ„ŸçŸ¥æ–­å¼€è¿æ¥çš„é€šçŸ¥ä¹‹åï¼Œå¦‚æœå½“å‰è®¢å•ä»»åŠ¡è¿˜æœªç»“æŸï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šé‡æ–°å»ºç«‹è¿æ¥ï¼Œç›´åˆ°è®¢å•ä»»åŠ¡ç»“æŸï¼Œè¿™æ ·åšèƒ½é¿å…ä¸€äº›æ— æ•ˆä¼šè¯ä¸€ç›´åœ¨æ¨é€æ¶ˆæ¯çš„é—®é¢˜ã€‚</li></ol></li><li>å®¢æˆ·ç«¯é‡è¿æœºåˆ¶ï¼šå¦‚æœå®¢æˆ·ç«¯å› ä¸ºç½‘ç»œé—®é¢˜æˆ–è€…å…¶ä»–é—®é¢˜è¿›è¡Œäº†æ–­çº¿ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šæ ¹æ®æœåŠ¡ç«¯å‘é€çš„retryå‚æ•°è®¾ç½®çš„æ—¶é—´é—´éš”è¿›è¡Œé‡è¿ï¼Œè€Œè¿™ä¸ªæ—¶å€™æœåŠ¡ç«¯æ˜¯æš‚æ—¶æ— æ³•æ„ŸçŸ¥åˆ°å®¢æˆ·ç«¯å·²ç»æ–­çº¿äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šåœ¨æŒç»­åœ°å»ç»™å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ã€‚å‡å¦‚å®¢æˆ·ç«¯é‡è¿æˆåŠŸä¹‹åï¼Œå°±ä¼šå‡ºç°ä»¥ä¸‹ä¸¤ç§åœºæ™¯ï¼š<ol><li>æœåŠ¡ç«¯æœªæ–­å¼€è¿æ¥ï¼šå¤ç”¨ä¹‹å‰çš„è¿æ¥çº¿è·¯ï¼Œå®¢æˆ·ç«¯ä¼šä¸€æ¬¡æ€§æ”¶åˆ°å¤šæ¡æ–­çº¿æœŸé—´æœªæ”¶åˆ°çš„æ¶ˆæ¯å†…å®¹ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯ä½¿ç”¨é™æµï¼Œåªæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œå‡å°‘DOMæ¸²æŸ“ã€‚</li><li>æœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€äº†è¿æ¥ï¼ˆè®¢å•ä»»åŠ¡ç»“æŸæ–­å¼€/è¾¾åˆ°æœ€å¤§è¿æ¥æ—¶é•¿ï¼‰ï¼šé‡æ–°å»ºç«‹ä¸€æ¡çº¿è·¯ï¼ˆä¹‹å‰çš„é‚£æ¡çº¿è·¯å…¶å®è¿˜æ˜¯å­˜åœ¨çš„ï¼‰ï¼Œå› ä¸ºæ˜¯ä¸€æ¡æ–°çº¿è·¯æ‰€ä»¥ä¹‹å‰æ–­çº¿æ—¶ï¼ŒæœåŠ¡ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œæ˜¯æ”¶ä¸åˆ°çš„ã€‚</li></ol></li><li>å¦‚ä½•ä¿è¯ç”¨æˆ·åœ¨åŒä¸€ä¸ªä¸šåŠ¡åœºæ™¯ä¸‹åªä¼šå»ºç«‹ä¸€æ¡è¿æ¥ï¼Ÿ<ol><li>è¿™ä¹Ÿå°±æ˜¯ä¸Šé¢æ ‡é»„å¤„æåˆ°çš„é—®é¢˜ï¼Œä¹‹å‰çš„ä¼šè¯idéƒ½æ˜¯æœåŠ¡ç«¯æ¥ç”Ÿæˆï¼Œæœ€åä¿®æ”¹ä¸ºå®¢æˆ·ç«¯æ¥ç”Ÿæˆä¼šè¯idå¹¶ä¸”ä¸´æ—¶ä¿å­˜åœ¨æœ¬åœ°ç­–ç•¥å°±æ˜¯ï¼ˆä¸šåŠ¡ID - ç”¨æˆ·tokenå20ä½ - é¡µé¢RUNTIME_IDï¼‰ï¼Œè¿™ä¸ªæ ·åšçš„åŸå› ä¸»è¦è¿˜æ˜¯ç¡®ä¿ç”¨æˆ·åœ¨åŒä¸€ä¸ªä¸šåŠ¡åœºæ™¯ä¸‹æˆ–è€…åœ¨æ–­çº¿é‡è¿æ—¶ å®¢æˆ·ç«¯æ¯æ¬¡å‘æœåŠ¡ç«¯å»ºç«‹è¿æ¥çš„ä¼šè¯idéƒ½æ˜¯ç›¸åŒçš„ï¼Œä»è€Œæ–¹ä¾¿åé¢ æœåŠ¡ç«¯æ–­å¼€ä¹‹å‰çš„çº¿è·¯ã€‚</li><li>ç”±äºæœåŠ¡ç«¯é‡‡ç”¨çš„æ˜¯HashMapæ¥å­˜å‚¨æ¯ä¸ªSSEå¯¹è±¡ï¼Œæ‰€ä»¥åœ¨æ’å…¥idç›¸åŒçš„ä¼šè¯çš„æ—¶å€™ï¼Œä¼šç›´æ¥æ›¿æ¢mapä¸­å·²ç»å­˜åœ¨çš„ä¼šè¯ï¼Œè™½ç„¶ä¹‹å‰çš„ä¼šè¯å·²ç»ä¸å­˜åœ¨äº†ï¼Œä½†æ˜¯å…¶å»ºç«‹çš„è¿æ¥å¹¶æ²¡æœ‰çœŸæ­£çš„æ–­å¼€ï¼Œæ‰€ä»¥æœåŠ¡ç«¯åœ¨æ–°çš„ä¼šè¯æ’å…¥ä¹‹å‰ï¼Œå…ˆå»æ˜¾å¼åœ°å»å°†ä¹‹å‰çš„ä¼šè¯æ‰§è¡Œä¸€æ¬¡æ–­å¼€è¿æ¥çš„æ“ä½œï¼Œç„¶åå†å»æ‰§è¡Œåˆ›å»ºè¿æ¥æ“ä½œã€‚å¦åˆ™ï¼Œå½“å¤šä½™çš„çº¿è·¯è¾¾åˆ°ä¸€å®šçš„æ•°é‡ä¹‹åï¼Œå®¢æˆ·ç«¯ä¼šå‡ºç°çº¿è·¯é˜»å¡çš„é—®é¢˜ã€‚</li></ol></li><li>æ–°çš„ä¼šè¯åŠ å…¥ä¹‹åï¼Œå¦‚ä½•ä¸­æ–­æ—§ä¼šè¯å ç”¨çš„çº¿ç¨‹ï¼Ÿ<ul><li>ä¸€å¼€å§‹çš„é€»è¾‘æ˜¯å°†ä¼šè¯idä¿ç•™åœ¨çº¿ç¨‹ä¹‹ä¸­ï¼Œå…·ä½“æµç¨‹æ˜¯ï¼šåˆ¤æ–­å½“å‰ä¼šè¯æ˜¯å¦å­˜åœ¨ -&gt; å­˜åœ¨å°±æ¨é€æ¶ˆæ¯ -&gt; sleep nç§’ã€‚è¿™æ ·çš„å¤„ç†çš„è¯å°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨è¿™é‡Œåˆ¤æ–­äº†ä¼šè¯idæ˜¯å¦å­˜åœ¨ï¼Œä½†æ˜¯ç”±äºä¸Šé¢æˆ‘ä»¬åœ¨æ›¿æ¢æ—§ä¼šè¯çš„æ—¶å€™ï¼Œåˆé‡æ–°åˆ›å»ºäº†ä¸€ä¸ªç›¸åŒidçš„æ–°ä¼šè¯ï¼ˆåœ¨åŒä¸€ä¸ªä¸šåŠ¡åœºæ™¯ä¸‹å¤šæ¬¡å»ºç«‹è¿æ¥ï¼Œæ¯æ¬¡çš„ä¼šè¯idæ˜¯ä¸€æ ·çš„ï¼‰ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹sleepç»“æŸä¹‹åï¼Œä¼šå‘ç°è¿™ä¸ªä¼šè¯æ˜¯å­˜åœ¨çš„ï¼Œä»è€Œä¼šç»§ç»­ç»™è¿™ä¸ªä¼šè¯æ¨é€æ¶ˆæ¯ã€‚è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯ä¼šæ”¶åˆ°å¤šä¸ªä¸åŒçº¿ç¨‹å‘é€æ¥çš„æ¶ˆæ¯çš„é—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š<ol><li>åœ¨æ¯æ¬¡å»ºç«‹è¿æ¥çš„æ—¶å€™å°†ä¼šè¯å’Œè¯¥ä¼šè¯çš„æ‰€å±çº¿ç¨‹å…³è”åœ¨ä¸€èµ·ï¼Œä¹Ÿå°±æ˜¯å°†ç®¡ç†ä¼šè¯çš„mapç”±åŸæ¥çš„ <code>Map&lt;String, SseEmitter&gt;</code>ç±»å‹ï¼Œä¿®æ”¹ä¸ºï¼š <code>Map&lt;String, SseEmitterInfo&gt;</code>   ç±»å‹ï¼Œå…¶ä¸­SseEmitterInfoæ˜¯æˆ‘ä»¬è‡ªå·±å°è£…çš„ä¸€ä¸ªç±»ï¼Œå…¶ä¸­åŒ…å«SseEmitterå¯¹è±¡å’Œå»ºç«‹è¯¥è¿æ¥æ—¶çš„çº¿ç¨‹åã€‚</li><li>åœ¨å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œéœ€è¦åˆ¤æ–­å½“å‰ä¼šè¯æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”åˆ¤æ–­è¯¥ä¼šè¯æ‰€å±çš„çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶çš„è¯ï¼Œå°±æ¨é€æ¶ˆæ¯ï¼›å¦åˆ™ï¼Œä¸­æ–­çº¿ç¨‹ï¼›è¿™æ ·å°±å¯ä»¥ä¿è¯æ¯ä¸€ä¸ªä¼šè¯åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ¨é€æ¶ˆæ¯ã€‚</li></ol></li></ul></li></ol><p><img src="https://s11.ax1x.com/2024/02/24/pFUyKFP.png" alt=""></p><h1>ä¸€äº›è¡¥å……</h1><ul><li>åç»­å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘åˆå¯¹SseUtilsè¿›è¡Œäº†æ”¹è¿›ï¼Œæœ€ç»ˆç‰ˆæœ¬å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.aimc.paperreduction.common.wrapper.RWrappers;</span><br><span class="line"><span class="keyword">import</span> com.aimc.paperreduction.model.enums.ErrorCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SseUtil</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸ºäº†é¿å…å†…å­˜æ³„éœ²ï¼Œè¿™é‡Œæœ€å¥½è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">DEFAULT_TIME_OUT</span> <span class="operator">=</span> <span class="number">30L</span> * <span class="number">60</span> *  <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">// ä¼šè¯map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, SseEmitterInfo&gt; conversationMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * æ–­å¼€è¿æ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">disconnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="type">SseEmitterInfo</span> <span class="variable">instance</span> <span class="operator">=</span> SseUtil.getInstance(conversationId);</span><br><span class="line">        <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">            instance.getEmitter().complete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å»ºç«‹è¿æ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitter <span class="title function_">getConnect</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º SseEmitterInfo</span></span><br><span class="line">        <span class="type">SseEmitterInfo</span> <span class="variable">sseEmitterInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitterInfo</span>(conversationId);</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">sseEmitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>(DEFAULT_TIME_OUT);</span><br><span class="line">        sseEmitterInfo.setEmitter(sseEmitter);</span><br><span class="line">        <span class="comment">// å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®å‰ç«¯é‡è¯•æ—¶5s</span></span><br><span class="line">            sseEmitter.send(SseEmitter.event().reconnectTime(<span class="number">5_000L</span>).data(JSONObject.toJSONString(RWrappers.Fail(ErrorCodeEnum.SSE_CONNECT_SUCCESS))));</span><br><span class="line">            <span class="comment">// è¿æ¥è¶…æ—¶</span></span><br><span class="line">            sseEmitter.onTimeout(() -&gt; SseUtil.timeout(conversationId));</span><br><span class="line">            <span class="comment">// è¿æ¥æ–­å¼€</span></span><br><span class="line">            sseEmitter.onCompletion(() -&gt; SseUtil.completion(conversationId));</span><br><span class="line">            <span class="comment">// é”™è¯¯</span></span><br><span class="line">            sseEmitter.onError((e) -&gt; SseUtil.error(conversationId, e.getMessage()));</span><br><span class="line">            <span class="comment">// æ·»åŠ sse</span></span><br><span class="line">            conversationMap.put(conversationId, sseEmitterInfo);</span><br><span class="line">            <span class="comment">// è¿æ¥æˆåŠŸ</span></span><br><span class="line">            log.info(<span class="string">&quot;åˆ›å»ºsseè¿æ¥æˆåŠŸ ==&gt; å½“å‰è¿æ¥æ€»æ•°=&#123;&#125;ï¼Œ ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationMap.size(), conversationId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// æ—¥å¿—</span></span><br><span class="line">            log.error(<span class="string">&quot;å‰ç«¯é‡è¿å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> sseEmitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * è·å–æ¶ˆæ¯å®ä¾‹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SseEmitterInfo <span class="title function_">getInstance</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.get(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»™æŒ‡å®šä¼šè¯å‘é€æ¶ˆæ¯ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œè¿”å›false</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jsonMsg        - æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String conversationId, String jsonMsg)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¯¥ä¼šè¯æ˜¯å¦è¿˜åœ¨Mapä¸­ï¼Œä¸å­˜åœ¨åˆ™åˆ é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (!conversationMap.containsKey(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å·²å»ºç«‹è¿æ¥</span></span><br><span class="line">        <span class="keyword">if</span> (SseUtil.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">                SseUtil.getInstance(conversationId).getEmitter().send(jsonMsg, MediaType.APPLICATION_JSON);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// æ—¥å¿—</span></span><br><span class="line">                SseUtil.removeClientId(conversationId);</span><br><span class="line">                log.error(<span class="string">&quot;å‘é€æ¶ˆæ¯å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;</span>, conversationId, e.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœªå»ºç«‹è¿æ¥</span></span><br><span class="line">            log.error(<span class="string">&quot;è¿æ¥ä¸å­˜åœ¨æˆ–è€…è¶…æ—¶ ==&gt; ä¼šè¯Id=&#123;&#125;ä¼šè¯è‡ªåŠ¨å…³é—­&quot;</span>, conversationId);</span><br><span class="line">            SseUtil.removeClientId(conversationId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»é™¤å¹¶æ–­å¼€ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨å­˜åœ¨ä¼šè¯</span></span><br><span class="line">        <span class="keyword">if</span> (!SseUtil.getIsExistClientId(conversationId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ é™¤è¯¥ä¼šè¯</span></span><br><span class="line">        conversationMap.remove(conversationId);</span><br><span class="line">        SseUtil.disconnect(conversationId);</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">         log.info(<span class="string">&quot;ç§»é™¤ä¼šè¯æˆåŠŸ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ˜¯å¦å­˜åœ¨ä¼šè¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId - ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">getIsExistClientId</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> conversationMap.containsKey(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å½“å‰è¿æ¥æ€»æ•°</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - è¿æ¥æ€»æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getConnectTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;å½“å‰è¿æ¥æ•°ï¼š&#123;&#125;&quot;</span>, conversationMap.size());</span><br><span class="line">        <span class="keyword">return</span> conversationMap.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¶…æ—¶</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">timeout</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.error(<span class="string">&quot;sseè¿æ¥è¶…æ—¶ ==&gt; ä¼šè¯Id=&#123;&#125;&quot;</span>, conversationId);</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtil.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®Œæˆ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">completion</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line">        log.info(<span class="string">&quot;sseè¿æ¥å·²æ–­å¼€ ==&gt; ä¼šè¯Idï¼š&#123;&#125;ï¼Œå½“å‰å‰©ä½™è¿æ¥æ•°ï¼š&#123;&#125;&quot;</span>, conversationId, conversationMap.size());</span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtil.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”™è¯¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conversationId String ä¼šè¯Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(String conversationId, String message)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—</span></span><br><span class="line"><span class="comment">//        log.error(&quot;sseæœåŠ¡å¼‚å¸¸ ==&gt; ä¼šè¯Id=&#123;&#125;, å¼‚å¸¸ä¿¡æ¯=&#123;&#125;&quot;, conversationId, message);</span></span><br><span class="line">        <span class="comment">// ç§»é™¤ä¼šè¯</span></span><br><span class="line">        SseUtil.removeClientId(conversationId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SseEmitterInfo</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> SseEmitter emitter;</span><br><span class="line">        <span class="keyword">private</span> String threadName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SseEmitterInfo</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.emitter = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">this</span>.threadName = Thread.currentThread().getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> SseEmitter <span class="title function_">getEmitter</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> emitter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmitter</span><span class="params">(SseEmitter emitter)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.emitter = emitter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getThreadName</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> threadName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setThreadName</span><span class="params">(String threadName)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.threadName = threadName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å®é™…ä½¿ç”¨å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/connSse&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SseEmitter <span class="title function_">connSse</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">    <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> SseUtil.getConnect(conversationId);</span><br><span class="line">    executor.execute(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œéœ€è¦ä¿è¯åŒä¸€ä¸ªä¼šè¯IDåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¤„ç†</span></span><br><span class="line">        SseUtil.getInstance(conversationId).setThreadName(Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">while</span> (!Thread.interrupted() &amp;&amp; SseUtil.getInstance(conversationId) != <span class="literal">null</span> &amp;&amp; SseUtil.getInstance(conversationId).getThreadName().equals(Thread.currentThread().getName())) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">sendSuccess</span> <span class="operator">=</span> SseUtil.sendMessage(conversationId, JSONObject.toJSONString(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">10</span>]));</span><br><span class="line">            log.info(<span class="string">&quot;å‘ä¼šè¯ï¼š&#123;&#125;ï¼Œæ¨é€&quot;</span>, conversationId);</span><br><span class="line">            <span class="keyword">if</span> (!sendSuccess) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;=========è¿æ¥ä¸å­˜åœ¨ï¼ŒæœåŠ¡ç«¯ä¸»åŠ¨å…³é—­SSEè¿æ¥=========&quot;</span>);</span><br><span class="line">                SseUtil.removeClientId(conversationId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ¯ä¸€ç§’æ¨é€ä¸€æ¬¡æ•°æ®</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”±äºæˆ‘è¿™é‡Œçš„ä¸šåŠ¡é™åˆ¶ï¼Œåªèƒ½è¿™ä¹ˆç”¨SSEã€‚åŸæœ‰çš„ä¸šåŠ¡é€»è¾‘æ˜¯ï¼Œæˆ‘è½®è¯¢ç®—æ³•æ¥å£ï¼Œæ›´æ–°æ•°æ®ï¼Œç„¶åå‰ç«¯è½®è¯¢æˆ‘çš„æ¥å£ï¼Œæ›´æ–°é¡µé¢çŠ¶æ€ã€‚ä½¿ç”¨äº†SSEä¹‹åå˜æˆäº†ï¼Œæˆ‘è½®è¯¢ç®—æ³•æ¥å£ï¼Œæ›´æ–°æ•°æ®ï¼Œç„¶åå‘å‰ç«¯æ¨é€æ•°æ®ã€‚</li><li>ä½†æ˜¯æ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯ï¼Œæˆ‘è¿™è¾¹ç»™ç®—æ³•æä¾›ä¸€ä¸ªå›è°ƒçš„æ¥å£ï¼Œå½“ç®—æ³•æœ‰è¿›åº¦æ›´æ–°æ—¶ï¼Œè°ƒç”¨æˆ‘è¿™ä¸ªå›è°ƒæ¥å£ï¼Œç„¶åæˆ‘åœ¨è¿™ä¸ªå›è°ƒé€»è¾‘é‡Œå‘å‰ç«¯æ¨é€æ•°æ®ï¼Œè¿™æ ·é€»è¾‘ä¸Šå…¶å®æ˜¯æ›´é¡ºçš„ï¼Œåç»­æœ‰æ—¶é—´ï¼Œæ‰“ç®—å’Œç®—æ³•ä¾§èŠèŠè¿™å—ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚</li></ul>]]></content>
    
    
    <summary type="html">Server-Sent Events æœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼Œç®€ç§° SSEï¼Œæ˜¯ä¸€ç§æœåŠ¡ç«¯å®æ—¶ä¸»åŠ¨å‘æµè§ˆå™¨æ¨é€æ¶ˆæ¯çš„æŠ€æœ¯ã€‚</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SSE" scheme="https://cyborg2077.github.io/tags/SSE/"/>
    
  </entry>
  
  <entry>
    <title>Redissonå»¶è¿Ÿé˜Ÿåˆ—å®ç°å€’è®¡æ—¶ä»»åŠ¡</title>
    <link href="https://cyborg2077.github.io/2023/10/28/RDelayedQueue/"/>
    <id>https://cyborg2077.github.io/2023/10/28/RDelayedQueue/</id>
    <published>2023-10-28T12:14:25.000Z</published>
    <updated>2023-10-28T14:37:26.471Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜èƒŒæ™¯">é—®é¢˜èƒŒæ™¯</h2><ul><li>é¡¹ç›®é‡Œåˆšå¥½éœ€è¦å®ç°ä¸€ä¸ªå»¶è¿Ÿè®¢å•å–æ¶ˆä»»åŠ¡ã€‚å…·ä½“è€Œè¨€ï¼Œå¦‚æœä¸€ä»½è®¢å•åœ¨ç”Ÿæˆåçš„15åˆ†é’Ÿå†…æœªå®Œæˆæ”¯ä»˜ï¼Œç³»ç»Ÿéœ€è¦è‡ªåŠ¨å–æ¶ˆè¯¥è®¢å•ï¼Œå¹¶è¿”è¿˜ç›¸å…³è®¢å•æ‰€ä½¿ç”¨çš„ä¼˜æƒ åˆ¸æˆ–å…è´¹é¢åº¦ç­‰èµ„æºã€‚</li><li>è™½ç„¶å¼•å…¥MQæˆ–è€…Kafkaä¹Ÿæ˜¯ä¸€ç§è§£å†³æ–¹æ³•ï¼Œä½†å‡ºäºæœ€å¤§ç¨‹åº¦å‡å°‘ç³»ç»Ÿå¤æ‚æ€§çš„è§’åº¦è€ƒè™‘ï¼Œå¼ºçƒˆå»ºè®®å……åˆ†åˆ©ç”¨å·²æœ‰çš„Redisç»„ä»¶ï¼ˆä¾‹å¦‚Redissonï¼‰æ¥è§£å†³è¿™ä¸€é—®é¢˜ï¼Œè€Œä¸å¼•å…¥æ–°ç»„ä»¶ã€‚è¿™æ ·å¯ä»¥æé«˜æ•ˆç‡ã€å‡å°‘ç»´æŠ¤è´Ÿæ‹…ï¼Œå¹¶ç¡®ä¿å……åˆ†å‘æŒ¥å·²æœ‰æŠ€æœ¯çš„æ½œåŠ›ã€‚</li></ul><h2 id="å»¶è¿Ÿé˜Ÿåˆ—">å»¶è¿Ÿé˜Ÿåˆ—</h2><ul><li>Redissonä¸­å®šä¹‰äº†åˆ†å¸ƒå¼å»¶è¿Ÿé˜Ÿåˆ—RDelayedQueueï¼Œæ˜¯ä¸€ç§åŸºäºzsetç»“æ„å®ç°çš„å»¶æ—¶é˜Ÿåˆ—ï¼Œï¼Œå®ƒå…è®¸ä»¥æŒ‡å®šçš„å»¶è¿Ÿæ—¶é•¿ï¼Œå°†ä»»åŠ¡æ”¾åˆ°ç›®æ ‡é˜Ÿåˆ—ä¸­ã€‚</li><li>å…¶å®å°±æ˜¯åœ¨zsetçš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ªåŸºäºå†…å­˜çš„å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå½“æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªæ•°æ®åˆ°å»¶è¿Ÿé˜Ÿåˆ—çš„æ—¶å€™ï¼ŒRedissionä¼šæŠŠæ•°æ®å’Œè¶…æ—¶æ—¶é—´æ”¾åˆ°zsetä¸­ï¼Œå¹¶ä¸”èµ·ä¸€ä¸ªå»¶æ—¶ä»»åŠ¡ï¼Œå½“ä»»åŠ¡åˆ°æœŸæ—¶ï¼Œå†å»zsetä¸­æŠŠæ•°æ®å–å‡ºæ¥ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ä½¿ç”¨ã€‚</li></ul><h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2><ul><li>å…¶å®è¿™é‡Œçš„å®ç°å’Œæˆ‘ä¹‹å‰å†™çš„æ¶ˆæ¯é˜Ÿåˆ—å·®ä¸å¤šï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹æˆ‘å‰é¢é‚£ç¯‡æ–‡</li></ul><div class="tag link"><a class="link-card" title="æ‰‹å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—" href="https://cyborg2077.github.io/2023/10/03/DIYTaskQueue/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">æ‰‹å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</p><p class="url">https://cyborg2077.github.io/2023/10/03/DIYTaskQueue/</p></div></a></div><ol><li>å¯¼å…¥ä¾èµ–</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>ç¼–å†™é…ç½®ç±»</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String REDIS_HOST;  <span class="comment">//åœ°å€é…ç½®åœ¨é…ç½®æ–‡ä»¶ä¸Š</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String REDIS_PORT;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String REDIS_PASSWORD;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">createRedisAPi</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">redissonConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        redissonConfig.setCodec(<span class="keyword">new</span> <span class="title class_">org</span>.redisson.client.codec.StringCodec());</span><br><span class="line">        <span class="comment">//æˆ‘è¿™é‡Œå•èŠ‚ç‚¹æ¼”ç¤ºä¸€ä¸‹</span></span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">singleServerConfig</span> <span class="operator">=</span> redissonConfig.useSingleServer();</span><br><span class="line">        singleServerConfig.setAddress(String.format(<span class="string">&quot;redis://%s:%s&quot;</span>, REDIS_HOST, REDIS_PORT));</span><br><span class="line">        singleServerConfig.setPassword(REDIS_PASSWORD);</span><br><span class="line">        <span class="comment">//è®¾ç½®å‡ å·æ•°æ®åº“</span></span><br><span class="line">        singleServerConfig.setDatabase(<span class="number">0</span>);</span><br><span class="line">        singleServerConfig.setConnectTimeout(<span class="number">10000</span>);</span><br><span class="line">        singleServerConfig.setConnectionPoolSize(<span class="number">300</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(redissonConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>å»¶è¿Ÿé˜Ÿåˆ—æ‰§è¡Œå™¨</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayTaskQueueExecutor</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> RBlockingQueue&lt;T&gt; queue;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Thread msgLooper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DelayTaskQueueExecutor.Processor&lt;T&gt; processor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Processor</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(T task)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DelayTaskQueueExecutor</span><span class="params">(String threadName, RBlockingQueue&lt;T&gt; queue, DelayTaskQueueExecutor.Processor&lt;T&gt; processor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.queue = queue;</span><br><span class="line">        <span class="built_in">this</span>.processor = processor;</span><br><span class="line">        <span class="built_in">this</span>.msgLooper = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>::looper);</span><br><span class="line">        <span class="built_in">this</span>.msgLooper.setName(threadName);</span><br><span class="line">        <span class="built_in">this</span>.msgLooper.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">looper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">task</span> <span class="operator">=</span> queue.take();</span><br><span class="line">                processor.process(task);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(String.format(<span class="string">&quot;TaskQueueExecutor %s run task exception&quot;</span>,</span><br><span class="line">                        <span class="built_in">this</span>.msgLooper.getName()), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>æœåŠ¡ç±»</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayQueueService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoMapper userInfoMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BonusInfoMapper bonusInfoMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redisson;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RDelayedQueue&lt;String&gt; delayedQueue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initDelayQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        RBlockingQueue&lt;String&gt; blockingQueue = redisson.getBlockingQueue(<span class="string">&quot;orderDelayQueue&quot;</span>);</span><br><span class="line">        delayedQueue = redisson.getDelayedQueue(blockingQueue);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DelayTaskQueueExecutor</span>&lt;&gt;(<span class="string">&quot;ORDER_DELAY&quot;</span>, blockingQueue, <span class="built_in">this</span>::processOrder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†è®¢å•ä¿¡æ¯åŠ å…¥åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­ï¼Œå¹¶è®¾ç½®TTL</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderId è®¢å•ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addToDelayQueue</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">        delayedQueue.offer(orderId, <span class="number">2</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">        <span class="type">Torder</span> <span class="variable">order</span> <span class="operator">=</span> orderMapper.selectOne(Wrappers.lambdaQuery(Torder.class).eq(Torder::getOrderId, orderId));</span><br><span class="line">        <span class="keyword">if</span> (order != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> order.getStatus();</span><br><span class="line">            <span class="comment">// å¦‚æœè®¢å•ä»ç„¶æ˜¯æœªæ”¯ä»˜çŠ¶æ€ï¼Œå¹¶ä¸”å­—æ•°å·²ç»é¢„æ‰£äº†ï¼Œåˆ™è¿”è¿˜é¢„æ‰£çš„å­—æ•°ï¼Œå¹¶ä¸”å…³é—­è®¢å•</span></span><br><span class="line">            <span class="keyword">if</span> (status == Common.ORDER_ORIGINAL_STATUS) &#123;</span><br><span class="line">                order.setStatus(Common.ORDER_CLOSED_STATUS);</span><br><span class="line">                <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> order.getToken();</span><br><span class="line">                <span class="comment">// æŸ¥è¯¢æ˜¯å¦æ˜¯ç™»å½•ç”¨æˆ·</span></span><br><span class="line">                <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userInfoMapper.selectOneForUpdate(userId);</span><br><span class="line">                <span class="keyword">if</span> (userInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">UsedWordsBonusInfo</span> <span class="variable">wordsBonusInfo</span> <span class="operator">=</span> usedWordsBonusInfoMapper.selectOne(Wrappers.lambdaQuery(UsedWordsBonusInfo.class).eq(UsedWordsBonusInfo::getOrderId, order.getOrderId()));</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»é¢„æ‰£äº†</span></span><br><span class="line">                    <span class="keyword">if</span> (wordsBonusInfo.getSelfWordsDeducted() == Common.ALREADY_DEDUCTION) &#123;</span><br><span class="line">                        userInfo.setRegisterBonusWords(userInfo.getRegisterBonusWords() + wordsBonusInfo.getUsedRegisterBonus());</span><br><span class="line">                        userInfo.setInviteBonusWords(userInfo.getInviteBonusWords() + wordsBonusInfo.getUsedInviteBonus());</span><br><span class="line">                        log.info(<span class="string">&quot;è®¢å•ï¼š&#123;&#125;ï¼Œè¿”è¿˜æ³¨å†Œå­—æ•°ï¼š&#123;&#125;ï¼Œé‚€è¯·å­—æ•°ï¼š&#123;&#125;&quot;</span>, orderId, wordsBonusInfo.getUsedRegisterBonus(), wordsBonusInfo.getUsedInviteBonus());</span><br><span class="line">                        wordsBonusInfo.setSelfWordsDeducted(Common.ORIGIN_STATUS);</span><br><span class="line">                        usedWordsBonusInfoMapper.updateById(wordsBonusInfo);</span><br><span class="line">                        userInfoMapper.updateById(userInfo);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            orderMapper.updateById(order);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>ä½¿ç”¨æ–¹æ³•ï¼Œåˆ›å»ºè®¢å•çš„æ—¶å€™å°†è®¢å•å·åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œåˆ°æœŸåä¼šè‡ªåŠ¨æ‰§è¡Œå…³é—­è®¢å•çš„å¯¹åº”é€»è¾‘</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delayQueueService.addToDelayQueue(orderId);</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h2><ul><li>ç»†å¿ƒçš„åŒå­¦å¯èƒ½æ³¨æ„åˆ°äº†æˆ‘è¿™é‡Œçš„äº‹åŠ¡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">      <span class="type">Torder</span> <span class="variable">order</span> <span class="operator">=</span> orderMapper.selectOne(Wrappers.lambdaQuery(Torder.class).eq(Torder::getOrderId, orderId));</span><br><span class="line">      <span class="keyword">if</span> (order != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> order.getStatus();</span><br><span class="line">          <span class="comment">// å¦‚æœè®¢å•ä»ç„¶æ˜¯æœªæ”¯ä»˜çŠ¶æ€ï¼Œå¹¶ä¸”å­—æ•°å·²ç»é¢„æ‰£äº†ï¼Œåˆ™è¿”è¿˜é¢„æ‰£çš„å­—æ•°ï¼Œå¹¶ä¸”å…³é—­è®¢å•</span></span><br><span class="line">          <span class="keyword">if</span> (status == Common.ORDER_ORIGINAL_STATUS) &#123;</span><br><span class="line">              order.setStatus(Common.ORDER_CLOSED_STATUS);</span><br><span class="line">              <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> order.getToken();</span><br><span class="line">              <span class="comment">// æŸ¥è¯¢æ˜¯å¦æ˜¯ç™»å½•ç”¨æˆ·</span></span><br><span class="line">              <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userInfoMapper.selectOneForUpdate(userId);</span><br><span class="line">              <span class="keyword">if</span> (userInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                  <span class="type">UsedWordsBonusInfo</span> <span class="variable">wordsBonusInfo</span> <span class="operator">=</span> usedWordsBonusInfoMapper.selectOne(Wrappers.lambdaQuery(UsedWordsBonusInfo.class).eq(UsedWordsBonusInfo::getOrderId, order.getOrderId()));</span><br><span class="line">                  <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»é¢„æ‰£äº†</span></span><br><span class="line">                  <span class="keyword">if</span> (wordsBonusInfo.getSelfWordsDeducted() == Common.ALREADY_DEDUCTION) &#123;</span><br><span class="line">                      userInfo.setRegisterBonusWords(userInfo.getRegisterBonusWords() + wordsBonusInfo.getUsedRegisterBonus());</span><br><span class="line">                      userInfo.setInviteBonusWords(userInfo.getInviteBonusWords() + wordsBonusInfo.getUsedInviteBonus());</span><br><span class="line">                      log.info(<span class="string">&quot;è®¢å•ï¼š&#123;&#125;ï¼Œè¿”è¿˜æ³¨å†Œå­—æ•°ï¼š&#123;&#125;ï¼Œé‚€è¯·å­—æ•°ï¼š&#123;&#125;&quot;</span>, orderId, wordsBonusInfo.getUsedRegisterBonus(), wordsBonusInfo.getUsedInviteBonus());</span><br><span class="line">                      wordsBonusInfo.setSelfWordsDeducted(Common.ORIGIN_STATUS);</span><br><span class="line">                      usedWordsBonusInfoMapper.updateById(wordsBonusInfo);</span><br><span class="line">                      userInfoMapper.updateById(userInfo);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          orderMapper.updateById(order);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>é‡ç‚¹æ˜¯æˆ‘è¿™é‡Œçš„<code>userInfoMapper.selectOneForUpdate(userId);</code>ï¼Œè¿™å¥å…¶å®æ˜¯æˆ‘æ‰‹å†™çš„ä¸€ä¸ªSQLï¼Œ<code>SELECT XXX FROM user WHERE userId = xxx FOR UPDATE</code>ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ‰‹åŠ¨è§¦å‘è¡Œé”ã€‚è¿™é‡Œæ˜¯ä½¿ç”¨çš„é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå¯é‡å¤è¯»ã€‚å› ä¸ºäº‹åŠ¡é‡Œçš„è¯»æ“ä½œé»˜è®¤æ˜¯ä¸ä¼šè§¦å‘è¡Œé”çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯èƒ½ä¼šå‡ºç°å¦ä¸€ä¸ªäº‹åŠ¡å°†ç”¨æˆ·ä¿¡æ¯æ”¹äº†ï¼Œå¹¶ä¸”æäº¤äº†ï¼Œç”±äºå¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå½“å‰äº‹åŠ¡ä¸­è¯»å–åˆ°çš„ä»æ˜¯ä¿®æ”¹å‰çš„æ•°æ®ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°±ä¼šå°†å¦ä¸€ä¸ªäº‹åŠ¡çš„æäº¤ç»“æœè¦†ç›–æ‰ï¼Œå¦‚æœè¿™é‡Œä¸è§¦å‘è¡Œé”ï¼Œä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚</li><li>åŠ äº†è¡Œé”ä¹‹åï¼Œå¯ä»¥ç¡®ä¿åªæœ‰ä¸€ä¸ªä¼šè¯å¯ä»¥è®¿é—®è¯¥è®¢å•æ•°æ®ï¼Œä»è€Œé¿å…å¹¶å‘é—®é¢˜ã€‚ä½†æ˜¯ä¹Ÿä¸æ˜¯æ‰€æœ‰åœ¨äº‹åŠ¡é‡Œçš„è¯»æ“ä½œéƒ½è¦åŠ è¡Œé”ï¼Œæ¯•ç«Ÿé‚£æ ·çš„æ‰§è¡Œæ•ˆç‡å°±å¤ªæ…¢äº†ï¼Œåªæœ‰æ¶‰åŠåˆ°è¯»å–ä¿¡æ¯ï¼Œå¹¶ä¸”åç»­éœ€è¦å¯¹è¯¥ä¿¡æ¯è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œæ‰åŠ ä¸Šè¡Œé”ã€‚</li></ul>]]></content>
    
    
    <summary type="html">é¡¹ç›®é‡Œæœ‰ä¸ªåœºæ™¯éœ€è¦åšå»¶è¿Ÿä»»åŠ¡</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="Redis" scheme="https://cyborg2077.github.io/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>æ‰‹å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</title>
    <link href="https://cyborg2077.github.io/2023/10/03/DIYTaskQueue/"/>
    <id>https://cyborg2077.github.io/2023/10/03/DIYTaskQueue/</id>
    <published>2023-10-03T15:30:34.000Z</published>
    <updated>2023-10-05T03:02:31.588Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><ul><li>æœ¬æ–‡æ¶‰åŠåˆ°äº†å¤§é‡JDK 8çš„æ–°ç‰¹æ€§ï¼Œå¯¹è¿™éƒ¨åˆ†ä¸å¤ªäº†è§£çš„ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„è¿™ç¯‡æ–‡ç« </li></ul><div class="tag link"><a class="link-card" title="Java8 æ–°ç‰¹æ€§" href="https://cyborg2077.github.io/2022/11/05/NewFeaturesOfJava8/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">Java8 æ–°ç‰¹æ€§</p><p class="url">https://cyborg2077.github.io/2022/11/05/NewFeaturesOfJava8/</p></div></a></div><h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><ul><li>é¡¹ç›®é‡ŒåŸæœ¬æ˜¯ä½¿ç”¨Kafkaå½“æ¶ˆæ¯é˜Ÿåˆ—çš„ï¼Œä½†æ˜¯ç»„å†…å¤§å¸ˆè§‰å¾—Kafkaå¤ªé‡äº†ï¼Œåªè¦ç¡®ä¿è®¢å•ä¿¡æ¯éƒ½æŒä¹…åŒ–åˆ°æ•°æ®åº“é‡Œï¼Œæ¯æ¬¡é‡å¯çš„æ—¶å€™é‡æ–°åŠ è½½ä»»åŠ¡ï¼Œé‚£ä¹ˆå…¶å®æ˜¯å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ¥æ›¿ä»£Kafkaçš„</li></ul><div class="tabs" id="æ¶ˆæ¯é˜Ÿåˆ—"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#æ¶ˆæ¯é˜Ÿåˆ—-1">ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨</button></li><li class="tab"><button type="button" data-href="#æ¶ˆæ¯é˜Ÿåˆ—-2">QueueService</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="æ¶ˆæ¯é˜Ÿåˆ—-1"><ul><li>ä¸‹é¢æ˜¯æˆ‘è‡ªå·±å†™çš„ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ï¼Œä½¿ç”¨äº†<code>ArrayBlockingQueue</code>æ¥å­˜å‚¨ä»»åŠ¡ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚å¹¶ä¸”å…è®¸æŒ‡å®šå¤„ç†ä»»åŠ¡çš„å¤„ç†å™¨ï¼ˆProcessorï¼‰ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</li><li>å…³äºTaskQueueExecutorçš„æ„é€ å‡½æ•°ï¼Œæˆ‘è¿™é‡Œè‡ªå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œä½†æ˜¯å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥ç”¨Javaå†…ç½®çš„å‡½æ•°å¼æ¥å£ï¼šFunctionï¼Œå†™æ³•ç±»ä¼¼äº<code>public TaskQueueExecutor(String threadName, int queueSize, Function&lt;T, R&gt; processor) {}</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskQueueExecutor</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// ä¸ºè®°å½•æ¶ˆæ¯å’Œé”™è¯¯ä¿¡æ¯å®šä¹‰ä¸€ä¸ªæ—¥å¿—è®°å½•å™¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºå­˜å‚¨ç±»å‹ä¸ºTçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayBlockingQueue&lt;T&gt; queue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºå¤„ç†ä»»åŠ¡çš„ç‹¬ç«‹çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Thread msgLooper;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºå¤„ç†ä»»åŠ¡çš„å¤„ç†å™¨æ¥å£</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Processor&lt;T&gt; processor;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºè·Ÿè¸ªé˜Ÿåˆ—ä¸­ä»»åŠ¡çš„æ•°é‡çš„AtomicIntegeræ˜¯åŸå­æ•´æ•°ç±»å‹ï¼Œå¯ä»¥é¿å…å¹¶å‘ç¯å¢ƒä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger taskNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªå¤„ç†ä»»åŠ¡çš„æ¥å£</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Processor</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(T task)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°ç”¨äºåˆå§‹åŒ–TaskQueueExecutor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TaskQueueExecutor</span><span class="params">(String threadName, <span class="type">int</span> queueSize, Processor&lt;T&gt; processor)</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ç»™å®šçš„å¤§å°åˆå§‹åŒ–é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="built_in">this</span>.queue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;T&gt;(queueSize);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å­˜å‚¨ç”¨äºå¤„ç†ä»»åŠ¡çš„å¤„ç†å™¨</span></span><br><span class="line">        <span class="built_in">this</span>.processor = processor;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ç”¨äºæ¶ˆæ¯å¤„ç†</span></span><br><span class="line">        <span class="built_in">this</span>.msgLooper = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>::looper);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¾ç½®çº¿ç¨‹åç§°ï¼Œæˆ‘è¿™é‡Œæ˜¯æ ¹æ®ä¸šåŠ¡åç§°æ¥è®¾ç½®çš„ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜ä¼šæ¯”è¾ƒæ–¹ä¾¿</span></span><br><span class="line">        <span class="built_in">this</span>.msgLooper.setName(threadName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯åŠ¨æ¶ˆæ¯å¤„ç†çº¿ç¨‹</span></span><br><span class="line">        <span class="built_in">this</span>.msgLooper.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–taskNum</span></span><br><span class="line">        taskNum = <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•ç”¨äºå°†æ¶ˆæ¯ï¼ˆä»»åŠ¡ï¼‰å‘é€åˆ°é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(T task)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—</span></span><br><span class="line">            <span class="built_in">this</span>.queue.put(task);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¢åŠ ä»»åŠ¡è®¡æ•°</span></span><br><span class="line">            taskNum.incrementAndGet();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•ç”¨äºè·å–é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTaskNum</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taskNum.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸»è¦çš„æ¶ˆæ¯å¤„ç†å¾ªç¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">looper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼ˆå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡ï¼‰</span></span><br><span class="line">                <span class="type">T</span> <span class="variable">task</span> <span class="operator">=</span> queue.take();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// ä½¿ç”¨æä¾›çš„å¤„ç†å™¨å¤„ç†ä»»åŠ¡</span></span><br><span class="line">                processor.process(task);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™ä¸­æ–­å¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// å¤„ç†ä»»åŠ¡å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°çš„ä»»ä½•å¼‚å¸¸</span></span><br><span class="line">                log.error(String.format(<span class="string">&quot;TaskQueueExecutor %s run task exception&quot;</span>,</span><br><span class="line">                        <span class="built_in">this</span>.msgLooper.getName()), e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// å³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿä¼šåœ¨finallyå—ä¸­å‡å°‘ä»»åŠ¡è®¡æ•°</span></span><br><span class="line">                taskNum.decrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æ¶ˆæ¯é˜Ÿåˆ—-2"><ul><li><code>QueueService</code>ï¼šæ˜¯ç”¨äºç®¡ç†ä¸åŒç±»å‹çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚<del>ï¼ˆæˆ‘è¿™é‡Œç›®å‰å°±ä¿©ä»»åŠ¡é˜Ÿåˆ—ï¼‰</del></li><li><code>@PostConstruct init()</code>ï¼šä½¿ç”¨æ³¨è§£æ¥æ ‡è®°åˆå§‹åŒ–æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ç±»å®ä¾‹åŒ–åè‡ªåŠ¨è°ƒç”¨ï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–äº†ä¸¤ä¸ª<code>ArrayList</code>ï¼Œåˆ†åˆ«ç”¨äºå­˜å‚¨ä¸åŒç±»å‹çš„ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ï¼ŒåŒæ—¶å¯ä»¥é€šè¿‡é…ç½®é¡¹æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä»æ•°æ®åº“åŠ è½½æœªå®Œæˆä»»åŠ¡ã€‚</li><li><code>sendMessage()</code>ï¼šç”¨äºå°†è®¢å•æ·»åŠ åˆ°é€‚å½“çš„é˜Ÿåˆ—æ‰§è¡Œå™¨ï¼Œæ ¹æ®è®¢å•çš„ç±»å‹é€‰æ‹©åˆé€‚çš„æ‰§è¡Œå™¨åˆ—è¡¨ï¼Œè®¡ç®—ä»»åŠ¡æœ€å°‘çš„åˆ†åŒºå¹¶æ·»åŠ è®¢å•ã€‚</li><li><code>getQueueSize()</code>: ç”¨äºè·å–ç‰¹å®šè®¢å•çš„é˜Ÿåˆ—å¤§å°ï¼Œæ ¹æ®è®¢å•ç±»å‹é€‰æ‹©ç›¸åº”çš„é˜Ÿåˆ—æ‰§è¡Œå™¨åˆ—è¡¨å¹¶è¿”å›é˜Ÿåˆ—å¤§å°ã€‚</li><li><code>getTaskQueueExecutors()</code>ï¼šæ ¹æ®è®¢å•ç±»å‹è¿”å›ç›¸åº”çš„ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼•å…¥ä¾èµ–çš„æœåŠ¡å’Œç»„ä»¶</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ThirdManager thirdManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> QueueConfig queueConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderConsumerService orderConsumerService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸¤ä¸ªArrayListï¼Œç”¨äºå­˜å‚¨ä¸åŒç±»å‹çš„ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ï¼Œè¿™é‡Œå¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡éœ€æ±‚æ¥å®šä¹‰å¤šä¸ªã€‚</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;TaskQueueExecutor&lt;Torder&gt;&gt; paperTaskExecutors;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;TaskQueueExecutor&lt;Torder&gt;&gt; textTaskExecutors;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ–¹æ³•ï¼Œåœ¨ç±»å®ä¾‹åŒ–åè‡ªåŠ¨è°ƒç”¨ï¼Œåˆ›å»ºä¿¡æ¯ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–ã€‚</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åŠ è½½é…ç½®ï¼Œè®¾ç½®é˜Ÿåˆ—å¤§å°å’Œå¤„ç†å™¨</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> <span class="number">0</span>; idx &lt; queueConfig.getPaperTopicPartitionsNum(); idx++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> idx;</span><br><span class="line">            paperTaskExecutors.add(<span class="keyword">new</span> <span class="title class_">TaskQueueExecutor</span>&lt;&gt;(</span><br><span class="line">                String.format(<span class="string">&quot;%s-%d&quot;</span>, queueConfig.getPaperTopic(), partition),</span><br><span class="line">                <span class="number">1000</span>,</span><br><span class="line">                torder -&gt; &#123;</span><br><span class="line">                    orderConsumerService.paperConsumeMessage(torder, partition);</span><br><span class="line">                &#125;</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ è½½é…ç½®ï¼Œè®¾ç½®é˜Ÿåˆ—å¤§å°å’Œå¤„ç†å™¨</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> <span class="number">0</span>; idx &lt; queueConfig.getTextTopicPartitionsNum(); idx++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> idx;</span><br><span class="line">            textTaskExecutors.add(<span class="keyword">new</span> <span class="title class_">TaskQueueExecutor</span>&lt;&gt;(</span><br><span class="line">                String.format(<span class="string">&quot;%s-%d&quot;</span>, queueConfig.getTextTopic(), partition),</span><br><span class="line">                <span class="number">1000</span>,</span><br><span class="line">                torder -&gt; &#123;</span><br><span class="line">                    orderConsumerService.textConsumeMessage(torder, partition);</span><br><span class="line">                &#125;</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¯æ¬¡é‡å¯çš„æ—¶å€™ï¼Œä»æ•°æ®åº“åŠ è½½æœªå®Œæˆè®¢å•ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹é…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒåŠ è½½æœªå®Œæˆä»»åŠ¡ï¼Œå¼€å‘ç¯å¢ƒä¸åŠ è½½</span></span><br><span class="line">        <span class="keyword">if</span> (queueConfig.isNeedLoadFromDB()) &#123;</span><br><span class="line">            <span class="comment">// æŸ¥è¯¢æ•°æ®åº“ä¸­æœªå¤„ç†çš„è®¢å•ã€‚</span></span><br><span class="line">            List&lt;Torder&gt; orders = orderMapper.selectList(Wrappers.lambdaQuery(Torder.class).eq(Torder::getStatus, <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">for</span> (Torder torder : orders) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;æ·»åŠ æœªå¤„ç†è®¢å•ï¼š&#123;&#125;&quot;</span>, torder);</span><br><span class="line">                <span class="comment">// å°†è¿™äº›è®¢å•æ·»åŠ åˆ°é€‚å½“çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»¥ä¾¿åç»­å¤„ç†ã€‚</span></span><br><span class="line">                sendMessage(torder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºå°†è®¢å•æ¶ˆæ¯å‘é€åˆ°é€‚å½“çš„é˜Ÿåˆ—æ‰§è¡Œå™¨ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(Torder torder)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">executorOptional</span> <span class="operator">=</span> getTaskQueueExecutors(torder);</span><br><span class="line">        executorOptional.ifPresent(executors -&gt; &#123;</span><br><span class="line">            <span class="comment">// streamæ“ä½œï¼Œç”¨äºå¯»æ‰¾ä»»åŠ¡æ•°æœ€å°‘çš„é˜Ÿåˆ—ï¼Œé»˜è®¤å€¼ä¸º0</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> IntStream.range(<span class="number">0</span>, executors.size())</span><br><span class="line">                    .reduce((i, j) -&gt; executors.get(i).getTaskNum() &gt; executors.get(j).getTaskNum() ? j : i)</span><br><span class="line">                    .orElse(<span class="number">0</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">taskNum</span> <span class="operator">=</span> executors.get(partition).getTaskNum();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¿™é‡Œæ˜¯æˆ‘çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">            torder.setZone(partition);</span><br><span class="line">            orderMapper.updateById(torder);</span><br><span class="line">            log.info(<span class="string">&quot;å½“å‰æ¶ˆæ¯å…¥é˜Ÿåˆ—ï¼Œæ‰€åœ¨åˆ†åŒº&#123;&#125;, å½“å‰è®¢å•å·ä¸º&#123;&#125;, å‰é¢è¿˜æœ‰&#123;&#125;äººåœ¨æ’é˜Ÿ&quot;</span>,</span><br><span class="line">                    partition, torder.getOrderId(), executors.get(partition).getTaskNum());</span><br><span class="line">            <span class="keyword">if</span> (taskNum &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                thirdManager.sendExceptionToFeiShu(<span class="string">&quot;æŠ¥å‘Šé™é‡ï¼Œåˆ†åŒºï¼šã€&quot;</span> + partition + <span class="string">&quot;ã€‘å½“å‰æ’é˜Ÿäººæ•°å·²è¾¾ï¼šã€&quot;</span> + taskNum + <span class="string">&quot;ã€‘äººæ¬¡&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ è®¢å•åˆ°é€‰å®šçš„é˜Ÿåˆ—æ‰§è¡Œå™¨ã€‚</span></span><br><span class="line">            executors.get(partition).sendMessage(torder);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•ç”¨äºè·å–ç‰¹å®šè®¢å•çš„é˜Ÿåˆ—å¤§å°ï¼ˆå³é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†çš„è®¢å•æ•°é‡ï¼‰ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getQueueSize</span><span class="params">(Torder torder)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">executorOptional</span> <span class="operator">=</span> getTaskQueueExecutors(torder);</span><br><span class="line">        <span class="keyword">return</span> executorOptional.map(taskQueueExecutors -&gt;</span><br><span class="line">                        taskQueueExecutors.get(torder.getZone()).getTaskNum())</span><br><span class="line">                .orElse(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•ç”¨äºæ ¹æ®è®¢å•ç±»å‹è·å–ç›¸åº”çš„ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨åˆ—è¡¨ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> Optional&lt;ArrayList&lt;TaskQueueExecutor&lt;Torder&gt;&gt;&gt; <span class="title function_">getTaskQueueExecutors</span><span class="params">(Torder torder)</span> &#123;</span><br><span class="line">        ArrayList&lt;TaskQueueExecutor&lt;Torder&gt;&gt; executors;</span><br><span class="line">        <span class="keyword">if</span> (torder.getPolishType().equals(Common.POLISH_TYPE_WITH_PAPER)) &#123;</span><br><span class="line">            executors = paperTaskExecutors;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (torder.getPolishType().equals(Common.POLISH_TYPE_WITH_TEXT)) &#123;</span><br><span class="line">            executors = textTaskExecutors;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (torder.getPolishType().equals(Common.POLISH_TYPE_WITH_EXPAND)) &#123;</span><br><span class="line">            executors = textTaskExecutors;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (torder.getPolishType().equals(Common.POLISH_TYPE_WITH_RELINE)) &#123;</span><br><span class="line">            executors = textTaskExecutors;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error PolishType: &#123;&#125;&quot;</span>, torder.getPolishType());</span><br><span class="line">            <span class="keyword">return</span> Optional.empty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Optional.of(executors);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
    <summary type="html">æ‰‹å†™æ¶ˆæ¯é˜Ÿåˆ—æ›¿ä»£Kafka</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SpringBoot" scheme="https://cyborg2077.github.io/tags/SpringBoot/"/>
    
    <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="https://cyborg2077.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>AOPã€MDCå®ç°æ—¥å¿—è¿½è¸ª</title>
    <link href="https://cyborg2077.github.io/2023/10/03/MDCTraceLog/"/>
    <id>https://cyborg2077.github.io/2023/10/03/MDCTraceLog/</id>
    <published>2023-10-03T13:36:49.000Z</published>
    <updated>2023-10-03T15:17:13.142Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><ul><li>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæ—¥å¿—è¾“å‡ºæ˜¯éå¸¸é‡è¦çš„ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœ æ—¥å¿—æ‰“å¾—å¥½ï¼Œå¯ä»¥å¿«é€Ÿåœ°æ’æŸ¥é—®é¢˜ï¼Œä¸ºäº†æ›´å¥½çš„æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº›æ—¥å¿—ä¸²è”èµ·æ¥ï¼Œè¿™æ ·ä¼šä½¿æ’æŸ¥é—®é¢˜å˜å¾—æ›´åŠ è½»æ¾ã€‚æ­£å¥½æˆ‘å‰ä¸€ç¯‡æ–‡ä»‹ç»äº†ELKçš„æ­å»ºï¼Œé‚£ä¹ˆç°åœ¨æˆ‘ä»¬å†æ¥çœ‹çœ‹AOP+MDCå¦‚ä½•å®ç°æ—¥å¿—è¿½è¸ªã€‚</li><li>å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨æ—¥å¿—ä¸­è®°å½•ç”¨æˆ·çš„IPï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½åˆ†æè¯¥ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œæ—¥å¿—ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨æ—¥å¿—ä¸­è®°å½•è®¢å•IDï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬çš„è®¢å•å‡ºç°äº†é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«çš„æ¥æ ¹æ®è®¢å•IDåœ¨Kibanaä¸­æœç´¢ä¸è¯¥è®¢å•IDå…³è”çš„æ‰€æœ‰æ—¥å¿—ä¿¡æ¯ã€‚</li></ul><h2 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h2><ul><li>ä¸²è”çš„æ ¸å¿ƒåœ¨äºè¦æŠŠIDä½œä¸ºä¸€ä¸ªè¯·æ±‚å¿…ä¼ å‚æ•°ï¼Œä¾‹å¦‚æˆ‘ä»¬æ‰‹åŠ¨æ‰“å°æ—¥å¿—çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨æ—¥å¿—ä¸­åŠ ä¸Šæˆ‘ä»¬çš„ä¸šåŠ¡IDï¼Œä¾‹å¦‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;æäº¤è®¢å•å¼€å§‹ï¼š&#123;&#125;&quot;</span>, orderId);</span><br></pre></td></tr></table></figure><ul><li>ä½†æ˜¯æ­¤ç§æ–¹å¼è¾ƒä¸ºç¹çï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯æ¡æ—¥å¿—ä¸­éƒ½æ‰‹åŠ¨åŠ ä¸ŠorderIdçš„è¾“å‡ºï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰æ›´ç®€å•çš„æ–¹å¼å‘¢ï¼Ÿé¦–å…ˆæƒ³åˆ°çš„æ˜¯AOPï¼Œå› ä¸ºAOPå¯ä»¥å°†æ—¥å¿—è®°å½•çš„è¡Œä¸ºä»ä¸šåŠ¡çš„æ ¸å¿ƒé€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œè€ŒMDCæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å­˜æ”¾è¯Šæ–­æ—¥å¿—çš„å®¹å™¨ï¼Œåœ¨å¤„ç†è¯·æ±‚å‰å°†è¯·æ±‚çš„å”¯ä¸€æ ‡ç¤ºæ”¾åˆ°MDCå®¹å™¨ä¸­ï¼Œè¿™ä¸ªå”¯ä¸€æ ‡ç¤ºä¼šéšç€æ—¥å¿—ä¸€èµ·è¾“å‡ºï¼Œä»¥æ­¤æ¥åŒºåˆ†è¯¥æ¡æ—¥å¿—æ˜¯å±äºé‚£ä¸ªè¯·æ±‚çš„ã€‚å¹¶åœ¨è¯·æ±‚å¤„ç†å®Œæˆä¹‹åæ¸…é™¤MDCå®¹å™¨ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MDCAdapter</span> &#123;</span><br><span class="line">    <span class="comment">// å°†ä¸€ä¸ªk-vé”®å€¼å¯¹æ”¾åˆ°å®¹å™¨ï¼Œå…¶å®æ˜¯æ”¾åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalMapä¸­</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String var1, String var2)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®keyåœ¨å½“å‰çº¿ç¨‹çš„MDCå®¹å™¨ä¸­è·å–å¯¹åº”çš„å€¼</span></span><br><span class="line">    String <span class="title function_">get</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®keyç§»é™¤å®¹å™¨ä¸­çš„å€¼</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç©ºå½“å‰çº¿ç¨‹çš„MDCå®¹å™¨</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; <span class="title function_">getCopyOfContextMap</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setContextMap</span><span class="params">(Map&lt;String, String&gt; var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Logbacké…ç½®ï¼šä½¿ç”¨MDCæœºåˆ¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨logback.xmlæ—¥å¿—æ¨¡æ¿ä¸­è¿›è¡Œä¸€äº›é…ç½®ï¼Œé€šè¿‡ä½¿ç”¨å ä½ç¬¦<code>%X&#123;&#125;</code>æ¥å ä½ï¼Œæ›¿æ¢åˆ°å¯¹åº”MDCä¸­keyçš„å€¼ã€‚</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value=&quot;%clr(%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;)&#123;faint&#125; %clr($&#123;LOG_LEVEL_PATTERN:-%5p&#125;) %clr([$&#123;springAppName:-&#125;])&#123;yellow&#125; %clr(%X&#123;TRACE_ID&#125;)&#123;cyan&#125; %clr($&#123;PID:- &#125;)&#123;magenta&#125; %clr(---)&#123;faint&#125; %clr([%15.15t])&#123;faint&#125; %clr(%-40.40logger&#123;39&#125;)&#123;cyan&#125; %clr(:)&#123;faint&#125; %green([%X&#123;userIp&#125;]) %cyan([%X&#123;requestURI&#125;]) %green([%X&#123;orderId&#125;]) %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&quot;</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨ï¼Œå°†ç”¨æˆ·IPä¿¡æ¯è®°å½•åˆ°æ—¥å¿—ä¸­</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserIpFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_IP_MDC_KEY</span> <span class="operator">=</span> <span class="string">&quot;userIp&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_REQUEST_URI_MDC_KEY</span> <span class="operator">=</span> <span class="string">&quot;requestURI&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–ç”¨æˆ·IPå¹¶æ·»åŠ åˆ°MDC</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">userIp</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-Real-IP&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">            MDC.put(USER_IP_MDC_KEY, userIp);</span><br><span class="line">            MDC.put(USER_REQUEST_URI_MDC_KEY, requestURI);</span><br><span class="line">            <span class="comment">// ç»§ç»­è¯·æ±‚å¤„ç†</span></span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// æ¸…é™¤MDCï¼Œç¡®ä¿ä¸ä¼šå½±å“å…¶ä»–è¯·æ±‚</span></span><br><span class="line">            MDC.remove(USER_IP_MDC_KEY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="MDCç»“åˆAOP">MDCç»“åˆAOP</h2><ul><li>å› ä¸ºè¿™éƒ¨åˆ†å…¶å®æ˜¯åŠé“é‡ŒåŠ è¿›æ¥çš„ï¼Œæ‰€ä»¥å†™çš„æ¯”è¾ƒç²—ç³™ï¼Œä½†æ˜¯å®ç°æ€è·¯å°±æ˜¯ç”¨åˆ‡ç‚¹è¡¨è¾¾å¼æ¥åŒ¹é…è®¢å•ç›¸å…³ä¿¡æ¯ï¼Œä¸»è¦å°±æ˜¯Orderè¿™ä¸ªå®ä½“ç±»å’ŒorderIdè¿™ä¸ªå‚æ•°ï¼Œä½†æ˜¯åˆ‡ç‚¹ä¸æ”¯æŒåŒ¹é…å‚æ•°åï¼Œæ‰€ä»¥åŒ¹é…String orderIdçš„æ—¶å€™ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨åŒ¹é…ï¼ˆå› ä¸ºä¸æ”¯æŒå‚æ•°ååŒ¹é…ï¼ŒæŒ‰ç±»å‹åŒ¹é…ä¼šåŒ¹é…ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Stingçš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šåŒ¹é…é”™ï¼‰ã€‚</li><li>æˆ‘è¿™é‡Œçš„å»ºè®®æ˜¯é€šè¿‡æ–¹æ³•åè¿›è¡ŒåŒ¹é…ï¼Œé‚£ä¹ˆå°±éœ€è¦è®¢å•ç›¸å…³çš„æ–¹æ³•åçš„åç¼€è¿›è¡Œç»Ÿä¸€ï¼Œç„¶ååˆ‡ç‚¹è¡¨è¾¾å¼æŒ‰æ–¹æ³•ååç¼€åŒ¹é…å°±å¥½äº† <del>ï¼ˆåæœŸæœ‰ç©ºå†é‡æ„é‡æ„ä»£ç å§ï¼Œæ¯•ç«Ÿè¿™é‡Œå†™çš„å®åœ¨ä¸å¤ªå¥½ï¼‰</del></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderIdAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;(execution(* xxx.xxxx.xxx.service.OrderConsumerService.processText(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.getPaperJsonContent(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.getTextJsonObject(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.TextConsumeMessage*(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.PaperConsumeMessage*(..)))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;&amp;&amp; args(torder, ..)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderMethod1</span><span class="params">(Torder torder)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(value = &quot;orderMethod1(torder)&quot;, argNames = &quot;joinPoint,torder&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">logMethod1</span><span class="params">(ProceedingJoinPoint joinPoint, Torder torder)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Accessed method: &#123;&#125;&quot;</span>, joinPoint.getSignature().toShortString());</span><br><span class="line">        MDC.put(<span class="string">&quot;orderId&quot;</span>, torder.getOrderId());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            MDC.remove(<span class="string">&quot;orderId&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;(execution(* xxx.xxxx.xxx.web.controller.CommonController.commitJCInformation(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.impl.OrderServiceImpl.getAsyncErrorStatusOrder(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.web.controller.CommonController.getStatusByOrderId(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.web.controller.CommonController.userComment(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.impl.OrderServiceImpl.commitJCInformation(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.getTextStatusByOrderId(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.service.OrderConsumerService.getPaperStatusByOrderId(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.manager.ThirdManager.getTaskProcessStatus(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.manager.ThirdManager.getTextTaskProcessStatus(..)) ||&quot; +</span></span><br><span class="line"><span class="meta">            &quot;execution(* xxx.xxxx.xxx.manager.ThirdManager.createTextAlgorithmTask(..)))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;&amp;&amp; args(orderId, ..)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderMethod2</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(value = &quot;orderMethod2(orderId)&quot;, argNames = &quot;joinPoint,orderId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">logMethod2</span><span class="params">(ProceedingJoinPoint joinPoint, String orderId)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Accessed method: &#123;&#125;&quot;</span>, joinPoint.getSignature().toShortString());</span><br><span class="line">        MDC.put(<span class="string">&quot;orderId&quot;</span>, orderId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            MDC.remove(<span class="string">&quot;orderId&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å‰é¢å·²ç»æ­å»ºäº†ELKï¼Œé‚£ç°åœ¨å†æ¥è®²è®²æ€ä¹ˆå®ç°æ—¥å¿—è¿½è¸ª</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SpringBoot" scheme="https://cyborg2077.github.io/tags/SpringBoot/"/>
    
    <category term="AOP" scheme="https://cyborg2077.github.io/tags/AOP/"/>
    
    <category term="æ—¥å¿—åˆ†æ" scheme="https://cyborg2077.github.io/tags/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/"/>
    
    <category term="MDC" scheme="https://cyborg2077.github.io/tags/MDC/"/>
    
  </entry>
  
  <entry>
    <title>AOPå°è£…ä¸€ä¸ªè®°å½•è€—æ—¶çš„æ³¨è§£</title>
    <link href="https://cyborg2077.github.io/2023/10/03/TakeTimeLog/"/>
    <id>https://cyborg2077.github.io/2023/10/03/TakeTimeLog/</id>
    <published>2023-10-03T07:16:34.000Z</published>
    <updated>2023-10-03T08:38:34.658Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€è¿°">ç®€è¿°</h2><ul><li>ä¸Šç¯‡æ–‡ç« è¯´çš„æ˜¯ä½¿ç”¨Arthasæ¥åˆ†æè€—æ—¶ï¼Œä½†æ˜¯æ•´ä½“æµç¨‹è¿˜æ˜¯æŒºç¹ççš„ï¼Œé‚£è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±ç”¨AOPæ¥å°è£…ä¸€ä¸ªè®°å½•è€—æ—¶çš„æ³¨è§£å§ï¼Œè™½ç„¶åšä¸åˆ°åˆ†ææ•´ä¸ªè°ƒç”¨é“¾è·¯ä¸Šçš„è€—æ—¶æƒ…å†µï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬å¸Œæœ›è®°å½•è€—æ—¶çš„æ–¹æ³•ä¸ŠåŠ ä¸Šå¯¹åº”çš„æ³¨è§£ï¼Œæ¥è®°å½•å¯¹åº”çš„è€—æ—¶ã€‚</li></ul><h2 id="ä»£ç å®ç°">ä»£ç å®ç°</h2><ul><li>é‚£ç°åœ¨æˆ‘ä»¬æ¥ä»å¤´ç¼–å†™ä¸€ä¸ªTakeTimeAspectç±»ï¼Œè¯¥ç±»é€šè¿‡AOPçš„æ–¹å¼æ¥ç›‘æ§æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œå¹¶ä¸”è®°å½•ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯ã€‚é¦–å…ˆå¯¼å…¥AOPçš„ä¾èµ–</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ä»£ç å®ç°  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TakeTimeAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ThreadLocalå˜é‡ç”¨äºå­˜å‚¨å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´</span></span><br><span class="line">    ThreadLocal&lt;Long&gt; startTime = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    ThreadLocal&lt;Long&gt; endTime = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼ŒåŒ¹é…å¸¦æœ‰@TakeTimeLogæ³¨è§£çš„æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.aimc.paperreduction.common.annotation.TakeTimeLog)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">TakeTime</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‰ç½®å¢å¼ºæ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œå‰è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="meta">@Before(&quot;TakeTime()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBefore</span><span class="params">(JoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// è·å¾—æ³¨è§£</span></span><br><span class="line">        <span class="type">TakeTimeLog</span> <span class="variable">timeLog</span> <span class="operator">=</span> getAnnotationLog(joinPoint);</span><br><span class="line">        <span class="keyword">if</span> (timeLog == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        startTime.set(System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›åå¢å¼ºæ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œåè®°å½•ç»“æŸæ—¶é—´å’Œæ‰§è¡Œæ—¶é—´ï¼Œå¹¶è®°å½•æ—¥å¿—</span></span><br><span class="line">    <span class="meta">@AfterReturning(returning = &quot;ret&quot;, pointcut = &quot;TakeTime()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterReturning</span><span class="params">(JoinPoint joinPoint, Object ret)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        String[] names = ((CodeSignature) joinPoint.getSignature()).getParameterNames();</span><br><span class="line">        <span class="keyword">if</span> (names.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; names.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(joinPoint.getArgs()[i] <span class="keyword">instanceof</span> HttpServletRequest)) &#123;</span><br><span class="line">                    resultMap.put(names[i], joinPoint.getArgs()[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤„ç†å®Œè¯·æ±‚åï¼Œè¿”å›å†…å®¹</span></span><br><span class="line">        log.info(<span class="string">&quot;Return:&quot;</span> + JSON.toJSONString(ret));</span><br><span class="line">        endTime.set(System.currentTimeMillis());</span><br><span class="line">        log.info(<span class="string">&quot;Execution Time:&quot;</span> + (endTime.get() - startTime.get()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºè·å–æ–¹æ³•ä¸Šçš„æ³¨è§£</span></span><br><span class="line">    <span class="keyword">private</span> TakeTimeLog <span class="title function_">getAnnotationLog</span><span class="params">(JoinPoint joinPoint)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> joinPoint.getSignature();</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">methodSignature</span> <span class="operator">=</span> (MethodSignature) signature;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> methodSignature.getMethod();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.getAnnotation(TakeTimeLog.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>ThreadLocal&lt;Long&gt; startTime</code> å’Œ <code>ThreadLocal&lt;Long&gt; endTime</code>ï¼šè¿™ä¸¤ä¸ªæ˜¯ThreadLocalå˜é‡ï¼Œç”¨äºå­˜å‚¨æ–¹æ³•æ‰§è¡Œçš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼Œç”¨äºè®¡ç®—æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ã€‚ThreadLocalå…è®¸å­˜å‚¨æ¯ä¸ªçº¿ç¨‹ç‰¹å®šçš„æ•°æ®ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§ã€‚</li><li>åˆ‡ç‚¹è¡¨è¾¾å¼ï¼š<code>@Pointcut(&quot;@annotation(com.aimc.paperreduction.common.annotation.TakeTimeLog)&quot;)</code>ï¼ŒåŒ¹é…å¸¦æœ‰@TakeTimeLogæ³¨è§£çš„æ–¹æ³•ã€‚</li><li>å¢å¼ºæ–¹æ³•<ol><li><code>@Before(&quot;TakeTime()&quot;)</code>ï¼šåœ¨åŒ¹é…TakeTimeåˆ‡å…¥ç‚¹çš„æ–¹æ³•ä¹‹å‰æ‰§è¡Œã€‚å®ƒæ•è·æ–¹æ³•æ‰§è¡Œå¼€å§‹çš„æ—¶é—´ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥è·å–æ›´å¤šçš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ–¹æ³•å‚æ•°ä¹‹ç±»çš„ä¿¡æ¯éƒ½å¯ä»¥æ‹¿åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬æ ¹æ®è‡ªèº«é¡¹ç›®çš„éœ€æ±‚æ¥ç¼–å†™ã€‚</li><li>@<code>AfterReturning(returning = &quot;ret&quot;, pointcut = &quot;TakeTime()&quot;)</code>ï¼šè¿™æ˜¯ä¸€ä¸ªè¿”å›åå¢å¼ºæ–¹æ³•ã€‚å®ƒæ•è·æ–¹æ³•çš„ç»“æŸæ—¶é—´ï¼Œè®°å½•è¿”å›å€¼ï¼Œå¹¶è®¡ç®—å¹¶è®°å½•æ‰§è¡Œæ—¶é—´ã€‚</li></ol></li><li><code>getAnnotationLog</code>ï¼šè¿™æ˜¯ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œç”¨äºä»ç›®æ ‡æ–¹æ³•ä¸­è·å–TakeTimeLogæ³¨è§£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚</li></ul></li></ul><h2 id="ä½¿ç”¨æ–¹å¼">ä½¿ç”¨æ–¹å¼</h2><ul><li>æˆ‘ä»¬åœ¨éœ€è¦è®°å½•è€—æ—¶çš„æ–¹æ³•ä¸ŠåŠ ä¸Šæ­¤æ³¨è§£å³å¯</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TakeTimeLog</span></span><br><span class="line"><span class="keyword">public</span> Wrapper&lt;UploadPaperDTO&gt; <span class="title function_">uploadDoc</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ä½ çš„ä»£ç é€»è¾‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ç®€å•å†™ä¸ªå°ç©æ„</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SpringBoot" scheme="https://cyborg2077.github.io/tags/SpringBoot/"/>
    
    <category term="æ€§èƒ½åˆ†æ" scheme="https://cyborg2077.github.io/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"/>
    
    <category term="AOP" scheme="https://cyborg2077.github.io/tags/AOP/"/>
    
  </entry>
  
  <entry>
    <title>Arthasæ’æŸ¥SpringBootçš„è€—æ—¶</title>
    <link href="https://cyborg2077.github.io/2023/09/07/ArthasAnalyzing/"/>
    <id>https://cyborg2077.github.io/2023/09/07/ArthasAnalyzing/</id>
    <published>2023-09-07T07:16:34.000Z</published>
    <updated>2023-09-07T07:16:34.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€è¿°">ç®€è¿°</h2><ul><li>Arthaså®˜ç½‘ï¼š<a href="https://arthas.aliyun.com/">https://arthas.aliyun.com/</a></li><li>Arthasï¼ˆAlibaba Java Diagnostic Toolï¼‰æ˜¯ä¸€ä¸ªå¼ºå¤§çš„Javaè¯Šæ–­å·¥å…·ï¼Œå®ƒå¯ä»¥ç›‘æ§å’Œåˆ†æè¿è¡Œä¸­çš„Javaåº”ç”¨ç¨‹åºã€‚å®ƒé‡‡ç”¨äº†å­—èŠ‚ç æ³¨å…¥çš„æ–¹å¼æ¥å®ç°ç›‘æ§å’Œè°ƒè¯•åŠŸèƒ½ã€‚</li></ul><h2 id="åº•å±‚åŸç†">åº•å±‚åŸç†</h2><ol><li>å­—èŠ‚ç æ³¨å…¥ï¼šArthasä½¿ç”¨å­—èŠ‚ç æ³¨å…¥æŠ€æœ¯ï¼Œé€šè¿‡ä¿®æ”¹ç›®æ ‡Javaç¨‹åºçš„å­—èŠ‚ç æ¥åŠ¨æ€æ³¨å…¥ç›‘æ§ä»£ç å’Œæ”¶é›†æ€§èƒ½ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œé‡æ–°ç¼–è¯‘æˆ–è€…é‡å¯ï¼Œå› ä¸ºé‡å¯ä¹‹åé—®é¢˜å¯èƒ½ä¸å®¹æ˜“å¤ç°ï¼Œå› æ­¤å¯ä»¥åœ¨è¿è¡Œæ—¶å¯¹å…¶è¿›è¡Œè¯Šæ–­å’Œåˆ†æã€‚</li><li>Instrumentation APIï¼šArthasä½¿ç”¨Javaçš„Instrumentation APIæ¥å®ç°å­—èŠ‚ç æ³¨å…¥ã€‚è¿™ä¸ªAPIè¿è¡Œç±»åŠ è½½å™¨ä¼šåœ¨åŠ è½½ç±»æ—¶ï¼Œå¯¹ç±»çš„å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼ŒArthasé€šè¿‡è¿™ä¸ªAPIæ¥æ³¨å…¥è‡ªå·±çš„ç›‘æ§ä»£ç ï¼Œä»¥ä¾¿æ•è·æ–¹æ³•æ‰§è¡Œã€æ€§èƒ½ç»Ÿè®¡ç­‰ä¿¡æ¯ã€‚</li><li>Agentæ–¹å¼ï¼šArthasä»¥Java Agentçš„å½¢å¼è¿è¡Œï¼Œé€šè¿‡JVMçš„Agentæœºåˆ¶åŠ è½½åˆ°ç›®æ ‡åº”ç”¨ç¨‹åºä¸­ã€‚Java Agentæ˜¯ä¸€ç§è¿è¡Œåœ¨Javaç¨‹åºä¹‹å¤–çš„Javaç¨‹åºï¼Œå¯ä»¥åœ¨ç›®æ ‡åº”ç”¨è¿è¡Œæ—¶è¢«åŠ¨æ€åœ°é™„åŠ åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ï¼Œå¹¶ä¸ä¹‹äº¤äº’ã€‚</li></ol><h2 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h2><ul><li><p>ç”±äºæ‰§è¡ŒArthasç¨‹åºçš„ç”¨æˆ·éœ€è¦ä¸ç›®æ ‡è¿›ç¨‹å…·æœ‰ç›¸åŒçš„æƒé™ï¼Œç›®å‰å…¬å¸çš„é¡¹ç›®éƒ½æ˜¯é€šè¿‡å®¹å™¨å¯åŠ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦è¿›å…¥JavaæœåŠ¡å®¹å™¨çš„å†…éƒ¨ï¼Œç„¶åä¸‹è½½Arthasçš„jaråŒ…ï¼Œç„¶åå†å¯åŠ¨ï¼ˆWindowsç¯å¢ƒä¸‹ç›´æ¥åœ¨CMDçª—å£è¿è¡Œå³å¯ï¼‰</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://arthas.aliyun.com/arthas-boot.jar</span><br><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ä¹‹åå°±ä¼šåˆ—å‡ºå½“å‰æ‰€æœ‰çš„Javaè¿›ç¨‹ï¼Œæˆ‘ä»¬æ ¹æ®è‡ªèº«éœ€æ±‚æ¥é€‰æ‹©è¦ç›‘æ§çš„Javaè¿›ç¨‹</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@ff3c3ed00ac8:/data<span class="comment"># java -jar arthas-boot.jar </span></span><br><span class="line">    [INFO] JAVA_HOME: /usr/local/openjdk-8/jre</span><br><span class="line">    [INFO] arthas-boot version: 3.7.1</span><br><span class="line">    [INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class="line">    * [1]: 7 /data/PaperReduction.jar</span><br><span class="line">    <span class="comment"># æ‰¾åˆ°ä¸€ä¸ªJavaè¿›ç¨‹ï¼ŒæŒ‰ä¸‹å¯¹åº”çš„æ•°å­—é”®æ¥è¿›è¡Œç›‘æ§</span></span><br><span class="line">    1</span><br><span class="line">    [INFO] arthas home: /root/.arthas/lib/3.7.1/arthas</span><br><span class="line">    [INFO] The target process already listen port 3658, skip attach.</span><br><span class="line">    [INFO] arthas-client connect 127.0.0.1 3658</span><br><span class="line">    ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           </span><br><span class="line">    /  O  \ |  .--. <span class="string">&#x27;&#x27;</span>--.  .--<span class="string">&#x27;|  &#x27;</span>--<span class="string">&#x27;  | /  O  \ &#x27;</span>   .-<span class="string">&#x27;                          </span></span><br><span class="line"><span class="string">    |  .-.  ||  &#x27;</span>--<span class="string">&#x27;.&#x27;</span>   |  |   |  .--.  ||  .-.  |`.  `-.                          </span><br><span class="line">    |  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="string">&#x27;    |                         </span></span><br><span class="line"><span class="string">    `--&#x27;</span> `--<span class="string">&#x27;`--&#x27;</span> <span class="string">&#x27;--&#x27;</span>   `--<span class="string">&#x27;   `--&#x27;</span>  `--<span class="string">&#x27;`--&#x27;</span> `--<span class="string">&#x27;`-----&#x27;</span>                          </span><br><span class="line">    </span><br><span class="line">    wiki       https://arthas.aliyun.com/doc                                        </span><br><span class="line">    tutorials  https://arthas.aliyun.com/doc/arthas-tutorials.html                  </span><br><span class="line">    version    3.7.1                                                                </span><br><span class="line">    main_class                                                                      </span><br><span class="line">    pid        7                                                                    </span><br><span class="line">    time       2023-09-06 19:15:06        </span><br><span class="line"></span><br><span class="line">[arthas@7]$                                           </span><br></pre></td></tr></table></figure></li><li><p>é‚£ä¹ˆç°åœ¨çš„éœ€æ±‚æ˜¯åˆ†æä»Springæ¡†æ¶æ¥æ”¶åˆ°HTTPè¯·æ±‚ï¼Œç„¶ååˆ†æ´¾åˆ°å¯¹åº”çš„Controlleræ–¹æ³•ä¹‹é—´çš„è€—æ—¶ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨Arthasçš„ä¸€ä¸ªå°åŠŸèƒ½traceï¼Œå®ƒå¯ä»¥åŠ¨æ€åœ°è®¡ç®—æ–¹æ³•è°ƒç”¨è·¯å¾„å’Œè€—æ—¶ã€‚</p><ol><li>traceæ–¹æ³•å†…éƒ¨è°ƒç”¨è·¯å¾„ï¼Œå¹¶è¾“å‡ºæ–¹æ³•è·¯å¾„ä¸Šæ¯ä¸ªèŠ‚ç‚¹çš„è€—æ—¶ã€‚</li><li>traceå‘½ä»¤èƒ½ä¸»åŠ¨æœç´¢class-pattern/method-patternï¼Œå¯¹åº”çš„æ–¹æ³•å¸¦å“¦ç”¨è·¯å¾„ï¼Œæ¸²æŸ“å’Œç»Ÿè®¡æ•´ä¸ªè°ƒç”¨é“¾è·¯ä¸Šçš„æ‰€æœ‰æ€§èƒ½å¼€é”€å’Œè¿½è¸ªè°ƒç”¨é“¾è·¯ã€‚</li></ol></li><li><p>å†äº†è§£ä¸¤ä¸ªå°æ¦‚å¿µ</p><ol><li>DispatcherServletï¼ˆorg.springframework.web.servlet.DispatcherServletï¼‰ï¼šDispatcherServlet æ˜¯Spring MVCçš„æ ¸å¿ƒï¼Œå®ƒè´Ÿè´£æ¥æ”¶HTTPè¯·æ±‚å¹¶å°†è¯·æ±‚åˆ†æ´¾ç»™ç›¸åº”çš„Controllerã€‚æˆ‘ä»¬å¯ä»¥ä»DispatcherServletçš„è¯·æ±‚å¤„ç†æ–¹æ³•å…¥æ‰‹ï¼Œåˆ†æè¯·æ±‚çš„è°ƒç”¨é“¾å’Œå¤„ç†æ—¶é—´ã€‚</li><li>HandlerMappingï¼ˆorg.springframework.web.servlet.HandlerMappingï¼‰ï¼šHandlerMapping è´Ÿè´£å°†è¯·æ±‚æ˜ å°„åˆ°å…·ä½“çš„Controlleræ–¹æ³•ã€‚æ‚¨å¯ä»¥åˆ†æä¸åŒçš„HandlerMappingå®ç°ï¼Œä»¥äº†è§£è¯·æ±‚åˆ°Controlleræ–¹æ³•çš„æ˜ å°„è¿‡ç¨‹ã€‚</li></ol></li><li><p>é‚£æˆ‘ä»¬ç°åœ¨æ‰§è¡Œ <code>trace org.springframework.web.servlet.DispatcherServlet *</code> æ¥åˆ†æä¸€ä¸‹è°ƒç”¨é“¾ä¸Šéƒ½ç»è¿‡äº†ä»€ä¹ˆ</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">`---ts=2023-09-07 10:27:40;thread_name=http-nio-80-exec-5;<span class="built_in">id</span>=33;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[5.59488ms] org.springframework.web.servlet.DispatcherServlet:doService()</span><br><span class="line">        +---[0.63% 0.035364ms ] org.springframework.web.servlet.DispatcherServlet:logRequest() <span class="comment">#926</span></span><br><span class="line">        |   `---[59.32% 0.020979ms ] org.springframework.web.servlet.DispatcherServlet:logRequest()</span><br><span class="line">        |       `---[28.81% 0.006045ms ] org.springframework.core.log.LogFormatUtils:traceDebug() <span class="comment">#980</span></span><br><span class="line">        +---[0.12% 0.006831ms ] org.springframework.web.util.WebUtils:isIncludeRequest() <span class="comment">#931</span></span><br><span class="line">        +---[0.10% 0.005813ms ] org.springframework.web.servlet.DispatcherServlet:getWebApplicationContext() <span class="comment">#943</span></span><br><span class="line">        +---[0.07% 0.004058ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#943</span></span><br><span class="line">        +---[0.06% 0.003624ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#944</span></span><br><span class="line">        +---[0.06% 0.003435ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#945</span></span><br><span class="line">        +---[0.61% 0.034354ms ] org.springframework.web.servlet.DispatcherServlet:getThemeSource() <span class="comment">#946</span></span><br><span class="line">        |   `---[61.47% 0.021117ms ] org.springframework.web.servlet.DispatcherServlet:getThemeSource()</span><br><span class="line">        |       `---[46.43% min=0.0046ms,max=0.005205ms,total=0.009805ms,count=2] org.springframework.web.servlet.DispatcherServlet:getWebApplicationContext() <span class="comment">#806</span></span><br><span class="line">        +---[0.06% 0.003434ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#946</span></span><br><span class="line">        +---[0.22% 0.012272ms ] org.springframework.web.servlet.FlashMapManager:retrieveAndUpdate() <span class="comment">#949</span></span><br><span class="line">        +---[0.16% 0.008744ms ] org.springframework.web.servlet.FlashMap:&lt;init&gt;() <span class="comment">#953</span></span><br><span class="line">        +---[0.12% 0.006509ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#953</span></span><br><span class="line">        +---[0.09% 0.004867ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#954</span></span><br><span class="line">        +---[0.07% 0.003641ms ] javax.servlet.http.HttpServletRequest:getAttribute() <span class="comment">#959</span></span><br><span class="line">        +---[2.51% 0.140331ms ] org.springframework.web.util.ServletRequestPathUtils:parseAndCache() <span class="comment">#960</span></span><br><span class="line">        +---[92.44% 5.172017ms ] org.springframework.web.servlet.DispatcherServlet:doDispatch() <span class="comment">#964</span></span><br><span class="line">        |   `---[99.30% 5.136033ms ] org.springframework.web.servlet.DispatcherServlet:doDispatch()</span><br><span class="line">        |       +---[0.13% 0.006484ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#1036</span></span><br><span class="line">        |       +---[0.72% 0.036845ms ] org.springframework.web.servlet.DispatcherServlet:checkMultipart() <span class="comment">#1043</span></span><br><span class="line">        |       |   `---[55.87% 0.020586ms ] org.springframework.web.servlet.DispatcherServlet:checkMultipart()</span><br><span class="line">        |       |       `---[55.39% 0.011402ms ] org.springframework.web.multipart.MultipartResolver:isMultipart() <span class="comment">#1197</span></span><br><span class="line">        |       +---[5.09% 0.261359ms ] org.springframework.web.servlet.DispatcherServlet:getHandler() <span class="comment">#1047</span></span><br><span class="line">        |       |   `---[94.84% 0.247868ms ] org.springframework.web.servlet.DispatcherServlet:getHandler()</span><br><span class="line">        |       |       `---[94.99% 0.235439ms ] org.springframework.web.servlet.HandlerMapping:getHandler() <span class="comment">#1265</span></span><br><span class="line">        |       +---[0.11% 0.005579ms ] org.springframework.web.servlet.HandlerExecutionChain:getHandler() <span class="comment">#1054</span></span><br><span class="line">        |       +---[0.62% 0.031705ms ] org.springframework.web.servlet.DispatcherServlet:getHandlerAdapter() <span class="comment">#1054</span></span><br><span class="line">        |       |   `---[56.86% 0.018028ms ] org.springframework.web.servlet.DispatcherServlet:getHandlerAdapter()</span><br><span class="line">        |       |       `---[32.95% 0.005941ms ] org.springframework.web.servlet.HandlerAdapter:supports() <span class="comment">#1301</span></span><br><span class="line">        |       +---[0.06% 0.003195ms ] javax.servlet.http.HttpServletRequest:getMethod() <span class="comment">#1057</span></span><br><span class="line">        |       +---[0.11% 0.00577ms ] org.springframework.http.HttpMethod:matches() <span class="comment">#1058</span></span><br><span class="line">        |       +---[0.05% 0.00277ms ] org.springframework.http.HttpMethod:matches() <span class="comment">#1059</span></span><br><span class="line">        |       +---[40.64% 2.08729ms ] org.springframework.web.servlet.HandlerExecutionChain:applyPreHandle() <span class="comment">#1066</span></span><br><span class="line">        |       +---[0.08% 0.004206ms ] org.springframework.web.servlet.HandlerExecutionChain:getHandler() <span class="comment">#1071</span></span><br><span class="line">        |       +---[47.64% 2.44697ms ] org.springframework.web.servlet.HandlerAdapter:handle() <span class="comment">#1071</span></span><br><span class="line">        |       +---[0.11% 0.00578ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1073</span></span><br><span class="line">        |       +---[0.77% 0.039313ms ] org.springframework.web.servlet.DispatcherServlet:applyDefaultViewName() <span class="comment">#1077</span></span><br><span class="line">        |       |   `---[34.47% 0.01355ms ] org.springframework.web.servlet.DispatcherServlet:applyDefaultViewName()</span><br><span class="line">        |       +---[0.16% 0.008038ms ] org.springframework.web.servlet.HandlerExecutionChain:applyPostHandle() <span class="comment">#1078</span></span><br><span class="line">        |       +---[1.41% 0.072602ms ] org.springframework.web.servlet.DispatcherServlet:processDispatchResult() <span class="comment">#1088</span></span><br><span class="line">        |       |   `---[66.42% 0.04822ms ] org.springframework.web.servlet.DispatcherServlet:processDispatchResult()</span><br><span class="line">        |       |       +---[6.78% 0.003268ms ] org.apache.commons.logging.Log:isTraceEnabled() <span class="comment">#1155</span></span><br><span class="line">        |       |       +---[10.20% 0.004917ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#1160</span></span><br><span class="line">        |       |       +---[5.81% 0.0028ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1160</span></span><br><span class="line">        |       |       `---[16.01% 0.007718ms ] org.springframework.web.servlet.HandlerExecutionChain:triggerAfterCompletion() <span class="comment">#1167</span></span><br><span class="line">        |       `---[0.11% 0.00572ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1098</span></span><br><span class="line">        +---[0.09% 0.004919ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#967</span></span><br><span class="line">        +---[0.05% 0.002756ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#967</span></span><br><span class="line">        `---[0.20% 0.011002ms ] org.springframework.web.util.ServletRequestPathUtils:setParsedRequestPath() <span class="comment">#974</span></span><br></pre></td></tr></table></figure><ol><li><code>doService()</code> æ–¹æ³•ï¼šé¦–å…ˆï¼Œè¯·æ±‚è¿›å…¥ <code>DispatcherServlet</code> çš„ <code>doService()</code> æ–¹æ³•ã€‚è¿™æ˜¯è¯·æ±‚å¤„ç†çš„å…¥å£ç‚¹ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šè¿›è¡Œä»¥ä¸‹ä¸€äº›é‡è¦çš„æ“ä½œï¼š<ol><li><code>logRequest()</code> æ–¹æ³•ï¼šè¿™ä¸ªæ–¹æ³•ç”¨äºè®°å½•è¯·æ±‚çš„ä¿¡æ¯ï¼Œä¾‹å¦‚è¯·æ±‚çš„HTTPæ–¹æ³•ã€URIç­‰ã€‚å®ƒé€šå¸¸ç”¨äºè°ƒè¯•å’Œæ—¥å¿—è®°å½•ç›®çš„ã€‚</li><li><code>isIncludeRequest()</code> æ–¹æ³•ï¼šæ£€æŸ¥å½“å‰è¯·æ±‚æ˜¯å¦æ˜¯åŒ…å«ï¼ˆincludeï¼‰è¯·æ±‚ã€‚åŒ…å«è¯·æ±‚æ˜¯æŒ‡ä¸€ä¸ªServletå¯ä»¥åŒ…å«å¦ä¸€ä¸ªServletçš„å“åº”å†…å®¹ã€‚</li><li><code>getWebApplicationContext()</code> æ–¹æ³•ï¼šè·å–Springçš„Webåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œè¯¥ä¸Šä¸‹æ–‡åŒ…å«äº†Springåº”ç”¨ç¨‹åºä¸­çš„å„ç§beanå®šä¹‰å’Œé…ç½®ã€‚</li><li><code>setAttribute()</code> æ–¹æ³•ï¼šåœ¨ <code>HttpServletRequest</code> å¯¹è±¡ä¸­è®¾ç½®ä¸€äº›å±æ€§ï¼Œä»¥ä¾¿åç»­çš„å¤„ç†å¯ä»¥è®¿é—®è¿™äº›å±æ€§ã€‚è¿™é€šå¸¸ç”¨äºåœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ä¼ é€’æ•°æ®ã€‚</li><li><code>getThemeSource()</code> æ–¹æ³•ï¼šè·å–ä¸»é¢˜èµ„æºï¼Œä¸»é¢˜é€šå¸¸ç”¨äºå®šåˆ¶åº”ç”¨ç¨‹åºçš„å¤–è§‚ã€‚</li></ol></li><li><code>doDispatch()</code> æ–¹æ³•ï¼šåœ¨ <code>doService()</code> ä¸­ï¼Œ<code>DispatcherServlet</code> è°ƒç”¨ <code>doDispatch()</code> æ–¹æ³•ï¼Œè¿™æ˜¯å®é™…çš„è¯·æ±‚åˆ†å‘å’Œå¤„ç†çš„å…³é”®æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šè¿›è¡Œä»¥ä¸‹æ“ä½œï¼š<ol><li><code>getAsyncManager()</code> æ–¹æ³•ï¼šè·å–å¼‚æ­¥è¯·æ±‚ç®¡ç†å™¨ï¼Œç”¨äºå¤„ç†å¼‚æ­¥è¯·æ±‚ã€‚</li><li><code>checkMultipart()</code> æ–¹æ³•ï¼šæ£€æŸ¥è¯·æ±‚æ˜¯å¦åŒ…å«å¤šéƒ¨åˆ†ï¼ˆmultipartï¼‰å†…å®¹ï¼Œé€šå¸¸ç”¨äºæ–‡ä»¶ä¸Šä¼ ã€‚</li><li><code>getHandler()</code> æ–¹æ³•ï¼šè·å–ç”¨äºå¤„ç†è¯·æ±‚çš„å¤„ç†å™¨ï¼ˆHandlerï¼‰ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯å†³å®šå¦‚ä½•å¤„ç†è¯·æ±‚çš„å…³é”®ç‚¹ã€‚<ul><li><code>getHandlerMapping()</code> æ–¹æ³•ï¼šè·å–ç”¨äºæŸ¥æ‰¾å¤„ç†å™¨çš„Handler Mappingã€‚Handler Mapping æ ¹æ®è¯·æ±‚çš„URLæˆ–å…¶ä»–æ¡ä»¶ï¼Œå°†è¯·æ±‚æ˜ å°„åˆ°é€‚å½“çš„å¤„ç†å™¨æ–¹æ³•ã€‚</li><li>ä¸€æ—¦æ‰¾åˆ°äº†åˆé€‚çš„å¤„ç†å™¨ï¼Œå®ƒä¼šè¢«è¿”å›ï¼Œä»¥ä¾¿åç»­çš„è¯·æ±‚å¤„ç†ã€‚</li></ul></li></ol></li></ol><ul><li>ä¸‹é¢æ˜¯æˆ‘ä¸Šä¼ äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°è€—æ—¶ç»å¤§éƒ¨åˆ†éƒ½æ˜¯åœ¨checkMultipart()æ–¹æ³•ä¸Šï¼Œç­‰ä¸‹æ¬¡ä¸Šä¼ æ–‡ä»¶å¼‚å¸¸ç¼“æ…¢çš„æ—¶å€™ï¼Œå¯ä»¥ç»“åˆNginxæ—¥å¿—ä¸­çš„å“åº”è€—æ—¶å’Œè¿™é‡Œçš„è€—æ—¶æ¥åˆ†æåˆ°åº•æ˜¯å“ªä¸ªæ­¥éª¤æ…¢</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">`---ts=2023-09-07 11:00:24;thread_name=http-nio-80-exec-7;<span class="built_in">id</span>=35;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[725.449628ms] org.springframework.web.servlet.DispatcherServlet:doService()</span><br><span class="line">        +---[0.17% 1.209254ms ] org.springframework.web.servlet.DispatcherServlet:logRequest() <span class="comment">#926</span></span><br><span class="line">        |   `---[97.75% 1.182007ms ] org.springframework.web.servlet.DispatcherServlet:logRequest()</span><br><span class="line">        |       `---[6.82% 0.080573ms ] org.springframework.core.log.LogFormatUtils:traceDebug() <span class="comment">#980</span></span><br><span class="line">        +---[0.00% 0.014693ms ] org.springframework.web.util.WebUtils:isIncludeRequest() <span class="comment">#931</span></span><br><span class="line">        +---[0.00% 0.012721ms ] org.springframework.web.servlet.DispatcherServlet:getWebApplicationContext() <span class="comment">#943</span></span><br><span class="line">        +---[0.00% 0.016321ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#943</span></span><br><span class="line">        +---[0.00% 0.003773ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#944</span></span><br><span class="line">        +---[0.00% 0.005059ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#945</span></span><br><span class="line">        +---[0.01% 0.06607ms ] org.springframework.web.servlet.DispatcherServlet:getThemeSource() <span class="comment">#946</span></span><br><span class="line">        |   `---[62.24% 0.041121ms ] org.springframework.web.servlet.DispatcherServlet:getThemeSource()</span><br><span class="line">        |       `---[28.35% min=0.004431ms,max=0.007225ms,total=0.011656ms,count=2] org.springframework.web.servlet.DispatcherServlet:getWebApplicationContext() <span class="comment">#806</span></span><br><span class="line">        +---[0.00% 0.005496ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#946</span></span><br><span class="line">        +---[0.00% 0.021549ms ] org.springframework.web.servlet.FlashMapManager:retrieveAndUpdate() <span class="comment">#949</span></span><br><span class="line">        +---[0.00% 0.018169ms ] org.springframework.web.servlet.FlashMap:&lt;init&gt;() <span class="comment">#953</span></span><br><span class="line">        +---[0.00% 0.004453ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#953</span></span><br><span class="line">        +---[0.00% 0.007301ms ] javax.servlet.http.HttpServletRequest:setAttribute() <span class="comment">#954</span></span><br><span class="line">        +---[0.00% 0.010647ms ] javax.servlet.http.HttpServletRequest:getAttribute() <span class="comment">#959</span></span><br><span class="line">        +---[0.09% 0.633634ms ] org.springframework.web.util.ServletRequestPathUtils:parseAndCache() <span class="comment">#960</span></span><br><span class="line">        +---[99.66% 722.964056ms ] org.springframework.web.servlet.DispatcherServlet:doDispatch() <span class="comment">#964</span></span><br><span class="line">        |   `---[100.00% 722.939122ms ] org.springframework.web.servlet.DispatcherServlet:doDispatch()</span><br><span class="line">        |       +---[0.00% 0.011085ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#1036</span></span><br><span class="line">        |       +---[4.74% 34.255344ms ] org.springframework.web.servlet.DispatcherServlet:checkMultipart() <span class="comment">#1043</span></span><br><span class="line">        |       |   `---[99.94% 34.235142ms ] org.springframework.web.servlet.DispatcherServlet:checkMultipart()</span><br><span class="line">        |       |       +---[0.05% 0.017859ms ] org.springframework.web.multipart.MultipartResolver:isMultipart() <span class="comment">#1197</span></span><br><span class="line">        |       |       +---[0.03% 0.010256ms ] org.springframework.web.util.WebUtils:getNativeRequest() <span class="comment">#1198</span></span><br><span class="line">        |       |       +---[0.13% 0.046108ms ] org.springframework.web.servlet.DispatcherServlet:hasMultipartException() <span class="comment">#1203</span></span><br><span class="line">        |       |       |   `---[65.16% 0.030045ms ] org.springframework.web.servlet.DispatcherServlet:hasMultipartException()</span><br><span class="line">        |       |       |       `---[18.36% 0.005515ms ] javax.servlet.http.HttpServletRequest:getAttribute() <span class="comment">#1230</span></span><br><span class="line">        |       |       `---[99.65% 34.116944ms ] org.springframework.web.multipart.MultipartResolver:resolveMultipart() <span class="comment">#1209</span></span><br><span class="line">        |       +---[0.12% 0.836273ms ] org.springframework.web.servlet.DispatcherServlet:getHandler() <span class="comment">#1047</span></span><br><span class="line">        |       |   `---[96.10% 0.803643ms ] org.springframework.web.servlet.DispatcherServlet:getHandler()</span><br><span class="line">        |       |       `---[88.91% 0.714557ms ] org.springframework.web.servlet.HandlerMapping:getHandler() <span class="comment">#1265</span></span><br><span class="line">        |       +---[0.00% 0.011929ms ] org.springframework.web.servlet.HandlerExecutionChain:getHandler() <span class="comment">#1054</span></span><br><span class="line">        |       +---[0.01% 0.05063ms ] org.springframework.web.servlet.DispatcherServlet:getHandlerAdapter() <span class="comment">#1054</span></span><br><span class="line">        |       |   `---[63.99% 0.032397ms ] org.springframework.web.servlet.DispatcherServlet:getHandlerAdapter()</span><br><span class="line">        |       |       `---[37.22% 0.012058ms ] org.springframework.web.servlet.HandlerAdapter:supports() <span class="comment">#1301</span></span><br><span class="line">        |       +---[0.00% 0.008964ms ] javax.servlet.http.HttpServletRequest:getMethod() <span class="comment">#1057</span></span><br><span class="line">        |       +---[0.00% 0.017054ms ] org.springframework.http.HttpMethod:matches() <span class="comment">#1058</span></span><br><span class="line">        |       +---[0.00% 0.003344ms ] org.springframework.http.HttpMethod:matches() <span class="comment">#1059</span></span><br><span class="line">        |       +---[0.63% 4.578389ms ] org.springframework.web.servlet.HandlerExecutionChain:applyPreHandle() <span class="comment">#1066</span></span><br><span class="line">        |       +---[0.00% 0.005151ms ] org.springframework.web.servlet.HandlerExecutionChain:getHandler() <span class="comment">#1071</span></span><br><span class="line">        |       +---[94.22% 681.164697ms ] org.springframework.web.servlet.HandlerAdapter:handle() <span class="comment">#1071</span></span><br><span class="line">        |       +---[0.00% 0.022867ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1073</span></span><br><span class="line">        |       +---[0.01% 0.046345ms ] org.springframework.web.servlet.DispatcherServlet:applyDefaultViewName() <span class="comment">#1077</span></span><br><span class="line">        |       |   `---[19.75% 0.009155ms ] org.springframework.web.servlet.DispatcherServlet:applyDefaultViewName()</span><br><span class="line">        |       +---[0.00% 0.023564ms ] org.springframework.web.servlet.HandlerExecutionChain:applyPostHandle() <span class="comment">#1078</span></span><br><span class="line">        |       +---[0.02% 0.122935ms ] org.springframework.web.servlet.DispatcherServlet:processDispatchResult() <span class="comment">#1088</span></span><br><span class="line">        |       |   `---[76.98% 0.09464ms ] org.springframework.web.servlet.DispatcherServlet:processDispatchResult()</span><br><span class="line">        |       |       +---[24.65% 0.023328ms ] org.apache.commons.logging.Log:isTraceEnabled() <span class="comment">#1155</span></span><br><span class="line">        |       |       +---[16.65% 0.015762ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#1160</span></span><br><span class="line">        |       |       +---[6.36% 0.006018ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1160</span></span><br><span class="line">        |       |       `---[14.57% 0.013792ms ] org.springframework.web.servlet.HandlerExecutionChain:triggerAfterCompletion() <span class="comment">#1167</span></span><br><span class="line">        |       +---[0.00% 0.004283ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#1098</span></span><br><span class="line">        |       `---[0.23% 1.628707ms ] org.springframework.web.servlet.DispatcherServlet:cleanupMultipart() <span class="comment">#1107</span></span><br><span class="line">        |           `---[98.68% 1.607223ms ] org.springframework.web.servlet.DispatcherServlet:cleanupMultipart()</span><br><span class="line">        |               +---[0.50% 0.008005ms ] org.springframework.web.util.WebUtils:getNativeRequest() <span class="comment">#1248</span></span><br><span class="line">        |               `---[97.93% 1.574022ms ] org.springframework.web.multipart.MultipartResolver:cleanupMultipart() <span class="comment">#1250</span></span><br><span class="line">        +---[0.00% 0.009553ms ] org.springframework.web.context.request.async.WebAsyncUtils:getAsyncManager() <span class="comment">#967</span></span><br><span class="line">        +---[0.00% 0.006599ms ] org.springframework.web.context.request.async.WebAsyncManager:isConcurrentHandlingStarted() <span class="comment">#967</span></span><br><span class="line">        `---[0.01% 0.10787ms ] org.springframework.web.util.ServletRequestPathUtils:setParsedRequestPath() <span class="comment">#974</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†æç‰¹å®šæ–¹æ³•çš„è€—æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ˜ç¡®æŒ‡å®šä¸€ä¸‹ç±»çš„å…¨é™å®šåä»¥åŠæ–¹æ³•åå³å¯ï¼Œä¾‹å¦‚ <code>trace com.aimc.paperreduction.web.controller.CommonController uploadPaper</code>ï¼Œè¿™é‡Œæ˜¯åˆ†æCommonControlleråŒ…ä¸‹çš„<code>uploadPaper</code>æ–¹æ³•ï¼Œæ­£å¥½ä¹‹å‰åŠ äº†é˜¿é‡Œäº‘çš„æ–‡æœ¬æ£€æµ‹ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å¯¹æ€§èƒ½çš„å½±å“</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[arthas@7]$ trace com.aimc.paperreduction.web.controller.CommonController uploadPaper</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 2 , method count: 2) cost <span class="keyword">in</span> 292 ms, listenerId: 20</span><br><span class="line">`---ts=2023-09-07 11:45:12;thread_name=http-nio-80-exec-5;<span class="built_in">id</span>=33;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[931.752981ms] com.aimc.paperreduction.web.controller.CommonController$$EnhancerBySpringCGLIB$<span class="variable">$864d4ba2</span>:uploadPaper()</span><br><span class="line">        `---[99.94% 931.15232ms ] org.springframework.cglib.proxy.MethodInterceptor:intercept()</span><br><span class="line">            `---[97.68% 909.537879ms ] com.aimc.paperreduction.web.controller.CommonController:uploadPaper()</span><br><span class="line">                +---[0.02% 0.160456ms ] org.slf4j.Logger:info() <span class="comment">#221</span></span><br><span class="line">                +---[0.00% 0.043686ms ] org.springframework.web.multipart.MultipartFile:isEmpty() <span class="comment">#224</span></span><br><span class="line">                +---[99.91% 908.687093ms ] com.aimc.paperreduction.service.OrderService:uploadPaper() <span class="comment">#227</span></span><br><span class="line">                +---[0.00% 0.021838ms ] com.aimc.paperreduction.common.wrapper.Wrapper:getCode() <span class="comment">#228</span></span><br><span class="line">                +---[0.04% 0.325031ms ] org.slf4j.Logger:info() <span class="comment">#232</span></span><br><span class="line">                +---[0.00% 0.017715ms ] com.aimc.paperreduction.common.wrapper.Wrapper:getResult() <span class="comment">#233</span></span><br><span class="line">                `---[0.00% 0.028309ms ] com.aimc.paperreduction.web.controller.CommonController:success() <span class="comment">#233</span></span><br><span class="line"></span><br><span class="line">[arthas@7]$ trace  com.aimc.paperreduction.service.OrderService uploadPaper</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 4 , method count: 3) cost <span class="keyword">in</span> 659 ms, listenerId: 21</span><br><span class="line">`---ts=2023-09-07 11:46:32;thread_name=http-nio-80-exec-9;<span class="built_in">id</span>=37;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[871.142915ms] com.aimc.paperreduction.service.impl.OrderServiceImpl$$EnhancerBySpringCGLIB$<span class="variable">$a91e94c</span>:uploadPaper()</span><br><span class="line">        `---[99.98% 871.000878ms ] org.springframework.cglib.proxy.MethodInterceptor:intercept()</span><br><span class="line">            `---[99.99% 870.908438ms ] com.aimc.paperreduction.service.impl.OrderServiceImpl:uploadPaper()</span><br><span class="line">                +---[0.01% 0.049453ms ] com.aimc.paperreduction.common.wrapper.Wrapper:&lt;init&gt;() <span class="comment">#1243</span></span><br><span class="line">                +---[0.00% 0.010567ms ] org.springframework.web.multipart.MultipartFile:getOriginalFilename() <span class="comment">#1246</span></span><br><span class="line">                +---[0.01% 0.064652ms ] com.aimc.paperreduction.utils.StringUtil:extractPathExt() <span class="comment">#1246</span></span><br><span class="line">                +---[0.01% 0.099063ms ] com.aimc.paperreduction.utils.PathUtil:getRealDiskPath() <span class="comment">#1263</span></span><br><span class="line">                +---[0.81% 7.026517ms ] com.aimc.paperreduction.service.impl.OrderServiceImpl:transferToDisk() <span class="comment">#1264</span></span><br><span class="line">                +---[6.17% 53.694128ms ] com.aspose.words.Document:&lt;init&gt;() <span class="comment">#1272</span></span><br><span class="line">                +---[41.01% 357.150979ms ] com.aspose.words.Document:save() <span class="comment">#1274</span></span><br><span class="line">                +---[0.22% 1.918176ms ] com.aspose.words.Document:cleanup() <span class="comment">#1277</span></span><br><span class="line">                +---[0.00% 0.010126ms ] com.aimc.paperreduction.model.entity.PaperInfo:&lt;init&gt;() <span class="comment">#1284</span></span><br><span class="line">                +---[14.27% 124.293242ms ] com.aimc.paperreduction.utils.CommonUtil:countWords() <span class="comment">#1286</span></span><br><span class="line">                +---[34.64% 301.714162ms ] com.aimc.paperreduction.utils.CommonUtil:isGreenDoc() <span class="comment">#1287</span></span><br><span class="line">                +---[0.01% 0.05563ms ] org.apache.commons.lang3.StringUtils:isNotBlank() <span class="comment">#1288</span></span><br></pre></td></tr></table></figure><ul><li>ä»ä¸Šé¢çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œé˜¿é‡Œçš„æ–‡æœ¬æ£€æµ‹å äº†ä¸‰åˆ†ä¹‹ä¸€çš„æ—¶é•¿ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä½¿ç”¨traceå‘½ä»¤æ¥çœ‹ä¸ºä»€ä¹ˆè€—æ—¶è¿™ä¹ˆä¹…</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 233 ms, listenerId: 22</span><br><span class="line">`---ts=2023-09-07 11:49:51;thread_name=http-nio-80-exec-10;<span class="built_in">id</span>=38;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[294.261119ms] com.aimc.paperreduction.utils.CommonUtil:isGreenDoc()</span><br><span class="line">        +---[25.88% 76.155345ms ] org.apache.poi.xwpf.usermodel.XWPFDocument:&lt;init&gt;() <span class="comment">#1700</span></span><br><span class="line">        +---[0.00% 0.006894ms ] org.apache.poi.xwpf.usermodel.XWPFDocument:getParagraphs() <span class="comment">#1701</span></span><br><span class="line">        +---[0.44% min=0.001325ms,max=0.124972ms,total=1.306473ms,count=39] org.apache.poi.xwpf.usermodel.XWPFParagraph:getText() <span class="comment">#1702</span></span><br><span class="line">        +---[73.52% 216.339053ms ] com.aimc.paperreduction.utils.TextReview:textReview() <span class="comment">#1709</span></span><br><span class="line">        +---[0.00% 0.012255ms ] com.aimc.paperreduction.utils.TextReview:textReview() <span class="comment">#1715</span></span><br><span class="line">        `---[0.02% 0.048882ms ] org.apache.poi.xwpf.usermodel.XWPFDocument:close() <span class="comment">#1717</span></span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ°ä¸»è¦æ˜¯TextReviewè€—æ—¶è¾ƒé•¿ï¼ŒåŒæ—¶XWPFDocumentå¯¹è±¡çš„åˆ›å»ºä¹Ÿå¾ˆåƒæ€§èƒ½ï¼Œä»£ç ä¸­è¦é¿å…é¢‘ç¹åˆ›å»ºé”€æ¯æ­¤å¯¹è±¡ï¼Œç»§ç»­çœ‹TextReview</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[arthas@7]$ trace com.aimc.paperreduction.utils.TextReview textReview</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 202 ms, listenerId: 23</span><br><span class="line">`---ts=2023-09-07 11:53:18;thread_name=http-nio-80-exec-1;<span class="built_in">id</span>=2f;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@55634720</span><br><span class="line">    `---[209.523489ms] com.aimc.paperreduction.utils.TextReview:textReview()</span><br><span class="line">        +---[0.03% 0.0623ms ] org.apache.commons.lang3.StringUtils:isBlank() <span class="comment">#17</span></span><br><span class="line">        +---[0.01% 0.01229ms ] com.aliyun.teaopenapi.models.Config:&lt;init&gt;() <span class="comment">#21</span></span><br><span class="line">        +---[0.01% 0.011889ms ] com.aliyun.teaopenapi.models.Config:setAccessKeyId() <span class="comment">#22</span></span><br><span class="line">        +---[0.00% 0.007757ms ] com.aliyun.teaopenapi.models.Config:setAccessKeySecret() <span class="comment">#23</span></span><br><span class="line">        +---[0.00% 0.007802ms ] com.aliyun.teaopenapi.models.Config:setEndpoint() <span class="comment">#25</span></span><br><span class="line">        +---[0.00% 0.006391ms ] com.aliyun.teaopenapi.models.Config:setConnectTimeout() <span class="comment">#26</span></span><br><span class="line">        +---[0.00% 0.006966ms ] com.aliyun.teaopenapi.models.Config:setReadTimeout() <span class="comment">#27</span></span><br><span class="line">        +---[0.07% 0.154858ms ] com.aliyun.green20220302.Client:&lt;init&gt;() <span class="comment">#28</span></span><br><span class="line">        +---[0.01% 0.011248ms ] com.alibaba.fastjson.JSONObject:&lt;init&gt;() <span class="comment">#30</span></span><br><span class="line">        +---[0.01% 0.012672ms ] com.alibaba.fastjson.JSONObject:put() <span class="comment">#31</span></span><br><span class="line">        +---[0.01% 0.01861ms ] com.aliyun.green20220302.models.TextModerationRequest:&lt;init&gt;() <span class="comment">#33</span></span><br><span class="line">        +---[0.01% 0.012414ms ] com.aliyun.green20220302.models.TextModerationRequest:setService() <span class="comment">#34</span></span><br><span class="line">        +---[0.08% 0.160351ms ] com.alibaba.fastjson.JSONObject:toJSONString() <span class="comment">#35</span></span><br><span class="line">        +---[0.00% 0.009442ms ] com.aliyun.green20220302.models.TextModerationRequest:setServiceParameters() <span class="comment">#35</span></span><br><span class="line">        +---[99.33% 208.114925ms ] com.aliyun.green20220302.Client:textModeration() <span class="comment">#36</span></span><br><span class="line">        +---[0.01% 0.028103ms ] com.aliyun.green20220302.models.TextModerationResponse:getBody() <span class="comment">#37</span></span><br><span class="line">        +---[0.01% 0.013397ms ] com.aliyun.green20220302.models.TextModerationResponseBody:getCode() <span class="comment">#38</span></span><br><span class="line">        +---[0.01% 0.018539ms ] com.aliyun.green20220302.models.TextModerationResponseBody:getData() <span class="comment">#40</span></span><br><span class="line">        `---[0.02% 0.031569ms ] com.aliyun.green20220302.models.TextModerationResponseBody<span class="variable">$TextModerationResponseBodyData</span>:getLabels() <span class="comment">#41</span></span><br></pre></td></tr></table></figure><ul><li>å®šä½åˆ°ä»£ç ä¸­</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TextModerationResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.textModeration(textModerationRequest);</span><br></pre></td></tr></table></figure><ul><li>è¿™æ˜¯ä¸€ä¸ªåŒæ­¥è°ƒç”¨ï¼Œä¼šç­‰å¾…æœåŠ¡å™¨è¿”å›ç»“æœï¼Œç­‰å¾…æœŸé—´ä¼šé˜»å¡ï¼Œå¦‚æœæœåŠ¡ç«¯å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œè¿™ä¸ªä»£ç ä¼šå¯¼è‡´ç¨‹åºåœ¨è¿™é‡Œä¸€ç›´é˜»å¡ã€‚ä¼˜åŒ–æ–¹æ¡ˆå°±æ˜¯æŠŠè¿™é‡Œæ”¹æˆäº†å¼‚æ­¥å¤„ç†</li><li>å…¶å®è§£å†³å¾ˆç®€å•ï¼Œå…³é”®åœ¨äºæ€ä¹ˆå®šä½å¹¶æ‰¾åˆ°è§£å†³é—®é¢˜çš„æ–¹æ³•ï¼Œç‰¹æ„å†™äº†ç¯‡æ–‡ç« æ¥è®°å½•ä¸€ä¸‹</li></ul></li></ul>]]></content>
    
    
    <summary type="html">ä¹‹å‰é—²çš„æ—¶å€™ï¼Œè®©æˆ‘åˆ†æä¸€ä¸‹è€—æ—¶çš„é—®é¢˜ï¼Œç„¶åå°±æ‰¾åˆ°äº†Arthas</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="SpringBoot" scheme="https://cyborg2077.github.io/tags/SpringBoot/"/>
    
    <category term="Arthas" scheme="https://cyborg2077.github.io/tags/Arthas/"/>
    
    <category term="æ€§èƒ½åˆ†æ" scheme="https://cyborg2077.github.io/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>docker-composeæ­å»ºELK</title>
    <link href="https://cyborg2077.github.io/2023/09/02/DockerComposeELK/"/>
    <id>https://cyborg2077.github.io/2023/09/02/DockerComposeELK/</id>
    <published>2023-09-02T10:10:01.000Z</published>
    <updated>2023-10-01T13:43:47.505Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†™åœ¨æœ€å‰">å†™åœ¨æœ€å‰</h2><ul><li>æ—¢ç„¶éƒ½çœ‹åˆ°è¿™äº†ï¼Œé‚£è‚¯å®šéƒ½æ˜¯æœ‰åŸºç¡€çš„äº†ï¼Œç”±äºåœ¨ç½‘ä¸Šè²Œä¼¼æ²¡æ‰¾åˆ°docker-composeæ­å»ºELKçš„ï¼Œæœ‰çš„ä¹Ÿä¸å¤ªè§„èŒƒ<del>ï¼ˆè™½ç„¶æˆ‘ä¹Ÿä¸å’‹è§„èŒƒï¼‰</del>ï¼Œæˆ‘æœ€è¿‘åˆšå¥½ä¹Ÿéœ€è¦æ­å»ºä¸€ä¸ªELKï¼Œéšæ‰‹å†™ä¸€ä¸‹</li></ul><h2 id="åˆå§‹åŒ–ç¯å¢ƒ">åˆå§‹åŒ–ç¯å¢ƒ</h2><ul><li>æ ¹æ®ç›®å½•ç»“æ„åˆ›å»ºå¥½å¯¹åº”çš„æ–‡ä»¶</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ELK</span><br><span class="line">â”œâ”€â”€ docker-compose<span class="selector-class">.yml</span></span><br><span class="line">â”œâ”€â”€ elasticsearch</span><br><span class="line">â”‚   â”œâ”€â”€ data</span><br><span class="line">â”‚   â”œâ”€â”€ logs</span><br><span class="line">â”‚   â””â”€â”€ plugins</span><br><span class="line">â”œâ”€â”€ kibana</span><br><span class="line">â”‚   â””â”€â”€ config</span><br><span class="line">â”‚       â””â”€â”€ kibana<span class="selector-class">.yml</span></span><br><span class="line">â””â”€â”€ logstash</span><br><span class="line">    â”œâ”€â”€ config</span><br><span class="line">    â”‚   â””â”€â”€ logstash<span class="selector-class">.yml</span></span><br><span class="line">    â””â”€â”€ pipeline</span><br><span class="line">        â””â”€â”€ logstash.conf</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¾‘docker-compose-yml">ç¼–è¾‘docker-compose.yml</h2><ul><li>éœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯ä»–ä»¬ä¸‰ä¸ªè¦æ”¾åœ¨åŒä¸€ä¸ªnetworksé‡Œ</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch:7.17.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">network_elk_test</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">cluster.name:</span> <span class="string">elasticsearch</span></span><br><span class="line">      <span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line">      <span class="attr">ES_JAVA_OPTS:</span> <span class="string">&quot;-Xms512m -Xmx512m&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./elasticsearch/plugins:/usr/share/elasticsearch/plugins</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./elasticsearch/data:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./elasticsearch/logs:/usr/share/elasticsearch/logs</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kibana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kibana:7.17.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kibana</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">network_elk_test</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5601:5601&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">I18N_LOCALE:</span> <span class="string">zh-CN</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">logstash:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">logstash:7.17.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">logstash</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">network_elk_test</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;4560:4560&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logstash/pipeline/logstash.conf:/usr/share/logstash/pipeline/logstash.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">network_elk_test:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ELKTest</span></span><br></pre></td></tr></table></figure><h2 id="ç¼–è¾‘kibana-ymlæ–‡ä»¶">ç¼–è¾‘kibana.ymlæ–‡ä»¶</h2><ul><li>ç”±äºä»–ä»¬ä¸‰ä¸ªæ˜¯å¤„äºåŒä¸€ä¸ªnetworksä¸‹ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ä½¿ç”¨æœåŠ¡åæ¥äº’ç›¸è®¿é—®</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">server.shutdownTimeout:</span> <span class="string">&quot;5s&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [ <span class="string">&quot;http://elasticsearch:9200&quot;</span> ]</span><br><span class="line"><span class="attr">monitoring.ui.container.elasticsearch.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">server.publicBaseUrl:</span> <span class="string">&quot;http://kibana:5601&quot;</span></span><br></pre></td></tr></table></figure><h2 id="ç¼–è¾‘logstash-yml">ç¼–è¾‘logstash.yml</h2><ul><li>è¿™é‡ŒåŒæ ·æ˜¯ä½¿ç”¨æœåŠ¡åæ¥è®¿é—®esï¼Œç”±äºæˆ‘è¿™é‡Œæ­å»ºçš„æ˜¯7.xç‰ˆæœ¬ï¼Œæ‰€ä»¥è¦åŠ ä¸Šç¬¬ä¸‰è¡Œé‚£è¡Œé…ç½®ï¼Œå¦‚æœä½ æ­å»ºçš„æ˜¯7.xç‰ˆæœ¬ä¹‹å‰ï¼Œå¯ä»¥å¿½ç•¥ç¬¬ä¸‰è¡Œ</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.hosts:</span> [ <span class="string">&quot;http://elasticsearch:9200&quot;</span> ]</span><br><span class="line"><span class="attr">pipeline.ecs_compatibility:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><h2 id="ç¼–è¾‘logstash-conf">ç¼–è¾‘logstash.conf</h2><ul><li>è¿™é‡Œè¦æ³¨æ„ç´¢å¼•åçš„æ ¼å¼å•Šï¼ŒappNameæ˜¯è·å–spring.application.nameé‡Œçš„å€¼æ¥æ‹¼æ¥çš„ï¼Œåé¢æ˜¯åŠ ä¸Šæ—¥æœŸï¼Œæ¯ä¸€å¤©çš„æ¯ä¸€ä¸ªæœåŠ¡éƒ½æœ‰å¯¹åº”çš„æ—¥å¿—ï¼Œè¿™æ ·æ’æŸ¥é—®é¢˜æŸ¥æ—¥å¿—çš„æ—¶å€™éƒ½æ¯”è¾ƒæ–¹ä¾¿</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    mode =&gt; &quot;server&quot;</span><br><span class="line">    host =&gt; &quot;0.0.0.0&quot;</span><br><span class="line">    port =&gt; 4560</span><br><span class="line">    codec =&gt; json_lines</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; &quot;elasticsearch:9200&quot;</span><br><span class="line">    index =&gt; &quot;%&#123;appName&#125;-%&#123;+YYYY.MM.dd&#125;&quot;  #ç´¢å¼•å</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JavaæœåŠ¡å¯¼å…¥logstashä¾èµ–">JavaæœåŠ¡å¯¼å…¥logstashä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.logstash.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="åœ¨resourcesç›®å½•ä¸‹åˆ›å»ºlogback-spring-xml">åœ¨resourcesç›®å½•ä¸‹åˆ›å»ºlogback-spring.xml</h2><ul><li><a href="http://xn--logstashspring-fx7vk61edscs91c7lc945c13njw1i193ct25apgk.application.name">è¿™é‡Œä¸»è¦å°±æ˜¯æŒ‡å®šlogstashç«¯å£å’Œspring.application.name</a></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_HOME&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logs/demo.log&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">scope</span>=<span class="string">&quot;context&quot;</span> <span class="attr">name</span>=<span class="string">&quot;appName&quot;</span> <span class="attr">source</span>=<span class="string">&quot;spring.application.name&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;logstash&quot;</span> <span class="attr">class</span>=<span class="string">&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--æŒ‡å®šlogstashçš„ipåŠç«¯å£--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">destination</span>&gt;</span>XX.XX.XX.XX:4560<span class="tag">&lt;/<span class="name">destination</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;net.logstash.logback.encoder.LogstashEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">customFields</span>&gt;</span>&#123;&quot;spring.application.name&quot;:&quot;$&#123;appName&#125;&quot;&#125;<span class="tag">&lt;/<span class="name">customFields</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;logstash&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>é…ç½®å¥½äº†ï¼Œå¯åŠ¨æœåŠ¡ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæœåŠ¡å+å½“å‰æ—¥æœŸçš„ç´¢å¼•ï¼Œå»kibanaé‡Œå¯ä»¥çœ‹åˆ°</li></ul>]]></content>
    
    
    <summary type="html">éšå†™</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="ELK" scheme="https://cyborg2077.github.io/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”</title>
    <link href="https://cyborg2077.github.io/2023/09/02/FairRWLock/"/>
    <id>https://cyborg2077.github.io/2023/09/02/FairRWLock/</id>
    <published>2023-09-02T10:10:01.000Z</published>
    <updated>2023-10-01T13:43:47.524Z</updated>
    
    <content type="html"><![CDATA[<h2 id="éœ€æ±‚">éœ€æ±‚</h2><ul><li>é¡¹ç›®é‡Œæœ‰ä¸ªåœºæ™¯ï¼Œè¯»çš„å¹¶å‘å¾ˆå¤§ï¼Œä½†ä»…ä»…æ¶‰åŠåˆ°å¾ˆå°‘çš„å†™æ“ä½œã€‚é‚£ä¹ˆæ­¤æ—¶é‡‡ç”¨è¯»å†™é”å°±æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†æ˜¯é»˜è®¤çš„è¯»å†™é”æ˜¯éå…¬å¹³é”ï¼Œå¦‚æœè¯»å¹¶å‘å¾ˆå¤§ï¼Œå†™è¯·æ±‚åˆ°è¾¾æ—¶å¯èƒ½æŠ¢ä¸åˆ°é”ï¼Œæ‰€ä»¥æ­¤æ—¶éœ€è¦ä½¿ç”¨å…¬å¹³è¯»å†™é”ï¼Œä¸ºäº†æå‡å¤ç”¨æ€§ï¼Œé‡‡å–æ³¨è§£çš„å½¢å¼è¿›è¡Œå°è£…ã€‚</li><li>å¦‚æœä¸€ä¸ªclassçš„objectéœ€è¦è¿™ä¸ªèƒ½åŠ›ï¼ŒåŠ å…¥æ³¨è§£<code>@ReadWriteResource</code></li><li>å…·ä½“çš„å‡½æ•°ï¼Œå¦‚æœåŠ <code>@ReadOnlyOperator</code>æ³¨è§£ï¼Œé‚£ä¹ˆè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªè¯»ä»»åŠ¡ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼›</li><li>å¦‚æœåŠ <code>@WriteOperator</code>ï¼Œé‚£ä¹ˆè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå†™ä»»åŠ¡ï¼Œå’Œè¯»ä»»åŠ¡ã€å†™ä»»åŠ¡äº’æ–¥æ‰§è¡Œï¼›</li></ul><div class="note info no-icon flat"><ul><li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œéœ€è¦æ§åˆ¶é”ç²’åº¦ä¸ºå¯¹è±¡çº§åˆ«çš„é”ã€‚</li></ul></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç å¦‚ä¸‹</span></span><br><span class="line"><span class="meta">@ReadWriteResource</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ManagedResource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ReadOnlyOperator</span></span><br><span class="line">    String <span class="title function_">getResource</span><span class="params">(<span class="type">int</span> key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ReadOnlyOperator</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getName</span><span class="params">(<span class="type">int</span> key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@WriteOperator</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateResource</span><span class="params">(<span class="type">int</span> key, String resource)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h2><ul><li><p>é‡‡ç”¨æ³¨è§£+åŠ¨æ€ä»£ç†çš„æ–¹å¼æ¥å®ç°ï¼Œæ€è·¯å°±æ˜¯æ ¹æ®<code>@ReadWriteResource</code>åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦éœ€è¦åŠ¨æ€ä»£ç†ï¼Œç„¶åæ‹¦æˆªå¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œå‰ååŠ é”é‡Šæ”¾ã€‚</p><ol><li>é¦–å…ˆåˆ›å»ºä¸‰ä¸ªæ³¨è§£</li></ol>  <div class="tabs" id="æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-1">ReadWriteResource</button></li><li class="tab"><button type="button" data-href="#æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-2">ReadOnlyOperator</button></li><li class="tab"><button type="button" data-href="#æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-3">WriteOperator</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ReadWriteResource &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ReadOnlyOperator &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æ³¨è§£å°è£…å…¬å¹³è¯»å†™é”-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> WriteOperator &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ol start="2"><li>ç„¶åç¼–å†™ä¸€ä¸ªä»£ç†å·¥å‚ç±»ï¼Œç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œé¦–å…ˆåˆ¤æ–­å¯¹è±¡çš„Classæ˜¯å¦æœ‰<code>@ReadWriteResource</code>æ³¨è§£ï¼Œä»¥æ­¤åˆ¤æ–­æ˜¯å¦è¦ä¸ºè¯¥å¯¹è±¡åˆ›å»ºä»£ç†å¯¹è±¡</li></ol>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadWriteResourceProxyFactory</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">createProxy</span><span class="params">(T target)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = target.getClass();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è¯¥ç±»æ˜¯å¦æœ‰ReadWriteResourceæ³¨è§£</span></span><br><span class="line">        <span class="type">ReadWriteResource</span> <span class="variable">annotation</span> <span class="operator">=</span> clazz.getAnnotation(ReadWriteResource.class);</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰æ³¨è§£ï¼Œåˆ™åˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œå¹¶ä¸éœ€è¦å°†targetå¯¹è±¡ä¼ å…¥ï¼Œå› ä¸ºæ‹¦æˆªå™¨æ‹¦æˆªçš„æ˜¯ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯ç›®æ ‡å¯¹è±¡æœ¬èº«</span></span><br><span class="line">            <span class="type">ReadWriteResourceInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReadWriteResourceInterceptor</span>();</span><br><span class="line">            <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">            enhancer.setSuperclass(clazz);</span><br><span class="line">            enhancer.setCallback(interceptor);</span><br><span class="line">            <span class="keyword">return</span> (T) enhancer.create();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æ³¨è§£ï¼Œç›´æ¥è¿”å›åŸå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>æ„é€ å‡½æ•°å…ˆä¸ºå¯¹è±¡åˆå§‹åŒ–è¯»å†™é”ï¼Œæ‹¦æˆªé€»è¾‘ä¸­åˆ¤æ–­æ–¹æ³•ä¸Šæ˜¯å¦å­˜åœ¨<code>@ReadOnlyOperator</code>æˆ–<code>WriteOperator</code>æ³¨è§£ï¼Œæ¥ç¡®å®šæ˜¯è¯»æ“ä½œè¿˜æ˜¯å†™æ“ä½œï¼Œç„¶ååŠ ä¸Šå¯¹åº”çš„é”ã€‚</li></ol>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadWriteResourceInterceptor</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock readLock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock writeLock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReadWriteResourceInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ReentrantReadWriteLock</span> <span class="variable">readWriteLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">this</span>.readLock = readWriteLock.readLock();</span><br><span class="line">        <span class="built_in">this</span>.writeLock = readWriteLock.writeLock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ReadOnlyOperator</span> <span class="variable">readOnlyOperatorAnnotation</span> <span class="operator">=</span> method.getAnnotation(ReadOnlyOperator.class);</span><br><span class="line">        <span class="type">WriteOperator</span> <span class="variable">writeOperatorAnnotation</span> <span class="operator">=</span> method.getAnnotation(WriteOperator.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (readOnlyOperatorAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœåŒ…å«ReadOnlyOperatoræ³¨è§£ï¼ŒåŠ è¯»é”</span></span><br><span class="line">            readLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡ŒåŸæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾è¯»é”</span></span><br><span class="line">                readLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (writeOperatorAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœåŒ…å«WriteOperatoræ³¨è§£ï¼ŒåŠ å†™é”</span></span><br><span class="line">            writeLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡ŒåŸæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾å†™é”</span></span><br><span class="line">                writeLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ²¡åŠ æ³¨è§£çš„æ™®é€šæ–¹æ³•ï¼Œè¿”å›ç›´æ¥è°ƒç”¨åŸæ–¹æ³•</span></span><br><span class="line">            <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>åŸºæœ¬ä½¿ç”¨ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼Œæµ‹è¯•çš„æ—¶å€™å¯ä»¥åœ¨æ—¥å¿—ä¸­æ‰“å°å‡ºè¯»å†™é”åœ°å€</li></ol>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ReadWriteResourceProxyFactory&lt;ManagedResource&gt; proxyFactory = <span class="keyword">new</span> <span class="title class_">ReadWriteResourceProxyFactory</span>&lt;&gt;();</span><br><span class="line"><span class="type">ManagedResource</span> <span class="variable">proxy</span> <span class="operator">=</span> proxyFactory.createProxy(<span class="keyword">new</span> <span class="title class_">ManagedResource</span>());</span><br><span class="line">proxy.getName();</span><br><span class="line">proxy.updateResource();</span><br></pre></td></tr></table></figure><ul><li>å†™å®Œäº†æ‰“åŒ…ä¸Šä¼ è‡³mavenç§æœï¼Œä»¥åå°±æ˜¯å°è£…è‡ªå·±çš„å·¥å…·ç±»äº†</li></ul></li></ul><h2 id="AOPå®ç°">AOPå®ç°</h2><ul><li>ä¹‹å‰å…¶å®é‡‡ç”¨çš„æ˜¯æ³¨è§£+AOPæ¥å°è£…çš„ï¼Œç„¶åå†™ç€å†™ç€å°±å‘ç°äº†ç‚¹é—®é¢˜ï¼Œè¿™é‡Œä¹Ÿæ¥å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹å§ã€‚</li><li>é¦–å…ˆæ³¨è§£æ–¹é¢æ²¡æœ‰å˜åŒ–ï¼Œä¸è¿‡æˆ‘æ²¡ç”¨åˆ°<code>@ReadWriteResource</code>æ³¨è§£ï¼Œå› ä¸ºæ‰¾åˆ‡ç‚¹çš„æ—¶å€™å¯ä»¥ç›´æ¥æ ¹æ®æ–¹æ³•ä¸Šæ˜¯å¦æœ‰<code>@ReadOnlyOperator</code>å’Œ<code>@WriteOperator</code>æ¥åˆ¤æ–­ã€‚</li><li>AOPçš„é€»è¾‘å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜å¤©æ›´</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å·¥ä½œéœ€è¦é€ äº†ä¸ªå°è½®å­</summary>
    
    
    
    <category term="éšå†™" scheme="https://cyborg2077.github.io/categories/%E9%9A%8F%E5%86%99/"/>
    
    
    <category term="Java" scheme="https://cyborg2077.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨æ•°æ®åº“ä¸­å­˜å‚¨æ ‘çŠ¶ç»“æ„</title>
    <link href="https://cyborg2077.github.io/2023/07/21/StoringTreeInDatabases/"/>
    <id>https://cyborg2077.github.io/2023/07/21/StoringTreeInDatabases/</id>
    <published>2023-07-21T11:29:46.000Z</published>
    <updated>2023-10-01T15:43:00.832Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜">é—®é¢˜</h2><ul><li>å®é™…å¼€å‘ä¸­å¾ˆå¤šåœ°æ–¹éƒ½éœ€è¦å­˜å‚¨æ ‘çŠ¶ç»“æ„ï¼Œä¾‹å¦‚ç»„ç»‡æ¶æ„ä¸­éœ€è¦ç”¨æ ‘çŠ¶ç»“æ„æ¥è¡¨ç¤ºå…¬å¸å‘˜å·¥ä¹‹é—´çš„å±‚çº§å…³ç³»ã€ç”µå•†ç½‘ç«™ä¸­ç”¨æ ‘çŠ¶ç»“æ„æ¥ç»„ç»‡å•†å“åˆ†ç±»ã€è®ºå›å¸–å­æˆ–è€…è¯„è®ºä¸­å¯ä»¥é€šè¿‡å›å¤æ¥æ„æˆæ ‘çŠ¶ç»“æ„ã€‚</li><li>å‡è®¾ç°åœ¨è¦å­˜å‚¨ä¸€ä¸‹å…¬å¸çš„äººå‘˜ç»“æ„ï¼Œå¤§æ¦‚å±‚æ¬¡å¦‚ä¸‹<br><img src="https://s1.ax1x.com/2023/07/21/pCb6A4f.png" alt=""></li><li>æ€ä¹ˆå­˜å‚¨è¿™ä¸ªç»“æ„ï¼Ÿå¹¶ä¸”è¦è·å–ä»¥ä¸‹ä¿¡æ¯<ol><li>æŸ¥è¯¢å°å¤©çš„ç›´æ¥ä¸Šå¸ï¼›</li><li>æŸ¥è¯¢è€å®‹ç®¡ç†ä¸‹çš„ç›´å±å‘˜å·¥ï¼›</li><li>æŸ¥è¯¢å°å¤©çš„æ‰€æœ‰ä¸Šå¸ï¼›</li><li>æŸ¥è¯¢è€ç‹ç®¡ç†çš„æ‰€æœ‰å‘˜å·¥ã€‚</li></ol></li></ul><h2 id="æ–¹æ¡ˆä¸€-Adjacency-Listï¼ˆå­˜å‚¨çˆ¶èŠ‚ç‚¹ï¼‰">æ–¹æ¡ˆä¸€ Adjacency Listï¼ˆå­˜å‚¨çˆ¶èŠ‚ç‚¹ï¼‰</h2><h3 id="æ•°æ®åº“å­˜å‚¨ç»“æ„">æ•°æ®åº“å­˜å‚¨ç»“æ„</h3><ul><li></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for employees</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `employees`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `employees`  (</span><br><span class="line">  `eid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¸»é”®ID&#x27;</span>,</span><br><span class="line">  `ename` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;å§“å&#x27;</span>,</span><br><span class="line">  `position` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä½ç½®&#x27;</span>,</span><br><span class="line">  `parent_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¸Šçº§ID&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`eid`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of employees</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;è€ç‹&#x27;</span>, <span class="string">&#x27;é«˜ç®¡&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;è€å®‹&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨ä¸»ç®¡&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;è€ç‰›&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨ä¸»ç®¡&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;å°å´&#x27;</span>, <span class="string">&#x27;äº§å“Aç»„é•¿&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">&#x27;å°æ&#x27;</span>, <span class="string">&#x27;äº§å“Bç»„é•¿&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="string">&#x27;å°æ¬¢&#x27;</span>, <span class="string">&#x27;äº§å“ç»ç†&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="string">&#x27;å°å°&#x27;</span>, <span class="string">&#x27;äº§å“ç»ç†&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="string">&#x27;å°å¤©&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="string">&#x27;å°é‡Œ&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="string">&#x27;å°é»‘&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">11</span>, <span class="string">&#x27;å°èƒ¡&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">12</span>, <span class="string">&#x27;å°ä¸½&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">13</span>, <span class="string">&#x27;å°è“&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">14</span>, <span class="string">&#x27;å°é»„&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees` <span class="keyword">VALUES</span> (<span class="number">15</span>, <span class="string">&#x27;å°çœŸ&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>, <span class="number">7</span>);   </span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:center">eid</th><th style="text-align:center">ename</th><th style="text-align:center">position</th><th style="text-align:center">parent_id</th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center">è€ç‹</td><td style="text-align:center">é«˜ç®¡</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">è€å®‹</td><td style="text-align:center">äº§å“éƒ¨ä¸»ç®¡</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">è€ç‰›</td><td style="text-align:center">æŠ€æœ¯éƒ¨ä¸»ç®¡</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">å°å´</td><td style="text-align:center">äº§å“Aç»„é•¿</td><td style="text-align:center">2</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">å°æ</td><td style="text-align:center">äº§å“Bç»„é•¿</td><td style="text-align:center">2</td></tr><tr><td style="text-align:center">6</td><td style="text-align:center">å°æ¬¢</td><td style="text-align:center">äº§å“ç»ç†</td><td style="text-align:center">3</td></tr><tr><td style="text-align:center">7</td><td style="text-align:center">å°å°</td><td style="text-align:center">äº§å“ç»ç†</td><td style="text-align:center">3</td></tr><tr><td style="text-align:center">8</td><td style="text-align:center">å°å¤©</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td><td style="text-align:center">4</td></tr><tr><td style="text-align:center">9</td><td style="text-align:center">å°é‡Œ</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td><td style="text-align:center">4</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">å°é»‘</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td><td style="text-align:center">5</td></tr><tr><td style="text-align:center">11</td><td style="text-align:center">å°èƒ¡</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td><td style="text-align:center">5</td></tr><tr><td style="text-align:center">12</td><td style="text-align:center">å°ä¸½</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td><td style="text-align:center">6</td></tr><tr><td style="text-align:center">13</td><td style="text-align:center">å°è“</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td><td style="text-align:center">6</td></tr><tr><td style="text-align:center">14</td><td style="text-align:center">å°é»„</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td><td style="text-align:center">7</td></tr><tr><td style="text-align:center">15</td><td style="text-align:center">å°çœŸ</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td><td style="text-align:center">7</td></tr></tbody></table><h3 id="SQLç¤ºä¾‹">SQLç¤ºä¾‹</h3><h4 id="æ·»åŠ èŠ‚ç‚¹">æ·»åŠ èŠ‚ç‚¹</h4><ul><li>ä¾‹å¦‚æˆ‘è¦åœ¨å°å´ä¸‹æ·»åŠ ä¸€ä¸ªå‘˜å·¥</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> employees(eid, ename, position, parent_id) </span><br><span class="line"><span class="keyword">VALUES</span>(<span class="number">16</span>, <span class="string">&#x27;å°é­&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢å°å¤©çš„ç›´æ¥ä¸Šå¸">æŸ¥è¯¢å°å¤©çš„ç›´æ¥ä¸Šå¸</h4><ul><li>æ–¹å¼ä¸€</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.eid, e1.ename</span><br><span class="line"><span class="keyword">FROM</span> employees e1, employees e2</span><br><span class="line"><span class="keyword">WHERE</span> e1.eid <span class="operator">=</span> e2.parent_id</span><br><span class="line"><span class="keyword">AND</span> e2.ename <span class="operator">=</span> <span class="string">&#x27;å°å¤©&#x27;</span></span><br></pre></td></tr></table></figure><ul><li>æ–¹å¼äºŒ</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> eid, ename</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> eid <span class="operator">=</span> (<span class="keyword">SELECT</span> parent_id <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> ename <span class="operator">=</span> <span class="string">&#x27;å°å¤©&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>è™½ç„¶ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥æŸ¥è¯¢ï¼Œä½†æ˜¯æ¨èä½¿ç”¨æ–¹å¼ä¸€æ¥è¿›è¡ŒæŸ¥è¯¢ã€‚å› ä¸ºæ–¹å¼äºŒä½¿ç”¨äº†å­æŸ¥è¯¢ï¼Œæ¯æ¬¡è¿è¡Œå¤–éƒ¨æŸ¥è¯¢æ—¶ï¼Œéƒ½éœ€è¦é‡æ–°è®¡ç®—å­æŸ¥è¯¢ï¼Œå¦‚æœå­æŸ¥è¯¢ä¸­è¿”å›äº†å¤§é‡çš„æ•°æ®ï¼Œä¼šå¯¼è‡´æŸ¥è¯¢æ•ˆç‡ä½ä¸‹ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ–¹å¼ä¸€çš„æŸ¥è¯¢æ•ˆç‡ä¼šæ›´é«˜ã€‚</li></ul><h4 id="æŸ¥è¯¢è€å®‹çš„ç›´å±å‘˜å·¥">æŸ¥è¯¢è€å®‹çš„ç›´å±å‘˜å·¥</h4><ul><li>è¿™æ¬¡æˆ‘å°±ä¸å†™å­æŸ¥è¯¢çš„æ–¹å¼äº†</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e2.eid, e2.ename </span><br><span class="line"><span class="keyword">FROM</span> employees e1, employees e2</span><br><span class="line"><span class="keyword">WHERE</span> e2.parent_id <span class="operator">=</span> e1.eid</span><br><span class="line"><span class="keyword">AND</span> e1.ename <span class="operator">=</span> <span class="string">&#x27;è€å®‹&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢å°å¤©çš„æ‰€æœ‰ä¸Šå¸">æŸ¥è¯¢å°å¤©çš„æ‰€æœ‰ä¸Šå¸</h4><ul><li>åœ¨MySQL8.0ä»¥åçš„ç‰ˆæœ¬ï¼Œä½¿ç”¨é€’å½’CTEå¯ä»¥è½»æ¾å®ç°</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> Leader <span class="keyword">AS</span> (</span><br><span class="line"><span class="keyword">SELECT</span> eid, ename, position, parent_id </span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> ename <span class="operator">=</span> <span class="string">&#x27;å°å¤©&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span> </span><br><span class="line"><span class="keyword">SELECT</span> e.eid, e.ename, e.position, e.parent_id </span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Leader l</span><br><span class="line"><span class="keyword">ON</span> e.eid <span class="operator">=</span> l.parent_id</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> eid, ename, position <span class="keyword">FROM</span> Leader </span><br></pre></td></tr></table></figure><ul><li>ä½†æ˜¯MySQL8.0ä¹‹å‰æ²¡æœ‰CTEï¼Œåªèƒ½å†™ä¸ªå‡½æ•°ï¼Œç”¨å¾ªç¯è¿›è¡Œå¾ªç¯æŸ¥è¯¢ï¼Œå…ˆæŸ¥ç›´æ¥ä¸Šå¸ï¼Œå†æŸ¥ç›´æ¥ä¸Šå¸çš„ç›´æ¥ä¸Šå¸ï¼Œå®ç°èµ·æ¥å¾ˆéº»çƒ¦ï¼Œå¹¶ä¸”è¿”å›çš„ç»“æœä¹Ÿä¸èƒ½æ˜¯ä¸€å¼ è¡¨</li></ul><h4 id="æŸ¥è¯¢è€ç‹çš„æ‰€æœ‰å‘˜å·¥">æŸ¥è¯¢è€ç‹çš„æ‰€æœ‰å‘˜å·¥</h4><ul><li>è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨é€’å½’CTEæŸ¥è¯¢</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> Emp <span class="keyword">AS</span> (</span><br><span class="line"><span class="keyword">SELECT</span> eid, ename, position, parent_id </span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> ename <span class="operator">=</span> <span class="string">&#x27;è€ç‹&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> e.eid, e.ename, e.position, e.parent_id </span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Emp emp </span><br><span class="line"><span class="keyword">ON</span> e.parent_id <span class="operator">=</span> emp.eid</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> eid, ename, position <span class="keyword">FROM</span> Emp </span><br></pre></td></tr></table></figure><h2 id="æ–¹æ¡ˆäºŒ-Path-Enumerationï¼ˆå­˜å‚¨è·¯å¾„ï¼‰">æ–¹æ¡ˆäºŒ Path Enumerationï¼ˆå­˜å‚¨è·¯å¾„ï¼‰</h2><ul><li>Path Enumeration è·¯å¾„æšä¸¾æ³•ï¼Œå­˜å‚¨æ ¹èŠ‚ç‚¹åˆ°æ¯ä¸ªå­èŠ‚ç‚¹çš„è·¯å¾„</li></ul><h3 id="æ•°æ®åº“å­˜å‚¨ç»“æ„-2">æ•°æ®åº“å­˜å‚¨ç»“æ„</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for employees2</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `employees2`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `employees2`  (</span><br><span class="line">  `eid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¸»é”®ID&#x27;</span>,</span><br><span class="line">  `ename` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;å§“å&#x27;</span>,</span><br><span class="line">  `position` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä½ç½®&#x27;</span>,</span><br><span class="line">  `path` <span class="type">varchar</span>(<span class="number">200</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;æ‰€åœ¨è·¯å¾„&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`eid`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of employees2</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;è€ç‹&#x27;</span>, <span class="string">&#x27;é«˜ç®¡&#x27;</span>, <span class="string">&#x27;/1&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;è€å®‹&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨ä¸»ç®¡&#x27;</span>, <span class="string">&#x27;/1/2&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;è€ç‰›&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨ä¸»ç®¡&#x27;</span>, <span class="string">&#x27;/1/3&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;å°å´&#x27;</span>, <span class="string">&#x27;äº§å“Aç»„é•¿&#x27;</span>, <span class="string">&#x27;/1/2/4&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">&#x27;å°æ&#x27;</span>, <span class="string">&#x27;äº§å“Bç»„é•¿&#x27;</span>, <span class="string">&#x27;/1/2/5&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="string">&#x27;å°æ¬¢&#x27;</span>, <span class="string">&#x27;äº§å“ç»ç†&#x27;</span>, <span class="string">&#x27;/1/3/6&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="string">&#x27;å°å°&#x27;</span>, <span class="string">&#x27;äº§å“ç»ç†&#x27;</span>, <span class="string">&#x27;/1/3/7&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="string">&#x27;å°å¤©&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>, <span class="string">&#x27;/1/2/4/8&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="string">&#x27;å°é‡Œ&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>, <span class="string">&#x27;/1/2/4/9&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="string">&#x27;å°é»‘&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>, <span class="string">&#x27;/1/2/5/10&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">11</span>, <span class="string">&#x27;å°èƒ¡&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>, <span class="string">&#x27;/1/2/5/11&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">12</span>, <span class="string">&#x27;å°ä¸½&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>, <span class="string">&#x27;/1/3/6/12&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">13</span>, <span class="string">&#x27;å°è“&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>, <span class="string">&#x27;/1/3/6/13&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">14</span>, <span class="string">&#x27;å°é»„&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>, <span class="string">&#x27;/1/3/7/14&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` <span class="keyword">VALUES</span> (<span class="number">15</span>, <span class="string">&#x27;å°çœŸ&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>, <span class="string">&#x27;/1/3/7/15&#x27;</span>);</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:center">eid</th><th style="text-align:center">ename</th><th style="text-align:center">position</th><th style="text-align:center">parent_id</th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center">è€ç‹</td><td style="text-align:center">é«˜ç®¡</td><td style="text-align:center">/1</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">è€å®‹</td><td style="text-align:center">äº§å“éƒ¨ä¸»ç®¡</td><td style="text-align:center">/1/2</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">è€ç‰›</td><td style="text-align:center">æŠ€æœ¯éƒ¨ä¸»ç®¡</td><td style="text-align:center">/1/3</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">å°å´</td><td style="text-align:center">äº§å“Aç»„é•¿</td><td style="text-align:center">/1/2/4</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">å°æ</td><td style="text-align:center">äº§å“Bç»„é•¿</td><td style="text-align:center">/1/2/5</td></tr><tr><td style="text-align:center">6</td><td style="text-align:center">å°æ¬¢</td><td style="text-align:center">äº§å“ç»ç†</td><td style="text-align:center">/1/3/6</td></tr><tr><td style="text-align:center">7</td><td style="text-align:center">å°å°</td><td style="text-align:center">äº§å“ç»ç†</td><td style="text-align:center">/1/3/7</td></tr><tr><td style="text-align:center">8</td><td style="text-align:center">å°å¤©</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td><td style="text-align:center">/1/2/4/8</td></tr><tr><td style="text-align:center">9</td><td style="text-align:center">å°é‡Œ</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td><td style="text-align:center">/1/2/4/9</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">å°é»‘</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td><td style="text-align:center">/1/2/5/10</td></tr><tr><td style="text-align:center">11</td><td style="text-align:center">å°èƒ¡</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td><td style="text-align:center">/1/2/5/11</td></tr><tr><td style="text-align:center">12</td><td style="text-align:center">å°ä¸½</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td><td style="text-align:center">/1/3/6/12</td></tr><tr><td style="text-align:center">13</td><td style="text-align:center">å°è“</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td><td style="text-align:center">/1/3/6/13</td></tr><tr><td style="text-align:center">14</td><td style="text-align:center">å°é»„</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td><td style="text-align:center">/1/3/7/14</td></tr><tr><td style="text-align:center">15</td><td style="text-align:center">å°çœŸ</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td><td style="text-align:center">/1/3/7/15</td></tr><tr><td style="text-align:center">16</td><td style="text-align:center">å°é­</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td><td style="text-align:center">/1/2/4/16</td></tr></tbody></table><h3 id="SQLç¤ºä¾‹-2">SQLç¤ºä¾‹</h3><h4 id="æ·»åŠ èŠ‚ç‚¹-2">æ·»åŠ èŠ‚ç‚¹</h4><ul><li>ä¾æ—§æ˜¯åœ¨å°å´èŠ‚ç‚¹æ’å…¥ä¸€ä¸ªä¸‹å±å‘˜å·¥</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. æ’å…¥ä¸‹å±å‘˜å·¥å°é­ï¼Œeidä¸º16ï¼ŒæŸ¥è¯¢çˆ¶çº§èŠ‚ç‚¹pathï¼Œæ‹¼æ¥å°é­çš„path</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees2` (`eid`, `ename`, `position`, `path`)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">16</span> <span class="keyword">AS</span> eid, <span class="string">&#x27;å°é­&#x27;</span> <span class="keyword">AS</span> ename, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span> <span class="keyword">AS</span> position, CONCAT(path, <span class="string">&#x27;/16&#x27;</span>) <span class="keyword">AS</span> path</span><br><span class="line"><span class="keyword">FROM</span> `employees2`</span><br><span class="line"><span class="keyword">WHERE</span> ename <span class="operator">=</span> <span class="string">&#x27;å°å´&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢å°å¤©çš„ç›´æ¥ä¸Šå¸-2">æŸ¥è¯¢å°å¤©çš„ç›´æ¥ä¸Šå¸</h4><ul><li>åœ¨ä¸Šä¸€ä¸ªè§£å†³æ–¹æ¡ˆä¸­èƒ½è½»æ˜“åšåˆ°çš„äº‹æƒ…ï¼Œåœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­å´æœ‰äº›éº»çƒ¦äº†ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å¯¹pathå­—æ®µåšå¤„ç†ï¼Œå»æ‰<code>/</code> + <code>è‡ªèº«id</code> ä¹‹åæ‰æ˜¯ä¸Šå¸pathçš„å€¼ï¼Œä¾‹å¦‚å°å¤©çš„pathæ˜¯<code>/1/2/4/8</code>ï¼Œå°å¤©çš„eidæ˜¯8ï¼Œé‚£ä¹ˆä¸Šå¸idå°±éœ€è¦å»æ‰<code>/8</code>ï¼Œä¸º<code>/1/2/4</code></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.eid,e1.ename,e1.position </span><br><span class="line"><span class="keyword">FROM</span> employees2 e1,employees2 e2 </span><br><span class="line"><span class="keyword">WHERE</span>e2.ename <span class="operator">=</span> <span class="string">&#x27;å°å¤©&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> e1.path <span class="operator">=</span> REPLACE (e2.path,CONCAT( <span class="string">&#x27;/&#x27;</span>, e2.eid ), <span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢è€å®‹çš„ç›´å±å‘˜å·¥-2">æŸ¥è¯¢è€å®‹çš„ç›´å±å‘˜å·¥</h4><ul><li>è¿™é‡Œæ³¨æ„æ˜¯æŸ¥è¯¢ç›´å±å‘˜å·¥ï¼Œè€Œä¸æ˜¯æ‰€æœ‰å‘˜å·¥ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨LIKEæ¥æ¨¡ç³ŠåŒ¹é…ï¼Œè€Œæ˜¯éœ€è¦ä½¿ç”¨æ­£åˆ™æ¥åŒ¹é…å•ä¸ªå±‚çº§</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.eid, e1.ename, e1.position</span><br><span class="line"><span class="keyword">FROM</span> employees2 e1, employees2 e2</span><br><span class="line"><span class="keyword">WHERE</span> e2.ename <span class="operator">=</span> <span class="string">&#x27;è€å®‹&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> e1.path REGEXP CONCAT(e2.path, <span class="string">&#x27;/[0-9]&#123;1,&#125;$&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>ä½†æ˜¯å¦‚æœæƒ³ä½¿ç”¨LIKEåšæ¨¡ç³ŠåŒ¹é…ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œå¯ä»¥å¢åŠ ä¸€ä¸ªlevelå­—æ®µï¼Œç”¨äºè¡¨ç¤ºå±‚çº§ã€‚<ul><li>ä¾‹å¦‚è€ç‹çš„levelæ˜¯1ï¼Œè€å®‹çš„levelæ˜¯2ï¼Œè€å®‹çš„ç›´å±å‘˜å·¥çš„levelå°±æ˜¯3ï¼Œä»¥æ­¤ç±»æ¨ï¼Œåœ¨æ„å»ºæŸ¥è¯¢è¯­å¥çš„æ—¶å€™é¢å¤–åˆ¤å®šä¸€ä¸‹levelå°±å¥½äº†</li></ul></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.eid, e1.ename, e1.position</span><br><span class="line"><span class="keyword">FROM</span> employees2 e1, employees2 e2</span><br><span class="line"><span class="keyword">WHERE</span> e2.ename <span class="operator">=</span> <span class="string">&#x27;è€å®‹&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> e1.path <span class="keyword">LIKE</span> CONCAT(e2.path, <span class="string">&#x27;/%&#x27;</span>)</span><br><span class="line"><span class="keyword">AND</span> e1.level <span class="operator">=</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢å°å¤©çš„æ‰€æœ‰ä¸Šå¸-2">æŸ¥è¯¢å°å¤©çš„æ‰€æœ‰ä¸Šå¸</h4><ul><li>æŸ¥è¯¢æ‰€æœ‰ä¸Šå¸æˆ–è€…æ‰€æœ‰å‘˜å·¥çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä½¿ç”¨LIKEåšæ¨¡ç³ŠåŒ¹é…</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.eid, e1.ename, e1.position</span><br><span class="line"><span class="keyword">FROM</span> employees2 e1, employees2 e2</span><br><span class="line"><span class="keyword">WHERE</span> e2.ename <span class="operator">=</span> <span class="string">&#x27;å°å¤©&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> e2.path <span class="keyword">LIKE</span> CONCAT(e1.path, <span class="string">&#x27;/%&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢è€ç‹çš„æ‰€æœ‰å‘˜å·¥-2">æŸ¥è¯¢è€ç‹çš„æ‰€æœ‰å‘˜å·¥</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.eid, e1.ename, e1.position</span><br><span class="line"><span class="keyword">FROM</span> employees2 e1, employees2 e2</span><br><span class="line"><span class="keyword">WHERE</span> e2.ename <span class="operator">=</span> <span class="string">&#x27;è€ç‹&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> e1.path <span class="keyword">LIKE</span> CONCAT(e2.path, <span class="string">&#x27;/%&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ¡ˆä¸‰-Closure-Table-å­˜å‚¨å…³ç³»è¡¨å’Œæ·±åº¦">æ–¹æ¡ˆä¸‰ Closure Table(å­˜å‚¨å…³ç³»è¡¨å’Œæ·±åº¦)</h2><ul><li>ä¿å­˜æ¯ä¸ªèŠ‚ç‚¹ä¸å…¶å„ä¸ªå­èŠ‚ç‚¹çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è®°å½•ä»¥å…¶ä¸ºæ ¹èŠ‚ç‚¹çš„å…¨éƒ¨å­èŠ‚ç‚¹ä¿¡æ¯ã€‚</li></ul><h3 id="æ•°æ®åº“å­˜å‚¨ç»“æ„-3">æ•°æ®åº“å­˜å‚¨ç»“æ„</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for employees3</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `employees3`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `employees3`  (</span><br><span class="line">  `eid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä¸»é”®ID&#x27;</span>,</span><br><span class="line">  `ename` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;å§“å&#x27;</span>,</span><br><span class="line">  `position` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ä½ç½®&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`eid`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of employees3</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;è€ç‹&#x27;</span>, <span class="string">&#x27;é«˜ç®¡&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;è€å®‹&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨ä¸»ç®¡&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;è€ç‰›&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨ä¸»ç®¡&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;å°å´&#x27;</span>, <span class="string">&#x27;äº§å“Aç»„é•¿&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">&#x27;å°æ&#x27;</span>, <span class="string">&#x27;äº§å“Bç»„é•¿&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="string">&#x27;å°æ¬¢&#x27;</span>, <span class="string">&#x27;äº§å“ç»ç†&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="string">&#x27;å°å°&#x27;</span>, <span class="string">&#x27;äº§å“ç»ç†&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="string">&#x27;å°å¤©&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="string">&#x27;å°é‡Œ&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="string">&#x27;å°é»‘&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">11</span>, <span class="string">&#x27;å°èƒ¡&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">12</span>, <span class="string">&#x27;å°ä¸½&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">13</span>, <span class="string">&#x27;å°è“&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">14</span>, <span class="string">&#x27;å°é»„&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employees3` <span class="keyword">VALUES</span> (<span class="number">15</span>, <span class="string">&#x27;å°çœŸ&#x27;</span>, <span class="string">&#x27;æŠ€æœ¯éƒ¨å‘˜å·¥&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for emp_relations</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `emp_relations`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `emp_relations`  (</span><br><span class="line">  `root_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;æ ¹èŠ‚ç‚¹çš„eid&#x27;</span>,</span><br><span class="line">  `depth` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;æ ¹èŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„æ·±åº¦&#x27;</span>,</span><br><span class="line">  `is_leaf` tinyint(<span class="number">1</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;è¯¥èŠ‚ç‚¹æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹&#x27;</span>,</span><br><span class="line">  `node_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;è¯¥èŠ‚ç‚¹çš„eid&#x27;</span></span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of emp_relations</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">9</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">11</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">12</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">13</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">14</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">9</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">11</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">12</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">13</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">14</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">9</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">11</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `emp_relations` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>);</span><br></pre></td></tr></table></figure><ul><li>ä¸»è¡¨</li></ul><table><thead><tr><th style="text-align:center">eid</th><th style="text-align:center">ename</th><th style="text-align:center">position</th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center">è€ç‹</td><td style="text-align:center">é«˜ç®¡</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">è€å®‹</td><td style="text-align:center">äº§å“éƒ¨ä¸»ç®¡</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">è€ç‰›</td><td style="text-align:center">æŠ€æœ¯éƒ¨ä¸»ç®¡</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">å°å´</td><td style="text-align:center">äº§å“Aç»„é•¿</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">å°æ</td><td style="text-align:center">äº§å“Bç»„é•¿</td></tr><tr><td style="text-align:center">6</td><td style="text-align:center">å°æ¬¢</td><td style="text-align:center">äº§å“ç»ç†</td></tr><tr><td style="text-align:center">7</td><td style="text-align:center">å°å°</td><td style="text-align:center">äº§å“ç»ç†</td></tr><tr><td style="text-align:center">8</td><td style="text-align:center">å°å¤©</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td></tr><tr><td style="text-align:center">9</td><td style="text-align:center">å°é‡Œ</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">å°é»‘</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td></tr><tr><td style="text-align:center">11</td><td style="text-align:center">å°èƒ¡</td><td style="text-align:center">äº§å“éƒ¨å‘˜å·¥</td></tr><tr><td style="text-align:center">12</td><td style="text-align:center">å°ä¸½</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td></tr><tr><td style="text-align:center">13</td><td style="text-align:center">å°è“</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td></tr><tr><td style="text-align:center">14</td><td style="text-align:center">å°é»„</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td></tr><tr><td style="text-align:center">15</td><td style="text-align:center">å°çœŸ</td><td style="text-align:center">æŠ€æœ¯éƒ¨å‘˜å·¥</td></tr></tbody></table><ul><li>é—­åŒ…è¡¨</li></ul><table><thead><tr><th style="text-align:center">root_id</th><th style="text-align:center">depth</th><th style="text-align:center">is_leaf</th><th style="text-align:center">node_id</th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">2</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">3</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td style="text-align:center">4</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td style="text-align:center">5</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td style="text-align:center">6</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">0</td><td style="text-align:center">7</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">8</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">9</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">10</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">11</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">12</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">13</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">14</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">15</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">2</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">4</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">5</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">8</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">9</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">11</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">3</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">6</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">7</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">12</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">13</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">14</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">15</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">4</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">8</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">9</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">5</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">10</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">11</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">12</td></tr></tbody></table><h3 id="SQLç¤ºä¾‹-3">SQLç¤ºä¾‹</h3><h4 id="æ·»åŠ èŠ‚ç‚¹-3">æ·»åŠ èŠ‚ç‚¹</h4><ul><li>ä¾æ—§æ˜¯åœ¨å°å´ä¸‹æ·»åŠ ä¸‹å±èŠ‚ç‚¹ï¼Œåœ¨æ’å…¥ä¸‹å±èŠ‚ç‚¹åï¼Œæ‰¾å‡ºä»¥å°å´èŠ‚ç‚¹ä¸ºåä»£çš„é‚£äº›èŠ‚ç‚¹ä½œä¸ºå’Œä¸‹å±èŠ‚ç‚¹ä¹‹é—´æœ‰åä»£å…³ç³»ï¼Œæ’å…¥åˆ°æ•°æ®è¡¨ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.æ’å…¥è‡ªå·±Mï¼Œeidä¸º16</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> employees3 ( eid, ename, position )</span><br><span class="line"><span class="keyword">VALUES</span> ( <span class="number">16</span>, <span class="string">&#x27;å°é­&#x27;</span>, <span class="string">&#x27;äº§å“éƒ¨å‘˜å·¥&#x27;</span> );</span><br><span class="line"><span class="comment">-- 2.æŸ¥å‡ºä»¥å°å´ä¸ºåä»£çš„èŠ‚ç‚¹æ•°æ®</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_relations <span class="keyword">WHERE</span> node_id<span class="operator">=</span><span class="number">4</span>;</span><br><span class="line"><span class="comment">-- 3.æ’å…¥åˆ°æ•°æ®è¡¨ï¼šæ·±åº¦+1ä½œä¸ºå’ŒMèŠ‚ç‚¹çš„æ·±åº¦ </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp_relations ( root_id, depth, is_leaf, node_id )</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">( <span class="number">1</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">16</span> ),</span><br><span class="line">( <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">16</span> ),</span><br><span class="line">( <span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span> ),</span><br><span class="line">( <span class="number">16</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">16</span> );</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢å°å¤©çš„ç›´æ¥ä¸Šå¸-3">æŸ¥è¯¢å°å¤©çš„ç›´æ¥ä¸Šå¸</h4><ul><li>åœ¨å…³ç³»è¡¨ä¸­æ‰¾åˆ°node_idä¸ºå°å¤©idï¼Œdepthä¸º1çš„æ ¹èŠ‚ç‚¹idå³å¯</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">e2.eid, e2.ename, e2.position </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">employees3 e1,</span><br><span class="line">employees3 e2,</span><br><span class="line">emp_relations rel </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">e1.ename <span class="operator">=</span> <span class="string">&#x27;å°å¤©&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> rel.node_id <span class="operator">=</span> e1.eid </span><br><span class="line"><span class="keyword">AND</span> rel.depth <span class="operator">=</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">AND</span> e2.eid <span class="operator">=</span> rel.root_id</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢è€å®‹çš„ç›´å±å‘˜å·¥-3">æŸ¥è¯¢è€å®‹çš„ç›´å±å‘˜å·¥</h4><ul><li>åªè¦æŸ¥è¯¢root_idä¸ºè€å®‹eidä¸”æ·±åº¦ä¸º1çš„node_idå³ä¸ºå…¶ç›´æ¥ä¸‹å±å‘˜å·¥id</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">e1.eid,e1.ename, e1.position</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">employees3 e1,</span><br><span class="line">employees3 e2,</span><br><span class="line">emp_relations rel </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">e2.ename <span class="operator">=</span> <span class="string">&#x27;è€å®‹&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> rel.root_id <span class="operator">=</span> e2.eid </span><br><span class="line"><span class="keyword">AND</span> rel.depth <span class="operator">=</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">AND</span> e1.eid <span class="operator">=</span> rel.node_id</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢å°å¤©çš„æ‰€æœ‰ä¸Šå¸-3">æŸ¥è¯¢å°å¤©çš„æ‰€æœ‰ä¸Šå¸</h4><ul><li>åªè¦åœ¨å…³ç³»è¡¨ä¸­æ‰¾åˆ°node_idä¸ºå°å¤©eidä¸”depthå¤§äº0çš„root_idå³å¯</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">e2.eid,e2.ename, e2.position</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">employees3 e1,</span><br><span class="line">employees3 e2,</span><br><span class="line">emp_relations rel </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">e1.ename <span class="operator">=</span> <span class="string">&#x27;å°å¤©&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> rel.node_id <span class="operator">=</span> e1.eid </span><br><span class="line"><span class="keyword">AND</span> rel.depth <span class="operator">&gt;</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">AND</span> e2.eid <span class="operator">=</span> rel.root_id  </span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢è€ç‹çš„æ‰€æœ‰å‘˜å·¥-3">æŸ¥è¯¢è€ç‹çš„æ‰€æœ‰å‘˜å·¥</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">e1.eid,e1.ename, e1.position </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">employees3 e1,</span><br><span class="line">employees3 e2,</span><br><span class="line">emp_relations rel </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">e2.ename <span class="operator">=</span> <span class="string">&#x27;è€ç‹&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> rel.root_id <span class="operator">=</span> e2.eid </span><br><span class="line"><span class="keyword">AND</span> rel.depth <span class="operator">&gt;</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">AND</span> e1.eid <span class="operator">=</span> rel.node_id</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“">æ€»ç»“</h2><ol><li>Adjacency Listï¼ˆé‚»æ¥åˆ—è¡¨ï¼‰:</li></ol><ul><li>ä¼˜ç‚¹ï¼šç®€å•æ˜“äºç†è§£å’Œå®ç°ï¼Œåªéœ€è¦ä¸€ä¸ªçˆ¶èŠ‚ç‚¹ ID å­—æ®µï¼Œå®¹æ˜“æ·»åŠ ã€åˆ é™¤ã€ç§»åŠ¨èŠ‚ç‚¹ã€‚ä¸éœ€è¦ç»´æŠ¤å†—ä½™æ•°æ®ã€‚</li><li>ç¼ºç‚¹ï¼šæŸ¥è¯¢å±‚çº§å…³ç³»å’Œé€’å½’æ“ä½œéœ€è¦è¿›è¡Œå¤šæ¬¡æŸ¥è¯¢ï¼Œæ•ˆç‡è¾ƒä½ã€‚åœ¨å¤§å‹æ ‘çŠ¶ç»“æ„ä¸­ï¼ŒæŸ¥è¯¢æ·±åº¦å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šé€‚ç”¨äºæ ‘çŠ¶ç»“æ„è¾ƒå°ï¼Œå±‚çº§æ·±åº¦ä¸å¤ªæ·±çš„æƒ…å†µï¼Œæˆ–è€…åªéœ€è¦ç®€å•çš„æ ‘ç»“æ„æ“ä½œã€‚</li></ul><ol start="2"><li>Path Enumerationï¼ˆè·¯å¾„æšä¸¾ï¼‰:<ul><li>ä¼˜ç‚¹ï¼šç›¸æ¯”é‚»æ¥åˆ—è¡¨ï¼Œè·¯å¾„æšä¸¾èƒ½å¤Ÿæ›´å¿«é€Ÿåœ°è¿›è¡Œé€’å½’æŸ¥è¯¢å’Œå±‚çº§æ“ä½œï¼Œå› ä¸ºè·¯å¾„ä¿¡æ¯å·²ç»åœ¨èŠ‚ç‚¹ä¸Šå­˜å‚¨ã€‚</li><li>ç¼ºç‚¹ï¼šç›¸æ¯”é—­åŒ…è¡¨ï¼Œä¼šæœ‰ä¸€å®šçš„å†—ä½™ï¼Œéœ€è¦ç»´æŠ¤èŠ‚ç‚¹è·¯å¾„ä¿¡æ¯ã€‚å¯¹äºå±‚çº§å…³ç³»è¾ƒå¤æ‚çš„æ ‘ç»“æ„ï¼Œå¯èƒ½ä¼šå ç”¨æ›´å¤šçš„å­˜å‚¨ç©ºé—´ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šé€‚ç”¨äºæ ‘çŠ¶ç»“æ„çš„å±‚çº§æ“ä½œè¾ƒé¢‘ç¹ï¼Œä½†æ ‘ç»“æ„ç›¸å¯¹ä¸å¤ªå¤æ‚çš„æƒ…å†µã€‚</li></ul></li><li>Closure Tableï¼ˆé—­åŒ…è¡¨ï¼‰:<ul><li>ä¼˜ç‚¹ï¼šèƒ½å¤Ÿé«˜æ•ˆåœ°è¿›è¡Œå±‚çº§æŸ¥è¯¢å’Œé€’å½’æ“ä½œï¼Œä¸éœ€è¦å¤šæ¬¡æŸ¥è¯¢æ•°æ®åº“ã€‚å¯¹äºå¤æ‚çš„æ ‘çŠ¶ç»“æ„ï¼Œé—­åŒ…è¡¨æ˜¯ä¸€ç§å¼ºå¤§çš„æ–¹æ³•ã€‚</li><li>ç¼ºç‚¹ï¼šé—­åŒ…è¡¨å¼•å…¥äº†æ•°æ®å†—ä½™ï¼Œå­˜å‚¨äº†æ‰€æœ‰ç¥–å…ˆ-åä»£å¯¹ï¼Œå¯èƒ½ä¼šå ç”¨æ›´å¤šçš„å­˜å‚¨ç©ºé—´ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šé€‚ç”¨äºæ ‘çŠ¶ç»“æ„éå¸¸å¤æ‚çš„æƒ…å†µï¼Œæˆ–è€…éœ€è¦é«˜æ•ˆæŸ¥è¯¢ç¥–å…ˆå’Œåä»£èŠ‚ç‚¹å…³ç³»çš„åœºæ™¯ã€‚</li></ul></li></ol><ul><li>ç»¼åˆè€ƒè™‘ï¼Œé€‰æ‹©é€‚å½“çš„å­˜å‚¨æ–¹æ³•å–å†³äºæ ‘çŠ¶ç»“æ„çš„å¤§å°ã€å±‚çº§æ·±åº¦ã€å¤æ‚æ€§ï¼Œä»¥åŠå¯¹äºå±‚çº§æŸ¥è¯¢å’Œæ“ä½œçš„æ€§èƒ½éœ€æ±‚ã€‚å¯¹äºå°å‹å’Œç®€å•çš„æ ‘ç»“æ„ï¼Œé‚»æ¥åˆ—è¡¨æ˜¯ä¸€ä¸ªç®€å•æœ‰æ•ˆçš„é€‰æ‹©ã€‚å¯¹äºè¾ƒå¤§ä¸”å±‚çº§æ·±åº¦è¾ƒæ·±çš„æ ‘ç»“æ„ï¼ŒClosure Table æä¾›äº†æ›´é«˜æ•ˆçš„æŸ¥è¯¢æ–¹å¼ã€‚è€Œè·¯å¾„æšä¸¾åˆ™åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥ä½œä¸ºä¸€ç§æŠ˜ä¸­æ–¹æ¡ˆï¼ŒåŒæ—¶æ»¡è¶³æŸ¥è¯¢æ•ˆç‡å’Œæ•°æ®å†—ä½™çš„éœ€æ±‚ã€‚</li></ul>]]></content>
    
    
    <summary type="html">æ•°æ®åº“ä¸­å­˜å‚¨æ ‘çŠ¶ç»“æ„çš„æœ€ä½³å®è·µ</summary>
    
    
    
    <category term="æ•°æ®åº“è®¾è®¡" scheme="https://cyborg2077.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/"/>
    
    
    <category term="æ•°æ®åº“" scheme="https://cyborg2077.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>ç¼–è¾‘è·ç¦»</title>
    <link href="https://cyborg2077.github.io/2023/07/16/EditDistanceSearch/"/>
    <id>https://cyborg2077.github.io/2023/07/16/EditDistanceSearch/</id>
    <published>2023-07-16T11:02:58.000Z</published>
    <updated>2023-10-01T13:43:47.517Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é¢è¯•é¢˜">é¢è¯•é¢˜</h2><ul><li>åœ¨ä¸€ä¸ªé•¿å­—ç¬¦ä¸²ä¸­ï¼Œå¯»æ‰¾ä¸€ä¸ªçŸ­å­—ç¬¦ä¸²ï¼ŒçŸ­å­—ç¬¦ä¸²å¯èƒ½æœ‰ä¸€äº›å™ªéŸ³ï¼Œå³æœ‰çš„å­—æ®µä¸åŒ¹é…ï¼Œä¸”çŸ­å­—ç¬¦ä¸²æ˜¯é•¿å­—ç¬¦ä¸²é•¿åº¦çš„ç™¾åˆ†ä¹‹ä¸€å·¦å³ï¼Œå¦‚ä½•å¿«é€ŸæŸ¥æ‰¾åˆ°è¿™ä¸ªçŸ­å­—ç¬¦ä¸²ã€‚</li><li>å½“æ—¶é¢è¯•å®˜æç¤ºæˆ‘ç¼–è¾‘è·ç¦»ç®—æ³•ï¼ˆ<del>éœ²æ€¯äº†ï¼Œå‹æ ¹æ²¡å¬è¯´è¿‡</del>ï¼‰ï¼Œåæ¥çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°å…¶å®å°±æ˜¯ä¸€é“ç»å…¸çš„DPï¼Œå“</li><li>ç¼–è¾‘è·ç¦»ç®—æ³•è¡¡é‡çš„æ˜¯å°†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¦ä¸€ä¸ªå­—ç¬¦ä¸²æ‰€éœ€çš„æœ€å°‘ç¼–è¾‘æ“ä½œæ¬¡æ•°ï¼Œå› ä¸ºçŸ­å­—ç¬¦ä¸²å­˜åœ¨å™ªéŸ³ï¼Œä¸ä¼šä¸é•¿å­—ç¬¦ä¸²ä¸­çš„å­ä¸²å®Œå…¨åŒ¹é…ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç­›é€‰ä¸€å®šç¼–è¾‘æ¬¡æ•°å†…çš„å­ä¸²ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EditDistanceSearch</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target     ç›®æ ‡å­ä¸²</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> longString é•¿å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> threshold  å®¹é”™é˜ˆå€¼ï¼Œå³è·ç¦»æ•°ï¼Œè§£å†³å™ªéŸ³é—®é¢˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">findSimilarSubstrings</span><span class="params">(String target, String longString, <span class="type">int</span> threshold)</span> &#123;</span><br><span class="line">        <span class="comment">// ç»“æœé›†</span></span><br><span class="line">        List&lt;String&gt; similarSubstrings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// éå†é•¿å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; longString.length() - target.length(); i++) &#123;</span><br><span class="line">            <span class="comment">// å–ç­‰é•¿å­ä¸²ï¼Œè®¡ç®—ç¼–è¾‘è·ç¦»</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">substring</span> <span class="operator">=</span> longString.substring(i, i + target.length());</span><br><span class="line">            <span class="type">int</span> <span class="variable">distance</span> <span class="operator">=</span> calculateEditDistance(substring, target);</span><br><span class="line">            <span class="comment">// æ ¹æ®å®¹é”™é˜ˆå€¼ç­›é€‰</span></span><br><span class="line">            <span class="keyword">if</span> (distance &lt;= threshold)</span><br><span class="line">                similarSubstrings.add(substring);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> similarSubstrings;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼–è¾‘è·ç¦»ç®—æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">calculateEditDistance</span><span class="params">(String str1, String str2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> str1.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> str2.length();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–çŸ©é˜µ</span></span><br><span class="line">        <span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[m + <span class="number">1</span>][n + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            dp[i][<span class="number">0</span>] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt;= n; j++) &#123;</span><br><span class="line">            dp[<span class="number">0</span>][j] = j;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¡ç®—ç¼–è¾‘è·ç¦»</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (str1.charAt(i - <span class="number">1</span>) == str2.charAt(j - <span class="number">1</span>)) &#123;</span><br><span class="line">                    dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dp[i][j] = Math.min(dp[i - <span class="number">1</span>][j - <span class="number">1</span>], Math.min(dp[i][j - <span class="number">1</span>], dp[i - <span class="number">1</span>][j])) + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dp[m][n];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> <span class="string">&quot;kitten&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">longString</span> <span class="operator">=</span> <span class="string">&quot;skittlesittingbingocat&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; similarSubstrings = findSimilarSubstrings(target, longString, threshold);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰¾åˆ°ç›¸ä¼¼å­ä¸²:&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String substring : similarSubstrings) &#123;</span><br><span class="line">            System.out.println(substring);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><ul><li>ç¼–è¾‘è·ç¦»ï¼ˆEdit Distanceï¼‰ï¼Œä¹Ÿç§°ä¸ºLevenshteinè·ç¦»ï¼Œæ˜¯è¡¡é‡ä¸¤ä¸ªå­—ç¬¦ä¸²ä¹‹é—´ç›¸ä¼¼åº¦çš„ä¸€ç§å¸¸ç”¨ç®—æ³•ã€‚å®ƒè¡¡é‡çš„æ˜¯å°†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¦ä¸€ä¸ªå­—ç¬¦ä¸²æ‰€éœ€çš„æœ€å°‘ç¼–è¾‘æ“ä½œæ¬¡æ•°ï¼Œå…¶ä¸­ç¼–è¾‘æ“ä½œå¯ä»¥æ˜¯æ’å…¥ã€åˆ é™¤æˆ–æ›¿æ¢å­—ç¬¦ã€‚</li><li>å…¶ä¸­ä¸€äº›å¸¸è§çš„åº”ç”¨åŒ…æ‹¬ï¼š<ol><li>æ‹¼å†™çº é”™ï¼šé€šè¿‡è®¡ç®—ç›®æ ‡å•è¯ä¸å€™é€‰å•è¯ä¹‹é—´çš„ç¼–è¾‘è·ç¦»ï¼Œå¯ä»¥æ‰¾åˆ°æœ€æ¥è¿‘ç›®æ ‡å•è¯çš„æ­£ç¡®æ‹¼å†™ã€‚</li><li>æ–‡æœ¬ç›¸ä¼¼æ€§ï¼šç¼–è¾‘è·ç¦»å¯ä»¥ç”¨äºæ¯”è¾ƒä¸¤æ®µæ–‡æœ¬ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼Œä¾‹å¦‚åœ¨æ–‡æœ¬æœç´¢ä¸­åŒ¹é…è¿‘ä¼¼çš„å…³é”®è¯æˆ–åœ¨æ–‡æ¡£èšç±»ä¸­å¯»æ‰¾ç›¸ä¼¼çš„æ–‡æœ¬ã€‚</li><li>åŸºå› ç»„æ¯”å¯¹ï¼šåœ¨ç”Ÿç‰©ä¿¡æ¯å­¦ä¸­ï¼Œç¼–è¾‘è·ç¦»å¯ä»¥ç”¨äºæ¯”è¾ƒDNAåºåˆ—æˆ–è›‹ç™½è´¨åºåˆ—ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼Œä»è€Œè¿›è¡ŒåŸºå› ç»„æ¯”å¯¹å’Œåˆ†æã€‚</li><li>è¯­éŸ³è¯†åˆ«ï¼šé€šè¿‡è®¡ç®—è¯­éŸ³ä¿¡å·ä¹‹é—´çš„ç¼–è¾‘è·ç¦»ï¼Œå¯ä»¥åœ¨è¯­éŸ³è¯†åˆ«ä»»åŠ¡ä¸­æ‰¾åˆ°æœ€åŒ¹é…çš„æ–‡æœ¬è½¬å½•ã€‚</li><li>æ•°æ®æ¸…æ´—ï¼šåœ¨æ•°æ®å¤„ç†ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ç¼–è¾‘è·ç¦»æ¥æ¸…æ´—å’Œè§„èŒƒåŒ–æ•°æ®ï¼Œä¾‹å¦‚çº æ­£ç”¨æˆ·è¾“å…¥é”™è¯¯æˆ–åŒ¹é…ç›¸ä¼¼çš„å®ä½“åç§°ã€‚</li></ol></li><li>åŠ›æ‰£é¢˜ç›®é“¾æ¥ï¼š<a href="https://leetcode.cn/problems/edit-distance/">https://leetcode.cn/problems/edit-distance/</a></li></ul><div class="note blud no-icon flat"><ul><li>dp[i][j]è¡¨ç¤ºçš„å«ä¹‰æ˜¯ï¼Œword1[i]å˜åŒ–åˆ°word2[j]èŠ±è´¹çš„æœ€å°‘æ­¥æ•°<ul><li>å½“ word1[i] == word2[j]ï¼Œdp[i][j] = dp[i-1][j-1]ï¼›</li><li>å½“ word1[i] != word2[j]ï¼Œdp[i][j] = min(dp[i-1][j-1], dp[i-1][j], dp[i][j-1]) + 1</li></ul></li><li>ä¸Šé¢çš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹ç»“åˆä¸‹é¢çš„è¡¨æ ¼æ¥çœ‹</li></ul><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">â€œâ€</th><th style="text-align:center">h</th><th style="text-align:center">o</th><th style="text-align:center">r</th><th style="text-align:center">s</th><th style="text-align:center">e</th></tr></thead><tbody><tr><td style="text-align:center">â€œâ€</td><td style="text-align:center">0</td><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">3</td><td style="text-align:center">4</td><td style="text-align:center">5</td></tr><tr><td style="text-align:center">r</td><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">2</td><td style="text-align:center">3</td><td style="text-align:center">4</td></tr><tr><td style="text-align:center">o</td><td style="text-align:center">2</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">3</td><td style="text-align:center">4</td></tr><tr><td style="text-align:center">s</td><td style="text-align:center">3</td><td style="text-align:center">3</td><td style="text-align:center">2</td><td style="text-align:center">2</td><td style="text-align:center">2</td><td style="text-align:center">3</td></tr></tbody></table><ul><li>ç¬¬ä¸€è¡Œ<ol><li>ä»<code>&quot;&quot;</code>å˜åŒ–åˆ°<code>&quot;&quot;</code>éœ€è¦0æ­¥</li><li>ä»<code>&quot;&quot;</code>å˜åŒ–åˆ°<code>h</code>éœ€è¦èŠ±1æ­¥ï¼Œæ’å…¥ä¸€ä¸ª<code>h</code></li><li>ä»<code>&quot;&quot;</code>å˜åŒ–åˆ°<code>ho</code>éœ€è¦èŠ±2æ­¥ï¼Œåœ¨2çš„åŸºç¡€ä¸Šå†æ’å…¥ä¸€ä¸ª<code>o</code></li><li>ä»<code>&quot;&quot;</code>å˜åŒ–åˆ°<code>hor</code>éœ€è¦èŠ±3æ­¥ï¼Œåœ¨3çš„åŸºç¡€ä¸Šå†æ’å…¥ä¸€ä¸ª<code>r</code></li><li>ä»¥æ­¤ç±»æ¨</li></ol></li><li>ç¬¬ä¸€åˆ—<ol><li>ä»<code>&quot;&quot;</code>å˜åŒ–åˆ°<code>&quot;&quot;</code>éœ€è¦0æ­¥</li><li>ä»<code>r</code>å˜åŒ–åˆ°<code>&quot;&quot;</code>éœ€è¦èŠ±1æ­¥ï¼Œåˆ é™¤ä¸€ä¸ª<code>r</code></li><li>ä»<code>ro</code>å˜åŒ–åˆ°<code>&quot;&quot;</code>éœ€è¦èŠ±2æ­¥ï¼Œåœ¨2çš„åŸºç¡€ä¸Šå†åˆ é™¤ä¸€ä¸ª<code>o</code></li><li>ä»<code>r</code>å˜åŒ–åˆ°<code>&quot;&quot;</code>éœ€è¦èŠ±3æ­¥ï¼Œåœ¨3çš„åŸºç¡€ä¸Šå†åˆ é™¤ä¸€ä¸ª<code>s</code></li></ol></li><li>æ–œå¯¹è§’çº¿<ol><li>ä»<code>&quot;&quot;</code>å˜åŒ–åˆ°<code>&quot;&quot;</code>éœ€è¦èŠ±0æ­¥</li><li>ä»<code>r</code>å˜åŒ–åˆ°<code>h</code>éœ€è¦èŠ±1æ­¥ï¼Œå°†<code>r</code>æ›¿æ¢ä¸º<code>h</code></li></ol></li><li>æ€»ç»“ï¼š<code>dp[i-1][j-1]</code>è¡¨ç¤ºæ›¿æ¢æ“ä½œï¼Œ<code>dp[i-1][j]</code>è¡¨ç¤ºåˆ é™¤æ“ä½œï¼Œ<code>dp[i][j-1]</code>è¡¨ç¤ºæ’å…¥æ“ä½œã€‚</li></ul></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minDistance</span><span class="params">(String word1, String word2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> word1.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> word2.length();</span><br><span class="line">        <span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[m + <span class="number">1</span>][n + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            dp[<span class="number">0</span>][i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            dp[i][<span class="number">0</span>] = i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¡ç®—ç¼–è¾‘è·ç¦»</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (word1.charAt(i - <span class="number">1</span>) == word2.charAt(j - <span class="number">1</span>)) &#123;</span><br><span class="line">                    dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span></span><br><span class="line">                    dp[i][j] = Math.min(Math.min(dp[i - <span class="number">1</span>][j], dp[i][j - <span class="number">1</span>]), dp[i - <span class="number">1</span>][j - <span class="number">1</span>]) + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[m][n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="TODO">TODO</h2><ul><li>æ–°å¢ä¸€ä¸ªåˆ†ç±»ï¼Œç”¨äºè®°å½•å·¥ä½œä¸­é‡åˆ°çš„ç®—æ³•ã€‚</li></ul>]]></content>
    
    
    <summary type="html">é¢è¯•ä¸­é‡åˆ°çš„ä¸€ä¸ªç®—æ³•ï¼ˆå½“æ—¶ä¸çŸ¥é“ï¼‰</summary>
    
    
    
    
    <category term="é¢ç»" scheme="https://cyborg2077.github.io/tags/%E9%9D%A2%E7%BB%8F/"/>
    
  </entry>
  
  <entry>
    <title>æ­å»ºæœ¬åœ°ChatGPT</title>
    <link href="https://cyborg2077.github.io/2023/06/13/BuildingLocalChatGPT/"/>
    <id>https://cyborg2077.github.io/2023/06/13/BuildingLocalChatGPT/</id>
    <published>2023-06-13T14:59:32.000Z</published>
    <updated>2023-10-01T13:43:47.468Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†™åœ¨æœ€å‰">å†™åœ¨æœ€å‰</h2><ul><li>æ€æ¥æƒ³å»è¿˜æ˜¯æ­å»ºä¸€ä¸ªæœ¬åœ°ç‰ˆç½¢ï¼ˆä¸ç„¶æ€»æ˜¯è¦ç§‘å­¦ä¸Šç½‘ï¼‰ï¼Œåˆšå¥½å¯ä»¥æ”¾æˆ‘è™šæ‹Ÿæœºé‡Œè·‘ï¼Œæœ¬æ•™ç¨‹åŸºäº<a href="https://github.com/pengzhile/pandora">Pengzhile/pandora</a> é¡¹ç›®</li><li>å‰ç½®è¦æ±‚ï¼šä¸€å°æ­è½½äº†Contos7çš„è™šæ‹Ÿæœº</li></ul><style>                    /* css part */                    .gr-card {                        --card-width: 100%;                        --card-height: 100px;                        display: flex;                        width: var(--card-width);                        height: var(--card-height);                        background-color: #fff;                        border-radius: 6px;                        overflow: hidden;                        box-shadow: 0px 4px 6px rgba(0, 0, 0, .12);                        margin-bottom: 20px;                        text-align: center;                    }                    .gr-svg {                        width: 80px;                        height: 80px;                        margin: auto;                    }                    svg {                        width: 80px;                        height: 80px;                        margin: auto;                    }                    </style>                    <div class="gr-card">                    <div class='gr-svg'><svg t="1625560263736" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5867" width="200" height="200"><path d="M841.554135 289.474752c-32.966703-13.322161-69.997795-24.386329-109.964278-32.966703-10.612569-113.351268-105.222492-202.316207-219.702757-202.316208-114.480265 0-209.090187 88.964939-219.702756 202.316208-39.966483 8.580375-76.997574 19.644542-109.964278 32.966703-97.093716 38.837486-150.382359 94.158324-150.382359 155.124145s53.514443 116.286659 150.382359 155.124146c88.513341 35.450496 205.703197 55.095039 329.667034 55.095039 123.963837 0 241.153693-19.644542 329.667035-55.095039 97.093716-38.837486 150.382359-94.158324 150.382359-155.124146s-53.288644-116.06086-150.382359-155.124145z m-329.441235-176.349283c78.35237 0 144.059978 57.127233 158.962734 132.544211-50.353252-7.451378-103.867696-11.289967-158.962734-11.289967-54.869239 0-108.383682 3.838589-158.736935 11.289967 14.676957-75.416979 80.158765-132.544212 158.736935-132.544211zM819.877398 545.531202c-81.739361 32.740904-191.02624 50.804851-307.764498 50.804851s-226.025138-18.063947-307.764499-50.804851c-71.126792-28.450717-113.577067-66.159206-113.577067-100.706505s42.450276-72.255788 113.577067-100.706505c81.739361-32.740904 191.02624-50.804851 307.764499-50.804851s226.025138 18.063947 307.764498 50.804851c71.126792 28.450717 113.577067 66.159206 113.577067 100.706505s-42.450276 72.029989-113.577067 100.706505z" p-id="5868" fill="#707070"></path><path d="M453.179272 135.931202c-27.547519 11.741566-50.804851 31.160309-67.514002 56.224035-5.419184 8.354576-3.161191 19.418743 4.967586 25.063727 3.161191 2.032194 6.548181 2.935391 9.93517 2.935391 5.870783 0 11.515766-2.935391 15.128556-8.128776 12.644763-19.192944 30.482911-34.0957 51.482249-43.127674 9.257773-3.838589 13.54796-14.451158 9.483573-23.70893-3.612789-8.806174-14.225358-13.096362-23.483132-9.257773zM516.403087 690.268578c-43.579272 0-74.513782 13.322161-94.384123 40.643881-17.838148 24.386329-25.741125 57.804631-25.741125 108.835281s7.902977 84.448953 25.741125 108.835281c19.870342 27.32172 50.804851 40.643881 94.384123 40.643881 43.579272 0 74.513782-13.322161 94.384124-40.643881 17.838148-24.386329 25.741125-57.804631 25.741124-108.835281s-7.902977-84.448953-25.741124-108.835281c-19.870342-27.32172-50.804851-40.643881-94.384124-40.643881z m0 240.250496c-37.031092 0-61.41742-6.322381-61.41742-90.771334 0-84.448953 24.386329-90.771334 61.41742-90.771334s61.41742 6.322381 61.41742 90.771334c-0.225799 84.448953-24.386329 90.771334-61.41742 90.771334zM333.054024 884.230209H305.280706v-164.607717-0.903198-1.580595c0-0.451599 0-0.903197-0.2258-1.354796 0-0.451599-0.225799-0.903197-0.225799-1.354796 0-0.451599-0.225799-1.128997-0.451599-1.580595 0-0.451599-0.225799-0.903197-0.225799-1.128997-0.225799-0.451599-0.225799-1.128997-0.451599-1.580595-0.225799-0.451599-0.225799-0.677398-0.451598-1.128997l-0.677398-1.354796-0.677398-1.354796c-0.225799-0.451599-0.451599-0.903197-0.677398-1.128997-0.225799-0.451599-0.451599-0.903197-0.903198-1.354796-0.225799-0.451599-0.451599-0.677398-0.677398-1.128997-0.225799-0.451599-0.677398-0.903197-0.903197-1.354796-0.225799-0.225799-0.451599-0.677398-0.903198-0.903197-0.451599-0.451599-0.677398-0.903197-1.128996-1.128997l-0.903198-0.903197c-0.451599-0.225799-0.677398-0.677398-1.128996-0.903197-0.451599-0.451599-0.903197-0.677398-1.354796-1.128997-0.225799-0.225799-0.451599-0.451599-0.677398-0.451599 0 0-0.225799 0-0.2258-0.225799-0.451599-0.451599-1.128997-0.677398-1.580595-0.903198-0.225799-0.225799-0.677398-0.451599-0.903197-0.451598-0.451599-0.225799-1.128997-0.451599-1.580596-0.903198-0.451599-0.225799-0.677398-0.451599-1.128996-0.451598-0.451599-0.225799-0.903197-0.451599-1.580596-0.677398-0.451599-0.225799-0.903197-0.225799-1.354796-0.451599-0.451599-0.225799-0.903197-0.225799-1.354796-0.451599-0.451599-0.225799-0.903197-0.225799-1.580595-0.451598-0.451599 0-0.677398-0.225799-1.128997-0.2258-0.677398 0-1.128997-0.225799-1.806395-0.225799H275.475193h-2.709592c-0.451599 0-0.903197 0-1.354796 0.225799-0.451599 0-0.903197 0.225799-1.354796 0.2258-0.451599 0-1.128997 0.225799-1.580596 0.451598-0.451599 0-0.903197 0.225799-1.128996 0.2258-0.451599 0.225799-1.128997 0.225799-1.580596 0.451598-0.451599 0.225799-0.677398 0.225799-1.128996 0.451599l-1.354796 0.677398c-0.451599 0.225799-0.903197 0.451599-1.128997 0.677398-0.451599 0.225799-0.903197 0.451599-1.128997 0.677398-0.451599 0.225799-0.903197 0.451599-1.354796 0.903198-0.451599 0.225799-0.677398 0.451599-1.128996 0.677398-0.451599 0.225799-0.903197 0.677398-1.354796 0.903197-0.225799 0.225799-0.677398 0.451599-0.903198 0.903197l-1.128997 1.128997-0.903197 0.903197c-0.225799 0.451599-0.677398 0.677398-0.903197 1.128997-0.451599 0.451599-0.677398 0.903197-1.128997 1.354796-0.225799 0.225799-0.451599 0.451599-0.451599 0.677398l-137.737596 193.961632c-6.322381 9.031974-7.225579 20.773539-2.257993 30.48291s15.128556 15.805954 26.192723 15.805954h108.383682v16.934951c0 16.257552 13.096362 29.353914 29.353914 29.353914s29.353914-13.096362 29.353914-29.353914V942.938037h27.773319c16.257552 0 29.353914-13.096362 29.353914-29.353914s-12.870562-29.353914-29.128115-29.353914z m-137.963396 0l51.48225-72.481587V884.230209H195.090628zM885.810805 884.230209H858.037486v-164.607717-0.903198-1.580595c0-0.451599 0-0.903197-0.225799-1.354796 0-0.451599-0.225799-0.903197-0.225799-1.354796 0-0.451599-0.225799-1.128997-0.451599-1.580595 0-0.451599-0.225799-0.903197-0.225799-1.128997-0.225799-0.451599-0.225799-1.128997-0.451599-1.580595-0.225799-0.451599-0.225799-0.677398-0.451599-1.128997l-0.677398-1.354796-0.677398-1.354796c-0.225799-0.451599-0.451599-0.903197-0.677398-1.128997-0.225799-0.451599-0.451599-0.903197-0.903197-1.354796-0.225799-0.451599-0.451599-0.677398-0.677398-1.128997-0.225799-0.451599-0.677398-0.903197-0.903198-1.354796-0.225799-0.225799-0.451599-0.677398-0.903197-0.903197-0.451599-0.451599-0.677398-0.903197-1.128997-1.128997l-0.903197-0.903197c-0.451599-0.225799-0.677398-0.677398-1.128997-0.903197-0.451599-0.451599-0.903197-0.677398-1.354796-1.128997-0.225799-0.225799-0.451599-0.451599-0.677398-0.451599 0 0-0.225799 0-0.225799-0.225799-0.451599-0.451599-1.128997-0.677398-1.580595-0.903198-0.225799-0.225799-0.677398-0.451599-0.903198-0.451598-0.451599-0.225799-1.128997-0.451599-1.580595-0.677398-0.451599-0.225799-0.677398-0.451599-1.128997-0.451599-0.451599-0.225799-0.903197-0.451599-1.354796-0.451599-0.451599-0.225799-0.903197-0.225799-1.354796-0.451598-0.451599-0.225799-0.903197-0.225799-1.354796-0.451599-0.451599-0.225799-1.128997-0.225799-1.580595-0.451599-0.451599 0-0.677398-0.225799-1.128997-0.225799-0.677398 0-1.128997-0.225799-1.806395-0.225799h-2.935391-2.709592c-0.451599 0-0.903197 0-1.354796 0.225799-0.451599 0-0.903197 0.225799-1.354796 0.225799-0.451599 0-1.128997 0.225799-1.580596 0.2258-0.451599 0-0.903197 0.225799-1.128996 0.225799-0.451599 0.225799-1.128997 0.225799-1.580596 0.451599-0.451599 0.225799-0.903197 0.225799-1.128996 0.451598l-1.354796 0.677398-1.354796 0.677398c-0.451599 0.225799-0.903197 0.451599-1.128997 0.677398-0.451599 0.225799-0.903197 0.451599-1.354796 0.903198-0.451599 0.225799-0.677398 0.451599-1.128997 0.677398-0.451599 0.225799-0.903197 0.677398-1.354796 0.903197-0.225799 0.225799-0.677398 0.451599-0.903197 0.903198-0.451599 0.451599-0.903197 0.677398-1.128997 1.128996l-0.903197 0.903198c-0.225799 0.451599-0.677398 0.677398-0.903198 1.128996-0.451599 0.451599-0.677398 0.903197-1.128996 1.354796-0.225799 0.225799-0.451599 0.451599-0.451599 0.677398l-137.737596 193.961632c-6.322381 9.031974-7.225579 20.773539-2.257994 30.482911 4.967585 9.709372 15.128556 15.805954 26.192723 15.805954h108.383683v16.93495c0 16.257552 13.096362 29.353914 29.353914 29.353914s29.353914-13.096362 29.353914-29.353914V942.938037h27.773319c16.257552 0 29.353914-13.096362 29.353914-29.353914s-12.870562-29.353914-29.128115-29.353914z m-138.189195 0l51.482249-72.481587V884.230209h-51.482249z" p-id="5869" fill="#707070"></path><path d="M512.1129 344.118192m-29.353914 0a29.353914 29.353914 0 1 0 58.707828 0 29.353914 29.353914 0 1 0-58.707828 0Z" p-id="5870" fill="#707070"></path><path d="M291.281147 373.472106m-29.353914 0a29.353914 29.353914 0 1 0 58.707828 0 29.353914 29.353914 0 1 0-58.707828 0Z" p-id="5871" fill="#707070"></path><path d="M291.281147 499.016538m-29.353914 0a29.353914 29.353914 0 1 0 58.707828 0 29.353914 29.353914 0 1 0-58.707828 0Z" p-id="5872" fill="#707070"></path><path d="M512.1129 541.241014m-29.353914 0a29.353914 29.353914 0 1 0 58.707828 0 29.353914 29.353914 0 1 0-58.707828 0Z" p-id="5873" fill="#707070"></path><path d="M732.718853 373.472106m-29.353914 0a29.353914 29.353914 0 1 0 58.707828 0 29.353914 29.353914 0 1 0-58.707828 0Z" p-id="5874" fill="#707070"></path><path d="M732.718853 499.016538m-29.353914 0a29.353914 29.353914 0 1 0 58.707828 0 29.353914 29.353914 0 1 0-58.707828 0Z" p-id="5875" fill="#707070"></path></svg>                    </div>                    </div><h2 id="å®‰è£…Docker">å®‰è£…Docker</h2><ul><li>å…³äºDockerçš„å®‰è£…å’Œä½¿ç”¨ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒæˆ‘è¿™ç¯‡æ–‡ç« </li></ul><div class="tag link"><a class="link-card" title="Docker" href="https://cyborg2077.github.io/2022/12/21/Docker/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">Docker</p><p class="url">https://cyborg2077.github.io/2022/12/21/Docker/</p></div></a></div><h3 id="å¸è½½-å¯é€‰">å¸è½½(å¯é€‰)</h3><ul><li>å¦‚æœä¹‹å‰å®‰è£…è¿‡æ—§ç‰ˆæœ¬çš„Dockerï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤å¸è½½</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-selinux \</span><br><span class="line">                  docker-engine-selinux \</span><br><span class="line">                  docker-engine \</span><br><span class="line">                  docker-ce</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…Docker-2">å®‰è£…Docker</h3><ul><li>é¦–å…ˆå…ˆå®‰è£…yumå·¥å…·</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils \</span><br><span class="line">           device-mapper-persistent-data \</span><br><span class="line">           lvm2 --skip-broken</span><br></pre></td></tr></table></figure><ul><li>ç„¶åæ›´æ–°æœ¬åœ°é•œåƒæº</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## è®¾ç½®Dockeré•œåƒæº</span></span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">    </span><br><span class="line">sed -i <span class="string">&#x27;s/download.docker.com/mirrors.aliyun.com\/docker-ce/g&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure><ul><li>ç„¶åå®‰è£…ç¤¾åŒºç‰ˆDocker</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y docker-ce</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨Docker">å¯åŠ¨Docker</h3><ul><li>Dockeråº”ç”¨éœ€è¦ç”¨åˆ°å„ç§ç«¯å£ï¼ŒæŒ¨ä¸ªä¿®æ”¹é˜²ç«å¢™è®¾ç½®å¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥è¿™é‡Œå»ºè®®ç›´æ¥å…³é—­é˜²ç«å¢™</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## å…³é—­</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="comment">## ç¦æ­¢å¼€æœºå¯åŠ¨é˜²ç«å¢™</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡å‘½ä»¤å¯åŠ¨Docker</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## å¯åŠ¨dockeræœåŠ¡ï¼ˆåªæ‰§è¡Œæ­¤æ“ä½œå³å¯ï¼‰</span></span><br><span class="line">systemctl start docker </span><br><span class="line"></span><br><span class="line"><span class="comment">## åœæ­¢dockeræœåŠ¡ï¼ˆæ— éœ€æ‰§è¡Œï¼‰</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"></span><br><span class="line"><span class="comment">## é‡å¯dockeræœåŠ¡ï¼ˆæ— éœ€æ‰§è¡Œï¼‰</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><ul><li>ç„¶åè¾“å…¥å‘½ä»¤ï¼ŒæŸ¥çœ‹dockerç‰ˆæœ¬ï¼Œå¦‚æœå¯ä»¥çœ‹åˆ°ç‰ˆæœ¬å·ï¼Œåˆ™å®‰è£…æˆåŠŸ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -v</span><br></pre></td></tr></table></figure><ul><li>è®¾ç½®å¼€æœºè‡ªå¯åŠ¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure><h2 id="æ‹‰å–é•œåƒå¹¶å¯åŠ¨å®¹å™¨">æ‹‰å–é•œåƒå¹¶å¯åŠ¨å®¹å™¨</h2><ol><li>æ‹‰å–é•œåƒ</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull pengzhile/pandora</span><br></pre></td></tr></table></figure><ol start="2"><li>å¯åŠ¨å®¹å™¨ï¼Œè¿™é‡Œçš„9527å¯ä»¥æ¢ä¸ºä½ å–œæ¬¢çš„ç«¯å£ï¼ˆç¡®ä¿å®ƒæ²¡æœ‰è¢«å ç”¨ï¼‰ï¼Œç”±äºdockerå·²ç»è®¾ç½®ä¸ºå¼€æœºè‡ªå¯äº†ï¼Œè¿™é‡Œå†è®¾ç½® <code>--restart=always</code>å¯ä»¥ä¿è¯è¯¥å®¹å™¨éšdockerå¯åŠ¨è€Œå¯åŠ¨ï¼Œä»è€Œå®ç°ä½ åªéœ€è¦å°†è™šæ‹Ÿæœºå¼€æœºï¼Œå³å¯è®¿é—®chatGPTäº†</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e PANDORA_CLOUD=cloud -e PANDORA_SERVER=0.0.0.0:9527 -p 9527:9527 -d --restart=always pengzhile/pandora</span><br></pre></td></tr></table></figure><ol start="3"><li>æŸ¥çœ‹è™šæ‹Ÿæœºipï¼Œåœ¨è¾“å‡ºç»“æœä¸­ï¼Œæ‰¾åˆ°å¸¦æœ‰ inet åœ°å€çš„è¡Œï¼Œåé¢çš„ä¸€ä¸²æ•°å­—å°±æ˜¯æœ¬æœºçš„ IP åœ°å€ï¼Œä¾‹å¦‚ï¼š<code>192.168.101.128</code></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br></pre></td></tr></table></figure><ol start="4"><li>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥<code>è™šæ‹Ÿæœºip:9527</code>ï¼Œå³å¯çœ‹åˆ°ç™»å½•ç•Œé¢ï¼Œç‚¹å‡»æœ€ä¸‹æ–¹<code>Continue with Access Token</code>è¾“å…¥tokenå³å¯ç™»å½•ä½¿ç”¨ï¼Œæ— éœ€ç§‘å­¦ä¸Šç½‘ï¼Œå®šæœŸåˆ·æ–°tokenå³å¯<br><img src="https://s1.ax1x.com/2023/06/14/pCnzCWV.png" alt=""></li><li>å…³äºtokençš„è·å–ï¼Œå¦‚æœä½ æœ‰æ­£å¸¸çš„openAIè´¦å·ï¼Œè®¿é—®https://chat.openai.com/api/auth/session å¯ä»¥æ‹¿åˆ°token<ul><li>å¦å¤–ä¸€ç§tokençš„è·å–æ–¹å¼ï¼š<a href="https://ai.fakeopen.com/auth">https://ai.fakeopen.com/auth</a></li></ul></li></ol><h2 id="å…¶ä»–è®¾å¤‡è®¿é—®">å…¶ä»–è®¾å¤‡è®¿é—®</h2><ul><li>æ‡’æ˜¯ç¬¬ä¸€ç”Ÿäº§åŠ›ï¼Œæˆ‘ç°åœ¨æƒ³åœ¨æ‰‹æœºæˆ–è€…ä»»ä½•æˆ‘çš„ç”µå­è®¾å¤‡ä¸Šè®¿é—®ChatGPTï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå¼€æ”¾ä¸»æœºçš„ä¸€ä¸ªç«¯å£ä¾›å…¶ä»–è®¾å¤‡ç«¯å£å°±å¥½äº†ï¼ˆå½“ç„¶ä½ çš„è®¾å¤‡éœ€è¦å’Œä¸»æœºåœ¨åŒä¸€ä¸ªå±€åŸŸç½‘å†…ï¼‰</li></ul><h3 id="Windowsé˜²ç«å¢™è®¾ç½®">Windowsé˜²ç«å¢™è®¾ç½®</h3><ul><li>æ§åˆ¶é¢æ¿-&gt;ç³»ç»Ÿä¸å®‰å…¨-&gt;Windowsé˜²ç«å¢™-&gt;é«˜çº§è®¾ç½®-&gt;å…¥ç«™è§„åˆ™-&gt;æ–°å»ºè§„åˆ™<br><img src="https://s1.ax1x.com/2023/06/20/pC8B6Ve.png" alt=""></li><li><code>åè®®å’Œç«¯å£</code>ï¼Œé€‰æ‹©<code>TCP</code>ï¼Œ<code>ç‰¹å®šæœ¬åœ°ç«¯å£</code>ï¼Œå¡«å†™ä¸€ä¸ªä½ å–œæ¬¢çš„ç«¯å£å³å¯ï¼Œæˆ‘è¿™é‡Œè¿˜æ˜¯9527<br><img src="https://s1.ax1x.com/2023/06/20/pC8BRPA.png" alt=""></li><li>ç„¶åä¸€è·¯Nextå°±å¥½äº†ï¼Œéƒ½ç”¨é»˜è®¤çš„é…ç½®ï¼Œæœ€åçš„åç§°ä½ å¯ä»¥èµ·ä¸€ä¸ªä½ å–œæ¬¢çš„åç§°ï¼Œæˆ‘è¿™é‡Œæ˜¯ChatGPT</li></ul><h3 id="è™šæ‹Ÿæœºç«¯å£è½¬å‘">è™šæ‹Ÿæœºç«¯å£è½¬å‘</h3><ul><li>ç”±äºè™šæ‹Ÿæœºé‡‡ç”¨çš„æ˜¯NATè”ç½‘æ–¹å¼ï¼Œæˆ‘ä»¬ç‚¹å‡»èœå•-&gt;ç¼–è¾‘-&gt;è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨-&gt;æ›´æ”¹è®¾ç½®ï¼Œé€‰æ‹©VMnet8ç½‘ç»œ<br><img src="https://s1.ax1x.com/2023/06/20/pC8DPIJ.png" alt=""></li><li>ç‚¹å‡»NATè®¾ç½®æ·»åŠ ç«¯å£è½¬å‘è§„åˆ™ï¼Œä¸»æœºç«¯å£é€‰æ‹©æˆ‘ä»¬ä¸Šä¸€æ­¥å¼€æ”¾çš„9527ç«¯å£ï¼Œè™šæ‹Ÿæœºåœ°å€å¡«å†™æˆ‘ä»¬Dockerå®¹å™¨ä¸­ChatGPTçš„å¯åŠ¨ç«¯å£<br><img src="https://s1.ax1x.com/2023/06/20/pC8DmqO.png" alt=""></li><li>æœ€åCMDæŸ¥çœ‹æœ¬æœºipï¼Œå…¶ä»–è®¾å¤‡åªè¦è·Ÿç”µè„‘åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘å†…ï¼Œè®¿é—®<code>ip:ç«¯å£</code>å³å¯æ­£å¸¸ä½¿ç”¨<br><img src="https://s1.ax1x.com/2023/06/20/pC8D0ij.jpg" alt=""></li></ul>]]></content>
    
    
    <summary type="html">ä»GitHubä¸Šçœ‹åˆ°çš„ä¸€ä¸ªé¡¹ç›®ï¼Œç„¶ååŠ¨æ‰‹æ­å»ºäº†ä¸€ä¸‹</summary>
    
    
    
    <category term="å®ç”¨æ•™ç¨‹" scheme="https://cyborg2077.github.io/categories/%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="ChatGPT" scheme="https://cyborg2077.github.io/tags/ChatGPT/"/>
    
  </entry>
  
  <entry>
    <title>å¹¶å‘ç¼–ç¨‹</title>
    <link href="https://cyborg2077.github.io/2023/06/05/JUC/"/>
    <id>https://cyborg2077.github.io/2023/06/05/JUC/</id>
    <published>2023-06-05T03:59:03.000Z</published>
    <updated>2023-10-04T15:13:42.387Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h2><ul><li>å¸Œæœ›ä½ ä¸æ˜¯ä¸€ä¸ªåˆå­¦è€…</li><li>çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œéœ€è¦ä½ æ¥è§¦è¿‡JavaWebå¼€å‘ã€JDBCå¼€å‘ã€WebæœåŠ¡å™¨ã€åˆ†å¸ƒå¼æ¡†æ¶æ—¶æ‰ä¼šé‡åˆ°</li><li>é‡‡ç”¨slf4jæ‰“å°æ—¥å¿—</li><li>é‡‡ç”¨lombokç®€åŒ–JavaBeançš„ä¹¦å†™</li><li>åŸºäºJDK8ï¼Œæœ€å¥½å¯¹å‡½æ•°å¼ç¼–ç¨‹ã€lambdaæœ‰ä¸€å®šäº†è§£ï¼Œè¿™éƒ¨åˆ†çŸ¥è¯†åœ¨æˆ‘çš„ç«™å†…ä¹Ÿæœ‰å¯¹åº”çš„ç¬”è®°</li></ul><div class="tag link"><a class="link-card" title="Java8 æ–°ç‰¹æ€§" href="https://cyborg2077.github.io/2022/11/05/NewFeaturesOfJava8/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">Java8 æ–°ç‰¹æ€§</p><p class="url">https://cyborg2077.github.io/2022/11/05/NewFeaturesOfJava8/</p></div></a></div><ul><li>åˆ›å»ºä¸€ä¸ªMavené¡¹ç›®ï¼Œæ‰€éœ€çš„pomä¾èµ–å¦‚ä¸‹</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>logback.xmlçš„é…ç½®å¦‚ä¸‹</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns</span>=<span class="string">&quot;http://ch.qos.logback/xml/ns/logback&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://ch.qos.logback/xml/ns/logback https://raw.githubusercontent.com/enricopulatzo/logback-XSD/master/src/main/xsd/logback.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%date&#123;HH:mm:ss.SSS&#125; %c [%t] - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;c&quot;</span> <span class="attr">level</span>=<span class="string">&quot;debug&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;ERROR&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="è¿›ç¨‹ä¸çº¿ç¨‹">è¿›ç¨‹ä¸çº¿ç¨‹</h2><ul><li>æœ¬èŠ‚å†…å®¹<ol><li>è¿›ç¨‹å’Œçº¿ç¨‹çš„æ¦‚å¿µ</li><li>å¹¶è¡Œå’Œå¹¶å‘çš„æ¦‚å¿µ</li><li>çº¿ç¨‹åŸºæœ¬åº”ç”¨</li></ol></li></ul><h3 id="è¿›ç¨‹ä¸çº¿ç¨‹-2">è¿›ç¨‹ä¸çº¿ç¨‹</h3><ul><li><code>è¿›ç¨‹</code><ul><li>ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†æŒ‡ä»¤åŠ è½½è‡³CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å†…å­˜ã€ç®¡ç†IOçš„</li><li>å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œæ­¤æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹</li><li>è¿›ç¨‹å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚è®°äº‹æœ¬ã€ç”»å›¾ã€æµè§ˆå™¨ç­‰ï¼‰ï¼Œä¹Ÿæœ‰çš„ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚ç½‘æŠ‘äº‘ã€Steamã€Eipcç­‰ï¼‰</li></ul></li><li><code>çº¿ç¨‹</code><ul><li>ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸€é“å¤šä¸ªçº¿ç¨‹</li><li>ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™CPUæ‰§è¡Œ</li><li>Javaä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚åœ¨Windowsä¸­çš„è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œä¸ºçº¿ç¨‹çš„å®¹å™¨</li></ul></li><li><code>äºŒè€…å¯¹æ¯”</code><ul><li>è¿›ç¨‹åŸºæœ¬ä¸Šæ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†</li><li>è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä¾›å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº«</li><li>è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚<ul><li>åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸ºIPC(Inter-process Communication)</li><li>ä¸åŒè®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œä¾‹å¦‚HTTP</li></ul></li><li>çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå®ƒä»¬å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡</li><li>çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬ä¸Šè¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½</li></ul></li></ul><h3 id="å¹¶è¡Œä¸å¹¶å‘">å¹¶è¡Œä¸å¹¶å‘</h3><ul><li>å•æ ¸CPUä¸‹ï¼Œçº¿ç¨‹å®é™…ä¸Šæ˜¯<code>ä¸²è¡Œæ‰§è¡Œ</code>çš„ã€‚æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åš<code>ä»»åŠ¡è°ƒåº¦å™¨</code>ï¼Œå°†CPUçš„æ—¶é—´ç‰‡åˆ†ç»™ä¸åŒçš„ç¨‹åºä½¿ç”¨ï¼Œåªæ˜¯ç”±äºCPUåœ¨çº¿ç¨‹é—´çš„åˆ‡æ¢éå¸¸å¿«(å› ä¸ºæ—¶é—´ç‰‡å¾ˆå°)ï¼Œæ‰€ä»¥ç»™æˆ‘ä»¬çš„æ„Ÿè§‰æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚æ€»ç»“ä¸ºä¸€å¥è¯å°±æ˜¯ï¼š<code>å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œã€‚</code></li><li>ä¸€èˆ¬ä¼šå°†è¿™ç§çº¿ç¨‹è½®æµä½¿ç”¨CPUçš„åšæ³•ç§°ä¸ºå¹¶å‘(Concurrent)</li></ul><table><thead><tr><th style="text-align:center">CPU</th><th style="text-align:center">æ—¶é—´ç‰‡1</th><th style="text-align:center">æ—¶é—´ç‰‡2</th><th style="text-align:center">æ—¶é—´ç‰‡3</th><th style="text-align:center">æ—¶é—´ç‰‡4</th></tr></thead><tbody><tr><td style="text-align:center">core</td><td style="text-align:center">çº¿ç¨‹1</td><td style="text-align:center">çº¿ç¨‹2</td><td style="text-align:center">çº¿ç¨‹3</td><td style="text-align:center">çº¿ç¨‹4</td></tr></tbody></table><p><img src="https://s1.ax1x.com/2023/06/08/pCk5rEq.png" alt=""></p><ul><li>å¤šæ ¸CPUä¸‹ï¼Œæ¯ä¸ªæ ¸(core)éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹å¯ä»¥æ˜¯å¹¶è¡Œçš„ã€‚</li></ul><table><thead><tr><th style="text-align:center">CPU</th><th style="text-align:center">æ—¶é—´ç‰‡ 1</th><th style="text-align:center">æ—¶é—´ç‰‡ 2</th><th style="text-align:center">æ—¶é—´ç‰‡ 3</th><th style="text-align:center">æ—¶é—´ç‰‡ 4</th></tr></thead><tbody><tr><td style="text-align:center">core 1</td><td style="text-align:center">çº¿ç¨‹ 1</td><td style="text-align:center">çº¿ç¨‹ 3</td><td style="text-align:center">çº¿ç¨‹ 1</td><td style="text-align:center">çº¿ç¨‹ 3</td></tr><tr><td style="text-align:center">core 2</td><td style="text-align:center">çº¿ç¨‹ 2</td><td style="text-align:center">çº¿ç¨‹ 4</td><td style="text-align:center">çº¿ç¨‹ 2</td><td style="text-align:center">çº¿ç¨‹ 4</td></tr></tbody></table><p><img src="https://s1.ax1x.com/2023/06/08/pCk5y5V.png" alt=""></p><ul><li>å°ç»“<ul><li><code>å¹¶å‘(Concurrent)ï¼š</code>æ˜¯åŒä¸€æ—¶é—´åº”å¯¹(dealing with)å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›</li><li><code>å¹¶è¡Œ(Parallel)ï¼š</code>æ˜¯åŒä¸€æ—¶é—´åŠ¨æ‰‹åš(doing)å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›</li></ul></li><li>ä¾‹å­<ul><li>æœ€è¿‘åˆšå¥½æŠŠåˆ†æ‰‹å¨æˆ¿é€šå…³äº†ï¼Œå°±æ‹¿å®ƒä¸¾ä¾‹å§ï¼šæ¸¸æˆéœ€è¦åˆ‡èœã€çƒ¹é¥ªã€è£…ç›˜ã€é€èœç­‰å¤šä¸ªæ­¥éª¤ï¼Œå¦‚æœç°åœ¨æ˜¯å•äººè½®æµäº¤æ›¿åšè¿™å¤šä»¶äº‹ï¼Œæ­¤æ—¶å°±æ˜¯å¹¶å‘</li><li>è”æœºå«äº†ä¸‰ä¸ªæœ‹å‹ä¸€èµ·æ‰“ï¼Œä¸€ä¸ªåªè´Ÿè´£åˆ‡èœã€ä¸€ä¸ªåªè´Ÿè´£çƒ¹é¥ªã€ä¸€ä¸ªåªè´Ÿè´£è£…ç›˜ã€ä¸€ä¸ªåªè´Ÿè´£é€èœï¼Œäº’ä¸å¹²æ‰°ï¼Œæ­¤æ—¶å°±æ˜¯å¹¶è¡Œ</li><li>ä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹å‡‘ä¸é½é‚£ä¹ˆå¤šäººï¼Œå¦‚æœä¸¤ä¸ªäººä¸€èµ·åšè¿™äº›äº‹ï¼Œæ­¤æ—¶æ—¢æœ‰å¹¶å‘ï¼Œä¹Ÿæœ‰å¹¶è¡Œï¼Œæ­¤æ—¶ä¼šäº§ç”Ÿç«äº‰ï¼Œä¾‹å¦‚é”…åªæœ‰ä¸€å£ï¼Œä¸€ä¸ªäººç”¨é”…çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªäººå°±å¾—ç­‰å¾…</li></ul></li></ul><h3 id="åº”ç”¨">åº”ç”¨</h3><h4 id="å¼‚æ­¥è°ƒç”¨">å¼‚æ­¥è°ƒç”¨</h4><ul><li>ä»¥è°ƒç”¨æ–¹è§’åº¦æ¥è®²ï¼Œå¦‚æœ<ul><li>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œï¼Œè¿™æ˜¯åŒæ­¥</li><li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œï¼Œè¿™æ˜¯å¼‚æ­¥</li></ul></li><li>è®¾è®¡<ul><li>å¤šçº¿ç¨‹å¯ä»¥è®©æ–¹æ³•æ‰§è¡Œå˜ä¸ºå¼‚æ­¥ï¼Œä¾‹å¦‚è¯»å–ç£ç›˜æ–‡ä»¶æ—¶ï¼Œå‡è®¾æ­¤æ¬¡è¯»å–è€—æ—¶5ç§’ï¼Œå¦‚æœæ²¡æœ‰çº¿ç¨‹è°ƒåº¦æœºåˆ¶ï¼Œè¿™5ç§’CPUä»€ä¹ˆä¹Ÿåšä¸äº†ï¼Œå…¶ä»–ä»£ç éƒ½å¾—æš‚åœ</li></ul></li><li>ç»“è®º<ul><li>ä¾‹å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œè§†é¢‘æ–‡ä»¶çš„æ ¼å¼è½¬æ¢ç­‰æ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œæ­¤æ—¶å¼€ä¸€ä¸ªæ–°çš„çº¿ç¨‹å»å¤„ç†è§†é¢‘è½¬æ¢ï¼Œå¯ä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹</li><li>Tomcatçš„å¼‚æ­¥servletä¹Ÿæ˜¯ç±»ä¼¼çš„ç›®çš„ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å¤„ç†è€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œé¿å…é˜»å¡Tomcatçš„å·¥ä½œçº¿ç¨‹</li></ul></li></ul><h4 id="æé«˜æ•ˆç‡">æé«˜æ•ˆç‡</h4><ul><li>å……åˆ†åˆ©ç”¨å¤šæ ¸CPUçš„ä¼˜åŠ¿ï¼Œæé«˜è¿è¡Œæ•ˆç‡ï¼Œæƒ³è±¡ä¸‹é¢çš„åœºæ™¯ï¼Œæ‰§è¡Œä¸‰ä¸ªè®¡ç®—ï¼Œæœ€åå°†è®¡ç®—ç»“æœæ±‡æ€»</li></ul><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è®¡ç®— <span class="number">1</span> èŠ±è´¹ <span class="number">10</span> <span class="keyword">ms</span></span><br><span class="line"></span><br><span class="line"><span class="title">è®¡ç®— 2</span> èŠ±è´¹ <span class="number">12</span> <span class="keyword">ms</span></span><br><span class="line"></span><br><span class="line"><span class="title">è®¡ç®— 3</span> èŠ±è´¹ <span class="number">8</span> <span class="keyword">ms</span></span><br><span class="line"></span><br><span class="line"><span class="title">æ±‡æ€» èŠ±è´¹ 2</span> ms</span><br></pre></td></tr></table></figure><ul><li><p>æ­¤æ—¶å¦‚æœæ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆéœ€è¦èŠ±è´¹<code>10 + 12 + 8 + 2 = 32ms</code></p></li><li><p>ä½†å¦‚æœæ˜¯4æ ¸CPUï¼Œå„ä¸ªæ ¸å¿ƒåˆ†åˆ«ä½¿ç”¨çº¿ç¨‹1æ‰§è¡Œè®¡ç®—1ã€çº¿ç¨‹2æ‰§è¡Œè®¡ç®—2ã€çº¿ç¨‹3æ‰§è¡Œè®¡ç®—3ï¼Œé‚£ä¹ˆ3ä¸ªçº¿ç¨‹æ˜¯å¹¶è¡Œçš„ï¼ŒèŠ±è´¹æ—¶é—´åªå–å†³äºæœ€é•¿çš„é‚£ä¸ªçº¿ç¨‹çš„è¿è¡Œæ—¶é—´ï¼Œå³<code>12ms</code>ï¼Œå†åŠ ä¸Šæ±‡æ€»æ—¶é—´æ‰€éœ€çš„<code>2ms</code>ï¼Œæ€»æ—¶é•¿ä»…ä»…æ‰<code>14ms</code></p></li><li><p>åœ¨å•æ ¸CPUä¸‹ï¼Œå¤šçº¿ç¨‹ä¸‹ä¸èƒ½å®é™…æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œåªæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„ä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼Œä¸åŒçº¿ç¨‹è½®æµä½¿ç”¨CPUï¼Œä¸è‡³äºä¸€ä¸ªçº¿ç¨‹æ€»å ç”¨CPUï¼Œå¯¼è‡´åˆ«çš„çº¿ç¨‹æ²¡æ³•å¹²æ´»</p></li><li><p>å¤šæ ¸CPUå¯ä»¥å¹¶è¡Œè·‘å¤šä¸ªçº¿ç¨‹ï¼Œä½†èƒ½å¦æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡è¿˜æ˜¯è¦åˆ†æƒ…å†µçš„</p><ul><li>æœ‰äº›ä»»åŠ¡ç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå°†ä»»åŠ¡æ‹†åˆ†ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå½“ç„¶å¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰è®¡ç®—ä»»åŠ¡éƒ½èƒ½æ‹†åˆ†ï¼ˆå‚è€ƒåæ–‡çš„<code>é˜¿å§†è¾¾å°”å®šå¾‹</code>ï¼‰</li><li>ä¹Ÿä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æ‹†åˆ†ï¼Œä»»åŠ¡çš„ç›®çš„å¦‚æœä¸åŒï¼Œè°ˆæ‹†åˆ†å’Œæ•ˆç‡æ²¡æœ‰æ„ä¹‰</li></ul></li><li><p>IOæ“ä½œä¸å ç”¨CPUï¼Œåªæ˜¯æˆ‘ä»¬ä¸€èˆ¬æ‹·è´æ–‡ä»¶ä½¿ç”¨çš„æ˜¯<code>é˜»å¡å¼IO</code>ï¼Œè¿™ç›¸å½“äºçº¿ç¨‹è™½ç„¶æ²¡ç”¨CPUï¼Œä½†éœ€è¦ä¸€ç›´<code>ç­‰å¾…IOç»“æŸ</code>ï¼Œæ²¡èƒ½å……åˆ†åˆ©ç”¨çº¿ç¨‹ã€‚æ‰€ä»¥æ‰æœ‰åé¢çš„<code>éé˜»å¡å¼IO</code>å’Œ<code>å¼‚æ­¥IO</code>çš„ä¼˜åŒ–</p></li></ul><h2 id="Javaçº¿ç¨‹">Javaçº¿ç¨‹</h2><ul><li>æœ¬èŠ‚å†…å®¹<ol><li>åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</li><li>æŸ¥çœ‹çº¿ç¨‹</li><li>çº¿ç¨‹API</li><li>çº¿ç¨‹çŠ¶æ€</li></ol></li></ul><h3 id="åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹">åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</h3><h4 id="æ–¹å¼ä¸€ï¼šç›´æ¥ä½¿ç”¨Thread">æ–¹å¼ä¸€ï¼šç›´æ¥ä½¿ç”¨Thread</h4><ul><li>ç¤ºä¾‹ä»£ç å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Sync&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åŒ¿åå†…éƒ¨ç±»åˆ›å»ºçº¿ç¨‹ï¼Œèµ·åä¸ºt1</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">14</span>:<span class="number">23</span>:<span class="number">39</span><span class="meta"> [t1] c.Sync - running</span></span><br></pre></td></tr></table></figure><h4 id="æ–¹å¼äºŒï¼šRunnableé…åˆThread">æ–¹å¼äºŒï¼šRunnableé…åˆThread</h4><ul><li>æŠŠåˆ›å»ºçº¿ç¨‹å’Œæ‰§è¡Œä»»åŠ¡çš„ä»£ç åˆ†å¼€ï¼ŒThreadåˆ›å»ºçº¿ç¨‹ï¼ŒRunnableæ‰§è¡Œä»»åŠ¡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Sync&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä»»åŠ¡</span></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// åˆ›å»ºçº¿ç¨‹ï¼ŒæŒ‡å®šä»»åŠ¡ï¼Œèµ·åä¸ºt1</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        <span class="comment">// å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">14</span>:<span class="number">26</span>:<span class="number">18</span><span class="meta"> [t1] c.Sync - running</span></span><br></pre></td></tr></table></figure><ul><li>Java8ä»¥åè¿˜å¯ä»¥ç”¨lambdaç®€åŒ–ä»£ç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Sync&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä»»åŠ¡ï¼Œlambdaç®€åŒ–ä»£ç </span></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºçº¿ç¨‹ï¼ŒæŒ‡å®šä»»åŠ¡ï¼Œèµ·åä¸ºt1</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        <span class="comment">// å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å½“ç„¶è¿˜å¯ä»¥è¿›ä¸€æ­¥ç²¾ç®€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Sync&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºçº¿ç¨‹ï¼ŒæŒ‡å®šä»»åŠ¡ï¼Œèµ·åä¸ºt1</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; log.debug(<span class="string">&quot;running&quot;</span>), <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        <span class="comment">// å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åŸç†ä¹‹Threadä¸Runnableçš„å…³ç³»">åŸç†ä¹‹Threadä¸Runnableçš„å…³ç³»</h4><ul><li>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹Threadçš„æºç ï¼Œç†æ¸…å®ƒä¸Runnableçš„å…³ç³»ï¼Œä¸‹é¢çš„ä»£ç æˆ‘åªæˆªå–äº†æˆ‘ä»¬ä¸Šé¢ç”¨åˆ°çš„éƒ¨åˆ†</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* What will be run. */</span></span><br><span class="line"><span class="keyword">private</span> Runnable target;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Thread</span><span class="params">(Runnable target, String name)</span> &#123;</span><br><span class="line">    init(<span class="literal">null</span>, target, name, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">        target.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä»Threadçš„æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ç”¨æ–¹å¼äºŒåˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¼ å…¥äº†ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä½œä¸ºThreadçš„ä¸€ä¸ªåä¸ºtargetçš„å±æ€§ï¼Œå½“æˆ‘ä»¬è°ƒç”¨runæ–¹æ³•æ—¶ï¼Œå¦‚æœtargetä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè°ƒç”¨çš„æ˜¯targetçš„run()æ–¹æ³•</li><li>ä½†æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨æ–¹å¼ä¸€çš„æ—¶å€™ï¼Œæ²¡æœ‰ä¼ å…¥Runnableå¯¹è±¡ï¼Œæ­¤æ—¶æ˜¯é‡å†™äº†Threadçš„run()æ–¹æ³•</li><li>å°ç»“<ul><li>æ–¹å¼ä¸€æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œæ–¹æ³•äºŒæ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€äº†</li><li>ä½¿ç”¨Runnableå¯¹è±¡ï¼Œæ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§APIé…åˆ</li><li>ä½¿ç”¨Runnableå¯¹è±¡è®©ä»»åŠ¡ç±»è„±ç¦»äº†Threadçš„ç»§æ‰¿ä½“ç³»ï¼Œæ›´çµæ´»</li></ul></li></ul><h4 id="æ–¹å¼ä¸‰ï¼šFutureTaské…åˆThread">æ–¹å¼ä¸‰ï¼šFutureTaské…åˆThread</h4><ul><li>FutureTaskèƒ½å¤Ÿæ¥å—Callableç±»å‹çš„å‚æ•°ï¼Œç”¨æ¥å¤„ç†æœ‰è¿”å›ç»“æœçš„æƒ…å†µ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä»»åŠ¡å¯¹è±¡</span></span><br><span class="line">FutureTask&lt;Integer&gt; task = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;Integer&gt;(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">521</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»»åŠ¡å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯çº¿ç¨‹åç§°</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"><span class="comment">// å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">thread.start();</span><br><span class="line"><span class="comment">// ä½¿ç”¨task.get()ä¼šé˜»å¡çº¿ç¨‹ç›´è‡³è·å–åˆ°ç»“æœï¼Œè¿™é‡Œæ—¥å¿—æ‰“å°</span></span><br><span class="line">log.debug(<span class="string">&quot;è·å–åˆ°è¿”å›å€¼ï¼š&#123;&#125;&quot;</span>, task.get()); </span><br></pre></td></tr></table></figure><ul><li>ä¸Šè¿°ä»£ç ä¹Ÿå¯ä»¥ç”¨lambdaç®€åŒ–</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FutureTask&lt;Integer&gt; task = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">521</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">thread.start();</span><br><span class="line">log.debug(<span class="string">&quot;è·å–åˆ°è¿”å›å€¼ï¼š&#123;&#125;&quot;</span>, task.get()); </span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">58</span>:<span class="number">06</span> <span class="selector-attr">[t1]</span> c<span class="selector-class">.Sync</span> - running</span><br><span class="line"><span class="number">14</span>:<span class="number">58</span>:<span class="number">06</span> <span class="selector-attr">[main]</span> c<span class="selector-class">.Sync</span> - è·å–åˆ°è¿”å›å€¼ï¼š<span class="number">521</span></span><br></pre></td></tr></table></figure><ul><li>æºç å‰–æ<ul><li>FutureTaskå®ç°äº†RunnableFutureæ¥å£</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureTask</span>&lt;V&gt; <span class="keyword">implements</span> <span class="title class_">RunnableFuture</span>&lt;V&gt; </span><br></pre></td></tr></table></figure><ul><li>è€ŒRunnableFutureåˆå®ç°äº†Runnableæ¥å£å’ŒFutureæ¥å£</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RunnableFuture</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">Runnable</span>, Future&lt;V&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets this Future to the result of its computation</span></span><br><span class="line"><span class="comment">     * unless it has been cancelled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Futureæ¥å£ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥è¿”å›ä»»åŠ¡æ‰§è¡Œçš„ç»“æœï¼Œæ³›å‹Vå³è¿”å›å€¼ç±»å‹</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br></pre></td></tr></table></figure><ul><li>Callableæ¥å£æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”å¯ä»¥æŠ›å‡ºå¼‚å¸¸</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Callable</span>&lt;V&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Computes a result, or throws an exception if unable to do so.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> computed result</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception if unable to compute a result</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    V <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="è§‚å¯Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ">è§‚å¯Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</h3><ul><li>ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œè°å…ˆè°åä¸å—æˆ‘ä»¬æ§åˆ¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t1] c.Sync - running</span><br><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t2] c.Sync - running</span><br><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t2] c.Sync - running</span><br><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t2] c.Sync - running</span><br><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t2] c.Sync - running</span><br><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t2] c.Sync - running</span><br><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t2] c.Sync - running</span><br><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t1] c.Sync - running</span><br><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t1] c.Sync - running</span><br><span class="line"><span class="number">15</span>:<span class="number">05</span>:<span class="number">16</span> [t2] c.Sync - running</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•">æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•</h3><h4 id="Windows">Windows</h4><ul><li>åœ¨Windowsç¯å¢ƒä¸‹ï¼Œå¯ä»¥é€šè¿‡ä»»åŠ¡ç®¡ç†å™¨æ¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹<ul><li>tasklist æŸ¥çœ‹è¿›ç¨‹</li><li>taskkill æ€æ­»è¿›ç¨‹</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">C:\WINDOWS\system32&gt;tasklist | findstr java</span><br><span class="line">java.exe                     <span class="number">20900</span> Console                    <span class="number">1</span>     <span class="number">63</span>,<span class="number">024</span> K</span><br><span class="line">java.exe                     <span class="number">17244</span> Console                    <span class="number">1</span>     <span class="number">26</span>,<span class="number">252</span> K</span><br><span class="line"></span><br><span class="line">C:\WINDOWS\system32&gt;jps</span><br><span class="line"><span class="number">15780</span> Jps</span><br><span class="line"><span class="number">20900</span> RemoteMavenServer36</span><br><span class="line"><span class="number">18760</span></span><br><span class="line"><span class="number">17244</span> Launcher</span><br><span class="line"></span><br><span class="line">C:\WINDOWS\system32&gt;jps</span><br><span class="line"><span class="number">20896</span> Launcher</span><br><span class="line"><span class="number">14788</span> Sync</span><br><span class="line"><span class="number">20900</span> RemoteMavenServer36</span><br><span class="line"><span class="number">6372</span> Jps</span><br><span class="line"><span class="number">18760</span></span><br><span class="line"></span><br><span class="line">C:\WINDOWS\system32&gt;taskkill /F /PID <span class="number">14788</span></span><br><span class="line">æˆåŠŸ: å·²ç»ˆæ­¢ PID ä¸º <span class="number">14788</span> çš„è¿›ç¨‹ã€‚</span><br></pre></td></tr></table></figure><h4 id="Linux">Linux</h4><ul><li>Linuxç¯å¢ƒä¸‹æœ‰å…³è¿›ç¨‹çš„æŒ‡ä»¤<ul><li><code>ps -ef</code> æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹</li><li><code>ps -fT -p &lt;PID&gt;</code> æŸ¥çœ‹æŸä¸ªè¿›ç¨‹(PID)çš„æ‰€æœ‰çº¿ç¨‹</li><li><code>kill</code> æ€æ­»è¿›ç¨‹</li><li><code>top</code> æŒ‰å¤§å†™Håˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºè¿›ç¨‹</li><li><code>top -H -p &lt;PID&gt;</code> æŸ¥çœ‹æŸä¸ªè¿›ç¨‹(PID)çš„æ‰€æœ‰çº¿ç¨‹</li></ul></li></ul><h4 id="Java">Java</h4><ul><li>jpså‘½ä»¤æŸ¥çœ‹æ‰€æœ‰Javaè¿›ç¨‹</li><li>jstack <PID> æŸ¥çœ‹æŸä¸ªJavaè¿›ç¨‹(PID)çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</li><li>jconsole æŸ¥çœ‹æŸä¸ªJavaè¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µ(å›¾å½¢ç•Œé¢)</li></ul><h3 id="åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ">åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ</h3><h4 id="æ ˆä¸æ ˆå¸§">æ ˆä¸æ ˆå¸§</h4><ul><li>Javaè™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stacksï¼‰æ˜¯Javaè™šæ‹Ÿæœºä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜å‚¨çº¿ç¨‹çš„æ–¹æ³•è°ƒç”¨å’Œå±€éƒ¨å˜é‡ç­‰ä¿¡æ¯ã€‚</li><li>æ¯ä¸ªçº¿ç¨‹åœ¨è¿è¡Œæ—¶éƒ½æœ‰è‡ªå·±çš„Javaè™šæ‹Ÿæœºæ ˆï¼Œçº¿ç¨‹å¼€å§‹æ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼ˆStack Frameï¼‰ï¼Œç”¨äºå­˜å‚¨è¯¥çº¿ç¨‹çš„æ–¹æ³•è°ƒç”¨ä¿¡æ¯ã€‚å½“æ–¹æ³•è°ƒç”¨å®Œæˆåï¼Œè¯¥æ ˆå¸§ä¼šè¢«å¼¹å‡ºï¼Œå›åˆ°ä¸Šä¸€æ¬¡æ–¹æ³•è°ƒç”¨çš„ä½ç½®ã€‚æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•ã€‚</li><li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆå¸§ï¼Œæ ˆå¸§åŒ…å«æ–¹æ³•çš„å‚æ•°ã€å±€éƒ¨å˜é‡å’Œè¿”å›å€¼ç­‰ä¿¡æ¯ï¼Œå› æ­¤ä¸åŒçš„çº¿ç¨‹å¯ä»¥åœ¨ä¸ç›¸äº’å¹²æ‰°çš„æƒ…å†µä¸‹åŒæ—¶è®¿é—®ç›¸åŒçš„æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç¼–å†™æµ‹è¯•ä»£ç éªŒè¯ä¸€ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        method1();</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    method1();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;here&#x27;s method1&quot;</span>);</span><br><span class="line">    method2();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;here&#x27;s method2&quot;</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><ul><li>æ‰“æ–­ç‚¹æ³¨æ„é€‰æ‹©æŒ‚èµ·çº¿ç¨‹<br><img src="https://s1.ax1x.com/2023/06/08/pCk5T56.png" alt=""></li><li>å¯¹mainçº¿ç¨‹ï¼Œä¾æ¬¡æ­¥å…¥method2()æ–¹æ³•ï¼Œä¸ä¼šå½±å“åˆ°t1çº¿ç¨‹çš„æ“ä½œï¼›åŒæ ·ï¼Œå¯¹t1çº¿ç¨‹ï¼Œä¾æ¬¡æ­¥å…¥åˆ°method2()æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šå½±å“mainçº¿ç¨‹ã€‚è¯å®äº†æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆå¸§ï¼Œä¸”å¯ä»¥åœ¨ä¸äº’ç›¸å¹²æ‰°çš„ç¯å¢ƒä¸‹åŒæ—¶è®¿é—®ç›¸åŒçš„æ–¹æ³•ã€‚</li><li>å…³äºè™šæ‹Ÿæœºæ ˆçš„æ›´è¯¦ç»†çš„å†…å®¹åœ¨æˆ‘è¿™ç¯‡æ–‡ç« çš„ç¬¬äºŒå°èŠ‚ä¸­æœ‰æåŠ</li></ul><div class="tag link"><a class="link-card" title="JVMå†…å­˜ç»“æ„" href="https://cyborg2077.github.io/2023/03/27/JvmPart2/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">JVMå†…å­˜ç»“æ„</p><p class="url">https://cyborg2077.github.io/2023/03/27/JvmPart2/</p></div></a></div><h4 id="çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢">çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</h4><ul><li>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢(Thread Context Switch)ï¼šå› ä¸ºæŸäº›åŸå› å¯¼è‡´ä¸å†æ‰§è¡Œå½“å‰çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç <ul><li>çº¿ç¨‹çš„CPUæ—¶é—´ç‰‡ç”¨å®Œ</li><li>åƒåœ¾å›æ”¶</li><li>æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ</li><li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº†sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lockç­‰æ–¹æ³•</li></ul></li></ul><h3 id="å¸¸è§æ–¹æ³•">å¸¸è§æ–¹æ³•</h3><table><thead><tr><th style="text-align:center">æ–¹æ³•å</th><th style="text-align:center">static</th><th style="text-align:center">åŠŸèƒ½è¯´æ˜</th><th style="text-align:center">æ³¨æ„</th></tr></thead><tbody><tr><td style="text-align:center">start()</td><td style="text-align:center"></td><td style="text-align:center">å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåœ¨æ–°çš„çº¿ç¨‹è¿è¡Œrunæ–¹æ³•ä¸­çš„ä»£ç </td><td style="text-align:center">startæ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œï¼ˆCPUçš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç°IllegalThreadStateException</td></tr><tr><td style="text-align:center">run()</td><td style="text-align:center"></td><td style="text-align:center">æ–°çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨çš„æ–¹æ³•</td><td style="text-align:center">å¦‚æœåœ¨æ„é€ Threadå¯¹è±¡æ—¶ä¼ é€’äº†Runnableå‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨Runnableä¸­çš„runæ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»ºThreadçš„å­ç±»å¯¹è±¡ï¼Œæ¥è¦†ç›–é»˜è®¤è¡Œä¸º</td></tr><tr><td style="text-align:center">join()</td><td style="text-align:center"></td><td style="text-align:center">ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">join(long n)</td><td style="text-align:center"></td><td style="text-align:center">ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæœ€å¤šç­‰å¾…næ¯«ç§’</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">getId()</td><td style="text-align:center"></td><td style="text-align:center">è·å–çº¿ç¨‹é•¿æ•´å‹çš„id</td><td style="text-align:center">idå”¯ä¸€</td></tr><tr><td style="text-align:center">getName()</td><td style="text-align:center"></td><td style="text-align:center">è·å–çº¿ç¨‹å</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">setName(String)</td><td style="text-align:center"></td><td style="text-align:center">ä¿®æ”¹çº¿ç¨‹å</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">getPriority()</td><td style="text-align:center"></td><td style="text-align:center">è·å–çº¿ç¨‹ä¼˜å…ˆçº§</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">setPriority(int)</td><td style="text-align:center"></td><td style="text-align:center">ä¿®æ”¹çº¿ç¨‹ä¼˜å…ˆçº§</td><td style="text-align:center">Javaä¸­è§„å®šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯1~10çš„æ•´æ•°ï¼Œè¾ƒå¤§çš„ä¼˜å…ˆçº§èƒ½æé«˜è¯¥çº¿ç¨‹è¢«CPUè°ƒåº¦çš„æœºç‡</td></tr><tr><td style="text-align:center">getState()</td><td style="text-align:center"></td><td style="text-align:center">è·å–çº¿ç¨‹çŠ¶æ€</td><td style="text-align:center">Javaä¸­çº¿ç¨‹çŠ¶æ€æ˜¯ç”¨6ä¸ªenumè¡¨ç¤ºï¼Œåˆ†åˆ«ä¸ºï¼šNEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATED</td></tr><tr><td style="text-align:center">isInterrupted()</td><td style="text-align:center">static</td><td style="text-align:center">åˆ¤æ–­æ˜¯å¦è¢«æ‰“æ–­</td><td style="text-align:center">ä¸ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</td></tr><tr><td style="text-align:center">isAlive()</td><td style="text-align:center">static</td><td style="text-align:center">çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆè¿˜æ²¡æœ‰è¿è¡Œå®Œæ¯•ï¼‰</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">interrupt()</td><td style="text-align:center">static</td><td style="text-align:center">æ‰“æ–­çº¿ç¨‹</td><td style="text-align:center">å¦‚æœè¢«æ‰“æ–­çº¿ç¨‹æ­£åœ¨sleepã€waitã€joinä¼šå¯¼è‡´è¢«æ‰“æ–­çš„çº¿ç¨‹æŠ›å‡ºInterruptedExceptionï¼Œå¹¶æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼›å¦‚æœæ‰“æ–­çš„æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œåˆ™ä¼šè®¾ç½®æ‰“æ–­æ ‡è®°ï¼›parkçš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¹Ÿä¼šè®¾ç½®æ‰“æ–­æ ‡è®°</td></tr><tr><td style="text-align:center">interrupted()</td><td style="text-align:center">static</td><td style="text-align:center">åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­</td><td style="text-align:center">ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</td></tr></tbody></table><h3 id="startä¸run">startä¸run</h3><h4 id="è°ƒç”¨run">è°ƒç”¨run</h4><ul><li>ç¤ºä¾‹ä»£ç å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Sync&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MP4_FULL_PATH</span> <span class="operator">=</span> <span class="string">&quot;D:\\BaiduNetdiskDownload\\CowboyBebop.mp4&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                read(MP4_FULL_PATH);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).run();</span><br><span class="line">        log.debug(<span class="string">&quot;do other things ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(fileName);</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ((len = fis.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.debug(<span class="string">&quot;è¯»å–æ–‡ä»¶è€—æ—¶ï¼š&#123;&#125;ms&quot;</span>, end - start);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">42</span>:<span class="number">59</span> <span class="selector-attr">[main]</span> c<span class="selector-class">.Sync</span> - <span class="selector-tag">main</span></span><br><span class="line"><span class="number">17</span>:<span class="number">43</span>:<span class="number">03</span> <span class="selector-attr">[main]</span> c<span class="selector-class">.Sync</span> - è¯»å–æ–‡ä»¶è€—æ—¶ï¼š<span class="number">3925ms</span></span><br><span class="line"><span class="number">17</span>:<span class="number">43</span>:<span class="number">03</span> <span class="selector-attr">[main]</span> c<span class="selector-class">.Sync</span> - do other things ...</span><br></pre></td></tr></table></figure><ul><li>ç¨‹åºä»åœ¨mançº¿ç¨‹è¿è¡Œï¼Œread()æ–¹æ³•è°ƒç”¨è¿˜æ˜¯åŒæ­¥çš„</li></ul><h4 id="è°ƒç”¨start">è°ƒç”¨start</h4><ul><li>å°†ä¸Šè¿°ä»£ç ä¸­çš„run()æ”¹ä¸ºstart()ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼Œæ­¤æ—¶è¯»å–æ–‡ä»¶æ˜¯åœ¨t1çº¿ç¨‹ä¸‹å®Œæˆçš„</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">13</span> [main] c.<span class="keyword">Sync </span>- do other things ...</span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">13</span> [<span class="built_in">t1</span>] c.<span class="keyword">Sync </span>- <span class="built_in">t1</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">17</span> [<span class="built_in">t1</span>] c.<span class="keyword">Sync </span>- è¯»å–æ–‡ä»¶è€—æ—¶ï¼š<span class="number">3844</span>ms</span><br></pre></td></tr></table></figure><h4 id="å°ç»“">å°ç»“</h4><ul><li>ç›´æ¥è°ƒç”¨run()æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº†run()ï¼Œå¹¶æ²¡æœ‰ç›´æ¥å¯åŠ¨æ–°çº¿ç¨‹</li><li>ä½¿ç”¨startæ˜¯å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œé€šè¿‡æ–°çš„çº¿ç¨‹é—´æ¥æ‰§è¡Œrun()ä¸­çš„ä»£ç </li></ul><h3 id="sleepå’Œyield">sleepå’Œyield</h3><h4 id="sleep">sleep</h4><ol><li><p>è°ƒç”¨sleepä¼šè®©å½“å‰çº¿ç¨‹ä»Runningè¿›å…¥Timed WaitingçŠ¶æ€ï¼ˆé˜»å¡ï¼‰</p><ul><li>æµ‹è¯•ä»£ç </li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    log.debug(<span class="string">&quot;t1çŠ¶æ€ï¼š&#123;&#125;&quot;</span>,t1.getState());</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;t1çŠ¶æ€ï¼š&#123;&#125;&quot;</span>,t1.getState());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœå¦‚ä¸‹ï¼Œç”±äºä¸»çº¿ç¨‹å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥æ­¤æ—¶t1çŠ¶æ€ä¸ºRUNNABLEï¼Œä¸»çº¿ç¨‹ä¼‘çœ 1såï¼Œå†æ¬¡æŸ¥çœ‹t1çŠ¶æ€ï¼Œæ­¤æ—¶t1æ˜¯é˜»å¡çŠ¶æ€</li></ul> <figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">03</span>:<span class="number">23</span>.<span class="number">500</span> [main] c.<span class="keyword">Sync </span>- <span class="built_in">t1</span>çŠ¶æ€ï¼šRUNNABLE</span><br><span class="line"><span class="number">12</span>:<span class="number">03</span>:<span class="number">24</span>.<span class="number">500</span> [main] c.<span class="keyword">Sync </span>- <span class="built_in">t1</span>çŠ¶æ€ï¼šTIMED_WAITING</span><br></pre></td></tr></table></figure></li><li><p>å…¶ä»–çº¿ç¨‹å¯ä»¥ä½¿ç”¨interruptæ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œæ­¤æ—¶sleepæ–¹æ³•ä¼šæŠ›å‡ºInterruptedException</p><ul><li>ç¤ºä¾‹ä»£ç </li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;t1è¿›å…¥ç¡çœ &quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;t1è¢«æ‰“æ–­é†’æ¥&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    log.debug(<span class="string">&quot;å‡†å¤‡æ‰“æ–­t1&quot;</span>);</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœå¦‚ä¸‹</li></ul> <figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">09</span>:<span class="number">12</span>.<span class="number">789</span> [<span class="built_in">t1</span>] c.<span class="keyword">Sync </span>- <span class="built_in">t1</span>è¿›å…¥ç¡çœ </span><br><span class="line"><span class="number">12</span>:<span class="number">09</span>:<span class="number">12</span>.<span class="number">789</span> [main] c.<span class="keyword">Sync </span>- å‡†å¤‡æ‰“æ–­<span class="built_in">t1</span></span><br><span class="line"><span class="number">12</span>:<span class="number">09</span>:<span class="number">13</span>.<span class="number">842</span> [<span class="built_in">t1</span>] c.<span class="keyword">Sync </span>- <span class="built_in">t1</span>è¢«æ‰“æ–­é†’æ¥</span><br><span class="line">Exception in thread <span class="string">&quot;t1&quot;</span> <span class="keyword">java.lang.RuntimeException: </span><span class="keyword">java.lang.InterruptedException: </span>sleep interrupted</span><br></pre></td></tr></table></figure></li><li><p>ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œï¼Œå› ä¸ºæ­¤æ—¶CPUå¯èƒ½åœ¨æ‰§è¡Œå…¶ä»–çš„çº¿ç¨‹ï¼Œå½“å½“å‰çº¿ç¨‹è·å–åˆ°æ—¶é—´ç‰‡æ—¶æ‰ä¼šå¾—åˆ°æ‰§è¡Œ</p></li><li><p>å»ºè®®ç”¨TimeUnitçš„sleepä»£æ›¿Threadçš„sleepæ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§</p><ul><li>TimeUnitæ˜¯ä¸€ä¸ªæšä¸¾ç±»ï¼Œæä¾›äº†å¯¹æ—¶é—´å•ä½çš„æŠ½è±¡è¡¨ç¤ºï¼Œå¦‚ç§’ã€æ¯«ç§’ã€å¾®ç§’ç­‰ã€‚å®ƒçš„sleepæ–¹æ³•æ¥å—ä¸€ä¸ªæ—¶é—´å€¼å’Œä¸€ä¸ªTimeUnitå‚æ•°ï¼Œç”¨äºæŒ‡å®šçº¿ç¨‹ä¼‘çœ çš„æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œ<code>TimeUnit.SECONDS.sleep(1)</code>è¡¨ç¤ºçº¿ç¨‹ä¼‘çœ 1ç§’ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†SECONDSæ¢æˆHOURã€DAYSç­‰æ—¶é—´å€¼</li></ul></li></ol><h4 id="yield">yield</h4><ol><li>å½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ° yield è¯­å¥æ—¶ï¼Œå®ƒä¼šæš‚åœå½“å‰çš„æ‰§è¡Œï¼Œå°†CPUçš„æ‰§è¡Œæƒäº¤ç»™å…¶ä»–çº¿ç¨‹ã€‚<ul><li>ç¤ºä¾‹ä»£ç </li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;t1 --&gt; &quot;</span> + count++);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œyield</span></span><br><span class="line">            Thread.<span class="keyword">yield</span>();</span><br><span class="line">            System.out.println(<span class="string">&quot;           t2 --&gt; &quot;</span> + count++);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœå¦‚ä¸‹ï¼Œt1è¾“å‡ºäº†10wæ¡ï¼Œt2æ‰1.7w</li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t1 --&gt; <span class="number">106221</span></span><br><span class="line">t1 --&gt; <span class="number">106222</span></span><br><span class="line">        t2 --&gt; <span class="number">17256</span></span><br><span class="line">t1 --&gt; <span class="number">106223</span></span><br><span class="line">t1 --&gt; <span class="number">106224</span></span><br></pre></td></tr></table></figure></li><li>å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨</li></ol><h4 id="çº¿ç¨‹ä¼˜å…ˆçº§">çº¿ç¨‹ä¼˜å…ˆçº§</h4><ul><li>çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤º(hint)è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒ</li><li>å¦‚æœCPUæ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½†CPUé—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨<ul><li>ç¤ºä¾‹ä»£ç </li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;t1 --&gt; &quot;</span> + count++);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;           t2 --&gt; &quot;</span> + count++);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    <span class="comment">// t1è®¾ç½®æœ€ä½ä¼˜å…ˆçº§</span></span><br><span class="line">    t1.setPriority(Thread.MIN_PRIORITY);</span><br><span class="line">    <span class="comment">// t2è®¾ç½®æœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">    t2.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœå¦‚ä¸‹ï¼Œt1æ‰“å°çš„æ¯”t2å¤šï¼ŒCPUé—²çš„æ—¶å€™ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨ <del>ï¼ˆå®ƒå·²ç»æ˜¯ä¸ªæˆç†Ÿçš„è°ƒåº¦å™¨äº†ï¼Œæœ‰è‡ªå·±çš„æƒ³æ³•ï¼‰</del></li></ul>  <figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="title">t2</span> --&gt;</span> <span class="number">64136</span></span><br><span class="line">        <span class="function"><span class="title">t2</span> --&gt;</span> <span class="number">64137</span></span><br><span class="line"><span class="function"><span class="title">t1</span> --&gt;</span> <span class="number">90915</span></span><br><span class="line"><span class="function"><span class="title">t1</span> --&gt;</span> <span class="number">90916</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="joinæ–¹æ³•è¯¦è§£">joinæ–¹æ³•è¯¦è§£</h3><h4 id="ä¸ºä»€ä¹ˆéœ€è¦join">ä¸ºä»€ä¹ˆéœ€è¦join</h4><ul><li>æˆ‘ä»¬ç”¨ä¸‹é¢çš„ä»£ç ä½œä¸ºå¼•å­ï¼Œæ‰“å°çš„ræ˜¯ä»€ä¹ˆï¼Ÿ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;ä¸»çº¿ç¨‹å¼€å§‹&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;t1å¼€å§‹&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        r = <span class="number">10</span>;</span><br><span class="line">        log.debug(<span class="string">&quot;t1ç»“æŸ&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    log.debug(<span class="string">&quot;ç»“æœä¸ºï¼š&#123;&#125;&quot;</span>, r);</span><br><span class="line">    log.debug(<span class="string">&quot;ä¸»çº¿ç¨‹ç»“æŸ&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ†æ<ul><li>å› ä¸ºä¸»çº¿ç¨‹å’Œt1æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œt1çº¿ç¨‹éœ€è¦ä¼‘çœ 1såæ‰èƒ½æ‰§è¡Œ<code>r = 10</code></li><li>è€Œä¸»çº¿ç¨‹ä¸€å¼€å§‹å°±è¦æ‰“å°rçš„ç»“æœï¼Œæ‰€ä»¥åªèƒ½è¾“å‡º<code>r = 0</code></li></ul>  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">09</span>:<span class="number">22.864</span> <span class="selector-attr">[main]</span> c<span class="selector-class">.Sync</span> - ä¸»çº¿ç¨‹å¼€å§‹</span><br><span class="line"><span class="number">13</span>:<span class="number">09</span>:<span class="number">22.958</span> <span class="selector-attr">[t1]</span> c<span class="selector-class">.Sync</span> - t1å¼€å§‹</span><br><span class="line"><span class="number">13</span>:<span class="number">09</span>:<span class="number">22.123</span> <span class="selector-attr">[main]</span> c<span class="selector-class">.Sync</span> - ç»“æœä¸ºï¼š<span class="number">0</span></span><br><span class="line"><span class="number">13</span>:<span class="number">09</span>:<span class="number">22.123</span> <span class="selector-attr">[main]</span> c<span class="selector-class">.Sync</span> - ä¸»çº¿ç¨‹ç»“æŸ</span><br><span class="line"><span class="number">13</span>:<span class="number">09</span>:<span class="number">23.234</span> <span class="selector-attr">[t1]</span> c<span class="selector-class">.Sync</span> - t1ç»“æŸ</span><br></pre></td></tr></table></figure></li><li>è§£å†³æ–¹æ³•<ul><li>åœ¨t1.start()åé¢åŠ ä¸Št1.join()ï¼Œè¿™æ ·ä¸»çº¿ç¨‹ä¼šç­‰å¾…t1æ‰§è¡Œå®Œæ¯•ï¼Œæœ€ç»ˆ<code>r = 10</code></li></ul>  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">12</span>:<span class="number">25.864</span> c<span class="selector-class">.Sync</span> <span class="selector-attr">[main]</span> - ä¸»çº¿ç¨‹å¼€å§‹</span><br><span class="line"><span class="number">13</span>:<span class="number">12</span>:<span class="number">25.915</span> c<span class="selector-class">.Sync</span> <span class="selector-attr">[t1]</span> - t1å¼€å§‹</span><br><span class="line"><span class="number">13</span>:<span class="number">12</span>:<span class="number">26.929</span> c<span class="selector-class">.Sync</span> <span class="selector-attr">[t1]</span> - t1ç»“æŸ</span><br><span class="line"><span class="number">13</span>:<span class="number">12</span>:<span class="number">26.929</span> c<span class="selector-class">.Sync</span> <span class="selector-attr">[main]</span> - ç»“æœä¸ºï¼š<span class="number">10</span></span><br><span class="line"><span class="number">13</span>:<span class="number">12</span>:<span class="number">26.931</span> c<span class="selector-class">.Sync</span> <span class="selector-attr">[main]</span> - ä¸»çº¿ç¨‹ç»“æŸ</span><br></pre></td></tr></table></figure></li></ul><h4 id="ç­‰å¾…å¤šä¸ªç»“æœ">ç­‰å¾…å¤šä¸ªç»“æœ</h4><ul><li>ä¸‹é¢ä»£ç è€—æ—¶å¤§çº¦å¤šä¹…ï¼Ÿ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// ä¼‘çœ 1s</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        r1 = <span class="number">10</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// ä¼‘çœ 2s</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        r2 = <span class="number">20</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.debug(<span class="string">&quot;r1ï¼š&#123;&#125;ï¼Œr2ï¼š&#123;&#125;ï¼Œè€—æ—¶ï¼š&#123;&#125;ms&quot;</span>, r1, r2, end - start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ†æä¸€ä¸‹<ul><li>t1.join()ï¼Œç­‰å¾…t1æ‰§è¡Œå®Œæ¯•ï¼Œä½†t2ä¹Ÿæ²¡æœ‰åœæ­¢ï¼Œä¹Ÿåœ¨è¿è¡Œ</li><li>t2.join()ï¼Œ1såï¼Œæ‰§è¡Œåˆ°æ­¤ï¼Œt2ä¹Ÿè¿è¡Œäº†1sï¼Œå†ç­‰å¾…1sä¹Ÿæ‰§è¡Œå®Œæ¯•äº†</li></ul></li><li>å¦‚æœé¢ å€’ä¸¤ä¸ªjoinï¼Œè¿è¡Œç»“æœä¹Ÿä¸ä¼šå˜ï¼Œæœ€ç»ˆè€—æ—¶å‡ä¸º2så·¦å³</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">13</span>:<span class="number">27</span>:<span class="number">50</span>.<span class="number">041</span> c.Sync<span class="meta"> [main] - r1ï¼š10ï¼Œr2ï¼š20ï¼Œè€—æ—¶ï¼š2010ms</span></span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2023/06/08/pCk5Lxe.png" alt=""></p><h4 id="æœ‰æ—¶æ•ˆçš„join">æœ‰æ—¶æ•ˆçš„join</h4><ul><li>join()æ–¹æ³•è¿˜æœ‰ä¸€ä¸ªå¸¦å‚æ•°çš„ï¼Œå¯ä»¥è®¾å®šæœ€å¤§ç­‰å¾…æ—¶é•¿æ¯«ç§’æ•°<ul><li>æ²¡ç­‰å¤Ÿï¼Œè¾“å‡ºï¼š<code>14:09:44.417 c.Sync [main] - rï¼š0ï¼Œè€—æ—¶ï¼š511ms</code></li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// ä¼‘çœ 1s</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        r = <span class="number">10</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="comment">// æœ€å¤šç­‰0.5s</span></span><br><span class="line">    t1.join(<span class="number">500</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.debug(<span class="string">&quot;rï¼š&#123;&#125;ï¼Œè€—æ—¶ï¼š&#123;&#125;ms&quot;</span>, r, end - start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç­‰å¤Ÿäº†ï¼Œçº¿ç¨‹æ‰§è¡Œç»“æŸä¼šå¯¼è‡´joinç»“æŸï¼Œè™½ç„¶ç­‰1.5sï¼Œä½†1så°±ç»“æŸï¼Œè€—æ—¶1sï¼š<code>14:10:47.975 c.Sync [main] - rï¼š10ï¼Œè€—æ—¶ï¼š1001ms</code></li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// ä¼‘çœ 1s</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        r = <span class="number">10</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="comment">// æœ€å¤šç­‰1.5s</span></span><br><span class="line">    t1.join(<span class="number">1500</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.debug(<span class="string">&quot;rï¼š&#123;&#125;ï¼Œè€—æ—¶ï¼š&#123;&#125;ms&quot;</span>, r, end - start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="interruptæ–¹æ³•è¯¦è§£">interruptæ–¹æ³•è¯¦è§£</h3><h4 id="æ‰“æ–­sleepã€waitã€joinçš„çº¿ç¨‹">æ‰“æ–­sleepã€waitã€joinçš„çº¿ç¨‹</h4><ul><li>è¿™å‡ ä¸ªæ–¹æ³•éƒ½ä¼šè®©çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæ‰“æ–­sleeçš„çº¿ç¨‹ï¼Œä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// ä¼‘çœ 2s</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="comment">// ä¼‘çœ 1sï¼Œæ‰“æ–­t1</span></span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">    log.debug(<span class="string">&quot;t1æ‰“æ–­çŠ¶æ€ï¼š&#123;&#125;&quot;</span>, t1.isInterrupted());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœ</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;Thread-0&quot;</span> java<span class="selector-class">.lang</span><span class="selector-class">.RuntimeException</span>: java<span class="selector-class">.lang</span><span class="selector-class">.InterruptedException</span>: sleep interrupted</span><br><span class="line">at com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo01</span><span class="selector-class">.Sync</span>.lambda<span class="variable">$main</span>$<span class="number">0</span>(Sync<span class="selector-class">.java</span>:<span class="number">25</span>)</span><br><span class="line">at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">750</span>)</span><br><span class="line">Caused by: java<span class="selector-class">.lang</span><span class="selector-class">.InterruptedException</span>: sleep interrupted</span><br><span class="line">at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.sleep</span>(Native Method)</span><br><span class="line">at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.sleep</span>(Thread<span class="selector-class">.java</span>:<span class="number">342</span>)</span><br><span class="line">at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.TimeUnit</span><span class="selector-class">.sleep</span>(TimeUnit<span class="selector-class">.java</span>:<span class="number">386</span>)</span><br><span class="line">at com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo01</span><span class="selector-class">.Sync</span>.lambda<span class="variable">$main</span>$<span class="number">0</span>(Sync<span class="selector-class">.java</span>:<span class="number">23</span>)</span><br><span class="line">... <span class="number">1</span> more</span><br><span class="line"><span class="number">14</span>:<span class="number">33</span>:<span class="number">07.789</span> c<span class="selector-class">.Sync</span> <span class="selector-attr">[main]</span> - t1æ‰“æ–­çŠ¶æ€ï¼šfalse</span><br></pre></td></tr></table></figure><h4 id="æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹">æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹</h4><ul><li>æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹ï¼Œä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> thread.isInterrupted();</span><br><span class="line">            <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ‰“æ–­çŠ¶æ€ï¼š&#123;&#125;&quot;</span>, interrupted);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="comment">// ä¼‘çœ 1sï¼Œæ‰“æ–­t1</span></span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœ</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">14</span>:<span class="number">38</span>:<span class="number">54</span>.<span class="number">278</span> c.Sync<span class="meta"> [t2] -  æ‰“æ–­çŠ¶æ€: true</span></span><br></pre></td></tr></table></figure><h4 id="æ‰“æ–­parkçº¿ç¨‹">æ‰“æ–­parkçº¿ç¨‹</h4><ul><li>æ‰“æ–­parkçº¿ç¨‹ï¼Œä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;æ‰“æ–­çŠ¶æ€ï¼š&#123;&#125;&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">33</span>:<span class="number">57</span>.<span class="number">325</span> c.<span class="keyword">Sync </span>[<span class="built_in">t1</span>] - park...</span><br><span class="line"><span class="number">16</span>:<span class="number">33</span>:<span class="number">58</span>.<span class="number">329</span> c.<span class="keyword">Sync </span>[<span class="built_in">t1</span>] - unpark...</span><br><span class="line"><span class="number">16</span>:<span class="number">33</span>:<span class="number">58</span>.<span class="number">329</span> c.<span class="keyword">Sync </span>[<span class="built_in">t1</span>] - æ‰“æ–­çŠ¶æ€ï¼štrue</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯trueï¼Œåˆ™parkä¼šå¤±æ•ˆï¼Œä¼šä¸€ç›´æ‰“å°è¿™ä¸¤æ¡æ—¥å¿—</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(<span class="string">&quot;æ‰“æ–­çŠ¶æ€ï¼š&#123;&#125;&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight plaintext"><figcaption><span>c.Sync [t1] - park...</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">16:34:51.588 c.Sync [t1] - æ‰“æ–­çŠ¶æ€ï¼štrue</span><br><span class="line">16:34:51.588 c.Sync [t1] - park...</span><br><span class="line">16:34:51.588 c.Sync [t1] - æ‰“æ–­çŠ¶æ€ï¼štrue</span><br><span class="line">16:34:51.588 c.Sync [t1] - park...</span><br><span class="line">16:34:51.588 c.Sync [t1] - æ‰“æ–­çŠ¶æ€ï¼štrue</span><br><span class="line">16:34:51.588 c.Sync [t1] - park...</span><br><span class="line">16:34:51.588 c.Sync [t1] - æ‰“æ–­çŠ¶æ€ï¼štrue</span><br><span class="line">16:34:51.588 c.Sync [t1] - park...</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Tread.interrupted()æ¸…é™¤æ‰“æ–­çŠ¶æ€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;æ‰“æ–­çŠ¶æ€ï¼š&#123;&#125;&quot;</span>, Thread.interrupted());</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">37</span>:<span class="number">37</span>.<span class="number">979</span> c.<span class="keyword">Sync </span>[<span class="built_in">t1</span>] - park...</span><br><span class="line"><span class="number">16</span>:<span class="number">37</span>:<span class="number">38</span>.<span class="number">982</span> c.<span class="keyword">Sync </span>[<span class="built_in">t1</span>] - unpark...</span><br><span class="line"><span class="number">16</span>:<span class="number">37</span>:<span class="number">38</span>.<span class="number">982</span> c.<span class="keyword">Sync </span>[<span class="built_in">t1</span>] - æ‰“æ–­çŠ¶æ€ï¼štrue</span><br></pre></td></tr></table></figure><h3 id="ä¸æ¨èä½¿ç”¨çš„æ–¹æ³•">ä¸æ¨èä½¿ç”¨çš„æ–¹æ³•</h3><ul><li>è¿™ä¸‰ä¸ªæ–¹æ³•å·²ç»è¿‡æ—¶ï¼Œè€Œä¸”å®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”</li></ul><table><thead><tr><th style="text-align:center">æ–¹æ³•å</th><th style="text-align:center">static</th><th style="text-align:center">åŠŸèƒ½è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">stop()</td><td style="text-align:center"></td><td style="text-align:center">åœæ­¢çº¿ç¨‹è¿è¡Œ</td></tr><tr><td style="text-align:center">suspend()</td><td style="text-align:center"></td><td style="text-align:center">æŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œ</td></tr><tr><td style="text-align:center">resume()</td><td style="text-align:center"></td><td style="text-align:center">æ¢å¤çº¿ç¨‹è¿è¡Œ</td></tr></tbody></table><h3 id="ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼">ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</h3><ul><li>ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ï¼ˆTwo Phase Terminationï¼‰<ul><li>åœ¨ä¸€ä¸ªçº¿ç¨‹T1ä¸­å¦‚ä½•ä¼˜é›…çš„ç»ˆæ­¢çº¿ç¨‹T2ï¼Ÿè¿™é‡Œçš„ä¼˜é›…æŒ‡çš„æ˜¯ç»™T2ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼š</li></ul></li></ul><h4 id="é”™è¯¯æ€è·¯">é”™è¯¯æ€è·¯</h4><ul><li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„<code>stop()</code>æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>stopæ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœæ­¤æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”</li></ul></li><li>ä½¿ç”¨<code>System.exit()</code>æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>ç›®çš„ä»…ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢</li></ul></li></ul><h4 id="ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼-interrupt">ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼-interrupt</h4><p><img src="https://s1.ax1x.com/2023/06/08/pCk5jrd.png" alt=""></p><ul><li>åˆ©ç”¨isInterrupted<ul><li>interruptå¯ä»¥æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ— è®ºè¿™ä¸ªçº¿ç¨‹æ˜¯åœ¨sleepã€waitè¿˜æ˜¯æ­£å¸¸è¿è¡Œ</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TPTInterrupt&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TPTInterrupt</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">TPTInterrupt</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TPTInterrupt</span>();</span><br><span class="line">        t.start();</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        t.stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        thread = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> currentThread.isInterrupted();</span><br><span class="line">                <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ–™ç†åäº‹&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;æ‰§è¡Œç›‘æ§è®°å½•&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="comment">// å› ä¸ºsleepè¢«æ‰“æ–­åä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°ä¸ºfalseï¼Œæ‰€ä»¥è¿™é‡Œé‡æ–°è®¾ç½®æ‰“æ–­æ ‡è®°</span></span><br><span class="line">                    thread.interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;ç›‘æ§çº¿ç¨‹&quot;</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœ</li></ul>  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">47</span>:<span class="number">09.479</span> c<span class="selector-class">.TPTInterrupt</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ‰§è¡Œç›‘æ§è®°å½•</span><br><span class="line"><span class="number">15</span>:<span class="number">47</span>:<span class="number">11.484</span> c<span class="selector-class">.TPTInterrupt</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ‰§è¡Œç›‘æ§è®°å½•</span><br><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.InterruptedException</span>: sleep interrupted</span><br><span class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.sleep</span>(Native Method)</span><br><span class="line">    at com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo01</span><span class="selector-class">.TPTInterrupt</span>.lambda<span class="variable">$start</span>$<span class="number">0</span>(Sync<span class="selector-class">.java</span>:<span class="number">59</span>)</span><br><span class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">750</span>)</span><br><span class="line"><span class="number">15</span>:<span class="number">47</span>:<span class="number">12.472</span> c<span class="selector-class">.TPTInterrupt</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ–™ç†åäº‹</span><br></pre></td></tr></table></figure></li></ul><h3 id="ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹">ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹</h3><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJavaçº¿ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒ<code>éå®ˆæŠ¤çº¿ç¨‹</code>è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸ</li><li>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œå°†t1çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹å³ä¸ºéå®ˆæŠ¤çº¿ç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;å®ˆæŠ¤çº¿ç¨‹å¼€å§‹æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;å®ˆæŠ¤çº¿ç¨‹æ‰§è¡Œç»“æŸ&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®è¯¥çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">    t1.setDaemon(<span class="literal">true</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;éå®ˆæŠ¤çº¿ç¨‹æ‰§è¡Œç»“æŸ&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡ºå¦‚ä¸‹ï¼Œå½“ä¸»çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œå®ˆæŠ¤çº¿ç¨‹æœªæ‰“å°<code>å®ˆæŠ¤çº¿ç¨‹æ‰§è¡Œç»“æŸ</code>ï¼Œå°±è¢«å¼ºåˆ¶ç»“æŸäº†</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span>:<span class="number">23</span>:<span class="number">07.989</span> c<span class="selector-class">.Sync</span> <span class="selector-attr">[t1]</span> - å®ˆæŠ¤çº¿ç¨‹å¼€å§‹æ‰§è¡Œ</span><br><span class="line"><span class="number">18</span>:<span class="number">23</span>:<span class="number">08.989</span> c<span class="selector-class">.Sync</span> <span class="selector-attr">[main]</span> - éå®ˆæŠ¤çº¿ç¨‹æ‰§è¡Œç»“æŸ</span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><ul><li>æ³¨æ„ï¼š<ul><li>åƒåœ¾å›æ”¶çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹</li><li>Tomcatä¸­çš„Acceptorå’ŒPollerçº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥Tomcatæ¥æ”¶åˆ°shutdownå‘½ä»¤åç§’å›ç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚</li></ul></li></ul></div><h3 id="äº”ç§çŠ¶æ€">äº”ç§çŠ¶æ€</h3><ul><li>äº”ç§çŠ¶æ€æ˜¯ä»<code>æ“ä½œç³»ç»Ÿ</code>å±‚é¢æ¥æè¿°çš„<ul><li><code>åˆå§‹çŠ¶æ€ä»…</code>æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹ç›¸å…³è”</li><li><code>å¯è¿è¡ŒçŠ¶æ€ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰</code>æŒ‡è¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼ˆä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼‰ï¼Œå¯ä»¥ç”±CPUè°ƒåº¦æ‰§è¡Œ</li><li><code>è¿è¡ŒçŠ¶æ€</code>æŒ‡è·å–äº†CPUæ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€<ul><li>å½“CPUæ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»è¿è¡ŒçŠ¶æ€è½¬æ¢è‡³å¯è¿è¡ŒçŠ¶æ€ï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢</li></ul></li><li><code>é˜»å¡çŠ¶æ€</code><ul><li>å¦‚æœè°ƒç”¨äº†é˜»å¡APIï¼Œå¦‚BIOè¯»å†™æ–‡ä»¶ï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ°CPUï¼Œä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€</li><li>ç­‰BIOæ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³å¯è¿è¡ŒçŠ¶æ€</li><li>ä¸å¯è¿è¡ŒçŠ¶æ€çš„åŒºåˆ«æ˜¯ï¼Œå¯¹é˜»å¡çŠ¶æ€çš„çº¿ç¨‹æ¥è¯´ï¼Œåªè¦å®ƒä»¬ä¸€ç›´ä¸å”¤é†’ï¼Œè°ƒåº¦å™¨å°±ä¸€ç›´ä¸ä¼šè€ƒè™‘è°ƒåº¦å®ƒä»¬</li></ul></li><li><code>ç»ˆæ­¢çŠ¶æ€</code>è¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶ä»–çŠ¶æ€</li></ul></li></ul><p><img src="https://s1.ax1x.com/2023/06/09/pCEYfYV.png" alt=""></p><h3 id="å…­ç§çŠ¶æ€">å…­ç§çŠ¶æ€</h3><ul><li>è¿™æ˜¯ä»Java APIå±‚é¢æ¥æè¿°çš„ï¼Œæ ¹æ®Thread Stateæšä¸¾ï¼Œåˆ†ä¸ºå…­ç§çŠ¶æ€<ul><li><code>NEW</code>ï¼šçº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†è¿˜æ²¡æœ‰è°ƒç”¨start()æ–¹æ³•</li><li><code>RUNNABLE</code>ï¼šå½“è°ƒç”¨äº†start()æ–¹æ³•å  <div class="note warning no-icon flat"><p>æ³¨æ„ï¼šJava APIå±‚é¢çš„RUNNABLEçŠ¶æ€æ¶µç›–äº†æ“ä½œç³»ç»Ÿå±‚é¢çš„å¯è¿è¡ŒçŠ¶æ€ã€è¿è¡ŒçŠ¶æ€å’Œé˜»å¡çŠ¶æ€ï¼ˆç”±äºBIOå¯¼è‡´çš„çº¿ç¨‹é˜»å¡ï¼Œåœ¨Javaé‡Œæ— æ³•åŒºåˆ†ï¼Œä»ç„¶è®¤ä¸ºæ˜¯å¯è¿è¡Œï¼‰</p></div></li><li><code>BLOCKED</code>ã€<code>WAITINT</code>ã€<code>TIMED_WAITING</code>éƒ½æ˜¯Java APIå±‚é¢å¯¹é˜»å¡çŠ¶æ€çš„ç»†åˆ†ï¼Œåé¢ä¼šåœ¨çŠ¶æ€è½¬æ¢ä¸€èŠ‚è¯¦ç»†æè¿°</li><li><code>TERMINATED</code>ï¼šå½“çº¿ç¨‹ä»£ç è¿è¡Œç»“æŸ</li></ul></li></ul><p><img src="https://s1.ax1x.com/2023/06/09/pCEtCmd.png" alt=""></p><ul><li>ä¸‹é¢æˆ‘ä»¬ç”¨ä»£ç æ¥éªŒè¯ä¸€ä¸‹è¿™å…­ç§çŠ¶æ€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestState&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestState</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1. t1çº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œè¿˜æœªè°ƒç”¨start()æ–¹æ³•ï¼Œæ­¤æ—¶çŠ¶æ€ä¸º NEW</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. t2çº¿ç¨‹å·²è¢«åˆ›å»ºï¼Œå¹¶ä¸”è°ƒç”¨äº†start()æ–¹æ³•ï¼Œç©ºå¾ªåä¼šä¿è¯t2çº¿ç¨‹ä¸ä¼šç»“æŸï¼Œæ­¤æ—¶çŠ¶æ€ä¸ºRUNNABLE</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="literal">true</span>) &#123; <span class="comment">// runnable</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. t3çº¿ç¨‹åªæ˜¯æ‰“å°ä¸€æ¡æ—¥å¿—ï¼Œç”±äºä¸»çº¿ç¨‹ä¸­è°ƒç”¨äº†sleep()ï¼Œæ•…å½“æˆ‘ä»¬æŸ¥çœ‹t3çº¿ç¨‹çŠ¶æ€æ—¶ï¼Œt3å·²ç»æ‰§è¡Œå®Œæ¯•ï¼ŒçŠ¶æ€ä¸ºTERMINATED</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t3&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t3.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. t4çº¿ç¨‹ä¸­è°ƒç”¨äº†sleep()æ–¹æ³•ï¼ŒçŠ¶æ€ä¸ºtimed_waitingï¼Œå³æœ‰æ—¶é™çš„ç­‰å¾…ï¼Œæ³¨æ„æ­¤æ—¶t4è¿˜æ‹¿åˆ°äº†ä¸€æŠŠé”ï¼Œåé¢è¦ç”¨</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t4&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (TestState.class) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000000</span>); <span class="comment">// timed_waiting</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t4.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. t5çº¿ç¨‹ä¸­è°ƒç”¨äº†t2.join()ï¼Œéœ€è¦ç­‰å¾…t2çº¿ç¨‹ç»“æŸï¼Œæ•…çŠ¶æ€ä¸ºwaitingï¼Œå³æ— æ—¶é™çš„ç­‰å¾…</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t5&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    t2.join(); <span class="comment">// waiting</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t5.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. ç”±äºt4çº¿ç¨‹æ‹¿åˆ°äº†é”ï¼Œä½†ç”±äºt4åœ¨sleepï¼Œæ•…t6çº¿ç¨‹æ‹¿ä¸åˆ°é”ï¼Œä¼šè¢«é˜»å¡ï¼ŒçŠ¶æ€ä¸ºblocked</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t6&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (TestState.class) &#123; <span class="comment">// blocked</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t6.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;t1 state &#123;&#125;&quot;</span>, t1.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t2 state &#123;&#125;&quot;</span>, t2.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t3 state &#123;&#125;&quot;</span>, t3.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t4 state &#123;&#125;&quot;</span>, t4.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t5 state &#123;&#125;&quot;</span>, t5.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t6 state &#123;&#125;&quot;</span>, t6.getState());</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">02</span>:<span class="number">48.753</span> c.TestState [t3] - running...</span><br><span class="line"><span class="number">11</span>:<span class="number">02</span>:<span class="number">49.264</span> c.TestState [main] - t1 <span class="keyword">state</span> NEW</span><br><span class="line"><span class="number">11</span>:<span class="number">02</span>:<span class="number">49.265</span> c.TestState [main] - t2 <span class="keyword">state</span> RUNNABLE</span><br><span class="line"><span class="number">11</span>:<span class="number">02</span>:<span class="number">49.265</span> c.TestState [main] - t3 <span class="keyword">state</span> TERMINATED</span><br><span class="line"><span class="number">11</span>:<span class="number">02</span>:<span class="number">49.265</span> c.TestState [main] - t4 <span class="keyword">state</span> TIMED_WAITING</span><br><span class="line"><span class="number">11</span>:<span class="number">02</span>:<span class="number">49.265</span> c.TestState [main] - t5 <span class="keyword">state</span> WAITING</span><br><span class="line"><span class="number">11</span>:<span class="number">02</span>:<span class="number">49.265</span> c.TestState [main] - t6 <span class="keyword">state</span> BLOCKED</span><br></pre></td></tr></table></figure><h3 id="åº”ç”¨ï¼šçƒ§æ°´æ³¡èŒ¶">åº”ç”¨ï¼šçƒ§æ°´æ³¡èŒ¶</h3><ul><li>é˜…è¯»åç½—åºšã€Šç»Ÿç­¹æ–¹æ³•ã€‹ï¼Œç»™å‡ºçƒ§æ°´æ³¡èŒ¶çš„å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆ</li></ul><div class="note info no-icon flat"><ul><li><p>ç»Ÿç­¹æ–¹æ³•ï¼Œæ˜¯ä¸€ç§å®‰æ’å·¥ä½œè¿›ç¨‹çš„æ•°å­¦æ–¹æ³•ã€‚å®ƒçš„å®ç”¨èŒƒå›´æå¹¿æ³›ï¼Œåœ¨ä¼ä¸šç®¡ç†å’ŒåŸºæœ¬å»ºè®¾ä¸­ï¼Œä»¥åŠå…³ç³»å¤æ‚çš„ç§‘ç ”é¡¹ç›®çš„ç»„ç»‡ä¸ç®¡ç†ä¸­ï¼Œéƒ½å¯ä»¥åº”ç”¨ã€‚</p></li><li><p>æ€æ ·åº”ç”¨å‘¢ï¼Ÿä¸»è¦æ˜¯æŠŠå·¥åºå®‰æ’å¥½ã€‚</p></li><li><p>æ¯”å¦‚ï¼Œæƒ³æ³¡å£¶èŒ¶å–ã€‚å½“æ—¶çš„æƒ…å†µæ˜¯ï¼šå¼€æ°´æ²¡æœ‰ï¼›æ°´å£¶è¦æ´—ï¼ŒèŒ¶å£¶ã€èŒ¶æ¯è¦æ´—ï¼›ç«å·²ç”Ÿäº†ï¼ŒèŒ¶å¶ä¹Ÿæœ‰äº†ã€‚æ€ä¹ˆåŠï¼Ÿ</p><ul><li>åŠæ³•ç”²ï¼šæ´—å¥½æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼›åœ¨ç­‰å¾…æ°´å¼€çš„æ—¶é—´é‡Œï¼Œæ´—èŒ¶å£¶ã€æ´—èŒ¶æ¯ã€æ‹¿èŒ¶å¶ï¼›ç­‰æ°´å¼€äº†ï¼Œæ³¡èŒ¶å–ã€‚</li><li>åŠæ³•ä¹™ï¼šå…ˆåšå¥½ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ´—æ°´å£¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ‹¿èŒ¶å¶ï¼›ä¸€åˆ‡å°±ç»ªï¼ŒçŒæ°´çƒ§æ°´ï¼›åå¾…æ°´å¼€äº†ï¼Œæ³¡èŒ¶å–ã€‚</li><li>åŠæ³•ä¸™ï¼šæ´—å‡€æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼Œåå¾…æ°´å¼€ï¼›æ°´å¼€äº†ä¹‹åï¼Œæ€¥æ€¥å¿™å¿™æ‰¾èŒ¶å¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ³¡èŒ¶å–ã€‚</li></ul></li><li><p>å“ªä¸€ç§åŠæ³•çœæ—¶é—´ï¼Ÿæˆ‘ä»¬èƒ½ä¸€çœ¼çœ‹å‡ºï¼Œç¬¬ä¸€ç§åŠæ³•å¥½ï¼Œåä¸¤ç§åŠæ³•éƒ½çªäº†å·¥ã€‚</p></li><li><p>è¿™æ˜¯å°äº‹ï¼Œä½†è¿™æ˜¯å¼•å­ï¼Œå¯ä»¥å¼•å‡ºç”Ÿäº§ç®¡ç†ç­‰æ–¹é¢æœ‰ç”¨çš„æ–¹æ³•æ¥ã€‚</p></li><li><p>æ°´å£¶ä¸æ´—ï¼Œä¸èƒ½çƒ§å¼€æ°´ï¼Œå› è€Œæ´—æ°´å£¶æ˜¯çƒ§å¼€æ°´çš„å‰æã€‚æ²¡å¼€æ°´ã€æ²¡èŒ¶å¶ã€ä¸æ´—èŒ¶å£¶èŒ¶æ¯ï¼Œå°±ä¸èƒ½æ³¡èŒ¶ï¼Œå› è€Œè¿™äº›åˆæ˜¯æ³¡èŒ¶çš„å‰æã€‚å®ƒä»¬çš„ç›¸äº’å…³ç³»ï¼Œå¯ä»¥ç”¨ä¸‹è¾¹çš„ç®­å¤´å›¾æ¥è¡¨ç¤ºï¼š<br><img src="https://s1.ax1x.com/2023/06/10/pCEHn0g.png" alt=""></p></li><li><p>ä»è¿™ä¸ªå›¾ä¸Šå¯ä»¥ä¸€çœ¼çœ‹å‡ºï¼ŒåŠæ³•ç”²æ€»å…±è¦16åˆ†é’Ÿï¼ˆè€ŒåŠæ³•ä¹™ã€ä¸™éœ€è¦20åˆ†é’Ÿï¼‰ã€‚å¦‚æœè¦ç¼©çŸ­å·¥æ—¶ã€æé«˜å·¥ä½œæ•ˆç‡ï¼Œåº”å½“ä¸»è¦æŠ“çƒ§å¼€æ°´è¿™ä¸ªç¯èŠ‚ï¼Œè€Œä¸æ˜¯æŠ“æ‹¿èŒ¶å¶ç­‰ç¯èŠ‚ã€‚åŒæ—¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ã€æ‹¿èŒ¶å¶æ€»å…±ä¸è¿‡4åˆ†é’Ÿï¼Œå¤§å¯åˆ©ç”¨â€œç­‰æ°´å¼€â€çš„æ—¶é—´æ¥åšã€‚</p></li><li><p>æ˜¯çš„ï¼Œè¿™å¥½åƒæ˜¯åºŸè¯ï¼Œå‘ä¹‹æ— ç”šé«˜è®ºã€‚æœ‰å¦‚èµ°è·¯è¦ç”¨ä¸¤æ¡è…¿èµ°ï¼Œåƒé¥­è¦ä¸€å£ä¸€å£åƒï¼Œè¿™äº›é“ç†è°éƒ½æ‡‚å¾—ã€‚ä½†ç¨æœ‰å˜åŒ–ï¼Œä¸´äº‹è€Œè¿·çš„æƒ…å†µï¼Œå¸¸å¸¸æ˜¯å­˜åœ¨çš„ã€‚åœ¨è¿‘ä»£å·¥ä¸šçš„é”™ç»¼å¤æ‚çš„å·¥è‰ºè¿‡ç¨‹ä¸­ï¼Œå¾€å¾€å°±ä¸æ˜¯åƒæ³¡èŒ¶å–è¿™ä¹ˆç®€å•äº†ã€‚ä»»åŠ¡å¤šäº†ï¼Œå‡ ç™¾å‡ åƒï¼Œç”šè‡³æœ‰å¥½å‡ ä¸‡ä¸ªä»»åŠ¡ã€‚å…³ç³»å¤šäº†ï¼Œé”™ç»¼å¤æ‚ï¼Œåƒå¤´ä¸‡ç»ªï¼Œå¾€å¾€å‡ºç°â€œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£â€çš„æƒ…å†µã€‚ç”±äºä¸€ä¸¤ä¸ªé›¶ä»¶æ²¡å®Œæˆï¼Œè€½è¯¯äº†ä¸€å°å¤æ‚æœºå™¨çš„å‡ºå‚æ—¶é—´ã€‚æˆ–å¾€å¾€å› ä¸ºæŠ“çš„ä¸æ˜¯å…³é”®ï¼Œè¿å¤œä¸‰ç­ï¼Œæ€¥æ€¥å¿™å¿™ï¼Œå®Œæˆè¿™ä¸€ç¯èŠ‚ä¹‹åï¼Œè¿˜å¾—ç­‰å¾…æ—çš„ç¯èŠ‚æ‰èƒ½è£…é…ã€‚æ´—èŒ¶å£¶ï¼Œæ´—èŒ¶æ¯ï¼Œæ‹¿èŒ¶å¶ï¼Œæˆ–å…ˆæˆ–åï¼Œå…³ç³»ä¸å¤§ï¼Œè€Œä¸”åŒæ˜¯ä¸€ä¸ªäººçš„æ´»å„¿ï¼Œå› è€Œå¯ä»¥åˆå¹¶æˆä¸ºï¼š<br><img src="https://s1.ax1x.com/2023/06/10/pCEHJXT.png" alt=""></p></li><li><p>çœ‹æ¥è¿™æ˜¯&quot;å°é¢˜å¤§åš&quot;ï¼Œä½†åœ¨å·¥ä½œç¯èŠ‚å¤ªå¤šçš„æ—¶å€™ï¼Œè¿™æ ·åšå°±éå¸¸å¿…è¦äº†</p></li><li><p>è¿™é‡Œè®²çš„ä¸»è¦æ˜¯æ—¶é—´æ–¹é¢çš„äº‹ï¼Œä½†åœ¨å…·ä½“ç”Ÿäº§å®è·µä¸­ï¼Œè¿˜æœ‰å…¶ä»–æ–¹é¢çš„è®¸å¤šäº‹ã€‚è¿™ç§æ–¹æ³•è™½ç„¶ä¸ä¸€å®šèƒ½ç›´æ¥è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬åˆ©ç”¨è¿™ç§æ–¹æ³•æ¥è€ƒè™‘é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸æ— è£¨ç›Šçš„ã€‚</p></li></ul></div><h4 id="è§£æ³•1ï¼šjoin">è§£æ³•1ï¼šjoin</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.MakeTea&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestTea</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;æ´—æ°´å£¶&quot;</span>);</span><br><span class="line">            sleep(<span class="number">15</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;çƒ§å¼€æ°´&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;Kyle&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;æ´—èŒ¶å£¶&quot;</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;æ´—èŒ¶æ¯&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;æ‹¿èŒ¶å¶&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t1.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;æ³¡èŒ¶&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;Lucy&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœ</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">55</span>:<span class="number">52.453</span> c<span class="selector-class">.MakeTea</span> <span class="selector-attr">[Lucy]</span> - æ´—èŒ¶å£¶</span><br><span class="line"><span class="number">13</span>:<span class="number">55</span>:<span class="number">52.453</span> c<span class="selector-class">.MakeTea</span> <span class="selector-attr">[Kyle]</span> - æ´—æ°´å£¶</span><br><span class="line"><span class="number">13</span>:<span class="number">55</span>:<span class="number">54.458</span> c<span class="selector-class">.MakeTea</span> <span class="selector-attr">[Lucy]</span> - æ´—èŒ¶æ¯</span><br><span class="line"><span class="number">13</span>:<span class="number">55</span>:<span class="number">55.469</span> c<span class="selector-class">.MakeTea</span> <span class="selector-attr">[Lucy]</span> - æ‹¿èŒ¶å¶</span><br><span class="line"><span class="number">13</span>:<span class="number">56</span>:<span class="number">07.463</span> c<span class="selector-class">.MakeTea</span> <span class="selector-attr">[Kyle]</span> - çƒ§å¼€æ°´  </span><br><span class="line"><span class="number">13</span>:<span class="number">56</span>:<span class="number">07.463</span> c<span class="selector-class">.MakeTea</span> <span class="selector-attr">[Lucy]</span> - æ³¡èŒ¶ </span><br></pre></td></tr></table></figure><ul><li>æ­¤ç§è§£æ³•çš„ç¼ºé™·<ul><li>ä¸Šé¢æ¨¡æ‹Ÿçš„æ˜¯Lucyç­‰Kyleçš„æ°´çƒ§å¼€äº†ï¼ŒLucyæ³¡èŒ¶ï¼Œå¦‚æœç°åœ¨è¦è®©Kyleç­‰LucyæŠŠèŒ¶å¶æ‹¿è¿‡æ¥ï¼Œç”±Kyleæ³¡èŒ¶å‘¢ï¼Ÿ</li><li>ä¸Šé¢ä¸¤ä¸ªçº¿ç¨‹å…¶å®æ˜¯å„æ‰§è¡Œå„çš„ï¼Œå¦‚æœè¦æ¨¡æ‹ŸKyleæŠŠæ°´å£¶äº¤ç»™Lucyæ³¡èŒ¶ï¼Œæˆ–è€…æ¨¡æ‹ŸLucyæŠŠèŒ¶å¶äº¤ç»™Kyleæ³¡èŒ¶å‘¢ï¼Ÿ</li></ul></li><li>è¿™ä¸ªç¼ºé™·æˆ‘ä»¬åé¢ä¼šè§£å†³</li></ul><h2 id="å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹">å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</h2><h3 id="å…±äº«å¸¦æ¥çš„é—®é¢˜">å…±äº«å¸¦æ¥çš„é—®é¢˜</h3><h4 id="å°æ•…äº‹">å°æ•…äº‹</h4><ul><li>è€ç‹ï¼ˆæ“ä½œç³»ç»Ÿï¼‰æœ‰ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ç®—ç›˜ï¼ˆCPUï¼‰ï¼Œç°åœ¨è€ç‹æƒ³æŠŠç®—ç›˜ç§Ÿå‡ºå»ï¼Œèµšç‚¹å¤–å¿«</li><li>å°å—å’Œå°å¥³ï¼ˆçº¿ç¨‹ï¼‰æ¥ä½¿ç”¨è¿™ä¸ªç®—ç›˜æ¥è¿›è¡Œä¸€äº›è®¡ç®—ï¼Œå¹¶æŒ‰ç…§æ—¶é—´ç»™è€ç‹æ”¯ä»˜è´¹ç”¨</li><li>ä½†å°å—ä¹Ÿä¸èƒ½ä¸€å¤©24å°æ—¶ä½¿ç”¨ç®—ç›˜ï¼Œä»–å¾—æ—¶ä¸æ—¶å°æ†©ä¸€ä¼šå„¿ï¼ˆsleepï¼‰ï¼Œåˆæˆ–è€…å»åƒé¥­ä¸Šå•æ‰€ï¼ˆé˜»å¡IOæ“ä½œï¼‰ï¼Œæœ‰æ—¶å€™è¿˜éœ€è¦ä¸€æ ¹çƒŸï¼Œæ²¡çƒŸçš„æ—¶å€™æ€è·¯å…¨æ— ï¼ˆwaitï¼‰è¿™äº›æƒ…å†µç»Ÿç§°ä¸ºé˜»å¡</li><li>åœ¨ä¸Šé¢çš„é‚£äº›æƒ…å†µä¸‹ï¼Œç®—ç›˜æ²¡åˆ©ç”¨èµ·æ¥ï¼Œè€ç‹è§‰å¾—æœ‰ç‚¹ä¸åˆ’ç®—</li><li>å¦å¤–ï¼Œå°å¥³ä¹Ÿæƒ³ç”¨ç”¨ç®—ç›˜ï¼Œå¦‚æœæ€»æ˜¯è®©å°å—å ç€ç®—ç›˜ï¼Œå°å¥³ä¼šè§‰å¾—å¾ˆä¸å…¬å¹³</li><li>äºæ˜¯ï¼Œè€ç‹çµæœºä¸€åŠ¨ï¼Œæƒ³äº†ä¸ªåŠæ³•ï¼Œè®©ä»–ä»¬æ²¡äººç”¨ä¸€ä¼šå„¿ï¼Œè½®æµä½¿ç”¨ç®—ç›˜ï¼ˆCPUæ—¶é—´ç‰‡ï¼‰</li><li>è¿™æ ·ï¼Œå½“å°å—é˜»å¡çš„æ—¶å€™ï¼Œç®—ç›˜å¯ä»¥åˆ†é…ç»™å°å¥³ç”¨ï¼Œä¸ä¼šæµªè´¹ï¼Œåä¹‹äº¦ç„¶</li><li>æœ€è¿‘æ‰§è¡Œçš„è®¡ç®—æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦å­˜å‚¨ä¸€äº›ä¸­é—´ç»“æœï¼Œè€Œå°å—å’Œå°å¥³çš„è„‘å®¹é‡ï¼ˆå·¥ä½œå†…å­˜ï¼‰ä¸å¤Ÿï¼Œæ‰€ä»¥è€ç‹ç”³è¯·äº†ä¸€ä¸ªç¬”è®°æœ¬ï¼ˆä¸»å­˜ï¼‰ï¼ŒæŠŠä¸€äº›ä¸­é—´ç»“æœå…ˆè®°åœ¨æœ¬ä¸Š</li><li>ä½†ç”±äºåˆ†æ—¶ç³»ç»Ÿï¼Œæœ‰ä¸€å¤©è¿˜æ˜¯å‘ç”Ÿäº†äº‹æ•…</li><li>å°å—ä»ç¬”è®°æœ¬ä¸Šè¯»å–äº†åˆå€¼0ï¼Œåšäº†ä¸€ä¸ªè‡ªå¢+1è®¡ç®—ï¼Œè¿˜æ²¡æ¥å¾—åŠå†™å›ç»“æœï¼Œæ­¤æ—¶è½®åˆ°å°å¥³ç”¨äº†</li><li>äºæ˜¯å°å—å˜´é‡Œå¿µå¨ç€ï¼Œç»“æœæ˜¯1ç»“æœæ˜¯1â€¦ï¼Œä¸ç”˜å¿ƒçš„ä¸Šä¸€è¾¹å¾…ç€å»äº†ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰</li><li>å°å¥³æ­¤æ—¶çœ‹åˆ°ç¬”è®°æœ¬ä¸Šæ˜¯0ï¼Œäºæ˜¯åšäº†ä¸€ä¸ª-1çš„è¿ç®—ï¼Œå¹¶å°†ç»“æœ-1å†™åˆ°ç¬”è®°æœ¬ä¸Šï¼Œæ­¤æ—¶å°å¥³çš„æ—¶é—´ä¹Ÿç”¨å®Œäº†ï¼Œåˆè½®åˆ°å°å—äº†</li><li>å°å—æ­¤æ—¶å°†å˜´é‡Œä¸€ç›´å¿µå¨çš„1ï¼Œå†™å…¥äº†ç¬”è®°æœ¬</li><li>æœ€ç»ˆå°å—å’Œå°å¥³éƒ½è§‰å¾—è‡ªå·±æ²¡åšé”™ï¼Œä½†ç¬”è®°æœ¬ä¸­çš„ç»“æœæ˜¯1è€Œä¸æ˜¯0</li></ul><h4 id="Javaçš„ä½“ç°">Javaçš„ä½“ç°</h4><ul><li>ä¸¤ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªåˆå€¼ä¸º0çš„é™æ€å˜é‡åšè‡ªå¢å’Œè‡ªå‡æ“ä½œï¼Œå„æ‰§è¡Œ5000æ¬¡ï¼Œè§‚å¯Ÿç»“æœ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestCalculate&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCalculate</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                num++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                num--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;ç»“æœä¸ºï¼š&#123;&#125;&quot;</span>, num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¤šæ¬¡è¿è¡Œï¼Œæˆ‘ä»¬ä¼šå‘ç°ç»“æœæœ‰æ­£æœ‰è´Ÿï¼Œä¹Ÿæœ‰å¯èƒ½ä¸º0</li></ul><h4 id="é—®é¢˜åˆ†æ">é—®é¢˜åˆ†æ</h4><ul><li>ä¸ºä»€ä¹ˆä¸Šé¢çš„ç»“æœä¸ç¡®å®šå‘¢ï¼Ÿå› ä¸ºJavaä¸­å¯¹é™æ€å˜é‡çš„è‡ªå¢ã€è‡ªå‡æ“ä½œå¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œè¿™éƒ¨åˆ†åœ¨æˆ‘è¿™ç¯‡æ–‡ç« çš„ç¬¬äºŒå°èŠ‚ä¸­åšäº†è¯¦ç»†çš„è§£é‡Š</li></ul><div class="tag link"><a class="link-card" title="JVMå†…å­˜æ¨¡å‹" href="https://cyborg2077.github.io/2023/04/11/JvmPart5/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">JVMå†…å­˜æ¨¡å‹</p><p class="url">https://cyborg2077.github.io/2023/04/11/JvmPart5/</p></div></a></div><ul><li>å¯¹äº<code>i++</code>(iä¸ºé™æ€å˜é‡)ï¼Œå®é™…ä¸Šä¼šäº§ç”Ÿå¦‚ä¸‹å­—èŠ‚ç æŒ‡ä»¤</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getstatic i     <span class="comment">// è·å–é™æ€å˜é‡içš„å€¼</span></span><br><span class="line">iconst_1        <span class="comment">// å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">iadd            <span class="comment">// è‡ªå¢</span></span><br><span class="line">putstatic i     <span class="comment">// å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i</span></span><br></pre></td></tr></table></figure><ul><li>å¯¹äº<code>i--</code>ä¹Ÿæ˜¯ç±»ä¼¼</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getstatic i     <span class="comment">// è·å–é™æ€å˜é‡içš„å€¼</span></span><br><span class="line">iconst_1        <span class="comment">// å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">isub            <span class="comment">// è‡ªå‡</span></span><br><span class="line">putstatic i     <span class="comment">// å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i</span></span><br></pre></td></tr></table></figure><ul><li>Javaçš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢ã€è‡ªå‡éœ€è¦åœ¨ä¸»å­˜ä¸çº¿ç¨‹å†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢<br><img src="https://s1.ax1x.com/2023/04/11/ppOSFv4.png" alt=""></li><li>å‡ºç°è´Ÿæ•°çš„æƒ…å†µ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾içš„åˆå§‹å€¼ä¸º0</span></span><br><span class="line">getstatic i         <span class="comment">// çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0</span></span><br><span class="line">getstatic i         <span class="comment">// çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0</span></span><br><span class="line">iconst_1            <span class="comment">// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">iadd                <span class="comment">// çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1</span></span><br><span class="line">putstatic i         <span class="comment">// çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1</span></span><br><span class="line">iconst_1            <span class="comment">// çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">isub                <span class="comment">// çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1</span></span><br><span class="line">putstatic i         <span class="comment">// çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1</span></span><br></pre></td></tr></table></figure><ul><li>å‡ºç°æ­£æ•°çš„æƒ…å†µ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾içš„åˆå§‹å€¼ä¸º0</span></span><br><span class="line">getstatic i         <span class="comment">// çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0</span></span><br><span class="line">getstatic i         <span class="comment">// çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0</span></span><br><span class="line">iconst_1            <span class="comment">// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">iadd                <span class="comment">// çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1</span></span><br><span class="line">iconst_1            <span class="comment">// çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">isub                <span class="comment">// çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1</span></span><br><span class="line">putstatic i         <span class="comment">// çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1</span></span><br><span class="line">putstatic i         <span class="comment">// çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1</span></span><br></pre></td></tr></table></figure><h4 id="ä¸´ç•ŒåŒº-Critical-Section">ä¸´ç•ŒåŒº(Critical Section)</h4><ul><li>ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œé—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®<code>å…±äº«èµ„æº</code><ul><li>å¤šä¸ªçº¿ç¨‹è¯»<code>å…±äº«èµ„æº</code>å…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜</li><li>åœ¨å¤šä¸ªçº¿ç¨‹å¯¹<code>å…±äº«èµ„æº</code>è¯»å†™æ“ä½œæ—¶ï¼Œå‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜</li></ul></li><li>ä¸€æ®µä»£ç å†…å¦‚æœå­˜åœ¨å¯¹<code>å…±äº«èµ„æº</code>çš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œåˆ™ç§°è¿™æ®µä»£ç ä¸º<code>ä¸´ç•ŒåŒº</code></li></ul><h4 id="ç«æ€æ¡ä»¶-Race-Condition">ç«æ€æ¡ä»¶(Race Condition)</h4><ul><li>å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„<code>æ‰§è¡Œåºåˆ—ä¸åŒ</code>ï¼Œè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œåˆ™ç§°ä¹‹ä¸ºå‘ç”Ÿäº†<code>ç«æ€æ¡ä»¶</code></li></ul><h3 id="synchronizedè§£å†³æ–¹æ¡ˆ">synchronizedè§£å†³æ–¹æ¡ˆ</h3><ul><li>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„<ul><li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedã€Lock</li><li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡</li></ul></li><li>è¿™é‡Œä½¿ç”¨é˜»å¡å¼è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼Œæ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå³ä¿—ç§°çš„<code>å¯¹è±¡é”</code>ï¼Œå®ƒé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€æ—¶åˆ»è‡³å¤šæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰<code>å¯¹è±¡é”</code>ï¼Œå…¶ä»–çº¿ç¨‹å†æƒ³è·å–è¿™ä¸ª<code>å¯¹è±¡é”</code>æ—¶å°±ä¼šé˜»å¡ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li></ul><div class="note warning no-icon flat"><ul><li>æ³¨æ„ï¼šè™½ç„¶Javaä¸­çš„äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨synchronizedå…³é”®å­—æ¥å®Œæˆï¼Œä½†å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š<ul><li>äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç </li><li>åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒï¼Œéœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹</li></ul></li></ul></div><ul><li>synchronizedè¯­æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(å¯¹è±¡) &#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è§£å†³</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestCalculate&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCalculate</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                    num++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                    num--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;ç»“æœä¸ºï¼š&#123;&#125;&quot;</span>, num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥æŠŠobjæƒ³è±¡æˆä¸€é—´æˆ¿é—´ï¼ˆæ’¤ç¡•ï¼‰ï¼Œçº¿ç¨‹t1ã€çº¿ç¨‹t2æƒ³è±¡æˆä¸¤ä¸ªäºº</li><li>å½“çº¿ç¨‹t1æ‰§è¡Œåˆ°<code>synchronized(obj)</code>æ—¶ï¼Œå°±å¥½æ¯”t1è¿›å…¥äº†æ’¤ç¡•ï¼Œå¹¶åæ‰‹é”ä½äº†é—¨ï¼Œåœ¨é—¨å†…æ‰§è¡Œ<code>i++</code>æ“ä½œ</li><li>æ­¤æ—¶å¦‚æœt2ä¹Ÿè¿è¡Œåˆ°äº†<code>synchronized(obj)</code>ï¼Œå®ƒå‘ç°é—¨è¢«é”ä½äº†ï¼Œåªèƒ½åœ¨é—¨å¤–ç­‰å¾…</li><li>å½“t1æ‰§è¡Œå®Œsynchronizedå—å†…çš„ä»£ç ï¼Œæ­¤æ—¶æ‰ä¼šè§£å¼€é—¨ä¸Šçš„é”ï¼Œä»æ’¤ç¡•å‡ºæ¥ï¼Œt2çº¿ç¨‹æ­¤æ—¶æ‰å¯ä»¥è¿›å…¥æ’¤ç¡•ï¼Œå¹¶åæ‰‹é”ä½é—¨ï¼Œæ‰§è¡Œå®ƒçš„<code>i--</code>æ“ä½œ</li></ul><h4 id="æ€è€ƒ">æ€è€ƒ</h4><ul><li>synchronizedå®é™…ä¸Šæ˜¯ä½¿ç”¨å¯¹è±¡é”ä¿è¯äº†ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­ã€‚ä¸ºäº†åŠ æ·±ç†è§£ï¼Œæˆ‘ä»¬æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜<ol><li>å¦‚æœæŠŠsynchronized(obj)æ”¾åœ¨forå¾ªç¯å¤–é¢ï¼Œå¦‚ä½•ç†è§£ï¼Ÿ<ul><li>ä»…åœ¨i++æ“ä½œä¸ŠåŠ é”ï¼Œé”ä½äº†4æ¡è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œä½†æ˜¯å¤–å±‚å¾ªç¯äº†5Wæ¬¡ï¼Œé‚£å°±è¦åŠ é”è§£é”5Wæ¬¡ï¼Œè¿™æ ·æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨forå¾ªç¯ä¸ŠåŠ é”ï¼Œè¿™æ ·å°±åªç”¨è§£é”ä¸€æ¬¡</li></ul></li><li>å¦‚æœt1 synchronized(obj1)ï¼Œè€Œt2 synchronized(obj2)ä¼šæ€æ ·è¿ä½œï¼Ÿ<ul><li>å¦‚æœt1é”ä½çš„æ˜¯obj1å¯¹è±¡ï¼Œt2é”ä½çš„æ˜¯obj2å¯¹è±¡ï¼Œå°±å¥½æ¯”ä¸¤ä¸ªäººè¿›å…¥äº†ä¸¤ä¸ªä¸åŒçš„æ’¤ç¡•ï¼Œæ²¡æ³•èµ·åˆ°åŒæ­¥çš„æ•ˆæœ</li></ul></li><li>å¦‚æœt1 synchronized(obj)ï¼Œè€Œt2æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ ·ï¼Ÿ<ul><li>è¿™æ„å‘³ç€çº¿ç¨‹ t2 å¯ä»¥è‡ªç”±åœ°å¯¹ num è¿›è¡Œè‡ªå‡æ“ä½œï¼Œå¯èƒ½ä¼šåœ¨çº¿ç¨‹ t1 ä¿®æ”¹ num çš„è¿‡ç¨‹ä¸­ï¼Œè¯»å–åˆ°ä¸€ä¸ªä¸­é—´çŠ¶æ€çš„ num å€¼ã€‚</li></ul></li></ol></li></ul><h4 id="é¢å‘å¯¹è±¡æ”¹è¿›">é¢å‘å¯¹è±¡æ”¹è¿›</h4><ul><li>å¯ä»¥æŠŠéœ€è¦ä¿æŠ¤çš„å…±äº«å˜é‡æ”¾å…¥ä¸€ä¸ªç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Room</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            value++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            value--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestCalculate&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCalculate</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Room</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Room</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; room.increment());</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; room.decrement());</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;ç»“æœä¸ºï¼š&#123;&#125;&quot;</span>, room.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•ä¸Šçš„synchronized">æ–¹æ³•ä¸Šçš„synchronized</h3><ul><li>æˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠsynchronizedå…³é”®å­—åŠ åœ¨æ–¹æ³•ä¸Šï¼Œè¿™æ ·ç­‰ä»·äºç”¨å½“å‰å¯¹è±¡(this)æ¥ä½œä¸ºé”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ç­‰ä»·äº</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœåœ¨é™æ€æ–¹æ³•ä¸ŠåŠ synchronizedï¼Œåˆ™æ˜¯ç­‰ä»·äºä½¿ç”¨è¯¥ç±»(Test.class)ä½œä¸ºé”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ç­‰ä»·äº</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (Test.class) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¸åŠ synchronizedçš„æ–¹æ³•">ä¸åŠ synchronizedçš„æ–¹æ³•</h4><ul><li>ä¸åŠ synchronizedçš„æ–¹æ³•å°±å¥½æ¯”ä¸éµå®ˆè§„åˆ™çš„äººï¼Œä¸å»è€å®æ’é˜Ÿï¼ˆå¥½æ¯”ç¿»å¢™è¿›å»çš„ï¼‰</li></ul><h4 id="çº¿ç¨‹å…«é”">çº¿ç¨‹å…«é”</h4><ul><li>å…¶å®å°±æ˜¯è€ƒæŸ¥synchronizedé”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡ï¼Œæœ‰å…«ç§æƒ…å½¢</li></ul><ol><li>æƒ…å†µä¸€ï¼šçº¿ç¨‹1å’Œçº¿ç¨‹2éƒ½æ˜¯ç”¨n1ä½œä¸ºé”ï¼ŒäºŒè€…æ‰§è¡Œé¡ºåºéšæœºï¼Œç»“æœä¸º<code>12</code>æˆ–<code>21</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tmp</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.a()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.b()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>æƒ…å†µäºŒï¼št1å’Œt2æ‹¿åˆ°çš„æ˜¯åŒä¸€æŠŠé”ï¼Œæ‰§è¡Œé¡ºåºéšæœºï¼Œå¦‚æœt1å…ˆæ‰§è¡Œï¼Œåˆ™<code>1så12</code>ï¼›å¦‚æœt2å…ˆæ‰§è¡Œï¼Œåˆ™<code>2 1så1</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        Tmp.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tmp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.a()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.b()).start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> i)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>æƒ…å†µä¸‰ï¼š<code>3 1så12</code>ã€<code>23 1så1</code>ã€<code>32 1så1</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        Tmp.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">c</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tmp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.a()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.b()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.c()).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> i)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>æƒ…å†µå››ï¼št1å’Œt2ç”¨çš„é”åˆ†åˆ«æ˜¯n1å’Œn2ï¼Œç›¸å½“äºæ²¡é”ï¼Œç”±äºt1çº¿ç¨‹éœ€è¦ä¼‘çœ 1sï¼Œå›ºç»“æœä¸º<code>2 1så1</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        Tmp.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tmp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.a()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n2.b()).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> i)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>æƒ…å†µäº”ï¼št1çš„é”æ˜¯<code>Number.class</code>ï¼Œt2çš„é”æ˜¯n1å¯¹è±¡ï¼Œé”ä¸åŒï¼Œç›¸å½“äºæ²¡é”ï¼Œç»“æœåŒä¸Šï¼š<code>2 1så1</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        Tmp.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tmp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.a()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.b()).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> i)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="6"><li>æƒ…å†µå…­ï¼št1å’Œt2çš„é”å‡ä¸º<code>Number.class</code>ï¼Œ<code>1så12</code>æˆ–<code>2 1så1</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        Tmp.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tmp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.a()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.b()).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> i)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="7"><li>æƒ…å†µä¸ƒï¼š<code>2 1så1</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        Tmp.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tmp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.a()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n2.b()).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> i)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="8"><li>æƒ…å†µå…«ï¼št1å’Œt2çš„é”å‡ä¸º<code>Number.class</code>ï¼Œä¸è°ƒç”¨æ–¹n1ã€n2æ— å…³ï¼Œç»“æœ<code>1så12</code>æˆ–<code>2 1så1</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        Tmp.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tmp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n1.a()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; n2.b()).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> i)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ">å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ</h3><h4 id="æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ">æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</h4><ul><li>å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li><li>å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½æ”¹å˜ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µ<ul><li>å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li><li>å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li></ul></li></ul><h4 id="å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨">å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨</h4><ul><li>é€šå¸¸æƒ…å†µä¸‹ï¼Œæ–¹æ³•å†…çš„å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä»¬åªèƒ½åœ¨æ–¹æ³•å†…éƒ¨è®¿é—®ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆå¸§ï¼Œè€Œå±€éƒ¨å˜é‡å°±å­˜æ”¾åœ¨æ ˆå¸§å†…ã€‚</li><li>ä½†å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡æœªå¿…æ˜¯çº¿ç¨‹å®‰å…¨çš„<ul><li>å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨åŸŸï¼Œé‚£ä¹ˆå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„</li><li>å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»äº†æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œåˆ™éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li><li>è¯¦æƒ…å¯ä»¥å‚è€ƒæˆ‘è¿™ç¯‡æ–‡ç« çš„<code>2.2.1</code>å°ç»“ï¼Œæˆ–è€…åœ¨æ–‡ç« å†…<kbd>Ctrl</kbd> + <kbd>F</kbd>æœç´¢<code>é€ƒç¦»</code></li></ul>  <div class="tag link"><a class="link-card" title="JVMå†…å­˜æ¨¡å‹" href="https://cyborg2077.github.io/2023/03/27/JvmPart2/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">JVMå†…å­˜æ¨¡å‹</p><p class="url">https://cyborg2077.github.io/2023/03/27/JvmPart2/</p></div></a></div></li></ul><h4 id="å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ">å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ</h4><ul><li>ç¤ºä¾‹ä»£ç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ¯ä¸ªçº¿ç¨‹è°ƒç”¨test1()æ–¹æ³•æ—¶ï¼Œå±€éƒ¨å˜é‡iä¼šåœ¨æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§å†…å­˜ä¸­è¢«åˆ›å»ºå¤šä»½ï¼Œå› æ­¤ä¸å­˜åœ¨å…±äº«ï¼Œä½¿ç”¨<code>javap -v</code>å‘½ä»¤æŸ¥çœ‹test1()çš„å­—èŠ‚ç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>;</span><br><span class="line">  descriptor: ()V</span><br><span class="line">  flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">0</span></span><br><span class="line">       <span class="number">0</span>: bipush        <span class="number">10</span>                    <span class="comment">// å°†æ•´æ•°10æ¨é€åˆ°æ“ä½œæ•°æ ˆé¡¶ã€‚</span></span><br><span class="line">       <span class="number">2</span>: istore_0                            <span class="comment">// å°†æ“ä½œæ•°æ ˆé¡¶çš„æ•´æ•°å€¼å­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨çš„ç´¢å¼•ä¸º0çš„ä½ç½®ï¼ˆå³å°†10å­˜å‚¨åˆ°å±€éƒ¨å˜é‡iï¼‰ </span></span><br><span class="line">       <span class="number">3</span>: iinc          <span class="number">0</span>, <span class="number">1</span>                  <span class="comment">// å°†å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º0çš„ä½ç½®çš„æ•´æ•°å€¼å¢åŠ 1ã€‚</span></span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          <span class="number">3</span>       <span class="number">4</span>     <span class="number">0</span>     i   I</span><br></pre></td></tr></table></figure><ul><li><p>å¦‚å›¾<br><img src="https://s1.ax1x.com/2023/06/16/pCM31Gn.png" alt=""></p></li><li><p>å±€éƒ¨å˜é‡çš„å¼•ç”¨ç¨æœ‰ä¸åŒï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªæˆå‘˜å˜é‡çš„ä¾‹å­ï¼Œmethod2å’Œmethod3éƒ½æ˜¯å¯¹æˆå‘˜å˜é‡çš„ä¿®æ”¹ï¼Œä¸€ä¸ªæ˜¯æ·»åŠ å…ƒç´ ï¼Œä¸€ä¸ªæ˜¯ç§»é™¤å…ƒç´ ã€‚</p><ul><li>å½“å¤šä¸ªçº¿ç¨‹æ‰§è¡Œçš„æŒ‡ä»¤äº¤é”™çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°listä¸­æ²¡æœ‰å…ƒç´ ï¼Œä½†æ˜¯å´æ‰§è¡Œäº†removeæ“ä½œï¼Œæ­¤æ—¶å°±ä¼šæŠ¥é”™</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THREAD_NUM</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LOOP_NUM</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadUnsafe</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadUnsafe</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; THREAD_NUM; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                test.method01(LOOP_NUM);</span><br><span class="line">            &#125;, <span class="string">&quot;Thread&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadUnsafe</span> &#123;</span><br><span class="line">    ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method01</span><span class="params">(<span class="type">int</span> loopNum)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNum; i++) &#123;</span><br><span class="line">            <span class="comment">// ä¸´ç•ŒåŒºï¼Œä¼šå‘ç”Ÿç«æ€æ¡ä»¶</span></span><br><span class="line">            method02();</span><br><span class="line">            method03();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method02</span><span class="params">()</span> &#123;</span><br><span class="line">        list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method03</span><span class="params">()</span> &#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æŠ¥é”™</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;Thread1&quot;</span> java<span class="selector-class">.lang</span><span class="selector-class">.IndexOutOfBoundsException</span>: Index: <span class="number">0</span>, Size: <span class="number">0</span></span><br><span class="line">at java<span class="selector-class">.util</span><span class="selector-class">.ArrayList</span><span class="selector-class">.rangeCheck</span>(ArrayList<span class="selector-class">.java</span>:<span class="number">657</span>)</span><br><span class="line">at java<span class="selector-class">.util</span><span class="selector-class">.ArrayList</span><span class="selector-class">.remove</span>(ArrayList<span class="selector-class">.java</span>:<span class="number">496</span>)</span><br><span class="line">at cn<span class="selector-class">.itcast</span><span class="selector-class">.n6</span><span class="selector-class">.ThreadUnsafe</span><span class="selector-class">.method3</span>(TestThreadSafe<span class="selector-class">.java</span>:<span class="number">35</span>)</span><br><span class="line">at cn<span class="selector-class">.itcast</span><span class="selector-class">.n6</span><span class="selector-class">.ThreadUnsafe</span><span class="selector-class">.method1</span>(TestThreadSafe<span class="selector-class">.java</span>:<span class="number">26</span>)</span><br><span class="line">at cn<span class="selector-class">.itcast</span><span class="selector-class">.n6</span><span class="selector-class">.TestThreadSafe</span>.lambda<span class="variable">$main</span>$<span class="number">0</span>(TestThreadSafe<span class="selector-class">.java</span>:<span class="number">14</span>)</span><br><span class="line">at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br></pre></td></tr></table></figure><ul><li><p>åˆ†æï¼šæ— è®ºå“ªä¸ªçº¿ç¨‹ä¸­çš„method02æˆ–method03ä¸­ï¼Œå¼•ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ä¸­çš„listæˆå‘˜å˜é‡<br><img src="https://s1.ax1x.com/2023/06/16/pCMddoV.png" alt=""></p></li><li><p>ä¸‹é¢æˆ‘ä»¬å°†listä¿®æ”¹ä¸ºå±€éƒ¨å˜é‡</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadSafe</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method01</span><span class="params">(<span class="type">int</span> loopNum)</span> &#123;</span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNum; i++) &#123;</span><br><span class="line">            <span class="comment">// ä¸´ç•ŒåŒºï¼Œä¼šå‘ç”Ÿç«æ€æ¡ä»¶</span></span><br><span class="line">            method02();</span><br><span class="line">            method03();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method02</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method03</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>æ­¤æ—¶æ— è®ºè¿è¡Œå¤šå°‘æ¬¡ï¼Œä¹Ÿä¸ä¼šå‡ºç°ä¸Šè¿°çš„é—®é¢˜äº†ã€‚å› ä¸ºæ­¤æ—¶listæ˜¯å±€éƒ¨å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ä¼šåˆ›å»ºå…¶ä¸åŒçš„å®ä¾‹ï¼Œæ²¡æœ‰å…±äº«<br><img src="https://s1.ax1x.com/2023/06/16/pCMdOTP.png" alt=""></p></li><li><p>æˆ‘ä»¬ç»§ç»­ä»æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦æ¥æ€è€ƒï¼Œå¦‚æœå°†method02å’Œmethod03ä¿®æ”¹ä¸ºpublicæ–¹æ³•ï¼Œä¼šä¸ä¼šé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</p><ol><li>æƒ…å†µä¸€ï¼šæœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨method02å’Œmethod03</li><li>æƒ…å†µäºŒï¼šåœ¨æƒ…å†µä¸€çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ ThreadSafeçš„å­ç±»ï¼Œå­ç±»è¦†ç›–method03æ–¹æ³•</li></ol>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadSafe</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method01</span><span class="params">(<span class="type">int</span> loopNum)</span> &#123;</span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNum; i++) &#123;</span><br><span class="line">            <span class="comment">// ä¸´ç•ŒåŒºï¼Œä¼šå‘ç”Ÿç«æ€æ¡ä»¶</span></span><br><span class="line">            method02(list);</span><br><span class="line">            method03(list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method02</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method03</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadSafeSubClass</span> <span class="keyword">extends</span> <span class="title class_">ThreadSafe</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method03</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            list.remove(<span class="number">0</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¤šè¿è¡Œå‡ éå°±ä¼šæŠ¥é”™ï¼ŒåŸå› æ˜¯é‡å†™çš„method03æ–¹æ³•å°†listå…±äº«åˆ°äº†æ–°çº¿ç¨‹ï¼Œé€ æˆä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ä¿®æ”¹listå¯¹è±¡ï¼Œä»è¿™ä¸ªä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºprivateå¯ä»¥ä¿æŠ¤æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨çš„ï¼Œé™åˆ¶å­ç±»ä¸èƒ½è¦†ç›–å®ƒ</li></ul>  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;Thread-957&quot;</span> java<span class="selector-class">.lang</span><span class="selector-class">.IndexOutOfBoundsException</span>: Index: <span class="number">0</span>, Size: <span class="number">0</span></span><br><span class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.ArrayList</span><span class="selector-class">.rangeCheck</span>(ArrayList<span class="selector-class">.java</span>:<span class="number">659</span>)</span><br><span class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.ArrayList</span><span class="selector-class">.remove</span>(ArrayList<span class="selector-class">.java</span>:<span class="number">498</span>)</span><br><span class="line">    at com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo01</span><span class="selector-class">.ThreadSafeSubClass</span>.lambda<span class="variable">$method03</span>$<span class="number">0</span>(Test01<span class="selector-class">.java</span>:<span class="number">44</span>)</span><br><span class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">750</span>)</span><br></pre></td></tr></table></figure></li></ul><h3 id="å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»">å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»</h3><ol><li>String</li><li>Integer</li><li>StringBuffer</li><li>Random</li><li>Vector</li><li>Hashtable</li><li>java.util.concurrentåŒ…ä¸‹çš„ç±»</li></ol><ul><li>è¿™é‡Œè¯´å®ƒä»¬æ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œå½“å¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬<code>åŒä¸€ä¸ª</code>å®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ç†è§£ä¸º</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; table.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>), <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; table.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>), <span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure><div class="note warning no-icon flat"><p>è™½ç„¶å®ƒä»¬çš„æ¯ä¸ªæ–¹æ³•éƒ½æ˜¯åŸå­çš„ï¼Œä½†å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„</p></div><h4 id="çº¿ç¨‹å®‰å…¨ç±»æ–¹æ³•çš„ç»„åˆ">çº¿ç¨‹å®‰å…¨ç±»æ–¹æ³•çš„ç»„åˆ</h4><ul><li>åˆ†æä»¥ä¸‹ä»£ç æ˜¯å¦çº¿ç¨‹å®‰å…¨</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line"><span class="comment">// ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">if</span> (table.get(<span class="string">&quot;key&quot;</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">    table.put(<span class="string">&quot;key&quot;</span>, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œå¯èƒ½ä¼šå‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œçº¿ç¨‹ <code>T2</code> çš„æ“ä½œç»“æœè¢«çº¿ç¨‹ <code>T1</code> çš„æ“ä½œç»“æœè¦†ç›–ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">T1ï¼š<span class="keyword">table</span>.<span class="keyword">get</span>(&quot;key&quot;) == <span class="keyword">null</span></span><br><span class="line">    T2ï¼š<span class="keyword">table</span>.<span class="keyword">get</span>(&quot;key&quot;) == <span class="keyword">null</span></span><br><span class="line">    T2ï¼š<span class="keyword">table</span>.put(&quot;key&quot;, v2);</span><br><span class="line">T1ï¼š<span class="keyword">table</span>.put(&quot;key&quot;, v1);</span><br></pre></td></tr></table></figure><h4 id="ä¸å¯å˜ç±»çš„çº¿ç¨‹å®‰å…¨æ€§">ä¸å¯å˜ç±»çš„çº¿ç¨‹å®‰å…¨æ€§</h4><ul><li>åœ¨Javaä¸­ï¼ŒStringç±»å’ŒIntegerç±»è¢«è®¾è®¡ä¸ºä¸å¯å˜ç±»ï¼ˆImmutable Classï¼‰ï¼Œè¿™æ„å‘³ç€ä¸€æ—¦åˆ›å»ºäº†å¯¹è±¡ï¼Œå…¶çŠ¶æ€å°±ä¸èƒ½è¢«ä¿®æ”¹ã€‚è¿™ç§ä¸å¯å˜æ€§ä½¿å¾—Stringå’ŒIntegerå¯¹è±¡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä»¬çš„çŠ¶æ€ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚<ol><li>Stringç±»çš„çº¿ç¨‹å®‰å…¨æ€§<ul><li>å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜çš„ï¼Œä¸€æ—¦åˆ›å»ºå°±ä¸èƒ½ä¿®æ”¹ã€‚ä»»ä½•å¯¹å­—ç¬¦ä¸²çš„ä¿®æ”¹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œè€Œä¸ä¼šä¿®æ”¹åŸå§‹å­—ç¬¦ä¸²å¯¹è±¡ã€‚</li><li>å› ä¸ºå­—ç¬¦ä¸²ä¸å¯å˜ï¼Œæ‰€ä»¥å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®åŒä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œè€Œä¸éœ€è¦æ‹…å¿ƒç«äº‰æ¡ä»¶æˆ–æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li></ul></li><li>Integerç±»çš„çº¿ç¨‹å®‰å…¨æ€§<ul><li>Integerç±»æ˜¯ä¸€ä¸ªåŒ…è£…ç±»ï¼Œç”¨äºå°è£…intç±»å‹çš„å€¼ã€‚å®ƒä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œä¸€æ—¦åˆ›å»ºå°±ä¸èƒ½ä¿®æ”¹</li><li>å¯¹äºå¸¸è§çš„æ•´æ•°å€¼ï¼ˆ-128 ~ 127ï¼‰ï¼ŒJavaä½¿ç”¨IntegerCacheæ¥é‡ç”¨Integerå¯¹è±¡ã€‚è¿™æ„å‘³ç€å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®è¿™äº›æ•´æ•°å€¼æ—¶ï¼Œä¼šå¾—åˆ°ç›¸åŒçš„Integerå¯¹è±¡</li><li>å¯¹äºè¶…å‡ºç¼“å­˜èŒƒå›´çš„æ•´æ•°å€¼ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè·å¾—ä¸€ä¸ªç‹¬ç«‹çš„Integerå¯¹è±¡ï¼Œå› æ­¤ä¸ä¼šå­˜åœ¨ç«æ€æ¡ä»¶ã€‚</li></ul></li></ol></li></ul><h4 id="å®ä¾‹åˆ†æ">å®ä¾‹åˆ†æ</h4><ol><li>ä¾‹ä¸€</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿå¦ï¼šHashtableæ‰æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ­¤mapä¼šè¢«å¤šä¸ªçº¿ç¨‹å…±äº«å¹¶è®¿é—®åˆ°</span></span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿæ˜¯ï¼šå­—ç¬¦ä¸²æ˜¯ä¸å¯å˜ç±»ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">S1</span> <span class="operator">=</span> <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿæ˜¯ï¼šç†ç”±åŒä¸Š</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">S2</span> <span class="operator">=</span> <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿå¦ï¼šä¼šè¢«å…±äº«ï¼Œä¸mapç†ç”±ä¸€è‡´</span></span><br><span class="line">    <span class="type">Date</span> <span class="variable">D1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿå¦ï¼šfinalä¿®é¥°ç¬¦ä»…ä»…æ˜¯å°†D2çš„å¼•ç”¨å€¼å›ºå®šäº†ï¼Œä½†è¿˜æ˜¯å¯è¢«ä¿®æ”¹çš„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Date</span> <span class="variable">D2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ä¸Šè¿°å˜é‡</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>ä¾‹äºŒ</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿå¦ï¼šdoGet æ–¹æ³•ä¼šè¢«å¤šä¸ªçº¿ç¨‹å¹¶å‘è°ƒç”¨ã€‚ç”±äº userService æ˜¯ä¸€ä¸ªå…±äº«çš„æˆå‘˜å˜é‡ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ doGet æ–¹æ³•å¯èƒ½ä¼šå¯¼è‡´å¹¶å‘è®¿é—®é—®é¢˜ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        userService.update(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// è®°å½•è°ƒç”¨æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥å°†UserServiceå¯¹è±¡çš„åˆ›å»ºæ”¾åœ¨doGetå†…æ¥å®Œæˆï¼Œè¿™æ ·å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line">    userService.update(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>ä¾‹ä¸‰</li></ol><ul><li>Springä¸­çš„å¯¹è±¡ï¼Œä¸åŠ <code>@Scope(&quot;&quot;prototype)</code>æ³¨è§£å£°æ˜çš„è¯ï¼Œé»˜è®¤éƒ½æ˜¯å•ä¾‹çš„ï¼Œæ—¢ç„¶å¯¹è±¡éƒ½æ˜¯å•ä¾‹çš„ï¼Œé‚£ä¹ˆè¿™é‡Œçš„startå±æ€§ä¹Ÿæ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="meta">@Before(&quot;execution(* *(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        start = System.nanoTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;execution(* *(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;cost time:&quot;</span> + (end-start));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¯ç»•é€šçŸ¥ï¼Œå°†startä½œä¸ºä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œä»è€Œé¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Around(&quot;execution(* *(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;cost time: &quot;</span> + (end - start));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>ä¾‹å››ï¼Œä»ä¸‹å¾€ä¸Šçœ‹</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼ŸåŒä¸‹ï¼Œä¹Ÿæ˜¯ä¸å¯å˜çš„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        userService.update(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿæ˜¯ï¼šè™½ç„¶UserDaoæ˜¯æˆå‘˜å˜é‡ï¼Œä½†æ˜¯é‡Œé¢æ²¡æœ‰ä¸œè¥¿å¯ä»¥æ”¹ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç±»ä¼¼äºæ— çŠ¶æ€ä¸å¯å˜</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDaoImpl</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update user set password = ? where username = ?&quot;</span>;</span><br><span class="line">        <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿæ˜¯ï¼šæ²¡æœ‰æˆå‘˜å˜é‡ï¼Œå³ä½¿æœ‰å¤šä¸ªçº¿ç¨‹æ¥è®¿é—®ï¼Œä¹Ÿä»€ä¹ˆéƒ½æ”¹ä¸äº†ï¼Œåªè¯»</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>ä¾‹äº”</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿå¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        userService.update(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿå¦ï¼Œå…¶ä¸­çš„æˆå‘˜å˜é‡è¢«å…±äº«ï¼Œå¯è¢«ä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDaoImpl</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿå¦ï¼šConnectionå¯¹è±¡ä½œä¸ºæˆå‘˜å˜é‡ï¼Œä¼šè¢«å…±äº«</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update user set password = ? where username = ?&quot;</span>;</span><br><span class="line">        conn = DriverManager.getConnection(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="6"><li>ä¾‹å…­</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        userService.update(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// UserDaoæ˜¯ä½œä¸ºå±€éƒ¨å˜é‡è¢«åˆ›å»ºçš„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDaoImpl</span>();</span><br><span class="line">        userDao.update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿæ˜¯ï¼šè™½ç„¶Connectionæ˜¯æˆå‘˜å˜é‡ï¼Œä½†æ˜¯UserDaoæ˜¯åœ¨update()æ–¹æ³•ä¸­ä½œä¸ºå±€éƒ¨å˜é‡åˆ›å»ºçš„ï¼Œæ•…è¿™é‡Œçš„Connectionéƒ½æ˜¯æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹åˆ›å»ºçš„ï¼Œä¸ä¼šè¢«å…±äº«</span></span><br><span class="line">    <span class="type">private</span> <span class="variable">Connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update user set password = ? where username = ?&quot;</span>;</span><br><span class="line">        conn = DriverManager.getConnection(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="7"><li>ä¾‹ä¸ƒ</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bar</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ˜¯å¦å®‰å…¨ï¼Ÿå¦ï¼šè™½ç„¶sdfæ–¹æ³•æ˜¯å±€éƒ¨å˜é‡ï¼Œä½†æ˜¯sdfå¯¹è±¡ä¼šä½œä¸ºå‚æ•°è¢«ä¼ é€’ç»™æŠ½è±¡æ–¹æ³•foo()ï¼Œå…¶å­ç±»å¯èƒ½ä¼šå¯¹foo()æ–¹æ³•ä¸­çš„sdfåšä¿®æ”¹ï¼Œç›¸å½“äºsdfå¯¹è±¡é€ƒç¦»äº†æ–¹æ³•ä½œç”¨èŒƒå›´ï¼Œçº¿ç¨‹ä¸å®‰å…¨</span></span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        foo(sdf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="title function_">foo</span><span class="params">(SimpleDateFormat sdf)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Test</span>().bar();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å…¶ä¸­fooçš„è¡Œä¸ºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½ä¼šå¯¹sdfåšä¿®æ”¹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(SimpleDateFormat sdf)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">dateStr</span> <span class="operator">=</span> <span class="string">&quot;1999-10-11 00:00:00&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sdf.parse(dateStr);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure><h3 id="ä¹ é¢˜">ä¹ é¢˜</h3><h4 id="å–ç¥¨ç»ƒä¹ ">å–ç¥¨ç»ƒä¹ </h4><ul><li>æµ‹è¯•ä¸‹é¢çš„å–ç¥¨ä»£ç æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¹¶å°è¯•æ”¹æ­£</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TicketWindow</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TicketWindow</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å–ç¥¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount é¢„è´­ä¹°çš„å¼ æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å®é™…å–çš„å¼ æ•°ï¼Œä½™ç¥¨ä¸è¶³ä¸º0 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sell</span><span class="params">(<span class="type">int</span> amount)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.count &gt;= amount) &#123;</span><br><span class="line">            <span class="built_in">this</span>.count -= amount;</span><br><span class="line">            <span class="keyword">return</span> amount;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬æ¥å®é™…æµ‹è¯•ä¸€ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.ExerciseSell&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExerciseSell</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">TicketWindow</span> <span class="variable">window</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TicketWindow</span>(<span class="number">1000</span>);</span><br><span class="line">        ArrayList&lt;Thread&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Integer&gt; sellCount = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> window.sell(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">5</span>) + <span class="number">1</span>);</span><br><span class="line">                sellCount.add(count);</span><br><span class="line">            &#125;);</span><br><span class="line">            list.add(thread);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach((t) -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        log.debug(<span class="string">&quot;å–å‡ºï¼š&#123;&#125;å¼ &quot;</span>, sellCount.stream().mapToInt(n -&gt; n.intValue()).sum());</span><br><span class="line">        log.debug(<span class="string">&quot;å‰©ä½™ï¼š&#123;&#125;å¼ &quot;</span>, window.getCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœå‘ç”Ÿäº†è¶…å–ç°è±¡ï¼ŒåŸå› æ˜¯åœ¨å”®ç¥¨æ–¹æ³•å¤„ï¼Œæ²¡æœ‰åŠ é”ï¼Œå¯¼è‡´å¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è¿›æ¥ä¿®æ”¹ç¥¨æ•°</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">37</span>:<span class="number">37.959</span> c<span class="selector-class">.ExerciseSell</span> <span class="selector-attr">[main]</span> - å–å‡ºï¼š<span class="number">1008</span>å¼ </span><br><span class="line"><span class="number">16</span>:<span class="number">37</span>:<span class="number">37.962</span> c<span class="selector-class">.ExerciseSell</span> <span class="selector-attr">[main]</span> - å‰©ä½™ï¼š<span class="number">0</span>å¼ </span><br></pre></td></tr></table></figure><ul><li>è§£å†³æ–¹æ¡ˆæ˜¯ç»™sell()æ–¹æ³•åŠ é”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">sell</span><span class="params">(<span class="type">int</span> amount)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.count &gt;= amount) &#123;</span><br><span class="line">        <span class="built_in">this</span>.count -= amount;</span><br><span class="line">        <span class="keyword">return</span> amount;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœ</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">55</span>:<span class="number">15.759</span> c<span class="selector-class">.ExerciseSell</span> <span class="selector-attr">[main]</span> - å–å‡ºï¼š<span class="number">1000</span>å¼ </span><br><span class="line"><span class="number">17</span>:<span class="number">55</span>:<span class="number">15.765</span> c<span class="selector-class">.ExerciseSell</span> <span class="selector-attr">[main]</span> - å‰©ä½™ï¼š<span class="number">0</span>å¼ </span><br></pre></td></tr></table></figure><h4 id="è½¬è´¦ç»ƒä¹ ">è½¬è´¦ç»ƒä¹ </h4><ul><li>æµ‹è¯•ä¸‹é¢ä»£ç æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¹¶å°è¯•æ”¹æ­£</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> money;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> amount, Account target)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.money &gt;= amount) &#123;</span><br><span class="line">            <span class="built_in">this</span>.setMoney(money - amount);</span><br><span class="line">            target.setMoney(target.getMoney() + amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•ä»£ç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.ExerciseTransfer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExerciseTransfer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Account</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>(<span class="number">1000</span>);</span><br><span class="line">        <span class="type">Account</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>(<span class="number">1000</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                a.transfer(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>), b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                b.transfer(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>), a);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.debug(<span class="string">&quot;ä¸¤äººæ€»é‡‘é¢ï¼š&#123;&#125;&quot;</span>, a.getMoney() + b.getMoney());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœå¦‚ä¸‹ï¼Œè½¬æ¥è½¬å»ï¼Œé’±è¿˜è½¬å°‘äº†<del>ï¼ˆèº«ä¸ºé“¶è¡Œï¼Œæ”¶ç‚¹æ‰‹ç»­è´¹æ€ä¹ˆå•¦ï¼‰</del></li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">18</span>:<span class="number">07</span>:<span class="number">44</span>.<span class="number">726</span> c.ExerciseTransfer<span class="meta"> [main] - ä¸¤äººæ€»é‡‘é¢ï¼š1436</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†æï¼šè¿™é‡Œçš„å…±äº«å˜é‡æ˜¯<code>money</code>ï¼Œä¸´ç•ŒåŒºåˆ™æ˜¯<code>transfer()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­å¯¹moneyè¿›è¡Œäº†ä¿®æ”¹ï¼Œä½†æ˜¯æ²¡æœ‰åŠ é”ï¼Œä½†æ˜¯ç›´æ¥åœ¨æ–¹æ³•ä¸ŠåŠ synchronizedæ˜¯æ²¡ç”¨çš„ï¼Œè¿™æ ·ç›¸å½“äºä½¿ç”¨thiså½“å‰å¯¹è±¡æ¥ä½œä¸ºé”ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨<code>transfer()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹ä¼šè·å–ä¸åŒçš„é”ï¼Œç­‰äºæ²¡åŠ é”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> amount, Account target)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.money &gt;= amount) &#123;</span><br><span class="line">            <span class="built_in">this</span>.setMoney(money - amount);</span><br><span class="line">            target.setMoney(target.getMoney() + amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ­£ç¡®çš„åšæ³•æ˜¯ä½¿ç”¨<code>ç›¸åŒçš„é”</code>æ¥å¯¹å…±äº«èµ„æºè¿›è¡ŒåŒæ­¥ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨<code>Account.class</code>æ¥ä½œä¸ºé”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> amount, Account target)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (Account.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.money &gt;= amount) &#123;</span><br><span class="line">            <span class="built_in">this</span>.setMoney(money - amount);</span><br><span class="line">            target.setMoney(target.getMoney() + amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Monitoræ¦‚å¿µ">Monitoræ¦‚å¿µ</h3><h4 id="Javaå¯¹è±¡å¤´">Javaå¯¹è±¡å¤´</h4><ul><li>ä»¥32ä½è™šæ‹Ÿæœºä¸ºä¾‹ï¼Œæ™®é€šå¯¹è±¡</li></ul><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">--------------------------------------------------------------</span>|</span><br><span class="line">|<span class="string">                   Object Header (64 bits)                    </span>|</span><br><span class="line">|<span class="string">------------------------------------</span>|<span class="string">-------------------------</span>|</span><br><span class="line">|<span class="string">      Mark Word (32 bits)           </span>|<span class="string">  Klass Word (32 bits)   </span>|</span><br><span class="line">|<span class="string">------------------------------------</span>|<span class="string">-------------------------</span>|</span><br></pre></td></tr></table></figure><ul><li>æ•°ç»„å¯¹è±¡</li></ul><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">---------------------------------------------------------------------------------</span>|</span><br><span class="line">|<span class="string">                               Object Header (96 bits)                           </span>|</span><br><span class="line">|<span class="string">--------------------------------</span>|<span class="string">-----------------------</span>|<span class="string">------------------------</span>|</span><br><span class="line">|<span class="string">       Mark Word(32 bits)       </span>|<span class="string">   Klass Word(32 bits) </span>|<span class="string"> array length(32 bits)  </span>|</span><br><span class="line">|<span class="string">--------------------------------</span>|<span class="string">-----------------------</span>|<span class="string">------------------------</span>|</span><br></pre></td></tr></table></figure><ul><li>å…¶ä¸­MarkWordç»“æ„ä¸º</li></ul><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">-------------------------------------------------</span>|<span class="string">----------------------------</span>|</span><br><span class="line">|<span class="string">                   Mark Word (32 bits)                   </span>|<span class="string">        State       </span>|</span><br><span class="line">|<span class="string">-------------------------------------------------</span>|<span class="string">----------------------------</span>|</span><br><span class="line">|<span class="string"> hashcode:25         </span>|<span class="string"> age:4 </span>|<span class="string">   biased_lock:0   </span>|<span class="string"> 01    </span>|<span class="string">        Normal      </span>|</span><br><span class="line">|<span class="string">-------------------------------------------------</span>|<span class="string">----------------------------</span>|</span><br><span class="line">|<span class="string"> thread:23 </span>|<span class="string"> epoch:2 </span>|<span class="string"> age:4 </span>|<span class="string">   biased_lock:1   </span>|<span class="string"> 01    </span>|<span class="string">        Biased      </span>|</span><br><span class="line">|<span class="string">-------------------------------------------------</span>|<span class="string">----------------------------</span>|</span><br><span class="line">|<span class="string">             ptr_to_lock_record:30               </span>|<span class="string"> 00    </span>|<span class="string"> Lightweight Locked </span>|</span><br><span class="line">|<span class="string">-------------------------------------------------</span>|<span class="string">----------------------------</span>|</span><br><span class="line">|<span class="string">          ptr_to_heavyweight_monitor:30          </span>|<span class="string"> 10    </span>|<span class="string"> Heavyweight Locked </span>|</span><br><span class="line">|<span class="string">-------------------------------------------------</span>|<span class="string">----------------------------</span>|</span><br><span class="line">|<span class="string">                                                 </span>|<span class="string"> 11    </span>|<span class="string">  Marked for GC     </span>|</span><br><span class="line">|<span class="string">-------------------------------------------------</span>|<span class="string">----------------------------</span>|</span><br></pre></td></tr></table></figure><ul><li>64ä½è™šæ‹ŸæœºMark Word</li></ul><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">                           Mark Word (64 bits)                      </span>|<span class="string">       State        </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> unused:25 </span>|<span class="string"> hashcode:31 </span>|<span class="string"> unused:1 </span>|<span class="string"> age:4 </span>|<span class="string"> biased_lock:0 </span>|<span class="string">  01   </span>|<span class="string">       Normal       </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> thread:54 </span>|<span class="string">  epoch:2    </span>|<span class="string"> unused:1 </span>|<span class="string"> age:4 </span>|<span class="string"> biased_lock:1 </span>|<span class="string">  01   </span>|<span class="string">       Biased       </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">               ptr_to_lock_record:62                        </span>|<span class="string">  00   </span>|<span class="string"> Lightweight Locked </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">             ptr_to_heavyweight_monitor:62                  </span>|<span class="string">  10   </span>|<span class="string"> Heavyweight Locked </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">                                                            </span>|<span class="string">  11   </span>|<span class="string">    Marked for GC   </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|<span class="string"> </span></span><br></pre></td></tr></table></figure><h4 id="Monitor-é”">Monitor(é”)</h4><ul><li>Monitorè¢«ç¿»è¯‘æˆ<code>ç›‘è§†å™¨</code>æˆ–<code>ç®¡ç¨‹</code></li><li>æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ªMonitorå¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨synchronizedç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„MarkWordä¸­å°±è¢«è®¾ç½®æŒ‡å‘Monitorå¯¹è±¡çš„æŒ‡é’ˆ</li><li>Monitorç»“æ„å¦‚ä¸‹<br><img src="https://s1.ax1x.com/2023/06/18/pC1iNxH.png" alt=""></li><li>åˆšå¼€å§‹Monitorä¸­Ownerä¸ºnull</li><li>å½“Thread-2ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœThread-3ã€Thread-4ã€Thread-5ä¹Ÿæ¥æ‰§è¡Œsynchronized(obj)ï¼Œå°±ä¼šè¿›å…¥é˜»å¡é˜Ÿåˆ—ç­‰å¾…ï¼ˆEntryList BLOCKEDï¼‰</li><li>Thread-2æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œç„¶åå”¤é†’EntryListä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰æ—¶æ˜¯éå…¬å¹³çš„</li><li>å›¾ä¸­WaitSetä¸­çš„Thread-0ã€Thread-1æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥WAITINGçŠ¶æ€çš„çº¿ç¨‹ï¼Œåé¢å°†wait-notifyæ—¶ä¼šåˆ†æ</li></ul><div class="note warning no-icon flat"><ul><li>synchronizedå¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„monitoræ‰æœ‰ä¸Šè¿°æ•ˆæœ</li><li>ä¸åŠ synchronizedçš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™</li></ul></div><h4 id="synchronizedåŸç†">synchronizedåŸç†</h4><ul><li>åŸç†æˆ‘ä»¬ä»å­—èŠ‚ç çš„è§’åº¦æ¥åˆ†æï¼Œç¤ºä¾‹ä»£ç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        counter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨<code>javap -v /xx/Test.class</code>ç¼–è¯‘åçš„å­—èŠ‚ç å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">    <span class="comment">// æ–¹æ³•ç­¾å</span></span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    <span class="comment">// è®¿é—®ä¿®é¥°ç¬¦</span></span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"></span><br><span class="line">Code:</span><br><span class="line">  <span class="comment">// æ“ä½œæ•°æ ˆæ·±åº¦å’Œæœ¬åœ°å˜é‡è¡¨å®¹é‡</span></span><br><span class="line">  stack=<span class="number">2</span>, locals=<span class="number">3</span>, args_size=<span class="number">1</span></span><br><span class="line">     <span class="number">0</span>: getstatic     #<span class="number">2</span>                    <span class="comment">// Field lock:Ljava/lang/Object;  // è·å–é™æ€å­—æ®µ lock çš„å€¼å¹¶å°†å…¶æ¨é€åˆ°æ“ä½œæ•°æ ˆé¡¶éƒ¨</span></span><br><span class="line">     <span class="number">3</span>: dup                                 <span class="comment">// å¤åˆ¶æ ˆé¡¶çš„æ•°å€¼ï¼ˆå³ lock å¼•ç”¨ï¼‰å¹¶å°†å‰¯æœ¬æ¨é€åˆ°æ“ä½œæ•°æ ˆé¡¶éƒ¨</span></span><br><span class="line">     <span class="number">4</span>: astore_1                            <span class="comment">// å°†æ ˆé¡¶çš„æ•°å€¼ï¼ˆå³ lock å¼•ç”¨çš„å‰¯æœ¬ï¼‰å­˜å‚¨åˆ°æœ¬åœ°å˜é‡ 1ï¼ˆargs å‚æ•°ï¼‰</span></span><br><span class="line">     <span class="number">5</span>: monitorenter                        <span class="comment">// è¿›å…¥ç›‘è§†å™¨ï¼ˆé”ï¼‰ä¿æŠ¤çš„åŒæ­¥å—</span></span><br><span class="line">     <span class="number">6</span>: getstatic     #<span class="number">3</span>                    <span class="comment">// Field counter:I  æ‰§è¡Œcounter++</span></span><br><span class="line">     <span class="number">9</span>: iconst_1                           </span><br><span class="line">    <span class="number">10</span>: iadd                                 </span><br><span class="line">    <span class="number">11</span>: putstatic     #<span class="number">3</span>                     </span><br><span class="line">    <span class="number">14</span>: aload_1                              </span><br><span class="line">    <span class="number">15</span>: monitorexit                         <span class="comment">// è‡ªå¢æ“ä½œå®Œæ¯•ï¼Œé€€å‡ºç›‘è§†å™¨ï¼ˆé”ï¼‰ä¿æŠ¤çš„åŒæ­¥å—</span></span><br><span class="line">    <span class="number">16</span>: goto          <span class="number">24</span>                    <span class="comment">// æ— æ¡ä»¶è·³è½¬åˆ°æŒ‡ä»¤ä½ç½® 24ï¼Œç»§ç»­æ‰§è¡Œä¸‹é¢çš„æŒ‡ä»¤</span></span><br><span class="line">    <span class="number">19</span>: astore_2                            <span class="comment">// è¿™é‡Œæ˜¯å¼‚å¸¸å¤„ç†ï¼šå°†æ ˆé¡¶çš„æ•°å€¼ï¼ˆå³å¼‚å¸¸å¯¹è±¡å¼•ç”¨ï¼‰å­˜å‚¨åˆ°æœ¬åœ°å˜é‡ 2ï¼ˆex å¼‚å¸¸ï¼‰</span></span><br><span class="line">    <span class="number">20</span>: aload_1                             <span class="comment">// å°†æœ¬åœ°å˜é‡ 1ï¼ˆargs å‚æ•°ï¼‰åŠ è½½åˆ°æ“ä½œæ•°æ ˆé¡¶éƒ¨</span></span><br><span class="line">    <span class="number">21</span>: monitorexit                         <span class="comment">// é‡Šæ”¾é”ï¼šåœ¨å¼‚å¸¸å¤„ç†å—ä¸­ï¼Œé€€å‡ºç›‘è§†å™¨ï¼ˆé”ï¼‰ä¿æŠ¤çš„åŒæ­¥å—</span></span><br><span class="line">    <span class="number">22</span>: aload_2                             <span class="comment">// é‡è¯•å¼‚å¸¸ï¼šå°†æœ¬åœ°å˜é‡ 2ï¼ˆex å¼‚å¸¸ï¼‰åŠ è½½åˆ°æ“ä½œæ•°æ ˆé¡¶éƒ¨</span></span><br><span class="line">    <span class="number">23</span>: athrow                              <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="number">24</span>: <span class="keyword">return</span>                              <span class="comment">// æ–¹æ³•è¿”å›</span></span><br><span class="line"></span><br><span class="line">Exception table:</span><br><span class="line">   from    to  target type</span><br><span class="line">       <span class="number">6</span>    <span class="number">16</span>    <span class="number">19</span>   any      <span class="comment">// å¦‚æœ6~16è¡Œå‡ºç°äº†å¼‚å¸¸ï¼Œè·³è½¬åˆ°19è¡Œç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">      <span class="number">19</span>    <span class="number">22</span>    <span class="number">19</span>   any      <span class="comment">// å¦‚æœ19~22è¡Œå‡ºç°äº†å¼‚å¸¸ï¼Œè·³è½¬åˆ°19è¡Œç»§ç»­æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><ul><li>ä»å­—èŠ‚ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå³ä½¿å‘ç”Ÿäº†å¼‚å¸¸ï¼Œä¹Ÿä¼šé‡Šæ”¾æ‰é”</li></ul><div class="note warning no-icon flat"><ul><li>æ³¨æ„ï¼šæ–¹æ³•çº§åˆ«çš„synchronizedä¸ä¼šå†å­—èŠ‚ç æŒ‡ä»¤ä¸­ä½“ç°</li></ul></div><h3 id="synchronizedåŸç†è¿›é˜¶">synchronizedåŸç†è¿›é˜¶</h3><h4 id="è½»é‡çº§é”">è½»é‡çº§é”</h4><ul><li>è½»é‡çº§é”çš„ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è¦åŠ é”ï¼Œä½†åŠ é”çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰åœ¨ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–</li><li>è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯<code>é€æ˜çš„</code>ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯synchronizedï¼Œä¸‹é¢æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­æ¥æ·±å…¥è½»é‡çº§é”çš„åŸç†</li><li>å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—A</span></span><br><span class="line">        method2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—B</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>é¦–å…ˆä¼šåˆ›å»ºé”å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„MarkWord<br><img src="https://s1.ax1x.com/2023/06/26/pCUcTJ0.png" alt=""></p></li><li><p>å…¶æ¬¡è®©é”è®°å½•ä¸­çš„Object referenceï¼Œå¹¶å°è¯•ä½¿ç”¨CASæ›¿æ¢Objectçš„Mark Wordï¼Œå°†Mark Wordçš„å€¼å­˜å…¥é”è®°å½•<br><img src="https://s1.ax1x.com/2023/06/26/pCUgiQO.png" alt=""></p></li><li><p>å¦‚æœCASæ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´æ±‡æ€»å­˜å‚¨äº†<code>é”è®°å½•åœ°å€å’ŒçŠ¶æ€00</code>ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”ï¼Œå…¶ä¸­<code>00</code>å¯¹åº”çš„æ˜¯<code>è½»é‡çº§é”</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://s1.ax1x.com/2023/06/26/pCUgVwd.png" alt=""></p></li><li><p>å¦‚æœCASæ›¿æ¢å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µ</p><ol><li>å¦‚æœæ˜¯å…¶ä»–çº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥Objectçš„è½»é‡çº§é”ï¼Œè¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€çš„è¿‡ç¨‹</li><li>å¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œäº†synchronizedé”é‡å…¥ï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡LockRecordä½œä¸ºé‡å…¥çš„è®¡æ•°<br><img src="https://s1.ax1x.com/2023/06/26/pCUgl6S.png" alt=""></li></ol></li><li><p>å½“é€€å‡ºsynchronizedä»£ç å—ï¼ˆè§£é”ï¼‰æ—¶ï¼Œå¦‚æœæœ‰å–å€¼ä¸ºnullçš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œæ­¤æ—¶åˆ é™¤é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°-1<br><img src="https://s1.ax1x.com/2023/06/26/pCUgs0J.png" alt=""></p></li><li><p>å½“é€€å‡ºsynchronizedä»£ç å—ï¼ˆè§£é”ï¼‰æ—¶ï¼Œé”è®°å½•çš„å€¼ä¸ä¸ºnullï¼Œæ­¤æ—¶ä½¿ç”¨CASå°†MarkWordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´</p><ul><li>æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ</li><li>å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”çš„è§£é”æµç¨‹</li></ul></li></ul><h4 id="é”è†¨èƒ€">é”è†¨èƒ€</h4><ul><li>å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCASæ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶ä»–çº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ˜¯éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç°åœ¨Thread-1å°è¯•åŠ è½»é‡çº§é”<br><img src="https://s1.ax1x.com/2023/06/26/pCU2sv8.png" alt=""></li><li>ç”±äºThread-0å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”ï¼Œå¯¹è±¡çš„MarkWordåä¸¤ä½å·²ç»æ˜¯00äº†ï¼Œé‚£ä¹ˆThread-1è¿›è¡ŒCASæ“ä½œå°±ä¼šå¤±è´¥ï¼Œæ­¤æ—¶è¿›å…¥é”è†¨èƒ€æµç¨‹<ul><li>å³ä¸ºObjectå¯¹è±¡ç”³è¯·Monitoré”ï¼Œè®©ObjectæŒ‡å‘é‡é‡çº§é”åœ°å€</li><li>ç„¶åè‡ªå·±è¿›å…¥Monitorçš„EntryList BLOCKEDï¼Œè¿›å…¥é˜»å¡é˜Ÿåˆ—ç­‰å¾…<br><img src="https://s1.ax1x.com/2023/06/26/pCU2YuD.png" alt=""></li><li>å½“Thread-0é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨CASå°†MarkWordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œå¤±è´¥ã€‚</li></ul></li></ul><h4 id="è‡ªæ—‹ä¼˜åŒ–">è‡ªæ—‹ä¼˜åŒ–</h4><ul><li>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒæœ‰é”çš„çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚</li><li>è‡ªæ—‹é‡è¯•æˆåŠŸçš„æƒ…å†µ</li></ul><table><thead><tr><th style="text-align:center">çº¿ç¨‹ 1 ï¼ˆcore 1 ä¸Šï¼‰</th><th style="text-align:center">å¯¹è±¡ Mark</th><th style="text-align:center">çº¿ç¨‹ 2 ï¼ˆcore 2 ä¸Šï¼‰</th></tr></thead><tbody><tr><td style="text-align:center">-</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æˆåŠŸï¼ˆåŠ é”ï¼‰</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æ‰§è¡Œå®Œæ¯•</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æˆåŠŸï¼ˆè§£é”ï¼‰</td><td style="text-align:center">01ï¼ˆæ— é”ï¼‰</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">æˆåŠŸï¼ˆåŠ é”ï¼‰</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">â€¦</td><td style="text-align:center">â€¦</td></tr></tbody></table><ul><li>è‡ªæ—‹é‡è¯•å¤±è´¥çš„æƒ…å†µ</li></ul><table><thead><tr><th style="text-align:center">çº¿ç¨‹ 1ï¼ˆcore 1 ä¸Šï¼‰</th><th style="text-align:center">å¯¹è±¡ Mark</th><th style="text-align:center">çº¿ç¨‹ 2ï¼ˆcore 2 ä¸Šï¼‰</th></tr></thead><tbody><tr><td style="text-align:center">-</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æˆåŠŸï¼ˆåŠ é”ï¼‰</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">è‡ªæ—‹é‡è¯•</td></tr><tr><td style="text-align:center">æ‰§è¡ŒåŒæ­¥å—</td><td style="text-align:center">10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style="text-align:center">é˜»å¡</td></tr><tr><td style="text-align:center">-</td><td style="text-align:center">â€¦</td><td style="text-align:center">â€¦</td></tr></tbody></table><ul><li>è‡ªæ—‹ä¼šå ç”¨CPUç©ºé—´ï¼Œå•æ ¸CPUè‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸CPUè‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿</li><li>åœ¨Java6ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œå¦‚æœå¯¹è±¡åˆšåˆšä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šå¾ˆé«˜ï¼Œé‚£å°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹å°±å°‘è‡ªæ—‹æˆ–è€…ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹æ˜¯æ¯”è¾ƒæ™ºèƒ½çš„ã€‚</li><li>Java7ä¹‹åå°±ä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½äº†ã€‚</li></ul><h4 id="åå‘é”">åå‘é”</h4><ul><li>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼Œæ¯æ¬¡é‡å…¥ä»éœ€è¦è¿›è¡ŒCASæ“ä½œã€‚Java6ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨CASå°†çº¿ç¨‹IDè®¾ç½®åˆ°å¯¹è±¡å¤´çš„MarkWordå¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹IDæ˜¯è‡ªå·±çš„ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— A</span></span><br><span class="line">        m2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— B</span></span><br><span class="line">        m3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— C</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2023/06/26/pCU5svq.png" alt=""></p><ul><li><p>åå‘çŠ¶æ€ï¼šå…ˆæ¥å›é¡¾ä¸€ä¸‹å¯¹è±¡å¤´æ ¼å¼</p>  <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">                           Mark Word (64 bits)                      </span>|<span class="string">       State        </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> unused:25 </span>|<span class="string"> hashcode:31 </span>|<span class="string"> unused:1 </span>|<span class="string"> age:4 </span>|<span class="string"> biased_lock:0 </span>|<span class="string">  01   </span>|<span class="string">       Normal       </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> thread:54 </span>|<span class="string">  epoch:2    </span>|<span class="string"> unused:1 </span>|<span class="string"> age:4 </span>|<span class="string"> biased_lock:1 </span>|<span class="string">  01   </span>|<span class="string">       Biased       </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">               ptr_to_lock_record:62                        </span>|<span class="string">  00   </span>|<span class="string"> Lightweight Locked </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">             ptr_to_heavyweight_monitor:62                  </span>|<span class="string">  10   </span>|<span class="string"> Heavyweight Locked </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">                                                            </span>|<span class="string">  11   </span>|<span class="string">    Marked for GC   </span>|</span><br><span class="line">|<span class="string">--------------------------------------------------------------------</span>|<span class="string">--------------------</span>|<span class="string"> </span></span><br></pre></td></tr></table></figure></li><li><p>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š</p><ul><li>å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤æ˜¯å¼€å¯çš„ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMarkWordçš„æœ€åä¸‰ä½ä¸º101ï¼Œæ­¤æ—¶å®ƒçš„threadã€epochã€ageéƒ½ä¸º0ã€‚</li><li>åå‘é”é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šå†ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥æ·»åŠ VMå‚æ•°ï¼š<code>XX:BiasedLockingStartupDelay=0</code>æ¥ç¦ç”¨å»¶è¿Ÿã€‚</li><li>å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMarkWordçš„æœ€åä¸‰ä½ä¸º001ï¼Œæ­¤æ—¶å®ƒçš„hashCodeã€ageå‡ä¸º0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ°hashCodeæ—¶æ‰ä¼šèµ‹å€¼ã€‚</li></ul>  <div class="note warning no-icon flat"><ul><li>æ³¨æ„ï¼šåå‘é”è§£é”åï¼Œçº¿ç¨‹IDä»å­˜å‚¨äºå¯¹è±¡å¤´ä¸­</li></ul></div></li></ul><h3 id="wait-notify">wait notify</h3><h4 id="ä¸ºä»€ä¹ˆéœ€è¦wait">ä¸ºä»€ä¹ˆéœ€è¦wait</h4><ul><li>ç”±äºæ¡ä»¶ä¸æ»¡è¶³ï¼Œå°å—ä¸èƒ½ç»§ç»­æ‰§è¡Œè®¡ç®—</li><li>ä½†æ˜¯å°å—å¦‚æœä¸€ç›´å ç”¨ç€é”ï¼Œç­‰å¾…è®¡ç®—èµ„æºçš„åˆ°æ¥ï¼Œå…¶ä»–äººå°±ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå°å—ç°åœ¨å±äºæ˜¯å ç€èŒ…å‘ä¸æ‹‰å±ï¼Œæ•ˆç‡å¤ªä½<br><img src="https://s1.ax1x.com/2023/07/27/pCvDk0H.png" alt=""></li><li>äºæ˜¯è€ç‹å•å¼€äº†ä¸€é—´ä¼‘æ¯å®¤ï¼ˆè°ƒç”¨waitæ–¹æ³•ï¼‰ï¼Œè®©å°å—åˆ°ä¼‘æ¯å®¤ï¼ˆWaitSetï¼‰ç­‰ç€å»äº†ï¼Œå¹¶ä¸”æ­¤æ—¶çš„é”è¢«é‡Šæ”¾å¼€ï¼Œå…¶ä»–äººå¯ä»¥ç”±è€ç‹éšæœºå®‰æ’è¿›å±‹</li><li>çŸ¥é“å°Må°†çƒŸé€æ¥ï¼Œå¤§å–Šä¸€å£°ï¼šä½ çš„çƒŸåˆ°äº†ï¼ˆè°ƒç”¨notifyï¼‰æ–¹æ³•<br><img src="https://s1.ax1x.com/2023/07/27/pCvDZtI.png" alt=""></li><li>äºæ˜¯å°å—å°±ç¦»å¼€äº†ä¼‘æ¯å®¤ï¼Œé‡æ–°è¿›å…¥ç«äº‰é”çš„é˜Ÿåˆ—<br><img src="https://s1.ax1x.com/2023/07/27/pCvDKc8.png" alt=""></li></ul><h4 id="åŸç†ä¹‹wait-notify">åŸç†ä¹‹wait/notify</h4><ul><li>Ownerçº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨waitæ–¹æ³•ï¼Œå³å¯è¿›å…¥WaitSetå˜ä¸ºWAITINGçŠ¶æ€</li><li>BLOCKEDå’ŒWAITINGçº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨CPUæ—¶é—´ç‰‡</li><li>BLOCKEDçº¿ç¨‹ä¼šåœ¨Ownerçº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’</li><li>WAITINGçº¿ç¨‹ä¼šåœ¨Ownerçº¿ç¨‹è°ƒç”¨notifyæˆ–notifyAllæ—¶å”¤é†’ï¼Œä½†å”¤é†’åå¹¶ä¸æ„å‘³ç€ç«‹åˆ»è·å¾—é”ï¼Œä»éœ€è¿›å…¥EntryListé‡æ–°ç«äº‰</li></ul><h4 id="APIä»‹ç»">APIä»‹ç»</h4><ul><li><p><code>obj.wait()</code>ï¼šè®©è¿›å…¥objectç›‘è§†å™¨çš„çº¿ç¨‹åˆ°waitSetç­‰å¾…</p></li><li><p><code>obj.notify()</code>ï¼šè®©objectä¸Šæ­£åœ¨waitSetç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’</p></li><li><p><code>obj.notifyAll()</code>ï¼šè®©objectä¸Šæ­£åœ¨waitSetç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</p></li><li><p>å®ƒä»¬éƒ½æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œåä½œçš„æ‰‹æ®µï¼Œéƒ½å±äºObjectå¯¹è±¡çš„æ–¹æ³•ï¼Œå¿…é¡»è·å¾—æ­¤å¯¹è±¡çš„é”ï¼Œæ‰èƒ½è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•ã€‚</p></li><li><p>ç¤ºä¾‹ä»£ç ï¼Œåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹t1å’Œt2ï¼Œåˆ†åˆ«æ‰§è¡Œwaitï¼Œè®©äºŒè€…è¿›å…¥åˆ°waitSetç­‰å¾…ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨notifyæ¥å”¤é†’ä¸€ä¸ªçº¿ç¨‹</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.NotifyTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ‰§è¡Œ...&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    obj.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å…¶ä»–ä»£ç &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ‰§è¡Œ...&quot;</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    obj.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å…¶ä»–ä»£ç &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;å”¤é†’objä¸Šå…¶ä»–çº¿ç¨‹&quot;</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">            obj.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä»æ‰§è¡Œç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’äº†</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">27</span>:<span class="number">53.375</span> c<span class="selector-class">.NotifyTest</span> <span class="selector-attr">[t2]</span> - æ‰§è¡Œ...</span><br><span class="line"><span class="number">14</span>:<span class="number">27</span>:<span class="number">53.375</span> c<span class="selector-class">.NotifyTest</span> <span class="selector-attr">[t1]</span> - æ‰§è¡Œ...</span><br><span class="line"><span class="number">14</span>:<span class="number">27</span>:<span class="number">55.375</span> c<span class="selector-class">.NotifyTest</span> <span class="selector-attr">[main]</span> - å”¤é†’objä¸Šå…¶ä»–çº¿ç¨‹</span><br><span class="line"><span class="number">14</span>:<span class="number">27</span>:<span class="number">55.375</span> c<span class="selector-class">.NotifyTest</span> <span class="selector-attr">[t1]</span> - å…¶ä»–ä»£ç </span><br></pre></td></tr></table></figure><ul><li>å¦‚ä½•æ­¤æ—¶å°†ä¸»çº¿ç¨‹ä¸­çš„notify()ä¿®æ”¹ä¸ºnotifyAll()ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">30</span>:<span class="number">02.045</span> c<span class="selector-class">.NotifyTest</span> <span class="selector-attr">[t1]</span> - æ‰§è¡Œ...</span><br><span class="line"><span class="number">14</span>:<span class="number">30</span>:<span class="number">02.045</span> c<span class="selector-class">.NotifyTest</span> <span class="selector-attr">[t2]</span> - æ‰§è¡Œ...</span><br><span class="line"><span class="number">14</span>:<span class="number">30</span>:<span class="number">04.042</span> c<span class="selector-class">.NotifyTest</span> <span class="selector-attr">[main]</span> - å”¤é†’objä¸Šå…¶ä»–çº¿ç¨‹</span><br><span class="line"><span class="number">14</span>:<span class="number">30</span>:<span class="number">04.042</span> c<span class="selector-class">.NotifyTest</span> <span class="selector-attr">[t2]</span> - å…¶ä»–ä»£ç </span><br><span class="line"><span class="number">14</span>:<span class="number">30</span>:<span class="number">04.042</span> c<span class="selector-class">.NotifyTest</span> <span class="selector-attr">[t1]</span> - å…¶ä»–ä»£ç </span><br></pre></td></tr></table></figure><ul><li>å°ç»“<ul><li>wait()æ–¹æ³•ä¼šé‡Šæ”¾å¯¹è±¡çš„é”ï¼Œè¿›å…¥WaitSetç­‰å¾…åŒºï¼Œæ— é™åˆ¶ç­‰å¾…ï¼Œç›´åˆ°notifyä½ç½®ï¼Œå¹¶ä¸”æ­¤æ—¶å…¶ä»–çº¿ç¨‹æœ‰æœºä¼šè·å–å¯¹è±¡çš„é”</li><li>wait(long n)ï¼šæœ‰æ—¶é™çš„ç­‰å¾…ï¼Œåˆ°næ¯«ç§’åç»“æŸç­‰å¾…ï¼Œæˆ–æ˜¯è¢«notify</li></ul></li></ul><h3 id="wait-notify-çš„æ­£ç¡®å§¿åŠ¿">wait notify çš„æ­£ç¡®å§¿åŠ¿</h3><ul><li>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹sleep(long n)å’Œwait(long n)çš„åŒºåˆ«<ol><li>sleepæ˜¯Threadçš„æ–¹æ³•ï¼Œè€Œwaitæ˜¯Objectçš„æ–¹æ³•</li><li>sleepä¸å¼ºåˆ¶å’Œsynchronizedé…åˆä½¿ç”¨ï¼Œè€Œwaitéœ€è¦å’Œsynchronizedä¸€èµ·ç”¨</li><li>sleepåœ¨ç¡çœ çš„åŒæ—¶ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œè€Œwaitåœ¨ç­‰å¾…çš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾å¯¹è±¡é”</li></ol></li></ul><h4 id="Step-1">Step 1</h4><ul><li>æ€è€ƒä¸‹é¢çš„è§£å†³æ–¹æ¡ˆå¥½ä¸å¥½ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestNotifyAll&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šå„¿&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            hasCigarette = <span class="literal">true</span>;</span><br><span class="line">            log.debug(<span class="string">&quot;çƒŸåˆ°äº†å¥¥&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;é€çƒŸçš„å°M&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡ºå¦‚ä¸‹</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">08.438</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æœ‰çƒŸæ²¡ï¼Ÿ<span class="selector-attr">[false]</span></span><br><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">08.444</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šå„¿</span><br><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">09.437</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[é€çƒŸçš„å°M]</span> - çƒŸåˆ°äº†å¥¥</span><br><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">10.445</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æœ‰çƒŸæ²¡ï¼Ÿ<span class="selector-attr">[true]</span></span><br><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">10.445</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[å°å—]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">10.445</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[Thread-4]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">10.445</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[Thread-3]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">10.445</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[Thread-2]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">10.445</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[Thread-1]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">14</span>:<span class="number">48</span>:<span class="number">10.445</span> c<span class="selector-class">.TestNotifyAll</span> <span class="selector-attr">[Thread-0]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br></pre></td></tr></table></figure><ul><li>ä¸Šé¢çš„ä»£ç ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œç”±äºå°å—è°ƒç”¨çš„æ˜¯sleepï¼Œç¡çœ æœŸé—´ä¼šé˜»å¡çº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½æ¥å¹²æ´»ï¼Œæ•ˆç‡å¤ªä½</li><li>å…¶æ¬¡ï¼Œå°å—ç¡çœ æ˜¯å›ºå®šçš„2sï¼Œé€šè¿‡è§‚å¯Ÿæ—¶é—´æˆ³ï¼Œå°±ç®—çƒŸæå‰åˆ°äº†ï¼Œä»–ä¹Ÿä¸ä¼šèµ·åºŠå¹²æ´»</li><li>é€çƒŸçš„çº¿ç¨‹ä¸èƒ½åŠ synchronized(room)ï¼Œå› ä¸ºå°å—ä¸€ç›´é”ç€é—¨ï¼ŒçƒŸé€ä¸è¿›å»</li><li>è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨<code>wait - notify</code>æœºåˆ¶</li></ul><h4 id="Step-2">Step 2</h4><ul><li>æ€è€ƒä¸‹é¢çš„å®ç°ï¼Œæ„Ÿè§‰å¯è¡Œå—ï¼Ÿ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestWaitNotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test03</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šå„¿&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait(<span class="number">2000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                hasCigarette = <span class="literal">true</span>;</span><br><span class="line">                log.debug(<span class="string">&quot;çƒŸåˆ°äº†å¥¥&quot;</span>);</span><br><span class="line">                room.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;é€çƒŸçš„å°M&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">44.703</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[å°å—]</span> - æœ‰çƒŸæ²¡ï¼Ÿ<span class="selector-attr">[false]</span></span><br><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">44.708</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[å°å—]</span> - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šå„¿</span><br><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">44.708</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[Thread-4]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">44.708</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[Thread-3]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">44.708</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[Thread-2]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">44.708</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[Thread-1]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">44.708</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[Thread-0]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">45.701</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[é€çƒŸçš„å°M]</span> - çƒŸåˆ°äº†å¥¥</span><br><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">45.701</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[å°å—]</span> - æœ‰çƒŸæ²¡ï¼Ÿ<span class="selector-attr">[true]</span></span><br><span class="line"><span class="number">15</span>:<span class="number">04</span>:<span class="number">45.701</span> c<span class="selector-class">.TestWaitNotify</span> <span class="selector-attr">[å°å—]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br></pre></td></tr></table></figure><ul><li>è§£å†³äº†é˜»å¡å…¶ä»–çº¿ç¨‹çš„é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœå…¶ä»–çº¿ç¨‹ä¹Ÿå­˜åœ¨ç­‰å¾…æ¡ä»¶å‘¢ï¼Ÿ</li></ul><h4 id="Step-3">Step 3</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestWaitNotifyAll&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šå„¿&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¹²æˆæ´»&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–åˆ°äº†æ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">                <span class="keyword">if</span> (!hasTakeout) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šå„¿&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–åˆ°äº†æ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">                <span class="keyword">if</span> (hasTakeout) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¹²æˆæ´»&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å¥³&quot;</span>).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                hasTakeout = <span class="literal">true</span>;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–åˆ°äº†å¥¥&quot;</span>);</span><br><span class="line">                room.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;é€å¤–å–çš„&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">18</span>:<span class="number">51.925</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æœ‰çƒŸæ²¡ï¼Ÿ<span class="selector-attr">[false]</span></span><br><span class="line"><span class="number">15</span>:<span class="number">18</span>:<span class="number">51.931</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šå„¿</span><br><span class="line"><span class="number">15</span>:<span class="number">18</span>:<span class="number">51.931</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å¥³]</span> - å¤–å–åˆ°äº†æ²¡ï¼Ÿ<span class="selector-attr">[false]</span></span><br><span class="line"><span class="number">15</span>:<span class="number">18</span>:<span class="number">51.931</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å¥³]</span> - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šå„¿</span><br><span class="line"><span class="number">15</span>:<span class="number">18</span>:<span class="number">52.926</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[é€å¤–å–çš„å°M]</span> - å¤–å–åˆ°äº†å¥¥</span><br><span class="line"><span class="number">15</span>:<span class="number">18</span>:<span class="number">52.926</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æœ‰çƒŸæ²¡ï¼Ÿ<span class="selector-attr">[false]</span></span><br><span class="line"><span class="number">15</span>:<span class="number">18</span>:<span class="number">52.926</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æ²¡å¹²æˆæ´»</span><br></pre></td></tr></table></figure><ul><li>notifyåªèƒ½å”¤é†’ä¸€ä¸ªWaitSetä¸­çš„çº¿ç¨‹ï¼Œå¦‚æœæ­¤æ—¶æœ‰å…¶ä»–çº¿ç¨‹ä¹Ÿåœ¨ç­‰ï¼Œé‚£ä¹ˆå¯èƒ½å”¤é†’ä¸äº†æ­£ç¡®çš„çº¿ç¨‹ï¼Œè¿™ç§æƒ…å†µè¢«ç§°ä¹‹ä¸º<code>è™šå‡å”¤é†’</code>ã€‚<ul><li>ä¸Šé¢çš„è¾“å‡ºç»“æœä¸­ï¼Œå¤–å–é€åˆ°äº†ï¼Œä½†æ˜¯å”¤é†’çš„ç¡®å®å°å—ï¼Œå”¤é†’äº†é”™è¯¯çš„çº¿ç¨‹</li></ul></li></ul><h4 id="Step-4">Step 4</h4><ul><li>è¦è§£å†³åˆšåˆšçš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨notifyAllæ¥å”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œä½†æ˜¯ç”¨if + waitä»…æœ‰ä¸€æ¬¡åˆ¤æ–­å‡ ä¹ï¼Œä¸€æ—¦æ¡ä»¶ä¸æˆç«‹ï¼Œå°±æ²¡æœ‰é‡æ–°åˆ¤æ–­çš„æœºä¼šäº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡‡ç”¨<code>while + wait</code>çš„æ–¹å¼æ¥åˆ¤æ–­ï¼Œå½“æ¡ä»¶ä¸æˆç«‹æ—¶ï¼Œç»§ç»­wait</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestWaitNotifyAll&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">while</span> (!hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šå„¿&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–åˆ°äº†æ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">                <span class="keyword">while</span> (!hasTakeout) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šå„¿&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å¥³&quot;</span>).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                hasTakeout = <span class="literal">true</span>;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–åˆ°äº†å¥¥&quot;</span>);</span><br><span class="line">                room.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;é€å¤–å–çš„&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">21</span>:<span class="number">59.246</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æœ‰çƒŸæ²¡ï¼Ÿ<span class="selector-attr">[false]</span></span><br><span class="line"><span class="number">15</span>:<span class="number">21</span>:<span class="number">59.252</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šå„¿</span><br><span class="line"><span class="number">15</span>:<span class="number">21</span>:<span class="number">59.252</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å¥³]</span> - å¤–å–åˆ°äº†æ²¡ï¼Ÿ<span class="selector-attr">[false]</span></span><br><span class="line"><span class="number">15</span>:<span class="number">21</span>:<span class="number">59.252</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å¥³]</span> - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šå„¿</span><br><span class="line"><span class="number">15</span>:<span class="number">22</span>:<span class="number">00.244</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[é€å¤–å–çš„]</span> - å¤–å–åˆ°äº†å¥¥</span><br><span class="line"><span class="number">15</span>:<span class="number">22</span>:<span class="number">00.244</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å¥³]</span> - å¤–å–åˆ°äº†æ²¡ï¼Ÿ<span class="selector-attr">[true]</span></span><br><span class="line"><span class="number">15</span>:<span class="number">22</span>:<span class="number">00.244</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å¥³]</span> - å¯ä»¥å¼€å§‹å¹²æ´»äº†</span><br><span class="line"><span class="number">15</span>:<span class="number">22</span>:<span class="number">00.244</span> c<span class="selector-class">.TestWaitNotifyAll</span> <span class="selector-attr">[å°å—]</span> - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šå„¿</span><br></pre></td></tr></table></figure><ul><li>å”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œä½†æ˜¯å°å—ä¾ç„¶ä¸ç¬¦åˆæ¡ä»¶ï¼Œç»§ç»­ç­‰å¾…ã€‚å°†æ­¤ç§æ–¹å¼å°è£…ä¸ºä¸€ä¸ªæ¨¡æ¿ï¼Œå¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">    <span class="keyword">while</span>(æ¡ä»¶ä¸æˆç«‹) &#123;</span><br><span class="line">        lock.wait()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¹²æ´»</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">    lock.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¿æŠ¤æ€§æš‚åœæ¨¡å¼">ä¿æŠ¤æ€§æš‚åœæ¨¡å¼</h3><h4 id="å®šä¹‰">å®šä¹‰</h4><ul><li>å³Guarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ</li><li>è¦ç‚¹<ol><li>æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©ä»–ä»¬å…³è”åŒä¸€ä¸ªGuardedObject</li><li>å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—</li><li>JDKä¸­ï¼Œjoinçš„å®ç°ï¼ŒFutureçš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼</li><li>å› ä¸ºè¦ç­‰å¾…å¦ä¸€æ–¹çš„ç»“æœï¼Œå› æ­¤å½’ç±»åˆ°åŒæ­¥æ¨¡å¼</li></ol></li></ul><h4 id="å®ç°">å®ç°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObject</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åº”ç”¨-2">åº”ç”¨</h4><ul><li>ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœï¼Œé¦–å…ˆç¼–å†™ä¸€ä¸ªç±»æ¥æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¸‹è½½baidu.comçš„ç½‘é¡µå†…å®¹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Downloader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">download</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">HttpURLConnection</span> <span class="variable">conn</span> <span class="operator">=</span> (HttpURLConnection) <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;https://www.baidu.com/&quot;</span>).openConnection();</span><br><span class="line">        List&lt;String&gt; lines = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span></span><br><span class="line">                     <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(conn.getInputStream(), StandardCharsets.UTF_8))) &#123;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                lines.add(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lines;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œä¸‹è½½ä»»åŠ¡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestGuarded&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test05</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">guardedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObject</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å­çº¿ç¨‹æ‰§è¡Œä¸‹è½½</span></span><br><span class="line">                List&lt;String&gt; response = Downloader.download();</span><br><span class="line">                log.debug(<span class="string">&quot;ä¸‹è½½å®Œæ¯•&quot;</span>);</span><br><span class="line">                guardedObject.complete(response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…t1çº¿ç¨‹ä¸‹è½½å®Œæ¯•ä¹‹å</span></span><br><span class="line">        List&lt;String&gt; response = (List&lt;String&gt;) guardedObject.get();</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–çº¿ç¨‹æ‰§è¡Œç»“æœï¼šã€&#123;&#125;ã€‘&quot;</span>, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œç»“æœ</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">16:43:29.121 c.TestGuarded [main] - waiting...</span><br><span class="line">16:43:30.461 c.TestGuarded [t1] - ä¸‹è½½å®Œæ¯•</span><br><span class="line">16:43:30.461 c.TestGuarded [main] - è·å–çº¿ç¨‹æ‰§è¡Œç»“æœï¼šã€[<span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span>, <span class="comment">&lt;!--STATUS OK--&gt;</span><span class="tag">&lt;<span class="name">html</span>&gt;</span> <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">content-type</span> <span class="attr">content</span>=<span class="string">text/html;charset</span>=<span class="string">utf-8</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">X-UA-Compatible</span> <span class="attr">content</span>=<span class="string">IE</span>=<span class="string">Edge</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">always</span> <span class="attr">name</span>=<span class="string">referrer</span>&gt;</span><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">stylesheet</span> <span class="attr">type</span>=<span class="string">text/css</span> <span class="attr">href</span>=<span class="string">https://ss1.bdstatic.com/5eN1bjq8AAUYm2zgoY3K/r/www/cache/bdorz/baidu.min.css</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span> <span class="tag">&lt;<span class="name">body</span> <span class="attr">link</span>=<span class="string">#0000cc</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">wrapper</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">head</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">head_wrapper</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">s_form</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">s_form_wrapper</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">lg</span>&gt;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">hidefocus</span>=<span class="string">true</span> <span class="attr">src</span>=<span class="string">//www.baidu.com/img/bd_logo1.png</span> <span class="attr">width</span>=<span class="string">270</span> <span class="attr">height</span>=<span class="string">129</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">form</span> <span class="attr">name</span>=<span class="string">f</span> <span class="attr">action</span>=<span class="string">//www.baidu.com/s</span> <span class="attr">class</span>=<span class="string">fm</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">bdorz_come</span> <span class="attr">value</span>=<span class="string">1</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">ie</span> <span class="attr">value</span>=<span class="string">utf-8</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">f</span> <span class="attr">value</span>=<span class="string">8</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">rsv_bp</span> <span class="attr">value</span>=<span class="string">1</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">rsv_idx</span> <span class="attr">value</span>=<span class="string">1</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">tn</span> <span class="attr">value</span>=<span class="string">baidu</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;bg s_ipt_wr&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">kw</span> <span class="attr">name</span>=<span class="string">wd</span> <span class="attr">class</span>=<span class="string">s_ipt</span> <span class="attr">value</span> <span class="attr">maxlength</span>=<span class="string">255</span> <span class="attr">autocomplete</span>=<span class="string">off</span> <span class="attr">autofocus</span>=<span class="string">autofocus</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;bg s_btn_wr&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">id</span>=<span class="string">su</span> <span class="attr">value</span>=<span class="string">ç™¾åº¦ä¸€ä¸‹</span> <span class="attr">class</span>=<span class="string">&quot;bg s_btn&quot;</span> <span class="attr">autofocus</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">form</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">u1</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://news.baidu.com</span> <span class="attr">name</span>=<span class="string">tj_trnews</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>æ–°é—»<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">https://www.hao123.com</span> <span class="attr">name</span>=<span class="string">tj_trhao123</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>hao123<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://map.baidu.com</span> <span class="attr">name</span>=<span class="string">tj_trmap</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>åœ°å›¾<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://v.baidu.com</span> <span class="attr">name</span>=<span class="string">tj_trvideo</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>è§†é¢‘<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://tieba.baidu.com</span> <span class="attr">name</span>=<span class="string">tj_trtieba</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>è´´å§<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">noscript</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://www.baidu.com/bdorz/login.gif?login&amp;amp;tpl</span>=<span class="string">mn&amp;amp;u</span>=<span class="string">http%3A%2F%2Fwww.baidu.com%2f%3fbdorz_come%3d1</span> <span class="attr">name</span>=<span class="string">tj_login</span> <span class="attr">class</span>=<span class="string">lb</span>&gt;</span>ç™»å½•<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;/<span class="name">noscript</span>&gt;</span> <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;&lt;a href=&quot;http://www.baidu.com/bdorz/login.gif?login&amp;tpl=mn&amp;u=&#x27;</span>+ <span class="built_in">encodeURIComponent</span>(<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>+ (<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">search</span> === <span class="string">&quot;&quot;</span> ? <span class="string">&quot;?&quot;</span> : <span class="string">&quot;&amp;&quot;</span>)+ <span class="string">&quot;bdorz_come=1&quot;</span>)+ <span class="string">&#x27;&quot; name=&quot;tj_login&quot; class=&quot;lb&quot;&gt;ç™»å½•&lt;/a&gt;&#x27;</span>);,                 </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">//www.baidu.com/more/</span> <span class="attr">name</span>=<span class="string">tj_briicon</span> <span class="attr">class</span>=<span class="string">bri</span> <span class="attr">style</span>=<span class="string">&quot;display: block;&quot;</span>&gt;</span>æ›´å¤šäº§å“<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">ftCon</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">ftConw</span>&gt;</span> <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">lh</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://home.baidu.com</span>&gt;</span>å…³äºç™¾åº¦<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://ir.baidu.com</span>&gt;</span>About Baidu<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;/<span class="name">p</span>&gt;</span> <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">cp</span>&gt;</span><span class="symbol">&amp;copy;</span>2017<span class="symbol">&amp;nbsp;</span>Baidu<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://www.baidu.com/duty/</span>&gt;</span>ä½¿ç”¨ç™¾åº¦å‰å¿…è¯»<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="symbol">&amp;nbsp;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://jianyi.baidu.com/</span> <span class="attr">class</span>=<span class="string">cp-feedback</span>&gt;</span>æ„è§åé¦ˆ<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="symbol">&amp;nbsp;</span>äº¬ICPè¯030173å·<span class="symbol">&amp;nbsp;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">//www.baidu.com/img/gs.gif</span>&gt;</span> <span class="tag">&lt;/<span class="name">p</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">body</span>&gt;</span> <span class="tag">&lt;/<span class="name">html</span>&gt;</span>]ã€‘</span><br></pre></td></tr></table></figure><h4 id="å¸¦è¶…æ—¶ç‰ˆ">å¸¦è¶…æ—¶ç‰ˆ</h4><ul><li>ä¹‹å‰çš„ç‰ˆæœ¬æ²¡æœ‰è¶…æ—¶æ—¶é—´ï¼Œåªèƒ½æ— é™ç­‰å¾…ï¼Œé‚£æˆ‘ä»¬ç°åœ¨å°±è¦æ¥è§£å†³è¿™ä¸ªé—®é¢˜</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObjectWithTimeout</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout millis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// 1. è®°å½•åˆå§‹æ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="comment">// 2. å·²ç»è¿‡çš„æ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">passed</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 3. è®¾ç½®å‰©ä½™ç­‰å¾…æ—¶é—´</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> timeout - passed;</span><br><span class="line">                <span class="comment">// 4. å¦‚æœè¶…æ—¶ï¼Œé€€å‡ºç­‰å¾…</span></span><br><span class="line">                <span class="keyword">if</span> (waitTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait(waitTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 5. è®¡ç®—å·²ç»è¿‡çš„æ—¶é—´</span></span><br><span class="line">                passed = System.currentTimeMillis() - begin;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tabs" id="æµ‹è¯•è¶…æ—¶"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#æµ‹è¯•è¶…æ—¶-1">æµ‹è¯•æ²¡æœ‰è¶…æ—¶çš„æƒ…å†µ</button></li><li class="tab"><button type="button" data-href="#æµ‹è¯•è¶…æ—¶-2">æµ‹è¯•è¶…æ—¶çš„æƒ…å†µ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="æµ‹è¯•è¶…æ—¶-1"><ul><li>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼Œç»™äºˆä¸€ä¸ªç›¸å¯¹å……è£•çš„è¶…æ—¶æ—¶é—´</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestGuarded&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test06</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GuardedObjectWithTimeout</span> <span class="variable">guardedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObjectWithTimeout</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                List&lt;String&gt; response = Downloader.download();</span><br><span class="line">                log.debug(<span class="string">&quot;ä¸‹è½½å®Œæ¯•&quot;</span>);</span><br><span class="line">                guardedObject.complete(response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…t1çº¿ç¨‹ä¸‹è½½å®Œæ¯•ä¹‹å</span></span><br><span class="line">        List&lt;String&gt; response = (List&lt;String&gt;) guardedObject.get(<span class="number">2000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–çº¿ç¨‹æ‰§è¡Œç»“æœï¼šã€&#123;&#125;ã€‘&quot;</span>, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¡ºåˆ©ä¸‹è½½å®Œæˆï¼Œå¹¶ä¸”å¾—åˆ°ç»“æœ</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">17:40:23.783 c.TestGuarded [main] - waiting...</span><br><span class="line">17:40:25.645 c.TestGuarded [t1] - ä¸‹è½½å®Œæ¯•</span><br><span class="line">17:40:25.645 c.TestGuarded [main] - è·å–çº¿ç¨‹æ‰§è¡Œç»“æœï¼šã€[<span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span>, <span class="comment">&lt;!--STATUS OK--&gt;</span><span class="tag">&lt;<span class="name">html</span>&gt;</span> <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">content-type</span> <span class="attr">content</span>=<span class="string">text/html;charset</span>=<span class="string">utf-8</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">X-UA-Compatible</span> <span class="attr">content</span>=<span class="string">IE</span>=<span class="string">Edge</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">always</span> <span class="attr">name</span>=<span class="string">referrer</span>&gt;</span><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">stylesheet</span> <span class="attr">type</span>=<span class="string">text/css</span> <span class="attr">href</span>=<span class="string">https://ss1.bdstatic.com/5eN1bjq8AAUYm2zgoY3K/r/www/cache/bdorz/baidu.min.css</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span> <span class="tag">&lt;<span class="name">body</span> <span class="attr">link</span>=<span class="string">#0000cc</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">wrapper</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">head</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">head_wrapper</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">s_form</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">s_form_wrapper</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">lg</span>&gt;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">hidefocus</span>=<span class="string">true</span> <span class="attr">src</span>=<span class="string">//www.baidu.com/img/bd_logo1.png</span> <span class="attr">width</span>=<span class="string">270</span> <span class="attr">height</span>=<span class="string">129</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">form</span> <span class="attr">name</span>=<span class="string">f</span> <span class="attr">action</span>=<span class="string">//www.baidu.com/s</span> <span class="attr">class</span>=<span class="string">fm</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">bdorz_come</span> <span class="attr">value</span>=<span class="string">1</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">ie</span> <span class="attr">value</span>=<span class="string">utf-8</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">f</span> <span class="attr">value</span>=<span class="string">8</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">rsv_bp</span> <span class="attr">value</span>=<span class="string">1</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">rsv_idx</span> <span class="attr">value</span>=<span class="string">1</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">name</span>=<span class="string">tn</span> <span class="attr">value</span>=<span class="string">baidu</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;bg s_ipt_wr&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">kw</span> <span class="attr">name</span>=<span class="string">wd</span> <span class="attr">class</span>=<span class="string">s_ipt</span> <span class="attr">value</span> <span class="attr">maxlength</span>=<span class="string">255</span> <span class="attr">autocomplete</span>=<span class="string">off</span> <span class="attr">autofocus</span>=<span class="string">autofocus</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;bg s_btn_wr&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">id</span>=<span class="string">su</span> <span class="attr">value</span>=<span class="string">ç™¾åº¦ä¸€ä¸‹</span> <span class="attr">class</span>=<span class="string">&quot;bg s_btn&quot;</span> <span class="attr">autofocus</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">form</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">u1</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://news.baidu.com</span> <span class="attr">name</span>=<span class="string">tj_trnews</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>æ–°é—»<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">https://www.hao123.com</span> <span class="attr">name</span>=<span class="string">tj_trhao123</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>hao123<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://map.baidu.com</span> <span class="attr">name</span>=<span class="string">tj_trmap</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>åœ°å›¾<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://v.baidu.com</span> <span class="attr">name</span>=<span class="string">tj_trvideo</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>è§†é¢‘<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://tieba.baidu.com</span> <span class="attr">name</span>=<span class="string">tj_trtieba</span> <span class="attr">class</span>=<span class="string">mnav</span>&gt;</span>è´´å§<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">noscript</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://www.baidu.com/bdorz/login.gif?login&amp;amp;tpl</span>=<span class="string">mn&amp;amp;u</span>=<span class="string">http%3A%2F%2Fwww.baidu.com%2f%3fbdorz_come%3d1</span> <span class="attr">name</span>=<span class="string">tj_login</span> <span class="attr">class</span>=<span class="string">lb</span>&gt;</span>ç™»å½•<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;/<span class="name">noscript</span>&gt;</span> <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;&lt;a href=&quot;http://www.baidu.com/bdorz/login.gif?login&amp;tpl=mn&amp;u=&#x27;</span>+ <span class="built_in">encodeURIComponent</span>(<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>+ (<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">search</span> === <span class="string">&quot;&quot;</span> ? <span class="string">&quot;?&quot;</span> : <span class="string">&quot;&amp;&quot;</span>)+ <span class="string">&quot;bdorz_come=1&quot;</span>)+ <span class="string">&#x27;&quot; name=&quot;tj_login&quot; class=&quot;lb&quot;&gt;ç™»å½•&lt;/a&gt;&#x27;</span>);,                 </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">//www.baidu.com/more/</span> <span class="attr">name</span>=<span class="string">tj_briicon</span> <span class="attr">class</span>=<span class="string">bri</span> <span class="attr">style</span>=<span class="string">&quot;display: block;&quot;</span>&gt;</span>æ›´å¤šäº§å“<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">ftCon</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">ftConw</span>&gt;</span> <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">lh</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://home.baidu.com</span>&gt;</span>å…³äºç™¾åº¦<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://ir.baidu.com</span>&gt;</span>About Baidu<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;/<span class="name">p</span>&gt;</span> <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">cp</span>&gt;</span><span class="symbol">&amp;copy;</span>2017<span class="symbol">&amp;nbsp;</span>Baidu<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://www.baidu.com/duty/</span>&gt;</span>ä½¿ç”¨ç™¾åº¦å‰å¿…è¯»<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="symbol">&amp;nbsp;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://jianyi.baidu.com/</span> <span class="attr">class</span>=<span class="string">cp-feedback</span>&gt;</span>æ„è§åé¦ˆ<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="symbol">&amp;nbsp;</span>äº¬ICPè¯030173å·<span class="symbol">&amp;nbsp;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">//www.baidu.com/img/gs.gif</span>&gt;</span> <span class="tag">&lt;/<span class="name">p</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;/<span class="name">body</span>&gt;</span> <span class="tag">&lt;/<span class="name">html</span>&gt;</span>]ã€‘</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æµ‹è¯•è¶…æ—¶-2"><ul><li>å°†è¶…æ—¶æ—¶é—´è®¾ç½®çš„çŸ­ä¸€äº›</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestGuarded&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test06</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GuardedObjectWithTimeout</span> <span class="variable">guardedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObjectWithTimeout</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                List&lt;String&gt; response = Downloader.download();</span><br><span class="line">                log.debug(<span class="string">&quot;ä¸‹è½½å®Œæ¯•&quot;</span>);</span><br><span class="line">                guardedObject.complete(response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…t1çº¿ç¨‹ä¸‹è½½å®Œæ¯•ä¹‹å</span></span><br><span class="line">        List&lt;String&gt; response = (List&lt;String&gt;) guardedObject.get(<span class="number">500</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–çº¿ç¨‹æ‰§è¡Œç»“æœï¼šã€&#123;&#125;ã€‘&quot;</span>, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœå¦‚ä¸‹ï¼Œç­‰å¾…è¶…æ—¶ï¼Œæ²¡æœ‰è·å–åˆ°ç»“æœ</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">42</span>:<span class="number">52.076</span> c<span class="selector-class">.TestGuarded</span> <span class="selector-attr">[main]</span> - waiting...</span><br><span class="line"><span class="number">17</span>:<span class="number">42</span>:<span class="number">52.582</span> c<span class="selector-class">.TestGuarded</span> <span class="selector-attr">[main]</span> - è·å–çº¿ç¨‹æ‰§è¡Œç»“æœï¼šã€nullã€‘</span><br><span class="line"><span class="number">17</span>:<span class="number">42</span>:<span class="number">53.403</span> c<span class="selector-class">.TestGuarded</span> <span class="selector-attr">[t1]</span> - ä¸‹è½½å®Œæ¯•</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div> <h3 id="åŸç†ä¹‹join">åŸç†ä¹‹join</h3><ul><li>joinæ–¹æ³•çš„å®ç°åŸç†å°±æ˜¯åŸºäºæˆ‘ä»¬åˆšåˆšæ‰‹å†™çš„ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ï¼Œå…¶åº•å±‚æºç ä¹Ÿä¸æˆ‘ä»¬åˆšåˆšå†™çš„ä»£ç ç±»ä¼¼</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">isAlive</span><span class="params">()</span>; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">join</span><span class="params">(<span class="type">long</span> millis)</span></span><br><span class="line"><span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;timeout value is negative&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            wait(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">delay</span> <span class="operator">=</span> millis - now;</span><br><span class="line">            <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            wait(delay);</span><br><span class="line">            now = System.currentTimeMillis() - base;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤šä»»åŠ¡ç‰ˆGuardedObject">å¤šä»»åŠ¡ç‰ˆGuardedObject</h3><!-- TODO --><h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼">ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</h3><!-- TODO --><h3 id="park-unpark">park &amp; unpark</h3><ul><li>å®ƒä»¬æ˜¯LockSupportç±»ä¸­çš„æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æš‚åœå½“å‰çº¿ç¨‹</span></span><br><span class="line">LockSupport.park();</span><br><span class="line"><span class="comment">// å›å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ</span></span><br><span class="line">LockSupport.unpark(æš‚åœçº¿ç¨‹å¯¹è±¡);</span><br></pre></td></tr></table></figure><div class="tabs" id="parkå’Œunpark"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#parkå’Œunpark-1">å…ˆparkå†unpark</button></li><li class="tab"><button type="button" data-href="#parkå’Œunpark-2">å…ˆunparkå†park</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="parkå’Œunpark-1"><ul><li>å…ˆparkå†unpark</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestPark&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;start ..&quot;</span>);</span><br><span class="line"></span><br><span class="line">            log.debug(<span class="string">&quot;park ..&quot;</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line"></span><br><span class="line">            log.debug(<span class="string">&quot;resume ..&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;unpark ..&quot;</span>);</span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">23.497</span> c.<span class="symbol">TestPark</span> [t1] - start ..</span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">23.500</span> c.<span class="symbol">TestPark</span> [t1] - park ..</span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">24.496</span> c.<span class="symbol">TestPark</span> [main] - unpark ..</span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">24.496</span> c.<span class="symbol">TestPark</span> [t1] - resume ..</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="parkå’Œunpark-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestPark&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;start ..&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;park ..&quot;</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line"></span><br><span class="line">            log.debug(<span class="string">&quot;resume ..&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;unpark ..&quot;</span>);</span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">36</span>:<span class="number">34.445</span> c.<span class="symbol">TestPark</span> [t1] - start ..</span><br><span class="line"><span class="number">21</span>:<span class="number">36</span>:<span class="number">35.445</span> c.<span class="symbol">TestPark</span> [main] - unpark ..</span><br><span class="line"><span class="number">21</span>:<span class="number">36</span>:<span class="number">36.447</span> c.<span class="symbol">TestPark</span> [t1] - park ..</span><br><span class="line"><span class="number">21</span>:<span class="number">36</span>:<span class="number">36.447</span> c.<span class="symbol">TestPark</span> [t1] - resume ..</span><br></pre></td></tr></table></figure><ul><li>ä»ç»“æœä¸­çœ‹åˆ°ï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œunparkå†æ‰§è¡Œparkï¼Œçº¿ç¨‹ä¾ç„¶ä¸ä¼šè¢«é˜»å¡ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ<ul><li>ç»§ç»­å¾€ä¸‹çœ‹<code>park &amp; unpark</code>çš„åŸç†</li></ul></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>ä¸Objectçš„<code>wait &amp; notify</code>å¯¹æ¯”<ul><li>waitã€notifyã€notifyAllå¿…é¡»é…åˆObject Monitorä¸€èµ·ä½¿ç”¨ï¼Œè€Œparkã€unparkä¸å¿…</li><li><code>park &amp; unpark</code>æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥é˜»å¡å’Œå”¤é†’çº¿ç¨‹çš„ï¼Œè€Œnotifyåªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…ä¸­çš„çº¿ç¨‹ï¼ŒnotifyAllæ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œä¸ç²¾ç¡®</li><li><code>park &amp; unpark</code>å¯ä»¥å…ˆunparkï¼Œè€Œ<code>wait &amp; notify</code>åªèƒ½ä¸èƒ½å…ˆnotify</li></ul></li></ul><h3 id="åŸç†ä¹‹park-unpark">åŸç†ä¹‹park &amp; unpark</h3><ul><li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªParkerå¯¹è±¡ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆ<code>_counter</code>ã€<code>_cond</code>å’Œ<code>_mutex</code>ï¼Œæ‰“ä¸ªæ¯”å–»<ul><li>çº¿ç¨‹å°±åƒä¸€ä¸ªæ—…äººï¼ŒParkerå°±åƒä»–éšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œ<code>_cond</code>å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¸ç¯·ï¼Œ<code>_counter</code>å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¤‡ç”¨å¹²ç²®(0ä¸ºè€—å°½ï¼Œ1ä¸ºå……è¶³)</li><li>è°ƒç”¨parkå°±æ˜¯è¦çœ‹éœ€ä¸éœ€è¦åœä¸‹æ¥ä¼‘æ¯<ul><li>å¦‚æœå¤‡ç”¨å¹²ç²®è€—å°½ï¼Œé‚£ä¹ˆå°±é’»è¿›å¸ç¯·ä¼‘æ¯</li><li>å¦‚æœå¤‡ç”¨å¹²ç²®å……è¶³ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åœç•™ï¼Œç»§ç»­å‰è¿›</li></ul></li><li>è°ƒç”¨unparkï¼Œå°±å¥½æ¯”ä»¤å¹²ç²®å……è¶³<ul><li>å¦‚æœæ­¤æ—¶è¿˜åœ¨å¸ç¯·ï¼Œé‚£å°±å”¤é†’ä»–ç»§ç»­å‰è¿›</li><li>å¦‚æœæ­¤æ—¶çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä»–ä¸‹æ¬¡è°ƒç”¨parkçš„æ—¶å€™ï¼Œä»…æ¶ˆè€—æ‰å¤‡ç”¨å¹²ç²®ï¼Œä¸éœ€è¦åœç•™ç»§ç»­å‰è¿›<ul><li>ä½†æ˜¯ç”±äºèƒŒåŒ…æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨unparkä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨å¹²ç²®</li></ul></li></ul></li></ul></li></ul><p><img src="https://s1.ax1x.com/2023/07/27/pCxnhlV.png" alt=""></p><ol><li><p>å½“çº¿ç¨‹è°ƒç”¨Unsafe.park()æ–¹æ³•</p></li><li><p>æ£€æŸ¥<code>_counter</code>ï¼Œæ­¤æ—¶<code>_counter = 0</code>ï¼Œè·å¾—<code>_mutex</code>äº’æ–¥é”</p></li><li><p>çº¿ç¨‹è¿›å…¥<code>_cond</code>æ¡ä»¶å˜é‡é˜»å¡</p></li><li><p>è®¾ç½®<code>_counter = 0</code></p></li><li><p>å½“çº¿ç¨‹è°ƒç”¨Unsafe.unpark()æ–¹æ³•ï¼Œè®¾ç½®<code>_counter = 1</code></p></li><li><p>å½“å‰çº¿ç¨‹è°ƒç”¨Unsafe.park()æ–¹æ³•</p></li><li><p>æ£€æŸ¥<code>_counter</code>ï¼Œæ­¤æ—¶<code>_counter = 1</code>ï¼Œçº¿ç¨‹æ— éœ€é˜»å¡ï¼Œç»§ç»­æ‰§è¡Œ</p></li><li><p>è®¾ç½®<code>_counter = 0</code></p></li></ol><h3 id="é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢">é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢</h3><ul><li>å‡è®¾æœ‰<code>Thread t</code><ol><li><code>NEW -&gt; RUNNABLE</code><ul><li>å½“è°ƒç”¨t.start()æ–¹æ³•æ—¶ï¼Œç”±<code>NEW -&gt; RUNNABLE</code></li></ul></li><li><code>RUNNABLE &lt;-&gt; WAITING</code><ul><li>tçº¿ç¨‹ä½¿ç”¨<code>synchronized(obj)</code>è·å–å¯¹è±¡é”ä¹‹å</li><li>è°ƒç”¨<code>obj.wait()</code>æ–¹æ³•æ—¶ï¼Œtçº¿ç¨‹ç”±<code>RUNNABLE -&gt; WAITING</code></li><li>è°ƒç”¨<code>obj.notify()</code>ã€<code>obj.notifyAll()</code>ã€<code>t.interrupt()</code>æ—¶<ul><li>ç«äº‰é”æˆåŠŸï¼Œtçº¿ç¨‹ç”±<code>WAITING -&gt; RUNNABLE</code></li><li>ç«äº‰é”å¤±è´¥ï¼Œtçº¿ç¨‹ç”±<code>WAITING -&gt; BLOCKED</code></li></ul></li></ul></li><li><code>RUNNABLE &lt;-&gt; WAITING</code><ul><li>å½“çº¿ç¨‹è°ƒç”¨t.join()æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šä»<code>RUNNABLE -&gt; WAITING</code><ul><li>æ³¨æ„å½“å‰çº¿ç¨‹æ˜¯åœ¨tçº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</li></ul></li><li>tçº¿ç¨‹è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt()</code>æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>WAITING -&gt; RUNNABLE</code></li></ul></li><li><code>RUNNABLE &lt;-&gt; WAITING</code><ul><li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>LockSupport.park()</code>æ–¹æ³•ï¼Œä¼šè®©å½“å‰çº¿ç¨‹ä»<code>RUNNABLE -&gt; WAITING</code></li><li>è°ƒç”¨LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)ï¼Œä¼šè®©ç›®æ ‡ç°æˆä»<code>WAITING -&gt; RUNNABLE</code></li></ul></li><li><code>RUNNABLE &lt;-&gt; TIMED_WAITING</code><ul><li>tçº¿ç¨‹ç”¨synchronized(obj)è·å–äº†å¯¹è±¡é”å<ul><li>è°ƒç”¨<code>obj.wait(long n)</code>æ–¹æ³•æ—¶ï¼Œtçº¿ç¨‹ä»<code>RUNNABLE -&gt; TIMED_WAITING</code></li><li>tçº¿ç¨‹ç­‰å¾…è¶…è¿‡äº†næ¯«ç§’æ—¶ï¼Œæˆ–è€…è°ƒç”¨obj.notify()ã€obj.notifyAll()ã€t.interrupt()æ—¶<ul><li>ç«äº‰æˆåŠŸï¼Œtçº¿ç¨‹ä»<code>TIMED_WAITING -&gt; RUNNABLE</code></li><li>ç«äº‰å¤±è´¥ï¼Œtçº¿ç¨‹ä»<code>TIMED_WAITING -&gt; BLOCKED</code></li></ul></li></ul></li></ul></li><li><code>RUNNABLE &lt;-&gt; TIMED_WAITING</code><ul><li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>t.join(long n)</code>æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE -&gt; TIMED_WAITING</code></li><li>å½“å‰çº¿ç¨‹ç­‰å¾…è¶…è¿‡äº†næ¯«ç§’ï¼Œæˆ–tçº¿ç¨‹è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt()</code>æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>TIMED_WAITING -&gt; RUNNABLE</code></li></ul></li><li><code>RUNNABLE &lt;-&gt; TIMED_WAITING</code><ul><li>å½“å‰çº¿ç¨‹è°ƒç”¨äº†<code>Thread.sleep(long n)</code>ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE -&gt; TIMED_WAITING</code></li><li>å½“å‰çº¿ç¨‹ç­‰å¾…è¶…è¿‡äº†næ¯«ç§’ï¼Œå½“å‰çº¿ç¨‹ä»<code>TIMED_WAITING -&gt; RUNNABLE</code></li></ul></li><li><code>RUNNABLE &lt;-&gt; TIMED_WAITING</code><ul><li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>LockSupport.parkNanos(long nanos)</code>æˆ–<code>LockSupport.parkUntil(long millis)</code>æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE -&gt; TIMED_WAITING</code></li><li>è°ƒç”¨LockSupport.unpark(ç›®æ ‡ç°æˆ)æˆ–è°ƒç”¨äº†çº¿ç¨‹çš„interrupt()æˆ–ç­‰å¾…è¶…æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>TIMED_WAITING -&gt; RUNNABLE</code></li></ul></li><li><code>RUNNABLE &lt;-&gt; BLOCKED</code><ul><li>tçº¿ç¨‹ç”¨synchronized(obj)è·å–é”æ—¶ï¼Œå¦‚æœç«äº‰å¤±è´¥ï¼Œä¼šä»<code>RUNNABLE -&gt; BLOCKED</code></li><li>æŒæœ‰objé”çš„çº¿ç¨‹çš„åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œä¼šå”¤é†’è¯¥å¯¹è±¡ä¸Šæ‰€æœ‰<code>BLOCKED</code>çš„çº¿ç¨‹é‡æ–°ç«äº‰ï¼Œå¦‚æœå…¶ä¸­tçº¿ç¨‹ç«äº‰æˆåŠŸï¼Œä»<code>BLOCKED -&gt; RUNNABLE</code>ï¼Œå…¶å®ƒå¤±è´¥çš„çº¿ç¨‹ä»ç„¶<code>BLOCKED</code></li></ul></li><li>RUNNABLE &lt;-&gt; TERMINATED<ul><li>å½“å‰çº¿ç¨‹æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•ï¼Œè¿›å…¥TERMINATED</li></ul></li></ol></li></ul><h3 id="å¤šæŠŠé”">å¤šæŠŠé”</h3><ul><li>ä¸€é—´å¤§å±‹å­å…·æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼šç¡è§‰å’Œå­¦ä¹ ï¼Œè¿™äºŒè€…äº’ä¸ç›¸å¹²</li><li>ç°åœ¨å°å—è¦å­¦ä¹ ã€å°å¥³è¦ç¡è§‰ï¼Œä½†æ˜¯å¦‚æœå…±ç”¨åŒä¸€é—´å±‹å­ï¼ˆä»…æœ‰ä¸€æŠŠé”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½ï¼Œå°å—å’Œå°å¥³æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚</li><li>è§£å†³åŠæ³•æ˜¯å‡†å¤‡å¤šä¸ªæˆ¿é—´ï¼ˆå³å‡†å¤‡å¤šæŠŠé”ï¼‰</li></ul><div class="tabs" id="å¤šæŠŠé”"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#å¤šæŠŠé”-1">ä¸€æŠŠé”</button></li><li class="tab"><button type="button" data-href="#å¤šæŠŠé”-2">å¤šæŠŠé”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="å¤šæŠŠé”-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestMultiLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æˆ‘æ˜¯å°å—ï¼Œæˆ‘è¦ç¡è§‰&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æˆ‘æ˜¯å°å¥³ï¼Œæˆ‘è¦å­¦ä¹ &quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;å°å¥³&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡ºç»“æœï¼Œå°å—å’Œå°å¥³çš„æ‰§è¡Œé—´éš”æ¥è¿‘1sï¼Œå› ä¸ºå°å—æ‰§è¡Œå®Œæ¯•åä¼‘çœ äº†1s</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">48</span>:<span class="number">50.180</span> c<span class="selector-class">.TestMultiLock</span> <span class="selector-attr">[å°å—]</span> - æˆ‘æ˜¯å°å—ï¼Œæˆ‘è¦ç¡è§‰</span><br><span class="line"><span class="number">16</span>:<span class="number">48</span>:<span class="number">51.184</span> c<span class="selector-class">.TestMultiLock</span> <span class="selector-attr">[å°å¥³]</span> - æˆ‘æ˜¯å°å¥³ï¼Œæˆ‘è¦å­¦ä¹ </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å¤šæŠŠé”-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestMultiLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">sleepLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">studyLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (sleepLock) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æˆ‘æ˜¯å°å—ï¼Œæˆ‘è¦ç¡è§‰&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (studyLock) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æˆ‘æ˜¯å°å¥³ï¼Œæˆ‘è¦å­¦ä¹ &quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;å°å¥³&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é‡‡ç”¨å¤šæŠŠé”çš„æ–¹å¼ï¼Œå°å—å’Œå°å¥³å‡ ä¹æ˜¯åŒæ—¶æ‰§è¡Œä»»åŠ¡ï¼Œå¢å¼ºäº†å¹¶å‘åº¦</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">50</span>:<span class="number">12.606</span> c<span class="selector-class">.TestMultiLock</span> <span class="selector-attr">[å°å—]</span> - æˆ‘æ˜¯å°å—ï¼Œæˆ‘è¦ç¡è§‰</span><br><span class="line"><span class="number">16</span>:<span class="number">50</span>:<span class="number">12.606</span> c<span class="selector-class">.TestMultiLock</span> <span class="selector-attr">[å°å¥³]</span> - æˆ‘æ˜¯å°å¥³ï¼Œæˆ‘è¦å­¦ä¹ </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>å°†é”çš„ç²’åº¦ç»†åˆ†<ul><li>å¥½å¤„ï¼šå¯ä»¥æé«˜å¹¶å‘</li><li>åå¤„ï¼šå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå®¹æ˜“å‘ç”Ÿæ­»é”</li></ul></li></ul><h3 id="æ´»è·ƒæ€§">æ´»è·ƒæ€§</h3><h4 id="æ­»é”">æ­»é”</h4><ul><li>åˆšåˆšè¯´ï¼Œä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å¤šæŠŠé”çš„æ—¶å€™ï¼Œå®¹æ˜“å‘ç”Ÿæ­»é”ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“åˆ†æä¸€ä¸‹è¿™ä¸ªåœºæ™¯<ul><li>t1çº¿ç¨‹è·å¾—Aå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å–Bå¯¹è±¡é”ã€‚</li><li>t2çº¿ç¨‹è·å¾—Bå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å¾—Aå¯¹è±¡é”ã€‚</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestDeadlock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test03</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">A</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">B</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (A) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;lock A&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (B) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;lock B&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (B) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;lock B&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (A) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;lock A&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">        log.debug(<span class="string">&quot;A:&#123;&#125;&quot;</span>, A);</span><br><span class="line">        log.debug(<span class="string">&quot;B:&#123;&#125;&quot;</span>, B);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»“æœå¦‚ä¸‹ï¼Œäº§ç”Ÿäº†æ­»é”</li></ul>  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">16</span>:<span class="number">42.469</span> c<span class="selector-class">.TestDeadlock</span> <span class="selector-attr">[main]</span> - A:java<span class="selector-class">.lang</span>.Object@<span class="number">2</span>aafb23c</span><br><span class="line"><span class="number">20</span>:<span class="number">16</span>:<span class="number">42.469</span> c<span class="selector-class">.TestDeadlock</span> <span class="selector-attr">[t2]</span> - lock B</span><br><span class="line"><span class="number">20</span>:<span class="number">16</span>:<span class="number">42.469</span> c<span class="selector-class">.TestDeadlock</span> <span class="selector-attr">[t1]</span> - lock A</span><br><span class="line"><span class="number">20</span>:<span class="number">16</span>:<span class="number">42.473</span> c<span class="selector-class">.TestDeadlock</span> <span class="selector-attr">[main]</span> - B:java<span class="selector-class">.lang</span>.Object@<span class="number">2</span>eee9593</span><br></pre></td></tr></table></figure></li></ul><h4 id="å®šä½æ­»é”">å®šä½æ­»é”</h4><ul><li>æ£€æµ‹æ­»é”å¯ä»¥ä½¿ç”¨jconsoleå·¥å…·ï¼Œæˆ–è€…ä½¿ç”¨jpså®šä½è¿›ç¨‹idï¼Œç„¶åä½¿ç”¨jstackå®šä½æ­»é”ã€‚æˆ‘è¿™é‡Œå°±ç”¨jconsoleæ¥æ£€æµ‹æ­»é”äº†<br><img src="https://s1.ax1x.com/2023/07/28/pCzqjUJ.png" alt=""><br><img src="https://s1.ax1x.com/2023/07/28/pCzLpgx.png" alt=""></li><li>ä»ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º<ul><li>çº¿ç¨‹ t1 æ­£åœ¨ç­‰å¾…è·å– java.lang.Object@2eee9593 å¯¹è±¡çš„é”ï¼Œä½†å®ƒè¢«çº¿ç¨‹ t2 æ‹¥æœ‰ï¼Œé€šè¿‡æˆ‘ä»¬çš„æ—¥å¿—è¾“å‡ºï¼Œ<code>java.lang.Object@2eee9593</code>å°±æ˜¯Bå¯¹è±¡ã€‚</li><li>çº¿ç¨‹ t2 æ­£åœ¨ç­‰å¾…è·å– java.lang.Object@2aafb23c å¯¹è±¡çš„é”ï¼Œä½†å®ƒè¢«çº¿ç¨‹ t1 æ‹¥æœ‰ï¼Œé€šè¿‡æˆ‘ä»¬çš„æ—¥å¿—è¾“å‡ºï¼Œ<code>java.lang.Object@2aafb23c</code>å°±æ˜¯Aå¯¹è±¡ã€‚</li></ul></li></ul><h4 id="å“²å­¦å®¶å°±é¤é—®é¢˜">å“²å­¦å®¶å°±é¤é—®é¢˜</h4><ul><li><p>æœ‰äº”ä½å“²å­¦å®¶ï¼Œåˆ†åˆ«æ˜¯è‹æ ¼æ‹‰åº•ã€æŸæ‹‰å›¾ã€äºšé‡Œå£«å¤šå¾·ã€èµ«æ‹‰å…‹åˆ©ç‰¹ã€é˜¿åŸºç±³å¾·ï¼Œå›´ååœ¨åœ†æ¡Œæ—</p><ul><li>ä»–ä»¬åªåšä¸¤ä»¶äº‹ï¼Œæ€è€ƒå’Œåƒé¥­ï¼Œæ€è€ƒä¸€ä¼šå„¿åƒå£é¥­ï¼Œåƒå®Œé¥­ç»§ç»­æ€è€ƒ</li><li>åƒé¥­æ—¶è¦ç”¨ä¸¤æ ¹ç­·å­åƒï¼Œæ¡Œä¸Šå…±æœ‰5æ ¹ç­·å­ï¼Œæ¯ä½å“²å­¦å®¶å·¦å³æ‰‹è¾¹å„æœ‰ä¸€æ ¹ç­·å­ã€‚</li><li>å¦‚æœç­·å­è¢«èº«è¾¹äººæ‹¿ç€ï¼Œè‡ªå·±å°±å¾—ç­‰å¾…<br><img src="https://s1.ax1x.com/2023/07/28/pCzLsIJ.png" alt=""></li></ul></li><li><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å°±æ¥æ¨¡æ‹Ÿä¸€ä¸‹è¿™ä¸ªåœºæ™¯</p></li></ul><div class="tabs" id="å“²å­¦å®¶å°±é¤"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#å“²å­¦å®¶å°±é¤-1">ç­·å­ç±»</button></li><li class="tab"><button type="button" data-href="#å“²å­¦å®¶å°±é¤-2">å“²å­¦å®¶ç±»</button></li><li class="tab"><button type="button" data-href="#å“²å­¦å®¶å°±é¤-3">å°±é¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="å“²å­¦å®¶å°±é¤-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Chopstick</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Chopstick</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Chopstick&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å“²å­¦å®¶å°±é¤-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Philosopher&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Philosopher</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    Chopstick left;</span><br><span class="line">    Chopstick right;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">        <span class="built_in">this</span>.left = left;</span><br><span class="line">        <span class="built_in">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;æˆ‘è¸é©¬åƒåƒåƒ&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// æ‹¿å·¦æ‰‹ç­·å­</span></span><br><span class="line">            <span class="keyword">synchronized</span> (left) &#123;</span><br><span class="line">                <span class="comment">// æ‹¿å³æ‰‹ç­·å­</span></span><br><span class="line">                <span class="keyword">synchronized</span> (right) &#123;</span><br><span class="line">                    eat();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ”¾ä¸‹å³æ‰‹ç­·å­</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ”¾ä¸‹å·¦æ‰‹ç­·å­</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å“²å­¦å®¶å°±é¤-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;è‹æ ¼æ‹‰åº•&quot;</span>, c1, c2).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;æŸæ‹‰å›¾&quot;</span>, c2, c3).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span>, c3, c4).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;èµ«æ‹‰å…‹åˆ©ç‰¹&quot;</span>, c4, c5).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;é˜¿åŸºç±³å¾·&quot;</span>, c5, c1).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œä¸ä¸€ä¼šå„¿ï¼Œå°±æ‰§è¡Œä¸ä¸‹å»äº†</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">03</span>:<span class="number">57.796</span> c<span class="selector-class">.Philosopher</span> <span class="selector-attr">[è‹æ ¼æ‹‰åº•]</span> - æˆ‘è¸é©¬åƒåƒåƒ</span><br><span class="line"><span class="number">21</span>:<span class="number">03</span>:<span class="number">57.796</span> c<span class="selector-class">.Philosopher</span> <span class="selector-attr">[äºšé‡Œå£«å¤šå¾·]</span> - æˆ‘è¸é©¬åƒåƒåƒ</span><br><span class="line"><span class="number">21</span>:<span class="number">03</span>:<span class="number">58.804</span> c<span class="selector-class">.Philosopher</span> <span class="selector-attr">[æŸæ‹‰å›¾]</span> - æˆ‘è¸é©¬åƒåƒåƒ</span><br><span class="line"><span class="number">21</span>:<span class="number">03</span>:<span class="number">59.804</span> c<span class="selector-class">.Philosopher</span> <span class="selector-attr">[æŸæ‹‰å›¾]</span> - æˆ‘è¸é©¬åƒåƒåƒ</span><br><span class="line"><span class="number">21</span>:<span class="number">04</span>:<span class="number">00.806</span> c<span class="selector-class">.Philosopher</span> <span class="selector-attr">[æŸæ‹‰å›¾]</span> - æˆ‘è¸é©¬åƒåƒåƒ</span><br><span class="line"><span class="number">21</span>:<span class="number">04</span>:<span class="number">01.816</span> c<span class="selector-class">.Philosopher</span> <span class="selector-attr">[è‹æ ¼æ‹‰åº•]</span> - æˆ‘è¸é©¬åƒåƒåƒ</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨jconsoleæ¥æ£€æµ‹ä¸€ä¸‹æ˜¯å¦å‘ç”Ÿäº†æ­»é”<br><img src="https://s1.ax1x.com/2023/07/28/pCzX44H.png" alt=""></li><li>ç¡®å®æ˜¯å‘ç”Ÿäº†æ­»é”</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">åç§°: é˜¿åŸºç±³å¾·</span><br><span class="line">çŠ¶æ€: com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">1</span>eadee3ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: è‹æ ¼æ‹‰åº•</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">1</span>, æ€»ç­‰å¾…æ•°: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span><span class="selector-class">.Philosopher</span><span class="selector-class">.run</span>(Philosopher<span class="selector-class">.java</span>:<span class="number">32</span>)</span><br><span class="line">   - å·²é”å®š com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">45</span>bda0d0</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">åç§°: è‹æ ¼æ‹‰åº•</span><br><span class="line">çŠ¶æ€: com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">754</span>b4f67ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: æŸæ‹‰å›¾</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">8</span>, æ€»ç­‰å¾…æ•°: <span class="number">2</span></span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span><span class="selector-class">.Philosopher</span><span class="selector-class">.run</span>(Philosopher<span class="selector-class">.java</span>:<span class="number">32</span>)</span><br><span class="line">   - å·²é”å®š com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">1</span>eadee3</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">åç§°: æŸæ‹‰å›¾</span><br><span class="line">çŠ¶æ€: com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">18</span>f3778bä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: äºšé‡Œå£«å¤šå¾·</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">3</span>, æ€»ç­‰å¾…æ•°: <span class="number">3</span></span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span><span class="selector-class">.Philosopher</span><span class="selector-class">.run</span>(Philosopher<span class="selector-class">.java</span>:<span class="number">32</span>)</span><br><span class="line">   - å·²é”å®š com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">754</span>b4f67</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">åç§°: äºšé‡Œå£«å¤šå¾·</span><br><span class="line">çŠ¶æ€: com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">68</span>d84ce6ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: èµ«æ‹‰å…‹åˆ©ç‰¹</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">7</span>, æ€»ç­‰å¾…æ•°: <span class="number">2</span></span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span><span class="selector-class">.Philosopher</span><span class="selector-class">.run</span>(Philosopher<span class="selector-class">.java</span>:<span class="number">32</span>)</span><br><span class="line">   - å·²é”å®š com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">18</span>f3778b</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">åç§°: èµ«æ‹‰å…‹åˆ©ç‰¹</span><br><span class="line">çŠ¶æ€: com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">45</span>bda0d0ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: é˜¿åŸºç±³å¾·</span><br><span class="line">æ€»é˜»æ­¢æ•°: <span class="number">2</span>, æ€»ç­‰å¾…æ•°: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span><span class="selector-class">.Philosopher</span><span class="selector-class">.run</span>(Philosopher<span class="selector-class">.java</span>:<span class="number">32</span>)</span><br><span class="line">   - å·²é”å®š com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span>.Chopstick@<span class="number">68</span>d84ce6</span><br></pre></td></tr></table></figure><ul><li>ç°åœ¨ä¸€äººæ‰‹é‡Œä¸€æ ¹ç­·å­ï¼Œéƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºï¼Œçº¿ç¨‹æ‰§è¡Œä¸ä¸‹å»äº†</li><li>è§£å†³åŠæ³•ç»§ç»­çœ‹åé¢çš„å¯é‡å…¥é”</li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="æ´»é”">æ´»é”</h4><ul><li>æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€ç»ˆè°ä¹Ÿæ— æ³•ç»“æŸï¼Œä¾‹å¦‚ç°åœ¨æœ‰ä¸€ä¸ªå˜é‡ä¸º10ï¼Œä¸€ä¸ªçº¿ç¨‹è¦å°†å…¶è‡ªå‡è‡³0æ‰ç»“æŸï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¦å°†å…¶è‡ªå¢è‡³20æ‰ç»“æŸ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestLiveLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test05</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                count--;</span><br><span class="line">                log.debug(<span class="string">&quot;countï¼š&#123;&#125;&quot;</span>, count);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (count &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                count++;</span><br><span class="line">                log.debug(<span class="string">&quot;countï¼š&#123;&#125;&quot;</span>, count);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä»ç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¸€ç›´åœ¨åƒµæŒï¼Œäº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸ</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">14</span>:<span class="number">38</span>.<span class="number">140</span> c.TestLiveLock [<span class="built_in">t2</span>] - <span class="built_in">count</span>ï¼š<span class="number">11</span></span><br><span class="line"><span class="number">21</span>:<span class="number">14</span>:<span class="number">38</span>.<span class="number">140</span> c.TestLiveLock [<span class="built_in">t1</span>] - <span class="built_in">count</span>ï¼š<span class="number">10</span></span><br><span class="line"><span class="number">21</span>:<span class="number">14</span>:<span class="number">38</span>.<span class="number">342</span> c.TestLiveLock [<span class="built_in">t1</span>] - <span class="built_in">count</span>ï¼š<span class="number">11</span></span><br><span class="line"><span class="number">21</span>:<span class="number">14</span>:<span class="number">38</span>.<span class="number">342</span> c.TestLiveLock [<span class="built_in">t2</span>] - <span class="built_in">count</span>ï¼š<span class="number">12</span></span><br><span class="line"><span class="number">21</span>:<span class="number">14</span>:<span class="number">38</span>.<span class="number">544</span> c.TestLiveLock [<span class="built_in">t1</span>] - <span class="built_in">count</span>ï¼š<span class="number">10</span></span><br><span class="line"><span class="number">21</span>:<span class="number">14</span>:<span class="number">38</span>.<span class="number">544</span> c.TestLiveLock [<span class="built_in">t2</span>] - <span class="built_in">count</span>ï¼š<span class="number">11</span></span><br><span class="line"><span class="number">21</span>:<span class="number">14</span>:<span class="number">38</span>.<span class="number">747</span> c.TestLiveLock [<span class="built_in">t2</span>] - <span class="built_in">count</span>ï¼š<span class="number">12</span></span><br></pre></td></tr></table></figure><h4 id="é¥¥é¥¿">é¥¥é¥¿</h4><ul><li>å¦‚æœä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§è¿‡ä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ°CPUè°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸã€‚</li></ul><h3 id="ReentrantLock">ReentrantLock</h3><ul><li>ç›¸è¾ƒäºsynchronizedï¼Œå¯é‡å…¥é”å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹<ol><li>å¯ä¸­æ–­</li><li>å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼šReentrantLockæä¾›äº†tryLock(long timeout, TimeUnit unit)æ–¹æ³•ï¼Œå…è®¸çº¿ç¨‹åœ¨å°è¯•è·å–é”æ—¶è®¾å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œåœ¨æŒ‡å®šçš„æ—¶é—´å†…æœªèƒ½è·å–é”ï¼Œåˆ™å¯ä»¥æ‰§è¡Œå…¶ä»–é€»è¾‘æˆ–æ”¾å¼ƒé”è¯·æ±‚ã€‚</li><li>å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”ï¼šä¿è¯å¤šä¸ªç­‰å¾…é”çš„çº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºè·å¾—é”ï¼Œé¿å…çº¿ç¨‹é¥¥é¥¿ç°è±¡ã€‚</li><li>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼šReentrantLocké€šè¿‡Conditionæ¥å£æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ã€‚ä¸€ä¸ªReentrantLockå¯¹è±¡å¯ä»¥ç»‘å®šå¤šä¸ªConditionå®ä¾‹ï¼Œæ¯ä¸ªConditionå¯¹è±¡å¯ä»¥è®©ä¸€ç»„çº¿ç¨‹ç­‰å¾…æˆ–å”¤é†’ï¼Œä»è€Œå®ç°æ›´çµæ´»çš„çº¿ç¨‹é€šä¿¡ã€‚å°±å¥½æ¯”synchronizedåªç»™ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹åªæä¾›äº†ä¸€é—´ä¼‘æ¯å®¤ï¼Œå”¤é†’æ—¶åªèƒ½notifyéšæœºå”¤é†’ä¸€ä¸ªæˆ–è€…notifyAllå”¤é†’å…¨éƒ¨ï¼Œè€ŒReentrantLockæä¾›äº†å¤šé—´ä¼‘æ¯å®¤ï¼Œå¹¶ä¸”å¯ä»¥æŒ‰ä¼‘æ¯å®¤æ¥å”¤é†’ã€‚</li></ol></li><li>åŸºæœ¬è¯­æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">reentrantLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="comment">// è·å–é”</span></span><br><span class="line">reentrantLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    reentrantLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¯é‡å…¥">å¯é‡å…¥</h4><ul><li>å¯é‡å…¥æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯é”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å¾—è¿™æŠŠé”ã€‚<ul><li>å¦‚æœæ˜¯ä¸å¯é‡å…¥é”ï¼Œç¬¬äºŒæ¬¡è·å–é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«æŒ¡ä½ã€‚</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestReentrantLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test06</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">reentrantLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        method1();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">        reentrantLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;execute method1&quot;</span>);</span><br><span class="line">            method2();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">        reentrantLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;execute method2&quot;</span>);</span><br><span class="line">            method3();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">()</span> &#123;</span><br><span class="line">        reentrantLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;execute method3&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul>  <figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">21:58:57.369 c.TestReentrantLock [main] -<span class="built_in"> execute </span>method1</span><br><span class="line">21:58:57.373 c.TestReentrantLock [main] -<span class="built_in"> execute </span>method2</span><br><span class="line">21:58:57.373 c.TestReentrantLock [main] -<span class="built_in"> execute </span>method3</span><br></pre></td></tr></table></figure></li></ul><h4 id="å¯æ‰“æ–­">å¯æ‰“æ–­</h4><ul><li>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œå…ˆè®©ä¸»çº¿ç¨‹è·å–é”ï¼Œç„¶åå¯åŠ¨t1çº¿ç¨‹ï¼Œt1çº¿ç¨‹å†…ä¹Ÿå°è¯•è·å–é”ï¼Œä½†ç”±äºæ­¤æ—¶é”çš„æŒæœ‰è€…æ˜¯ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥t1çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…ï¼Œç„¶åä¸»çº¿ç¨‹æ‰§è¡Œæ‰“æ–­</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestInterrupt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test07</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ReentrantLock</span> <span class="variable">reentrantLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¯åŠ¨&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                reentrantLock.lockInterruptibly();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                log.debug(<span class="string">&quot;ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­äº†&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                reentrantLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        reentrantLock.lock();</span><br><span class="line">        log.debug(<span class="string">&quot;è·å¾—äº†é”&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            t1.interrupt();</span><br><span class="line">            log.debug(<span class="string">&quot;æ‰§è¡Œæ‰“æ–­&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">13</span>:<span class="number">13.081</span> c<span class="selector-class">.TestInterrupt</span> <span class="selector-attr">[main]</span> - è·å¾—äº†é”</span><br><span class="line"><span class="number">10</span>:<span class="number">13</span>:<span class="number">13.089</span> c<span class="selector-class">.TestInterrupt</span> <span class="selector-attr">[t1]</span> - å¯åŠ¨</span><br><span class="line"><span class="number">10</span>:<span class="number">13</span>:<span class="number">14.089</span> c<span class="selector-class">.TestInterrupt</span> <span class="selector-attr">[main]</span> - æ‰§è¡Œæ‰“æ–­</span><br><span class="line"><span class="number">10</span>:<span class="number">13</span>:<span class="number">14.090</span> c<span class="selector-class">.TestInterrupt</span> <span class="selector-attr">[t1]</span> - ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­äº†</span><br><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.InterruptedException</span></span><br><span class="line">at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.AbstractQueuedSynchronizer</span><span class="selector-class">.doAcquireInterruptibly</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">898</span>)</span><br><span class="line">at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.AbstractQueuedSynchronizer</span><span class="selector-class">.acquireInterruptibly</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">1222</span>)</span><br><span class="line">at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.ReentrantLock</span><span class="selector-class">.lockInterruptibly</span>(ReentrantLock<span class="selector-class">.java</span>:<span class="number">335</span>)</span><br><span class="line">at com<span class="selector-class">.cyborg2077</span><span class="selector-class">.demo03</span><span class="selector-class">.Test07</span>.lambda<span class="variable">$main</span>$<span class="number">0</span>(Test07<span class="selector-class">.java</span>:<span class="number">15</span>)</span><br><span class="line">at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">750</span>)</span><br></pre></td></tr></table></figure><h4 id="é”è¶…æ—¶">é”è¶…æ—¶</h4><div class="tabs" id="é”è¶…æ—¶"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#é”è¶…æ—¶-1">ç«‹åˆ»å¤±è´¥</button></li><li class="tab"><button type="button" data-href="#é”è¶…æ—¶-2">è¶…æ—¶å¤±è´¥</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="é”è¶…æ—¶-1"><ul><li>ç«‹åˆ»å¤±è´¥</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestTryLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test08</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ReentrantLock</span> <span class="variable">reentrantLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¯åŠ¨&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!reentrantLock.tryLock()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œç«‹åˆ»è¿”å›&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;è·å–äº†é”&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;é‡Šæ”¾äº†é”&quot;</span>);</span><br><span class="line">                reentrantLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        reentrantLock.lock();</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–äº†é”&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é‡Šæ”¾äº†é”&quot;</span>);</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">31</span>:<span class="number">14.310</span> c<span class="selector-class">.TestTryLock</span> <span class="selector-attr">[main]</span> - è·å–äº†é”</span><br><span class="line"><span class="number">10</span>:<span class="number">31</span>:<span class="number">14.313</span> c<span class="selector-class">.TestTryLock</span> <span class="selector-attr">[t1]</span> - å¯åŠ¨</span><br><span class="line"><span class="number">10</span>:<span class="number">31</span>:<span class="number">14.313</span> c<span class="selector-class">.TestTryLock</span> <span class="selector-attr">[t1]</span> - è·å–é”å¤±è´¥ï¼Œç«‹åˆ»è¿”å›</span><br><span class="line"><span class="number">10</span>:<span class="number">31</span>:<span class="number">16.313</span> c<span class="selector-class">.TestTryLock</span> <span class="selector-attr">[main]</span> - é‡Šæ”¾äº†é”</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="é”è¶…æ—¶-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestTryLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test08</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ReentrantLock</span> <span class="variable">reentrantLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å¯åŠ¨&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!reentrantLock.tryLock(<span class="number">3</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;ç­‰å¾…1såè·å–å¤±è´¥ï¼Œè¿”å›&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;è·å–äº†é”&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;é‡Šæ”¾äº†é”&quot;</span>);</span><br><span class="line">                reentrantLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        reentrantLock.lock();</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–äº†é”&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é‡Šæ”¾äº†é”&quot;</span>);</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">30</span>:<span class="number">09.663</span> c<span class="selector-class">.TestTryLock</span> <span class="selector-attr">[main]</span> - è·å–äº†é”</span><br><span class="line"><span class="number">10</span>:<span class="number">30</span>:<span class="number">09.666</span> c<span class="selector-class">.TestTryLock</span> <span class="selector-attr">[t1]</span> - å¯åŠ¨</span><br><span class="line"><span class="number">10</span>:<span class="number">30</span>:<span class="number">10.667</span> c<span class="selector-class">.TestTryLock</span> <span class="selector-attr">[t1]</span> - è·å–ç­‰å¾…<span class="number">1s</span>åå¤±è´¥ï¼Œè¿”å›</span><br><span class="line"><span class="number">10</span>:<span class="number">30</span>:<span class="number">11.667</span> c<span class="selector-class">.TestTryLock</span> <span class="selector-attr">[main]</span> - é‡Šæ”¾äº†é”</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜">è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜</h4><ul><li>å“²å­¦å®¶å°±é¤ä¹‹æ‰€ä»¥ä¼šå‡ºç°æ­»é”ï¼Œæ˜¯å› ä¸ºä¸€äººæ‰‹é‡Œä¸€æ ¹ç­·å­ï¼Œéƒ½åœ¨ç­‰åˆ«äººæ”¾ä¸‹ç­·å­ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨åˆšåˆšçš„tryLockæ¥è®¾ç½®ä¸€ä¸ªç­‰å¾…æ—¶é—´ï¼Œåˆ°æ—¶è‡ªåŠ¨æ”¾ä¸‹ç­·å­å°±å¥½äº†</li></ul><div class="tabs" id="è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜-1">ç­·å­ç±»</button></li><li class="tab"><button type="button" data-href="#è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜-2">å“²å­¦å®¶ç±»</button></li><li class="tab"><button type="button" data-href="#è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜-3">å°±é¤</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜-1"><ul><li>ä¿®æ”¹ä¹‹å‰çš„ä»£ç ï¼Œè®©ç­·å­ç±»ç»§æ‰¿ReentrantLock</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Chopstick</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Chopstick</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Chopstick&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Philosopher&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Philosopher</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    Chopstick left;</span><br><span class="line">    Chopstick right;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">        <span class="built_in">this</span>.left = left;</span><br><span class="line">        <span class="built_in">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;æˆ‘è¸é©¬åƒåƒåƒ&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// å°è¯•è·å–å·¦æ‰‹ç­·å­</span></span><br><span class="line">            <span class="keyword">if</span> (left.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// å°è¯•è·å–å³æ‰‹ç­·å­</span></span><br><span class="line">                    <span class="keyword">if</span> (right.tryLock()) &#123;</span><br><span class="line">                        <span class="comment">// åƒå®Œå…ˆæ”¾ä¸‹ å³æ‰‹ç­·å­</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            eat();</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            right.unlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="comment">// æ²¡æ‹¿åˆ°å³æ‰‹ç­·å­æˆ–è€…åƒå®Œäº†ï¼ŒæŠŠå·¦æ‰‹ç­·å­ä¹Ÿæ”¾äº†</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    left.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜-3"><ul><li>æ­¤ç±»ä¸éœ€è¦åšä¿®æ”¹ï¼Œç°åœ¨å†æ‰§è¡Œï¼Œäº”ä½å“²å­¦å®¶å°±å¯ä»¥æ­£å¸¸åƒé¥­äº†ï¼Œä¸ä¼šå‘ç”Ÿæ­»é”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;è‹æ ¼æ‹‰åº•&quot;</span>, c1, c2).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;æŸæ‹‰å›¾&quot;</span>, c2, c3).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span>, c3, c4).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;èµ«æ‹‰å…‹åˆ©ç‰¹&quot;</span>, c4, c5).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;é˜¿åŸºç±³å¾·&quot;</span>, c5, c1).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h4 id="æ¡ä»¶å˜é‡">æ¡ä»¶å˜é‡</h4><ul><li><p>ReentrantLockæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œå°±å¥½æ¯”</p><ul><li>synchronizedæ˜¯é‚£äº›ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹éƒ½åœ¨åŒä¸€é—´ä¼‘æ¯å®¤ç­‰æ¶ˆæ¯</li><li>ReentrantLockæ”¯æŒå¤šé—´ä¼‘æ¯å®¤ï¼Œæœ‰ä¸“é—¨ç­‰çƒŸçš„ä¼‘æ¯å®¤ã€ä¸“é—¨ç­‰å¤–å–çš„ä¼‘æ¯å®¤ã€å”¤é†’æ—¶ä¹Ÿæ˜¯æŒ‰ä¼‘æ¯å®¤æ¥å”¤é†’</li></ul></li><li><p>ä½¿ç”¨è¦ç‚¹</p><ol><li>awaitå‰éœ€è¦è·å¾—é”</li><li>awaitæ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥conditionObjectç­‰å¾…</li><li>awaitçš„çº¿ç¨‹å¯ä»¥é€šè¿‡conditionObjectçš„signal()æ–¹æ³•æ¥è¢«å”¤é†’å»é‡æ–°ç«äº‰locké”ï¼Œawaitçš„æ–¹æ³•è¢«æ‰“æ–­æˆ–è€…è¶…æ—¶çš„æ—¶å€™ï¼Œä¹Ÿä¼šå»é‡æ–°ç«äº‰locké”</li><li>ç«äº‰locké”æˆåŠŸåï¼Œä»awaitåç»§ç»­æ‰§è¡Œ</li></ol></li><li><p>ä¾‹å­</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestCondition&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test09</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Condition</span> <span class="variable">waitCigaretteQueue</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Condition</span> <span class="variable">waitTakeoutQueue</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">while</span> (!hasCigarette) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        waitCigaretteQueue.await();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ‹¿åˆ°äº†çƒŸ&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">while</span> (!hasTakeout) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        waitTakeoutQueue.await();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;æ‹¿åˆ°äº†å¤–å–&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å¥³&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        sendCigarette();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        sendTakeout();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendCigarette</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é€çƒŸçš„æ¥äº†&quot;</span>);</span><br><span class="line">            hasCigarette = <span class="literal">true</span>;</span><br><span class="line">            waitCigaretteQueue.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendTakeout</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é€å¤–å–çš„æ¥äº†&quot;</span>);</span><br><span class="line">            hasTakeout = <span class="literal">true</span>;</span><br><span class="line">            waitTakeoutQueue.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">58</span>:<span class="number">19.515</span> c<span class="selector-class">.TestCondition</span> <span class="selector-attr">[main]</span> - é€çƒŸçš„æ¥äº†</span><br><span class="line"><span class="number">11</span>:<span class="number">58</span>:<span class="number">19.518</span> c<span class="selector-class">.TestCondition</span> <span class="selector-attr">[å°å—]</span> - æ‹¿åˆ°äº†çƒŸ</span><br><span class="line"><span class="number">11</span>:<span class="number">58</span>:<span class="number">20.519</span> c<span class="selector-class">.TestCondition</span> <span class="selector-attr">[main]</span> - é€å¤–å–çš„æ¥äº†</span><br><span class="line"><span class="number">11</span>:<span class="number">58</span>:<span class="number">20.519</span> c<span class="selector-class">.TestCondition</span> <span class="selector-attr">[å°å¥³]</span> - æ‹¿åˆ°äº†å¤–å–</span><br></pre></td></tr></table></figure><h3 id="åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶">åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</h3><h4 id="å›ºå®šè¿è¡Œé¡ºåº">å›ºå®šè¿è¡Œé¡ºåº</h4><ul><li>ä¾‹å¦‚å¿…é¡»å…ˆæ‰§è¡Œçº¿ç¨‹2å†æ‰§è¡Œçº¿ç¨‹1<ul><li>ä½¿ç”¨<code>wait notify</code>æ¥è§£å†³ï¼Œä½¿ç”¨æ­¤ç§å‡¡äº‹ï¼Œéœ€ä¿è¯å…ˆwaitå†notifyï¼Œå¦åˆ™waitçº¿ç¨‹æ°¸è¿œå¾—ä¸åˆ°å”¤é†’ã€‚å› æ­¤éœ€è¦è®¾ç«‹äº†ä¸€ä¸ªisT2Ranå­—æ®µæ¥åˆ¤æ–­è¯¥ä¸è¯¥waitã€‚</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.WaitNotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">isT2Ran</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœt2æ²¡æœ‰æ‰§è¡Œè¿‡</span></span><br><span class="line">                <span class="keyword">while</span> (!isT2Ran) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// é‚£ä¹ˆt1ç­‰å¾…</span></span><br><span class="line">                        obj.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                <span class="comment">// t2æ‰§è¡Œçš„æ—¶å€™ä¿®æ”¹æ ‡è®°</span></span><br><span class="line">                isT2Ran = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// å¹¶ä¸”å”¤é†’ç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line">                obj.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥ä½¿ç”¨parkå’Œunparkæ¥è§£å†³ï¼Œä»£ç æ›´ä¸ºç®€æ´ï¼Œè¿™é‡Œçš„unparkçš„ä½œç”¨äºè®¾ç«‹çš„isT2Rançš„ä½œç”¨ç±»ä¼¼ï¼Œéƒ½å¯ä»¥èµ·åˆ°é€šçŸ¥t1çº¿ç¨‹ï¼Œt2çº¿ç¨‹å·²ç»æ‰§è¡Œè¿‡äº†çš„ä½œç”¨ã€‚ä½¿ç”¨æ­¤ç§æ–¹å¼æ›´ä¸ºçµæ´»ï¼Œæ— è®ºt1çº¿ç¨‹å’Œt2çº¿ç¨‹çš„è°ƒç”¨é¡ºåºå¦‚ä½•ï¼Œéƒ½æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æš‚åœå’Œæ¢å¤ï¼Œä¸éœ€è¦åŒæ­¥å¯¹è±¡(obj)å’Œè¿è¡Œæ ‡è®°(isT2Ran)</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.ParkUnpark&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// å½“t1çº¿ç¨‹æ²¡æœ‰è®¸å¯çš„æ—¶å€™ï¼Œt1çº¿ç¨‹ä¼šæš‚åœï¼Œæœ‰è®¸å¯çš„æ—¶å€™ï¼Œç”¨æ‰è¿™ä¸ªè®¸å¯ï¼Œæ¢å¤å½“å‰çº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// ç»™t1çº¿ç¨‹å‘æ”¾è®¸å¯</span></span><br><span class="line">            LockSupport.unpark(t1);</span><br><span class="line">            log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="äº¤æ›¿è¾“å‡º">äº¤æ›¿è¾“å‡º</h4><ul><li>t1è¾“å‡ºaäº”æ¬¡ï¼Œt2è¾“å‡ºbäº”æ¬¡ï¼Œt3è¾“å‡ºcäº”æ¬¡<ul><li>ä½¿ç”¨<code>wait notify</code>æ¥è§£å†³</li></ul>  <div class="tabs" id="äº¤æ›¿è¾“å‡º"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#äº¤æ›¿è¾“å‡º-1">SyncWaitNotify</button></li><li class="tab"><button type="button" data-href="#äº¤æ›¿è¾“å‡º-2">æµ‹è¯•ç±»</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="äº¤æ›¿è¾“å‡º-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¾“å‡ºå†…å®¹     ç­‰å¾…æ ‡è®°        ä¸‹ä¸€ä¸ªæ ‡è®°</span></span><br><span class="line"><span class="comment"> *   a          1               2</span></span><br><span class="line"><span class="comment"> *   b          2               3</span></span><br><span class="line"><span class="comment"> *   c          3               1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.SyncWaitNotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncWaitNotify</span> &#123;</span><br><span class="line">    <span class="comment">// ç­‰å¾…æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> flag;</span><br><span class="line">    <span class="comment">// å¾ªç¯æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> loopNum;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SyncWaitNotify</span><span class="params">(<span class="type">int</span> flag, <span class="type">int</span> loopNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.flag = flag;</span><br><span class="line">        <span class="built_in">this</span>.loopNum = loopNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str       è¾“å‡ºå†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waitFlag  ç­‰å¾…æ ‡è®°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nextFlag  ä¸‹ä¸€ä¸ªæ ‡è®°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str, <span class="type">int</span> waitFlag, <span class="type">int</span> nextFlag)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNum; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (flag != waitFlag) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(str);</span><br><span class="line">                flag = nextFlag;</span><br><span class="line">                <span class="built_in">this</span>.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="äº¤æ›¿è¾“å‡º-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test03</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SyncWaitNotify</span> <span class="variable">syncWaitNotify</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyncWaitNotify</span>(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            syncWaitNotify.print(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            syncWaitNotify.print(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            syncWaitNotify.print(<span class="string">&quot;c&quot;</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t3&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.373</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t1]</span> - <span class="selector-tag">a</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t2]</span> - <span class="selector-tag">b</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t3]</span> - c</span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t1]</span> - <span class="selector-tag">a</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t2]</span> - <span class="selector-tag">b</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t3]</span> - c</span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t1]</span> - <span class="selector-tag">a</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t2]</span> - <span class="selector-tag">b</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t3]</span> - c</span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t1]</span> - <span class="selector-tag">a</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t2]</span> - <span class="selector-tag">b</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t3]</span> - c</span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t1]</span> - <span class="selector-tag">a</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t2]</span> - <span class="selector-tag">b</span></span><br><span class="line"><span class="number">17</span>:<span class="number">50</span>:<span class="number">51.376</span> c<span class="selector-class">.SyncWaitNotify</span> <span class="selector-attr">[t3]</span> - c</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><ul><li>ä½¿ç”¨awaitå’Œsignalæ¥è§£å†³</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncAwaitSignal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AwaitSignal</span> <span class="variable">awaitSignal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AwaitSignal</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">a</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">b</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">c</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(<span class="string">&quot;a&quot;</span>, a, b);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(<span class="string">&quot;b&quot;</span>, b, c);</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(<span class="string">&quot;c&quot;</span>, c, a);</span><br><span class="line">        &#125;, <span class="string">&quot;t3&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        awaitSignal.start(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.AwaitSignal&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AwaitSignal</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> loopNum;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AwaitSignal</span><span class="params">(<span class="type">int</span> loopNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loopNum = loopNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str, Condition current, Condition next)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNum; i++) &#123;</span><br><span class="line">            <span class="built_in">this</span>.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ¯ä¸ªçº¿ç¨‹éƒ½å…ˆè¿›è‡ªå·±çš„ä¼‘æ¯å®¤ç­‰å¾…</span></span><br><span class="line">                current.await();</span><br><span class="line">                log.debug(str);</span><br><span class="line">                <span class="comment">// å«é†’ä¸‹ä¸€ä¸ª</span></span><br><span class="line">                next.signal();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(Condition condition)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            condition.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨Parkå’ŒUnparkæ¥è§£å†³</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncParkUnpark</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Thread t1;</span><br><span class="line">    <span class="keyword">static</span> Thread t2;</span><br><span class="line">    <span class="keyword">static</span> Thread t3;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ParkUnpark</span> <span class="variable">parkUnpark</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParkUnpark</span>(<span class="number">5</span>);</span><br><span class="line">        t1 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            parkUnpark.print(<span class="string">&quot;a&quot;</span>, t2);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t2 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            parkUnpark.print(<span class="string">&quot;b&quot;</span>, t3);</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t3 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            parkUnpark.print(<span class="string">&quot;c&quot;</span>, t1);</span><br><span class="line">        &#125;, <span class="string">&quot;t3&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line"></span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.ParkUnpark&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParkUnpark</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> loopNum;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ParkUnpark</span><span class="params">(<span class="type">int</span> loopNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loopNum = loopNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str, Thread next)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNum; i++) &#123;</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(str);</span><br><span class="line">            LockSupport.unpark(next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="å°ç»“-2">å°ç»“</h3><ul><li>é€šè¿‡ä¸Šé¢çš„å­¦ä¹ ï¼Œéœ€è¦æŒæ¡çš„æ˜¯<ul><li>åˆ†æå¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå“ªäº›ä»£ç ç‰‡æ®µå±äºä¸´ç•ŒåŒº</li><li>ä½¿ç”¨synchronizedäº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜<ul><li>æŒæ¡synchronizedé”å¯¹è±¡æ–¹æ³•</li><li>æŒæ¡synchronizedåŠ è½½æˆå‘˜æ–¹æ³•å’Œé™æ€æ–¹æ³•è¯­æ³•</li><li>æŒæ¡wait/notifyåŒæ­¥æ–¹æ³•</li></ul></li><li>ä½¿ç”¨lockäº’æ–¥é”è§£å†³ä¸´ç•ŒåŒºçº¿ç¨‹å®‰å…¨é—®é¢˜<ul><li>æŒæ¡lockä½¿ç”¨ç»†èŠ‚ï¼šå¯æ‰“æ–­ã€é”è¶…æ—¶ã€å…¬å¹³é”ã€æ¡ä»¶å˜é‡</li></ul></li><li>å­¦ä¼šåˆ†æå˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§ã€å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»çš„ä½¿ç”¨</li><li>äº†è§£çº¿ç¨‹æ´»è·ƒæ€§é—®é¢˜ï¼šæ­»é”ã€æ´»é”ã€é¥¥é¥¿</li><li>åº”ç”¨æ–¹é¢<ul><li>äº’æ–¥ï¼šä½¿ç”¨synchronizedæˆ–Lockè¾¾åˆ°å…±äº«èµ„æºäº’æ–¥æ•ˆæœ</li><li>åŒæ­¥ï¼šä½¿ç”¨wait/notifyæˆ–Lockçš„æ¡ä»¶å˜é‡è¾¾åˆ°çº¿ç¨‹é—´é€šä¿¡æ•ˆæœ</li></ul></li><li>åŸç†æ–¹é¢<ul><li>monitorã€synchronizedã€wait/notifyåŸç†</li><li>synchronizedè¿›é˜¶åŸç†</li><li>park/unparkåŸç†</li></ul></li><li>æ¨¡å¼æ–¹é¢<ul><li>åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</li><li>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…</li><li>åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</li></ul></li></ul></li></ul><h2 id="å…±äº«æ¨¡å‹ä¹‹å†…å­˜">å…±äº«æ¨¡å‹ä¹‹å†…å­˜</h2><ul><li>ä¸Šä¸€å°èŠ‚ä¸»è¦è®²è§£çš„Monitorä¸»è¦å…³æ³¨çš„æ˜¯è®¿é—®å…±äº«å˜é‡æ—¶ï¼Œä¿è¯ä¸´ç•ŒåŒºä»£ç çš„åŸå­æ€§</li><li>åœ¨è¿™ä¸€å°èŠ‚æˆ‘ä»¬æ¥è¿›ä¸€æ­¥æ·±å…¥å­¦ä¹ å…±äº«å˜é‡åœ¨å¤šçº¿ç¨‹é—´çš„<code>å¯è§æ€§é—®é¢˜</code>å’Œå‘½ä»¤æ‰§è¡Œæ—¶çš„<code>æœ‰åºæ€§é—®é¢˜</code></li></ul><h3 id="Javaå†…å­˜æ¨¡å‹">Javaå†…å­˜æ¨¡å‹</h3><ul><li>JMMå³Java Memory Modelï¼Œå®ƒå®šä¹‰äº†ä¸»å­˜ã€å·¥ä½œå†…å­˜æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€CPUå¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€CPUæŒ‡ä»¤ä¼˜åŒ–ç­‰ã€‚</li><li>JMM ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢<ol><li>åŸå­æ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šæ”¶åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“</li><li>å¯è§æ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—CPUç¼“å­˜çš„å½±å“</li><li>æœ‰åºæ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—CPUæŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“</li></ol></li></ul><h3 id="å¯è§æ€§">å¯è§æ€§</h3><h4 id="é€€ä¸å‡ºçš„å¾ªç¯">é€€ä¸å‡ºçš„å¾ªç¯</h4><ul><li>å…ˆæ¥çœ‹ä¸€ä¸ªç°è±¡ï¼Œmainçº¿ç¨‹å¯¹runå˜é‡çš„ä¿®æ”¹å¯¹äºtçº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´tçº¿ç¨‹æ— æ³•åœæ­¢ï¼Œæ—¥å¿—è¿Ÿè¿Ÿæ²¡æœ‰æ‰“å°ç»“æŸ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestRun&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (flag) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;ç»“æŸ&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        log.debug(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§çŠ¶å†µå‘¢ï¼Ÿæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹<ol><li>åˆå§‹çŠ¶æ€ï¼štçº¿ç¨‹åˆšå¼€å§‹ï¼Œä»ä¸»å­˜ä¸­è¯»å–flagåˆ°å·¥ä½œå†…å­˜<br><img src="https://s1.ax1x.com/2023/04/11/ppOC3MF.png" alt=""></li><li>å› ä¸ºtçº¿ç¨‹è¦é¢‘ç¹åœ°ä»ä¸»å­˜ä¸­è¯»å–flagçš„å€¼ï¼Œæ‰€ä»¥JITç¼–è¯‘å™¨ä¼šå°†runçš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­flagçš„è®¿é—®ï¼Œæé«˜æ•ˆç‡<br><img src="https://s1.ax1x.com/2023/04/11/ppOCtaR.png" alt=""></li><li>1såï¼Œä¸»çº¿ç¨‹ä¿®æ”¹äº†flagçš„å€¼ä¸ºfalseï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œtçº¿ç¨‹åˆ™æ˜¯ç»§ç»­ä»è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­è¯»å–çš„flagçš„å€¼ï¼Œå§‹ç»ˆä¸ºæ—§å€¼<br><img src="https://s1.ax1x.com/2023/04/11/ppOCaPx.png" alt=""></li></ol>  <div class="note info no-icon flat"><ul><li>ä¸»å­˜å°±æ˜¯æ‰€æœ‰å…±äº«ä¿¡æ¯å­˜å‚¨çš„ä½ç½®ï¼Œå·¥ä½œå†…å­˜æ˜¯æ¯ä¸ªçº¿ç¨‹ç§æœ‰ä¿¡æ¯å­˜å‚¨çš„ä½ç½®</li></ul></div></li></ul><h4 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</h4><ul><li>volatile(æ˜“å˜å…³é”®å­—)ï¼šå®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œé¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œvolatileå˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (flag) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;ç»“æŸ&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        log.debug(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¯è§æ€§-vs-åŸå­æ€§">å¯è§æ€§ vs åŸå­æ€§</h3><ul><li>å‰é¢çš„ä¾‹å­ä½“ç°çš„å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹volatileå˜é‡çš„ä¿®æ”¹æ˜¯å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§çš„ï¼Œä½†ä¸ä¿è¯åŸå­æ€§ï¼Œä»…ç”¨äºåœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹çš„æƒ…å†µï¼Œä»å­—èŠ‚ç çš„è§’åº¦çœ‹æ˜¯è¿™æ ·çš„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getstatic flag <span class="comment">// çº¿ç¨‹ t è·å– flag true</span></span><br><span class="line">getstatic flag <span class="comment">// çº¿ç¨‹ t è·å– flag true</span></span><br><span class="line">getstatic flag <span class="comment">// çº¿ç¨‹ t è·å– flag true</span></span><br><span class="line">getstatic flag <span class="comment">// çº¿ç¨‹ t è·å– flag true</span></span><br><span class="line">putstatic flag <span class="comment">// çº¿ç¨‹ main ä¿®æ”¹ flag ä¸º false</span></span><br><span class="line">getstatic flag <span class="comment">// çº¿ç¨‹ t è·å– flag false</span></span><br></pre></td></tr></table></figure><ul><li>å¯¹æ¯”ä¸€ä¸‹ä¹‹å‰è®²çº¿ç¨‹å®‰å…¨æ—¶çš„ä¾‹å­ï¼Œä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªè¿›è¡Œè‡ªå¢ï¼Œä¸€ä¸ªè¿›è¡Œè‡ªå‡ï¼Œåªèƒ½ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ï¼Œä½†ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾içš„åˆå§‹å€¼ä¸º0</span></span><br><span class="line">getstatic i         <span class="comment">// çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0</span></span><br><span class="line">getstatic i         <span class="comment">// çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0</span></span><br><span class="line">iconst_1            <span class="comment">// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">iadd                <span class="comment">// çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1</span></span><br><span class="line">putstatic i         <span class="comment">// çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1</span></span><br><span class="line">iconst_1            <span class="comment">// çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">isub                <span class="comment">// çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1</span></span><br><span class="line">putstatic i         <span class="comment">// çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1</span></span><br></pre></td></tr></table></figure><ul><li>ä½†æ˜¯synchronizedä»£ç å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„åŸå­æ€§ï¼Œåˆå¯ä»¥ä¿è¯ä»£ç å—å†…å˜é‡çš„å¯è§æ€§ã€‚ä½†æ˜¯ç¼ºç‚¹æ˜¯synchronizedæ˜¯å±äºé‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒä½ã€‚</li></ul><h3 id="ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼-volatile">ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼-volatile</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TestTPTVolatile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">TPTVolatile</span> <span class="variable">tpt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TPTVolatile</span>();</span><br><span class="line">        tpt.start();</span><br><span class="line">        Thread.sleep(<span class="number">3500</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;åœæ­¢ç›‘æ§&quot;</span>);</span><br><span class="line">        tpt.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.TPTVolatile&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TPTVolatile</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Thread thread;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        thread = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ–™ç†åäº‹&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;æ‰§è¡Œç›‘æ§è®°å½•&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;ç›‘æ§çº¿ç¨‹&quot;</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        flag = <span class="literal">true</span>;</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">06</span>:<span class="number">40.611</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ‰§è¡Œç›‘æ§è®°å½•</span><br><span class="line"><span class="number">13</span>:<span class="number">06</span>:<span class="number">41.614</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ‰§è¡Œç›‘æ§è®°å½•</span><br><span class="line"><span class="number">13</span>:<span class="number">06</span>:<span class="number">42.616</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ‰§è¡Œç›‘æ§è®°å½•</span><br><span class="line"><span class="number">13</span>:<span class="number">06</span>:<span class="number">43.113</span> c<span class="selector-class">.TestTPTVolatile</span> <span class="selector-attr">[main]</span> - åœæ­¢ç›‘æ§</span><br><span class="line"><span class="number">13</span>:<span class="number">06</span>:<span class="number">43.113</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ–™ç†åäº‹</span><br></pre></td></tr></table></figure><h3 id="çŠ¹è±«æ¨¡å¼">çŠ¹è±«æ¨¡å¼</h3><h4 id="å®šä¹‰-2">å®šä¹‰</h4><ul><li>Balkingï¼ˆçŠ¹è±«ï¼‰æ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åšäº†ï¼Œç›´æ¥ç»“æŸè¿”å›</li></ul><h4 id="å®ç°-2">å®ç°</h4><ul><li>å…¶å®å®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªå­—æ®µæ¥æ ‡è¯†è¿™ä»¶äº‹å·²ç»æœ‰äººåšäº†ï¼Œç»§ç»­æ‹¿ä¸Šé¢çš„ç›‘æ§çº¿ç¨‹ä¸¾ä¾‹</li></ul><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j(topic = &quot;c.TestTPTVolatile&quot;)</span><br><span class="line">public class Test02 &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        TPTVolatile tpt = new TPTVolatile();</span><br><span class="line">        tpt.start();</span><br><span class="line"><span class="addition">+       tpt.start();</span></span><br><span class="line">        Thread.sleep(3500);</span><br><span class="line">        log.debug(&quot;åœæ­¢ç›‘æ§&quot;);</span><br><span class="line">        tpt.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Slf4j(topic = &quot;c.TPTVolatile&quot;)</span><br><span class="line">class TPTVolatile &#123;</span><br><span class="line">    private Thread thread;</span><br><span class="line"></span><br><span class="line">    private volatile boolean flag = false;</span><br><span class="line"></span><br><span class="line"><span class="addition">+   private boolean starting = false;</span></span><br><span class="line"></span><br><span class="line">    public void start() &#123;</span><br><span class="line"><span class="addition">+       if (starting) &#123;</span></span><br><span class="line"><span class="addition">+           log.debug(&quot;ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨ï¼Œç›´æ¥ç»“æŸè¿”å›&quot;);</span></span><br><span class="line"><span class="addition">+           return;</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line">        log.debug(&quot;å¯åŠ¨ç›‘æ§çº¿ç¨‹&quot;);</span><br><span class="line"><span class="addition">+       starting = true;</span></span><br><span class="line">        thread = new Thread(() -&gt; &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                if (flag) &#123;</span><br><span class="line">                    log.debug(&quot;æ–™ç†åäº‹&quot;);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                    log.debug(&quot;æ‰§è¡Œç›‘æ§è®°å½•&quot;);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, &quot;ç›‘æ§çº¿ç¨‹&quot;);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void stop() &#123;</span><br><span class="line">        flag = true;</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡º</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">26</span>:<span class="number">59.682</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[main]</span> - å¯åŠ¨ç›‘æ§çº¿ç¨‹</span><br><span class="line"><span class="number">16</span>:<span class="number">26</span>:<span class="number">59.730</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[main]</span> - ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨ï¼Œç›´æ¥ç»“æŸè¿”å›</span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">00.731</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ‰§è¡Œç›‘æ§è®°å½•</span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">01.732</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ‰§è¡Œç›‘æ§è®°å½•</span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">02.736</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ‰§è¡Œç›‘æ§è®°å½•</span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">03.231</span> c<span class="selector-class">.TestTPTVolatile</span> <span class="selector-attr">[main]</span> - åœæ­¢ç›‘æ§</span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">03.231</span> c<span class="selector-class">.TPTVolatile</span> <span class="selector-attr">[ç›‘æ§çº¿ç¨‹]</span> - æ–™ç†åäº‹</span><br></pre></td></tr></table></figure><ul><li>å®ƒè¿˜ç»å¸¸ç”¨æ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ·±å…¥å¹¶å‘ç¼–ç¨‹ï¼Œå®ç°é«˜æ•ˆå¤šä»»åŠ¡å¤„ç†</summary>
    
    
    
    <category term="å­¦ä¹ ç¬”è®°" scheme="https://cyborg2077.github.io/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="JUC" scheme="https://cyborg2077.github.io/tags/JUC/"/>
    
  </entry>
  
  <entry>
    <title>Leetcode75</title>
    <link href="https://cyborg2077.github.io/2023/06/03/Leetcode75/"/>
    <id>https://cyborg2077.github.io/2023/06/03/Leetcode75/</id>
    <published>2023-06-03T06:27:09.000Z</published>
    <updated>2023-10-01T13:43:47.753Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†™åœ¨æœ€å‰">å†™åœ¨æœ€å‰</h2><ul><li>åŠ›æ‰£å®˜æ–¹çš„å­¦ä¹ è®¡åˆ’ï¼Œé“¾æ¥ï¼š<a href="https://leetcode.cn/studyplan/leetcode-75/">https://leetcode.cn/studyplan/leetcode-75/</a></li></ul><h2 id="æ•°ç»„-å­—ç¬¦ä¸²">æ•°ç»„ / å­—ç¬¦ä¸²</h2><h3 id="äº¤æ›¿åˆå¹¶å­—ç¬¦ä¸²"><a href="https://leetcode.cn/problems/merge-strings-alternately/">äº¤æ›¿åˆå¹¶å­—ç¬¦ä¸²</a></h3><ul><li>æ–¹å¼ä¸€ï¼šäº¤æ›¿æ·»åŠ å­—ç¬¦ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªå­—ç¬¦ä¸²æ¯”å¦ä¸€ä¸ªé•¿ï¼Œä¼šå°†å¤šä½™çš„å­—ç¬¦è¿½åŠ åˆ°åˆå¹¶åå­—ç¬¦ä¸²çš„æœ«å°¾ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">mergeAlternately</span><span class="params">(String word1, String word2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l1</span> <span class="operator">=</span> word1.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">l2</span> <span class="operator">=</span> word2.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">minLen</span> <span class="operator">=</span> Math.min(l1, l2);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; minLen; i++) &#123;</span><br><span class="line">            sb.append(word1.charAt(i));</span><br><span class="line">            sb.append(word2.charAt(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (minLen == l1)</span><br><span class="line">            sb.append(word2.substring(minLen));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sb.append(word1.substring(minLen));</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ–¹å¼äºŒï¼šä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆiå’Œjåˆ†åˆ«æŒ‡å‘ä¸¤ä¸ªå­—ç¬¦ä¸²çš„å½“å‰å­—ç¬¦ä½ç½®ã€‚é€šè¿‡ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­å°†å¯¹åº”ä½ç½®çš„å­—ç¬¦æ·»åŠ åˆ°ç»“æœå­—ç¬¦ä¸²ä¸­ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªå­—ç¬¦ä¸²éå†å®Œã€‚ç„¶åå°†å‰©ä½™æœªéå†å®Œçš„å­—ç¬¦ä¸²ç›´æ¥è¿½åŠ åˆ°ç»“æœå­—ç¬¦ä¸²æœ«å°¾ã€‚è¿™ç§æ–¹æ³•é¿å…äº†substringæ“ä½œï¼Œå¯ä»¥ç¨å¾®æé«˜æ€§èƒ½ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">mergeAlternately</span><span class="params">(String word1, String word2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l1</span> <span class="operator">=</span> word1.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">l2</span> <span class="operator">=</span> word2.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">while</span> (i &lt; l1 || j &lt; l2) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; l1)</span><br><span class="line">                sb.append(word1.charAt(i++));</span><br><span class="line">            <span class="keyword">if</span> (j &lt; l2)</span><br><span class="line">                sb.append(word2.charAt(j++));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­—ç¬¦ä¸²çš„æœ€å¤§å…¬å› å­"><a href="https://leetcode.cn/problems/greatest-common-divisor-of-strings/">å­—ç¬¦ä¸²çš„æœ€å¤§å…¬å› å­</a></h3><ul><li>é¢˜ç›®æ‰¾str1å’Œstr2çš„æœ€å¤§å…¬å­ä¸²ï¼Œé‚£ä¹ˆstr1å’Œstr2éƒ½æ˜¯nä¸ªå­ä¸²ç»„æˆçš„ï¼Œé‚£ä¹ˆå¦‚æœä¸æ»¡è¶³<code>(str1 + str2).equals(str2 + str1)</code>ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ç¤ºä¾‹ä¸‰ï¼‰ï¼Œåä¹‹å¦‚æœæ»¡è¶³ï¼Œåˆ™str1å’Œstr2é•¿åº¦çš„æœ€å¤§å…¬å› å­å°±æ˜¯å­ä¸²é•¿åº¦ï¼Œæˆ‘ä»¬ç”¨substring()å¯ä»¥è·å–åˆ°å­ä¸²ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="comment">// æ±‚æœ€å¤§å…¬å› å­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">gcd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> b == <span class="number">0</span> ? a : gcd(b, a % b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">gcdOfStrings</span><span class="params">(String str1, String str2)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸æ»¡è¶³æ¡ä»¶ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">if</span> (!(str1 + str2).equals(str2 + str1)) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// æ»¡è¶³æ¡ä»¶ï¼Œæ±‚str1å’Œstr2çš„æœ€å¤§å…¬å› å­</span></span><br><span class="line">        <span class="keyword">return</span> str1.substring(<span class="number">0</span>, gcd(str1.length(), str2.length()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‹¥æœ‰æœ€å¤šç³–æœçš„å­©å­"><a href="https://leetcode.cn/problems/kids-with-the-greatest-number-of-candies/">æ‹¥æœ‰æœ€å¤šç³–æœçš„å­©å­</a></h3><ul><li>æ‰¾å‡ºæœ€å¤šç³–æœçš„æ•°é‡ï¼Œ<code>å…¶ä½™å­©å­ç³–æœæ•° + é¢å¤–ç³–æœæ•° &gt;= æœ€å¤šç³–æœæ•°</code>ï¼Œç»“æœä¸ºtrue</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Boolean&gt; <span class="title function_">kidsWithCandies</span><span class="params">(<span class="type">int</span>[] candies, <span class="type">int</span> extraCandies)</span> &#123;</span><br><span class="line">        ArrayList&lt;Boolean&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> candy : candies) &#123;</span><br><span class="line">            max = Math.max(max, candy);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; candies.length; i++) &#123;</span><br><span class="line">            res.add(candies[i] + extraCandies &gt;= max);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç§èŠ±é—®é¢˜"><a href="https://leetcode.cn/problems/can-place-flowers/">ç§èŠ±é—®é¢˜</a></h3><ul><li>è´ªå¿ƒï¼šå½“å‰ä½ç½®ä¸º0ï¼Œå‰é¢ä¸º0ï¼Œåé¢ä¸º0ï¼Œé‚£å°±èƒ½ç§ã€‚éœ€è¦æ³¨æ„åˆ¤æ–­ä¸€ä¸‹è¾¹ç•Œæ¡ä»¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canPlaceFlowers</span><span class="params">(<span class="type">int</span>[] flowerbed, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; flowerbed.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (flowerbed[i] == <span class="number">0</span></span><br><span class="line">                    <span class="comment">// å³è¾¹ç•Œ</span></span><br><span class="line">                    &amp;&amp; (i + <span class="number">1</span> == flowerbed.length || flowerbed[i + <span class="number">1</span>] == <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">// å·¦è¾¹ç•Œ</span></span><br><span class="line">                    &amp;&amp; (i == <span class="number">0</span> || flowerbed[i - <span class="number">1</span>] == <span class="number">0</span>)) &#123;</span><br><span class="line">                flowerbed[i] = <span class="number">1</span>;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count &gt;= n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åè½¬å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³å­—æ¯"><a href="https://leetcode.cn/problems/reverse-vowels-of-a-string/submissions/">åè½¬å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³å­—æ¯</a></h3><ul><li>åŒæŒ‡é’ˆï¼Œé¦–å°¾éå†å…ƒéŸ³å­—æ¯ï¼Œæ‰¾åˆ°åäº¤æ¢ä½ç½®</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">reverseVowels</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span>, r = s.length() - <span class="number">1</span>;</span><br><span class="line">        <span class="type">char</span>[] str = s.toCharArray();</span><br><span class="line">        <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">            <span class="keyword">while</span> (l &lt; s.length() &amp;&amp; !isTarget(str[l]))</span><br><span class="line">                l++;</span><br><span class="line">            <span class="keyword">while</span> (r &gt; <span class="number">0</span> &amp;&amp; !isTarget(str[r]))</span><br><span class="line">                r--;</span><br><span class="line">            <span class="keyword">if</span> (l &lt; r) &#123;</span><br><span class="line">                swap(str, l, r);</span><br><span class="line">                l++;</span><br><span class="line">                r--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isTarget</span><span class="params">(<span class="type">char</span> c)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;AEIOUaeiou&quot;</span>.indexOf(c) &gt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">char</span>[] str, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">tmp</span> <span class="operator">=</span> str[i];</span><br><span class="line">        str[i] = str[j];</span><br><span class="line">        str[j] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯"><a href="https://leetcode.cn/problems/reverse-words-in-a-string/">åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯</a></h3><ul><li>å…ˆå»é™¤é¦–å°¾ç©ºæ ¼ï¼Œç„¶åæ­£åˆ™åŒ¹é…è¿ç»­ç©ºæ ¼åˆ‡åˆ†ï¼Œæœ€åç¿»è½¬åˆ—è¡¨ï¼ŒåŠ å…¥ç©ºæ ¼æ‹¼æ¥ï¼Œè¿”å›ç»“æœ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">reverseWords</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        String[] res = s.trim().split(<span class="string">&quot;\\s+&quot;</span>); </span><br><span class="line">        Collections.reverse(Arrays.asList(res));</span><br><span class="line">        <span class="keyword">return</span> String.join(<span class="string">&quot; &quot;</span>, res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é™¤è‡ªèº«ä»¥å¤–æ•°ç»„çš„ä¹˜ç§¯"><a href="https://leetcode.cn/problems/product-of-array-except-self/">é™¤è‡ªèº«ä»¥å¤–æ•°ç»„çš„ä¹˜ç§¯</a></h3><ul><li>ä¸è®©ç”¨é™¤æ³•ï¼Œä¸”è¦åœ¨O(n)çš„æ—¶é—´å¤æ‚åº¦å†…å®Œæˆï¼Œé‚£å°±åªèƒ½ä¸€å±‚å¾ªç¯ï¼Œå¯ä»¥é€šè¿‡è®¡ç®—å‰ç¼€ç§¯å’Œåç¼€ç§¯æœ€åä½¿å…¶ç›¸ä¹˜å¾—å‡ºç»“æœ</li></ul><table><thead><tr><th style="text-align:center">nums</th><th style="text-align:center">1</th><th>2</th><th>3</th><th>4</th></tr></thead><tbody><tr><td style="text-align:center">pre</td><td style="text-align:center">1</td><td>1</td><td>2</td><td>6</td></tr><tr><td style="text-align:center">suf</td><td style="text-align:center">24</td><td>12</td><td>4</td><td>1</td></tr><tr><td style="text-align:center">res</td><td style="text-align:center">24</td><td>12</td><td>8</td><td>6</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[] productExceptSelf(<span class="type">int</span>[] nums) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.length;</span><br><span class="line">        <span class="comment">// å‰ç¼€ç§¯è®¡ç®—</span></span><br><span class="line">        <span class="type">int</span>[] pre = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        pre[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            pre[i] = nums[i - <span class="number">1</span>] * pre[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åç¼€ç§¯è®¡ç®—</span></span><br><span class="line">        <span class="type">int</span>[] suf = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        suf[n - <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            suf[i] = suf[i + <span class="number">1</span>] * nums[i + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç»“æœè®¡ç®—</span></span><br><span class="line">        <span class="type">int</span>[] res = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            res[i] = pre[i] * suf[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é™ä½åˆ°O(1)çš„ç©ºé—´å¤æ‚åº¦ï¼šç”¨resæ•°ç»„ä»£æ›¿preæ•°ç»„ï¼Œç”¨ä¸€ä¸ªsufå˜é‡ä»£æ›¿sufæ•°ç»„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[] productExceptSelf(<span class="type">int</span>[] nums) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.length;</span><br><span class="line">        <span class="type">int</span>[] res = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        res[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            res[i] = nums[i - <span class="number">1</span>] * res[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">suf</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            res[i] *= suf;</span><br><span class="line">            suf *= nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é€’å¢çš„ä¸‰å…ƒå­åºåˆ—"><a href="https://leetcode.cn/problems/increasing-triplet-subsequence/">é€’å¢çš„ä¸‰å…ƒå­åºåˆ—</a></h3><h3 id="å‹ç¼©å­—ç¬¦ä¸²"><a href="https://leetcode.cn/problems/string-compression/">å‹ç¼©å­—ç¬¦ä¸²</a></h3><h2 id="åŒæŒ‡é’ˆ">åŒæŒ‡é’ˆ</h2><h3 id="ç§»åŠ¨é›¶"><a href="https://leetcode.cn/problems/move-zeroes/">ç§»åŠ¨é›¶</a></h3><ul><li>æ–¹å¼ä¸€ï¼šåŒæŒ‡é’ˆéå†ï¼Œå¿«æŒ‡é’ˆéå†ä¸ä¸º0çš„å…ƒç´ ï¼Œèµ‹å€¼ç»™æ…¢æŒ‡é’ˆï¼Œå¿«æŒ‡é’ˆéå†åˆ°æœ«å°¾ç»“æŸï¼Œæ…¢æŒ‡é’ˆå°†å‰©ä½™å…ƒç´ è®¾0</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">moveZeroes</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums == <span class="literal">null</span> || nums.length == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fast</span> <span class="operator">=</span> <span class="number">0</span>, slow = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¿«æŒ‡é’ˆéå†ä¸ä¸º0çš„å…ƒç´ </span></span><br><span class="line">        <span class="keyword">for</span> (; fast &lt; nums.length; fast++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[fast] != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// èµ‹å€¼ç»™æ…¢æŒ‡é’ˆ</span></span><br><span class="line">                nums[slow++] = nums[fast];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ…¢æŒ‡é’ˆå°†å‰©ä½™å…ƒç´ è®¾0</span></span><br><span class="line">        <span class="keyword">for</span> (; slow &lt; nums.length; slow++) &#123;</span><br><span class="line">            nums[slow] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ–¹å¼äºŒ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">moveZeroes</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums == <span class="literal">null</span> || nums.length == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fast</span> <span class="operator">=</span> <span class="number">0</span>, slow = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; fast &lt; nums.length; fast++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[fast] != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">tmp</span> <span class="operator">=</span> nums[fast];</span><br><span class="line">                nums[fast] = nums[slow];</span><br><span class="line">                nums[slow++] = tmp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ¤æ–­å­åºåˆ—"><a href="https://leetcode.cn/problems/is-subsequence/">åˆ¤æ–­å­åºåˆ—</a></h3><ul><li>åŒæŒ‡é’ˆéå†ï¼Œå¦‚æœsæ˜¯tçš„å­åºåˆ—ï¼Œé‚£ä¹ˆsä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šæŒ‰é¡ºåºåœ¨tä¸­ä¾æ¬¡å‡ºç°ï¼Œä¸€ä¸ªæŒ‡é’ˆéå†sï¼Œå¦ä¸€ä¸ªæŒ‡é’ˆéå†tï¼Œæœ€ç»ˆåˆ¤æ–­æŒ‡é’ˆæ˜¯å¦éå†åˆ°äº†sçš„æœ«å°¾</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSubsequence</span><span class="params">(String s, String t)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> s.length(), n = t.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; m &amp;&amp; j &lt; n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s.charAt(i) == t.charAt(j)) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> i == m;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç››æœ€å¤šæ°´çš„å®¹å™¨"><a href="https://leetcode.cn/problems/container-with-most-water/">ç››æœ€å¤šæ°´çš„å®¹å™¨</a></h3><ul><li>è®¾åŒæŒ‡é’ˆ<code>i</code>, <code>j</code>åˆ†åˆ«æŒ‡å‘<code>height[0]</code>, <code>height[n - 1]</code>ï¼Œå¹¶é€æ¸å‘å†…æ”¶ç¼©ï¼Œé‚£ä¹ˆé¢ç§¯<code>S(i, j) = (j - i) * min(height[i], height[j])</code>ï¼Œæ­¤æ—¶çš„é¢ç§¯å–å†³äº<code>min(height[i], height[j])</code><ul><li>å¦‚æœå‘å†…ç§»åŠ¨çŸ­æ¿ï¼Œé‚£ä¹ˆ<code>min(height[i], height[j])</code>æ˜¯å¯èƒ½å¢å¤§çš„ï¼ˆä¹Ÿæœ‰å¯èƒ½å˜å°ï¼‰ï¼Œå³ç§»åŠ¨çŸ­æ¿é¢ç§¯å¯èƒ½ä¼šå¢å¤§</li><li>å¦‚æœå‘å†…ç§»åŠ¨é•¿æ¿ï¼Œé‚£ä¹ˆ<code>min(height[i], height[j])</code>æ˜¯å‡å°æˆ–ä¸å˜çš„ï¼Œå³ç§»åŠ¨é•¿æ¿é¢ç§¯ä¸€å®šä¼šå˜å°</li></ul></li><li>æ‰€ä»¥ä¸ºäº†æ±‚å‡ºæœ€å¤§é¢ç§¯ï¼Œè‚¯å®šæ˜¯ä¸èƒ½ç§»åŠ¨é•¿æ¿çš„ï¼Œåªèƒ½ç§»åŠ¨çŸ­æ¿èµŒä¸€æ³¢ï¼Œæ¯æ¬¡ç§»åŠ¨çŸ­æ¿ä¹‹åæ›´æ–°æœ€å¤§å€¼å³å¯ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxArea</span><span class="params">(<span class="type">int</span>[] height)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// åŒæŒ‡é’ˆä¸€é¦–ä¸€å°¾</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = height.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">            <span class="comment">// ç§»åŠ¨çŸ­æ¿ï¼Œæ›´æ–°æœ€å¤§å€¼</span></span><br><span class="line">            ans = height[i] &lt; height[j] ?</span><br><span class="line">                    Math.max(ans, (j - i) * height[i++]) :</span><br><span class="line">                    Math.max(ans, (j - i) * height[j--]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="K-å’Œæ•°å¯¹çš„æœ€å¤§æ•°ç›®">K å’Œæ•°å¯¹çš„æœ€å¤§æ•°ç›®</h3><h2 id="æ»‘åŠ¨çª—å£">æ»‘åŠ¨çª—å£</h2><h3 id="å­æ•°ç»„æœ€å¤§å¹³å‡æ•°-I"><a href="https://leetcode.cn/problems/maximum-average-subarray-i/">å­æ•°ç»„æœ€å¤§å¹³å‡æ•° I</a></h3><ul><li>è®¡ç®—å›ºå®šé•¿åº¦åŒºé—´å†…æ•°çš„æœ€å¤§å¹³å‡å€¼ï¼Œé‡‡ç”¨æ»‘åŠ¨çª—å£çš„æ€æƒ³ï¼Œå³ç»´æŠ¤ä¸€ä¸ªé•¿åº¦ä¸ºkçš„æ»‘åŠ¨çª—å£ï¼Œå…ˆè®¡ç®—é•¿åº¦ä¸ºkçš„çª—å£åˆå€¼ï¼Œç„¶åæ¯æ¬¡çª—å£å‘å³ç§»åŠ¨çš„æ—¶å€™ï¼ŒåŠ ä¸Šæœ€å³è¾¹çš„å…ƒç´ ï¼Œå‡æ‰æœ€å·¦è¾¹çš„å…ƒç´ ï¼Œæ›´æ–°çª—å£æœ€å¤§å€¼ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span> <span class="title function_">findMaxAverage</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// è®¡ç®—é•¿åº¦ä¸ºkçš„çª—å£çš„åˆå€¼</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">            sum += nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> sum;</span><br><span class="line">        <span class="comment">// æ¯æ¬¡å‘å³ç§»åŠ¨æ—¶</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> k; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="comment">// åŠ ä¸Šæœ€å³ç«¯å…ƒç´ ï¼Œå‡å»æœ€å·¦ç«¯å…ƒç´ </span></span><br><span class="line">            sum = sum + nums[i] - nums[i - k];</span><br><span class="line">            <span class="comment">// æ›´æ–°æœ€å¤§å€¼</span></span><br><span class="line">            res = Math.max(res, sum);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å–å¹³å‡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.0</span> * res / k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®šé•¿å­ä¸²ä¸­å…ƒéŸ³çš„æœ€å¤§æ•°ç›®"><a href="https://leetcode.cn/problems/maximum-number-of-vowels-in-a-substring-of-given-length/">å®šé•¿å­ä¸²ä¸­å…ƒéŸ³çš„æœ€å¤§æ•°ç›®</a></h3><ul><li>ä¸€æ ·çš„å¥—è·¯ï¼Œå”¯ä¸€ä¸€ç‚¹åŒºåˆ«å°±æ˜¯éœ€è¦åˆ¤æ–­æ–°åŠ å…¥å…ƒç´ å’Œå‰”é™¤å…ƒç´ æ˜¯å¦ä¸ºå…ƒéŸ³å­—æ¯</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxVowels</span><span class="params">(String s, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span>[] chars = s.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">            current += isVowel(chars[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> current;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> k; i &lt; chars.length; i++) &#123;</span><br><span class="line">            current = current + isVowel(chars[i]) - isVowel(chars[i - k]);</span><br><span class="line">            res = Math.max(res, current);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">isVowel</span><span class="params">(<span class="type">char</span> c)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (c == <span class="string">&#x27;a&#x27;</span> || c == <span class="string">&#x27;e&#x27;</span> || c == <span class="string">&#x27;i&#x27;</span> || c == <span class="string">&#x27;o&#x27;</span> || c == <span class="string">&#x27;u&#x27;</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æœ€å¤§è¿ç»­1çš„ä¸ªæ•°-III"><a href="https://leetcode.cn/problems/max-consecutive-ones-iii/">æœ€å¤§è¿ç»­1çš„ä¸ªæ•° III</a></h3><ul><li>å°†é—®é¢˜è½¬æ¢ä¸ºï¼šæ‰¾ä¸€ä¸ªæœ€é•¿å­æ•°ç»„ï¼Œè¯¥å­æ•°ç»„æœ€å¤šåŒ…å«kä¸ª0</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">longestOnes</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>, count = <span class="number">0</span>, left = <span class="number">0</span>, right = <span class="number">0</span>, n = nums.length;</span><br><span class="line">        <span class="comment">// å³è¾¹ç•Œéå†åˆ°ç»“å°¾</span></span><br><span class="line">        <span class="keyword">while</span> (right &lt; n) &#123;</span><br><span class="line">            <span class="comment">// å³è¾¹ç•Œå³ç§»ï¼Œå¦‚æœé‡åˆ°0ï¼Œåˆ™è®¡æ•°+1</span></span><br><span class="line">            <span class="keyword">if</span> (nums[right] == <span class="number">0</span>)</span><br><span class="line">                count++;</span><br><span class="line">            <span class="comment">// å¦‚æœæ­¤æ—¶left ~ rightçš„å­æ•°ç»„ä¸­çš„0å·²ç»è¶…è¿‡äº†kä¸ª</span></span><br><span class="line">            <span class="keyword">while</span> (count &gt; k) &#123;</span><br><span class="line">                <span class="comment">// å·¦è¾¹ç•Œå³ç§»ï¼Œå¦‚æœå·¦è¾¹ç•Œé‡åˆ°äº†0ï¼Œåˆ™å°†å…¶ç§»é™¤ï¼Œè®¡æ•°-1</span></span><br><span class="line">                <span class="keyword">if</span> (nums[left++] == <span class="number">0</span>)</span><br><span class="line">                    count--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ¯æ¬¡æ“ä½œå®Œæ¯•æ›´æ–°ç»“æœ</span></span><br><span class="line">            res = Math.max(res, right - left + <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// å³è¾¹ç•Œå³ç§»</span></span><br><span class="line">            right++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ æ‰ä¸€ä¸ªå…ƒç´ ä»¥åå…¨ä¸º1çš„æœ€é•¿å­æ•°ç»„"><a href="https://leetcode.cn/problems/longest-subarray-of-1s-after-deleting-one-element/">åˆ æ‰ä¸€ä¸ªå…ƒç´ ä»¥åå…¨ä¸º1çš„æœ€é•¿å­æ•°ç»„</a></h3><ul><li>ä¸ä¸Šé¢˜ç±»ä¼¼ï¼Œå°†å…¶è½¬æ¢ä¸ºï¼šæ‰¾ä¸€ä¸ªæœ€é•¿å­æ•°ç»„ï¼Œæœ€å¤šåªåŒ…å«1ä¸ª0</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">longestSubarray</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>, count = <span class="number">0</span>, left = <span class="number">0</span>, right = <span class="number">0</span>, n = nums.length;</span><br><span class="line">        <span class="keyword">while</span>(right &lt; n) &#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[right] == <span class="number">0</span>) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span>(count &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(nums[left++] == <span class="number">0</span>) &#123;</span><br><span class="line">                    count--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res = Math.max(res, right - left + <span class="number">1</span>);</span><br><span class="line">            right++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‰ç¼€å’Œ">å‰ç¼€å’Œ</h2><h3 id="æ‰¾åˆ°æœ€é«˜æµ·æ‹”"><a href="https://leetcode.cn/problems/find-the-highest-altitude/">æ‰¾åˆ°æœ€é«˜æµ·æ‹”</a></h3><ul><li>ç®€å•çš„å‰ç¼€å’Œ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">largestAltitude</span><span class="params">(<span class="type">int</span>[] gain)</span> &#123;</span><br><span class="line">       <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>, sum = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span>(<span class="type">int</span> x : gain) &#123;</span><br><span class="line">           sum += x;</span><br><span class="line">           res = Math.max(res, sum);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¯»æ‰¾æ•°ç»„çš„ä¸­å¿ƒä¸‹æ ‡"><a href="https://leetcode.cn/problems/find-pivot-index/">å¯»æ‰¾æ•°ç»„çš„ä¸­å¿ƒä¸‹æ ‡</a></h3><ul><li>æ±‚å‰ç¼€å’Œå’Œåç¼€å’Œï¼Œç„¶åä»å·¦å¾€å³éå†ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå‰ç¼€å’Œå’Œåç¼€å’Œç›¸ç­‰çš„ä¸‹æ ‡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">pivotIndex</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.length;</span><br><span class="line">        <span class="type">int</span>[] preSum = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        preSum[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span>[] extSum = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        extSum[n - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            preSum[i] = preSum[i - <span class="number">1</span>] + nums[i - <span class="number">1</span>];</span><br><span class="line">            extSum[n - <span class="number">1</span> - i] = extSum[n - i] + nums[n - i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preSum[i] == extSum[i])</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¼˜åŒ–æ€è·¯ï¼šå¦‚æœæœ‰ç¬¦åˆæ¡ä»¶çš„ä¸­å¿ƒä¸‹æ ‡ï¼Œåˆ™æœ‰<code>å·¦æ±‚å’Œ Ã— 2 + ä¸­å¿ƒä¸‹è¡¨å€¼ = æ€»å’Œ</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">pivotIndex</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> Arrays.stream(nums).sum();</span><br><span class="line">        <span class="type">int</span> <span class="variable">leftSum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (leftSum * <span class="number">2</span> + nums[i] == sum) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">            leftSum += nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å“ˆå¸Œè¡¨-å“ˆå¸Œé›†åˆ">å“ˆå¸Œè¡¨ / å“ˆå¸Œé›†åˆ</h2><h3 id="æ‰¾å‡ºä¸¤æ•°ç»„çš„ä¸åŒ"><a href="https://leetcode.cn/problems/find-the-difference-of-two-arrays/">æ‰¾å‡ºä¸¤æ•°ç»„çš„ä¸åŒ</a></h3><ul><li>è¯·å«æˆ‘APIä¾ </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="title function_">findDifference</span><span class="params">(<span class="type">int</span>[] nums1, <span class="type">int</span>[] nums2)</span> &#123;</span><br><span class="line">        HashSet&lt;Integer&gt; set1 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        HashSet&lt;Integer&gt; set2 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n : nums2) &#123;</span><br><span class="line">            set2.add(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n : nums1) &#123;</span><br><span class="line">            set1.add(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n : nums2) &#123;</span><br><span class="line">            set1.remove(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n : nums1) &#123;</span><br><span class="line">            set2.remove(n);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        res.add(set1.stream().toList());</span><br><span class="line">        res.add(set2.stream().toList());</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ›´æ–¹ä¾¿çš„API</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="title function_">findDifference</span><span class="params">(<span class="type">int</span>[] nums1, <span class="type">int</span>[] nums2)</span> &#123;</span><br><span class="line">        HashSet&lt;Integer&gt; set1 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        HashSet&lt;Integer&gt; set2 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n : nums2) &#123;</span><br><span class="line">            set2.add(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n : nums1) &#123;</span><br><span class="line">            set1.add(n);</span><br><span class="line">            set2.remove(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n : nums2) &#123;</span><br><span class="line">            set1.remove(n);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> List.of(List.copyOf(set1), List.copyOf(set2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç‹¬ä¸€æ— äºŒçš„å‡ºç°æ¬¡æ•°"><a href="https://leetcode.cn/problems/unique-number-of-occurrences/">ç‹¬ä¸€æ— äºŒçš„å‡ºç°æ¬¡æ•°</a></h3><ul><li>å“ˆå¸Œè¡¨å­˜å‚¨æ¯ä¸ªæ•°å­—å‡ºç°çš„æ¬¡æ•°ï¼Œåˆ¤æ–­valueæ˜¯å¦æœ‰é‡å¤å€¼ï¼ŒæŠŠvalueå­˜å…¥HashSetï¼Œè§‚å¯Ÿvalueçš„ä¸ªæ•°ä¼šä¸ä¼šå‡å°‘å³å¯</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">uniqueOccurrences</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">        HashMap&lt;Integer, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n : arr) &#123;</span><br><span class="line">            map.put(n, map.get(n) == <span class="literal">null</span> ? <span class="number">0</span> : map.get(n) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(map.values()).size() == map.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¡®å®šä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ¥è¿‘">ç¡®å®šä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ¥è¿‘</h3><h3 id="ç›¸ç­‰è¡Œåˆ—å¯¹">ç›¸ç­‰è¡Œåˆ—å¯¹</h3><h2 id="æ ˆ">æ ˆ</h2><h3 id="ä»å­—ç¬¦ä¸²ä¸­ç§»é™¤æ˜Ÿå·">ä»å­—ç¬¦ä¸²ä¸­ç§»é™¤æ˜Ÿå·</h3><h3 id="è¡Œæ˜Ÿç¢°æ’">è¡Œæ˜Ÿç¢°æ’</h3><h3 id="å­—ç¬¦ä¸²è§£ç ">å­—ç¬¦ä¸²è§£ç </h3><h2 id="é˜Ÿåˆ—">é˜Ÿåˆ—</h2><h3 id="æœ€è¿‘çš„è¯·æ±‚æ¬¡æ•°">æœ€è¿‘çš„è¯·æ±‚æ¬¡æ•°</h3><h3 id="Dota2-å‚è®®é™¢">Dota2 å‚è®®é™¢</h3><h2 id="é“¾è¡¨">é“¾è¡¨</h2><h3 id="åˆ é™¤é“¾è¡¨çš„ä¸­é—´èŠ‚ç‚¹">åˆ é™¤é“¾è¡¨çš„ä¸­é—´èŠ‚ç‚¹</h3><h3 id="å¥‡å¶é“¾è¡¨">å¥‡å¶é“¾è¡¨</h3><h3 id="åè½¬é“¾è¡¨">åè½¬é“¾è¡¨</h3><h3 id="é“¾è¡¨æœ€å¤§å­ªç”Ÿå’Œ">é“¾è¡¨æœ€å¤§å­ªç”Ÿå’Œ</h3><h2 id="äºŒå‰æ ‘-æ·±åº¦ä¼˜å…ˆæœç´¢">äºŒå‰æ ‘ - æ·±åº¦ä¼˜å…ˆæœç´¢</h2><h3 id="äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦">äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦</h3><h3 id="å¶å­ç›¸ä¼¼çš„æ ‘">å¶å­ç›¸ä¼¼çš„æ ‘</h3><h3 id="ç»Ÿè®¡äºŒå‰æ ‘ä¸­å¥½èŠ‚ç‚¹çš„æ•°ç›®">ç»Ÿè®¡äºŒå‰æ ‘ä¸­å¥½èŠ‚ç‚¹çš„æ•°ç›®</h3><h3 id="è·¯å¾„æ€»å’Œ-III">è·¯å¾„æ€»å’Œ III</h3><h3 id="äºŒå‰æ ‘ä¸­çš„æœ€é•¿äº¤é”™è·¯å¾„">äºŒå‰æ ‘ä¸­çš„æœ€é•¿äº¤é”™è·¯å¾„</h3><h3 id="äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ">äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ</h3><h2 id="äºŒå‰æ ‘-å¹¿åº¦ä¼˜å…ˆæœç´¢">äºŒå‰æ ‘ - å¹¿åº¦ä¼˜å…ˆæœç´¢</h2><h3 id="äºŒå‰æ ‘çš„å³è§†å›¾">äºŒå‰æ ‘çš„å³è§†å›¾</h3><h3 id="æœ€å¤§å±‚å†…å…ƒç´ å’Œ">æœ€å¤§å±‚å†…å…ƒç´ å’Œ</h3><h2 id="äºŒå‰æœç´¢æ ‘">äºŒå‰æœç´¢æ ‘</h2><h3 id="äºŒå‰æœç´¢æ ‘ä¸­çš„æœç´¢">äºŒå‰æœç´¢æ ‘ä¸­çš„æœç´¢</h3><h3 id="åˆ é™¤äºŒå‰æœç´¢æ ‘ä¸­çš„èŠ‚ç‚¹">åˆ é™¤äºŒå‰æœç´¢æ ‘ä¸­çš„èŠ‚ç‚¹</h3><h2 id="å›¾-æ·±åº¦ä¼˜å…ˆæœç´¢">å›¾ - æ·±åº¦ä¼˜å…ˆæœç´¢</h2><h3 id="é’¥åŒ™å’Œæˆ¿é—´">é’¥åŒ™å’Œæˆ¿é—´</h3><h3 id="çœä»½æ•°é‡">çœä»½æ•°é‡</h3><h3 id="é‡æ–°è§„åˆ’è·¯çº¿">é‡æ–°è§„åˆ’è·¯çº¿</h3><h3 id="é™¤æ³•æ±‚å€¼">é™¤æ³•æ±‚å€¼</h3><h2 id="å›¾-å¹¿åº¦ä¼˜å…ˆæœç´¢">å›¾ - å¹¿åº¦ä¼˜å…ˆæœç´¢</h2><h3 id="è¿·å®«ä¸­ç¦»å…¥å£æœ€è¿‘çš„å‡ºå£">è¿·å®«ä¸­ç¦»å…¥å£æœ€è¿‘çš„å‡ºå£</h3><h3 id="è…çƒ‚çš„æ©˜å­">è…çƒ‚çš„æ©˜å­</h3><h2 id="å †-ä¼˜å…ˆé˜Ÿåˆ—">å † / ä¼˜å…ˆé˜Ÿåˆ—</h2><h3 id="æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´ ">æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´ </h3><h3 id="æ— é™é›†ä¸­çš„æœ€å°æ•°å­—">æ— é™é›†ä¸­çš„æœ€å°æ•°å­—</h3><h3 id="æœ€å¤§å­åºåˆ—çš„åˆ†æ•°">æœ€å¤§å­åºåˆ—çš„åˆ†æ•°</h3><h3 id="é›‡ä½£-K-ä½å·¥äººçš„æ€»ä»£ä»·">é›‡ä½£ K ä½å·¥äººçš„æ€»ä»£ä»·</h3><h2 id="äºŒåˆ†æŸ¥æ‰¾">äºŒåˆ†æŸ¥æ‰¾</h2><h3 id="çŒœæ•°å­—å¤§å°">çŒœæ•°å­—å¤§å°</h3><h3 id="å’’è¯­å’Œè¯æ°´çš„æˆåŠŸå¯¹æ•°">å’’è¯­å’Œè¯æ°´çš„æˆåŠŸå¯¹æ•°</h3><h3 id="å¯»æ‰¾å³°å€¼">å¯»æ‰¾å³°å€¼</h3><h3 id="çˆ±åƒé¦™è•‰çš„ç‚ç‚">çˆ±åƒé¦™è•‰çš„ç‚ç‚</h3><h2 id="å›æº¯">å›æº¯</h2><h3 id="ç”µè¯å·ç çš„å­—æ¯ç»„åˆ">ç”µè¯å·ç çš„å­—æ¯ç»„åˆ</h3><h3 id="ç»„åˆæ€»å’Œ-III">ç»„åˆæ€»å’Œ III</h3><h2 id="åŠ¨æ€è§„åˆ’-ä¸€ç»´">åŠ¨æ€è§„åˆ’ - ä¸€ç»´</h2><h3 id="ç¬¬-N-ä¸ªæ³°æ³¢é‚£å¥‘æ•°">ç¬¬ N ä¸ªæ³°æ³¢é‚£å¥‘æ•°</h3><h3 id="ä½¿ç”¨æœ€å°èŠ±è´¹çˆ¬æ¥¼æ¢¯">ä½¿ç”¨æœ€å°èŠ±è´¹çˆ¬æ¥¼æ¢¯</h3><h3 id="æ‰“å®¶åŠ«èˆ">æ‰“å®¶åŠ«èˆ</h3><h3 id="å¤šç±³è¯ºå’Œæ‰˜ç±³è¯ºå¹³é“º">å¤šç±³è¯ºå’Œæ‰˜ç±³è¯ºå¹³é“º</h3><h2 id="åŠ¨æ€è§„åˆ’-å¤šç»´">åŠ¨æ€è§„åˆ’ - å¤šç»´</h2><h3 id="ä¸åŒè·¯å¾„">ä¸åŒè·¯å¾„</h3><h3 id="æœ€é•¿å…¬å…±å­åºåˆ—">æœ€é•¿å…¬å…±å­åºåˆ—</h3><h3 id="ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœºå«æ‰‹ç»­è´¹">ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœºå«æ‰‹ç»­è´¹</h3><h3 id="ç¼–è¾‘è·ç¦»">ç¼–è¾‘è·ç¦»</h3><h2 id="ä½è¿ç®—">ä½è¿ç®—</h2><h3 id="æ¯”ç‰¹ä½è®¡æ•°">æ¯”ç‰¹ä½è®¡æ•°</h3><h3 id="åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—">åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—</h3><h3 id="æˆ–è¿ç®—çš„æœ€å°ç¿»è½¬æ¬¡æ•°">æˆ–è¿ç®—çš„æœ€å°ç¿»è½¬æ¬¡æ•°</h3><h2 id="å‰ç¼€æ ‘">å‰ç¼€æ ‘</h2><h3 id="å®ç°-Trie-å‰ç¼€æ ‘">å®ç° Trie (å‰ç¼€æ ‘)</h3><h3 id="æœç´¢æ¨èç³»ç»Ÿ">æœç´¢æ¨èç³»ç»Ÿ</h3><h2 id="åŒºé—´é›†åˆ">åŒºé—´é›†åˆ</h2><h3 id="æ— é‡å åŒºé—´">æ— é‡å åŒºé—´</h3><h3 id="ç”¨æœ€å°‘æ•°é‡çš„ç®­å¼•çˆ†æ°”çƒ">ç”¨æœ€å°‘æ•°é‡çš„ç®­å¼•çˆ†æ°”çƒ</h3><h2 id="å•è°ƒæ ˆ">å•è°ƒæ ˆ</h2><h3 id="æ¯æ—¥æ¸©åº¦">æ¯æ—¥æ¸©åº¦</h3><h3 id="è‚¡ç¥¨ä»·æ ¼è·¨åº¦">è‚¡ç¥¨ä»·æ ¼è·¨åº¦</h3>]]></content>
    
    
    <summary type="html">Leetcode 75 é¢è¯•å¿…è€ƒç²¾åç‰ˆï¼Œ75é¢˜è¦†ç›–å…¨é‡è€ƒç‚¹</summary>
    
    
    
    <category term="åŠ›æ‰£" scheme="https://cyborg2077.github.io/categories/%E5%8A%9B%E6%89%A3/"/>
    
    
    <category term="Leetcode" scheme="https://cyborg2077.github.io/tags/Leetcode/"/>
    
  </entry>
  
  <entry>
    <title>Mavené¢è¯•é¢˜</title>
    <link href="https://cyborg2077.github.io/2023/05/20/InQMaven/"/>
    <id>https://cyborg2077.github.io/2023/05/20/InQMaven/</id>
    <published>2023-05-20T04:20:27.000Z</published>
    <updated>2023-10-01T13:43:47.560Z</updated>
    
    <content type="html"><![CDATA[<ol><li>ä»€ä¹ˆæ˜¯Mavenï¼Ÿ</li></ol><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Mavenæ˜¯ä¸€ä¸ªå¼€æºçš„é¡¹ç›®ç®¡ç†å’Œæ„å»ºå·¥å…·ï¼Œç”¨äºå¸®åŠ©å¼€å‘äººå‘˜è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²Javaé¡¹ç›®ã€‚å®ƒæä¾›äº†ä¸€ä¸ªæ ‡å‡†åŒ–çš„é¡¹ç›®ç»“æ„å’Œä¸€å¥—å¼ºå¤§çš„æ„å»ºè§„åˆ™ï¼Œä»¥åŠä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿï¼Œä½¿å¾—é¡¹ç›®çš„æ„å»ºå’Œä¾èµ–ç®¡ç†å˜å¾—ç®€å•å’Œå¯é ã€‚</li><li>Mavençš„æ ¸å¿ƒæ¦‚å¿µåŒ…æ‹¬é¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼ˆProject Object Modelï¼ŒPOMï¼‰ã€åæ ‡ã€ä¾èµ–ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸã€‚é¡¹ç›®å¯¹è±¡æ¨¡å‹æ˜¯ä¸€ä¸ªXMLæ–‡ä»¶ï¼Œæè¿°äº†é¡¹ç›®çš„åŸºæœ¬ä¿¡æ¯ã€ä¾èµ–ä¿¡æ¯ã€æ’ä»¶é…ç½®ç­‰ã€‚</li><li>ä¾èµ–ç®¡ç†åŠŸèƒ½å¯ä»¥è®©å¼€å‘äººå‘˜æ–¹ä¾¿çš„ç”Ÿå‘½å’Œç®¡ç†é¡¹ç›®æ‰€ä¾èµ–çš„å¤–éƒ¨åº“å’Œæ¨¡å—ã€‚ç”Ÿå‘½å‘¨æœŸå®šä¹‰äº†ä¸€ç³»åˆ—çš„æ„å»ºé˜¶æ®µå’Œæ’ä»¶ç›®æ ‡ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ ¹æ®éœ€æ±‚æ‰§è¡Œä¸åŒçš„æ„å»ºä»»åŠ¡ã€‚</li></ul>              </div>            </details><ol start="2"><li>Mavenèƒ½ä¸ºæˆ‘ä»¬è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li></ol><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ol><li>æ·»åŠ ç¬¬ä¸‰æ–¹jaråŒ…<ul><li>ä½¿ç”¨Mavenä¹‹å‰ï¼Œæˆ‘ä»¬éƒ½æ˜¯æ‰‹åŠ¨å¤åˆ¶jaråŒ…åˆ°é¡¹ç›®çš„<code>WEB-INF/lib</code>ä¸‹ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½ä¼šæœ‰ä¸€ä»½ï¼Œé€ æˆå¤§é‡é‡å¤æ–‡ä»¶ã€‚è€ŒMavenå°†jaråŒ…æ”¾åœ¨æœ¬åœ°ä»“åº“ä¸­ç»Ÿä¸€ç®¡ç†ï¼Œéœ€è¦jaråŒ…åªéœ€è¦ç”¨åæ ‡çš„æ–¹å¼å¼•ç”¨å³å¯ã€‚</li></ul></li><li>jaråŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»<ul><li>jaråŒ…ä¹‹é—´å¾€å¾€æ˜¯ä¸ç‹¬ç«‹çš„ï¼Œå¾ˆå¤šjaråŒ…éœ€è¦åœ¨å…¶ä»–jaråŒ…çš„æ”¯æŒä¸‹æ‰èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œæˆä¸ºjaråŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¦‚æœæˆ‘ä»¬æ‰‹åŠ¨å»å¯¼å…¥ï¼Œè¦çŸ¥é“jaråŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»å¹¶ä¸€ä¸€å¯¼å…¥ï¼Œè¿™æ ·æ˜¯æå…¶éº»çƒ¦è€Œä¸”å®¹æ˜“å‡ºé”™çš„ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨mavenï¼Œå®ƒèƒ½å¤Ÿå°†å½“å‰jaråŒ…æ‰€ä¾èµ–çš„å…¶ä»–æ‰€æœ‰jaråŒ…å…¨éƒ¨å¯¼å…¥ã€‚</li></ul></li><li>è·å–ç¬¬ä¸‰æ–¹jaråŒ…<ul><li>å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦ç”¨åˆ°å¾ˆå¤šjaråŒ…ï¼Œæ¯ä¸ªjaråŒ…åœ¨å®˜ç½‘çš„è·å–æ–¹å¼ä¸å°½ç›¸åŒï¼Œç»™å·¥ä½œå¸¦æ¥äº†é¢å¤–çš„å›°æ‰°ã€‚ä½†æ˜¯ä½¿ç”¨Mavenå¯ä»¥ä»¥åæ ‡çš„æ–¹å¼ä¾èµ–ä¸€ä¸ªjaråŒ…ï¼ŒMavenä»ä¸­å¤®ä»“åº“è¿›è¡Œä¸‹è½½ï¼Œå¹¶åŒæ—¶ä¸‹è½½è¿™ä¸ªjaråŒ…ä¾èµ–çš„å…¶ä»–jaråŒ…</li></ul></li><li>å°†é¡¹ç›®æ‹†åˆ†ä¸ºè¿‡ä¸ªå·¥ç¨‹æ¨¡å—<ul><li>éšç€é¡¹ç›®çš„è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œå·²ç»ä¸å¯èƒ½é€šè¿‡packageç»“æ„æ¥åˆ’åˆ†æ¨¡å—ï¼Œå¿…é¡»å°†é¡¹ç›®æ‹†åˆ†ä¸ºå¤šä¸ªå·¥ç¨‹ååŒå¼€å‘ã€‚</li></ul></li></ol>              </div>            </details><ol start="3"><li>è¯´è¯´Mavenæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ</li></ol><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä¼˜ç‚¹<ol><li>ç®€åŒ–äº†é¡¹ç›®ä¾èµ–ç®¡ç†</li><li>æ˜“äºä¸Šæ‰‹ï¼Œå¯¹äºæ–°æ‰‹æ¥è¯´ï¼Œäº†è§£å‡ ä¸ªå¸¸ç”¨å‘½ä»¤å³å¯æ»¡è¶³æ—¥å¸¸å·¥ä½œéœ€æ±‚</li><li>ä¾¿äºä¸æŒç»­é›†æˆå·¥å…·ï¼ˆjenkinsï¼‰æ•´åˆ</li><li>ä¾¿äºé¡¹ç›®å‡çº§ï¼Œæ— è®ºæ˜¯é¡¹ç›®æœ¬èº«è¿˜æ˜¯é¡¹ç›®ä½¿ç”¨çš„ä¾èµ–</li><li>mavenæœ‰å¾ˆå¤šæ’ä»¶ï¼Œä¾¿äºåŠŸèƒ½æ‰©å±•ï¼Œä¾‹å¦‚ç”Ÿäº§ç«™ç‚¹ã€è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ç­‰</li></ol></li><li>ç¼ºç‚¹<ul><li>Mavenæ˜¯ä¸€ä¸ªåºå¤§çš„æ„å»ºç³»ç»Ÿï¼Œå­¦ä¹ éš¾åº¦å¤§ï¼Œå…¥é—¨å®¹æ˜“ä½†ç²¾é€šéš¾</li><li>Mavené‡‡ç”¨çº¦å®šå¤§äºé…ç½®çš„ç­–ç•¥ï¼Œè™½ç„¶ä¸Šæ‰‹å®¹æ˜“ï¼Œä½†ä¸€æ—¦å‡ºç°é—®é¢˜ï¼Œå¾ˆéš¾è°ƒè¯•ï¼ˆä¾‹å¦‚ç½‘ç»œç¯å¢ƒè¾ƒå·®ï¼Œå¯¼è‡´å¾ˆå¤šrepositoryæ— æ³•è®¿é—®ï¼‰</li></ul></li></ul>              </div>            </details><ol start="4"><li>ä»€ä¹ˆæ˜¯Mavençš„åæ ‡ï¼Ÿ</li></ol><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Mavenåæ ‡æ˜¯ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªé¡¹ç›®æˆ–æ¨¡å—çš„ä¿¡æ¯ï¼Œå®ƒç”±ä¸€ç»„å›ºå®šçš„å±æ€§ç»„æˆï¼ŒåŒ…æ‹¬groupIdã€artifactIdå’ŒVersion<ul><li>groupId(ç»„ç»‡åç§°)ï¼šç”¨äºè¡¨ç¤ºé¡¹ç›®æ‰€å±çš„ç»„ç»‡æˆ–å›¢é˜Ÿï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒçš„å‘½åæ˜¯ç¿»è½¬çš„åŸŸåï¼ˆcom.exampleï¼‰ï¼Œä½†ä¹Ÿå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚æ¥è‡ªå®šä¹‰ã€‚</li><li>artifactId(é¡¹ç›®ç»„ç»‡)ï¼šartifactIdæ˜¯æŒ‡é¡¹ç›®çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„é¡¹ç›®ã€‚å®ƒé€šå¸¸æ˜¯é¡¹ç›®çš„åç§°ï¼Œç”¨äºåœ¨ä»“åº“ä¸­å”¯ä¸€æ ‡è¯†ä¸€ä¸ªé¡¹ç›®ï¼Œåœ¨åŒä¸€ä¸ªgroupIdä¸‹ï¼Œä¸åŒçš„é¡¹ç›®åº”è¯¥æœ‰ä¸åŒçš„artifactId</li><li>version(ç‰ˆæœ¬å·)ï¼šversionè¡¨ç¤ºé¡¹ç›®çš„ç‰ˆæœ¬å·ã€‚å®ƒç”¨äºåŒºåˆ†ä¸åŒç‰ˆæœ¬çš„é¡¹ç›®ï¼Œä»¥ä¾¿åœ¨ä¾èµ–ç®¡ç†å’Œæ„å»ºè¿‡ç¨‹ä¸­æ­£ç¡®é€‰æ‹©å’Œä½¿ç”¨ã€‚ç‰ˆæœ¬å·å¯ä»¥é‡‡ç”¨æ ‡å‡†çš„æ•°å­—æ ¼å¼ï¼ˆä¾‹å¦‚1.0ã€2.1.7ï¼‰æˆ–å…¶ä»–çº¦å®šçš„æ ¼å¼ã€‚</li></ul></li><li>é€šè¿‡ç»„åˆè¿™äº›å±æ€§ï¼ŒMavençš„åæ ‡æä¾›äº†ä¸€ç§å”¯ä¸€æ ‡è¯†çš„å®šä½é¡¹ç›®çš„æ–¹å¼ã€‚åœ¨ä¾èµ–ç®¡ç†ä¸­ï¼Œå…¶ä»–é¡¹ç›®å¯ä»¥é€šè¿‡å¼•ç”¨è¯¥åæ ‡æ¥å£°æ˜å¯¹è¯¥é¡¹ç›®çš„ä¾èµ–ã€‚Mavenä¼šæ ¹æ®è¿™äº›åæ ‡ä¿¡æ¯ï¼Œè‡ªåŠ¨ä¸‹è½½å¹¶å¼•å…¥æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚</li></ul>              </div>            </details><ol start="5"><li>è®²ä¸€ä¸‹mavençš„ç”Ÿå‘½å‘¨æœŸ</li></ol><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <table><thead><tr><th style="text-align:center">é˜¶æ®µ</th><th style="text-align:center">å¤„ç†</th><th style="text-align:center">æè¿°</th></tr></thead><tbody><tr><td style="text-align:center">validate</td><td style="text-align:center">éªŒè¯é¡¹ç›®</td><td style="text-align:center">éªŒè¯é¡¹ç›®æ˜¯å¦æ­£ç¡®ä¸”æ‰€æœ‰å¿…é¡»ä¿¡æ¯æ˜¯å¯ç”¨çš„</td></tr><tr><td style="text-align:center">compile</td><td style="text-align:center">æ‰§è¡Œç¼–è¯‘</td><td style="text-align:center">æºä»£ç ç¼–è¯‘åœ¨æ­¤é˜¶æ®µå®Œæˆ</td></tr><tr><td style="text-align:center">test</td><td style="text-align:center">æµ‹è¯•</td><td style="text-align:center">ä½¿ç”¨é€‚å½“çš„å•å…ƒæµ‹è¯•æ¡†æ¶(ä¾‹JUnit)è¿è¡Œæµ‹è¯•</td></tr><tr><td style="text-align:center">package</td><td style="text-align:center">æ‰“åŒ…</td><td style="text-align:center">åˆ›å»ºJAR/WARåŒ…å¦‚åœ¨ pom,xml ä¸­å®šä¹‰æåŠçš„åŒ…</td></tr><tr><td style="text-align:center">verify</td><td style="text-align:center">æ£€æŸ¥</td><td style="text-align:center">å¯¹é›†æˆæµ‹è¯•çš„ç»“æœè¿›è¡Œæ£€æŸ¥ï¼Œä»¥ä¿è¯è´¨é‡è¾¾æ ‡</td></tr><tr><td style="text-align:center">install</td><td style="text-align:center">å®‰è£…</td><td style="text-align:center">å®‰è£…æ‰“åŒ…çš„é¡¹ç›®åˆ°æœ¬åœ°ä»“åº“ï¼Œä»¥ä¾›å…¶ä»–é¡¹ç›®ä½¿ç”¨</td></tr><tr><td style="text-align:center">deploy</td><td style="text-align:center">éƒ¨ç½²</td><td style="text-align:center">æ‹·è´æœ€ç»ˆçš„å·¥ç¨‹åŒ…åˆ°è¿œç¨‹ä»“åº“ä¸­ï¼Œä»¥å…±äº«ç»™å…¶ä»–å¼€å‘äººå‘˜å’Œå·¥ç¨‹</td></tr></tbody></table>              </div>            </details><ol start="6"><li>è¯´è¯´ä½ ç†Ÿæ‚‰å“ªäº›mavenå‘½ä»¤ï¼Ÿ</li></ol><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <table><thead><tr><th style="text-align:center">Maven å‘½ä»¤</th><th style="text-align:center">åŠŸèƒ½</th></tr></thead><tbody><tr><td style="text-align:center">mvn archetype:generate</td><td style="text-align:center">åˆ›å»º Maven é¡¹ç›®</td></tr><tr><td style="text-align:center">mvn compile</td><td style="text-align:center">ç¼–è¯‘æºä»£ç </td></tr><tr><td style="text-align:center">mvn deploy</td><td style="text-align:center">å‘å¸ƒé¡¹ç›®</td></tr><tr><td style="text-align:center">mvn test-compile</td><td style="text-align:center">ç¼–è¯‘æµ‹è¯•æºä»£ç </td></tr><tr><td style="text-align:center">mvn test</td><td style="text-align:center">è¿è¡Œåº”ç”¨ç¨‹åºä¸­çš„å•å…ƒæµ‹è¯•</td></tr><tr><td style="text-align:center">mvn site</td><td style="text-align:center">ç”Ÿæˆé¡¹ç›®ç›¸å…³ä¿¡æ¯çš„ç½‘ç«™</td></tr><tr><td style="text-align:center">mvn clean</td><td style="text-align:center">æ¸…é™¤é¡¹ç›®ç›®å½•ä¸­çš„ç”Ÿæˆç»“æœ</td></tr><tr><td style="text-align:center">mvn package</td><td style="text-align:center">æ ¹æ®é¡¹ç›®ç”Ÿæˆçš„ JAR</td></tr><tr><td style="text-align:center">mvn install</td><td style="text-align:center">åœ¨æœ¬åœ° Repository ä¸­å®‰è£… JAR</td></tr><tr><td style="text-align:center">mvn eclipse:eclipse</td><td style="text-align:center">ç”Ÿæˆ Eclipse é¡¹ç›®æ–‡ä»¶</td></tr><tr><td style="text-align:center">mvn jetty:run</td><td style="text-align:center">å¯åŠ¨ Jetty æœåŠ¡</td></tr><tr><td style="text-align:center">mvn tomcat:run</td><td style="text-align:center">å¯åŠ¨ Tomcat æœåŠ¡</td></tr><tr><td style="text-align:center">mvn clean package -Dmaven.test.skip=true</td><td style="text-align:center">æ¸…é™¤ä»¥å‰çš„åŒ…åé‡æ–°æ‰“åŒ…ï¼Œè·³è¿‡æµ‹è¯•ç±»</td></tr></tbody></table>              </div>            </details><ol start="7"><li>å¦‚ä½•è§£å†³ä¾èµ–ä¼ é€’å¼•èµ·çš„ç‰ˆæœ¬å†²çªï¼Ÿ</li></ol><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <p>å¯ä»¥é€šè¿‡åœ¨ä¾èµ–é¡¹å£°æ˜ä¸­ä½¿ç”¨<code>&lt;exclusions&gt;</code>æ ‡ç­¾æ¥æ’é™¤ç‰¹å®šçš„ä¼ é€’ä¾èµ–é¡¹ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>example-library<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>conflicting-group<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>conflicting-artifact<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>              </div>            </details><ol start="8"><li>è¯´è¯´mavençš„ä¾èµ–åŸåˆ™</li></ol><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ol><li>æœ€çŸ­è·¯å¾„åŸåˆ™ï¼ˆä¾èµ–ä¼ é€’çš„è·¯å¾„è¶ŠçŸ­è¶Šä¼˜å…ˆï¼‰</li><li>pomæ–‡ä»¶ç”³æ˜é¡ºåºä¼˜å…ˆï¼ˆè·¯å¾„é•¿åº¦ä¸€æ ·ï¼Œåˆ™å…ˆç”³æ˜çš„ä¼˜å…ˆï¼‰</li><li>è¦†å†™åŸåˆ™ï¼ˆå½“å‰pomæ–‡ä»¶é‡Œç”³æ˜çš„ç›´æ¥è¦†ç›–çˆ¶å·¥ç¨‹ä¼ è¿‡æ¥çš„ï¼‰</li></ol>              </div>            </details><ol start="9"><li>è¯´è¯´ä¾èµ–çš„è§£ææœºåˆ¶</li></ol><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ol><li>è¯»å–POMæ–‡ä»¶ï¼šMavené¦–å…ˆè¯»å–é¡¹ç›®çš„POMæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†é¡¹ç›®ä¾èµ–çš„é…ç½®ä¿¡æ¯ã€‚</li><li>è§£æä¾èµ–åæ ‡ï¼šMavenè§£æPOMæ–‡ä»¶ä¸­çš„ä¾èµ–åæ ‡ï¼ŒåŒ…æ‹¬groupIdã€artifactIdå’Œversionç­‰ä¿¡æ¯ï¼Œè¿™äº›åæ ‡å”¯ä¸€æ ‡è¯†äº†ä¸€ä¸ªä¾èµ–é¡¹ã€‚</li><li>æ£€æŸ¥æœ¬åœ°ä»“åº“ï¼šMavené¦–å…ˆæ£€æŸ¥æœ¬åœ°ä»“åº“ï¼ˆé€šå¸¸ä½äºç”¨æˆ·ç›®å½•çš„.m2ç›®å½•ä¸‹ï¼‰ï¼Œçœ‹æ˜¯å¦å·²ç»å­˜åœ¨æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚å¦‚æœå·²ç»å­˜åœ¨ï¼Œå¹¶ä¸”ç‰ˆæœ¬åŒ¹é…ï¼Œåˆ™ç›´æ¥ä½¿ç”¨æœ¬åœ°ä»“åº“ä¸­çš„ä¾èµ–é¡¹ï¼Œæ— éœ€ä¸‹è½½ã€‚</li><li>ä¸‹è½½ä¾èµ–é¡¹ï¼šå¦‚æœæœ¬åœ°ä»“åº“ä¸­ä¸å­˜åœ¨æ‰€éœ€çš„ä¾èµ–é¡¹ï¼Œæˆ–è€…ç‰ˆæœ¬ä¸åŒ¹é…ï¼ŒMavenä¼šå°è¯•ä»é…ç½®çš„è¿œç¨‹ä»“åº“ï¼ˆå¦‚Mavenä¸­å¤®ä»“åº“ï¼‰ä¸‹è½½ä¾èµ–é¡¹ã€‚Mavenä¼šæ ¹æ®ä¾èµ–åæ ‡æ„å»ºè¿œç¨‹ä»“åº“çš„URLï¼Œä¸‹è½½ç›¸åº”çš„JARæ–‡ä»¶ã€‚</li><li>è§£æä¾èµ–å…³ç³»ï¼šMavenè§£æä¾èµ–é¡¹çš„ä¼ é€’å…³ç³»ã€‚å®ƒä¼šæ£€æŸ¥æ‰€ä¸‹è½½çš„ä¾èµ–é¡¹çš„POMæ–‡ä»¶ï¼Œæ‰¾åˆ°ä»–ä»¬çš„ä¼ é€’ä¾èµ–é¡¹ï¼Œå¹¶é‡å¤ä»¥ä¸Šæ­¥éª¤æ¥è§£æå’Œä¸‹è½½ä¼ é€’ä¾èµ–é¡¹ã€‚</li><li>ç‰ˆæœ¬å†²çªè§£å†³ï¼šå½“å­˜åœ¨å¤šä¸ªä¾èµ–é¡¹çš„ä¸åŒç‰ˆæœ¬æ—¶ï¼ŒMavenä½¿ç”¨å†²çªè§£å†³æœºåˆ¶æ¥ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„ç‰ˆæœ¬ã€‚é€šå¸¸ä¼šé€‰æ‹©è·¯å¾„æœ€çŸ­çš„ä¾èµ–é¡¹ï¼ˆæœ€çŸ­è·¯å¾„åŸåˆ™ï¼‰æˆ–è€…æ ¹æ®POMæ–‡ä»¶ä¸­å£°æ˜é¡ºåºé€‰æ‹©ä¼˜å…ˆçš„ç‰ˆæœ¬ã€‚</li><li>æ„å»ºä¾èµ–æ ‘ï¼šMavenæ ¹æ®è§£æç»“æœæ„å»ºä¸€ä¸ªä¾èµ–æ ‘ï¼Œè¡¨ç¤ºé¡¹ç›®çš„ä¾èµ–å…³ç³»å’Œå±‚æ¬¡ç»“æ„ã€‚è¿™ä¸ªä¾èµ–æ ‘åŒ…æ‹¬ç›´æ¥ä¾èµ–å’Œä¼ é€’ä¾èµ–ã€‚</li><li>ä¼ é€’ä¾èµ–ç®¡ç†ï¼šMavenä¼šå°†è§£æçš„ä¾èµ–é¡¹æ·»åŠ åˆ°é¡¹ç›®çš„ç±»è·¯å¾„ä¸­ï¼Œä»¥ä¾¿åœ¨ç¼–è¯‘ã€æµ‹è¯•å’Œè¿è¡Œæ—¶ä½¿ç”¨ã€‚å®ƒè¿˜ä¼šç®¡ç†ä¼ é€’ä¾èµ–çš„èŒƒå›´å’Œå†²çªè§£å†³ã€‚</li></ol>              </div>            </details> ]]></content>
    
    
    <summary type="html">Mavenç›¸å…³é¢è¯•é¢˜</summary>
    
    
    
    <category term="é¢è¯•é¢˜" scheme="https://cyborg2077.github.io/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
    
    <category term="Maven" scheme="https://cyborg2077.github.io/tags/Maven/"/>
    
  </entry>
  
  <entry>
    <title>Redisé¢è¯•é¢˜</title>
    <link href="https://cyborg2077.github.io/2023/05/07/InQRedis/"/>
    <id>https://cyborg2077.github.io/2023/05/07/InQRedis/</id>
    <published>2023-05-07T11:56:38.000Z</published>
    <updated>2023-10-01T13:43:47.585Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜ï¼Ÿ">ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä½¿ç”¨ç¼“å­˜çš„ç›®çš„å°±æ˜¯æå‡è¯»å†™æ€§èƒ½ã€‚åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæ›´å¤šçš„æ˜¯ä¸ºäº†æå‡è¯»æ€§èƒ½ï¼Œå¸¦æ¥æ›´å¥½çš„æ€§èƒ½å’Œå¹¶å‘é‡ã€‚Redisçš„è¯»å†™æ€§èƒ½æ¯”MySQLå¥½çš„å¤šï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠMySQLä¸­çš„çƒ­ç‚¹æ•°æ®ç¼“å­˜åˆ°Redisï¼Œæå‡è¯»å–æ€§èƒ½ï¼ŒåŒæ—¶å‡è½»äº†MySQLçš„è¯»å–å‹åŠ›ã€‚</li></ul>              </div>            </details><h2 id="ä»€ä¹ˆæ˜¯Redisï¼Ÿ">ä»€ä¹ˆæ˜¯Redisï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å†…å­˜æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºé”®å€¼å­˜å‚¨ç³»ç»Ÿã€‚å®ƒæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆç­‰ï¼Œè¿˜æä¾›äº†ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œå¦‚å‘å¸ƒè®¢é˜…ã€äº‹åŠ¡ã€Luaè„šæœ¬ç­‰ã€‚Redisçš„ç‰¹ç‚¹æ˜¯æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥å¿«é€Ÿè¯»å†™ï¼ŒåŒæ—¶æ”¯æŒæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚Redisè¿˜å…·æœ‰åˆ†å¸ƒå¼ç‰¹æ€§ï¼Œå¯ä»¥é€šè¿‡åˆ†ç‰‡å’Œèµ‹å€¼æ¥å®ç°é«˜å¯ç”¨å’Œé«˜æ‰©å±•æ€§ã€‚</li><li>Redisä¸»è¦åº”ç”¨äºç¼“å­˜ã€ä¼šè¯å­˜å‚¨ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ’è¡Œæ¦œç­‰åœºæ™¯ï¼Œå…·æœ‰å¿«é€Ÿã€ç¨³å®šã€å¯é ç­‰ä¼˜ç‚¹ã€‚ç”±äºå…¶å‡ºè‰²çš„æ€§èƒ½å’Œæ˜“ç”¨æ€§ï¼ŒRediså·²ç»æˆä¸ºæœ€å—æ¬¢è¿çš„å†…å­˜æ•°æ®åº“ä¹‹ä¸€ã€‚</li></ul>              </div>            </details><h2 id="ä½¿ç”¨Redisæœ‰å“ªäº›å¥½å¤„ï¼Ÿ">ä½¿ç”¨Redisæœ‰å“ªäº›å¥½å¤„ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä½¿ç”¨Redisæœ‰ä»¥ä¸‹å‡ ä¸ªå¥½å¤„<ol><li>é«˜æ€§èƒ½ï¼šRediså°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œå¯ä»¥è¾¾åˆ°å‡ åä¸‡ç”šè‡³ä¸Šç™¾ä¸‡QPSï¼Œç‰¹åˆ«é€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚</li><li>æ•°æ®ç»“æ„ä¸°å¯Œï¼šRedisæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆç­‰ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒåœºæ™¯ä¸‹çš„éœ€æ±‚ã€‚</li><li>æŒä¹…åŒ–ï¼šRedisæ”¯æŒå°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œä»¥ä¿è¯æ•°æ®çš„å®‰å…¨æ€§å’Œå¯æ¢å¤æ€§ã€‚</li><li>åˆ†å¸ƒå¼ç‰¹æ€§ï¼šRedisæ”¯æŒåˆ†ç‰‡å’Œå¤åˆ¶ï¼Œå¯ä»¥å®ç°é«˜å¯ç”¨å’Œé«˜æ‰©å±•æ€§ï¼Œæ”¯æŒæ•°æ®åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´çš„å…±äº«ã€‚</li><li>ä¸°å¯Œçš„åŠŸèƒ½ï¼šRedisæä¾›äº†è®¸å¤šé«˜çº§åŠŸèƒ½ï¼Œå¦‚äº‹åŠ¡ã€Luaè„šæœ¬ã€å‘å¸ƒè®¢é˜…ã€è¿‡æœŸç­–ç•¥ç­‰ï¼Œå¯ä»¥æ»¡è¶³æ›´åŠ å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ã€‚</li></ol></li></ul>              </div>            </details><h2 id="ä¸ºä»€ä¹ˆè¦æ˜¯ç”¨Redisè€Œä¸æ˜¯ç”¨Memcachedå‘¢ï¼Ÿ">ä¸ºä»€ä¹ˆè¦æ˜¯ç”¨Redisè€Œä¸æ˜¯ç”¨Memcachedå‘¢ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Rediså’ŒMemcachedéƒ½æ˜¯æµè¡Œçš„å†…å­˜ç¼“å­˜ç³»ç»Ÿï¼Œå®ƒä»¬éƒ½å¯ä»¥åœ¨å†…å­˜ä¸­å¿«é€Ÿè¯»å†™æ•°æ®ï¼Œä½†æ˜¯åœ¨ä¸€äº›æ–¹é¢æœ‰æ‰€ä¸åŒï¼Œä¸‹é¢æ˜¯Redisç›¸è¾ƒäºMemcachedçš„ä¸€äº›ä¼˜ç‚¹<ol><li>æ•°æ®ç»“æ„æ›´ä¸°å¯Œï¼šRedisæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆç­‰ï¼Œè¿™äº›æ•°æ®ç»“æ„å¯ä»¥ç›´æ¥æ˜ å°„åˆ°å®é™…çš„æ•°æ®æ¨¡å‹ä¸­ï¼Œæ–¹ä¾¿ä¸šåŠ¡å¼€å‘å’Œæ•°æ®å¤„ç†ã€‚</li><li>å¤šç§æŒä¹…åŒ–æ–¹å¼ï¼šRedisæ”¯æŒå¤šç§æŒä¹…åŒ–æ–¹å¼ï¼ŒåŒ…æ‹¬å“¦RDBï¼ˆå¿«ç…§ï¼‰å’ŒAOFï¼ˆæ—¥å¿—ï¼‰ï¼Œè¿™äº›æŒä¹…åŒ–æ–¹å¼å¯ä»¥ä¿è¯æ•°æ®çš„å®‰å…¨æ€§å’Œå¯æ¢å¤æ€§ã€‚</li><li>å¤šç§å¤åˆ¶æ–¹å¼ï¼šRedisæ”¯æŒä¸»ä»å¤åˆ¶å’Œå“¨å…µæ¨¡å¼ï¼Œå¯ä»¥å®ç°é«˜å¯ç”¨å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œè€ŒMemcachedåˆ™éœ€è¦é€šè¿‡ç¬¬ä¸‰æ–¹å·¥å…·æ¥å®ç°é«˜å¯ç”¨ã€‚</li><li>æ›´å¥½çš„æ€§èƒ½ï¼šRedisåœ¨è¯»å†™æ€§èƒ½å’Œå¹¶å‘èƒ½åŠ›ä¸Šç›¸è¾ƒäºMemcachedæ›´å¥½ï¼Œå°¤å…¶æ˜¯åœ¨å¤šæ ¸CPUç¯å¢ƒä¸‹ï¼ŒRediså¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸çš„ä¼˜åŠ¿ï¼Œæé«˜ç³»ç»Ÿçš„ååé‡ã€‚</li><li>æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼šRedisæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¦‚äº‹åŠ¡ã€Luaè„šæœ¬ã€å‘å¸ƒè®¢é˜…ã€è¿‡æœŸç­–ç•¥ç­‰ï¼Œå¯ä»¥æ»¡è¶³æ›´åŠ è´Ÿè½½çš„ä¸šåŠ¡éœ€æ±‚ã€‚</li></ol></li></ul>              </div>            </details><h2 id="è¯´è¯´Redisçº¿ç¨‹æ¨¡å‹">è¯´è¯´Redisçº¿ç¨‹æ¨¡å‹</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisé‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„è¯·æ±‚éƒ½ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚è¿™ä¸ªçº¿ç¨‹ä¸»è¦è´Ÿè´£ç½‘ç»œIOã€è¯·æ±‚è§£æã€å‘½ä»¤æ‰§è¡Œå’Œæ•°æ®è¿”å›ç­‰ä¸šåŠ¡ã€‚Rediså†…éƒ¨é€šè¿‡äº‹ä»¶é©±åŠ¨æœºåˆ¶æ¥å®ç°å¼‚æ­¥IOæ“ä½œï¼ŒåŒ…æ‹¬æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ã€‚å…·ä½“æ¥è¯´ï¼ŒRedisåœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼Œæ¥ç›‘å¬å®¢æˆ·ç«¯å¥—æ¥å­—çš„è¯»å†™äº‹ä»¶ï¼Œå¹¶åœ¨äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘å“åº”çš„å›è°ƒå‡½æ•°æ¥å¤„ç†äº‹ä»¶ã€‚</li><li>Rediså•çº¿ç¨‹æ¨¡å‹çš„ä¼˜ç‚¹æ˜¯ä»£ç ç®€æ´ã€æ˜“äºç»´æŠ¤å’Œè°ƒè¯•ï¼ŒåŒæ—¶å¯ä»¥é¿å…å¤šçº¿ç¨‹å¹¶å‘å¸¦æ¥çš„åŒæ­¥å’Œé”çš„é—®é¢˜ã€‚æ­¤å¤–ï¼ŒRedisè¿˜é‡‡ç”¨äº†å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå¯ä»¥å°†å¤šä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚åˆå¹¶åˆ°ä¸€èµ·ï¼Œå‡å°‘IOæ“ä½œçš„æ¬¡æ•°ï¼Œæé«˜ç³»ç»Ÿçš„ååé‡å’Œå“åº”é€Ÿåº¦ã€‚</li><li>å½“ç„¶ï¼ŒRedisçš„å•çº¿ç¨‹æ¨¡å‹ä¹Ÿå­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼Œå¦‚æ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸CPUçš„ä¼˜åŠ¿ï¼Œå®¹æ˜“å—åˆ°å•ç‚¹æ•…éšœçš„å½±å“ç­‰ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒRediså¼•å…¥äº†å¤šä¸ªè¿›ç¨‹å’Œå¤šä¸ªå®ä¾‹çš„æ–¹æ¡ˆï¼Œå¦‚ä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼å’Œé›†ç¾¤æ¨¡å¼ç­‰ã€‚è¿™äº›æ–¹æ¡ˆå¯ä»¥æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œæ‰©å±•æ€§ï¼ŒåŒæ—¶ä¿æŒäº†Redisç®€æ´ã€é«˜æ•ˆçš„ç‰¹ç‚¹ã€‚</li></ul>              </div>            </details><h2 id="ä¸ºä»€ä¹ˆRediså•çº¿ç¨‹æ¨¡å‹æ•ˆç‡ä¹Ÿèƒ½é‚£ä¹ˆé«˜ï¼Ÿ">ä¸ºä»€ä¹ˆRediså•çº¿ç¨‹æ¨¡å‹æ•ˆç‡ä¹Ÿèƒ½é‚£ä¹ˆé«˜ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ol><li>Cè¯­è¨€å®ç°ï¼Œæ•ˆç‡é«˜</li><li>çº¯å†…å­˜æ“ä½œ</li><li>åŸºäºéé˜»å¡çš„IOå¤ç”¨æ¨¡å‹æœºåˆ¶</li><li>å•çº¿ç¨‹çš„è¯å¯ä»¥é¿å…å¤šçº¿ç¨‹çš„é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜</li><li>ä¸°å¯Œçš„æ•°æ®ç»“æ„ï¼Œå…¨ç¨‹é‡‡ç”¨å“ˆå¸Œç»“æ„ï¼Œè¯»å–é€Ÿåº¦éå¸¸å¿«ï¼Œå¯¹æ•°æ®å­˜å‚¨è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼Œä¾‹å¦‚å‹ç¼©è¡¨ã€è·³è¡¨ç­‰ã€‚</li></ol>              </div>            </details><h2 id="ä¸ºä»€ä¹ˆRediséœ€è¦æŠŠæ‰€æœ‰æ•°æ®æ”¾åˆ°å†…å­˜ä¸­ï¼Ÿ">ä¸ºä»€ä¹ˆRediséœ€è¦æŠŠæ‰€æœ‰æ•°æ®æ”¾åˆ°å†…å­˜ä¸­ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisä¹‹æ‰€ä»¥å°†æ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨å†…å­˜ä¸­ï¼Œæ˜¯å› ä¸ºå®ƒè®¾è®¡çš„ç›®æ ‡æ˜¯é«˜æ€§èƒ½ã€é«˜ååé‡å’Œä½å»¶è¿Ÿï¼Œè€Œå†…å­˜è®¿é—®çš„é€Ÿåº¦æ¯”ç£ç›˜è®¿é—®çš„é€Ÿåº¦å¿«å¾ˆå¤šã€‚å¦‚æœæ•°æ®å­˜å‚¨åœ¨ç¡¬ç›˜ä¸­ï¼Œç£ç›˜I/Oä¼šä¸¥é‡å½±å“Redisçš„æ€§èƒ½ã€‚è€Œä¸”Redisè¿˜æä¾›äº†æ•°æ®æŒä¹…åŒ–åŠŸèƒ½ï¼Œä¸ç”¨æ‹…å¿ƒæœåŠ¡å™¨é‡å¯å¯¹å†…å­˜ä¸­æ•°æ®çš„å½±å“ã€‚</li></ul>              </div>            </details><h2 id="Redisçš„åŒæ­¥æœºåˆ¶äº†è§£å—ï¼Ÿ">Redisçš„åŒæ­¥æœºåˆ¶äº†è§£å—ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisæ”¯æŒä¸»ä»åŒæ­¥å’Œä»ä»åŒæ­¥ï¼Œè€Œåœ¨è¿›è¡Œç¬¬ä¸€æ¬¡ä¸»ä»åŒæ­¥æ—¶ï¼Œéœ€è¦ç°åœ¨ä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡ŒBGSAVEå‘½ä»¤ï¼Œå°†å½“å‰å†…å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–é“ç£ç›˜ä¸Šç”ŸæˆRDBæ–‡ä»¶ï¼Œå¹¶ä¸”å°†ä¸»èŠ‚ç‚¹éœ€è¦å°†åç»­ä¿®æ”¹æ“ä½œè®°å½•åˆ°å†…å­˜ç¼“å†²åŒºä¸­ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¼šå°†ç”Ÿæˆçš„RDBæ–‡ä»¶å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¥æ”¶å¹¶åŠ è½½RDBæ–‡ä»¶åˆ°è‡ªå·±çš„å†…å­˜ä¸­ã€‚åŠ è½½å®Œæˆåï¼Œä»èŠ‚ç‚¹ä¼šé€šçŸ¥ä¸»èŠ‚ç‚¹ï¼Œå°†ä¸»èŠ‚ç‚¹åœ¨å¤åˆ¶æœŸé—´äº§ç”Ÿçš„å‘½ä»¤åŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œä»¥æ­¤å®Œæˆä¸»ä»åŒæ­¥è¿‡ç¨‹ã€‚</li></ul>              </div>            </details><h2 id="pipelineæœ‰ä»€ä¹ˆå¥½å¤„ï¼Œä¸ºä»€ä¹ˆè¦æ˜¯ç”¨Pipelineï¼Ÿ">pipelineæœ‰ä»€ä¹ˆå¥½å¤„ï¼Œä¸ºä»€ä¹ˆè¦æ˜¯ç”¨Pipelineï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä½¿ç”¨Pipelineçš„å¥½å¤„åœ¨äºå¯ä»¥å°†å¤šæ¬¡I/Oå¾€è¿”çš„æ—¶é—´ç¼©çŸ­ä¸ºä¸€æ¬¡ï¼Œä»è€Œæé«˜Redisçš„ååé‡å’Œæ€§èƒ½ã€‚Pipelineå…è®¸å®¢æˆ·ç«¯å°†å¤šä¸ªRediså‘½ä»¤æ‰“åŒ…æˆä¸€æ¬¡è¯·æ±‚å‘é€ç»™RedisæœåŠ¡å™¨ï¼ŒRedisæœåŠ¡å™¨æ”¶åˆ°åï¼Œå°†å¤šä¸ªå‘½ä»¤æŒ‰é¡ºåºæ‰§è¡Œï¼Œå¹¶å°†æ‰§è¡Œç»“æœæŒ‰ç…§è¯·æ±‚çš„é¡ºåºè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ ·å°±é¿å…äº†æ¯æ¬¡è¯·æ±‚éƒ½è¦è¿›è¡Œç½‘ç»œé€šä¿¡çš„å¼€é”€ã€‚</li></ul>              </div>            </details><h2 id="è¯´ä¸€ä¸‹Redisæœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ">è¯´ä¸€ä¸‹Redisæœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä¼˜ç‚¹ï¼š<ol><li>é«˜æ€§èƒ½ï¼šRedisä½¿ç”¨Cè¯­è¨€ç¼–å†™ï¼Œé‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹ï¼Œå°†æ•°æ®å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒåŠ ä¸Šå¼‚æ­¥I/Oå’Œæ—¶é—´é©±åŠ¨æœºåˆ¶ç­‰ä¼˜åŒ–ï¼Œä½¿å¾—Redisåœ¨è¯»å†™æ•°æ®æ—¶çš„æ€§èƒ½éå¸¸é«˜ã€‚</li><li>æ•°æ®ç»“æ„ä¸°å¯Œï¼šRedisæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå¦‚å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å“ˆå¸Œè¡¨ã€é›†åˆã€æœ‰åºé›†åˆç­‰ï¼Œè¿™äº›æ•°æ®ç»“æ„å¯ä»¥æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ã€‚</li><li>æŒä¹…åŒ–æœºåˆ¶ï¼šRedisæä¾›äº†ä¸¤å¼ æŒä¹…åŒ–æœºåˆ¶ï¼Œå³RDBå’ŒAOFï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œä¿è¯äº†æ•°æ®çš„å¯é æ€§å’Œå®‰å…¨æ€§ã€‚</li><li>é«˜å¯ç”¨æ€§ï¼šRedisæä¾›äº†ä¸»ä»å¤åˆ¶å’ŒSentinelæœºåˆ¶ï¼Œå¯ä»¥å®ç°æ•°æ®çš„é«˜å¯ç”¨æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚</li></ol></li><li>ç¼ºç‚¹ï¼š<ol><li>å†…å­˜å—é™ï¼šRediså°†æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼Œä¼šå—åˆ°å†…å­˜å¤§å°çš„é™åˆ¶ï¼Œä¸é€‚åˆå­˜å‚¨å¤§è§„æ¨¡æ•°æ®ã€‚</li><li>æŒä¹…åŒ–æœºåˆ¶å¯èƒ½å¸¦æ¥æ€§èƒ½æŸå¤±ï¼šç”±äºRedisæä¾›äº†æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®éœ€è¦åŒæ­¥åˆ°ç£ç›˜ä¸Šï¼ŒçœŸä¼šå¯¼è‡´å†™å…¥æ€§èƒ½çš„ä¸‹é™ã€‚</li><li>å•çº¿ç¨‹æ¨¡å‹å¯èƒ½å­˜åœ¨ç“¶é¢ˆï¼šå°½ç®¡Redisé‡‡ç”¨äº†å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯åœ¨æç«¯æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°æ€§èƒ½ç“¶é¢ˆï¼Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚</li><li>ä¸æ”¯æŒå¤šæœºæ•°æ®å…±äº«ï¼šRedisä¸æ”¯æŒå¤šæœºæ•°æ®å…±äº«ï¼Œéœ€è¦ä½¿ç”¨å…¶ä»–æŠ€æœ¯å¦‚ä¸»ä»å¤åˆ¶å’ŒSentinelæœºåˆ¶æ¥å®ç°é«˜å¯ç”¨æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚</li></ol></li></ul>              </div>            </details><h2 id="Redisç¼“å­˜åˆ·æ–°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ">Redisç¼“å­˜åˆ·æ–°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisæä¾›äº†ä»¥ä¸‹å‡ ç§ç¼“å­˜åˆ·æ–°ç­–ç•¥<ol><li>åŸºäºè¿‡æœŸæ—¶é—´ï¼šå¯ä»¥è®¾ç½®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå½“è¿‡æœŸæ—¶é—´åˆ°è¾¾åï¼ŒRedisä¼šè‡ªåŠ¨åˆ é™¤è¯¥keyã€‚</li><li>åŸºäºLRUç®—æ³•ï¼šRedisä½¿ç”¨LRUç®—æ³•æ¥æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„keyï¼Œä»¥ä¿ç•™çƒ­ç‚¹æ•°æ®ã€‚</li><li>åŸºäºLFUç®—æ³•ï¼šRedisä½¿ç”¨LFUç®—æ³•æ¥æ·˜æ±°æœ€ä¸ç»å¸¸ä½¿ç”¨çš„keyï¼Œä»¥ä¿ç•™çƒ­ç‚¹æ•°æ®ã€‚</li><li>åŸºäºæ‰‹åŠ¨åˆ·æ–°ï¼šå¯ä»¥æ‰‹åŠ¨åˆ é™¤ç¼“å­˜ä¸­çš„keyï¼Œæˆ–è€…é€šè¿‡å‘é€é€šçŸ¥æ¥é€šçŸ¥å®¢æˆ·ç«¯åˆ é™¤keyã€‚</li><li>åŸºäºå®šæ—¶åˆ·æ–°ï¼šå¯ä»¥å®šæ—¶æ¸…ç©ºç¼“å­˜ï¼Œæˆ–è€…å®šæ—¶åˆ·æ–°ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œä»¥ä¿æŒæ•°æ®çš„åŠæ—¶æ€§ã€‚</li></ol></li></ul>              </div>            </details><h2 id="RedisæŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›ï¼Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ">RedisæŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›ï¼Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisæä¾›ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼šRDBå’ŒAOFã€‚</li><li>RDB(Redis DataBase)æŒä¹…åŒ–ï¼šä¼šå°†Redisåœ¨å†…å­˜ä¸­çš„æ•°æ®å¿«ç…§ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼Œå½¢æˆä¸€ä¸ªRDBæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«äº†Redisåœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„æ•°æ®å¿«ç…§<ul><li>ä¼˜ç‚¹ï¼š<ol><li>åªæœ‰ä¸€ä¸ªdump.rdbæ–‡ä»¶ï¼Œæ–¹ä¾¿æŒä¹…åŒ–</li><li>å®¹ç¾æ€§å¥½ï¼Œä¸€ä¸ªæ–‡ä»¶å¯ä»¥ä¿å­˜åˆ°å®‰å…¨çš„ç£ç›˜ã€‚</li><li>æ€§èƒ½æœ€å¤§åŒ–ï¼Œforkå­è¿›ç¨‹æ¥å®Œæˆå†™æ“ä½œï¼Œè®©ä¸»è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤ï¼ŒI/Oæœ€å¤§åŒ–</li><li>æ•°æ®é›†è¾ƒå¤§æ—¶ï¼Œæ¯”AOFçš„å¯åŠ¨æ•ˆç‡æ›´é«˜ã€‚</li></ol></li><li>ç¼ºç‚¹ï¼š<ol><li>æ•°æ®å®‰å…¨æ€§è¾ƒä½ï¼ŒRDBæ˜¯é—´éš”ä¸€æ®µæ—¶é—´è¿›è¡ŒæŒä¹…åŒ–ï¼Œå¦‚æœæŒä¹…åŒ–ä¹‹é—´Rediså‘ç”Ÿæ•…éšœï¼Œä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±ï¼Œå› æ­¤è¿™ç§æ–¹å¼æ›´é€‚åˆæ•°æ®è¦æ±‚ä¸ä¸¥è°¨çš„æ—¶å€™ã€‚</li></ol></li></ul></li><li>AOF(Append Only File)æŒä¹…åŒ–ï¼šæ˜¯å°†Rediså†™æ“ä½œè®°å½•åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ¯æ¬¡Redisæ‰§è¡Œä¸€æ¡å†™å‘½ä»¤ï¼Œå°±å°†è¯¥å‘½ä»¤å†™å…¥AOFæ–‡ä»¶ä¸­ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯æ¡å‘½ä»¤éƒ½èƒ½è¢«ä¿å­˜ä¸‹æ¥ã€‚AOFæ–‡ä»¶å¯ä»¥è¿›è¡Œè¿½åŠ å’Œé‡å†™æ“ä½œï¼Œå½“æ–‡ä»¶å¤ªå¤§æ—¶ï¼ŒRedisä¼šè‡ªåŠ¨è¿›è¡Œé‡å†™ï¼Œå°†å¤šæ¬¡ä¿®æ”¹åˆå¹¶æˆä¸€æ¡ï¼Œä»¥å‡å°‘ç£ç›˜å ç”¨ç©ºé—´ã€‚<ul><li>ä¼˜ç‚¹ï¼š<ol><li>æ•°æ®å®‰å…¨ï¼šAOFæŒä¹…åŒ–å¯ä»¥é…ç½®<code>appendfsync</code>å±æ€§ï¼Œå®ƒå¯ä»¥æŒ‡å®šAOFæ–‡ä»¶çš„åˆ·ç›˜ç­–ç•¥ã€‚é»˜è®¤æƒ…å†µä¸‹<code>appendfsync</code>çš„å€¼ä¸º<code>everysec</code>ã€‚å³æ¯ç§’ä¸­å°†AOFç¼“å­˜ä¸­çš„æ•°æ®å†™å…¥ç£ç›˜ä¸€æ¬¡ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥å°†<code>appendfsync</code>çš„å€¼è®¾ç½®ä¸º<code>always</code>ï¼Œè¿™æ ·æ¯æ¬¡æ‰§è¡Œå†™æ“ä½œéƒ½ä¼šç«‹å³å°†AOFç¼“å­˜ä¸­çš„æ•°æ®å†™å…¥ç£ç›˜ã€‚è¿™æ ·å³ä½¿Rediså‘ç”Ÿå¼‚å¸¸æƒ…å†µã€‚åªè¦AOFæ–‡ä»¶ä¸­å·²ç»è®°å½•äº†ç›¸åº”çš„å†™æ“ä½œï¼Œå°±å¯ä»¥é€šè¿‡AOFæ–‡ä»¶æ¥æ¢å¤æ•°æ®ã€‚</li><li>æ•°æ®ä¸€è‡´æ€§ï¼šAOFæŒä¹…åŒ–æ˜¯é€šè¿‡appendæ¨¡å¼å†™å…¥æ–‡ä»¶çš„ï¼Œå³æ¯æ¬¡å†™æ“ä½œéƒ½æ˜¯è¿½åŠ åˆ°AOFæ–‡ä»¶æœ«å°¾ã€‚å› æ­¤ï¼Œå³ä½¿Redisåœ¨å†™å…¥AOFæ–‡ä»¶çš„è¿‡ç¨‹ä¸­å®•æœºï¼ŒAOFæ–‡ä»¶ä¹Ÿä¸ä¼šæŸåï¼Œè€Œæ˜¯åªä¼šä¸¢å¤±ä¸€éƒ¨åˆ†çš„æ•°æ®ã€‚å½“Redisé‡æ–°å¯åŠ¨æ˜¯ï¼Œä¼šé€šè¿‡redis-check-aofå·¥å…·å°†AOFæ–‡ä»¶ä¸­ä¸ä¸€è‡´çš„æ•°æ®è¿›è¡Œä¿®å¤ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨AOFæŒä¹…åŒ–æ—¶ï¼Œå¦‚æœRedisé¢‘ç¹æ‰§è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆAOFæ–‡ä»¶å¯èƒ½ä¼šéå¸¸å¤§ï¼Œå¯èƒ½å½±å“æ€§èƒ½ã€‚å› æ­¤ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡é…ç½®AOFé‡å†™è§„åˆ™ï¼Œå®šæœŸå¯¹AOFæ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼Œä»¥å‡å°æ–‡ä»¶å¤§å°ã€‚</li></ol></li><li>ç¼ºç‚¹ï¼š<ol><li>AOFæ–‡ä»¶æ¯”RDBæ–‡ä»¶å¤§ï¼Œä¸”æ¢å¤é€Ÿåº¦æ…¢ã€‚</li><li>æ•°æ®é›†è¾ƒå¤§æ—¶ï¼Œæ¯”RDBå¯åŠ¨æ•ˆç‡ä½ã€‚</li></ol></li></ul></li><li>Redisæ”¯æŒåŒæ—¶ä½¿ç”¨RDBå’ŒAOFæŒä¹…åŒ–æœºåˆ¶ã€‚åœ¨ä½¿ç”¨æ—¶ï¼ŒRedisä¼šå…ˆå°è¯•ä½¿ç”¨AOFæ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œå¦‚æœAOFæ–‡ä»¶ä¸å­˜åœ¨æˆ–è€…æ¢å¤å¤±è´¥ï¼ŒRedisä¼šå°è¯•ä½¿ç”¨RDBæ–‡ä»¶æ¥æ¢å¤æ•°æ®ã€‚åŒæ—¶ä½¿ç”¨ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶å¯ä»¥åœ¨ä¿è¯æ•°æ®å®Œæ•´æ€§çš„åŒæ—¶æé«˜æ¢å¤é€Ÿåº¦ã€‚</li></ul>              </div>            </details><h2 id="æŒä¹…åŒ–æœ‰ä¸¤ç§ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆé€‰æ‹©å‘¢ï¼Ÿ">æŒä¹…åŒ–æœ‰ä¸¤ç§ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆé€‰æ‹©å‘¢ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ol><li>ä¸è¦ä»…ä»…ä½¿ç”¨RDBï¼Œå› ä¸ºé‚£æ ·ä¼šå¯¼è‡´ä¸¢å¤±å¾ˆå¤šæ•°æ®ã€‚è™½ç„¶RDBæŒä¹…åŒ–æœºåˆ¶çš„å¿’ä½†æ˜¯å¯ä»¥ç”Ÿæˆæ•°æ®çš„å¿«ç…§ï¼Œè¿™æ ·åœ¨æ¢å¤æ•°æ®çš„æ—¶å€™éå¸¸å¿«é€Ÿã€‚ä½†æ˜¯RDBæŒä¹…åŒ–åªåœ¨å‘ç”Ÿæ•…éšœæ—¶æ‰§è¡Œï¼Œå¦‚æœRediså´©æºƒæˆ–æ„å¤–å…³é—­ï¼Œå¯èƒ½ä¼šä¸¢å¤±æœ€è¿‘æ‰§è¡Œçš„ä¸€äº›å‘½ä»¤ã€‚å› æ­¤ï¼Œå»ºè®®ä½¿ç”¨AOFæŒä¹…åŒ–æ¥è®°å½•Redisæ‰§è¡Œçš„æ‰€æœ‰å†™æ“ä½œï¼Œå¹¶å°†RDBæŒä¹…åŒ–ç”¨äºå†·å¤‡ã€‚</li><li>ä¹Ÿä¸è¦ä»…ä»…ä½¿ç”¨AOFï¼Œè™½ç„¶AOFæŒä¹…åŒ–æœºåˆ¶å¯ä»¥è®°å½•Redisæ‰§è¡Œçš„æ‰€æœ‰å†™æ“ä½œï¼Œå› æ­¤åœ¨æ•°æ®æ¢å¤æ–¹é¢ä¼šæ¯”RDBæ›´åŠ å¥å£®ï¼Œä½†æ˜¯å®ƒä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚å¦‚æœä»…ä½¿ç”¨AOFè¿›è¡Œå†·å¤‡ï¼Œé‚£ä¹ˆåœ¨æ¢å¤æ•°æ®æ—¶ï¼Œå®ƒå¯èƒ½ä¼šæ¯”RDBæŒä¹…åŒ–æ…¢ã€‚å¦‚æœåªä½¿ç”¨AOFæŒä¹…åŒ–ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå› ä¸ºAOFæ–‡ä»¶è¿‡å¤§å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li><li>Redisæ”¯æŒåŒæ—¶ä½¿ç”¨AOFå’ŒRDBæŒä¹…åŒ–æœºåˆ¶ã€‚ä½¿ç”¨AOFæŒä¹…åŒ–å¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œå¹¶ä½œä¸ºæ•°æ®æ¢å¤çš„é¦–é€‰ï¼Œä½¿ç”¨RDBæŒä¹…åŒ–ä½œä¸ºå†·å¤‡ï¼Œä»¥æä¾›å¿«é€Ÿæ•°æ®æ¢å¤é€‰é¡¹ã€‚è¿™ç§æ–¹å¼å¯ä»¥åˆ©ç”¨AOFå’ŒRDBæŒä¹…åŒ–æœºåˆ¶çš„ä¼˜ç‚¹æ¥æé«˜æ•°æ®å®‰å…¨æ€§å’Œæ¢å¤é€Ÿåº¦ã€‚</li><li>å¦‚æœåŒæ—¶ä½¿ç”¨RDBå’ŒAOFæŒä¹…åŒ–æœºåˆ¶ï¼Œåœ¨Redisé‡å¯æ—¶ï¼Œä¼šä½¿ç”¨AOFæ¥é‡æ„æ•°æ®ï¼Œå› ä¸ºAOFä¸­çš„æ•°æ®æ›´åŠ å®Œæ•´ã€‚</li></ol>              </div>            </details><h2 id="æ€ä¹ˆä½¿ç”¨Rediså®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ">æ€ä¹ˆä½¿ç”¨Rediså®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Rediså¯ä»¥ä½¿ç”¨listç»“æ„ä½œä¸ºé˜Ÿåˆ—æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½¿ç”¨rpushç”Ÿäº§æ¶ˆæ¯ï¼Œä½¿ç”¨lpopæ¶ˆè´¹æ¶ˆæ¯ã€‚å½“lpopæ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œéœ€è¦é€‚å½“çš„sleepä¸€ä¼šå„¿å†é‡è¯•ã€‚ä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨blpopå‘½ä»¤æ¥é˜»å¡ä½ï¼Œç›´åˆ°æ¶ˆæ¯åˆ°æ¥ï¼Œé¿å…äº†sleepæ“ä½œã€‚</li><li>å¦‚æœéœ€è¦å®ç°ç”Ÿäº§ä¸€æ¬¡æ¶ˆè´¹å¤šæ¬¡çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨pub/subä¸»é¢˜è®¢é˜…è€…æ¨¡å¼ï¼Œå®ç°<code>1:N</code>çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li>ä½†æ˜¯pub/subçš„ç¼ºç‚¹æ˜¯åœ¨æ¶ˆè´¹è€…ä¸‹çº¿çš„æƒ…å†µä¸‹ï¼Œç”Ÿäº§çš„æ¶ˆæ¯ä¼šä¸¢å¤±ã€‚å› æ­¤ï¼Œå¦‚æœéœ€è¦æ›´å¯é çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéœ€è¦ä½¿ç”¨ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¾‹å¦‚RabbitMQã€‚</li><li>æ­¤å¤–ï¼ŒRedisè¿˜å¯ä»¥ä½¿ç”¨sortedsetç»“æ„æ¥å®ç°å»¶æ—¶é˜Ÿåˆ—ã€‚ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºscoreï¼Œæ¶ˆæ¯å†…å®¹ä½œä¸ºkeyï¼Œè°ƒç”¨zaddæ¥ç”Ÿäº§æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…å¯ä»¥ä½¿ç”¨zrangebyscoreæŒ‡ä»¤è·å–Nç§’ä¹‹å‰çš„æ•°æ®ï¼Œç„¶åè½®è¯¢è¿›è¡Œå¤„ç†ã€‚</li></ul>              </div>            </details><h2 id="è¯´è¯´ä½ å¯¹Redisäº‹åŠ¡çš„ç†è§£">è¯´è¯´ä½ å¯¹Redisäº‹åŠ¡çš„ç†è§£</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä»€ä¹ˆæ˜¯Redisäº‹åŠ¡ï¼Ÿ<ul><li>Redisä¸­çš„äº‹åŠ¡æ˜¯ä¸€ç»„å‘½ä»¤çš„é›†åˆï¼Œæ˜¯Redisçš„æœ€å°æ‰§è¡Œå•ä½ã€‚å®ƒå¯ä»¥ä¿è¯ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œæ¯ä¸ªäº‹åŠ¡æ˜¯ä¸€ä¸ªå•ç‹¬çš„éš”ç¦»æ“ä½œï¼Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«åºåˆ—åŒ–ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œï¼ŒæœåŠ¡ç«¯åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤è¯·æ±‚æ‰“æ–­ã€‚Redisäº‹åŠ¡é€šè¿‡MULTIã€EXECã€DISCARDã€WATCHç­‰å‘½ä»¤æ¥å®ç°çš„ã€‚</li></ul></li></ul><table><thead><tr><th style="text-align:center">å‘½ä»¤</th><th style="text-align:center">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:center">MULTI</td><td style="text-align:center">å¼€å¯ä¸€ä¸ªäº‹åŠ¡</td></tr><tr><td style="text-align:center">EXEC</td><td style="text-align:center">æäº¤äº‹åŠ¡ï¼Œä»å‘½ä»¤é˜Ÿåˆ—ä¸­å–å‡ºæäº¤çš„æ“ä½œå‘½ä»¤ï¼Œè¿›è¡Œå®é™…æ‰§è¡Œ</td></tr><tr><td style="text-align:center">DISCARD</td><td style="text-align:center">æ”¾å¼ƒä¸€ä¸ªäº‹åŠ¡ï¼Œæ¸…ç©ºå‘½ä»¤é˜Ÿåˆ—</td></tr><tr><td style="text-align:center">WATCH</td><td style="text-align:center">æ£€æµ‹ä¸€ä¸ªæˆ–å¤šä¸ªé”®çš„å€¼åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡æ”¾å¼ƒæ‰§è¡Œ</td></tr></tbody></table><ul><li>Redisäº‹åŠ¡çš„æ³¨æ„ç‚¹æœ‰å“ªäº›ï¼Ÿ<ol><li>Redisäº‹åŠ¡æ˜¯ä¸æ”¯æŒå›æ»šçš„ã€‚</li><li>RedisæœåŠ¡ç«¯åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤è¯·æ±‚æ‰“æ–­ï¼Œç›´åˆ°äº‹åŠ¡å‘½ä»¤å…¨éƒ¨æ‰§è¡Œå®Œæ¯•æ‰ä¼šæ‰§è¡Œå…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚</li></ol></li><li>Redisäº‹åŠ¡ä¸ºä»€ä¹ˆä¸æ”¯æŒå›æ»šï¼Ÿ<ul><li>Redisçš„äº‹åŠ¡ä¸æ”¯æŒå›æ»šï¼Œä½†æ˜¯æ‰§è¡Œçš„å‘½ä»¤å¦‚æœæœ‰è¯­æ³•é”™è¯¯ï¼ŒRedisä¼šæ‰§è¡Œå¤±è´¥ï¼Œè¿™äº›é—®é¢˜å¯ä»¥ä»ç¨‹åºå±‚é¢æ•è·å¹¶è§£å†³ã€‚ä½†æ˜¯å¦‚æœå‡ºç°å…¶ä»–é—®é¢˜ï¼Œåˆ™ä¾ç„¶ä¼šç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„å‘½ä»¤ã€‚è¿™æ ·åšçš„åŸå› æ˜¯å› ä¸ºå›æ»šéœ€è¦å¢åŠ å¾ˆå¤šå·¥ä½œï¼Œè€Œä¸æ”¯æŒå›æ»šå¯ä»¥ä¿æŒç®€å•ã€å¿«é€Ÿçš„ç‰¹æ€§ã€‚</li></ul></li></ul>              </div>            </details><h2 id="Redisä¸ºä»€ä¹ˆè®¾è®¡æˆå•çº¿ç¨‹çš„ï¼Ÿ">Redisä¸ºä»€ä¹ˆè®¾è®¡æˆå•çº¿ç¨‹çš„ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisçš„å•çº¿ç¨‹è®¾è®¡æ˜¯å…¶é«˜æ€§èƒ½çš„é‡è¦åŸå› ä¹‹ä¸€ã€‚Rediså•çº¿ç¨‹çš„è®¾è®¡æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†é¿å…å¤šçº¿ç¨‹å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€é”ç«äº‰ç­‰å¼€é”€ã€‚ä»è€Œæé«˜Redisçš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</li><li>å…·ä½“æ¥è¯´ï¼ŒRediså•çº¿ç¨‹çš„è®¾è®¡ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„è€ƒè™‘ï¼š<ol><li>é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ä¼šæ¶‰åŠåˆ°ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œè¿™ä¸ªåˆ‡æ¢æœ¬èº«å°±å°±ä¼šæ¶ˆè€—CPUèµ„æºå’Œæ—¶é—´ã€‚è€ŒRediså•çº¿ç¨‹çš„è®¾è®¡å¯ä»¥é¿å…è¿™ç§ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œä»è€Œæé«˜Redisçš„æ€§èƒ½ã€‚</li><li>é¿å…é”ç«äº‰ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«æ•°æ®æ—¶éœ€è¦ä½¿ç”¨é”æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚è€Œæ‰€æœ¬èº«ä¹Ÿä¼šå¸¦æ¥å¼€é”€å’Œç«äº‰ï¼Œé™ä½Redisçš„æ•ˆç‡å’Œæ€§èƒ½ã€‚è€ŒRediså•çº¿ç¨‹çš„è®¾è®¡å¯ä»¥é¿å…è¿™ç§é”ç«äº‰çš„å¼€é”€ï¼Œä»è€Œæé«˜Redisçš„æ€§èƒ½ã€‚</li><li>å‡å°‘å†…å­˜åˆ†é…ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œçº¿ç¨‹ä¹‹é—´éœ€è¦å…±äº«å†…å­˜ï¼Œè€Œå†…å­˜å…±äº«ä¼šæ¶‰åŠåˆ°å†…å­˜åˆ†é…å’Œç®¡ç†çš„å¼€é”€ã€‚è€ŒRediså•çº¿ç¨‹çš„è®¾è®¡å¯ä»¥é¿å…è¿™ç§å†…å­˜åˆ†é…çš„å¼€é”€ï¼Œä»è€Œæé«˜Redisçš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</li></ol></li></ul>              </div>            </details><h2 id="ä»€ä¹ˆæ˜¯Bigkeyï¼Ÿä¼šå­˜åœ¨ä»€ä¹ˆå½±å“ï¼Ÿ">ä»€ä¹ˆæ˜¯Bigkeyï¼Ÿä¼šå­˜åœ¨ä»€ä¹ˆå½±å“ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>BigkeyæŒ‡çš„æ˜¯Redisä¸­çš„å¤§é”®ï¼Œå³å ç”¨å†…å­˜è¾ƒå¤šçš„é”®å€¼å¯¹ã€‚é€ æˆçš„å½±å“å¦‚ä¸‹ï¼š<ol><li>å†…å­˜å ç”¨ï¼šBigkeyä¼šå ç”¨å¤§é‡çš„å†…å­˜èµ„æºï¼Œå¯¼è‡´Rediså†…å­˜ä¸è¶³ï¼Œä»è€Œå½±å“Redisçš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚</li><li>ç½‘ç»œä¼ è¾“ï¼šBigkeyä¼šå¢åŠ ç½‘ç»œä¼ è¾“çš„è´Ÿæ‹…ï¼Œå› ä¸ºåœ¨è¿›è¡Œæ•°æ®å¤‡ä»½å’Œå¤åˆ¶çš„æ—¶å€™ï¼Œéœ€è¦å°†Bigkeyçš„æ•°æ®å…¨éƒ¨ä¼ è¾“ï¼Œä»è€Œå¢åŠ äº†ç½‘ç»œå¸¦å®½çš„ä½¿ç”¨ã€‚</li><li>è¶…æ—¶é˜»å¡ï¼šç”±äºBigkeyå ç”¨çš„ç©ºé—´è¾ƒå¤§ï¼Œæ‰€ä»¥Redisåœ¨å¯¹å…¶æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šæ¶ˆè€—è¿‡é•¿çš„æ—¶é—´ï¼Œå¯¼è‡´å®¢æˆ·ç«¯è¶…æ—¶é˜»å¡ã€‚å› ä¸ºRedisé‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹ï¼Œå½“å¤„ç†ä¸€ä¸ªå¤§keyæ—¶ï¼Œå…¶ä»–è¯·æ±‚å¿…é¡»ç­‰å¾…è¯¥æ“ä½œå®Œæˆåæ‰èƒ½æ‰§è¡Œï¼Œè€Œè¿™ä¸ªæ“ä½œå¯èƒ½ä¼šéœ€è¦è¾ƒé•¿çš„æ—¶é—´ï¼Œä»è€Œå¯¼è‡´é˜»å¡ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œå¯ä»¥å¯¹bigkeyè¿›è¡Œæ‹†åˆ†æˆ–ä¼˜åŒ–ã€‚</li><li>å†…å­˜ç¢ç‰‡ï¼šBigkeyä¼šå¯¼è‡´Redisä¸­å‡ºç°å†…å­˜ç¢ç‰‡ï¼Œä»è€Œå½±å“Redisçš„å†…å­˜ä½¿ç”¨æ•ˆç‡ï¼Œå¯¼è‡´Rediså†…å­˜å ç”¨ç‡ä¸Šå‡ã€‚</li></ol></li></ul>              </div>            </details> <h2 id="è¯´è¯´Rediså“ˆå¸Œæ§½çš„æ¦‚å¿µ">è¯´è¯´Rediså“ˆå¸Œæ§½çš„æ¦‚å¿µ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Rediså“ˆå¸Œæ§½æ˜¯Redisé›†ç¾¤ä¸­ç”¨æ¥å®ç°æ•°æ®åˆ†ç‰‡çš„ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å°†æ‰€æœ‰çš„é”®å‡åŒ€åœ°åˆ†å¸ƒåˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œä»¥å®ç°é«˜å¯ç”¨å’Œé«˜æ€§èƒ½åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨ã€‚</li><li>å…·ä½“æ¥è¯´ï¼ŒRedisé›†ç¾¤å°†æ•´ä¸ªæ•°æ®é›†åˆ†ä¸º16384ä¸ªå“ˆå¸Œæ§½ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å…¶ä¸­çš„ä¸€éƒ¨åˆ†å“ˆå¸Œæ§½ï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šè¿‡Gossipåè®®è¿›è¡Œé€šä¿¡ï¼Œç»´æŠ¤æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯æƒ³è¦è®¿é—®ä¸€ä¸ªé”®æ—¶ï¼ŒRedisä¼šæ ¹æ®é”®åè®¡ç®—å‡ºè¯¥é”®å¯¹åº”çš„å“ˆå¸Œå€¼ï¼Œç„¶åæ‰¾åˆ°å“ˆå¸Œæ§½çš„ç¼–å·ï¼Œå†æ ¹æ®å“ˆå¸Œæ§½çš„æ˜ å°„å…³ç³»ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°å¯¹åº”èŠ‚ç‚¹ä¸Šã€‚</li></ul>              </div>            </details><h2 id="Rediså¸¸è§æ€§èƒ½é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ">Rediså¸¸è§æ€§èƒ½é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ol><li>ç½‘ç»œå»¶è¿Ÿï¼šRedisçš„æ€§èƒ½å¾ˆå¤§ç¨‹åº¦ä¸Šå—é™äºç½‘ç»œå»¶è¿Ÿï¼Œå› æ­¤éœ€è¦å°½å¯èƒ½å‡å°‘ç½‘ç»œä¼ è¾“æ¬¡æ•°å’Œæ•°æ®é‡ï¼Œé¿å…è¿‡å¤šçš„ç½‘ç»œIOæ“ä½œ<ul><li>è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥ä½¿ç”¨Redisçš„Piplineç‰¹æ€§ï¼Œå°†å¤šä¸ªè¯·æ±‚æ‰“åŒ…å‘é€ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“çš„æ¬¡æ•°ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨Redisçš„æ‰¹é‡æ“ä½œå‘½ä»¤ï¼Œå°†å¤šä¸ªæ•°æ®ä¸€æ¬¡æ€§æäº¤ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡ã€‚</li></ul></li><li>å¤§é‡çš„æ•°æ®è¯»å†™ï¼šRedisçš„å•çº¿ç¨‹æ¨¡å‹ä¼šåœ¨é«˜å¹¶å‘è¯»å†™çš„æƒ…å†µä¸‹å‡ºç°æ€§èƒ½ç“¶é¢ˆï¼Œå¯¼è‡´å“åº”æ—¶é—´å˜é•¿ã€‚<ul><li>è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥ä½¿ç”¨Redisçš„ä¸»ä»å¤åˆ¶å’Œé›†ç¾¤ç‰¹æ€§ï¼Œå°†æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¢åŠ ç³»ç»Ÿçš„è¯»å†™å¹¶å‘èƒ½åŠ›ã€‚</li></ul></li><li>æ…¢æŸ¥è¯¢ï¼šå½“Redisä¸­å­˜åœ¨å¤§é‡æ…¢æŸ¥è¯¢æ“ä½œæ—¶ï¼Œä¼šå½±å“Redisçš„æ•´ä½“æ€§èƒ½ã€‚<ul><li>è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥ä½¿ç”¨Redisçš„slowlogåŠŸèƒ½ï¼Œè®°å½•Redisçš„æ…¢æŸ¥è¯¢æ“ä½œï¼Œå¹¶ä½¿ç”¨Redisçš„ç›‘æ§å·¥å…·è¿›è¡Œç›‘æ§ï¼ŒåŠæ—¶å‘ç°æ…¢æŸ¥è¯¢é—®é¢˜ã€‚</li></ul></li><li>å†…å­˜ä½¿ç”¨è¿‡å¤šï¼šRediséœ€è¦å°†æ‰€æœ‰çš„æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå½“æ•°æ®é‡è¿‡å¤§æ—¶ï¼Œä¼šå ç”¨å¤§é‡çš„å†…å­˜èµ„æºï¼Œå¯¼è‡´Redisçš„æ€§èƒ½ä¸‹é™ã€‚<ul><li>è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥ä½¿ç”¨Redisçš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œå°†æ•°æ®å†™å…¥ç£ç›˜ä¸­ï¼Œä»¥é‡Šæ”¾å†…å­˜ç©ºé—´ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨Redisçš„å†…å­˜ä¼˜åŒ–æŠ€å·§ï¼Œå¦‚åˆ é™¤ä¸å¿…è¦çš„æ•°æ®ã€åˆç†ä½¿ç”¨Redisçš„æ•°æ®ç»“æ„ç­‰ã€‚</li></ul></li><li>é˜»å¡æ“ä½œï¼šå½“Redisæ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œä¼šé˜»å¡å…¶ä»–æ“ä½œçš„æ‰§è¡Œï¼Œä»è€Œå½±å“Redisçš„æ•´ä½“æ€§èƒ½ã€‚<ul><li>è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥ä½¿ç”¨Redisçš„å¼‚æ­¥æ“ä½œç‰¹æ€§ï¼Œå°†é˜»å¡æ“ä½œè½¬åŒ–ä¸ºå¼‚æ­¥æ“ä½œï¼Œä»¥æé«˜Redisçš„æ€§èƒ½å’Œååé‡ã€‚</li></ul></li></ol>              </div>            </details><h2 id="å¦‚æœRedisä¸­æœ‰1äº¿ä¸ªkeyï¼Œå…¶ä¸­æœ‰10wä¸ªkeyæ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥å‰ç¼€å¼€å¤´çš„ï¼Œå¦‚ä½•å°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥ï¼Ÿ">å¦‚æœRedisä¸­æœ‰1äº¿ä¸ªkeyï¼Œå…¶ä¸­æœ‰10wä¸ªkeyæ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥å‰ç¼€å¼€å¤´çš„ï¼Œå¦‚ä½•å°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨keyså‘½ä»¤æˆ–scanå‘½ä»¤ï¼Œç„¶è€Œåœ¨æ•°æ®é‡åºå¤§çš„ç¯å¢ƒä¸‹ï¼Œä¸æ¨èä½¿ç”¨keyså‘½ä»¤ã€‚<ol><li>keyså‘½ä»¤æ˜¯éå†æŸ¥è¯¢çš„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œæ•°æ®é‡è¶Šå¤§æŸ¥è¯¢æ—¶é—´è¶Šé•¿ï¼Œä¸”Redisæ˜¯å•çº¿ç¨‹çš„ï¼Œä½¿ç”¨keyså‘½ä»¤ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´ï¼Œä»è€Œå¯¼è‡´Redisä¼šå‡ºç°å‡æ­»é—®é¢˜ï¼Œç›´åˆ°keyså‘½ä»¤æ‰§è¡Œå®Œæ¯•æ‰èƒ½æ¢å¤ï¼Œè¿™åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹æ˜¯ä¸å¯æ¥å—çš„ã€‚æ­¤å¤–ï¼Œkeyså‘½ä»¤æ²¡æœ‰åˆ†é¡µåŠŸèƒ½ï¼Œä¼šä¸€æ¬¡æ€§æŸ¥è¯¢å‡ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„keyå€¼ï¼Œè¾“å‡ºçš„ä¿¡æ¯éå¸¸å¤šã€‚</li><li>ç›¸å¯¹æ¥è¯´ï¼Œscanå‘½ä»¤æ¯”keyså‘½ä»¤æ›´é€‚åˆç”Ÿäº§ç¯å¢ƒã€‚sacnå‘½ä»¤å¯ä»¥å®ç°å’Œkeyså‘½ä»¤ç›¸åŒçš„åŒ¹é…åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œå¹¶ä¸”æŸ¥è¯¢çš„æ•°æ®å¯èƒ½å­˜åœ¨é‡å¤ï¼Œéœ€è¦å®¢æˆ·ç«¯å»é‡ã€‚å› ä¸ºscanå‘½ä»¤æ˜¯é€šè¿‡æ¸¸æ ‡æ–¹å¼æŸ¥è¯¢çš„ï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´Rediså‡ºç°å‡æ­»é—®é¢˜ã€‚Redisåœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­ä¼šæŠŠæ¸¸æ ‡è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå•è¯è¿”å›æ§åˆ¶ä¸”æ¸¸æ ‡ä¸ä¸º0ï¼Œåˆ™è¯´æ˜éå†è¿˜æ²¡æœ‰ç»“æŸï¼Œå®¢æˆ·ç«¯ç»§ç»­éå†æŸ¥è¯¢ã€‚ä½†æ˜¯ï¼Œscanå‘½ä»¤åœ¨æ£€ç´¢çš„è¿‡ç¨‹ä¸­ï¼Œè¢«åˆ é™¤çš„å…ƒç´ æ˜¯ä¸ä¼šè¢«æŸ¥è¯¢å‡ºæ¥çš„ï¼Œå¦‚æœåœ¨è¿­ä»£è¿‡ç¨‹ä¸­æœ‰å…ƒç´ è¢«ä¿®æ”¹ï¼Œscanå‘½ä»¤ä¹Ÿä¸èƒ½ä¿è¯æŸ¥è¯¢å‡ºå¯¹åº”çš„å…ƒç´ ã€‚ç›¸å¯¹æ¥è¯´ï¼Œscanå‘½ä»¤æŸ¥æ‰¾èŠ±è´¹çš„æ—¶é—´ä¼šæ¯”keyså‘½ä»¤é•¿ã€‚</li></ol></li></ul><div class="note info no-icon flat"><ul><li>è¡¥å……ï¼šå‡æ­»é—®é¢˜<ul><li>Rediså‡æ­»é—®é¢˜æ˜¯æŒ‡å½“Rediså®ä¾‹åœ¨è¿›è¡ŒæŸäº›è€—æ—¶æ“ä½œæ—¶ï¼ˆä¾‹å¦‚éå†æ‰€æœ‰keyï¼‰ï¼Œç”±äºRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ“ä½œä¼šå¯¼è‡´Redisçº¿ç¨‹è¢«é˜»å¡ï¼Œä»è€Œå¯¼è‡´Redisæ— æ³•å¤„ç†å…¶ä»–è¯·æ±‚ï¼Œé€ æˆRedisæœåŠ¡ä¸å¯ç”¨çš„çŠ¶æ€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒRedisä¼¼ä¹å·²ç»æ­»äº†ï¼Œä½†å…¶å®Redisçº¿ç¨‹ä»åœ¨æ‰§è¡Œæ“ä½œï¼Œåªæ˜¯æ— æ³•å¤„ç†å…¶ä»–è¯·æ±‚è€Œå·²ã€‚å› æ­¤ï¼Œè¿™ç§çŠ¶æ€è¢«ç§°ä¸ºRediså‡æ­»é—®é¢˜ã€‚é¿å…Rediså‡æ­»é—®é¢˜çš„å¸¸è§æ–¹æ³•æ˜¯ä½¿ç”¨Redisæä¾›çš„å¼‚æ­¥å‘½ä»¤å’Œç®¡é“æŠ€æœ¯ï¼Œä»¥é¿å…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¼šä½¿ç”¨éå†æ‰€æœ‰keyçš„æ“ä½œã€‚</li></ul></li></ul></div>              </div>            </details><h2 id="å¦‚æœæœ‰å¤§é‡çš„keyéœ€è¦è®¾ç½®åŒä¸€æ—¶é—´è¿‡æœŸï¼Œä¸€èˆ¬éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ">å¦‚æœæœ‰å¤§é‡çš„keyéœ€è¦è®¾ç½®åŒä¸€æ—¶é—´è¿‡æœŸï¼Œä¸€èˆ¬éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å¦‚æœå¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼Œä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œå®¹æ˜“é€ æˆæ•°æ®åº“å´©æºƒæˆ–è€…é™ä½æ•°æ®åº“çš„æ€§èƒ½ï¼Œè¿›è€Œå½±å“æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚</li><li>ä¸ºäº†é¢„é˜²è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬æœ€å¥½åœ¨è®¾è®¡æ•°æ®è¿‡æœŸæ—¶é—´çš„æ—¶å€™ï¼Œéƒ½åŠ ä¸Šä¸€ä¸ªéšæœºå€¼ï¼Œè®©è¿‡æœŸæ—¶é—´æ›´åŠ åˆ†æ•£ï¼Œä»è€Œå°½é‡é¿å…å¤§é‡çš„keyåœ¨åŒä¸€æ—¶åˆ»å¤±æ•ˆã€‚</li></ul>              </div>            </details><h2 id="ä»€ä¹ˆæƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´Redisé˜»å¡ï¼Ÿ">ä»€ä¹ˆæƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´Redisé˜»å¡ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Rediså¯èƒ½å‡ºç°é˜»å¡çš„æƒ…å†µåŒ…æ‹¬ï¼š<ol><li>Redisä¸»çº¿ç¨‹åœ¨æ‰§è¡Œé˜»å¡å‘½ä»¤ï¼ˆå¦‚<code>BRPOP</code>ã€<code>BLPOP</code>ã€<code>BRPOPLPUSH</code>ã€<code>SUBSCRIBE</code>ç­‰ï¼‰æ—¶ï¼Œä¼šé˜»å¡å…¶ä»–å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œç›´åˆ°å‘½ä»¤æ‰§è¡Œå®Œæ¯•æ‰èƒ½ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚ã€‚</li><li>Redisä¸»çº¿ç¨‹åœ¨æ‰§è¡ŒæŸäº›è€—æ—¶çš„å‘½ä»¤ï¼ˆå¦‚<code>SORT</code>ã€<code>KEYS</code>ç­‰ï¼‰æ—¶ï¼Œä¹Ÿä¼šé˜»å¡å…¶ä»–å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ŒåŒæ ·éœ€è¦ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæ¯•åæ‰èƒ½ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚ã€‚</li><li>Rediså†…å­˜ä½¿ç”¨è¾¾åˆ°æœ€å¤§é™åˆ¶æ—¶ï¼Œæ‰§è¡Œå†™æ“ä½œï¼ˆå¦‚<code>SET</code>ã€<code>INCR</code>ç­‰ï¼‰å¯èƒ½ä¼šå¯¼è‡´Redisé˜»å¡ã€‚è¿™æ˜¯å› ä¸ºRediséœ€è¦æ‰§è¡Œå†…å­˜å›æ”¶æ“ä½œä»¥é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œå¦‚æœå›æ”¶æ“ä½œè€—æ—¶è¿‡é•¿ï¼Œå°±ä¼šå¯¼è‡´Redisé˜»å¡ã€‚</li><li>Redisä¸»ä»åŒæ­¥è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸»åº“æ— æ³•åŠæ—¶å“åº”ä»åº“çš„åŒæ­¥è¯·æ±‚ï¼Œå°±ä¼šå¯¼è‡´ä»åº“é˜»å¡ï¼Œæ— æ³•ç»§ç»­è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</li></ol></li><li>å¯¹äºè¿™äº›é˜»å¡æƒ…å†µï¼Œå¯ä»¥é‡‡å–ä¸€äº›æªæ–½æ¥é¿å…æˆ–å‡å°‘é˜»å¡çš„å½±å“ï¼Œä¾‹å¦‚<ol><li>å°½å¯èƒ½ä½¿ç”¨éé˜»å¡å‘½ä»¤ï¼Œä¾‹å¦‚<code>LPUSH</code>å’Œ<code>RPOP</code>ä»£æ›¿<code>BLPOP</code>ï¼Œä½¿ç”¨Luaè„šæœ¬å®ç°å¤šä¸ªæ“ä½œçš„åŸå­æ€§ç­‰ã€‚</li><li>å°½é‡é¿å…ä½¿ç”¨è€—æ—¶çš„å‘½ä»¤æˆ–å¯¹å¤§æ•°æ®é›†è¿›è¡Œæ“ä½œï¼Œå¦‚æœå¿…é¡»ä½¿ç”¨ï¼Œå¯ä»¥è€ƒè™‘å°†è¿™äº›æ“ä½œæ”¾åœ¨åå°è¿›è¡Œã€‚</li><li>è®¾ç½®åˆç†çš„å†…å­˜ä½¿ç”¨ä¸Šé™ï¼ŒåŒæ—¶ä½¿ç”¨å†…å­˜æ·˜æ±°ç­–ç•¥æ¥æ§åˆ¶å†…å­˜ä½¿ç”¨æƒ…å†µã€‚</li><li>é…ç½®åˆç†çš„ä¸»ä»æ¶æ„ï¼Œé¿å…ä¸»åº“è¿‡äºç¹å¿™ï¼Œå¯¼è‡´ä»åº“åŒæ­¥é˜»å¡ã€‚</li></ol></li></ul>              </div>            </details> <h2 id="æ€ä¹ˆæé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Ÿ">æ€ä¹ˆæé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>æé«˜ç¼“å­˜å‘½ä¸­ç‡å¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š<ol><li>é¢„çƒ­ç¼“å­˜ï¼šåœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ï¼Œå°†ä¸€äº›çƒ­ç‚¹æ•°æ®æå‰åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œå¯ä»¥é¿å…åœ¨ç³»ç»Ÿè¿è¡Œæ—¶å‡ºç°ç¼“å­˜ç©¿é€å’Œç¼“å­˜é›ªå´©çš„æƒ…å†µã€‚</li><li>å¢åŠ ç¼“å­˜å®¹é‡ï¼šå¢åŠ ç¼“å­˜å®¹é‡å¯ä»¥ç¼“å­˜æ›´å¤šçš„æ•°æ®ï¼Œä»è€Œæé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚</li><li>ä¼˜åŒ–ç¼“å­˜è®¾è®¡ï¼šåˆç†çš„ç¼“å­˜è®¾è®¡æ˜¯æé«˜ç¼“å­˜å‘½ä¸­ç‡çš„å‰æï¼ŒåŒ…æ‹¬é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ã€ç¼“å­˜è¿‡æœŸæ—¶é—´ã€ç¼“å­˜çš„keyå‘½åç­‰ã€‚</li><li>ä½¿ç”¨å¤šçº§ç¼“å­˜ï¼šå¤šçº§ç¼“å­˜å¯ä»¥å°†çƒ­ç‚¹æ•°æ®ç¼“å­˜åœ¨æ›´å¿«é€Ÿã€å®¹é‡æ›´å°çš„ç¼“å­˜ä¸­ï¼Œå‡å°‘ä»æ…¢é€Ÿç¼“å­˜æˆ–è€…æ•°æ®åº“ä¸­è¯»å–æ•°æ®çš„æ¬¡æ•°ã€‚</li><li>ç¼“å­˜ç©¿é€å¤„ç†ï¼šé’ˆå¯¹ä¸€äº›ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œä½†æ˜¯ç»å¸¸è¢«æŸ¥è¯¢çš„æ•°æ®ï¼Œå¯ä»¥é‡‡å–å¸ƒéš†è¿‡æ»¤å™¨æˆ–è®¾ç½®ç©ºå€¼ç­‰æ–¹å¼æ¥è¿›è¡Œé¢„åˆ¤ï¼Œé¿å…ç¼“å­˜ç©¿é€çš„æƒ…å†µã€‚</li><li>å»ºç«‹è¯»å†™åˆ†ç¦»çš„æ¶æ„ï¼šå°†è¯»è¯·æ±‚å’Œå†™è¯·æ±‚åˆ†åˆ«å¤„ç†ï¼Œè¯»è¯·æ±‚å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–æ•°æ®ï¼Œå†™è¯·æ±‚æ›´æ–°æ•°æ®åº“åå†æ›´æ–°ç¼“å­˜ï¼Œä»è€Œé¿å…ç¼“å­˜å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§é—®é¢˜ã€‚</li></ol></li></ul>              </div>            </details><h2 id="Rediså¦‚ä½•è§£å†³keyå†²çªï¼Ÿ">Rediså¦‚ä½•è§£å†³keyå†²çªï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å¦‚æœä¸¤ä¸ªkeyçš„åå­—ç›¸åŒï¼Œåä¸€ä¸ªkeyä¼šè¦†ç›–å‰ä¸€ä¸ªkeyã€‚å› æ­¤ï¼Œä¸ºäº†é¿å…keyå†²çªï¼Œæœ€å¥½ä¸ºæ¯ä¸€ä¸ªkeyå–ä¸€ä¸ªç‹¬ç‰¹çš„ã€æ˜“äºè¾¨è¯†çš„åç§°ã€‚</li><li>é€šå¸¸å¯ä»¥ä½¿ç”¨ä¸šåŠ¡åå’Œå‚æ•°æ¥åŒºkeyï¼Œè¿™æ ·å¯ä»¥é¿å…keyå†²çªï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿ä¸šåŠ¡é€»è¾‘çš„ç®¡ç†å’Œç»´æŠ¤ã€‚</li></ul>              </div>            </details><h2 id="RedisæŠ¥å†…å­˜ä¸è¶³æ€ä¹ˆå¤„ç†ï¼Ÿ">RedisæŠ¥å†…å­˜ä¸è¶³æ€ä¹ˆå¤„ç†ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å¯ä»¥è€ƒè™‘ä»¥ä¸‹å‡ ç§å¤„ç†æ–¹å¼ï¼š<ol><li>å¢åŠ ç‰©ç†å†…å­˜ï¼šå¢åŠ Redisæ‰€åœ¨æœåŠ¡å™¨çš„ç‰©ç†å†…å­˜ï¼Œå¯ä»¥è®©Redisæœ‰æ›´å¤šçš„ç©ºé—´æ¥å­˜å‚¨æ•°æ®ã€‚</li><li>å‡å°‘æ•°æ®é‡ï¼šå¯ä»¥åˆ é™¤ä¸€äº›å·²ç»ä¸å†ä½¿ç”¨çš„æ•°æ®ï¼Œæˆ–è€…å°†ä¸€äº›æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ï¼Œä»¥é‡Šæ”¾å†…å­˜ã€‚è®¾ç½®ç¼“å­˜æ·˜æ±°ç­–ç•¥ï¼Œæé«˜å†…å­˜çš„ä½¿ç”¨æ•ˆç‡ã€‚</li><li>ä¿®æ”¹Redisé…ç½®ï¼šå¯ä»¥è°ƒæ•´Redisé…ç½®æ–‡ä»¶ä¸­çš„ä¸€äº›å‚æ•°ï¼Œå¦‚maxmemoryç­‰ï¼Œå¢åŠ Rediså¯ç”¨å†…å­˜ã€‚</li><li>ä½¿ç”¨Redisé›†ç¾¤ï¼šå¯ä»¥å°†æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªRedisèŠ‚ç‚¹ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨ä¸€éƒ¨åˆ†æ•°æ®ï¼Œä»è€Œå‡å°‘å•ä¸ªRediså®ä¾‹çš„å†…å­˜ä½¿ç”¨é‡ã€‚</li></ol></li></ul>              </div>            </details> <h2 id="ç¼“å­˜é›ªå´©ã€ç¼“å­˜ç©¿é€ã€ç¼“å­˜é¢„çƒ­ã€ç¼“å­˜æ›´æ–°ã€ç¼“å­˜é™çº§éƒ½äº†è§£å—ï¼Ÿ">ç¼“å­˜é›ªå´©ã€ç¼“å­˜ç©¿é€ã€ç¼“å­˜é¢„çƒ­ã€ç¼“å­˜æ›´æ–°ã€ç¼“å­˜é™çº§éƒ½äº†è§£å—ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ç®€è¿°å…¶æ¦‚å¿µå¦‚ä¸‹<ol><li>ç¼“å­˜é›ªå´©ï¼šæŒ‡åœ¨æŸä¸ªæ—¶é—´æ®µå†…ç¼“å­˜é›†ä½“è¿‡æœŸå¤±æ•ˆæˆ–ç¼“å­˜æœåŠ¡é‡å¯ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚éƒ½è½åˆ°æ•°æ®åº“ä¸Šï¼Œä»è€Œå¯¼è‡´æ•°æ®åº“å´©æºƒçš„æƒ…å†µã€‚</li><li>ç¼“å­˜ç©¿é€ï¼šæŒ‡æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œç”±äºç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šåˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼Œä¸¥é‡çš„å¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“å®•æœºã€‚</li><li>ç¼“å­˜é¢„çƒ­ï¼šæŒ‡ç³»ç»Ÿä¸Šçº¿åï¼Œå°†ç›¸å…³çš„ç¼“å­˜æ•°æ®ç›´æ¥åŠ è½½åˆ°ç¼“å­˜ç³»ç»Ÿä¸­ï¼Œé¿å…åœ¨ç”¨æˆ·è¯·æ±‚è¿‡ç¨‹ä¸­å› æ²¡æœ‰é¢„å…ˆåŠ è½½è€Œå¯¼è‡´ç¼“å­˜ç©¿é€çš„ç°è±¡ã€‚</li><li>ç¼“å­˜æ›´æ–°ï¼šæŒ‡å¯¹æ•°æ®åº“ä¸­çš„æ•°æ®æ›´æ–°æ—¶ï¼ŒåŒæ—¶æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œä¿è¯ç¼“å­˜æ•°æ®å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚</li><li>ç¼“å­˜é™çº§ï¼šæŒ‡åœ¨ç¼“å­˜å¤±æ•ˆæˆ–ç¼“å­˜è®¿é—®å¼‚å¸¸æ—¶ï¼Œä¸ºäº†ä¿è¯ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œé€šè¿‡ä¸€äº›æœºåˆ¶ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°å…¶ä»–æœåŠ¡æˆ–è€…ç›´æ¥è¿”å›é»˜è®¤å€¼ï¼Œä»è€Œé¿å…ç³»ç»Ÿå´©æºƒæˆ–è€…å› ä¸ºç¼“å­˜æ•…éšœå¯¼è‡´ä¸šåŠ¡å—æŸã€‚</li></ol></li><li>å¸¸è§çš„Redisç¼“å­˜é™çº§ç­–ç•¥åŒ…æ‹¬ï¼š<ol><li>ç†”æ–­é™çº§ï¼šå½“Redisç¼“å­˜æ•…éšœæˆ–è€…è¶…æ—¶æ—¶ï¼Œç³»ç»Ÿä¼šè¿›å…¥ç†”æ–­çŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚å¥–æ¯è½¬å‘åˆ°å¤‡ç”¨æœåŠ¡æˆ–è€…ç›´æ¥è¿”å›é»˜è®¤å€¼ã€‚</li><li>é™æµé™çº§ï¼šå½“Redisç¼“å­˜æ— æ³•å¤„ç†æ‰€æœ‰è¯·æ±‚æ—¶ï¼Œç³»ç»Ÿä¼šé‡‡ç”¨é™æµç­–ç•¥ï¼Œé™åˆ¶è®¿é—®æµé‡ï¼Œä¿æŠ¤ç³»ç»Ÿèµ„æºï¼Œé¿å…ç³»ç»Ÿå´©æºƒã€‚</li><li>æ•°æ®é™çº§ï¼šå½“Redisç¼“å­˜æ•…éšœæ—¶ï¼Œç³»ç»Ÿå¯ä»¥è¿”å›é»˜è®¤å€¼ï¼Œé¿å…å› ç¼“å­˜æ•…éšœå¯¼è‡´ä¸šåŠ¡å—æŸã€‚</li></ol></li></ul>              </div>            </details><h2 id="çƒ­ç‚¹æ•°æ®å’Œå†·æ•°æ®æ˜¯ä»€ä¹ˆï¼Ÿ">çƒ­ç‚¹æ•°æ®å’Œå†·æ•°æ®æ˜¯ä»€ä¹ˆï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>çƒ­ç‚¹æ•°æ®å’Œå†·æ•°æ®æ˜¯æ ¹æ®æ•°æ®è¢«è®¿é—®çš„é¢‘ç‡æ¥è¿›è¡Œåˆ’åˆ†çš„ã€‚<ul><li>çƒ­ç‚¹æ•°æ®å€¼çš„æ˜¯è¢«é¢‘ç¹è®¿é—®çš„æ•°æ®ï¼Œé€šå¸¸æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ï¼Œä¾‹å¦‚çƒ­é—¨å•†å“ã€çƒ­é—¨æ–‡ç« ã€çƒ­é—¨æ´»åŠ¨ç­‰ï¼Œè¿™äº›æ•°æ®çš„è®¿é—®é‡éå¸¸é«˜ï¼Œå¦‚æœæ²¡æœ‰å¾—åˆ°æœ‰æ•ˆçš„ç¼“å­˜ä¼˜åŒ–ï¼Œç³»ç»Ÿå°†ä¼šé¢ä¸´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚</li><li>å†·æ•°æ®åˆ™ç›¸åï¼ŒæŒ‡çš„æ˜¯ä¸ç»å¸¸è¢«è®¿é—®çš„æ•°æ®ï¼Œå®ƒä»¬çš„æ•°æ®è®¿é—®é¢‘ç‡è¾ƒä½ï¼Œä¾‹å¦‚æ—§çš„æ–‡ç« ã€è¿‡æœŸçš„æ´»åŠ¨ç­‰ã€‚</li></ul></li><li>äº†è§£çƒ­ç‚¹æ•°æ®å’Œå†·æ•°æ®å¯¹äºç¼“å­˜è®¾è®¡å’Œä¼˜åŒ–éå¸¸é‡è¦ï¼Œå› ä¸ºä¸åŒçš„æ•°æ®éœ€è¦é‡‡ç”¨ä¸åŒçš„ç¼“å­˜ç­–ç•¥ã€‚<ul><li>ä¾‹å¦‚å¯¹äºçƒ­ç‚¹æ•°æ®éœ€è¦é‡‡ç”¨ç¼“å­˜é¢„çƒ­ã€ç¼“å­˜æ›´æ–°ç­‰ç­–ç•¥æ¥ä¿è¯ç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œè€Œå¯¹äºå†·æ•°æ®åˆ™å¯ä»¥é‡‡ç”¨æ‡’åŠ è½½ç­‰ç­–ç•¥æ¥é¿å…ä¸å¿…è¦çš„ç¼“å­˜å¼€é”€ã€‚</li></ul></li></ul>              </div>            </details><h2 id="Memcachedå’ŒRedisçš„åŒºåˆ«éƒ½æœ‰å“ªäº›ï¼Ÿ">Memcachedå’ŒRedisçš„åŒºåˆ«éƒ½æœ‰å“ªäº›ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Memcachedå’ŒRedisæ˜¯ä¸¤ç§å¸¸ç”¨çš„ç¼“å­˜ç³»ç»Ÿï¼Œå®ƒä»¬çš„åŒºåˆ«å¦‚ä¸‹ï¼š<ol><li>æ•°æ®ç±»å‹ï¼šRedisæ”¯æŒæ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆç­‰ï¼Œè€ŒMemcachedä»…æ”¯æŒç®€å•çš„é”®å€¼å¯¹å­˜å‚¨ã€‚</li><li>æŒä¹…åŒ–ï¼šRedisæ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†æ•°æ®å†™å…¥ç£ç›˜ï¼Œè€ŒMemcachedä¸æ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ã€‚</li><li>åˆ†å¸ƒå¼æ”¯æŒï¼šMemcachedå¤©ç”Ÿæ”¯æŒåˆ†å¸ƒå¼ï¼Œå¤šä¸ªèŠ‚ç‚¹å¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œè€ŒRedisçš„åˆ†å¸ƒå¼æ”¯æŒéœ€è¦é€šè¿‡é›†ç¾¤ã€åˆ†ç‰‡ç­‰æ–¹å¼å®ç°ã€‚</li><li>æ€§èƒ½ï¼šåœ¨å•æœºç¯å¢ƒä¸‹ï¼ŒRedisçš„æ€§èƒ½é€šå¸¸æ¯”Memcachedæ›´å¥½ï¼Œä½†åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œç”±äºç½‘ç»œé€šä¿¡å¼€é”€çš„å¢åŠ ï¼Œä¸¤è€…çš„æ€§èƒ½å·®è·å¯èƒ½ä¼šå‡å°ã€‚</li><li>ç¼“å­˜ç­–ç•¥ï¼šRedisæ”¯æŒæ›´å¤šçš„ç¼“å­˜ç­–ç•¥ï¼Œæ¯”å¦‚LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ã€LFUï¼ˆæœ€å°‘ä½¿ç”¨ï¼‰ã€éšæœºç­‰ï¼Œè€ŒMemcachedä»…æ”¯æŒLRUã€‚</li><li>åº”ç”¨åœºæ™¯ï¼šRedisæ›´é€‚åˆéœ€è¦ä¸°å¯Œæ•°æ®ç±»å‹ã€æ”¯æŒæŒä¹…åŒ–ã€ç¼“å­˜ç­–ç•¥è¾ƒå¤šã€å•æœºæ€§èƒ½è¾ƒå¥½çš„åœºæ™¯ï¼›è€ŒMemcachedæ›´é€‚åˆéœ€è¦é«˜é€Ÿè¯»å†™ã€åˆ†å¸ƒå¼æ”¯æŒã€ç¼“å­˜ç­–ç•¥ç›¸å¯¹ç®€å•çš„åœºæ™¯ã€‚</li></ol></li></ul>              </div>            </details><h2 id="Redisçš„æ•°æ®ç±»å‹ï¼Œä»¥åŠæ¯ç§æ•°æ®ç±»å‹çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ">Redisçš„æ•°æ®ç±»å‹ï¼Œä»¥åŠæ¯ç§æ•°æ®ç±»å‹çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å¸¸è§çš„å‡ ç§æ•°æ®ç±»å‹å’Œä½¿ç”¨åœºæ™¯å¦‚ä¸‹ï¼š<ol><li>å­—ç¬¦ä¸²(String)ï¼šå­—ç¬¦ä¸²ç±»å‹æ˜¯Redisæœ€åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œä¸€ä¸ªé”®æœ€å¤§èƒ½å­˜å‚¨512MBã€‚<ul><li>ä½¿ç”¨åœºæ™¯ï¼šé€‚ç”¨äºè®¡æ•°å™¨ã€åˆ†å¸ƒå¼é”ã€ç¼“å­˜ç­‰å¸¸è§ã€‚</li></ul></li><li>åˆ—è¡¨(List)ï¼šåˆ—è¡¨æ˜¯é“¾è¡¨ç»“æ„ï¼Œå¯ä»¥åœ¨å¤´éƒ¨å’Œå°¾éƒ¨æ·»åŠ å…ƒç´ ã€‚<ul><li>ä½¿ç”¨åœºæ™¯ï¼šå¯ä»¥åšç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½ã€‚åˆ©ç”¨Irangeå‘½ä»¤ï¼ŒåšåŸºäºRedisçš„åˆ†é¡µåŠŸèƒ½ã€‚</li></ul></li><li>é›†åˆ(Set)ï¼šé›†åˆæ˜¯é€šè¿‡å“ˆå¸Œè¡¨å®ç°çš„æ— åºé›†åˆï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚<ul><li>ä½¿ç”¨åœºæ™¯ï¼šé€‚ç”¨äºå¥½å‹å…³ç³»ã€å…±åŒå¥½å‹ç­‰å»é‡å’Œè®¡ç®—äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„åœºæ™¯ã€‚</li></ul></li><li>å“ˆå¸Œ(Hash)ï¼šå“ˆå¸Œç»“æ„ç±»ä¼¼äºå…³è”æ•°ç»„ï¼Œç”±å­—æ®µå’Œå€¼ç»„æˆã€‚<ul><li>ä½¿ç”¨åœºæ™¯ï¼šé€‚ç”¨äºå¯¹è±¡ç¼“å­˜ã€‚</li></ul></li><li>æœ‰åºé›†åˆ(Sorted Set)ï¼šæœ‰åºé›†åˆç±»ä¼¼äºé›†åˆï¼Œä¸åŒçš„æ˜¯æ¯ä¸ªå…ƒç´ éƒ½ä¼šå…³è”ä¸€ä¸ªæƒé‡(score)ï¼ŒæŒ‰ç…§æƒé‡è¿›è¡Œæ’åºã€‚<ul><li>ä½¿ç”¨åœºæ™¯ï¼šæ’è¡Œæ¦œã€å¸¦æƒé‡çš„ä»»åŠ¡é˜Ÿåˆ—ç­‰åœºæ™¯ã€‚</li></ul></li><li>ä½å›¾(BitMap)ï¼šç”¨äºå­˜å‚¨äºŒè¿›åˆ¶ä½çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥è¿›è¡Œä½è¿ç®—ï¼Œæ”¯æŒé«˜æ•ˆçš„ä½å›¾è®¡ç®—ã€‚<ul><li>ä½¿ç”¨åœºæ™¯ï¼šç”¨æˆ·ç­¾åˆ°è®°å½•ã€‚</li></ul></li><li>åœ°ç†ä½ç½®(Geo)ï¼šç”¨äºå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯çš„æ•°æ®ç»“æ„ã€‚<ul><li>ä½¿ç”¨åœºæ™¯ï¼šé™„è¿‘çš„é…’åº—ã€é¤å…ã€‚</li></ul></li><li>HyperLogLogï¼šç”¨äºè¿›è¡ŒåŸºæ•°è®¡æ•°çš„æ•°æ®ç»“æ„ï¼Œæ”¯æŒé«˜æ•ˆçš„å¯¹å¤§é‡å…ƒç´ è¿›è¡Œå»é‡ç»Ÿè®¡ã€‚<ul><li>ä½¿ç”¨åœºæ™¯ï¼šç½‘ç«™çš„UVç»Ÿè®¡ã€‚</li></ul></li></ol></li></ul>              </div>            </details><h2 id="Redisçš„è¿‡æœŸç­–ç•¥ä»¥åŠå†…å­˜æ·˜æ±°æœºåˆ¶">Redisçš„è¿‡æœŸç­–ç•¥ä»¥åŠå†…å­˜æ·˜æ±°æœºåˆ¶</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisçš„è¿‡æœŸç­–ç•¥å’Œå†…å­˜æ·˜æ±°æœºåˆ¶å¦‚ä¸‹ï¼š<ol><li>è¿‡æœŸç­–ç•¥ï¼šRedisä¸­å¯ä»¥è®¾ç½®keyçš„è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´åˆ°æœŸåï¼Œkeyå°†ä¼šè‡ªåŠ¨è¢«åˆ é™¤ã€‚Redisæä¾›äº†ä¸¤ç§ä¸åŒçš„è¿‡æœŸç­–ç•¥ï¼š<ul><li>å®šæ—¶åˆ é™¤ï¼šåœ¨è®¾ç½®keyè¿‡æœŸçš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“è¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶ï¼Œå°±ä¼šç«‹å³åˆ é™¤è¯¥keyã€‚</li><li>æƒ°æ€§åˆ é™¤ï¼šå†è·å–æŸä¸ªkeyçš„å€¼æ—¶ï¼Œå…ˆæ£€æŸ¥è¯¥keyæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±åˆ é™¤ï¼Œå¦åˆ™è¿”å›è¯¥keyçš„å€¼ã€‚</li><li>Redisé»˜è®¤ä½¿ç”¨æƒ°æ€§åˆ é™¤ç­–ç•¥ã€‚</li></ul></li><li>å†…å­˜æ·˜æ±°æœºåˆ¶ï¼šå½“Rediså†…å­˜è¾¾åˆ°äº†æœ€å¤§é™åˆ¶æ—¶ï¼Œéœ€è¦ä»å†…å­˜ä¸­åˆ é™¤ä¸€äº›æ•°æ®ã€‚Redisæä¾›äº†å¤šç§å†…å­˜æ·˜æ±°æœºåˆ¶ï¼š<ul><li>noevictionï¼šå½“å†…å­˜ç©ºé—´ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ï¼Œè¿™ç§æ–¹å¼ä¸ä¼šåˆ é™¤ä»»ä½•æ•°æ®ï¼Œåº”è¯¥åªç”¨äºç‰¹æ®Šåœºæ™¯ã€‚</li><li>allkeys-lruï¼šå½“å†…å­˜ç©ºé—´ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„keyï¼ˆLRUç®—æ³•ï¼‰ã€‚è¿™æ˜¯Redisé»˜è®¤çš„æ·˜æ±°ç­–ç•¥ã€‚</li><li>allkeys-randomï¼šä»æ‰€æœ‰keyä¸­éšæœºé€‰æ‹©ä¸€äº›è¿›è¡Œåˆ é™¤ã€‚</li><li>volatile-lruï¼šå½“å†…å­˜ç©ºé—´ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œå†è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„keyï¼ˆLRUç®—æ³•ï¼‰ã€‚</li><li>volatile-ramdomï¼šä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­éšæœºé€‰æ‹©ä¸€äº›è¿›è¡Œåˆ é™¤ã€‚</li><li>volatile-ttlï¼šä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­ï¼Œæ ¹æ®è¿‡æœŸæ—¶é—´çš„å…ˆåé¡ºåºè¿›è¡Œåˆ é™¤ï¼Œè¶Šæ—©è¿‡æœŸçš„è¶Šä¼˜å…ˆåˆ é™¤ã€‚</li></ul></li></ol></li></ul>              </div>            </details><h2 id="ä¸ºä»€ä¹ˆRedisçš„æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œæ€ä¹ˆä¿è¯åŸå­æ€§ï¼Ÿ">ä¸ºä»€ä¹ˆRedisçš„æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œæ€ä¹ˆä¿è¯åŸå­æ€§ï¼Ÿ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisçš„æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œæ˜¯å› ä¸ºRedisæ˜¯å•çº¿ç¨‹çš„ï¼ŒRedisä¸­çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åœ¨ä¸€ä¸ªå•çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å¹¶å‘çš„ç¯å¢ƒä¸‹å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ªé”®å€¼å¯¹çš„é—®é¢˜ã€‚åœ¨Redisä¸­ï¼Œä»»ä½•ä¸€ä¸ªæ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œè¦ä¹ˆæ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆæ‰§è¡Œä¸æˆåŠŸã€‚å¦‚æœä¸€ä¸ªæ“ä½œåŒ…å«å¤šä¸ªæ­¥éª¤ï¼Œé‚£ä¹ˆè¿™äº›æ­¥éª¤ä¼šè¢«å½“æˆä¸€ä¸ªæ•´ä½“ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚</li><li>Redisä¿è¯åŸå­æ€§çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼šäº‹åŠ¡å’ŒLuaè„šæœ¬ã€‚åœ¨äº‹åŠ¡ä¸­ï¼ŒRedisä¼šå°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…æˆä¸€ä¸ªäº‹åŠ¡è¿›è¡Œæ‰§è¡Œï¼Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåœ¨ä¸€æ¬¡æ“ä½œä¸­è¢«æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚è€ŒLuaè„šæœ¬åˆ™å¯ä»¥å°†å¤šä¸ªæ“ä½œæ‰“åŒ…æˆä¸€ä¸ªåŸå­æ€§çš„æ“ä½œè¿›è¡Œæ‰§è¡Œï¼Œè¿™ä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚å¦å¤–ï¼ŒRedisè¿˜æä¾›äº†ä¸€äº›åŸå­æ€§æ“ä½œï¼Œä¾‹å¦‚INCRã€DECRç­‰ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚</li><li>åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œgetå’Œsetå‘½ä»¤ï¼Œå¯èƒ½ä¼šå‡ºç°ç«äº‰æ¡ä»¶ï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨Redisæä¾›çš„åŸå­æ€§æ“ä½œINCRï¼Œåˆ™ä¸ä¼šå­˜åœ¨è¿™ç§é—®é¢˜ï¼Œå› ä¸ºINCRå‘½ä»¤æ˜¯åŸå­æ€§çš„ã€‚</li><li>å› æ­¤å¯ä»¥ä½¿ç”¨Redisäº‹åŠ¡æˆ–è€…Redis+Luaçš„æ–¹å¼ä¿è¯å¤šä¸ªå‘½ä»¤åœ¨å¹¶å‘ä¸­çš„åŸå­æ€§ï¼Œæˆ–è€…ä½¿ç”¨Redisæä¾›çš„åŸå­æ€§æ“ä½œã€‚</li></ul>              </div>            </details><h2 id="é¢è¯•æ¨¡æ‹Ÿ">é¢è¯•æ¨¡æ‹Ÿ</h2><ul><li>é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>emmï¼Œæˆ‘æƒ³ä¸€ä¸‹<ul><li>ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œå¦‚æœä»å­˜å‚¨å±‚æŸ¥è¯¢ä¸åˆ°æ•°æ®ï¼Œåˆ™ä¸ä¼šå†™å…¥ç¼“å­˜ï¼Œæ­¤æ—¶å°±ä¼šå¯¼è‡´æ¯æ¬¡è¯·æ±‚è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œéƒ½ä¼šåˆ°DBé‡Œå»æŸ¥è¯¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´DBæŒ‚æ‰ï¼Œè¿™ç§æƒ…å†µå¤§æ¦‚ç‡æ˜¯é­åˆ°äº†æ”»å‡»ã€‚</li><li>è§£å†³æ–¹æ¡ˆçš„è¯ï¼Œä¸€èˆ¬å¯ä»¥ç¼“å­˜ç©ºæ•°æ®ï¼Œå³ç¼“å­˜è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ã€‚å¦å¤–ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨</li></ul></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šå¥½çš„ï¼Œé‚£ä½ èƒ½ä»‹ç»ä¸€ä¸‹å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œæ˜¯è¿™æ ·<ul><li>å¸ƒéš†è¿‡æ»¤å™¨ä¸»è¦æ˜¯ç”¨äºæ£€ç´¢ä¸€ä¸ªå…ƒç´ ç»å¯¹ä¸åœ¨é›†åˆä¸­æˆ–å¯èƒ½åœ¨é›†åˆä¸­ã€‚å®ƒçš„åº•å±‚ä¸»è¦æ˜¯å…ˆå»åˆå§‹åŒ–ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ•°ç»„ï¼Œé‡Œé¢å­˜æ”¾äºŒè¿›åˆ¶çš„0æˆ–1ï¼Œåœ¨ä¸€å¼€å§‹éƒ½æ˜¯0ï¼Œå½“ä¸€ä¸ªkeyæ¥äº†ä¹‹åç»è¿‡3ä¸ªå“ˆå¸Œå‡½æ•°çš„è®¡ç®—ï¼Œæ¨¡äºæ•°ç»„é•¿åº¦æ‰¾åˆ°æ•°æ®çš„ä¸‹æ ‡ï¼Œç„¶åæŠŠä¸‹æ ‡ä½ç½®çš„0æ”¹ä¸º1ï¼Œè¿™æ ·çš„è¯ï¼Œä¸‰ä¸ªæ•°ç»„ä¸‹æ ‡çš„ä½ç½®å°±èƒ½æ ‡æ˜ä¸€ä¸ªkeyçš„å­˜åœ¨ï¼ŒæŸ¥æ‰¾çš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</li><li>å½“ç„¶è¿™ä¸ªä¹Ÿæ˜¯æœ‰ç¼ºç‚¹çš„ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¯èƒ½å­˜åœ¨ä¸€äº›è¯¯åˆ¤ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ˜¯å¯ä»¥è®¾ç½®è¿™ä¸ªè¯¯åˆ¤ç‡çš„ï¼Œå¤§æ¦‚ä¸ä¼šè¶…è¿‡5%ï¼Œå› ä¸ºå“ˆå¸Œå†²çªä¸å¯èƒ½é¿å…ï¼Œæ‰€ä»¥è¿™ä¸ªè¯¯åˆ¤æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œè¦ä¸ç„¶å°±å¢åŠ æ•°ç»„é•¿åº¦ã€‚ä½†å…¶å®5%çš„è¯¯åˆ¤ç‡ä¸€èˆ¬é¡¹ç›®ä¹Ÿæ˜¯èƒ½æ¥å—çš„ï¼Œä¸è‡³äºé«˜å¹¶å‘ä¸‹å‹å€’æ•°æ®åº“ã€‚<br><img src="https://s1.ax1x.com/2023/07/23/pCq6DtP.png" alt=""></li><li>ç”¨ä¸Šå›¾æ¥ä¸¾ä¸ªä¾‹å­<ol><li>åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ä¸º 16 ä½ï¼Œæ¯ä¸€ä½åˆå§‹å€¼éƒ½ä¸º 0ã€‚</li><li>å°† <code>Fredy</code> å½•å…¥å¸ƒéš†è¿‡æ»¤å™¨ï¼Œç»è¿‡ä¸‰ä¸ªå“ˆå¸Œå‡½æ•°çš„è®¡ç®—ï¼Œå°†ç¬¬ 1ã€3ã€7 ä½è®¾ä¸º 1ã€‚</li><li>å°† <code>Eli</code> å½•å…¥å¸ƒéš†è¿‡æ»¤å™¨ï¼Œç»è¿‡ä¸‰ä¸ªå“ˆå¸Œå‡½æ•°çš„è®¡ç®—ï¼Œå°†ç¬¬ 10ã€12ã€15 ä½è®¾ä¸º 1ã€‚</li><li>æŸ¥è¯¢ <code>Tom</code>ï¼Œç»è¿‡ä¸‰ä¸ªå“ˆå¸Œå‡½æ•°çš„è®¡ç®—ï¼Œå¾—åˆ°ç¬¬ 0ã€2ã€5 ä½ï¼Œè¿™ä¸‰ä¸ªä½ç½®ä¸Šçš„æ•°å­—éƒ½æ˜¯ 0ã€‚æ ¹æ®å¸ƒéš†è¿‡æ»¤å™¨çš„è§„åˆ™ï¼Œå¯ä»¥åˆ¤æ–­ <code>Tom</code> ç»å¯¹ä¸åœ¨æ•°æ®åº“ä¸­ã€‚</li><li>æŸ¥è¯¢ <code>Lily</code>ï¼Œç»è¿‡ä¸‰ä¸ªå“ˆå¸Œå‡½æ•°çš„è®¡ç®—ï¼Œå¾—åˆ°ç¬¬ 7ã€12ã€15 ä½ï¼Œè¿™ä¸‰ä¸ªä½ç½®ä¸Šçš„æ•°å­—éƒ½æ˜¯ 1ã€‚è¿™é‡Œéœ€è¦æ¾„æ¸…ä¸€ç‚¹ï¼šè™½ç„¶è¿™ä¸‰ä¸ªä½ç½®ä¸Šçš„æ•°å­—éƒ½æ˜¯ 1ï¼Œä½†å¸ƒéš†è¿‡æ»¤å™¨åªèƒ½åˆ¤æ–­ <code>Lily</code> å¯èƒ½å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œè€Œä¸èƒ½ç¡®å®š <code>Lily</code> çœŸçš„åœ¨æ•°æ®åº“ä¸­ã€‚å› ä¸ºè¿™ä¸‰ä¸ªä½ä¸Šçš„ 1 å¯èƒ½æ˜¯ç”± <code>Fredy</code> å’Œ <code>Eli</code> å…±åŒç»„æˆçš„ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ã€‚</li><li>å½“å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­æ•°æ®ä¸€å®šä¸å­˜åœ¨ï¼Œå°±ä¸ç”¨æŸ¥è¯¢æ•°æ®åº“ï¼Œç›´æ¥è¿”å›ä¸å­˜åœ¨çš„ç»“æœã€‚å½“å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å¯èƒ½å­˜åœ¨ï¼Œé‚£ä¹ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œä»¥ç¡®è®¤å…ƒç´ æ˜¯å¦çœŸçš„å­˜åœ¨ã€‚</li></ol></li></ul></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>emmï¼Œæˆ‘æƒ³æƒ³<ul><li>ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡åœ¨ç¼“å­˜ä¸­è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æŸä¸ªkeyï¼Œåœ¨æŸä¸ªæ—¶é—´ç‚¹è¿™ä¸ªkeyæ­£å¥½è¿‡æœŸï¼Œå¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼Œæ°å¥½æ­¤æ—¶æœ‰å¤§é‡ç—…å‘æƒ…è¶£åŒæ—¶è®¿é—®è¯¥keyï¼Œè¿™äº›è¯·æ±‚ä¼šç›´æ¥è®¿é—®åç«¯æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“å‹åŠ›éª¤å¢ï¼Œä¸¥é‡å½±å“ç³»ç»Ÿæ€§èƒ½ï¼Œç”šè‡³ç›´æ¥å‹å®æ•°æ®åº“ã€‚</li><li>è§£å†³æ–¹æ¡ˆçš„è¯ï¼Œæˆ‘äº†è§£çš„æœ‰ä¸¤ç§<ul><li>æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨äº’æ–¥é”<ol><li>å½“ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¸ç«‹å³å»åŠ è½½æ•°æ®åº“ï¼Œè€Œæ˜¯å…ˆä½¿ç”¨Redisçš„<code>SETNX</code>(Set if Not Exists)å‘½ä»¤å»è®¾ç½®ä¸€ä¸ªäº’æ–¥é”ï¼Œåªæœ‰ä¸€ä¸ªè¯·æ±‚èƒ½å¤ŸæˆåŠŸè®¾ç½®äº’æ–¥é”ï¼Œå…¶ä»–è¯·æ±‚ä¼šåœ¨è¿™ä¸€æ­¥è¢«é˜»å¡</li><li>æˆåŠŸè®¾ç½®äº’æ–¥é”çš„è¯·æ±‚ï¼Œå†å»åŠ è½½æ•°æ®åº“ï¼Œå¹¶å°†åŠ è½½çš„æ•°æ®å›è®¾åˆ°ç¼“å­˜ä¸­</li></ol></li><li>æ–¹æ¡ˆäºŒï¼šé€»è¾‘è¿‡æœŸ<ol><li>åœ¨è®¾ç½®ç¼“å­˜keyçš„åŒæ—¶ï¼Œé¢å¤–å­˜å‚¨ä¸€ä¸ªè¿‡æœŸæ—¶é—´å­—æ®µåˆ°ç¼“å­˜ä¸­ï¼Œä½†æ˜¯ä¸ç»™å½“å‰keyè®¾ç½®è¿‡æœŸæ—¶é—´</li><li>å½“æŸ¥è¯¢è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œé¦–å…ˆä»ç¼“å­˜ä¸­å–å‡ºæ•°æ®ï¼Œå¹¶ä¸”é¢å¤–åˆ¤æ–­ä¸€ä¸‹å­˜å‚¨keyçš„è¿‡æœŸæ—¶é—´å­—æ®µï¼Œè‹¥è¿‡æœŸåˆ™è®¤ä¸ºç¼“å­˜å¤±æ•ˆ</li><li>å½“ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œå¼€å¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ•°æ®çš„å¼‚æ­¥åŠ è½½å’Œç¼“å­˜æ›´æ–°ï¼Œå½“å‰è¯·æ±‚ç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ—§æ•°æ®ï¼Œä½†è¿™éƒ¨åˆ†æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°</li><li>è¿™ç§æ–¹æ¡ˆä¸€å®šç¨‹åº¦ä¸Šä¿è¯äº†é«˜å¯ç”¨æ€§ï¼Œé¿å…äº†å¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚</li></ol></li></ul></li><li>å½“ç„¶ä¸¤ç§æ–¹æ¡ˆå„æœ‰åˆ©å¼Š<ul><li>æ–¹æ¡ˆä¸€ä½¿ç”¨äº†äº’æ–¥é”ï¼Œä¿è¯äº†æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œåˆ°å“ªæ€§èƒ½å¯èƒ½ä¼šå—åˆ°é”çš„ç«äº‰å½±å“ï¼Œè€Œä¸”éœ€è¦è€ƒè™‘æ­»é”çš„é—®é¢˜</li><li>æ–¹æ¡ˆäºŒä¼˜å…ˆè€ƒè™‘çš„æ˜¯é«˜å¯ç”¨å’Œæ€§èƒ½ï¼Œä½†ä¸èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°ç¼“å­˜å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</li><li>å®é™…ä½¿ç”¨ä¸­æ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚æ¥é€‰æ‹©è¦ä¿è¯ä¸€è‡´æ€§è¿˜æ˜¯å¯ç”¨æ€§ã€‚</li></ul></li></ul></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ç¼“å­˜é›ªå´©æ˜¯æŒ‡æ¢æˆé‚£ç§è®¾ç½®äº†ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯¼è‡´å¤§é‡ç¼“å­˜åœ¨åŒä¸€æ—¶åˆ»åŒæ—¶å¤±æ•ˆï¼Œè¿›è€Œå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚ç›´æ¥è½¬å‘åˆ°äº†åç«¯æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“ç¬æ—¶å‹åŠ›è¿‡å¤§ï¼Œå¯èƒ½ç›´æ¥å‹å®æ•°æ®åº“ã€‚å®ƒä¸ç¼“å­˜å‡»ç©¿çš„åŒºåˆ«åœ¨äºï¼Œç¼“å­˜é›ªå´©æ˜¯å¾ˆå¤škeyåŒæ—¶å¤±æ•ˆï¼Œè€Œç¼“å­˜å‡»ç©¿æ˜¯æŸä¸€ä¸ªkeyç¼“å­˜å¤±æ•ˆ</li><li>è§£å†³æ–¹æ¡ˆä¸»è¦æ˜¯åœ¨è®¾ç½®ç¼“å­˜çš„æ—¶å€™ï¼Œå¯ä»¥ç»™æ¯ä¸ªç¼“å­˜çš„è¿‡æœŸæ—¶é—´åŠ ä¸Šä¸€ä¸ªéšæœºå€¼ï¼Œä¾‹å¦‚åœ¨åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šï¼Œå†åŠ ä¸Šä¸€ä¸ª1~5åˆ†é’Ÿçš„éšæœºå€¼ã€‚</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šRedisä½œä¸ºç¼“å­˜ï¼ŒMySQLçš„æ•°æ®å¦‚ä½•ä¸Redisè¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿï¼ˆåŒå†™ä¸€è‡´æ€§é—®é¢˜ï¼‰</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œè¿™ä¸ªéœ€è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µã€‚<ul><li>ä¿è¯å¼ºä¸€è‡´æ€§ï¼šä½¿ç”¨è¯»å†™é”ã€‚<ul><li>å¦‚æœæ˜¯éœ€è¦ä¿è¯å¼ºä¸€è‡´æ€§çš„è¯ï¼Œå¯ä»¥é‡‡ç”¨Redissonå®ç°çš„è¯»å†™é”ï¼Œåœ¨è¯»çš„æ—¶å€™æ·»åŠ å…±äº«é”ï¼Œå¯ä»¥ä¿è¯è¯»è¯»ä¸äº’æ–¥ï¼Œè¯»å†™äº’æ–¥ã€‚å½“æˆ‘ä»¬æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œæ·»åŠ æ’ä»–é”ï¼Œå®ƒæ˜¯è¯»å†™ã€è¯»è¯»éƒ½äº’æ–¥ï¼Œè¿™æ ·èƒ½ä¿è¯åœ¨å†™æ•°æ®çš„åŒæ—¶ä¸ä¼šè®©å…¶ä»–çº¿ç¨‹æ¥è¯»æ•°æ®ï¼Œé¿å…å…¶ä»–çº¿ç¨‹è¯»åˆ°è„æ•°æ®ã€‚è¿™é‡Œéœ€è¦æ³¨æ„è¯»æ–¹æ³•å’Œå†™æ–¹æ³•ä¸Šéœ€è¦ä½¿ç”¨åŒä¸€æŠŠé”ã€‚</li><li>æ’ä»–é”çš„åº•å±‚ä½¿ç”¨çš„ä¹Ÿæ˜¯setnxï¼Œä¿è¯åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ“ä½œè¢«é”ä½çš„æ–¹æ³•</li></ul></li><li>ç„¶åä¸è¿½æ±‚å¼ºä¸€è‡´æ€§ï¼Œæ•°æ®åŒæ­¥å¯ä»¥æœ‰ä¸€å®šçš„å»¶æ—¶ã€‚<ul><li>å¯ä»¥é‡‡ç”¨é˜¿é‡Œçš„canalç»„ä»¶æ¥å®ç°æ•°æ®åŒæ­¥ï¼šä¸éœ€è¦æ›´æ”¹ä¸šåŠ¡ä»£ç ï¼Œéƒ¨ç½²ä¸€ä¸ªcanalæœåŠ¡ï¼ŒcanalæœåŠ¡ä¼šæŠŠè‡ªå·±ä¼ªè£…æˆMySQLçš„ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå½“MySQLæ•°æ®æ›´æ–°ä»¥åï¼Œcanalä¼šè¯»å–binlogæ•°æ®ï¼Œç„¶åé€šè¿‡canalçš„å®¢æˆ·ç«¯è·å–åˆ°æ•°æ®ï¼Œæ›´æ–°ç¼“å­˜å³å¯ã€‚</li></ul></li></ul></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šRedisä½œä¸ºç¼“å­˜ï¼Œæ•°æ®çš„æŒä¹…åŒ–æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>åœ¨Redisä¸­æä¾›äº†ä¸¤ç§æ•°æ®æŒä¹…åŒ–çš„æ–¹æ³•<ol><li>RDB<ul><li>RDBæ˜¯ä¸€ä¸ªå¿«ç…§æ–‡ä»¶ï¼Œå®ƒæ˜¯æŠŠRediså†…å­˜å­˜å‚¨çš„æ•°æ®å†™åˆ°ç£ç›˜ä¸Šï¼Œå½“Rediså®ä¾‹å®•æœºæ¢å¤æ•°æ®çš„æ—¶å€™ï¼Œæ–¹ä¾¿ä»RDBçš„å¿«ç…§æ–‡ä»¶ä¸­æ¢å¤æ•°æ®ã€‚</li></ul></li><li>AOF<ul><li>AOFçš„å«ä¹‰æ˜¯è¿½åŠ æ–‡ä»¶ï¼Œå½“Redisæ“ä½œå†™å‘½ä»¤çš„æ—¶å€™ï¼Œéƒ½ä¼šå­˜å‚¨åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå½“Rediså®ä¾‹å®•æœºæ¢å¤æ•°æ®çš„æ—¶å€™ï¼Œä¼šä»è¿™ä¸ªæ–‡ä»¶ä¸­å†æ¬¡æ‰§è¡Œä¸€éå‘½ä»¤æ¥æ¢å¤æ•°æ®ã€‚</li></ul></li></ol></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šé‚£è¿™ä¸¤ç§æ–¹å¼ï¼Œå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«å‘¢ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>RDBå› ä¸ºæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨ä¿å­˜çš„æ—¶å€™ä½“ç§¯ä¹Ÿæ˜¯æ¯”è¾ƒå°çš„ï¼Œæ‰€ä»¥æ¢å¤çš„æ¯”è¾ƒå¿«ï¼Œä½†æ˜¯å®ƒæœ‰å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ï¼Œå› ä¸ºRediså†…éƒ¨è®¾ç½®äº†è§¦å‘RDBçš„æœºåˆ¶ï¼Œæ‰€ä»¥å¯èƒ½ä¼šä¸¢å¤±ä¸€æ®µæ—¶é—´çš„ç¼“å­˜</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1      ## 900ç§’å†…ï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyå‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™è§¦å‘ä¸€æ¬¡æŒä¹…åŒ–æ“ä½œ</span><br><span class="line">save 300 10     ## 300ç§’å†…ï¼Œ10ä¸ªkeyå˜åŒ–</span><br><span class="line">save 60 10000   ## 60ç§’å†…ï¼Œ10000ä¸ªkeyå˜åŒ–</span><br></pre></td></tr></table></figure><ul><li>AOFæ¢å¤çš„é€Ÿåº¦æ…¢ä¸€äº›ï¼Œä½†æ˜¯å®ƒä¸¢å¤±æ•°æ®çš„é£é™©è¦å°å¾ˆå¤šï¼Œåœ¨Redisçš„é…ç½®æ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥é…ç½®AOFçš„åˆ·ç›˜ç­–ç•¥ï¼Œé‡‡ç”¨everysecçš„è¯ï¼Œæœ€å¤šä¸¢å¤±ä¸€ç§’çš„æ•°æ®</li></ul><table><thead><tr><th style="text-align:center">é…ç½®é¡¹</th><th style="text-align:center">åˆ·ç›˜æ—¶æœº</th><th style="text-align:center">ä¼˜ç‚¹</th><th style="text-align:center">ç¼ºç‚¹</th></tr></thead><tbody><tr><td style="text-align:center">Always</td><td style="text-align:center">åŒæ­¥åˆ·ç›˜</td><td style="text-align:center">å¯é æ€§é«˜ï¼Œå‡ ä¹ä¸ä¸¢æ•°æ®</td><td style="text-align:center">æ€§èƒ½å½±å“å¤§</td></tr><tr><td style="text-align:center">everysec</td><td style="text-align:center">æ¯ç§’åˆ·ç›˜</td><td style="text-align:center">æ€§èƒ½é€‚ä¸­</td><td style="text-align:center">æœ€å¤šä¸¢å¤±1ç§’æ•°æ®</td></tr><tr><td style="text-align:center">no</td><td style="text-align:center">æ“ä½œç³»ç»Ÿæ§åˆ¶</td><td style="text-align:center">æ€§èƒ½æœ€å¥½</td><td style="text-align:center">å¯é æ€§è¾ƒå·®ï¼Œå¯èƒ½ä¸¢å¤±å¤§é‡æ•°æ®</td></tr></tbody></table><ul><li>å®é™…ç¯å¢ƒä¸­ï¼Œéƒ½æ˜¯ç»“åˆä½¿ç”¨RDBå’ŒAOFæ¥ä½¿ç”¨çš„ã€‚</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šRedisçš„æ•°æ®è¿‡æœŸç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼ŒRedisæä¾›äº†ä¸¤ç§æ•°æ®è¿‡æœŸåˆ é™¤ç­–ç•¥<ul><li>ç¬¬ä¸€ç§æ˜¯æƒ°æ€§åˆ é™¤ï¼Œåœ¨è®¾ç½®keyè¿‡æœŸæ—¶é—´åï¼Œæˆ‘ä»¬ä¸å»ç®¡å®ƒï¼Œå½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨è¯¥keyæ—¶ï¼Œæˆ‘ä»¬å†æ£€æŸ¥å…¶æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸï¼Œæˆ‘ä»¬å°±åˆ é™¤å®ƒï¼Œæ²¡è¿‡æœŸï¼Œæˆ‘ä»¬å°±è¿”å›è¯¥keyã€‚è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯ï¼Œå¦‚æœæœ‰å¤§é‡å†·æ•°æ®ï¼Œé•¿æ—¶é—´ä¸ä¼šè¢«ä½¿ç”¨åˆ°ï¼Œä¼šå ç”¨å†…å­˜ç©ºé—´ï¼Œä¸ä¼šè¢«åŠæ—¶æ¸…ç†æ‰ã€‚</li><li>ç¬¬äºŒç§æ˜¯å®šæœŸåˆ é™¤ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬å°±å¯¹ä¸€äº›keyè¿›è¡Œæ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢å·²ç»è¿‡æœŸçš„keyã€‚å®šæœŸæ¸…ç†çš„ä¸¤ç§æ¨¡å¼<ol><li>SLOWæ¨¡å¼æ˜¯å®šæ—¶ä»»åŠ¡ï¼Œæ‰§è¡Œé¢‘ç‡é»˜è®¤ä¸º10HZï¼Œæ¯æ¬¡ä¸è¶…è¿‡25msï¼Œä¸è¿‡ä¹Ÿå¯ä»¥é€šè¿‡Redisçš„é…ç½®æ–‡ä»¶æ¥æ‰‹åŠ¨é…ç½®</li><li>FASTæ¨¡å¼æ‰§è¡Œé¢‘ç‡ä¸å›ºå®šï¼Œæ¯æ¬¡äº‹ä»¶å¾ªç¯ä¼šå°è¯•æ‰§è¡Œï¼Œä½†ä¸¤æ¬¡é—´éš”ä¸ä½äº2msï¼Œæ¯æ¬¡è€—æ—¶ä¸è¶…è¿‡1ms</li></ol></li><li>Redisçš„è¿‡æœŸåˆ é™¤ç­–ç•¥ï¼Œä¸€èˆ¬éƒ½æ˜¯ç»“åˆè¿™äºŒè€…ä¸€èµ·æ¥ä½¿ç”¨çš„ã€‚</li></ul></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šRedisçš„æ•°æ®æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼ŒRedisæ”¯æŒå…«ç§ä¸åŒçš„ç­–ç•¥æ¥é€‰æ‹©è¦åˆ é™¤çš„key<ol><li>noevictionï¼š ä¸æ·˜æ±°ä»»ä½•keyï¼Œä½†æ˜¯å†…å­˜æ»¡æ—¶ä¸å…è®¸å†™å…¥æ–°æ•°æ®ï¼Œé»˜è®¤å°±æ˜¯è¿™ç§ç­–ç•¥ã€‚</li><li>volatile-ttlï¼š å¯¹è®¾ç½®äº†TTLçš„keyï¼Œæ¯”è¾ƒkeyçš„å‰©ä½™TTLå€¼ï¼ŒTTLè¶Šå°è¶Šå…ˆè¢«æ·˜æ±°</li><li>allkeys-randomï¼šå¯¹å…¨ä½“key ï¼Œéšæœºè¿›è¡Œæ·˜æ±°ã€‚</li><li>volatile-randomï¼šå¯¹è®¾ç½®äº†TTLçš„key ï¼Œéšæœºè¿›è¡Œæ·˜æ±°ã€‚</li><li>allkeys-lruï¼š å¯¹å…¨ä½“keyï¼ŒåŸºäºLRUç®—æ³•è¿›è¡Œæ·˜æ±°ï¼ŒLRUçš„æ„æ€æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨</li><li>volatile-lruï¼š å¯¹è®¾ç½®äº†TTLçš„keyï¼ŒåŸºäºLRUç®—æ³•è¿›è¡Œæ·˜æ±°</li><li>allkeys-lfuï¼š å¯¹å…¨ä½“keyï¼ŒåŸºäºLFUç®—æ³•è¿›è¡Œæ·˜æ±°ï¼ŒLFUçš„æ„æ€æ˜¯æœ€å°‘é¢‘ç‡ä½¿ç”¨</li><li>volatile-lfuï¼š å¯¹è®¾ç½®äº†TTLçš„keyï¼ŒåŸºäºLFUç®—æ³•è¿›è¡Œæ·˜æ±°</li></ol></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šå‡å¦‚æ•°æ®åº“ä¸­æœ‰1000wæ•°æ®ï¼ŒRedisä¸­åªèƒ½ç¼“å­˜20wæ¡æ•°æ®ï¼Œå¦‚ä½•ä¿è¯Redisä¸­çš„æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ®</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥ä»Redisçš„æ•°æ®æ·˜æ±°ç­–ç•¥æ¥è€ƒè™‘ï¼Œå¦‚æœéœ€è¦ä¿ç•™çƒ­ç‚¹æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥æ ¹æ®æœ€è¿‘æœ€å°‘ä½¿ç”¨æ¥æ·˜æ±°æ•°æ®ï¼Œå³LRUç®—æ³•ï¼Œè¿™æ ·å‰©ä¸‹çš„å°±æ˜¯çƒ­ç‚¹æ•°æ®äº†ã€‚</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šRediså†…å­˜ç”¨å®Œäº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œè¿™ä¸ªé—®é¢˜å¾—çœ‹é…ç½®çš„Redisæ•°æ®æ·˜æ±°ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Œå¦‚æœæ˜¯é»˜è®¤çš„é…ç½®ï¼ŒRediså†…å­˜ç”¨å®Œä»¥åç›´æ¥æŠ¥é”™ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥è®¾ç½®æ•°æ®æ·˜æ±°ç­–ç•¥ï¼Œæˆ‘ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨çš„LRUæ¥æ·˜æ±°æ•°æ®ã€‚</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šRedisçš„åˆ†å¸ƒå¼é”å¦‚ä½•å®ç°</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼ŒRedisä¸­æä¾›äº†ä¸€ä¸ªSETNXå‘½ä»¤ï¼Œå³Set if Not Exists<ul><li>ç”±äºRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥ä½¿ç”¨è¯¥å‘½ä»¤åï¼Œåªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹æŸä¸€ä¸ªkeyè®¾ç½®å€¼ï¼Œåœ¨æ²¡æœ‰è¿‡æœŸæˆ–åˆ é™¤è¯¥keyä¹‹å‰ï¼Œå…¶ä»–å®¢æˆ·ç«¯æ˜¯ä¸èƒ½è®¾ç½®è¿™ä¸ªkeyçš„</li></ul></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šé‚£ä½ æ˜¯å¦‚ä½•æ§åˆ¶Rediså®ç°åˆ†å¸ƒå¼é”çš„æœ‰æ•ˆæ—¶é•¿å‘¢ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œé‡‡ç”¨Redisçš„SETNXå‘½ä»¤ç¡®å®ä¸å¤ªå¥½æ§åˆ¶è¿™ä¸ªæ—¶é•¿ï¼Œä½†æ˜¯å¯ä»¥é‡‡ç”¨Redisçš„ä¸€ä¸ªæ¡†æ¶ï¼ŒRedissonæ¥å®ç°ã€‚<ul><li>åœ¨Redissonä¸­éœ€è¦æ‰‹åŠ¨åŠ é”ï¼Œå¹¶ä¸”å¯ä»¥æ§åˆ¶é”çš„å¤±æ•ˆæ—¶é—´å’Œç­‰å¾…æ—¶é—´ï¼Œå½“é”ä½çš„ä¸€ä¸ªä¸šåŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆæ—¶ï¼ŒRedissonçš„çœ‹é—¨ç‹—æœºåˆ¶ä¼šæ¯éš”ä¸€æ®µæ—¶é—´æ¥æ£€æŸ¥å½“å‰ä¸šåŠ¡æ˜¯å¦è¿˜æŒæœ‰é”ï¼Œå¦‚æœæŒæœ‰é”ï¼Œå°±å¢åŠ é”çš„æŒä¹…æ—¶é—´ï¼Œå½“ä¸šåŠ¡æ‰§è¡Œå®Œæˆä¹‹åæ‰‹åŠ¨é‡Šæ”¾é”å³å¯ã€‚</li></ul></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šRedisé›†ç¾¤æœ‰å“ªäº›æ–¹æ¡ˆï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>Redisæä¾›çš„é›†ç¾¤æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼šä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼ã€Redisåˆ†ç‰‡é›†ç¾¤</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šé‚£ä½ æ¥ä»‹ç»ä¸€ä¸‹ä¸»ä»åŒæ­¥</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œæ˜¯è¿™æ ·çš„ï¼Œå•èŠ‚ç‚¹çš„Rediså¹¶å‘èƒ½åŠ›æœ‰é™ï¼Œè¦è¿›ä¸€æ­¥æé«˜Redisçš„å¹¶å‘èƒ½åŠ›ï¼Œå¯ä»¥æ­å»ºä¸»ä»é›†ç¾¤ï¼Œå®ç°è¯»å†™åˆ†ç¦»ã€‚ä¸€èˆ¬éƒ½æ˜¯ä¸€ä¸»å¤šä»ï¼Œä¸»èŠ‚ç‚¹è´Ÿè´£å†™å…¥æ•°æ®ï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»æ•°æ®ï¼Œä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®ä¹‹åï¼Œéœ€è¦å°†æ•°æ®åŒæ­¥åˆ°ä»èŠ‚ç‚¹ä¸­ã€‚</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šé‚£ä½ ç»§ç»­è¯´ä¸€ä¸‹ä¸»ä»åŒæ­¥çš„æµç¨‹å§</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä¸»ä»åŒæ­¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œä¸€ä¸ªæ˜¯å…¨é‡åŒæ­¥ï¼Œä¸€ä¸ªæ˜¯å¢é‡åŒæ­¥<ul><li>å…¨é‡åŒæ­¥æ˜¯æŒ‡ä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡ä¸ä¸»èŠ‚ç‚¹å»ºç«‹è¿æ¥çš„æ—¶å€™<ol><li>ä»èŠ‚ç‚¹è¯·æ±‚ä¸»èŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼Œä»èŠ‚ç‚¹ä¼šæºå¸¦è‡ªå·±çš„replication idå’Œoffsetåç§»é‡</li><li>ä¸»èŠ‚ç‚¹åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ¤æ–­çš„ä¾æ®æ˜¯ï¼Œä¸»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹æ˜¯å¦æ˜¯åŒä¸€ä¸ªreplication idï¼Œç„¶åä¸æ˜¯ï¼Œé‚£ä¸»èŠ‚ç‚¹å°±ä¼šæŠŠè‡ªå·±çš„replication idå’Œoffsetå‘é€ç»™ä»èŠ‚ç‚¹ï¼Œè®©ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹çš„ä¿¡æ¯ä¿æŒä¸€è‡´</li><li>ä¸æ­¤åŒæ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šæ‰§è¡Œbgsaveï¼Œç”ŸæˆRDBæ–‡ä»¶åï¼Œå‘é€ç»™ä»èŠ‚ç‚¹å»æ‰§è¡Œï¼Œä»èŠ‚ç‚¹å…ˆæŠŠè‡ªå·±çš„æ•°æ®æ¸…ç©ºï¼Œç„¶åæ‰§è¡Œä¸»èŠ‚ç‚¹å‘æ¥çš„RDBæ–‡ä»¶ï¼Œè¿™æ ·å°±ä¿æŒäº†ä¸€è‡´ã€‚</li><li>å¦‚æœåœ¨ä»èŠ‚ç‚¹æ‰§è¡ŒRDBæ–‡ä»¶çš„æœŸé—´ï¼Œä»æœ‰è¯·æ±‚åˆ°äº†ä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹ä¼šä»¥å‘½ä»¤çš„æ–¹å¼è®°å½•åˆ°ç¼“å†²åŒºï¼Œç¼“å†²åŒºæ˜¯ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œæœ€åæŠŠè¿™ä¸ªæ—¥å¿—æ–‡ä»¶å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œè¿™æ ·å°±ä¿è¯äº†ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹æ•°æ®å®Œå…¨ä¸€è‡´ï¼ŒåæœŸå†è¿›è¡ŒåŒæ­¥æ•°æ®çš„æ—¶å€™ï¼Œéƒ½æ˜¯ä¾èµ–äºè¿™ä¸ªæ—¥å¿—æ–‡ä»¶ã€‚è¿™ä¸ªå°±æ˜¯å…¨é‡åŒæ­¥</li></ol></li><li>å¢é‡åŒæ­¥æ˜¯æŒ‡ï¼Œå½“ä»èŠ‚ç‚¹æœåŠ¡é‡å¯ä¹‹åï¼Œæ•°æ®ä¸ä¸€è‡´äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä»èŠ‚ç‚¹ä¼šè¯·æ±‚ä¸»èŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼Œä¸»èŠ‚ç‚¹è¿˜æ˜¯å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ¤æ–­çš„è¯­å¥è¿˜æ˜¯replication idï¼Œä¸æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚çš„è¯ï¼Œå°±è·å–ä»èŠ‚ç‚¹çš„offsetå€¼ï¼Œç„¶åä¸»èŠ‚ç‚¹ä»å‘½ä»¤æ—¥å¿—ä¸­è·å–offsetå€¼ä¹‹åçš„æ•°æ®ï¼Œå‘é€ç»™ä»èŠ‚ç‚¹è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</li></ul></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šæ€ä¹ˆä¿è¯Redisçš„é«˜å¹¶å‘é«˜å¯ç”¨</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>é¦–å…ˆå¯ä»¥æ­å»ºä¸»ä»é›†ç¾¤ï¼Œå†åŠ ä¸Šä½¿ç”¨Redisä¸­çš„å“¨å…µæ¨¡å¼ï¼Œå“¨å…µæ¨¡å¼å¯ä»¥å®ç°ä¸»ä»é›†ç¾¤çš„è‡ªåŠ¨æ•…éšœæ¢å¤ï¼Œé‡Œé¢å°±åŒ…å«äº†å¯¹ä¸»ä»æœåŠ¡çš„ç›‘æ§ã€è‡ªåŠ¨æ•…éšœå›å¤ã€é€šçŸ¥ï¼›å¦‚æœä¸»èŠ‚ç‚¹æ•…éšœï¼Œå“¨å…µä¼šå°†ä¸€ä¸ªä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œå½“æ•…éšœå®ä¾‹æ¢å¤æ­£å¸¸ä¹‹åï¼Œä¹Ÿæ˜¯ä»¥æœ€æ–°çš„ä¸»èŠ‚ç‚¹ä¸ºä¸»ã€‚åŒæ—¶å“¨å…µä¹Ÿå……å½“Rediså®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°æ¥æºï¼Œå½“é›†ç¾¤å‘ç”Ÿæ•…éšœè½¬ç§»çš„æ—¶å€™ï¼Œä¼šå°†æœ€æ–°æ¶ˆæ¯æ¨é€ç»™Rediså®¢æˆ·ç«¯ï¼Œæ‰€ä»¥ä¸€èˆ¬é¡¹ç›®éƒ½ä¼šé‡‡ç”¨å“¨å…µæ¨¡å¼æ¥ä¿è¯Redisçš„é«˜å¹¶å‘é«˜å¯ç”¨</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œä¸ºä»€ä¹ˆè¿˜é‚£ä¹ˆå¿«ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ol><li>é¦–å…ˆRediså®Œå…¨æ˜¯åŸºäºå†…å­˜çš„ï¼Œå†…å­˜çš„è¯»å†™é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œå¹¶ä¸”Redisæ˜¯ç”±Cè¯­è¨€ç¼–å†™çš„</li><li>é‡‡ç”¨å•çº¿ç¨‹ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ç«äº‰æ¡ä»¶</li><li>ä½¿ç”¨I/Oå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œéé˜»å¡IO<ul><li>I/Oå¤šè·¯å¤ç”¨æŒ‡çš„æ˜¯åˆ©ç”¨å•ä¸ªçº¿ç¨‹æ¥ç›‘å¬å¤šä¸ªsocketï¼Œå¹¶åœ¨æŸä¸ªsocketå°±ç»ªçš„æ—¶å€™ï¼Œå¾—åˆ°é€šçŸ¥ï¼Œä»è€Œé¿å…æ— æ•ˆçš„ç­‰å¾…ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚ç›®å‰I/Oå¤šè·¯å¤ç”¨éƒ½æ˜¯é‡‡ç”¨çš„epollæ¨¡å¼å®ç°ï¼Œå®ƒä¼šé€šçŸ¥ç”¨æˆ·è¿›ç¨‹socketå°±ç»ªçš„åŒæ—¶ï¼ŒæŠŠå·²å°±ç»ªçš„socketå†™å…¥ç”¨æˆ·ç©ºé—´ï¼Œä¸éœ€è¦æŒ¨ä¸ªéå†socketæ¥åˆ¤æ–­æ˜¯å¦å°±ç»ªã€‚æå‡äº†æ€§èƒ½ã€‚</li></ul></li><li>Redisçš„ç½‘ç»œæ¨¡å‹ä½¿ç”¨I/Oå¤šè·¯å¤ç”¨ç»“åˆäº‹ä»¶å¤„ç†å™¨æ¥åº”å¯¹å¤šä¸ªsocketè¯·æ±‚ï¼Œä¾‹å¦‚ï¼Œæä¾›äº†è¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨ã€å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ã€‚<ul><li>Rediså› ä¸ºæ˜¯åŸºäºå†…å­˜çš„ï¼Œå†…å­˜è¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œæ‰€ä»¥æ€§èƒ½ç“¶é¢ˆä¸åœ¨å†…å­˜ï¼Œè€Œæ˜¯åœ¨ç½‘ç»œI/Oï¼Œå…·ä½“æ˜¯åœ¨å‘½ä»¤çš„è§£æè¿™ä¸€å—ï¼Œå‡å¦‚å¾ˆå¤šçš„å®¢æˆ·ç«¯éƒ½æ¥è¯»æ•°æ®ï¼Œé‚£ä¹ˆä»–ä»¬éƒ½ä¼šæºå¸¦è‡ªå·±çš„å‘½ä»¤ï¼ŒRediséœ€è¦æ¥æ”¶ç½‘ç»œè¯·æ±‚çš„æ•°æ®ï¼Œè½¬åŒ–ä¸ºRediså‘½ä»¤ï¼Œé‚£ä¹ˆRedisæ­¤æ—¶å¯èƒ½å°±å¿™ä¸è¿‡æ¥äº†ã€‚åœ¨Redis 6.0ä¹‹åå¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œç”¨äºè§£æç½‘ç»œè¯·æ±‚ã€‚ä½†æ˜¯çœŸæ­£å»æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä½¿ç”¨çš„å•çº¿ç¨‹ã€‚</li></ul></li></ol>              </div>            </details>]]></content>
    
    
    <summary type="html">Redisç›¸å…³é¢è¯•é¢˜</summary>
    
    
    
    <category term="é¢è¯•é¢˜" scheme="https://cyborg2077.github.io/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
    
    <category term="Redis" scheme="https://cyborg2077.github.io/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>MySQLé¢è¯•é¢˜</title>
    <link href="https://cyborg2077.github.io/2023/05/06/InQMySQL/"/>
    <id>https://cyborg2077.github.io/2023/05/06/InQMySQL/</id>
    <published>2023-05-06T13:40:59.000Z</published>
    <updated>2023-10-01T13:43:47.569Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ•°æ®åº“çš„ä¸‰èŒƒå¼æ˜¯ä»€ä¹ˆ">æ•°æ®åº“çš„ä¸‰èŒƒå¼æ˜¯ä»€ä¹ˆ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ol><li>ç¬¬ä¸€èŒƒå¼ï¼šåˆ—ä¸å¯å†åˆ†</li><li>ç¬¬äºŒèŒƒå¼ï¼šè¡Œå¯ä»¥å”¯ä¸€åŒºåˆ†ï¼Œä¸»é”®çº¦æŸ</li><li>ç¬¬ä¸‰èŒƒå¼ï¼šè¡¨çš„éä¸»å±æ€§ä¸èƒ½ä¾èµ–äºå…¶ä»–è¡¨çš„éä¸»å±æ€§ï¼Œå¤–é”®çº¦æŸ</li></ol><ul><li>ä¸‰çº§èŒƒå¼æ˜¯ä¸€çº§ä¸€çº§ä¾èµ–çš„ï¼Œç¬¬äºŒèŒƒå¼å»ºç«‹åœ¨ç¬¬ä¸€èŒƒå¼ä¸Šï¼Œç¬¬ä¸‰èŒƒå¼å»ºç«‹åœ¨ç¬¬ä¸€ã€ç¬¬äºŒèŒƒå¼ä¸Š</li></ul>              </div>            </details><h2 id="MySQLæ•°æ®åº“å¼•æ“æœ‰å“ªäº›">MySQLæ•°æ®åº“å¼•æ“æœ‰å“ªäº›</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <table><thead><tr><th style="text-align:center">Engine</th><th style="text-align:center">Support</th><th style="text-align:center">Comment</th><th style="text-align:center">Transactions</th><th style="text-align:center">XA</th><th style="text-align:center">Savepoints</th></tr></thead><tbody><tr><td style="text-align:center">InnoDB</td><td style="text-align:center">DEFAULT</td><td style="text-align:center">Supports transactions, row-level locking, and foreign keys</td><td style="text-align:center">YES</td><td style="text-align:center">YES</td><td style="text-align:center">YES</td></tr><tr><td style="text-align:center">MRG_MYISAM</td><td style="text-align:center">YES</td><td style="text-align:center">Collection of identical MyISAM tables</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td></tr><tr><td style="text-align:center">MEMORY</td><td style="text-align:center">YES</td><td style="text-align:center">Hash based, stored in memory, useful for temporary tables</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td></tr><tr><td style="text-align:center">BLACKHOLE</td><td style="text-align:center">YES</td><td style="text-align:center">/dev/null storage engine (anything you write to it disappears)</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td></tr><tr><td style="text-align:center">MyISAM</td><td style="text-align:center">YES</td><td style="text-align:center">MyISAM storage engine</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td></tr><tr><td style="text-align:center">CSV</td><td style="text-align:center">YES</td><td style="text-align:center">CSV storage engine</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td></tr><tr><td style="text-align:center">ARCHIVE</td><td style="text-align:center">YES</td><td style="text-align:center">Archive storage engine</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td></tr><tr><td style="text-align:center">PERFORMANCE_SCHEMA</td><td style="text-align:center">YES</td><td style="text-align:center">Performance Schema</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td><td style="text-align:center">NO</td></tr><tr><td style="text-align:center">FEDERATED</td><td style="text-align:center">NO</td><td style="text-align:center">Federated MySQL storage engine</td><td style="text-align:center">NULL</td><td style="text-align:center">NULL</td><td style="text-align:center">NULL</td></tr></tbody></table><ul><li>MySQLå¸¸ç”¨å¼•æ“åŒ…æ‹¬ï¼šMyISAMã€InnoDBã€MEMORY<ol><li>InnoDBï¼šInnoDBæ˜¯MySQLçš„é»˜è®¤å­˜å‚¨å¼•æ“ã€‚å®ƒæ”¯æŒäº‹åŠ¡ã€è¡Œçº§é”å’Œå¤–é”®çº¦æŸç­‰ç‰¹æ€§ï¼Œé€‚ç”¨äºéœ€è¦é«˜å¹¶å‘ã€é«˜å¯é æ€§ã€é«˜å¯ç”¨æ€§å’Œæ•°æ®å®‰å…¨æ€§çš„åº”ç”¨åœºæ™¯ã€‚</li><li>MyISAMï¼šMyISAMæ˜¯MySQLçš„å¦ä¸€ä¸ªå¸¸è§çš„å­˜å‚¨å¼•æ“ï¼Œå®ƒä¸æ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”ï¼Œä½†æ˜¯æ”¯æŒå…¨æ–‡æ£€ç´¢å’Œå‹ç¼©åŒ…ç­‰ç‰¹æ€§ï¼Œé€‚ç”¨äºè¯»å¯†é›†ã€å†™å°‘çš„åº”ç”¨åœºæ™¯ã€‚</li><li>MEMORYï¼šMEMORYå¼•æ“æ˜¯ä¸€ç§åŸºäºå†…å­˜çš„å­˜å‚¨å¼•æ“ï¼Œé€‚ç”¨äºå¯¹è¯»å†™é€Ÿåº¦è¦æ±‚éå¸¸é«˜çš„åº”ç”¨åœºæ™¯ï¼Œä½†æ˜¯æ•°æ®ä¸èƒ½æŒä¹…åŒ–ã€‚</li></ol></li></ul>              </div>            </details><h2 id="è¯´è¯´InnoDBå’ŒMyISAMçš„åŒºåˆ«">è¯´è¯´InnoDBå’ŒMyISAMçš„åŒºåˆ«</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>InnoDBå’ŒMyISAMæ˜¯MySQLæœ€å¸¸ç”¨çš„ä¸¤ç§å­˜å‚¨å¼•æ“ï¼Œå®ƒä»¬æœ‰ä»¥ä¸‹å‡ ä¸ªåŒºåˆ«<ol><li>äº‹åŠ¡å’Œé”ï¼šInnoDBæ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”ï¼Œè€ŒMyISAMä¸æ”¯æŒäº‹åŠ¡ï¼Œåªæ”¯æŒè¡¨çº§é”ã€‚å› æ­¤åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼ŒInnoDBå¯ä»¥æä¾›æ›´å¥½çš„å¹¶å‘æ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§ï¼Œè€ŒMyISAMçš„é”æœºåˆ¶å¯èƒ½ä¼šå¯¼è‡´è¯»å†™å†²çªå’Œæ€§èƒ½é—®é¢˜ã€‚</li><li>ç´¢å¼•ï¼šInnoDBçš„ç´¢å¼•æ˜¯B+æ ‘ç´¢å¼•ï¼Œè€ŒMyISAMçš„ç´¢å¼•æ˜¯Bæ ‘ç´¢å¼•ã€‚B+æ ‘ç´¢å¼•å¯¹äºèŒƒå›´æŸ¥è¯¢å’Œæ’åºç­‰æ“ä½œçš„æ€§èƒ½æ›´å¥½ï¼Œè€ŒBæ ‘ç´¢å¼•å¯¹äºç­‰å€¼æŸ¥è¯¢çš„æ€§èƒ½æ›´å¥½ã€‚</li><li>å…¨æ–‡æ£€ç´¢ï¼šMyISAMæ”¯æŒå…¨æ–‡æ£€ç´¢ï¼Œè€ŒInnoDBä¸æ”¯æŒå…¨æ–‡æ£€ç´¢ã€‚å¦‚æœéœ€è¦è¿›è¡Œå…¨æ–‡æ£€ç´¢ï¼Œå¯ä»¥ä½¿ç”¨MySQLçš„å…¨æ–‡æ£€ç´¢å¼•æ“(å¦‚Sphinx)ï¼Œæˆ–è€…ä½¿ç”¨å…¶ä»–æ”¯æŒå…¨æ–‡æ£€ç´¢çš„æ•°æ®åº“</li><li>å¤–é”®çº¦æŸï¼šInnoDBæ”¯æŒå¤–é”®çº¦æŸï¼Œè€ŒMyISAMä¸æ”¯æŒå¤–é”®çº¦æŸã€‚ä½¿ç”¨å¤–é”®çº¦æŸå¯ä»¥ä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ï¼Œé¿å…æ•°æ®å¼‚å¸¸å’Œé”™è¯¯ã€‚</li><li>æ•°æ®å®‰å…¨æ€§ï¼šInnoDBæ”¯æŒå´©æºƒæ¢å¤å’Œæ•°æ®æ¢å¤ï¼Œå¯ä»¥ä¿è¯æ•°æ®çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚è€ŒMyISAMä¸æ”¯æŒå´©æºƒæ¢å¤å’Œæ•°æ®æ¢å¤ï¼Œä¸€æ—¦å‘ç”Ÿå´©æºƒï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±æˆ–ä¸ä¸€è‡´ã€‚</li><li>InnoDBä¸ä¿å­˜è¡¨çš„å…·ä½“è¡Œæ•°ï¼Œæ‰§è¡Œ<code>SELECT COUNT(*) FROM table</code>æ—¶éœ€è¦å…¨è¡¨æ‰«æã€‚è€ŒMyISAMç”¨ä¸€ä¸ªå˜é‡ä¿å­˜äº†æ•´ä¸ªè¡¨çš„è¡Œæ•°ï¼Œæ‰§è¡Œä¸Šè¿°è¯­å¥æ—¶åªéœ€è¦è¯»å‡ºè¯¥å˜é‡å³å¯ï¼Œé€Ÿåº¦å¾ˆå¿«ã€‚</li></ol></li></ul>              </div>            </details><h2 id="æ•°æ®åº“äº‹åŠ¡">æ•°æ®åº“äº‹åŠ¡</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>æ•°æ®åº“äº‹åŠ¡æ˜¯æŒ‡ä¸€ç³»åˆ—æ•°æ®åº“æ“ä½œè¢«è§†ä¸ºä¸€ä¸ªå•ç‹¬çš„é€»è¾‘å•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸæ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šã€‚äº‹åŠ¡çš„ç›®çš„æ˜¯ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ï¼Œå³ä½¿åœ¨å¤šä¸ªå¹¶å‘è®¿é—®çš„æƒ…å†µä¸‹ä¹Ÿä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€‚</li><li>åœ¨æ•°æ®åº“ä¸­ï¼Œäº‹åŠ¡é€šå¸¸ç”±ä»¥ä¸‹å››ä¸ªå±æ€§ç»„æˆï¼Œå³ACID:<ol><li>åŸå­æ€§(Atomicity)ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Œä¸å­˜åœ¨éƒ¨åˆ†æ‰§è¡Œçš„æƒ…å†µã€‚</li><li>ä¸€è‡´æ€§(Consistency)ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“ä¸­çš„æ•°æ®å¿…é¡»æ»¡è¶³çº¦æŸæ¡ä»¶å’Œå®Œæ•´æ€§è§„åˆ™ï¼Œå³æ•°æ®åº“ä¸­çš„æ•°æ®å¿…é¡»å¤„äºä¸€è‡´çš„çŠ¶æ€ã€‚</li><li>éš”ç¦»æ€§(Isolation)ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½åº”è¯¥æ„Ÿè§‰ä¸åˆ°å…¶ä»–äº‹åŠ¡çš„å­˜åœ¨ï¼Œæ¯ä¸ªäº‹åŠ¡çš„æ‰§è¡Œåº”è¯¥ç‹¬ç«‹äºå…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œã€‚</li><li>æŒä¹…æ€§(Durability)ï¼šä¸€æ—¦äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œå®ƒå¯¹æ•°æ®åº“çš„ä¿®æ”¹åº”è¯¥æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä½¿å‘ç”Ÿç³»ç»Ÿæ•…éšœæˆ–é‡å¯ï¼Œæ•°æ®åº“ä¹Ÿåº”è¯¥èƒ½å¤Ÿæ¢å¤åˆ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸçš„çŠ¶æ€ã€‚</li></ol></li><li>é€šè¿‡ä½¿ç”¨äº‹åŠ¡ï¼Œå¯ä»¥ç¡®ä¿æ•°æ®åº“æ“ä½œçš„åŸå­æ€§å’Œä¸€è‡´æ€§ï¼Œé¿å…æ•°æ®å¼‚å¸¸å’Œé”™è¯¯ã€‚</li></ul>              </div>            </details><h2 id="ç´¢å¼•æ˜¯ä»€ä¹ˆ">ç´¢å¼•æ˜¯ä»€ä¹ˆ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ç´¢å¼•æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œç”¨äºåŠ å¿«æ•°æ®åº“ä¸­æ•°æ®æŸ¥è¯¢çš„é€Ÿåº¦ã€‚å®ƒç±»ä¼¼äºä¹¦ä¸­çš„ç›®å½•ï¼Œå¯ä»¥å¸®åŠ©å¿«é€ŸæŸ¥æ‰¾ç‰¹å®šçš„æ•°æ®ã€‚</li><li>åœ¨æ•°æ®åº“ä¸­ï¼Œç´¢å¼•é€šå¸¸æ˜¯åœ¨è¡¨çš„ä¸€åˆ—æˆ–å¤šåˆ—ä¸Šåˆ›å»ºçš„ã€‚åˆ›å»ºç´¢å¼•åï¼Œæ•°æ®åº“ä¼šä½¿ç”¨ç±»ä¼¼äºäºŒåˆ†æŸ¥æ‰¾çš„ç®—æ³•æ¥æŸ¥æ‰¾æ•°æ®ï¼Œä»è€Œå¤§å¤§æé«˜äº†æ•°æ®æŸ¥è¯¢çš„é€Ÿåº¦ã€‚</li><li>ç´¢å¼•å¯ä»¥å¤§å¤§æé«˜æ•°æ®æŸ¥è¯¢çš„é€Ÿåº¦ï¼Œä½†ä¹Ÿä¼šå¢åŠ æ•°æ®ä¿®æ”¹çš„æ—¶é—´å’Œç£ç›˜ç©ºé—´çš„ä½¿ç”¨ã€‚å› æ­¤ï¼Œåœ¨é€‰æ‹©ç´¢å¼•æ—¶ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œæƒè¡¡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåº”è¯¥å¯¹ç»å¸¸ç”¨äºæŸ¥è¯¢çš„åˆ—æˆ–ç”¨äºè¡¨ä¹‹é—´è¿æ¥çš„åˆ—åˆ›å»ºç´¢å¼•ï¼ŒåŒæ—¶é¿å…åˆ›å»ºè¿‡å¤šçš„ç´¢å¼•å’Œä¸å¿…è¦çš„ç´¢å¼•ï¼Œä»¥å…å¯¹æ•°æ®åº“æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚</li><li>æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„ç´¢å¼•ï¼ŒåŒ…æ‹¬èšé›†ç´¢å¼•ã€è¦†ç›–ç´¢å¼•ã€ç»„åˆç´¢å¼•ã€å‰ç¼€ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ç­‰ï¼Œæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œé»˜è®¤éƒ½æ˜¯ä½¿ç”¨B+æ ‘ç»“æ„ç»„ç»‡çš„ç´¢å¼•ã€‚</li></ul>              </div>            </details><h2 id="SQLä¼˜åŒ–æ‰‹æ®µæœ‰å“ªäº›">SQLä¼˜åŒ–æ‰‹æ®µæœ‰å“ªäº›</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>SQLä¼˜åŒ–æ˜¯æŒ‡å¯¹æ•°æ®åº“ä¸­çš„SQLè¯­å¥è¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ï¼Œä»¥æé«˜æŸ¥è¯¢å’Œä¿®æ”¹æ•°æ®çš„æ•ˆç‡ï¼Œä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„SQLä¼˜åŒ–æ‰‹æ®µ<ol><li>æŸ¥è¯¢è¯­å¥ä¸­ä¸è¦ä½¿ç”¨<code>SELECT *</code>ï¼šä½¿ç”¨<code>SELECT *</code>ä¼šæŸ¥è¯¢å‡ºæ‰€æœ‰çš„åˆ—ï¼ŒåŒ…æ‹¬å¯èƒ½ä¸éœ€è¦çš„åˆ—ï¼Œè¿™æ ·ä¼šå¢åŠ æŸ¥è¯¢çš„æ•°æ®é‡ï¼Œå½±å“æŸ¥è¯¢çš„æ•ˆç‡ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œåº”è¯¥å°½é‡æŒ‡å®šéœ€è¦æŸ¥è¯¢çš„åˆ—ã€‚</li></ol>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## ä¼˜åŒ–å‰</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br><span class="line"></span><br><span class="line">## ä¼˜åŒ–å</span><br><span class="line"><span class="keyword">SELECT</span> id, name, age <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure><ol start="2"><li>å°½é‡å‡å°‘å­æŸ¥è¯¢ï¼Œä½¿ç”¨å…³è”æŸ¥è¯¢(LEFT JOINã€RIGHT JOINã€INNER JOIN)æ›¿ä»£ï¼šå­æŸ¥è¯¢æ˜¯æŒ‡åœ¨ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ä¸­åµŒå¥—å¦ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ã€‚ç”±äºå­æŸ¥è¯¢éœ€è¦è¿›è¡Œå¤šæ¬¡æŸ¥è¯¢ï¼Œå› æ­¤ä¼šé™ä½æŸ¥è¯¢çš„æ•ˆç‡ã€‚å¯ä»¥ä½¿ç”¨å…³è”æŸ¥è¯¢æ¥æ›¿ä»£å­æŸ¥è¯¢ï¼Œä»¥å‡å°‘æŸ¥è¯¢æ¬¡æ•°ã€‚</li></ol>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## ä¼˜åŒ–å‰</span><br><span class="line"><span class="keyword">SELECT</span> name, age, (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) <span class="keyword">FROM</span> salary <span class="keyword">WHERE</span> salary.user_id <span class="operator">=</span> user.id) <span class="keyword">AS</span> max_salary <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br><span class="line"></span><br><span class="line">## ä¼˜åŒ–å</span><br><span class="line"><span class="keyword">SELECT</span> user.name user.age <span class="built_in">MAX</span>(salary.salary) <span class="keyword">AS</span> max_salary</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">user</span></span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> salary <span class="keyword">ON</span> user.id <span class="operator">=</span> salary.user_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user.id, user.name, user.age;</span><br></pre></td></tr></table></figure><ol start="3"><li>å‡å°‘ä½¿ç”¨<code>IN</code>æˆ–<code>NOT IN</code>ï¼Œä½¿ç”¨<code>EXISTS</code>ã€<code>NOT EXISTS</code>æˆ–å…³è”æŸ¥è¯¢æ›¿ä»£ï¼š<code>IN</code>å’Œ<code>NOT IN</code>æŸ¥è¯¢ä¼šå¯¹åˆ—è¡¨ä¸­çš„æ¯ä¸ªå€¼è¿›è¡ŒåŒ¹é…ï¼Œå› æ­¤æŸ¥è¯¢æ•ˆç‡è¾ƒä½ã€‚å¯ä»¥ä½¿ç”¨<code>EXISTS</code>æˆ–<code>NOT EXISTS</code>æŸ¥è¯¢è¯­å¥æˆ–å…³è”æŸ¥è¯¢è¯­å¥æ›¿ä»£</li></ol>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## ä¼˜åŒ–å‰</span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> user_id <span class="keyword">FROM</span> <span class="keyword">order</span> <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span>)</span><br><span class="line">## ä¼˜åŒ–å</span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> <span class="keyword">user</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> <span class="keyword">order</span> <span class="keyword">WHERE</span> order.user_id <span class="operator">-</span> user.id <span class="keyword">AND</span> order.status <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span>)</span><br></pre></td></tr></table></figure><ol start="4"><li><code>OR</code>çš„æŸ¥è¯¢å°½é‡ä½¿ç”¨<code>UNION</code>å’Œ<code>UNION ALL</code>ä»£æ›¿ï¼ˆåœ¨ç¡®è®¤æ²¡æœ‰é‡å¤æ•°æ®æˆ–ä¸ç”¨å»é‡æ•°æ®æ—¶ï¼ŒUNION ALLä¼šæ›´å¥½ï¼‰ï¼š<code>OR</code>æŸ¥è¯¢è¯­å¥ä¼šå¯¹å¤šä¸ªæ¡ä»¶è¿›è¡ŒåŒ¹é…ï¼Œè€Œ<code>UNION</code>å’Œ<code>UNION ALL</code>æŸ¥è¯¢è¯­å¥ä¼šå°†å¤šä¸ªæŸ¥è¯¢è¯­å¥çš„ç»“æœåˆå¹¶ã€‚åœ¨ç¡®å®šæ²¡æœ‰é‡å¤æ•°æ®æˆ–ä¸éœ€è¦å‰”é™¤é‡å¤æ•°æ®æ—¶ï¼Œä½¿ç”¨<code>UNION ALL</code>ä¼šæ¯”<code>UNION</code>æ›´é«˜æ•ˆã€‚</li></ol>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## ä¼˜åŒ–å‰</span><br><span class="line"></span><br><span class="line">## ä¼˜åŒ–å</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="5"><li>å°½é‡é¿å…åœ¨<code>WHERE</code>å­å¥ä¸­ä½¿ç”¨<code>!=</code>ã€<code>&lt;&gt;</code>æ“ä½œç¬¦ï¼Œå¦åˆ™å¼•æ“å°†æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¯ä»¥ä½¿ç”¨<code>=</code>æ“ä½œç¬¦æˆ–<code>NOT</code>æ“ä½œç¬¦æ¥æ›¿ä»£</li></ol>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## ä¼˜åŒ–å‰</span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> age <span class="operator">&lt;&gt;</span> <span class="number">18</span>;</span><br><span class="line">## ä¼˜åŒ–å</span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> age <span class="operator">&lt;</span> <span class="number">18</span> <span class="keyword">OR</span> age <span class="operator">&gt;</span> <span class="number">18</span>;</span><br></pre></td></tr></table></figure><ol start="6"><li>å°½é‡é¿å…åœ¨<code>WHERE</code>å­å¥ä¸­å¯¹å­—æ®µè¿›è¡ŒNULLå€¼åˆ¤æ–­ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¦‚</li></ol>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> tb <span class="keyword">WHERE</span> id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line">## æ”¹ä¸ºå¦‚ä¸‹å½¢å¼ï¼Œå‰ææ˜¯numè®¾ç½®é»˜è®¤å€¼ä¸º<span class="number">0</span>ï¼Œç¡®ä¿numåˆ—ä¸ä¼šå‡ºç°<span class="keyword">NULL</span>å€¼</span><br><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> tb <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></li></ul>              </div>            </details><h2 id="ç®€å•è¯´è¯´DROPã€DELETEä¸TRUNCATEçš„åŒºåˆ«">ç®€å•è¯´è¯´DROPã€DELETEä¸TRUNCATEçš„åŒºåˆ«</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>DROPã€DELETEã€TRUNCATEéƒ½æ˜¯MySQLä¸­ç”¨äºåˆ é™¤æ•°æ®æˆ–å¯¹è±¡çš„è¯­å¥ï¼Œä»–ä»¬çš„åŒºåˆ«å¦‚ä¸‹<ol><li>DROPï¼šç”¨äºåˆ é™¤æ•´ä¸ªæ•°æ®åº“ã€è¡¨æˆ–è§†å›¾ç­‰å¯¹è±¡ï¼ŒåŒæ—¶åˆ é™¤å¯¹è±¡æœºå™¨ç›¸å…³çš„çº¦æŸã€è§¦å‘å™¨å’Œç´¢å¼•ç­‰ã€‚DROPè¯­å¥æ˜¯æ— æ³•æ¢å¤çš„ï¼Œä¸€æ—¦æ‰§è¡ŒæˆåŠŸï¼Œå¯¹è±¡å°†æ°¸ä¹…åˆ é™¤ã€‚</li><li>DELETEï¼šç”¨äºåˆ é™¤è¡¨ä¸­çš„æ•°æ®è¡Œï¼Œä½†ä¸åˆ é™¤è¡¨æœ¬èº«æˆ–è¡¨ç»“æ„ã€‚DELETEè¯­å¥å¯ä»¥ä½¿ç”¨WHEREå­å¥æŒ‡å®šè¦åˆ é™¤çš„æ•°æ®è¡Œï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šWHEREå­å¥ï¼Œå°†åˆ é™¤è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚DELETEè¯­å¥æ˜¯å¯é€†çš„ï¼Œä½¿ç”¨ROLLBACKè¯­å¥å¯ä»¥æ’¤é”€åˆ é™¤æ“ä½œã€‚</li><li>TRUNCATEï¼šä¹Ÿæ˜¯ç”¨äºåˆ é™¤è¡¨ä¸­çš„æ•°æ®è¡Œï¼Œä¸DELETEä¸åŒçš„æ˜¯ï¼ŒTRUNCATEè¯­å¥åˆ é™¤è¡¨ä¸­æ‰€æœ‰æ•°æ®ï¼ˆä¸æ”¯æŒWHEREå­å¥ï¼‰ã€‚TURNCATEæ¯”DELETEæ›´å¿«ä¸”æ›´æœ‰æ•ˆç‡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ— æ³•æ¢å¤çš„ã€‚</li></ol></li><li>DELETEè¯­å¥æ˜¯DMLï¼Œè¿™ä¸ªæ“ä½œä¼šæ”¾åˆ°ROLLBACK SEGEMENTä¸­ï¼Œäº‹åŠ¡æäº¤åæ‰ç”Ÿæ•ˆï¼Œå¦‚æœæœ‰ç›¸åº”çš„TRIGGERï¼Œæ‰§è¡Œæ—¶ä¼šè¢«è§¦å‘</li><li>DROPå’ŒTRUNCATEæ˜¯DDLï¼Œæ“ä½œç«‹å³ç”Ÿæ•ˆï¼Œæ— æ³•å›æ»šï¼Œæ“ä½œä¸è§¦å‘TRIGGER</li></ul>              </div>            </details><h2 id="ä»€ä¹ˆæ˜¯è§†å›¾">ä»€ä¹ˆæ˜¯è§†å›¾</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>è§†å›¾(View)æ˜¯ä¸€ç§è™šæ‹Ÿçš„è¡¨ï¼Œæ˜¯ä»ä¸€ä¸ªæˆ–å¤šä¸ªåŸºæœ¬è¡¨(æˆ–è§†å›¾)å¯¼å‡ºçš„è¡¨ã€‚è§†å›¾å¹¶ä¸å­˜å‚¨æ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡æŸ¥è¯¢åŸºæœ¬è¡¨å¾—åˆ°æ•°æ®çš„ç»“æœé›†ï¼Œå› æ­¤è§†å›¾ä¸­çš„æ•°æ®æ˜¯åŠ¨æ€çš„ï¼Œä¼šæ ¹æ®åŸºæœ¬è¡¨çš„æ•°æ®å˜åŒ–è€Œè‡ªåŠ¨æ›´æ–°ã€‚</li><li>è§†å›¾å¯ä»¥çœ‹åšæ˜¯ä¸€ç§æ•°æ®è¿‡æ»¤å™¨æˆ–æ•°æ®æŠ½è±¡å±‚ï¼Œå¯ä»¥éšè—åº•å±‚è¡¨çš„ç»†èŠ‚ï¼Œæä¾›æ›´åŠ ç®€å•ã€ç›´è§‚çš„æ•°æ®è®¿é—®æ¥å£ï¼Œæ–¹ä¾¿ç”¨æˆ·è¿›è¡ŒæŸ¥è¯¢å’Œåˆ†æã€‚é€šè¿‡è§†å›¾ï¼Œç”¨æˆ·å¯ä»¥åªçœ‹åˆ°ä»–ä»¬éœ€è¦çš„æ•°æ®ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚è¡¨çš„å…·ä½“ç»“æ„å’Œå…³ç³»ã€‚</li><li>ä¾‹å¦‚ä¸‹é¢çš„è§†å›¾ä»å‘˜å·¥è¡¨ä¸­è¿‡æ»¤å‡ºå·¥èµ„å¤§äº5000çš„å‘˜å·¥çš„ä¿¡æ¯</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> high_salary_employee <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> emp_id, emp_name, salary</span><br><span class="line"><span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">5000</span>;</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡åˆ›å»ºè¿™ä¸ªè§†å›¾ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥æŸ¥è¯¢å·¥èµ„å¤§äº5000çš„å‘˜å·¥ä¿¡æ¯ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½å†™å‡ºSELECTæŸ¥è¯¢è¯­å¥</li></ul>              </div>            </details><h2 id="ä»€ä¹ˆæ˜¯å†…è¿æ¥ã€å·¦å¤–è¿æ¥ã€å³å¤–é“¾æ¥">ä»€ä¹ˆæ˜¯å†…è¿æ¥ã€å·¦å¤–è¿æ¥ã€å³å¤–é“¾æ¥</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å†…è¿æ¥(Inner Join)ï¼šåŒ¹é…ä¸¤å¼ è¡¨ä¸­ç›¸å…³è”çš„è®°å½•</li><li>å·¦å¤–è¿æ¥(Left Outer Join)ï¼šé™¤äº†åŒ¹é…ä¸¤å¼ è¡¨ä¸­ç›¸å…³è”çš„è®°å½•å¤–ï¼Œè¿˜ä¼šåŒ¹é…å·¦è¡¨ä¸­å‰©ä½™çš„è®°å½•ï¼Œå³è¡¨ä¸­æœªåŒ¹é…åˆ°çš„å­—æ®µç”¨NULLè¡¨ç¤º</li><li>å³å¤–é“¾æ¥(Right Outer Join)ï¼šé™¤äº†åŒ¹é…ä¸¤å¼ è¡¨ä¸­ç›¸å…³è”çš„è®°å½•æ­ªï¼Œè¿˜ä¼šåŒ¹é…å³è¡¨ä¸­å‰©ä½™çš„è®°å½•ï¼Œå·¦è¡¨ä¸­æœªåŒ¹é…åˆ°çš„å­—æ®µç”¨NULLè¡¨ç¤º</li></ul>              </div>            </details><h2 id="å¹¶å‘äº‹åŠ¡å¸¦æ¥å“ªäº›é—®é¢˜">å¹¶å‘äº‹åŠ¡å¸¦æ¥å“ªäº›é—®é¢˜</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>åœ¨å…¸å‹çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¤šä¸ªäº‹åŠ¡å¹¶å‘è¿è¡Œï¼Œç»å¸¸ä¼šæ“ä½œç›¸åŒçš„æ•°æ®æ¥å®Œæˆå„è‡ªçš„ä»»åŠ¡ï¼ˆå¤šä¸ªç”¨æˆ·å¯¹åŒä¸€æ¡æ•°æ®è¿›è¡Œæ“ä½œï¼‰ã€‚å¹¶å‘è™½ç„¶æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯åŒæ ·ä¼šå¯¼è‡´ä»¥ä¸‹å‡ ä¸ªé—®é¢˜<ol><li>è„è¯»(Dirty read)ï¼šå½“äº‹åŠ¡Aæ­£åœ¨è®¿é—®æ•°æ®å¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§ä¿®æ”¹è¿˜æ²¡æœ‰è¢«æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œæ­¤æ—¶äº‹åŠ¡Bä¹Ÿè®¿é—®äº†è¿™ä¸ªæ•°æ®ï¼Œç„¶åä½¿ç”¨äº†è¿™ä¸ªæ•°æ®ã€‚å› ä¸ºè¿™ä¸ªæ•°æ®æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œé‚£ä¹ˆäº‹åŠ¡Bè¯»åˆ°çš„æ•°æ®å°±æ˜¯<code>è„æ•°æ®</code>ï¼Œä¾æ®<code>è„æ•°æ®</code>æ‰€åšçš„æ“ä½œå¯èƒ½æ˜¯ä¸æ­£ç¡®çš„ã€‚</li><li>ä¸¢å¤±ä¿®æ”¹(Lost to modify)ï¼šæ˜¯æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€ä¸ªæ•°æ®æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¯¥æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†è¿™ä¸ªæ•°æ®åï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ä¹Ÿä¿®æ”¹äº†è¿™ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹çš„ç»“æœè¢«ä¸¢å¤±ï¼Œå› æ­¤æˆä¸ºä¸¢å¤±ä¿®æ”¹ã€‚<ul><li>ä¾‹å¦‚äº‹åŠ¡Aè¯»å–è¡¨ä¸­çš„æ•°æ®<code>age=10</code>ï¼Œäº‹åŠ¡Bä¹Ÿè¯»å–<code>age=10</code>ï¼Œäº‹åŠ¡Aä¿®æ”¹<code>age=age+1</code>ï¼Œäº‹åŠ¡Bä¿®æ”¹<code>age=age+2</code>ï¼Œæœ€ç»ˆç»“æœ<code>age=12</code>ï¼Œäº‹åŠ¡Açš„ä¿®æ”¹è¢«ä¸¢å¤±</li></ul></li><li>ä¸å¯é‡å¤è¯»(Unrepeatable read)ï¼šæ˜¯æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€äº‹åŠ¡ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¯¥æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä¸¤æ¬¡è¯»æ•°æ®ä¹‹é—´ï¼Œç”±äºç¬¬äºŒä¸ªå¤±è¯¯çš„ä¿®æ”¹å¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®å¯èƒ½ä¸å¤ªä¸€æ ·ï¼Œè¿™å°±å‘ç”Ÿäº†åœ¨ä¸€ä¸ªé£Ÿç‰©å†…ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå› æ­¤è¢«ç§°ä¸ºä¸å¯é‡å¤è¯»ã€‚</li><li>å¹»è¯»(Phantonm read)ï¼šå¹»è¯»ä¸ä¸å¯é‡å¤è¯»ç±»ä¼¼ï¼Œå®ƒå‘ç”Ÿåœ¨ä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å‡ è¡Œæ•°æ®ï¼Œæ¥ç€å¦ä¸€ä¸ªå¹¶å‘äº‹åŠ¡æ’å…¥äº†ä¸€äº›æ•°æ®ã€‚åœ¨éšåçš„æŸ¥è¯¢ä¸­ï¼Œç¬¬ä¸€ä¸ªäº‹åŠ¡å°±ä¼šå‘ç°å¤šäº†ä¸€äº›åŸæœ¬ä¸å­˜åœ¨çš„è®°å½•ï¼Œå°±å¥½åƒå‘ç”Ÿäº†å¹»è§‰ä¸€æ ·ï¼Œå› æ­¤è¢«ç§°ä¸ºå¹»è¯»ã€‚</li></ol></li><li>ä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„åŒºåˆ«ï¼š<ul><li>ä¸å¯é‡å¤è¯»çš„é‡ç‚¹æ˜¯ä¿®æ”¹ï¼šä¾‹å¦‚å¤šæ¬¡è¯»å–ä¸€æ¡è®°å½•ï¼Œå‘ç°å…¶ä¸­æŸäº›åˆ—çš„å€¼è¢«ä¿®æ”¹äº†ã€‚</li><li>å¹»è¯»çš„é‡ç‚¹åœ¨äºæ–°å¢æˆ–åˆ é™¤ï¼šä¾‹å¦‚å¤šæ¬¡æŒ‰ç…§å›ºå®šçš„æŸ¥è¯¢è¯­å¥æŸ¥è¯¢è®°å½•ï¼Œå‘ç°è¯»å–åˆ°çš„è®°å½•æ•°å¢å¤šäº†æˆ–æ˜¯å‡å°‘äº†</li></ul></li></ul>              </div>            </details><h2 id="äº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼ŸMySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆ">äº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼ŸMySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯æŒ‡å¤šä¸ªäº‹åŠ¡ä¹‹é—´äº’ç›¸éš”ç¦»çš„ç¨‹åº¦ï¼Œç›®çš„æ˜¯ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§å’Œéš”ç¦»æ€§ï¼ŒMySQLæ”¯æŒå››ç§éš”ç¦»çº§åˆ«ï¼Œåˆ†åˆ«æ˜¯<ol><li>è¯»æœªæäº¤(Read Uncommitted)ï¼šæœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»å–å¦ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼Œå®¹æ˜“å‡ºç°è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»çš„é—®é¢˜ã€‚</li><li>è¯»å·²æäº¤(Read Committed)ï¼šä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»å–å¦ä¸€ä¸ªäº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é¿å…è„è¯»é—®é¢˜ï¼Œä½†æ˜¯å¯èƒ½å‡ºç°ä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„é—®é¢˜ã€‚</li><li>å¯é‡å¤åº¦(Repeatable Read)ï¼šä¸€ä¸ªäº‹åŠ¡å¼€å§‹åï¼Œä¸å…è®¸å…¶ä»–äº‹åŠ¡ä¿®æ”¹è¯¥äº‹ç‰©ä½¿ç”¨çš„æ•°æ®ï¼Œå¯ä»¥é¿å…è„è¯»å’Œä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œä½†æ˜¯å¯èƒ½å‡ºç°å¹»è¯»é—®é¢˜ã€‚</li><li>ä¸²è¡ŒåŒ–(Serializable)ï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨çš„éš”ç¦»äº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½å¿…é¡»ç­‰å¾…å‰ä¸€ä¸ªäº‹åŠ¡æäº¤åæ‰èƒ½æ‰§è¡Œï¼Œé¿å…äº†æ‰€æœ‰å¹¶å‘é—®é¢˜ã€‚</li></ol></li></ul>              </div>            </details><h2 id="å¤§è¡¨å¦‚ä½•ä¼˜åŒ–">å¤§è¡¨å¦‚ä½•ä¼˜åŒ–</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä¼˜åŒ–å¤§è¡¨çš„æ€§èƒ½æ˜¯æ•°æ®åº“ä¼˜åŒ–çš„é‡è¦éƒ¨åˆ†ï¼Œä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„ä¼˜åŒ–æ–¹æ¡ˆ<ol><li>å‚ç›´åˆ†éš”(Vrtical Partitioning)ï¼šå°†å¤§è¡¨æŒ‰ç…§ä¸šåŠ¡é€»è¾‘æ‹†åˆ†ä¸ºå¤šä¸ªè¡¨ï¼Œæ¯ä¸ªè¡¨åªåŒ…å«ç‰¹å®šçš„å­—æ®µï¼Œå¯ä»¥å‡å°‘æ¯ä¸ªè¡¨çš„è¡Œæ•°å’Œåˆ—æ•°ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚</li><li>æ°´å¹³åˆ†éš”(Horizontal Partitioning)ï¼šå°†å¤§è¡¨æŒ‰ç…§æŸä¸ªå­—æ®µ(å¦‚æ—¶é—´ã€åœ°åŸŸç­‰)è¿›è¡Œåˆ†åŒºï¼Œå°†ä¸åŒçš„æ•°æ®å­˜å‚¨åœ¨ä¸åŒçš„åˆ†åŒºä¸­ï¼Œå¯ä»¥å‡å°‘å•ä¸ªè¡¨çš„è¡Œæ•°ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚</li><li>æ•°æ®åº“åˆ†åº“åˆ†è¡¨(Sharding)ï¼šå°†å¤§è¡¨æ‹†åˆ†ä¸ºå¤šä¸ªå°è¡¨ï¼Œåˆ†æ•£åœ¨å¤šä¸ªæ•°æ®åº“æˆ–è€…è¡¨ç©ºé—´ä¸­ï¼Œå¯ä»¥æé«˜å¹¶å‘è®¿é—®èƒ½åŠ›å’Œæ•°æ®å¤„ç†èƒ½åŠ›ï¼Œä½†æ˜¯éœ€è¦è€ƒè™‘æ•°æ®çš„ä¸€è‡´æ€§å’Œè·¨åˆ†åŒºæŸ¥è¯¢ç­‰é—®é¢˜ã€‚</li><li>ç´¢å¼•ä¼˜åŒ–ï¼šå¯¹äºå¤§è¡¨ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç´¢å¼•çš„è®¾è®¡å’Œä¼˜åŒ–ï¼Œå°½é‡é¿å…å…¨è¡¨æ‰«æå’Œç´¢å¼•å¤±æ•ˆç­‰é—®é¢˜ã€‚</li><li>æ•°æ®åº“ä¼˜åŒ–å‚æ•°è°ƒæ•´ï¼šå¯¹äºå¤§è¡¨ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µé€‚å½“è°ƒæ•´æ•°æ®åº“çš„ä¸€äº›å‚æ•°ï¼Œä¾‹å¦‚ç¼“å­˜å¤§å°ã€å¹¶å‘è¿æ¥æ•°ã€çº¿ç¨‹æ± å¤§å°ç­‰ã€‚</li><li>å®šæœŸæ¸…ç†æ— ç”¨æ•°æ®ï¼šå¯¹äºå¤§è¡¨ï¼Œéœ€è¦å®šæœŸæ¸…ç†æ— ç”¨æ•°æ®ï¼Œä»¥å‡å°‘è¡¨çš„è¡Œæ•°å’Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚</li></ol></li><li>è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒï¼š<a href="https://segmentfault.com/a/1190000006158186">MySQLå¤§è¡¨ä¼˜åŒ–æ–¹æ¡ˆ</a></li></ul>              </div>            </details><h2 id="åˆ†åº“åˆ†è¡¨åï¼Œidä¸»é”®å¦‚ä½•å¤„ç†">åˆ†åº“åˆ†è¡¨åï¼Œidä¸»é”®å¦‚ä½•å¤„ç†</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å°†å¤§è¡¨æ‹†åˆ†ä¸ºå¤šä¸ªè¡¨åï¼Œå¦‚æœæ¯ä¸ªè¡¨çš„ä¸»é”®éƒ½æ˜¯ä»1å¼€å§‹ç´¯åŠ çš„ï¼Œè¿™æ ·æ˜¯ä¸å¯¹çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„IDæ¥æ ‡è¯†</li><li>ç”Ÿæˆå…¨å±€IDæœ‰ä¸‹é¢å‡ ç§æ–¹å¼<ol><li>UUIDï¼šä¸é€‚åˆä½œä¸ºä¸»é”®ï¼Œå¤ªé•¿äº†ï¼Œå¹¶ä¸”æ— åºä¸å¯è¯»ï¼ŒæŸ¥è¯¢æ•ˆç‡ä½ã€‚æ¯”è¾ƒé€‚åˆç”¨äºç”Ÿæˆå«è¡£çš„åå­—æ ‡è¯†ï¼Œä¾‹å¦‚æ–‡ä»¶åã€‚</li><li>æ•°æ®åº“è‡ªå¢idï¼šä¸¤å°æ•°æ®åº“åˆ†åˆ«è®¾ç½®ä¸åŒçš„è‡ªå¢è¡¥å¿ï¼Œç”Ÿæˆä¸é‡å¤IDçš„ç­–ç•¥æ¥å®ç°é«˜å¯ç”¨ã€‚è¿™ç§æ–¹å¼ç”Ÿæˆçš„IDæœ‰åºï¼Œä½†æ˜¯éœ€è¦ç‹¬ç«‹éƒ¨ç½²æ•°æ®åº“å®ä¾‹ï¼Œæˆæœ¬é«˜ï¼Œè¿˜ä¼šæœ‰æ€§èƒ½ç“¶é¢ˆã€‚</li><li>åˆ©ç”¨Redisç”ŸæˆIDï¼šæ€§èƒ½æ¯”è¾ƒå¥½ï¼Œçµæ´»æ–¹ä¾¿ï¼Œä¸ä¾èµ–äºæ•°æ®åº“ï¼Œä½†æ˜¯å¼•å…¥äº†æ–°ç»„ä»¶é€ æˆç³»ç»Ÿæ›´åŠ å¤æ‚ï¼Œå¯ç”¨æ€§é™ä½ï¼Œç¼–ç æ›´åŠ å¤æ‚ï¼Œå¢åŠ äº†ç³»ç»Ÿæˆæœ¬</li><li>Twitterçš„snowflakeç®—æ³•ï¼ˆé›ªèŠ±ç®—æ³•ï¼‰</li></ol></li></ul>              </div>            </details><h2 id="è¯´è¯´åœ¨MySQLä¸­ï¼Œä¸€æ¡æŸ¥è¯¢SQLæ˜¯å¦‚ä½•æ‰§è¡Œçš„">è¯´è¯´åœ¨MySQLä¸­ï¼Œä¸€æ¡æŸ¥è¯¢SQLæ˜¯å¦‚ä½•æ‰§è¡Œçš„</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤<ol><li>è·å–è¿æ¥ï¼šä½¿ç”¨MySQLè¿æ¥å™¨è¿æ¥åˆ°æ•°æ®åº“ã€‚</li><li>æŸ¥è¯¢ç¼“å­˜ï¼škeyä¸ºSQLè¯­å¥ï¼Œvalueä¸ºæŸ¥è¯¢ç»“æœï¼Œå¦‚æœæŸ¥åˆ°å°±ç›´æ¥è¿”å›ã€‚ä½†æ˜¯ä¸å»ºè®®ä½¿ç”¨æ­¤ç¼“å­˜ï¼Œåœ¨MySQL 8.0ç‰ˆæœ¬ä¸­å·²ç»å°†æŸ¥è¯¢ç¼“å­˜åˆ é™¤æ‰äº†</li><li>åˆ†æå™¨ï¼šå°†SQLè¯­å¥è¿›è¡Œåˆ†è¯å’Œè¯­æ³•åˆ†æï¼Œåˆ¤æ–­è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœè¯­æ³•ä¸æ­£ç¡®ï¼Œä¼šåœ¨è¿™ä¸ªé˜¶æ®µå‘ç°å¹¶æŠ¥é”™ã€‚</li><li>ä¼˜åŒ–å™¨ï¼šå¯¹SQLè¯­å¥è¿›è¡Œä¼˜åŒ–ï¼Œé€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚æ‰§è¡Œè®¡åˆ’æ˜¯æŒ‡åœ¨è¡¨ä¸­æŸ¥è¯¢æ•°æ®çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ä½¿ç”¨å“ªäº›ç´¢å¼•ã€è¿æ¥è¡¨çš„é¡ºåºç­‰ã€‚ä¼˜åŒ–å™¨ä¼šæ ¹æ®è¡¨ä¸­çš„ç´¢å¼•ã€è¡¨å¤§å°ã€ç»Ÿè®¡ä¿¡æ¯ç­‰å› ç´ ï¼Œé€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚</li><li>æ‰§è¡Œå™¨ï¼šæ ¹æ®ä¼˜åŒ–å™¨é€‰æ‹©çš„æ‰§è¡Œè®¡åˆ’æ‰§è¡ŒSQLè¯­å¥ã€‚æ‰§è¡Œå™¨è´Ÿè´£æ‰“å¼€è¡¨ï¼Œæ ¹æ®è¡¨çš„å¼•æ“å®šä¹‰ï¼Œä½¿ç”¨å¼•æ“æä¾›çš„æ¥å£è·å–æ•°æ®ï¼Œè¿›è¡Œç­›é€‰å’Œè®¡ç®—ï¼Œæœ€ç»ˆè¿”å›æŸ¥è¯¢ç»“æœã€‚</li></ol></li></ul>              </div>            </details><h2 id="ç´¢å¼•æœ‰ä»€ä¹ˆç¼ºç‚¹">ç´¢å¼•æœ‰ä»€ä¹ˆç¼ºç‚¹</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>è™½ç„¶ç´¢å¼•å¯ä»¥åŠ é€ŸæŸ¥è¯¢ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä»¥ä¸‹ç¼ºç‚¹<ol><li>ç´¢å¼•ä¼šå¢åŠ æ•°æ®çš„å­˜å‚¨ç©ºé—´ï¼šç´¢å¼•éœ€è¦å ç”¨ä¸€å®šçš„å­˜å‚¨ç©ºé—´ï¼Œå°¤å…¶æ˜¯å¯¹äºå¤§è¡¨æ¥è¯´ï¼Œç´¢å¼•å¯èƒ½ä¼šå ç”¨ç›¸å½“å¤§çš„ç©ºé—´ã€‚</li><li>ç´¢å¼•ä¼šé™ä½æ•°æ®çš„ä¿®æ”¹é€Ÿåº¦ï¼šå½“æ•°æ®è¡¨ä¸­çš„æ•°æ®å‘ç”Ÿä¿®æ”¹æ—¶ï¼Œç´¢å¼•ä¹Ÿéœ€è¦è¿›è¡Œç›¸åº”çš„æ›´æ–°æ“ä½œã€‚å› æ­¤ï¼Œå¯¹äºç»å¸¸éœ€è¦ä¿®æ”¹çš„è¡¨ï¼Œç´¢å¼•å¯èƒ½ä¼šé™ä½æ•°æ®çš„ä¿®æ”¹é€Ÿåº¦ã€‚</li><li>ç´¢å¼•ä¸é€‚ç”¨äºæ‰€æœ‰ç±»å‹çš„æŸ¥è¯¢ï¼šè™½ç„¶ç´¢å¼•å¯ä»¥åŠ é€Ÿè®¸å¤šç±»å‹çš„æŸ¥è¯¢ï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„æŸ¥è¯¢éƒ½å¯ä»¥ä½¿ç”¨ç´¢å¼•è¿›è¡Œä¼˜åŒ–ã€‚ä¾‹å¦‚å¯¹äºä½¿ç”¨<code>LIKE</code>æˆ–<code>%</code>æ“ä½œç¬¦çš„æ¨¡ç³ŠæŸ¥è¯¢ï¼Œç´¢å¼•å¯èƒ½ä¼šå¤±æ•ˆã€‚</li><li>ç´¢å¼•å¯èƒ½ä¼šé™ä½æ•°æ®åº“çš„æ•´ä½“æ€§èƒ½ï¼šè™½ç„¶ç´¢å¼•å¯ä»¥åŠ é€ŸæŸ¥è¯¢ï¼Œä½†æ˜¯è¿‡å¤šçš„ç´¢å¼•å¯èƒ½ä¼šé™ä½æ•°æ®åº“çš„æ•´ä½“æ€§èƒ½ã€‚å› ä¸ºç´¢å¼•ä¹Ÿä¼šå ç”¨ä¸€å®šçš„ç³»ç»Ÿèµ„æºï¼Œä¾‹å¦‚CPUã€å†…å­˜ç­‰ï¼Œå¦‚æœç´¢å¼•å¤ªå¤šï¼Œä¼šå¯¼è‡´ç³»ç»Ÿèµ„æºä¸è¶³ï¼Œä»è€Œå½±å“æ•°æ®åº“çš„æ•´ä½“æ€§èƒ½ã€‚</li></ol></li></ul>              </div>            </details><h2 id="MySQLä¸­varcharå’Œcharçš„åŒºåˆ«ï¼Ÿvarchar-30-ä¸­çš„30ä»£è¡¨çš„å«ä¹‰">MySQLä¸­varcharå’Œcharçš„åŒºåˆ«ï¼Ÿvarchar(30)ä¸­çš„30ä»£è¡¨çš„å«ä¹‰</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>varcharå’Œcharæ˜¯ä¸¤ç§ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºå­˜å‚¨æ–¹å¼å’Œå­˜å‚¨ç©ºé—´çš„ä½¿ç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œcharæ˜¯ä¸€ç§å›ºå®šé•¿åº¦çš„å­—ç¬¦ç±»å‹ï¼Œè€Œvarcharæ˜¯ä¸€ç§å¯å˜é•¿åº¦çš„å­—ç¬¦ç±»å‹ã€‚</li><li>åœ¨charç±»å‹ä¸­ï¼Œå¦‚æœæŒ‡å®šäº†ä¸€ä¸ªé•¿åº¦ä¸ºNçš„charå­—æ®µï¼Œé‚£ä¹ˆè¯¥å­—æ®µæ€»æ˜¯å ç”¨Nä¸ªå­—ç¬¦çš„å­˜å‚¨ç©ºé—´ï¼Œå³ä½¿å®é™…å­˜å‚¨çš„å­—ç¬¦æ•°å°äºNï¼Œä¹Ÿä¸ä¼šé‡Šæ”¾å¤šä½™çš„å­˜å‚¨ç©ºé—´ã€‚</li><li>åœ¨varcharç±»å‹ä¸­ï¼Œå¦‚æœæŒ‡å®šäº†ä¸€ä¸ªé•¿åº¦ä¸ºNçš„varcharå­—æ®µï¼Œé‚£ä¹ˆæ”¹ç»„æ®µå¯ä»¥å­˜å‚¨æœ€å¤šNä¸ªå­—ç¬¦çš„æ•°æ®ï¼Œä½†å®é™…å­˜å‚¨çš„å­—ç¬¦æ•°å¯èƒ½ä¼šå°äºNï¼Œæ­¤æ—¶è¯¥å­—æ®µå°†åªå ç”¨å®é™…å­˜å‚¨çš„å­—ç¬¦æ•°çš„å­˜å‚¨ç©ºé—´ï¼Œè€Œä¸æ˜¯å›ºå®šé•¿åº¦çš„å­˜å‚¨ç©ºé—´</li><li>åœ¨varchar(30)ä¸­ï¼Œ30è¡¨ç¤ºè¯¥å­—æ®µå¯ä»¥å­˜å‚¨çš„æœ€å¤§å­—ç¬¦æ•°ä¸º30ï¼Œä½†å®é™…å­˜å‚¨çš„å­—ç¬¦æ•°å¯èƒ½å°äº30ã€‚å¦‚æœå®é™…ä½¿ç”¨ä¸­å­˜å‚¨çš„è‡ªä»˜è¶…è¿‡äº†30ï¼Œé‚£ä¹ˆMySQLå°†è‡ªåŠ¨æŠ›å‡ºé”™è¯¯æˆ–è€…æˆªæ–­æ•°æ®ã€‚</li></ul>              </div>            </details><h2 id="int-11-ä¸­11ä»£è¡¨çš„æ„ä¹‰">int(11)ä¸­11ä»£è¡¨çš„æ„ä¹‰</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>åœ¨MySQLä¸­ï¼Œint(11)ä¸­çš„11è¡¨ç¤ºå­—æ®µçš„æ˜¾ç¤ºå®½åº¦ï¼Œè€Œä¸æ˜¯å­—æ®µçš„æœ€å¤§å€¼æˆ–è€…å­˜å‚¨ç©ºé—´ã€‚</li></ul>              </div>            </details><h2 id="ä¸ºä»€ä¹ˆSELECT-COUNT-FROM-tableåœ¨InnoDBæ¯”MyISAMæ…¢">ä¸ºä»€ä¹ˆ<code>SELECT COUNT(*) FROM table</code>åœ¨InnoDBæ¯”MyISAMæ…¢</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>åœ¨MySQLä¸­ï¼Œæ‰§è¡Œ<code>SELECT COUNT(*) FROM table</code>è¯­å¥æ—¶ï¼Œä¼šå¯¹è¡¨ä¸­çš„æ¯ä¸€è¡Œè¿›è¡Œä¸€æ¬¡è®¡æ•°æ“ä½œï¼Œå› æ­¤éœ€è¦éå†æ•´ä¸ªè¡¨ã€‚</li><li>å¯¹äºMyISAMè¡¨æ¥è¯´ï¼Œè¡¨ä¸­ä¿å­˜äº†è¡Œæ•°çš„è®¡æ•°å™¨ï¼Œå› æ­¤åœ¨æ‰§è¡Œ<code>SELECT COUNT(*) FROM table</code>æ—¶ï¼Œåªéœ€è¦è¯»å–è®¡æ•°å™¨çš„å€¼ï¼Œè€Œä¸éœ€è¦éå†æ•´ä¸ªè¡¨ï¼Œå› æ­¤æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ã€‚</li><li>ä½†æ˜¯åœ¨InnoDBä¸­ï¼Œç”±äºæ•°æ®å­˜å‚¨çš„ç‰¹æ®Šæ€§è´¨å’Œå®ç°æ–¹å¼ï¼Œæ²¡æœ‰ç±»ä¼¼äºMyISAMçš„è®¡æ•°å™¨æ¥ä¿å­˜è¡¨ä¸­çš„è¡Œæ•°ï¼Œå› æ­¤MySQLéœ€è¦éå†æ•´ä¸ªè¡¨æ¥è¿›è¡Œè®¡æ•°æ“ä½œã€‚</li></ul>              </div>            </details> <h2 id="MySQLç´¢å¼•ç±»å‹æœ‰å“ªäº›">MySQLç´¢å¼•ç±»å‹æœ‰å“ªäº›</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>MySQLæ”¯æŒå¤šç§ç±»å‹çš„ç´¢å¼•ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ç§<ol><li>Bæ ‘ç´¢å¼•ï¼šè¿™æ˜¯MySQLä¸­æœ€åŸºæœ¬çš„ç´¢å¼•ç±»å‹ï¼Œé‡‡ç”¨Bæ ‘ç»“æ„å­˜å‚¨æ•°æ®ï¼Œé€‚ç”¨äºæŸ¥æ‰¾å•ä¸ªå€¼çš„åœºæ™¯ã€‚</li><li>B+æ ‘ç´¢å¼•ï¼šB+æ ‘æ˜¯Bæ ‘çš„ä¸€ç§å˜ä½“ï¼Œåœ¨Bæ ‘çš„åŸºç¡€ä¸Šå¢åŠ äº†å¶å­ç»“ç‚¹çš„æŒ‡é’ˆã€‚å½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œé€‚ç”¨äºèŒƒå›´æŸ¥æ‰¾å’Œæ’åºçš„åœºæ™¯ã€‚</li><li>å“ˆå¸Œç´¢å¼•ï¼šè¿™ç§ç´¢å¼•é‡‡ç”¨å“ˆå¸Œç®—æ³•æ¥å¿«é€Ÿå®šä½æ•°æ®ï¼Œé€‚ç”¨äºç­‰å€¼æŸ¥è¯¢åœºæ™¯ï¼Œä½†ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢å’Œæ’åºã€‚</li><li>å…¨æ–‡ç´¢å¼•ï¼šè¿™ç§ç´¢å¼•ç”¨äºå…¨æ–‡æœç´¢ï¼Œé€‚ç”¨äºå¯¹æ–‡æœ¬è¿›è¡Œæ¨¡ç³ŠåŒ¹é…å’Œæœç´¢çš„åœºæ™¯ã€‚</li></ol></li></ul>              </div>            </details><h2 id="ä»€ä¹ˆæ—¶å€™ä¸è¦ä½¿ç”¨ç´¢å¼•">ä»€ä¹ˆæ—¶å€™ä¸è¦ä½¿ç”¨ç´¢å¼•</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ç´¢å¼•è™½ç„¶å¯ä»¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½æ¶ˆè€—ï¼Œç”šè‡³ä¼šé™ä½æŸ¥è¯¢æ•ˆç‡ã€‚ä»¥ä¸‹æ˜¯ä¸é€‚åˆä½¿ç”¨ç´¢å¼•çš„æƒ…å†µ<ol><li>æ•°æ®é‡éå¸¸å°ï¼šå¯¹äºéå¸¸å°çš„æ•°æ®é›†ï¼Œç´¢å¼•å¯èƒ½ä¸ä¼šå¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½æå‡ï¼Œåè€Œä¼šå¢åŠ é¢å¤–çš„å¼€é”€ã€‚</li><li>ç»å¸¸è¿›è¡Œæ’å…¥ã€åˆ é™¤æˆ–ä¿®æ”¹æ“ä½œï¼šå¯¹è¡¨è¿›è¡Œæ›´æ–°æ“ä½œæ—¶ï¼Œç´¢å¼•ä¹Ÿéœ€è¦æ›´æ–°å’Œç»´æŠ¤ï¼Œä¼šå¯¼è‡´é¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚å¦‚æœå¯¹è¡¨çš„æ›´æ–°æ“ä½œæ¯”è¾ƒé¢‘ç¹ï¼Œé‚£ä¹ˆä½¿ç”¨ç´¢å¼•å¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚</li><li>æœ‰å¤§é‡é‡å¤çš„åˆ—ï¼šå¦‚æœæŸä¸ªåˆ—å­˜åœ¨å¤§é‡é‡å¤çš„å€¼ï¼Œå°±ç®—è¿™ä¸ªåˆ—æ²¡æœ‰å”¯ä¸€æ€§çº¦æŸï¼Œä¹Ÿä¸å»ºè®®å¯¹å…¶å»ºç«‹ç´¢å¼•ã€‚å› ä¸ºç´¢å¼•çš„ç›®çš„æ˜¯å¸®åŠ©æ•°æ®åº“åŠ é€Ÿæ•°æ®çš„æŸ¥æ‰¾å’ŒåŒ¹é…ï¼Œè€Œå¦‚æœä¸€ä¸ªåˆ—å­˜åœ¨å¤§é‡é‡å¤çš„å€¼ï¼Œå»ºç«‹ç´¢å¼•åè€Œä¼šé™ä½æŸ¥è¯¢çš„æ•ˆç‡ã€‚</li></ol></li></ul>              </div>            </details><h2 id="è¯´è¯´ä»€ä¹ˆæ˜¯MVCC">è¯´è¯´ä»€ä¹ˆæ˜¯MVCC</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>MVCC(Multi-Version Concurrency Control, å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)æ˜¯ä¸€ç§ç”¨äºä¿è¯æ•°æ®åº“å¹¶å‘æ€§çš„æŠ€æœ¯ã€‚</li><li>åœ¨ä¼ ç»Ÿçš„æ•°æ®åº“å¹¶å‘æ§åˆ¶æœºåˆ¶ä¸­ï¼Œé”å®šæ˜¯æ§åˆ¶å¹¶å‘è®¿é—®çš„ä¸»è¦æ‰‹æ®µã€‚å½“å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®åŒä¸€è¡Œæ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šå¯¹è¯¥è¡Œæ•°æ®è¿›è¡Œé”å®šï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªäº‹åŠ¡å®Œæˆæ“ä½œå¹¶é‡Šæ”¾é”ä¹‹åï¼Œå…¶ä»–äº‹åŠ¡æ‰èƒ½è®¿é—®è¯¥è¡Œæ•°æ®ã€‚è¿™ç§æ–¹å¼è™½ç„¶å¯ä»¥ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®‰å…¨æ€§ï¼Œä½†æ˜¯ä¼šå¼•å…¥è®¸å¤šé—®é¢˜ï¼Œå¦‚æ­»é”ã€æ€§èƒ½ç“¶é¢ˆç­‰ã€‚</li><li>MVCCé‡‡ç”¨äº†ä¸€ç§ä¸åŒçš„æ–¹å¼æ¥æ§åˆ¶å¹¶å‘è®¿é—®ã€‚åœ¨MVCCä¸­ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>ç‰ˆæœ¬</code>ï¼ˆæˆ–è€…è¯´æ˜¯å¿«ç…§ï¼‰çš„æ•°æ®ï¼Œä¸åŒçš„äº‹åŠ¡ä¹‹é—´ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬æ¥é¿å…å†²çªã€‚å½“ä¸€ä¸ªäº‹åŠ¡æ›´æ–°æŸä¸ªæ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œå¹¶åœ¨äº‹åŠ¡æäº¤æ—¶å°†å…¶å†™å…¥ç£ç›˜ã€‚å…¶ä»–äº‹åŠ¡ç»§ç»­ä½¿ç”¨æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼Œç›´åˆ°å®ƒä»¬æäº¤æˆ–å›æ»šäº‹åŠ¡ï¼Œç„¶åå†ä½¿ç”¨æ–°ç‰ˆæœ¬çš„æ•°æ®ã€‚è¿™æ ·å¯ä»¥é¿å…é”å®šå’Œæ­»é”ç­‰é—®é¢˜ï¼Œå¹¶æé«˜å¹¶å‘è®¿é—®çš„æ•ˆç‡ã€‚</li></ul>              </div>            </details><h2 id="MVCCå¯ä»¥ä¸ºæ•°æ®åº“è§£å†³ä»€ä¹ˆé—®é¢˜">MVCCå¯ä»¥ä¸ºæ•°æ®åº“è§£å†³ä»€ä¹ˆé—®é¢˜</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>MVCCå¯ä»¥è§£å†³æ•°æ®åº“ä¸­å¹¶å‘æ€§å’Œä¸€è‡´æ€§çš„é—®é¢˜ã€‚æ•°æ®åº“ä¸­çš„å¹¶å‘æ€§é—®é¢˜åŒ…æ‹¬äº†è¯»å†™å†²çªã€æ­»é”ç­‰ï¼Œè€ŒMVCCé€šè¿‡é‡‡ç”¨ä¹è§‚é”çš„æ–¹å¼ï¼Œå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è¯»å–ä¸€ä¸ªæ•°æ®ï¼ŒåŒæ—¶åˆèƒ½å¤Ÿä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</li><li>å…·ä½“æ¥è¯´ï¼ŒMVCCå®ç°äº†ä»¥ä¸‹ç‰¹æ€§<ol><li>å¯é‡å¤åº¦ï¼šé€šè¿‡ä½¿ç”¨æ¯ä¸ªäº‹ç‰©çš„ç‹¬ç«‹ç‰ˆæœ¬å¿«ç…§æ¥é¿å…æ•°æ®è¢«å…¶ä»–å¹¶å‘äº‹åŠ¡ä¿®æ”¹è€Œå¯¼è‡´çš„è¯»å–ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li><li>éé˜»å¡è¯»ï¼šè¯»æ“ä½œä¸ä¼šé˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸ä¼šé˜»å¡è¯»æ“ä½œã€‚</li><li>æ— é”å†™ï¼šMVCCä½¿ç”¨CAS(Compare-And-Swap)æ“ä½œæ¥å®ç°ä¹è§‚é”ï¼Œé¿å…äº†ä¼ ç»Ÿé”æœºåˆ¶çš„ç“¶é¢ˆå’Œç¼ºé™·ã€‚</li><li>é¿å…æ­»é”ï¼šMVCCä¸ä½¿ç”¨ä¼ ç»Ÿé”æœºåˆ¶ï¼Œé¿å…äº†ä¼ ç»Ÿé”æœºåˆ¶ä¸­å¯èƒ½å‘ç”Ÿçš„æ­»é”çš„é—®é¢˜ã€‚</li><li>é«˜å¹¶å‘ï¼šMVCCé€šè¿‡æä¾›å¹¶å‘äº‹åŠ¡çš„ç‹¬ç«‹å¿«ç…§æ¥ä¿è¯è¯»å–çš„ä¸€è‡´æ€§ï¼Œä»è€Œæé«˜äº†æ•°æ®åº“çš„å¹¶å‘æ€§èƒ½ã€‚</li></ol></li><li>æ€»ä¹‹ï¼ŒMVCCèƒ½å¤Ÿä½¿æ•°æ®åº“åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¿æŒä¸€è‡´æ€§å’Œå¯é æ€§ï¼Œä½¿å¾—å¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶è®¿é—®åŒä¸€ä¸ªæ•°æ®åº“ï¼Œä»è€Œæé«˜äº†æ•°æ®åº“çš„å¹¶å‘æ€§èƒ½ã€‚</li></ul>              </div>            </details><h2 id="è¯´è¯´MVCCçš„å®ç°åŸç†">è¯´è¯´MVCCçš„å®ç°åŸç†</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>MVCCçš„å®ç°åŸç†ä¸»è¦åŒ…æ‹¬ç‰ˆæœ¬å·ã€å¿«ç…§ã€å›æ»šæ®µã€å¤šç‰ˆæœ¬ç´¢å¼•ç­‰æŠ€æœ¯ã€‚<ol><li>ç‰ˆæœ¬å·ï¼šæ¯ä¸ªæ•°æ®è¡Œéƒ½æœ‰ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œç”¨æ¥æ ‡è¯†è¯¥è¡Œæ•°æ®çš„ç‰ˆæœ¬ã€‚åœ¨MySQLä¸­ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä½¿ç”¨ä¸€ä¸ª6å­—èŠ‚çš„äº‹åŠ¡IDå’Œä¸€ä¸ª7å­—èŠ‚çš„é€’å¢è®¡æ•°å™¨æ¥è¡¨ç¤ºç‰ˆæœ¬å·ã€‚</li><li>å¿«ç…§ï¼šæ¯ä¸ªäº‹åŠ¡åœ¨å¼€å§‹æ‰§è¡Œæ—¶ï¼Œä¼šå»ºç«‹ä¸€ä¸ªå¿«ç…§(Snapshot)ï¼Œç”¨æ¥è®°å½•å½“å‰æ—¶é—´ç‚¹çš„æ•°æ®åº“çŠ¶æ€ã€‚è¿™ä¸ªå¿«ç…§å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªäº‹åŠ¡çš„<code>è§†å›¾</code>ï¼Œåæ˜ äº†å®ƒæ‰€èƒ½çœ‹åˆ°çš„æ•°æ®çŠ¶æ€ã€‚åœ¨æŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®äº‹åŠ¡çš„å¿«ç…§ï¼Œè¿”å›ç›¸åº”ç‰ˆæœ¬çš„æ•°æ®ã€‚</li><li>å›æ»šæ®µï¼šåœ¨MVCCä¸­ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå›æ»šæ®µ(Rollback Segment)ï¼Œç”¨æ¥ä¿å­˜è¯¥äº‹ç‰©æ‰€åšçš„ä¿®æ”¹ã€‚å¦‚æœäº‹åŠ¡éœ€è¦å›æ»šï¼Œç³»ç»Ÿå°±å¯ä»¥åˆ©ç”¨å›æ»šæ®µä¸­çš„ä¿¡æ¯æ¥å›å¤æ•°æ®çš„åŸå§‹çŠ¶æ€ã€‚</li><li>å¤šç‰ˆæœ¬ç´¢å¼•ï¼šä¸ºäº†æ”¯æŒMVCCï¼Œæ•°æ®åº“é€šå¸¸ä¼šä½¿ç”¨å¤šç‰ˆæœ¬ç´¢å¼•(Multi-Version Index)æ¥è®°å½•æ•°æ®çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚å¤šç‰ˆæœ¬ç´¢å¼•åŒ…å«å¤šä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œæ¯ä¸ªç‰ˆæœ¬éƒ½æœ‰è‡ªå·±çš„ç‰ˆæœ¬å·å’Œå¿«ç…§ä¿¡æ¯ã€‚å½“äº‹åŠ¡æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®äº‹åŠ¡çš„å¿«ç…§ï¼Œè¿”å›ç›¸åº”ç‰ˆæœ¬çš„æ•°æ®ã€‚</li></ol></li><li>MVCCçš„å®ç°åŸç†å¯ä»¥æ¦‚æ‹¬ä¸ºï¼šæ¯ä¸ªäº‹åŠ¡éƒ½æœ‰è‡ªå·±çš„å¿«ç…§ï¼Œç”¨æ¥è®°å½•å½“å‰æ—¶é—´ç‚¹çš„æ•°æ®çŠ¶æ€ã€‚åœ¨æŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®äº‹åŠ¡çš„å¿«ç…§ï¼Œè¿”å›ç›¸åº”ç‰ˆæœ¬çš„æ•°æ®ã€‚å½“äº‹åŠ¡éœ€è¦å›æ»šæ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œå¹¶å°†æ—§ç‰ˆæœ¬æ ‡è®°ä¸º<code>å·²åˆ é™¤</code>ã€‚å¦‚æœäº‹åŠ¡éœ€è¦å›æ»šï¼Œç³»ç»Ÿå°±å¯ä»¥åˆ©ç”¨å›æ»šæ®µä¸­çš„ä¿¡æ¯ï¼Œæ¢å¤æ•°æ®çš„åŸå§‹çŠ¶æ€ã€‚å¤šç‰ˆæœ¬ç´¢å¼•ç”¨äºè®°å½•æ•°æ®çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œä»¥ä¾¿ç³»ç»Ÿèƒ½å¤Ÿå¿«é€Ÿåœ°æ‰¾åˆ°ç›¸åº”ç‰ˆæœ¬çš„æ•°æ®ã€‚è¿™äº›æŠ€æœ¯ç›¸äº’é…åˆï¼Œå®ç°äº†MVCCçš„é«˜æ•ˆå¹¶å‘æ§åˆ¶ã€‚</li></ul>              </div>            </details><h2 id="è¯´è¯´MySQLæ•°æ®åº“çš„é”">è¯´è¯´MySQLæ•°æ®åº“çš„é”</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>MySQLæ•°æ®åº“ä¸­çš„é”åˆ†ä¸ºå…±äº«é”(Shared Lock)å’Œæ’å®ƒé”(Exclusive Lock)ä¸¤ç§ã€‚<ol><li>å…±äº«é”ï¼šä¹Ÿè¢«ç§°ä¸ºè¯»é”ï¼Œå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è¯»å–åŒä¸€ä»½æ•°æ®ï¼Œä½†ä¸å…è®¸ä»»ä½•äº‹ç‰©å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œæ‰¾åˆ°æ‰€æœ‰å…±äº«é”éƒ½è¢«é‡Šæ”¾ã€‚</li><li>æ’ä»–é”ï¼šä¹Ÿè¢«ç§°ä¸ºå†™é”ï¼Œåªå…è®¸ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•è¯»å–æˆ–ä¿®æ”¹æ•°æ®ï¼Œç›´åˆ°æ’ä»–é”è¢«é‡Šæ”¾ã€‚</li></ol></li><li>MySQLè¿˜æ”¯æŒè¡¨çº§é”è¡Œçº§é”ä¸¤ç§ç²’åº¦çš„é”<ol><li>è¡¨çº§é”ï¼šæ˜¯å¯¹æ•´å¼ è¡¨çš„é”ï¼Œå¯ä»¥é”å®šæ•´ä¸ªè¡¨ï¼Œé¿å…å…¶ä»–äº‹åŠ¡å¯¹è¯¥è¡¨è¿›è¡Œä»»ä½•æ“ä½œã€‚è¡¨çº§é”çš„ä¼˜ç‚¹æ˜¯ç®€å•ï¼Œç³»ç»Ÿå¼€é”€å°ï¼Œé€‚ç”¨äºå¯¹è¡¨è¿›è¡Œå…¨å±€æ€§æ“ä½œï¼›ç¼ºç‚¹æ˜¯ç²’åº¦å¤ªå¤§ï¼Œä¼šå¯¼è‡´å¹¶å‘æ€§èƒ½ä¸‹é™ã€‚MyISAMä½¿ç”¨è¡¨çº§é”ã€‚</li><li>è¡Œçº§é”ï¼šæ˜¯é’ˆå¯¹å•ä¸ªæ•°æ®è¡Œçš„é”ï¼Œåªé”å®šéœ€è¦ä¿®æ”¹çš„æ•°æ®è¡Œï¼Œé¿å…å…¶ä»–äº‹åŠ¡å¯¹è¯¥æ•°æ®è¿›è¡Œæ“ä½œã€‚è¡Œçº§é”çš„ä¼˜ç‚¹æ˜¯ç²’åº¦å°ï¼Œå‘ç”Ÿå†²çªæ¦‚ç‡ä½ï¼Œå¯ä»¥æé«˜å¹¶å‘æ€§èƒ½ï¼›ç¼ºç‚¹æ˜¯å®ç°å¤æ‚ï¼Œéœ€è¦ç»´æŠ¤é”å®šçš„æ•°æ®è¡Œå’Œäº‹åŠ¡çš„çŠ¶æ€ï¼Œå®¹æ˜“å‡ºç°æ­»é”ã€‚InnoDBæ”¯æŒè¡Œé”ï¼ˆå¿…é¡»æœ‰ç´¢å¼•æ‰èƒ½å®ç°ï¼Œå¦åˆ™ä¼šè‡ªåŠ¨é”å…¨è¡¨ï¼Œå˜æˆè¡¨çº§é”ï¼‰</li></ol></li></ul>              </div>            </details><h2 id="ä»€ä¹ˆæ˜¯é”å‡çº§">ä»€ä¹ˆæ˜¯é”å‡çº§</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>é”å‡çº§æ˜¯æŒ‡å°†è¡Œçº§é”å‡çº§ä¸ºè¡¨çº§é”çš„è¿‡ç¨‹ã€‚MySQLä¸­é»˜è®¤ä½¿ç”¨çš„æ˜¯è¡Œçº§é”ï¼Œåœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œéœ€è¦ä½¿ç”¨è¡¨çº§é”ï¼Œä½†æ˜¯å¦‚æœè¡¨ä¸Šå·²ç»å­˜åœ¨è¡Œçº§é”ï¼Œå°±éœ€è¦å°†è¡Œçº§é”å‡çº§ä¸ºè¡¨çº§é”ï¼Œä»è€Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚</li><li>é”å‡çº§ä¸€èˆ¬ä¼šåœ¨ä»¥ä¸‹æƒ…å†µå‘ç”Ÿï¼š<ol><li>å½“å‰ä¼šè¯éœ€è¦æ›´æ–°çš„è¡Œæ•°å¤ªå¤šï¼Œå¯¼è‡´è·å–è¡Œçº§é”çš„æ—¶é—´è¿‡é•¿ï¼Œä»è€Œå½±å“ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ï¼Œæ­¤æ—¶å¯ä»¥å°†è¡Œçº§é”å‡çº§ä¸ºè¡¨çº§é”ã€‚</li><li>å½“å‰ä¼šè¯éœ€è¦æ‰§è¡Œçš„æ“ä½œå·²ç»æ¶‰åŠåˆ°æ•´å¼ è¡¨çš„æ•°æ®ï¼Œæ¯”å¦‚å¯¹è¡¨è¿›è¡ŒTRUNCATEã€DROPç­‰æ“ä½œï¼Œæ­¤æ—¶éœ€è¦å°†è¡Œçº§é”å‡çº§ä¸ºè¡¨çº§é”ã€‚</li></ol></li><li>é”å‡çº§çš„è¿‡ç¨‹æ˜¯è‡ªåŠ¨çš„ï¼Œç”±MySQLå†…éƒ¨çš„é”ç®¡ç†å™¨æ¥æ§åˆ¶ï¼Œå…·ä½“å®ç°ç»†èŠ‚å¯ä»¥å‚è€ƒMySQLçš„å®˜æ–¹æ–‡æ¡£ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé”å‡çº§ä¼šå¯¹ç³»ç»Ÿçš„æ€§èƒ½äº§ç”Ÿä¸€å®šçš„å½±å“ï¼Œå› æ­¤åœ¨å®é™…çš„åº”ç”¨ä¸­éœ€è¦è°¨æ…ä½¿ç”¨ï¼Œå°½é‡é¿å…é”å‡çº§çš„æƒ…å†µã€‚</li></ul>              </div>            </details><h2 id="è¯´è¯´æ‚²è§‚é”å’Œä¹è§‚é”">è¯´è¯´æ‚²è§‚é”å’Œä¹è§‚é”</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>æ‚²è§‚é”å’Œä¹è§‚é”æ˜¯ä¸¤ç§å¸¸è§çš„å¹¶å‘æ§åˆ¶æ–¹å¼ã€‚<ol><li>æ‚²è§‚é”çš„æ€æƒ³æ˜¯ï¼šå‡è®¾å¹¶å‘è®¿é—®çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å¾ˆå¯èƒ½ä¼šè¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œå› æ­¤åœ¨è®¿é—®æ•°æ®å‰å°±ä¼šåŠ é”ï¼Œé˜²æ­¢å…¶ä»–ç”¨æˆ·å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚æ‚²è§‚é”çš„å®ç°æ–¹å¼ä¸€èˆ¬æ˜¯é€šè¿‡æ•°æ®åº“çš„é”æœºåˆ¶æ¥å®ç°çš„ï¼Œä¾‹å¦‚è¡Œçº§é”ã€è¡¨çº§é”ç­‰ã€‚</li><li>ä¹è§‚é”çš„æ€æƒ³æ˜¯ï¼šå‡è®¾å¹¶å‘è®¿é—®çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å¾ˆå°‘ä¼šå‘ç”Ÿå†²çªï¼Œå› æ­¤åœ¨è®¿é—®æ•°æ®å‰ä¸ä¼šåŠ é”ï¼Œè€Œæ˜¯é€šè¿‡åœ¨æ•°æ®ä¸Šå¢åŠ ç‰ˆæœ¬å·ç­‰æœºåˆ¶æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ã€‚ä¹è§‚é”çš„å®ç°æ–¹å¼ä¸€èˆ¬æ˜¯é€šè¿‡åœ¨æ•°æ®è¡¨ä¸­å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³ç­‰å­—æ®µï¼Œæ¯æ¬¡ä¿®æ”¹æ•°æ®æ—¶éƒ½ä¼šæ›´æ–°è¿™ä¸ªç‰ˆæœ¬å·ï¼Œå¦‚æœè¯»å–æ•°æ®æ˜¯å‘ç°ç‰ˆæœ¬å·ä¸é¢„æœŸçš„ä¸ä¸€è‡´ï¼Œåˆ™è¯´æ˜æ•°æ®å·²ç»è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œéœ€è¦é‡æ–°è¯»å–æ•°æ®ã€‚</li></ol></li></ul>              </div>            </details><h2 id="æ€æ ·å°½é‡é¿å…æ­»é”çš„å‡ºç°">æ€æ ·å°½é‡é¿å…æ­»é”çš„å‡ºç°</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>æ­»é”æ˜¯æŒ‡å¤šä¸ªäº‹åŠ¡åœ¨äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºè€Œæ— æ³•ç»§ç»­æ‰§è¡Œçš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦DBMSçš„å¹²é¢„æ‰èƒ½è§£é™¤æ­»é”ã€‚ä¸‹é¢æ˜¯ä¸€äº›å°½é‡é¿å…æ­»é”çš„æ–¹æ³•ï¼š<ol><li>å°½é‡å‡å°‘äº‹åŠ¡æŒæœ‰èµ„æºçš„æ—¶é—´ï¼Œæ¯”å¦‚é¿å…åœ¨äº‹åŠ¡ä¸­è¿›è¡Œå¤§é‡è®¡ç®—å’Œé€»è¾‘å¤„ç†ã€‚</li><li>å°½é‡åœ¨äº‹åŠ¡å¼€å§‹æ—¶å°±ç¡®å®šéœ€è¦è®¿é—®çš„æ•°æ®ï¼Œé¿å…åœ¨äº‹åŠ¡ä¸­æ ¹æ®æ¡ä»¶åŠ¨æ€æ£€ç´¢æ•°æ®ã€‚</li><li>é¿å…é•¿æ—¶é—´å ç”¨å¤šä¸ªèµ„æºï¼Œæ¯”å¦‚å¯¹å¤šä¸ªè¡¨è¿›è¡Œæ›´æ–°æ“ä½œã€‚</li><li>å°½é‡ä½¿ç”¨è¾ƒçŸ­çš„äº‹åŠ¡ï¼Œè¿™æ ·é”çš„ç­‰å¾…æ—¶é—´ä¼šå‡å°‘ã€‚</li><li>ä¼˜åŒ–SQLè¯­å¥ï¼Œå°½é‡é¿å…å…¨è¡¨æ‰«ææˆ–ç´¢å¼•å¤±æ•ˆç­‰æƒ…å†µã€‚</li></ol></li><li>å¦‚æœæ­»é”æ— æ³•é¿å…ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä½œä¸ºä¿åº•æ‰‹æ®µè§£é™¤æ­»é”ï¼š<ol><li>è®¾ç½®ç­‰å¾…è¶…æ—¶æœºåˆ¶ï¼šå½“ä¸€ä¸ªäº‹åŠ¡åœ¨ä¸€å®šæ—¶é—´å†…æ— æ³•è·å¾—é”ï¼Œå°±ä¸»åŠ¨æ”¾å¼ƒç­‰å¾…å¹¶ç»“æŸäº‹åŠ¡ï¼Œç„¶åå†é‡è¯•ã€‚</li><li>æ­»é”æ£€æµ‹ï¼šDBMSå®šæ—¶æ£€æµ‹ç³»ç»Ÿä¸­çš„æ­»é”æƒ…å†µï¼Œå¹¶å°†å…¶è§£é™¤ã€‚è¿™ç§æ–¹æ³•ä¼šæ¶ˆè€—ä¸€å®šçš„ç³»ç»Ÿèµ„æºï¼Œæ‰€ä»¥ä¸é€‚åˆåœ¨é«˜å¹¶å‘çš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</li></ol></li></ul>              </div>            </details><h2 id="ä½¿ç”¨MySQLçš„ç´¢å¼•æ—¶éœ€è¦æ³¨æ„ä»€ä¹ˆ">ä½¿ç”¨MySQLçš„ç´¢å¼•æ—¶éœ€è¦æ³¨æ„ä»€ä¹ˆ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä½¿ç”¨MySQLçš„ç´¢å¼•æ—¶éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹<ol><li>åº”å°½é‡é¿å…åœ¨<code>WHERE</code>å­å¥ä¸­ä½¿ç”¨<code>!=</code>æˆ–<code>&lt;&gt;</code>æ“ä½œç¬¦ï¼Œå¦åˆ™å°†å¼•æ“æ”¾å¼ƒç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æã€‚ä¼˜åŒ–å™¨å°†æ— æ³•é€šè¿‡ç´¢å¼•æ¥ç¡®å®šå°†è¦å‘½ä¸­çš„è¡Œæ•°ï¼Œå› æ­¤éœ€è¦æŸ¥è¯¢è¯¥è¡¨çš„æ‰€æœ‰è¡Œã€‚</li><li>åº”å°½é‡é¿å…åœ¨<code>WHERE</code>å­å¥ä¸­ç”¨<code>OR</code>æ¥è¿æ¥æ¡ä»¶ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«çŒ«ï¼Œå¦‚: <code>SELECT id FROM t WHERE num = 10 OR num = 20</code></li><li>åº”å°½é‡é¿å…åœ¨<code>WHERE</code>å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œè¡¨è¾¾å¼æ“ä½œï¼Œè¿™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æ.</li><li>åº”å°½é‡é¿å…åœ¨<code>WHERE</code>å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œå‡½æ•°æ“ä½œï¼Œè¿™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æ.</li><li>ä¸è¦åœ¨<code>WHERE</code>å­å¥ä¸­çš„<code>=</code>å·¦è¾¹è¿›è¡Œå‡½æ•°ã€ç®—æœ¯è¿ç®—æˆ–å…¶ä»–è¡¨è¾¾å¼è¿ç®—ï¼Œå¦åˆ™ç³»ç»Ÿå°†å¯èƒ½æ— æ³•æ­£ç¡®ä½¿ç”¨ç´¢å¼•ã€‚</li><li>å¤åˆç´¢å¼•éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™ã€‚</li><li>å¦‚æœ<code>MySQL</code>è¯„ä¼°ä½¿ç”¨ç´¢å¼•æ¯”å…¨è¡¨æ‰«ææ›´æ…¢ï¼Œä¼šæ”¾å¼ƒä½¿ç”¨ç´¢å¼•ã€‚å¦‚æœæ­¤æ—¶æƒ³è¦ç´¢å¼•ï¼Œå¯ä»¥åœ¨è¯­å¥ä¸­æ·»åŠ å¼ºåˆ¶ç´¢å¼•ã€‚</li><li>åˆ—ç±»å‹æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ŒæŸ¥è¯¢æ—¶ä¸€å®šè¦ç»™å€¼åŠ å¼•å·ï¼Œå¦åˆ™ç´¢å¼•å¤±æ•ˆ.</li><li>LIKE çš„æ¨¡ç³ŠæŸ¥è¯¢å¯èƒ½ä¼šå¯¼è‡´æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚åŸå› æ˜¯ LIKE è¯­å¥ä¸­çš„é€šé…ç¬¦ï¼ˆ% æˆ– _ï¼‰ä½¿å¾—ç´¢å¼•å¤±æ•ˆã€‚å¦‚æœéœ€è¦æ¨¡ç³ŠåŒ¹é…ï¼Œå¯ä»¥ä½¿ç”¨å…¨æ–‡ç´¢å¼•å¼•æ“ï¼ˆä¾‹å¦‚ElasticSearchï¼‰</li><li>è¡¨å­—æ®µä¸ºNULLï¼Œä¹Ÿä¸å¯ä»¥ä½¿ç”¨ç´¢å¼•çš„</li></ol></li></ul>              </div>            </details><h2 id="ä¸»é”®å’Œå€™é€‰é”®æœ‰ä»€ä¹ˆåŒºåˆ«">ä¸»é”®å’Œå€™é€‰é”®æœ‰ä»€ä¹ˆåŒºåˆ«</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä¸»é”®å’Œå€™é€‰é”®éƒ½æ˜¯ç”¨æ¥å”¯ä¸€æ ‡è¯†ä¸€å¼ è¡¨ä¸­æ¯ä¸ªè¡Œçš„é”®ï¼Œä½†æ˜¯å®ƒä»¬ä¹‹é—´æœ‰ä¸€äº›åŒºåˆ«<ol><li>ä¸»é”®å¿…é¡»æ˜¯éç©ºã€å”¯ä¸€çš„ã€‚</li><li>å€™é€‰é”®ä¹Ÿæ˜¯å”¯ä¸€æ ‡è¯†ä¸€å¼ è¡¨ä¸­æ¯ä¸ªè¡Œçš„é”®ï¼Œä½†ä¸æ˜¯å¿…é¡»éç©ºçš„ï¼Œåœ¨ä¸€ä¸ªè¡¨ä¸­å¯ä»¥æœ‰å¤šä¸ªå€™é€‰é”®ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰å€™é€‰é”®ã€‚</li><li>ä¸»é”®æ˜¯ä¸€ç§ç‰¹æ®Šçš„å€™é€‰é”®ï¼Œå®ƒæ˜¯è¡¨çš„ä¸»è¦æ ‡è¯†ï¼Œç”¨äºä¿è¯è¡¨ä¸­çš„æ¯ä¸ªè¡Œçš„å”¯ä¸€æ€§ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šä¸»é”®ï¼Œåˆ™å¯ä»¥é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„å€™é€‰é”®ä½œä¸ºä¸»é”®ã€‚å€™é€‰é”®å¯ä»¥æ˜¯å¤šä¸ªï¼Œä½†åªæœ‰ä¸€ä¸ªå¯ä»¥æˆä¸ºä¸»é”®ã€‚</li></ol></li></ul>              </div>            </details><h2 id="ä¸»é”®å’Œç´¢å¼•æœ‰ä»€ä¹ˆåŒºåˆ«">ä¸»é”®å’Œç´¢å¼•æœ‰ä»€ä¹ˆåŒºåˆ«</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ä¸»é”®å’Œç´¢å¼•éƒ½å¯ä»¥ç”¨æ¥å”¯ä¸€æ ‡è¯†ä¸€å¼ è¡¨ä¸­çš„è®°å½•ï¼Œä½†å®ƒä»¬æœ‰ä¸€äº›åŒºåˆ«<ol><li>ä¸»é”®æ˜¯ä¸€ç§å”¯ä¸€æ€§çº¦æŸï¼Œä¿è¯è¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ€§ã€‚è€Œç´¢å¼•çŸ¥è¯†ä¸€ç§è¾…åŠ©æ•°æ®ç»“æ„ï¼Œç”¨äºæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚</li><li>ä¸»é”®ä¸€å®šä¼šåˆ›å»ºä¸€ä¸ªå”¯ä¸€ç´¢å¼•ï¼Œä½†æ˜¯æœ‰å”¯ä¸€ç´¢å¼•çš„åˆ—ä¸ä¸€å®šæ˜¯ä¸»é”®ã€‚</li><li>ä¸»é”®ä¸å…è®¸ä¸ºç©ºå€¼ï¼Œå”¯ä¸€ç´¢å¼•åˆ—å…è®¸ä¸ºç©ºå€¼ã€‚</li><li>ä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä½†æ˜¯å¯ä»¥æœ‰å¤šä¸ªå”¯ä¸€ç´¢å¼•ã€‚</li><li>ä¸»é”®å¯ä»¥è¢«å…¶ä»–è¡¨å¼•ç”¨ä¸ºå¤–é”®ï¼Œå”¯ä¸€ç´¢å¼•åˆ—ä¸å¯ä»¥ã€‚</li></ol></li></ul>              </div>            </details><h2 id="MySQLå¦‚ä½•åšåˆ°é«˜å¯ç”¨æ–¹æ¡ˆ">MySQLå¦‚ä½•åšåˆ°é«˜å¯ç”¨æ–¹æ¡ˆ</h2><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>MySQLçš„é«˜å¯ç”¨æ–¹æ¡ˆå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å®ç°ï¼š<ol><li>ä¸»ä»å¤åˆ¶ï¼šå°†ä¸€ä¸ªMySQLå®ä¾‹ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œå…¶ä½™MySQLå®ä¾‹ä½œä¸ºä»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹ä¸Šçš„æ“ä½œä¼šè¢«è‡ªåŠ¨åŒæ­¥åˆ°ä»èŠ‚ç‚¹ä¸Šï¼Œä»è€Œè¾¾åˆ°é«˜å¯ç”¨çš„ç›®çš„ã€‚å½“ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œå¯ä»¥å°†å…¶ä¸­ä¸€ä¸ªä»èŠ‚ç‚¹æå‡ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</li><li>æ•°æ®åº“é›†ç¾¤ï¼šå°†å¤šä¸ªMySQLå®ä¾‹ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œæ¯ä¸ªç¤ºä¾‹éƒ½å¯ä»¥å¤„ç†è¯·æ±‚ï¼Œå½“å…¶ä¸­ä¸€ä¸ªå®ä¾‹å‡ºç°æ•…éšœæ—¶ï¼Œå…¶ä»–å®ä¾‹ä¼šè‡ªåŠ¨æ¥ç®¡è¯·æ±‚ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</li><li>æ•°æ®åº“ä»£ç†ï¼šé€šè¿‡å¼•å…¥æ•°æ®åº“ä»£ç†å±‚ï¼Œå°†å¤šä¸ªMySQLå®ä¾‹è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œæä¾›è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»ã€è‡ªåŠ¨åˆ‡æ¢ç­‰åŠŸèƒ½ï¼Œä»è€Œè¾¾åˆ°é«˜å¯ç”¨çš„ç›®çš„ã€‚</li><li>æ•°æ®åº“å¤‡ä»½å’Œæ¢å¤ï¼šé€šè¿‡å®šæœŸå¤‡ä»½æ•°æ®åº“ï¼Œå°†å¤‡ä»½æ•°æ®å­˜å‚¨åˆ°å…¶ä»–ä½ç½®ï¼Œå½“å‡ºç°æ•…éšœæ—¶ï¼Œå¯ä»¥é€šè¿‡å¤‡ä»½æ•°æ®è¿›è¡Œå¿«é€Ÿæ¢å¤ï¼Œä»è€Œè¾¾åˆ°é«˜å¯ç”¨çš„ç›®çš„ã€‚</li></ol></li></ul>              </div>            </details><h2 id="é¢è¯•æ¨¡æ‹Ÿ">é¢è¯•æ¨¡æ‹Ÿ</h2><ul><li>é¢è¯•å®˜ï¼šäº†è§£è¿‡ç´¢å¼•å—ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ç´¢å¼•åœ¨é¡¹ç›®ä¸­è¿˜æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œå®ƒæ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦æ˜¯ç”¨æ¥æé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®åº“çš„IOæˆæœ¬ï¼ŒåŒæ—¶é€šè¿‡ç´¢å¼•åˆ—å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½æ•°æ®æ’åºçš„æˆæœ¬ï¼Œä¹Ÿèƒ½é™ä½CPUçš„æ¶ˆè€—</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šç´¢å¼•åº•å±‚çš„æ•°æ®ç»“æ„äº†è§£è¿‡å—ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>MySQLç°åœ¨é»˜è®¤çš„å­˜å‚¨å¼•æ“æ˜¯InnoDBï¼Œå®ƒé‡‡ç”¨çš„æ˜¯B+æ ‘çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ç´¢å¼•ï¼Œé€‰æ‹©B+æ ‘çš„ä¸»è¦åŸå› æ˜¯<ol><li>é˜¶æ•°ï¼ˆæ ‘æˆï¼‰æ›´å¤šï¼Œè·¯å¾„æ›´çŸ­</li><li>ç£ç›˜è¯»å†™ä»£ä»·æ›´ä½ï¼Œé£å¶å­èŠ‚ç‚¹åªå­˜å‚¨æŒ‡é’ˆï¼Œå¶å­ç»“ç‚¹å­˜å‚¨æ•°æ®</li><li>B+æ ‘ä¾¿äºæ‰«åº“å’Œå»æ£€æŸ¥è¯¢ï¼Œå› ä¸ºå¶å­ç»“ç‚¹æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨<br><img src="https://s1.ax1x.com/2023/07/23/pCqI5qK.png" alt=""></li></ol></li><li>ä½¿ç”¨äºŒå‰æ ‘æˆ–è€…çº¢é»‘æ ‘æ•ˆç‡éƒ½ä¸é«˜ï¼ŒäºŒå‰æ ‘åœ¨ä¸å¹³è¡¡çš„æƒ…å†µä¸‹ï¼Œä¼šé€€åŒ–ä¸ºé“¾è¡¨ã€‚çº¢é»‘æ ‘è™½ç„¶èƒ½ä¿è¯å¹³è¡¡æ€§æ¥é™ä½æ ‘çš„é«˜åº¦ï¼Œä½†æ˜¯çº¢é»‘æ ‘åªæ˜¯äºŒå‰æ ‘ï¼Œé˜¶æ•°ä½ï¼Œå¦‚æœé‡åˆ°åºå¤§çš„æ•°æ®é‡ï¼ŒäºŒå‰æ ‘ä¹Ÿä¼šå¾ˆé«˜ï¼Œæ•ˆç‡ä¹Ÿæ˜¯ä¸å¦‚B+æ ‘<br><img src="https://s1.ax1x.com/2023/07/23/pCq5S6P.png" alt=""></li><li>Bæ ‘çš„éå¶å­ç»“ç‚¹å’Œå¶å­ç»“ç‚¹éƒ½ä¼šå­˜æ”¾æ•°æ®ï¼ŒèŒƒå›´æŸ¥è¯¢æ•ˆç‡ä½ï¼Œå¹¶ä¸”ä¸å¤ªç¨³å®š<br><img src="https://s1.ax1x.com/2023/07/23/pCqo9Ig.png" alt=""></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯èšç°‡ç´¢å¼•ï¼Ÿä»€ä¹ˆæ˜¯éèšç°‡ç´¢å¼•ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>èšç°‡ç´¢å¼•æœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼Œä¸»è¦æ˜¯æŒ‡æ•°æ®ä¸ç´¢å¼•æ”¾åˆ°ä¸€å—ï¼ŒB+æ ‘çš„å¶å­ç»“ç‚¹ä¿å­˜äº†æ•´è¡Œæ•°æ®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ä¸»é”®ä½œä¸ºèšç°‡ç´¢å¼•çš„</li><li>éèšç°‡ç´¢å¼•æŒ‡çš„æ˜¯æ•°æ®ä¸ç´¢å¼•åˆ†å¼€å­˜å‚¨ï¼ŒB+æ ‘çš„å¶å­ç»“ç‚¹ä¿å­˜å¯¹åº”çš„ä¸»é”®ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œä¸€èˆ¬æˆ‘ä»¬è‡ªå®šä¹‰çš„ç´¢å¼•éƒ½æ˜¯éèšç°‡ç´¢å¼•<br><img src="https://s1.ax1x.com/2023/07/23/pCqoHmV.png" alt=""></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šçŸ¥é“ä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢å—ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>è¿™ä¸ªå’Œåˆšåˆšä»‹ç»çš„èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•æœ‰å¾ˆå¤§å…³ç³»çš„ï¼Œå›è¡¨çš„æ„æ€æ˜¯ï¼Œé€šè¿‡éèšç°‡ç´¢å¼•æ‰¾åˆ°æ•°æ®å¯¹åº”çš„ä¸»é”®å€¼ï¼Œç„¶åé€šè¿‡ä¸»é”®å€¼å»èšç°‡ç´¢å¼•ä¸­æŸ¥æ‰¾å‡ºæ•´è¡Œçš„æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯å›è¡¨ã€‚<br><img src="https://s1.ax1x.com/2023/07/23/pCq76IS.png" alt=""></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šçŸ¥é“ä»€ä¹ˆå«è¦†ç›–ç´¢å¼•å—ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>è¦†ç›–ç´¢å¼•å€¼çš„æ˜¯selectæŸ¥è¯¢è¯­å¥ä½¿ç”¨äº†ç´¢å¼•ï¼Œè¿”å›çš„åˆ—å¿…é¡»èƒ½åœ¨ç´¢å¼•ä¸­å…¨éƒ¨æ‰¾åˆ°ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨idæŸ¥è¯¢ï¼Œå®ƒä¼šç›´æ¥èµ°èšé›†ç´¢å¼•æŸ¥è¯¢ï¼Œä¸€æ¬¡ç´¢å¼•æ‰«æï¼Œç›´æ¥è¿”å›æ•°æ®ï¼Œæ€§èƒ½é«˜ã€‚</li><li>å¦‚æœæŒ‰ç…§éèšé›†ç´¢å¼•æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œè¿”å›çš„åˆ—ä¸­æ²¡æœ‰åˆ›å»ºç´¢å¼•ï¼Œæœ‰å¯èƒ½ä¼šè§¦å‘å›è¡¨æŸ¥è¯¢ï¼Œæ‰€ä»¥å°½é‡é¿å…ä½¿ç”¨<code>SELECT *</code>ï¼Œå°½é‡åœ¨è¿”å›çš„åˆ—ä¸­éƒ½åŒ…å«æ·»åŠ ç´¢å¼•çš„å­—æ®µ</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šMySQLè¶…å¤§åˆ†é¡µæ€ä¹ˆå¤„ç†ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>è¶…å¤§åˆ†é¡µä¸€èˆ¬éƒ½æ˜¯åœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨limitåˆ†é¡µæŸ¥è¯¢ï¼Œå¹¶ä¸”éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œè¿™ä¸ªæ—¶å€™æ•ˆç‡å°±å¾ˆä½ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨è¦†ç›–ç´¢å¼•å’Œå­æŸ¥è¯¢æ¥è§£å†³ã€‚</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä¼šå…ˆæ’åºå‰900010æ¡æ•°æ®ï¼Œä»…è¿”å›å10æ¡è®°å½•ï¼ŒæŸ¥è¯¢çš„ä»£ä»·éå¸¸å¤§</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tb_stu limit <span class="number">9000000</span>, <span class="number">10</span>;</span><br></pre></td></tr></table></figure><ul><li>å…ˆåˆ†é¡µæŸ¥è¯¢æ•°æ®çš„idå­—æ®µï¼Œç¡®å®šäº†idä¹‹åï¼Œå†ä½¿ç”¨å­æŸ¥è¯¢æ¥è¿‡æ»¤ï¼ŒåªæŸ¥è¯¢è¿™ä¸ªidåˆ—è¡¨ä¸­çš„æ•°æ®å°±å¯ä»¥äº†ï¼Œå› ä¸ºæŸ¥è¯¢idçš„æ—¶å€™ï¼Œèµ°çš„æ˜¯è¦†ç›–ç´¢å¼•ï¼Œè¿™æ ·æ•ˆç‡å°±ä¼šæå‡å¾ˆå¤š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> tb_stu t, (<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> tb_stu <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">9000000.</span> <span class="number">10</span>) a</span><br><span class="line"><span class="keyword">WHERE</span> t.id <span class="operator">=</span> a.id</span><br></pre></td></tr></table></figure>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šç´¢å¼•åˆ›å»ºåŸåˆ™æœ‰å“ªäº›ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œè¿™ä¸ªæƒ…å†µæœ‰å¾ˆå¤šï¼Œä¸è¿‡éƒ½æœ‰ä¸€ä¸ªå¤§å‰æï¼Œé¦–å…ˆè¡¨ä¸­çš„æ•°æ®è¦è¶…è¿‡10ä¸‡æ¡ä»¥ä¸Šï¼Œæˆ‘ä»¬æ‰ä¼šå»åˆ›å»ºç´¢å¼•ï¼Œå¹¶ä¸”æ·»åŠ ç´¢å¼•çš„å­—æ®µæ˜¯æŸ¥è¯¢æ¯”è¾ƒé¢‘ç¹çš„å­—æ®µï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ã€æ’åºå­—æ®µæˆ–è€…åˆ†ç»„å­—æ®µè¿™äº›ã€‚å…¶æ¬¡å°±æ˜¯ï¼Œæˆ‘ä»¬é€šå¸¸åˆ›å»ºç´¢å¼•çš„æ—¶å€™éƒ½æ˜¯ä½¿ç”¨å¤åˆç´¢å¼•æ¥åˆ›å»ºï¼Œä¸€æ¡SQLçš„è¿”å›å€¼ï¼Œå°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ã€‚</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œè¿™ä¸ªæƒ…å†µæ¯”è¾ƒå¤š<ul><li>æ¯”å¦‚ç´¢å¼•åœ¨ä½¿ç”¨çš„æ—¶å€™æ²¡æœ‰éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œä¸¾ä¾‹è¯´æ˜ï¼šå‡è®¾æœ‰ä¸€ä¸ªå¤åˆç´¢å¼•idx_name_ageï¼ŒåŒ…å«ä¸¤åˆ—ï¼šnameå’Œageã€‚ä¸‹é¢æ˜¯ä¸€äº›æŸ¥è¯¢æ¡ä»¶å’Œå®ƒä»¬æ˜¯å¦ç¬¦åˆæœ€å·¦åŒ¹é…åŸåˆ™çš„åˆ¤æ–­ï¼š<ol><li>æŸ¥è¯¢æ¡ä»¶ï¼šWHERE name = â€˜Johnâ€™ã€‚<ul><li>ç¬¦åˆæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œå› ä¸ºä»å¤åˆç´¢å¼•çš„æœ€å·¦ä¾§åˆ—nameå¼€å§‹è¿›è¡ŒåŒ¹é…ã€‚</li></ul></li><li>æŸ¥è¯¢æ¡ä»¶ï¼šWHERE age &gt; 30ã€‚<ul><li>ä¸ç¬¦åˆæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œå› ä¸ºå¤åˆç´¢å¼•çš„ç¬¬ä¸€åˆ—æ˜¯nameï¼Œè€Œageä¸æ˜¯ä»æœ€å·¦ä¾§å¼€å§‹è¿›è¡ŒåŒ¹é…çš„ã€‚</li></ul></li><li>æŸ¥è¯¢æ¡ä»¶ï¼šWHERE name = â€˜Johnâ€™ AND age &gt; 30ã€‚<ul><li>ç¬¦åˆæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œå› ä¸ºä»å¤åˆç´¢å¼•çš„æœ€å·¦ä¾§åˆ—nameå¼€å§‹è¿›è¡ŒåŒ¹é…ï¼Œç„¶åç´§æ¥ç€åŒ¹é…ageã€‚</li></ul></li><li>æŸ¥è¯¢æ¡ä»¶ï¼šWHERE age &gt; 30 AND name = â€˜Johnâ€™ã€‚<ul><li>ä¸ç¬¦åˆæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œè™½ç„¶æ¶µç›–äº†å¤åˆç´¢å¼•çš„æ‰€æœ‰åˆ—ï¼Œä½†æ˜¯åˆ—çš„é¡ºåºå¹¶æ²¡æœ‰ä»æœ€å·¦ä¾§å¼€å§‹è¿ç»­åŒ¹é…ã€‚</li></ul></li></ol></li><li>æ¨¡ç³ŠæŸ¥è¯¢çš„æ—¶å€™ï¼Œå¦‚æœ%åœ¨å‰é¢ä¹Ÿä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚<ul><li>ä¾‹å¦‚ <code>LIKE '%John'</code> ä¼šå¤±æ•ˆï¼Œè€Œ <code>LIKE 'John%'</code>åˆ™ä¸ä¼š</li></ul></li><li>åœ¨æ·»åŠ ç´¢å¼•çš„å­—æ®µä¸Šè¿›è¡Œäº†è¿ç®—æ“ä½œæˆ–è€…ç±»å‹è½¬æ¢ä¹Ÿä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ</li></ul>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿›è¡Œäº†è¿ç®—æ“ä½œ</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_seller <span class="keyword">where</span> <span class="built_in">substring</span>(name,<span class="number">3</span>,<span class="number">2</span>) <span class="operator">=</span><span class="string">&#x27;ç§‘æŠ€&#x27;</span></span><br><span class="line"><span class="comment">-- å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ï¼Œä¹Ÿä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼Œå› ä¸ºæ­¤æ—¶è¦è¿›è¡Œç±»å‹è½¬æ¢</span></span><br></pre></td></tr></table></figure></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šæœ‰SQLçš„ä¼˜åŒ–ç»éªŒå—ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œè¿™ä¸ªè¿˜æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œå¯ä»¥ä»è¿™å‡ æ–¹é¢æ¥è€ƒè™‘<ol><li>å»ºè¡¨çš„æ—¶å€™é€‰æ‹©åˆé€‚çš„ç±»å‹</li><li>ä½¿ç”¨ç´¢å¼•</li><li>SQLè¯­å¥çš„ç¼–å†™</li><li>ä¸»ä»å¤åˆ¶</li><li>è¯»å†™åˆ†ç¦»</li></ol></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šé‚£ä½ åœ¨å»ºè¡¨çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•è¿›è¡Œä¼˜åŒ–çš„å‘¢ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>è¿™ä¸ªä¸»è¦å‚è€ƒé˜¿é‡Œå¼€å‘æ‰‹å†Œï¼Œå°±æ¯”å¦‚å†å®šä¹‰å­—æ®µçš„æ—¶å€™ï¼Œéœ€è¦ç»“åˆå­—æ®µçš„å†…å®¹æ¥é€‰æ‹©åˆé€‚çš„ç±»å‹ï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦ç»“åˆå­˜å‚¨çš„å†…å®¹æ¥é€‰æ‹©æ˜¯ä½¿ç”¨charè¿˜æ˜¯varcharæˆ–è€…textç±»å‹ã€‚ç”¨æˆ·åé‚®ç®±ä¹‹ç±»çš„ï¼Œå¯ä»¥ç”¨varcharï¼Œæ–‡ç« å†…å®¹è¿™ç§å¯ä»¥ç”¨textï¼Œé‚®ç¼–ä¹‹ç±»çš„å®šé•¿å­—ç¬¦ä¸²å¯ä»¥ç”¨char</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šé‚£ä½ åœ¨ä½¿ç”¨ç´¢å¼•çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•ä¼˜åŒ–çš„å‘¢ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>é¦–å…ˆè¡¨ä¸­çš„æ•°æ®è¦è¶…è¿‡10ä¸‡æ¡ä»¥ä¸Šï¼Œæˆ‘ä»¬æ‰ä¼šå»åˆ›å»ºç´¢å¼•ï¼Œå¹¶ä¸”æ·»åŠ ç´¢å¼•çš„å­—æ®µæ˜¯æŸ¥è¯¢æ¯”è¾ƒé¢‘ç¹çš„å­—æ®µï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ã€æ’åºå­—æ®µæˆ–è€…åˆ†ç»„å­—æ®µè¿™äº›ã€‚å…¶æ¬¡å°±æ˜¯ï¼Œæˆ‘ä»¬é€šå¸¸åˆ›å»ºç´¢å¼•çš„æ—¶å€™éƒ½æ˜¯ä½¿ç”¨å¤åˆç´¢å¼•æ¥åˆ›å»ºï¼Œä¸€æ¡SQLçš„è¿”å›å€¼ï¼Œå°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ã€‚</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šä½ å¹³æ—¶å¯¹SQLè¯­å¥åšäº†å“ªäº›ä¼˜åŒ–å‘¢ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>å—¯ï¼Œè¿™ä¸ªä¹Ÿæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚SELECTè¯­å¥åŠ¡å¿…æŒ‡æ˜å­—æ®µåç§°ï¼Œä¸è¦ç›´æ¥ä½¿ç”¨SELECT *ï¼Œè¿˜æœ‰å°±æ˜¯éœ€è¦æ³¨æ„é¿å…ç´¢å¼•å¤±æ•ˆçš„å†™æ³•ï¼Œå¦‚æœæ˜¯èšåˆæŸ¥è¯¢ï¼Œå°½é‡ä½¿ç”¨UNION ALLæ¥æ›¿ä»£UNIONï¼Œå› ä¸ºUNIONä¼šå¤šä¸€æ¬¡è¿‡æ»¤ï¼Œæ•ˆç‡ç›¸å¯¹è¾ƒä½ã€‚å¦‚æœæ˜¯è¡¨å…³è”çš„è¯ï¼Œå°½é‡ä½¿ç”¨INNER JOINï¼Œå¿…è¦æ—¶ç”¨LEFT JOINæˆ–RIGHT JOINï¼Œå¦‚æœéè¦ç”¨çš„è¯ï¼Œä¸€å®šè¦ä»¥å°è¡¨ä½œä¸ºé©±åŠ¨ã€‚</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šäº‹åŠ¡çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥è¯¦ç»†è¯´ä¸€ä¸‹å—ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>äº‹åŠ¡çš„ç‰¹æ€§æŒ‡çš„æ˜¯ACIDå±æ€§ï¼Œåˆ†åˆ«æ˜¯åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ã€‚æˆ‘ä¸¾ä¸ªä¾‹å­å§ï¼Œå°±æ¯”å¦‚è½¬è´¦è¿™ç§åœºæ™¯<ol><li>Aå‘Bè½¬è´¦500ï¼Œè½¬è´¦æˆåŠŸï¼ŒAæ‰£é™¤500å…ƒï¼ŒBå¢åŠ 500å…ƒã€‚åŸå­æ€§ä½“ç°åœ¨è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚</li><li>åœ¨è½¬è´¦è¿‡ç¨‹ä¸­ï¼ŒAæ‰£é™¤äº†500å…ƒï¼Œé‚£ä¹ˆBå¿…é¡»å¢åŠ 500å…ƒï¼Œéœ€è¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</li><li>éš”ç¦»æ€§ä½“ç°åœ¨ï¼ŒAå‘Bè½¬è´¦ï¼Œä¸èƒ½å—åˆ°å…¶ä»–äº‹åŠ¡çš„å¹²æ‰°</li><li>æŒä¹…æ€§ä½“ç°åœ¨ï¼Œè½¬è´¦æˆåŠŸåï¼Œéœ€è¦å°†æ•°æ®æŒä¹…åŒ–ã€‚</li></ol></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šå¹¶å‘äº‹åŠ¡å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>ç¬¬ä¸€æ˜¯è„è¯»ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨è®¿é—®æ•°æ®ï¼Œå¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§ä¿®æ”¹è¿˜æ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿæ¥è®¿é—®äº†è¿™ä¸ªæ•°æ®ï¼Œç”±äºè¿™ä¸ªæ•°æ®è¿˜æ²¡æœ‰æäº¤ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°çš„æ•°æ®å°±æ˜¯è„æ•°æ®ï¼Œæ ¹æ®è„æ•°æ®æ‰€åšçš„æ“ä½œå¯èƒ½æ˜¯ä¸æ­£ç¡®çš„ã€‚</li><li>ç¬¬äºŒä¸ªæ˜¯ä¸å¯é‡å¤è¯»ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»åŒä¸€æ•°æ®ï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿæ¥è®¿é—®è¯¥æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä¸¤æ¬¡è¯»å–æ•°æ®ä¹‹é—´ï¼Œç”±äºç¬¬äºŒä¸ªäº‹åŠ¡çš„ä¿®æ”¹å¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®å¯èƒ½ä¸å¤ªä¸€æ ·ï¼Œå› æ­¤ç§°ä¸ºä¸å¯é‡å¤è¯»ã€‚</li><li>ç¬¬ä¸‰ä¸ªæ˜¯å¹»è¯»ï¼šå¹»è¯»è·Ÿä¸å¯é‡å¤è¯»ç±»ä¼¼ï¼Œå®ƒæ˜¯å‘ç”Ÿåœ¨ä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å‡ è¡Œæ•°æ®ï¼Œæ¥ç€å¦ä¸€ä¸ªäº‹åŠ¡æ’å…¥äº†ä¸€äº›æ•°æ®ï¼Œåœ¨éšåçš„æŸ¥è¯¢ä¸­ï¼Œç¬¬ä¸€ä¸ªäº‹åŠ¡å°±ä¼šå‘ç°å¤šäº†ä¸€äº›åŸæœ¬ä¸å­˜åœ¨çš„è®°å½•ã€‚</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šé‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜å‘¢ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>è§£å†³æ–¹æ¡ˆæ˜¯å¯¹äº‹åŠ¡è¿›è¡Œéš”ç¦»ï¼ŒMySQLæ”¯æŒå››ç§éš”ç¦»çº§åˆ«<ol><li>è¯»æœªæäº¤ï¼šå®ƒè§£å†³ä¸äº†åˆšåˆšçš„æ‰€æœ‰é—®é¢˜ï¼Œä¸€èˆ¬é¡¹ç›®é‡Œä¹Ÿä¸ç”¨è¿™ä¸ª</li><li>è¯»å·²æäº¤ï¼šå®ƒèƒ½è§£å†³è„è¯»é—®é¢˜ï¼Œä½†æ˜¯è§£å†³ä¸äº†ä¸å¯é‡å¤è¯»å’Œå¹»è¯»</li><li>å¯é‡å¤è¯»ï¼šä»–èƒ½è§£å†³è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†æ˜¯è§£å†³ä¸äº†å¹»è¯»ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯MySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«</li><li>ä¸²è¡ŒåŒ–ï¼šå®ƒå¯ä»¥è§£å†³åˆšåˆšæå‡ºçš„æ‰€æœ‰é—®é¢˜ï¼Œä½†æ˜¯ç”±äºæ˜¯è®©äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œçš„ï¼Œæ€§èƒ½æ¯”è¾ƒä½ã€‚æ‰€ä»¥é¡¹ç›®ä¸­ä¸€èˆ¬ç”¨çš„éƒ½æ˜¯MySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼šå¯é‡å¤è¯»ã€‚</li></ol></li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šundo logå’Œredo logçš„åŒºåˆ«</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>redo logæ—¥å¿—è®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ï¼ŒæœåŠ¡å®•æœºå¯ç”¨æ¥åŒæ­¥æ•°æ®ï¼Œè€Œundo log ä¸åŒï¼Œå®ƒä¸»è¦è®°å½•çš„æ˜¯é€»è¾‘æ—¥å¿—ï¼Œå½“äº‹åŠ¡å›æ»šæ—¶ï¼Œé€šè¿‡é€†æ“ä½œæ¢å¤åŸæ¥çš„æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ é™¤ä¸€æ¡æ•°æ®çš„æ—¶å€™ï¼Œå°±ä¼šåœ¨undo logæ—¥å¿—æ–‡ä»¶ä¸­æ–°å¢ä¸€æ¡deleteè¯­å¥ï¼Œå¦‚æœå‘ç”Ÿå›æ»šå°±æ‰§è¡Œé€†æ“ä½œï¼›</li><li>redo logä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œundo logä¿è¯äº†äº‹åŠ¡çš„åŸå­æ€§å’Œä¸€è‡´æ€§</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šäº‹åŠ¡ä¸­çš„éš”ç¦»æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>éš”ç¦»æ€§æ˜¯ç”±é”å’ŒMVCCå®ç°çš„ã€‚</li><li>MVCCæ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ŒæŒ‡ç»´æŠ¤ä¸€ä¸ªæ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä½¿å¾—è¯»å†™æ“ä½œæ²¡æœ‰å†²çªï¼Œå®ƒçš„åº•å±‚å®ç°ä¸»è¦æ˜¯åˆ†ä¸ºäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€ä¸ªæ˜¯éšè—å­—æ®µï¼Œç¬¬äºŒä¸ªæ˜¯undo logæ—¥å¿—ï¼Œç¬¬ä¸‰ä¸ªæ˜¯readViewè§†å›¾</li><li>éšè—å­—æ®µæ˜¯æŒ‡åœ¨MySQLä¸­ç»™æ¯ä¸ªè¡¨éƒ½è®¾ç½®äº†éšè—å­—æ®µï¼Œæœ‰ä¸€ä¸ªæ˜¯trx_idï¼ˆäº‹åŠ¡idï¼‰ï¼Œè®°å½•æ¯ä¸€æ¬¡æ“ä½œçš„äº‹åŠ¡idï¼Œæ˜¯é€’å¢çš„ï¼Œå¦ä¸€ä¸ªæ˜¯roll_pointerï¼ˆå›æ»šæŒ‡é’ˆï¼‰ï¼ŒæŒ‡å‘ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„äº‹åŠ¡åœ°å€</li><li>undo logä¸»è¦çš„ä½œç”¨æ˜¯è®°å½•å›æ»šæ—¥å¿—ï¼Œå­˜å‚¨è€ç‰ˆæœ¬æ•°æ®ï¼Œåœ¨å†…éƒ¨ä¼šå½¢æˆä¸€ä¸ªç‰ˆæœ¬é“¾ï¼Œåœ¨å¤šä¸ªäº‹åŠ¡å¹¶è¡Œæ“ä½œæŸä¸€è¡Œè®°å½•ï¼Œè®°å½•ä¸åŒäº‹åŠ¡ä¿®æ”¹æ•°æ®çš„ç‰ˆæœ¬ï¼Œé€šè¿‡roll_pointeræŒ‡é’ˆå½¢æˆä¸€ä¸ªé“¾è¡¨</li><li>readViewè§£å†³çš„æ˜¯ä¸€ä¸ªäº‹åŠ¡æŸ¥è¯¢é€‰æ‹©ç‰ˆæœ¬çš„é—®é¢˜ï¼Œåœ¨å†…éƒ¨å®šä¹‰äº†ä¸€äº›åŒ¹é…è§„åˆ™å’Œå½“å‰çš„ä¸€äº›äº‹åŠ¡idåˆ¤æ–­è¯¥è®¿é—®å“ªä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œä¸åŒçš„éš”ç¦»çº§åˆ«å¿«ç…§è¯»æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ€ç»ˆçš„è®¿é—®ç»“æœä¹Ÿä¸ä¸€æ ·ã€‚å¦‚æœæ˜¯è¯»å·²æäº¤éš”ç¦»çº§åˆ«ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œå¦‚æœæ˜¯å¯é‡å¤åº¦éš”ç¦»çº§åˆ«ä»…åœ¨äº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œåç»­å¤ç”¨</li></ul>              </div>            </details><ul><li>é¢è¯•å®˜ï¼šMySQLä¸»ä»åŒæ­¥åŸç†çŸ¥é“å—ï¼Ÿ</li><li>å€™é€‰äººï¼š</li></ul><details class="folding-tag" cyan><summary>  </summary>              <div class='content'>              <ul><li>MySQLä¸»ä»å¤åˆ¶çš„æ ¸å¿ƒå°±æ˜¯äºŒè¿›åˆ¶æ—¥å¿—(DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰è¯­å¥å’Œ DMLï¼ˆæ•°æ®æ“çºµè¯­è¨€ï¼‰è¯­å¥)ï¼Œå®ƒçš„æ­¥éª¤æ˜¯è¿™æ ·çš„ï¼š<ol><li>ä¸»åº“åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œä¼šæŠŠæ•°æ®å˜æ›´è®°å½•åœ¨äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ Binlog ä¸­ã€‚</li><li>ä»åº“è¯»å–ä¸»åº“çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ Binlog ï¼Œå†™å…¥åˆ°ä»åº“çš„ä¸­ç»§æ—¥å¿— Relay Log ã€‚</li><li>ä»åº“é‡åšä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†æ”¹å˜åæ˜ å®ƒè‡ªå·±çš„æ•°æ®</li></ol></li></ul>              </div>            </details>]]></content>
    
    
    <summary type="html">MySQLç›¸å…³é¢è¯•é¢˜</summary>
    
    
    
    <category term="é¢è¯•é¢˜" scheme="https://cyborg2077.github.io/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
    
    <category term="MySQL" scheme="https://cyborg2077.github.io/tags/MySQL/"/>
    
  </entry>
  
</feed>
