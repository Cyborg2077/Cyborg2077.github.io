<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>学成在线--课程发布模块开发 | Kyle's Blog</title><meta name="keywords" content="ElasticSearch,SpringBoot,SpringCloud,MyBatisPlus,xxl-job"><meta name="author" content="Kyle Violet"><meta name="copyright" content="Kyle Violet"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="黑马学成在线--课程发布模块开发">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线--课程发布模块开发">
<meta property="og:url" content="https://cyborg2077.github.io/2023/02/28/XuechengOnlinePart4/index.html">
<meta property="og:site_name" content="Kyle&#39;s Blog">
<meta property="og:description" content="黑马学成在线--课程发布模块开发">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img2.baidu.com/it/u=595920241,2439700946&fm=253&fmt=auto&app=120&f=JPEG?w=1422&h=800">
<meta property="article:published_time" content="2023-02-28T09:21:48.000Z">
<meta property="article:modified_time" content="2023-03-27T02:53:47.435Z">
<meta property="article:author" content="Kyle Violet">
<meta property="article:tag" content="ElasticSearch">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="SpringCloud">
<meta property="article:tag" content="MyBatisPlus">
<meta property="article:tag" content="xxl-job">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img2.baidu.com/it/u=595920241,2439700946&fm=253&fmt=auto&app=120&f=JPEG?w=1422&h=800"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cyborg2077.github.io/2023/02/28/XuechengOnlinePart4/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f8440b73b5064587c92bcc0ec23ce01c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-RQZSMGWCQS"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-RQZSMGWCQS');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '学成在线--课程发布模块开发',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-27 10:53:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script data-pjax src="https://ali-oss.xmwpro.com/cdn/js/echarts.min.js"></script><script src="https://npm.elemecdn.com/echarts@5.3.2/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/readPercent.css"><link rel="stylesheet" href="/css/custom/twikoo_beautify.css"  media="defer" onload="this.media='all'"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3049706_6drr2nvsz9b.css"><link rel="stylesheet" href="/css/wave.css"><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><style type="text/css"> #universe {  display: block; position: fixed; margin: 0; padding: 0; border: 0; outline: 0; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; } </style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.css"><link rel="stylesheet" href="/css/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.15/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/04/18/fj4XvrdM5o62hbA.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">105</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">86</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw iconfont icon-liuyan"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gossip/"><i class="fa-fw iconfont icon-talk-new"></i><span> 闲言碎语</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw iconfont icon-bilibili"></i><span> 追番</span></a></li><li><a class="site-page child" href="/secret/"><i class="fa-fw fas fa-heart"></i><span> 记忆胶囊</span></a></li><li><a class="site-page child" href="/fitness/"><i class="fa-fw iconfont icon-jianshen-"></i><span> 健身日寄</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw iconfont icon-zhangdan"></i><span> 打赏榜单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img2.baidu.com/it/u=595920241,2439700946&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1422&amp;h=800')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Kyle's Blog</a></span><div id="he-plugin-simple"></div><div id="none_space"></div><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw iconfont icon-liuyan"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gossip/"><i class="fa-fw iconfont icon-talk-new"></i><span> 闲言碎语</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw iconfont icon-bilibili"></i><span> 追番</span></a></li><li><a class="site-page child" href="/secret/"><i class="fa-fw fas fa-heart"></i><span> 记忆胶囊</span></a></li><li><a class="site-page child" href="/fitness/"><i class="fa-fw iconfont icon-jianshen-"></i><span> 健身日寄</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw iconfont icon-zhangdan"></i><span> 打赏榜单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">学成在线--课程发布模块开发</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-28T09:21:48.000Z" title="发表于 2023-02-28 17:21:48">2023-02-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-27T02:53:47.435Z" title="更新于 2023-03-27 10:53:47">2023-03-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/">实战项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">23.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>93分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="学成在线--课程发布模块开发"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>在此特别感谢黑马程序员提供的课程</p>
</blockquote>
<div class="bvideo">
    <a href="//www.bilibili.com/video/BV1j8411N7Bm" target="_blank">
        <div class="bvideo-box">
            <div class="bvideo-cover">
                <div class="cover-default"></div>
                <div class="bvideo-cover-layer" style="background-image:url(https://images.weserv.nl/?url=http://i0.hdslb.com/bfs/archive/b15eeaafd0ed8d6defd00e81a5f4181d3aafd757.jpg)">
                    <i class="icon-video"></i>
                </div>
                <span class="duration">51:51:58</span>
            </div>
            <div class="bvideo-info">
                <p class="title">黑马程序员Java企业级实战开发《学成在线》微服务项目，基于SpringCloud、SpringCloudAlibaba技术栈开发，项目搭建到选课支付学习全通关</p>
                <p class="card-status">
                    <span class="play-num">
                        <i class="fa fa-youtube-play"></i>
                        <span>26.1万</span></span>
                    <span>
                        <i class="fa fa-list-alt"></i>
                        <span>3714</span></span></p>
                <div class="partition">
                    <label class="card-label">视频</label>
                    <label class="up-label"></label>
                    <label class="up-name">黑马程序员</label>
                </div>
                <div class="actions hide"></div>
            </div>
        </div>
    </a>
</div>
<h1 id="写在最前"><a href="#写在最前" class="headerlink" title="写在最前"></a>写在最前</h1><ul>
<li>完整项目地址：<a target="_blank" rel="noopener" href="https://github.com/Cyborg2077/xuecheng-plus/tree/master">https://github.com/Cyborg2077/xuecheng-plus/tree/master</a></li>
</ul>
<h1 id="模块需求分析"><a href="#模块需求分析" class="headerlink" title="模块需求分析"></a>模块需求分析</h1><h2 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h2><ul>
<li>课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后，学习者通过学成在线平台的网站可以搜索到课程，然后查看课程的详细信息，选课进行学习。</li>
<li>下面是课程编辑与发布的整体流程<br><img src="https://s1.ax1x.com/2023/01/29/pSa6wSf.png" alt=""></li>
<li>为了保证课程内容没有违规信息、课程内容安排合理，在课程发布之前，平台运营方会进行课程审核，审核通过后，课程方可发布</li>
<li>作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效果，若课程信息存在问题，方便查看，及时修改</li>
<li>教学机构确认课程内容无误，提交审核，平台运营人员对课程内容审核，审核通过后教学机构人员发布课程成功</li>
<li>课程发布模块共包括三块功能<ol>
<li>课程预览</li>
<li>课程审核</li>
<li>课程发布</li>
</ol>
</li>
</ul>
<h2 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h2><h3 id="课程预览"><a href="#课程预览" class="headerlink" title="课程预览"></a>课程预览</h3><ol>
<li>教学机构用户在课程管理中可对该机构所管理的课程进行检索</li>
<li>点击某课程数据后的预览链接，即可对该课程进行预览，可以看到发布后的详情页面</li>
<li>点即课程目录中的具体章节，查看视频是否正常播放</li>
</ol>
<h3 id="视频审核"><a href="#视频审核" class="headerlink" title="视频审核"></a>视频审核</h3><ul>
<li><p>教学机构提交课程审核后，平台运营人员登录运营平台查询待审核的记录<br><img src="https://s1.ax1x.com/2023/02/28/ppP8yeH.png" alt=""></p>
</li>
<li><p>具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容</p>
</li>
<li>如果存在问题，则审核不通过，并附上审核不通过的原因供教学机构人员查看</li>
<li>如果课程内容没有违规信息且课程内容全面，则审核通过</li>
<li>课程审核通过后，教学机构发布课程成功</li>
</ul>
<h3 id="课程发布"><a href="#课程发布" class="headerlink" title="课程发布"></a>课程发布</h3><ol>
<li>教学机构用户在课程管理中可对机构内课程进行检索</li>
<li>点击某课程数据后的发布连接，即可对该课程进行发布</li>
<li>课程发布后可通过课程搜索查询到的课程信息，查看课程的详细信息</li>
<li>点击课程搜索页中课程列表的某个课程，可以进入课程详情页</li>
</ol>
<h1 id="课程预览-1"><a href="#课程预览-1" class="headerlink" title="课程预览"></a>课程预览</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><ul>
<li>课程预览就是把课程的相关信息进行整合，在课程详情界面进行展示，通过课程预览页面查看信息是否存在问题</li>
<li>下图是课程预览的数据来源<br><img src="https://s1.ax1x.com/2023/02/28/ppPGguF.png" alt=""></li>
<li><p>课程预览的效果与最终课程发布后查看到的效果是一致的，所以课程预览时会通过网站门户域名地址进行预览，下图是课程预览的整个流程图<br><img src="https://s1.ax1x.com/2023/02/28/ppPGhNR.png" alt=""></p>
</li>
<li><p>说明如下：</p>
<ol>
<li>点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览</li>
<li>内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏览器</li>
<li>通过课程预览页面点击<code>马上学习</code>打开视频播放页面</li>
<li>视频播放页面通过Nginx请求后台服务网关，查询课程信息展示课程计划目录，请求媒资管理查询课程计划绑定的视频文件的地址，在浏览器播放视频</li>
</ol>
</li>
</ul>
<h2 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h2><h3 id="什么是模板引擎"><a href="#什么是模板引擎" class="headerlink" title="什么是模板引擎"></a>什么是模板引擎</h3><ul>
<li>根据前面的数据模型分析，课程预览就是把课程的相关信息进行整合，在课程预览界面进行展示，课程预览界面与课程发布的课程详情界面一致，保证了教学机构人员发布前看到的是什么样，发布后也会看到什么样</li>
<li>项目采用模板引擎技术实现课程预览界面，那么什么是模板引擎？</li>
<li>早期我们使用的JSP技术就是一种模板引擎技术<ol>
<li>浏览器请求web服务器</li>
<li>服务器渲染界面，渲染的过程就是向JSP界面（模板）内填充数据（模型）</li>
<li>服务器将渲染生成的页面返回给浏览器</li>
</ol>
</li>
<li><p>所以模板引擎就是<code>模板 + 数据 = 输出</code>。JSP页面就是模板，页面中嵌入的JSP标签就是数据，两者相结合输出HTML网页</p>
</li>
<li><p>常用的Java模板引擎还有那些？</p>
<ul>
<li>JSP</li>
<li>Freemarker</li>
<li>Thymeleaf</li>
<li>Velocity</li>
</ul>
</li>
<li>本项目采用Freemarker作为模板引擎技术</li>
<li>Freemarker官网：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/">http://freemarker.foofun.cn/</a></li>
</ul>
<h3 id="Freemarker快速入门"><a href="#Freemarker快速入门" class="headerlink" title="Freemarker快速入门"></a>Freemarker快速入门</h3><ul>
<li>下面在内容管理接口层搭建Freemarker的运行环境并测试<ol>
<li>在content-api添加Freemarker与SpringBoot的整合包<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot 对结果视图 Freemarker 集成 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>nacos中配置freemarker，新增一个freemarker-config-dev.yaml配置<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">freemarker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span>   <span class="comment">#关闭模板缓存，方便测试</span></span><br><span class="line">    <span class="attr">settings:</span></span><br><span class="line">      <span class="attr">template_update_delay:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.ftl</span>   <span class="comment">#页面模板后缀名</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">template-loader-path:</span> <span class="string">classpath:/templates/</span>   <span class="comment">#页面模板位置(默认为 classpath:/templates/)</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">add-mappings:</span> <span class="literal">false</span>   <span class="comment">#关闭项目中的静态资源映射(static、resources文件夹下的资源)</span></span><br></pre></td></tr></table></figure></li>
<li>在content-api的bootstrap.yml中添加freemarker的共享配置<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shared-configs:</span><br><span class="line">  - data-id: swagger-$&#123;spring.profiles.active&#125;.yaml</span><br><span class="line">    group: xuecheng-plus-common</span><br><span class="line">    refresh: true</span><br><span class="line">  - data-id: logging-$&#123;spring.profiles.active&#125;.yaml</span><br><span class="line">    group: xuecheng-plus-common</span><br><span class="line">    refresh: true</span><br><span class="line"><span class="addition">+ - data-id: freemarker-config-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line"><span class="addition">+   group: xuecheng-plus-common</span></span><br><span class="line"><span class="addition">+   refresh: true</span></span><br></pre></td></tr></table></figure></li>
<li>添加模板，在resource下创建templates目录（与配置文件中一致），添加test.ftl模板文件<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Hello $&#123;broski&#125;!</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>编写Controller方法，准备模型数据<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FreemarkerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testfreemaker&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;broski&quot;</span>, <span class="string">&quot;Kyle&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>启动内容管理服务，访问<a target="_blank" rel="noopener" href="http://localhost:53040/content/testfreemaker">http://localhost:53040/content/testfreemaker</a> ，屏幕输出<code>Hello Kyle!</code></li>
</ol>
</li>
</ul>
<div class="note info no-icon flat"><p>freemarker提供了很多指令用于解析各种类型的数据模型，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p>
</div>
<h2 id="测试静态页面"><a href="#测试静态页面" class="headerlink" title="测试静态页面"></a>测试静态页面</h2><h3 id="部署网站门户"><a href="#部署网站门户" class="headerlink" title="部署网站门户"></a>部署网站门户</h3><ul>
<li>在课程预览界面上要加载css、js、图片等内容，这里部署Nginx来访问这些静态资源，对于SpringBoot服务的动态资源由Nginx去代理请求<br><img src="https://s1.ax1x.com/2023/03/01/ppinYrR.png" alt=""></li>
</ul>
<ol>
<li>本机安装Nginx，直接用黑马提供的资料</li>
<li>运行nginx.exe，访问localhost，可以看到Nginx默认页面则启动成功（若失败，请检查是否存在中文目录或者端口占用情况）</li>
<li>解压黑马提供的xc-ui-pc-static-portal.zip文件，并记录解压的位置，在第5步修改Nginx配置时，需要指定其所在目录</li>
<li>在Nginx的conf/nginx.conf文件中配置如下内容<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    #rewrite ^(.*) https://$server_name$1 permanent;</span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    ssi on;</span><br><span class="line">    ssi_silent_errors on;</span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        alias   D:\BaiduNetdiskDownload/xc-ui-pc-static-portal/;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    #静态资源</span><br><span class="line">    location /static/img/ &#123;  </span><br><span class="line">            alias  D:\BaiduNetdiskDownload/xc-ui-pc-static-portal/img/;</span><br><span class="line">    &#125; </span><br><span class="line">    location /static/css/ &#123;  </span><br><span class="line">            alias   D:\BaiduNetdiskDownload/xc-ui-pc-static-portal/css/;</span><br><span class="line">    &#125; </span><br><span class="line">    location /static/js/ &#123;  </span><br><span class="line">            alias   D:\BaiduNetdiskDownload/xc-ui-pc-static-portal/js/;</span><br><span class="line">    &#125; </span><br><span class="line">    location /static/plugins/ &#123;  </span><br><span class="line">            alias   D:\BaiduNetdiskDownload/xc-ui-pc-static-portal/plugins/;</span><br><span class="line">            add_header Access-Control-Allow-Origin http://ucenter.localhost;  </span><br><span class="line">            add_header Access-Control-Allow-Credentials true;  </span><br><span class="line">            add_header Access-Control-Allow-Methods GET;</span><br><span class="line">    &#125; </span><br><span class="line">    location /plugins/ &#123;  </span><br><span class="line">            alias   D:\BaiduNetdiskDownload/xc-ui-pc-static-portal/plugins/;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    root           html;</span><br><span class="line">    #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    #    fastcgi_index  index.php;</span><br><span class="line">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">    #    include        fastcgi_params;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">    # concurs with nginx&#x27;s one</span><br><span class="line">    #</span><br><span class="line">    #location ~ /\.ht &#123;</span><br><span class="line">    #    deny  all;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>启动Nginx，访问localhost，可以看到学成在线的门户网站（我这里就没配域名了，会被定向到涩情网站）<br><img src="https://s1.ax1x.com/2023/03/01/ppiyp5V.png" alt=""></li>
</ol>
<h3 id="课程详情页面"><a href="#课程详情页面" class="headerlink" title="课程详情页面"></a>课程详情页面</h3><ul>
<li>course_template.html是一个静态html页面，里面还没有添加freemarker标签，如果要预览该页面需要借助Nginx进行预览，因为页面需要加载一些css样式表、图片等内容</li>
<li>course_template.html文件在xc-ui-pc-static-portal\course目录下</li>
<li>通过浏览器访问localhost/course/course_template.html，效果如下<br><img src="https://s1.ax1x.com/2023/03/01/ppiyFv4.png" alt=""></li>
</ul>
<h3 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a>文件服务器</h3><ul>
<li>在进行课程预览时，需要展示课程的图片，在线播放课程视频、课程图片，而这些媒资都在MinIO文件系统存储，下面统一由Nginx代理，通过文件服务域名统一访问</li>
<li>在nginx.conf中配置文件服务器的代理地址<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#文件服务</span><br><span class="line">upstream fileserver&#123;</span><br><span class="line">    server localhost:9000 weight=10;</span><br><span class="line">&#125; </span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  file.localhost;</span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    ssi on;</span><br><span class="line">    ssi_silent_errors on;</span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line">    location /video &#123;</span><br><span class="line">        proxy_pass   http://fileserver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /mediafiles &#123;</span><br><span class="line">        proxy_pass   http://fileserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>配置完毕，重新加载nginx配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.exe -s reload</span><br></pre></td></tr></table></figure></li>
<li>通过<a target="_blank" rel="noopener" href="http://file.localhost/video/视频地址">http://file.localhost/video/视频地址</a> 访问视频</li>
<li>通过<a target="_blank" rel="noopener" href="http://file.localhost/mediafiles/图片地址">http://file.localhost/mediafiles/图片地址</a> 访问图片</li>
</ul>
<h3 id="视频播放页面"><a href="#视频播放页面" class="headerlink" title="视频播放页面"></a>视频播放页面</h3><ul>
<li>进入课程详情页面，点击马上学习或课程目录下的小节名称，打开视频播放页面</li>
<li>首先在nginx.conf中配置视频播放页面的地址<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /course/preview/learning.html &#123;</span><br><span class="line">        alias D:\BaiduNetdiskDownload/xc-ui-pc-static-portal/course/learning.html;</span><br><span class="line">&#125; </span><br><span class="line">location /course/search.html &#123;  </span><br><span class="line">        root   D:\BaiduNetdiskDownload/xc-ui-pc-static-portal;</span><br><span class="line">&#125; </span><br><span class="line">location /course/learning.html &#123;  </span><br><span class="line">        root   D:\BaiduNetdiskDownload/xc-ui-pc-static-portal;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li>
<li>修改learning.html，<kbd>Ctrl</kbd> + <kbd>F</kbd>搜索<code>videoObject</code>，修改videoServer和video，同时将所有的<code>www.xuecheng-plus.com</code>替换成<code>localhost</code>，用VSCode可以快速全部替换<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">data: &#123;</span><br><span class="line">    <span class="attr">videServer</span>:<span class="string">&#x27;http://file.localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">courseId</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">teachplanId</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">teachplans</span>:[],</span><br><span class="line">    <span class="attr">videoObject</span> : &#123;</span><br><span class="line">        <span class="attr">container</span>: <span class="string">&#x27;#vdplay&#x27;</span>, <span class="comment">//容器的ID或className</span></span><br><span class="line">        <span class="attr">variable</span>: <span class="string">&#x27;player&#x27;</span>,<span class="comment">//播放函数名称</span></span><br><span class="line">        <span class="attr">poster</span>:<span class="string">&#x27;/static/img/asset-video.png&#x27;</span>,<span class="comment">//封面图片</span></span><br><span class="line">        <span class="comment">//loaded: &#x27;loadedHandler&#x27;, //当播放器加载后执行的函数</span></span><br><span class="line">        <span class="attr">video</span>:<span class="string">&#x27;http://file.localhost/video/a/9/a92da96ebcf28dfe194a1e2c393dd860/a92da96ebcf28dfe194a1e2c393dd860.mp4&#x27;</span></span><br><span class="line">        <span class="comment">// video: [//视频地址列表形式</span></span><br><span class="line">        <span class="comment">// 	[&#x27;http://file.xuecheng-plus.com/video/3/a/3a5a861d1c745d05166132c47b44f9e4/3a5a861d1c745d05166132c47b44f9e4.mp4&#x27;, &#x27;video/mp4&#x27;, &#x27;中文标清&#x27;, 0]</span></span><br><span class="line">        <span class="comment">// ]</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">player</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">preview</span>:<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>修改course_template.html，同样将所有的<code>www.xuecheng-plus.com</code>替换成<code>localhost</code></li>
<li>重启Nginx，访问<code>localhost/course/course_template.html</code> ，点击视频封面，会访问<code>localhost/course/preview/learning.html?id=82</code> ，并且可以播放视频</li>
</ul>
<h2 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h2><h3 id="定义课程预览接口"><a href="#定义课程预览接口" class="headerlink" title="定义课程预览接口"></a>定义课程预览接口</h3><ul>
<li>课程预览接口要将课程信息进行整合，在服务端渲染页面后返回浏览器</li>
<li>下面对课程预览接口进行分析<ol>
<li>请求参数：传入课程id，表示要预览哪一门课程</li>
<li>响应结果：输出课程详情页面到浏览器</li>
</ol>
</li>
<li>响应页面到浏览器使用freemarker模板引擎技术实现，首先从黑马提供的资料中获取课程预览界面<code>course_template.html</code>，拷贝至content-api打的<code>resources/template</code>目录下，复制一份并重命名为<code>course_template.ftl</code></li>
<li>下面定义接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoursePublishController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">preview</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span></span>&#123;</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;course_template&quot;</span>);</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;model&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>重启ContentApiApplication，现在当我们点击预览按钮时，会打开预览页面，但是此时页面内容没有样式，稍后我们来解决这个问题<br><img src="https://s1.ax1x.com/2023/03/02/ppF4NNQ.png" alt=""><br><img src="https://s1.ax1x.com/2023/03/02/ppF4Uhj.png" alt=""></li>
</ul>
<h3 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h3><ul>
<li>课程预览接口虽然可以正常访问，但是页面没有样式，我们需要由Nginx反向代理访问课程预览接口<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#后台网关</span><br><span class="line">upstream gatewayserver&#123;</span><br><span class="line">    server 127.0.0.1:53010 weight=10;</span><br><span class="line">&#125; </span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    ....</span><br><span class="line">    #api</span><br><span class="line">    location /api/ &#123;</span><br><span class="line">        proxy_pass http://gatewayserver/;</span><br><span class="line">    &#125; </span><br><span class="line">    ····</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>重新加载Nginx配置文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.exe -s reload</span><br></pre></td></tr></table></figure></li>
<li>访问新地址<code>localhost/api/content/coursepreview/1</code>页面样式正常，但是现在的内容是静态内容，写死的，我们需要调用Service方法获取模型数据，并进行页面渲染</li>
</ul>
<h2 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a>接口开发</h2><h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><ul>
<li>课程预览就是把课程基本信息、营销信息、课程计划、师资信息等课程的相关信息进行整合，在预览页面进行展示，如下图<br><img src="https://s1.ax1x.com/2023/03/02/ppFIokD.png" alt=""></li>
<li>在使用freemarker渲染生成视图时，需要数据模型，此数据模型包括基本信息、营销信息、课程计划、师资信息等信息，所以我们这里需要定义一个数据模型类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoursePreviewDto</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程基本计划、课程营销信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CourseBaseInfoDto courseBaseInfoDto;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程计划信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;TeachplanDto&gt; teachplans;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 师资信息暂时不加</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Service接口"><a href="#Service接口" class="headerlink" title="Service接口"></a>Service接口</h3><ul>
<li>Service负责从数据库查询基本信息、营销信息、课程计划等课程相关信息，组成CoursePreviewDto对象<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 课程预览、发布接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CoursePublishService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据课程id获取课程预览信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  package com.xuecheng.content.model.dto.CoursePreviewDto;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">CoursePreviewDto <span class="title">getCoursePreviewInfo</span><span class="params">(Long courseId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>接口实现如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoursePublishServiceImpl</span> <span class="keyword">implements</span> <span class="title">CoursePublishService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CourseBaseInfoService courseBaseInfoService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TeachplanService teachplanService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CoursePreviewDto <span class="title">getCoursePreviewInfo</span><span class="params">(Long courseId)</span> </span>&#123;</span><br><span class="line">        CoursePreviewDto coursePreviewDto = <span class="keyword">new</span> CoursePreviewDto();</span><br><span class="line">        <span class="comment">// 根据课程id查询 课程基本信息、营销信息</span></span><br><span class="line">        CourseBaseInfoDto courseBaseInfo = courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line">        <span class="comment">// 根据课程id，查询课程计划</span></span><br><span class="line">        List&lt;TeachplanDto&gt; teachplanDtos = teachplanService.findTeachplanTree(courseId);</span><br><span class="line">        <span class="comment">// 封装返回</span></span><br><span class="line">        coursePreviewDto.setCourseBaseInfoDto(courseBaseInfo);</span><br><span class="line">        coursePreviewDto.setTeachplans(teachplanDtos);</span><br><span class="line">        <span class="keyword">return</span> coursePreviewDto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="接口层完善"><a href="#接口层完善" class="headerlink" title="接口层完善"></a>接口层完善</h3><ul>
<li>接口层调用Service方法，获取模板引擎所需要的模型数据<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoursePublishController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">preview</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span></span>&#123;</span><br><span class="line">        CoursePreviewDto coursePreviewInfo = coursePublishService.getCoursePreviewInfo(courseId);</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;course_template&quot;</span>);</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;model&quot;</span>, coursePreviewInfo);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a>前后端联调</h3><ul>
<li>目前是通过Nginx访问门户，Nginx是整个项目最前方的代理服务器，如下<br><img src="https://s1.ax1x.com/2023/03/02/ppFLJHI.png" alt=""></li>
<li>原来前端直接指向后台网关地址，现在要改为Nginx的地址，修改前段<code>.env</code>文件<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">VUE_APP_SERVER_API_URL</span>=<span class="string">http://localhost/api</span></span><br></pre></td></tr></table></figure></li>
<li>重启前端工程，进入课程列表点击预览按钮，正常打开课程预览页面</li>
</ul>
<h3 id="编写模板"><a href="#编写模板" class="headerlink" title="编写模板"></a>编写模板</h3><ul>
<li>模型数据准备好后，下一步就是将模型数据填充到<code>course_template.ftl</code>上</li>
<li>填充时注意不要一次填充太多，边填边测，利于发现问题</li>
<li>freemarker提供了很多指令用于解析各种类型的数据模型，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></li>
<li>修改模板后需要编译<br><img src="https://s1.ax1x.com/2023/03/02/ppFLcEq.png" alt=""></li>
<li>那么我们现在就用freemarker提供的指令，来替换掉页面中写死的数据</li>
</ul>
<h3 id="视频播放页面接口"><a href="#视频播放页面接口" class="headerlink" title="视频播放页面接口"></a>视频播放页面接口</h3><ul>
<li>在课程详情页面，点击课程小节的超链接，会进入视频播放页面，在此页面需要从后台获取课程计划作为目录、并根据课程计划获取对应的视频地址，现在我们就来编写这两个接口    <ol>
<li>获取课程计划接口：/open/content/course/whole/{courseId}</li>
<li>根据课程计划获取视频地址接口：/open/media/preview/{mediaId}</li>
</ol>
</li>
</ul>
<ol>
<li>在nginx配置如下内容<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#openapi</span><br><span class="line">location /open/content/ &#123;</span><br><span class="line">    proxy_pass http://gatewayserver/content/open/;</span><br><span class="line">&#125; </span><br><span class="line">location /open/media/ &#123;</span><br><span class="line">    proxy_pass http://gatewayserver/media/open/;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li>
<li>在content-api模块下的定义CourseOpenController类，并定义接口：获取课程计划接口：<code>/open/content/course/whole/&#123;courseId&#125;</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/open&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseOpenController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/course/whole/&#123;courseId&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CoursePreviewDto <span class="title">getPreviewInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 获取课程预览信息</span></span><br><span class="line">        <span class="keyword">return</span> coursePublishService.getCoursePreviewInfo(courseId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
现在我们重启nginx和内容管理服务，访问视频播放页面，右侧已经可以成功显示目录了，如果没显示，访问<code>http://localhost/open/content/course/whole/160</code>查看是否能查询到数据<br><img src="https://s1.ax1x.com/2023/03/03/ppkde1J.png" alt=""></li>
<li>当我们点击右侧目录时，会自动跳转到对应的小节视频，所以我们来编写获取视频地址的接口，在media-api下定义MediaOpenController类，并定义接口<code>/open/media/preview/&#123;courseId&#125;</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/open&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaOpenController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MediaFileService mediaFileService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title">getMediaUrl</span><span class="params">(<span class="meta">@PathVariable</span> String mediaId)</span> </span>&#123;</span><br><span class="line">        MediaFiles mediaFile = mediaFileService.getFileById(mediaId);</span><br><span class="line">        <span class="keyword">if</span> (mediaFile == <span class="keyword">null</span> || StringUtils.isEmpty(mediaFile.getUrl())) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;视频还没有转码处理&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(mediaFile.getUrl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
那么到此为止，两个接口都开发完毕，我们点击右侧目录，可以正确的播放视频</li>
</ol>
<h2 id="面试"><a href="#面试" class="headerlink" title="面试"></a>面试</h2><div class="note info no-icon flat"><ul>
<li>为什么要用Freemarker静态化？如何做的？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>页面静态化是指使用模板引擎技术将一个动态网页生成html静态页面，满足以下条件可以考虑使用静态化<ol>
<li>该页面被访问频率高，例如：商品信息展示、讲师介绍页面</li>
<li>页面上数据变化频率低，例如：商品发布后对商品信息的修改频率低、讲师介绍信息修改频率低</li>
</ol>
</li>
<li>静态化的技术很多，Freemarker是一个成熟的开源的模板引擎工具，简单易用，功能强大，本项目使用Freemarker将课程信息静态化<ol>
<li>使用Freemarker的标签编写课程信息的模板</li>
<li>调用接口获取木板上需要的模型数据</li>
<li>调用Freemarker的API生成静态页面</li>
<li>生成的静态页面最终会上传到文件系统方便访问</li>
</ol>
</li>
</ul>
</div>
<h1 id="课程审核"><a href="#课程审核" class="headerlink" title="课程审核"></a>课程审核</h1><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h2><h3 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a>业务流程</h3><ul>
<li><p>根据模块需求分析，课程发布前先要审核，审核通过方可发布。下图是课程审核及发布的流程图<br><img src="https://s1.ax1x.com/2023/03/03/ppksNjg.png" alt=""></p>
</li>
<li><p>为什么课程要审核通过才可以发布呢？</p>
<ul>
<li>这样做为了防止课程信息有违规情况，课程信息不完善对网站用户体验也不好，课程审核不仅起到监督作用，也是帮助教学机构规范使用平台的手段。</li>
</ul>
</li>
<li>如何控制课程审核通过才可以发布呢？<ul>
<li>在课程基本表course_base中，设置课程审核状态字段，包括：未提交、已提交（未审核）、审核通过、审核不通过</li>
</ul>
</li>
<li><p>下面是课程状态的转换关系<br><img src="https://s1.ax1x.com/2023/03/03/ppksyCV.png" alt=""></p>
</li>
<li><p>说明如下</p>
<ol>
<li>一门课程新增后，它的审核状态为<code>未提交</code>，发布状态为<code>未发布</code></li>
<li>课程信息编辑完成，教学机构人员进行<code>提交审核</code>操作，此时课程的审核状态为<code>已提交</code></li>
<li>当课程状态为<code>已提交</code>时，运营平台人员对课程进行审核</li>
<li>运营平台人员审核课程，结果有两个：审核通过、审核不通过</li>
<li>课程审核后不管状态是否通过，教学机构都可以再次修改课程并提交审核，此时课程状态为<code>已提交</code>，运营平台人员再次审核课程</li>
<li>课程审核通过，教学机构人员可以发布课程，发布成功后，课程的发布状态为<code>已发布</code></li>
<li>课程发布后，通过<code>下架</code>操作可以更改课程发布状态为<code>下架</code></li>
<li>课程下架后，通过<code>上架</code>操作可以再次发布课程，上架后课程发布状态为<code>发布</code></li>
</ol>
</li>
</ul>
<h3 id="数据模型-1"><a href="#数据模型-1" class="headerlink" title="数据模型"></a>数据模型</h3><ul>
<li>通过业务流程分析，现在我们思考：课程提交审核后，还允许修改课程吗？<ul>
<li>如果不允许修改是不合理的，因为提交很合后可以继续做下一个阶段的课程内容，比如添加课程计划、上传额外章节的课程视频等</li>
<li>如果允许修改，那么课程审核时看到的课程内容从哪儿来呢？如果也从课程基本信息表、课程营销信息表、课程计划信息表中查询会出现什么问题呢？如下图<br><img src="https://s1.ax1x.com/2023/03/03/ppApXLT.png" alt=""></li>
</ul>
</li>
<li>运营人员审核课程和教学机构编辑课程操作的数据是同一份，此时就可能产生冲突，例如：运营人员正在审核时，教学机构把数据修改了</li>
<li>为了解决这个问题，我们专门设计了一张课程与发布表<ul>
<li>提交课程审核，将课程基本信息、营销信息、课程计划汇总后，写入该表中。</li>
<li>课程审核人员从预发布表查询信息</li>
<li>课程审核通过执行课程发布，将课程预发布的信息写入课程发布表</li>
</ul>
</li>
<li>提交审核课程后，也修改了课程信息，可以再次提交审核吗？<ul>
<li>这个问题在上面分析的课程审核状态时已经有了答案，如图<br><img src="https://s1.ax1x.com/2023/03/03/ppksyCV.png" alt=""></li>
<li>提交审核课程后，必须等待课程审核完毕后，才可以再次提交课程（无论审核通过/不通过）</li>
</ul>
</li>
<li>提交审核，将课程信息、课程计划信息等汇总，写入课程预发布表，表结构如下<br><img src="https://s1.ax1x.com/2023/03/03/ppACzG9.png" alt=""></li>
<li>提交审核的沟通过是，也需要将课程基本信息表的审核状态修改为：已经提交</li>
<li>课程审核后，更新课程基本信息比嗷的审核状态、课程预发布表的审核状态，并将审核结果写入课程审核记录，其表结构如下<br><img src="https://s1.ax1x.com/2023/03/03/ppAPeGd.png" alt=""></li>
</ul>
<h2 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h2><ul>
<li>当我们在课程管理页面点击<code>提交审核</code>时，查看浏览器发出的请求<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">请求网址: http:<span class="comment">//localhost:8601/api/content/courseaudit/commit/1</span></span><br><span class="line">请求方法: POST</span><br></pre></td></tr></table></figure></li>
<li>请求路径：/content/courseaudit/commit/{courseId}</li>
<li>请求方式：POST</li>
<li>从请求路径可以看出，该接口需要定义在content-api下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/courseaudit/commit/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commitAudit</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a>接口开发</h2><h3 id="DAO开发"><a href="#DAO开发" class="headerlink" title="DAO开发"></a>DAO开发</h3><ul>
<li>使用自动生成的Mapper即可</li>
<li>通过上面的分析，我们要查询的内容如下<ol>
<li>根据传入的courseId，查询课程基本信息、课程营销信息、课程计划信息，并汇总成课程预发布信息</li>
<li>向课程预发布表中插入我们汇总好的信息，如果已经存在，则更新，并状态为<code>已提交</code></li>
<li>更新课程基本信息表的审核状态为<code>已提交</code></li>
</ol>
</li>
<li>约束<ol>
<li>未提交或审核完后，方可提交审核</li>
<li>本机构只允许提交本机构的课程</li>
<li>没有上传图片，不允许提交审核</li>
<li>没有添加课程计划，不允许提交审核</li>
</ol>
</li>
</ul>
<h3 id="Service开发"><a href="#Service开发" class="headerlink" title="Service开发"></a>Service开发</h3><ul>
<li>在课程发布Service类中定义接口如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提交审核</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">commitAudit</span><span class="params">(Long courseId)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li>接口实现如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commitAudit</span><span class="params">(Long companyId, Long courseId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 查询课程基本信息</span></span><br><span class="line">    CourseBase courseBase = courseBaseMapper.selectById(courseId);</span><br><span class="line">    <span class="comment">// 查询课程营销信息</span></span><br><span class="line">    CourseMarket courseMarket = courseMarketMapper.selectById(courseId);</span><br><span class="line">    <span class="comment">// 查询课程基本信息、课程营销信息</span></span><br><span class="line">    CourseBaseInfoDto courseBaseInfo = courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line">    <span class="comment">// 查询课程计划</span></span><br><span class="line">    List&lt;TeachplanDto&gt; teachplanTree = teachplanService.findTeachplanTree(courseId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 约束</span></span><br><span class="line">    String auditStatus = courseBaseInfo.getAuditStatus();</span><br><span class="line">    <span class="comment">// 1.1 审核完后，方可提交审核</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;202003&quot;</span>.equals(auditStatus)) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;该课程现在属于待审核状态，审核完成后可再次提交&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.2 本机构只允许提交本机构的课程</span></span><br><span class="line">    <span class="keyword">if</span> (!companyId.equals(courseBaseInfo.getCompanyId())) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;本机构只允许提交本机构的课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.3 没有上传图片，不允许提交</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(courseBaseInfo.getPic())) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;没有上传课程封面，不允许提交审核&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.4 没有添加课程计划，不允许提交审核</span></span><br><span class="line">    <span class="keyword">if</span> (teachplanTree.isEmpty()) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;没有添加课程计划，不允许提交审核&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. 准备封装返回对象</span></span><br><span class="line">    CoursePublishPre coursePublishPre = <span class="keyword">new</span> CoursePublishPre();</span><br><span class="line">    BeanUtils.copyProperties(courseBaseInfo, coursePublishPre);</span><br><span class="line">    coursePublishPre.setMarket(JSON.toJSONString(courseMarket));</span><br><span class="line">    coursePublishPre.setTeachplan(JSON.toJSONString(teachplanTree));</span><br><span class="line">    coursePublishPre.setCompanyId(companyId);</span><br><span class="line">    coursePublishPre.setCreateDate(LocalDateTime.now());</span><br><span class="line">    <span class="comment">// 3. 设置预发布记录状态为已提交</span></span><br><span class="line">    coursePublishPre.setStatus(<span class="string">&quot;202003&quot;</span>);</span><br><span class="line">    <span class="comment">// 判断是否已经存在预发布记录，若存在，则更新</span></span><br><span class="line">    CoursePublishPre coursePublishPreUpdate = coursePublishPreMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span> (coursePublishPreUpdate == <span class="keyword">null</span>) &#123;</span><br><span class="line">        coursePublishPreMapper.insert(coursePublishPre);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        coursePublishPreMapper.updateById(coursePublishPre);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4. 设置课程基本信息审核状态为已提交</span></span><br><span class="line">    courseBase.setAuditStatus(<span class="string">&quot;202003&quot;</span>);</span><br><span class="line">    courseBaseMapper.updateById(courseBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="接口完善"><a href="#接口完善" class="headerlink" title="接口完善"></a>接口完善</h2><ul>
<li>完善接口层代码，调用Service方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/courseaudit/commit/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commitAudit</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span> </span>&#123;</span><br><span class="line">    Long companyId = <span class="number">1232141425L</span>;</span><br><span class="line">    coursePublishService.commitAudit(companyId, courseId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h2><ol>
<li>找一门信息补全的课程，测试4种约束条件</li>
<li>正常提交后，观察数据库中课程预发布表中的内容是否完整，不完整就打个断点调试一下，看看哪个数据少了</li>
<li>测试审核过后再次提交，提交后观察数据库中课程预发布表记录的内容是否正确</li>
</ol>
<h1 id="课程发布-1"><a href="#课程发布-1" class="headerlink" title="课程发布"></a>课程发布</h1><h2 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h2><h3 id="数据模型-2"><a href="#数据模型-2" class="headerlink" title="数据模型"></a>数据模型</h3><ul>
<li>教学机构人员在课程审核通过后，即可发布课程，课程发布后会公开展示在网站上供学生查看、选课、学习</li>
<li>在网喊上展示课程信息需要解决课程信息显示的性能问题，如果速度慢（排除网速原因）会影响用户的体验性</li>
<li>如何去快速搜索课程？打开课程详情页面仍然去查询数据库可行吗？<ul>
<li>为了提高网站的速度需要将课程信息进行缓存，并且要将课程信息加入索引库方便搜索，下图显示了课程发布后课程信息的流转情况<br><img src="https://s1.ax1x.com/2023/03/03/ppAGNEF.png" alt=""></li>
</ul>
<ol>
<li>向内容管理数据库的课程发布比嗷存储课程发布信息</li>
<li>向Redis存储课程缓存信息</li>
<li>向Elasticsearch存储课程索引信息</li>
<li>请求分布式文件系统存储存储课程静态化页面（即htm页面），实现快速浏览课程详情页面</li>
</ol>
</li>
<li>课程发布比嗷的数据来源于课程预发布表，它们的结构基本一样<br><img src="https://s1.ax1x.com/2023/03/03/ppAJoW9.png" alt=""></li>
<li>Redis中的课程缓存信息是将课程发布表中的数据转为json进行存储</li>
<li>ElasticSearch中的课程索引信息是根据搜索需要，将课程名称、课程介绍等字段创建倒排索引</li>
<li>MinIO中存储了课程的静态化页面文件（html网页），查看课程详情是通过文件系统去浏览课程详情页面</li>
</ul>
<h2 id="分布式事务问题"><a href="#分布式事务问题" class="headerlink" title="分布式事务问题"></a>分布式事务问题</h2><h3 id="什么是分布式事务"><a href="#什么是分布式事务" class="headerlink" title="什么是分布式事务"></a>什么是分布式事务</h3><ul>
<li>一次课程发布操作需要向数据库、Redis、Elasticsearch、MinIO写四份数据，这里存在分布式事务问题<div class="note blue no-icon flat"><ul>
<li>什么是分布式事务？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>首先理解什么是本地事务</li>
<li>平时我们在程序中通过Spring去控制事务是利用数据库本身的事务特性来实现的，因此叫<code>数据库事务</code>，由于应用主要靠关系数据库来控制事务，而数据库通常和应用在同一个服务器，所以基于关系型数据库的事务又被称为本地事务</li>
<li>本地事务具有ACID四大特性<ul>
<li>原子性（Atomicity）：事务是一个不可分割的工作单位，事务中的操作要么全部成功，要么全部失败。</li>
<li>一致性（Consistency）：事务在执行前后必须保持数据的一致性，即满足业务逻辑和约束条件。</li>
<li>隔离性（Isolation）：事务之间不应相互干扰，每个事务都应该在独立的环境中执行，不受其他事务的影响。</li>
<li>持久性（Durability）：事务一旦提交，其对数据的修改就应该永久保存在数据库中，即使发生系统故障或崩溃也不会丢失。</li>
</ul>
</li>
<li>数据库事务在实现时会将一次事务涉及到的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚</li>
</ul>
</div>
<div class="note blue no-icon flat"><ul>
<li>理解了本地事务，那么什么是分布式事务？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>现在的需求是：课程发布操作后，将数据写入数据库、Redis、ElasticSearch、MinIO四个地方，这四个地方已经不限制在一个数据库内，而是由四个分散的服务去提供，与这四个服务去通信需要网络通信，而网络存在不可到达性（例如突然断网），在这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务，称之为<code>分布式事务</code></li>
<li>在分布式系统中分布式事务的场景有很多，例如用户注册送积分、银行转账、创建订单减库存，这些都是分布式事务</li>
<li>拿转账举例，我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin transaction;</span><br><span class="line"><span class="comment">// 1. 本地数据库操作：张三减少金额</span></span><br><span class="line"><span class="comment">// 2. 本第数据库操作：李四增加金额</span></span><br><span class="line">end transaction;</span><br></pre></td></tr></table></figure></li>
<li>但是在分布式环境下，会变成这样<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin transaction;</span><br><span class="line"><span class="comment">// 1. 本地数据库操作：张三减少金额</span></span><br><span class="line"><span class="comment">// 2. 远程调用：李四增加金额</span></span><br><span class="line">end transaction;</span><br></pre></td></tr></table></figure></li>
<li>可以设想，当远程调用让李四增加金额成功了，由于网络原因导致远程调用的结果没有返回，此时本地事务提交失败就回滚了张三减少金额的操作，此时张三和李四的数据就不一致了</li>
<li>因此在分布式框架的基础上，传统数据库事务就无法使用了，张三和李四的账户不在同一个数据库甚至不在同一个应用系统里，实现转账事务需要远程调用，由于网络问题就会导致分布式事务问题</li>
</ul>
</div>
</li>
</ul>
<h3 id="什么是CAP理论"><a href="#什么是CAP理论" class="headerlink" title="什么是CAP理论"></a>什么是CAP理论</h3><ul>
<li>控制分布式事务首先需要理解CAP理论，什么是CAP理论？</li>
<li>CAP理论是一个分布式系统设计的重要理论，它指出一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition tolerance）这三项中的两项。<ul>
<li>一致性是指所有节点访问同一份最新的数据副本</li>
<li>可用性是指每个请求都能得到响应</li>
<li>分区容忍性是指系统能够在网络分区的情况下继续运行。</li>
</ul>
</li>
<li>下面使用分布式系统结构进行说明<br><img src="https://s1.ax1x.com/2023/03/04/ppAR7pn.png" alt=""></li>
<li>客户端经过网关访问用户服务的两个节点<ul>
<li>一致性是指用户不管访问哪一个节点，拿到的数据都是最新的相同的，例如查询小明的信息，不能出现在数据没有改变的情况下，两次查询结果不一样</li>
<li>可用性是指任何时候查询用户信息都可以查询到结果，但是不保证查询到的是最新的数据</li>
<li>分区容忍性也叫分区容错性，由于网络通信异常，导致请求终端、消息丢失，单服务依然对外提供服务</li>
</ul>
</li>
<li>CAP理论要强调的是在分布式系统中，这三点不可能全部满足，因为只要是分布式系统就要满足分区容忍性，因为服务间难免会出现网络异常，不能因为局部网络异常就导致整个系统不可用</li>
<li>满足分区容忍性的条件下，一致性和可用性不能同时满足</li>
<li>例如我们添加一个用户小明的信息，该信息先添加到结点1中，再同步到结点2中<br><img src="https://s1.ax1x.com/2023/03/04/ppAWthj.png" alt=""></li>
<li>如果满足C一致性，必须等待小明的信息同步完成后，系统才可用（否则当你查询结点2的时候，会查不到数据，违背了一致性）</li>
<li>如果满足A可用性，要时刻保证系统可用，就不用等待信息同步完成，此时系统的一致性就无法满足</li>
<li>所以C和A不能同时满足，在分布式系统中进行分布式事务控制，要么保证CP、要么保证AP</li>
</ul>
<h3 id="分布式事务控制方案"><a href="#分布式事务控制方案" class="headerlink" title="分布式事务控制方案"></a>分布式事务控制方案</h3><ul>
<li>学习CAP理论，我们知道进行分布式事务控制要在C一致性和A可用性中做出取舍，保证一致性就不要保证可用性，保证可用性就不要宝恒一致性。</li>
<li>首先要确认我们的需求是要CP还是AP，具体要根据应用场景进行判断</li>
<li>CP的场景：满足C舍弃A，强调一致性<ul>
<li>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败，另一方执行回滚操作</li>
<li>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败，该用户都不可使用新开账户，要满足一致性</li>
</ul>
</li>
<li>AP的场景：满足A舍弃C，强调可用性<ul>
<li>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可</li>
<li>注册送积分，注册成功，积分在24小时内到账</li>
<li>支付短信通信，支付成功发短信，短信发送可以有延迟</li>
</ul>
</li>
<li>在实际应用中符合AP的场景比较多，虽然AP舍弃C的一致性，但实际最终数据还是保持了一致，所以业界定义了BASE理论</li>
<li>BASE是Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。<ul>
<li>基本可用：当系统无法满足全部可用时，保证核心业务可用即可，比如一个外卖系统，到了饭点的时候系统并发量很高，此时要保证下单流程涉及的服务可用，其他服务暂不可用</li>
<li>软状态：可以存在中间状态，例如：微博的评论功能。当用户发表一条评论时，这条评论并不会立即同步到所有关注者的页面上，而是会先存储在缓存中，并逐渐传播到其他节点。这样就存在了一个中间状态，即某些用户可以看到这条评论，而某些用户还不能看到。</li>
<li>最终一致性：前面的软状态并不影响微博的整体可用性，用户仍然可以正常浏览和发表微博。最终，在一定时间内，所有关注者都能看到这条评论，达到了最终一致性。</li>
</ul>
</li>
</ul>
<h3 id="课程发布分布式事务控制"><a href="#课程发布分布式事务控制" class="headerlink" title="课程发布分布式事务控制"></a>课程发布分布式事务控制</h3><ul>
<li>前面的理论部分我们看完了，现在回到课程发布，执行课程发布操作后，需要向数据库、Redis、ElasticSearch、MinIO写四份数据，这个场景用哪种方案？</li>
<li>显然是AP，课程发布操作后，先更新数据库中的课程发布状态，更新后向Redis、ElasticSearch、MinIO写课程信息，只要在一定时间内最终成功写入数据即可</li>
<li>下图是具体的技术方案<br><img src="https://s1.ax1x.com/2023/03/04/ppAhqXt.png" alt=""></li>
</ul>
<ol>
<li>在内容管理服务的数据库添加一个消息表（mq_message），消息表和课程发布表在同一个数据库</li>
<li>点击课程发布，通过本地事务向课程发布表写入课程发布信息，同时向消息表写入课程发布的信息，这两条记录需保证同时存在或者同时不存在</li>
<li>启动任务调度系统的定时调度内容管理服务去定时扫描消息表的记录</li>
<li>当扫描到课程发布的消息时，即开始向Redis、ElasticSearch、MinIO完成同步数据的操作</li>
<li>同步数据的任务完成后删除消息表记录，并插入历史消息表</li>
</ol>
<ul>
<li>课程发布操作的时序图如下<br><img src="https://s1.ax1x.com/2023/03/04/ppA4u9J.png" alt=""></li>
</ul>
<ol>
<li>执行发布操作，内容管理服务存储课程发布表的同时，向消息表插入一条<code>课程发布任务</code>，这里使用本地事务保证课程发布信息保存成功，同时消息表也保存成功</li>
<li>任务调度服务定时调度内容管理服务扫描消息表，由于课程发布操作后向消息表插入了一条课程发布任务，所以此时会扫描到一条任务</li>
<li>拿到任务开始执行任务，分别向Redis、ElasticSearch、MinIO文件系统存储数据</li>
<li>任务完成后删除消息表记录</li>
</ol>
<h2 id="课程发布接口"><a href="#课程发布接口" class="headerlink" title="课程发布接口"></a>课程发布接口</h2><h3 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h3><ul>
<li>根据课程发布的分布式事务控制方案，课程发布操作首先通过本地事务向课程发布表写入课程发布信息，并向消息表插入一条记录，这里定义的课程发布接口要实现该功能</li>
<li>在课程管理界面点击随便找一门课程，点击<code>发布</code>，查看浏览器发送的请求<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">请求网址: http:<span class="comment">//localhost:8601/api/content/coursepublish/1</span></span><br><span class="line">请求方法: POST</span><br></pre></td></tr></table></figure></li>
<li>请求路径：/content/coursepublish/{courseId}</li>
<li>请求方式：POST</li>
<li>在content-api中定义接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/coursepublish/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">coursePublish</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="接口开发-2"><a href="#接口开发-2" class="headerlink" title="接口开发"></a>接口开发</h3><h4 id="DAO开发-1"><a href="#DAO开发-1" class="headerlink" title="DAO开发"></a>DAO开发</h4><ul>
<li>课程发布操作对数据库操作如下<ol>
<li>向course_publish表中插入一条记录，如果存在则更新，发布状态为<code>已发布</code></li>
<li>更新course_base表的课程发布状态为<code>已发布</code></li>
<li>向mq_message表插入一条消息，消息类型为course_publish</li>
<li>删除课程预发布表的对应记录</li>
</ol>
</li>
<li>约束<ol>
<li>课程审核后通过，方可发布</li>
<li>本机构只允许发布本机构的课程</li>
</ol>
</li>
<li>以上功能使用自动生成的Mapper接口即可完成</li>
<li>mq_message表结构如下<br><img src="https://s1.ax1x.com/2023/03/04/ppA5ua8.png" alt=""></li>
</ul>
<h4 id="Service开发-1"><a href="#Service开发-1" class="headerlink" title="Service开发"></a>Service开发</h4><ul>
<li>定义Service接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发布课程</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">publishCourse</span><span class="params">(Long companyId, Long courseId)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li>对应的接口实现<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishCourse</span><span class="params">(Long companyId, Long courseId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 约束校验</span></span><br><span class="line">    <span class="comment">// 1.1 获取课程预发布表数据</span></span><br><span class="line">    CoursePublishPre coursePublishPre = coursePublishPreMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span> (coursePublishPre == <span class="keyword">null</span>) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请先提交课程审核，审核通过后方可发布&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.2 课程审核通过后，方可发布</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;202004&quot;</span>.equals(coursePublishPre.getStatus())) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;操作失败，课程审核通过后方可发布&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.3 本机构只允许发布本机构的课程</span></span><br><span class="line">    <span class="keyword">if</span> (!coursePublishPre.getCompanyId().equals(companyId)) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;操作失败，本机构只允许发布本机构的课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. 向课程发布表插入数据</span></span><br><span class="line">    saveCoursePublish(courseId);</span><br><span class="line">    <span class="comment">// 3. 向消息表插入数据</span></span><br><span class="line">    saveCoursePublishMessage(courseId);</span><br><span class="line">    <span class="comment">// 4. 删除课程预发布表对应记录</span></span><br><span class="line">    coursePublishPreMapper.deleteById(courseId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存课程发布信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveCoursePublish</span><span class="params">(Long courseId)</span> </span>&#123;</span><br><span class="line">    CoursePublishPre coursePublishPre = coursePublishPreMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span> (coursePublishPre == <span class="keyword">null</span>) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;课程预发布数据为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    CoursePublish coursePublish = <span class="keyword">new</span> CoursePublish();</span><br><span class="line">    BeanUtils.copyProperties(coursePublishPre, coursePublish);</span><br><span class="line">    <span class="comment">// 设置发布状态为已发布</span></span><br><span class="line">    coursePublish.setStatus(<span class="string">&quot;203002&quot;</span>);</span><br><span class="line">    CoursePublish coursePublishUpdate = coursePublishMapper.selectById(courseId);</span><br><span class="line">    <span class="comment">// 有则更新，无则新增</span></span><br><span class="line">    <span class="keyword">if</span> (coursePublishUpdate == <span class="keyword">null</span>) &#123;</span><br><span class="line">        coursePublishMapper.insert(coursePublish);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        coursePublishMapper.updateById(coursePublish);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新课程基本信息表的发布状态为已发布</span></span><br><span class="line">    CourseBase courseBase = courseBaseMapper.selectById(courseId);</span><br><span class="line">    courseBase.setAuditStatus(<span class="string">&quot;203002&quot;</span>);</span><br><span class="line">    courseBaseMapper.updateById(courseBase);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 待会儿我们再来实现</span></span><br><span class="line"><span class="comment"> * 保存消息表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveCoursePublishMessage</span><span class="params">(Long courseId)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="接口完善-1"><a href="#接口完善-1" class="headerlink" title="接口完善"></a>接口完善</h4><ul>
<li>接口层调用Service方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 课程发布接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/coursepublish/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">coursePublish</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span> </span>&#123;</span><br><span class="line">    Long companyId = <span class="number">1232141425L</span>;</span><br><span class="line">    coursePublishService.publishCourse(companyId, courseId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a>接口测试</h3><ul>
<li>正常流程测试<ol>
<li>提交审核课程</li>
<li>在数据库中手动修改课程的基本信息表和预发布信息表的审核状态为<code>审核通过</code></li>
<li>执行课程发布</li>
<li>观察课程发布表是否有数据，同时课程预发布表记录已经删除，课程基本信息表与课程发布表的发布状态为<code>发布</code></li>
</ol>
</li>
</ul>
<h2 id="消息处理SDK"><a href="#消息处理SDK" class="headerlink" title="消息处理SDK"></a>消息处理SDK</h2><h3 id="消息模块技术方案"><a href="#消息模块技术方案" class="headerlink" title="消息模块技术方案"></a>消息模块技术方案</h3><ul>
<li>课程发布操作执行后需要扫描消息表的记录，有关消息表处理的有哪些？<br>  <img src="https://s1.ax1x.com/2023/03/04/ppAjK8P.png" alt=""><ol>
<li>新增消息表</li>
<li>扫描消息表</li>
<li>更新消息表</li>
<li>删除消息表</li>
</ol>
</li>
<li>使用消息表这种方式实现最终事务一致性的地方除了课程发布，还有其他业务场景<br><img src="https://s1.ax1x.com/2023/03/04/ppAjQv8.png" alt=""></li>
<li>如果在每个地方都实现一套针对消息定时扫描、处理的逻辑，基本上都是重复的，软件的复用性太低、成本太高</li>
<li>如何解决这个问题？<ul>
<li>我们可以将消息处理相关的逻辑做成一个通用的东西</li>
</ul>
</li>
<li>那么是做成通用的服务还是做成通用的代码组件呢？<ul>
<li>通用的服务是完成一个通用的独立功能，并提供独立的网络接口，比如：项目中的文件系统服务，提供文件的分布式存储服务</li>
<li>代码组件也是完成一个通用的独立功能，通常会提供API的方式供外部系统使用，例如：Fastjson、Apache commons工具包等</li>
</ul>
</li>
<li>如果将消息处理做成一个通用的服务，该服务需要连接多个数据库，因为它要扫描微服务数据库下的消息表，并且还要提供微服务通信的网络接口，但就针对当前需求而言，开发成本有点高</li>
<li>如果将消息处理做成一个SDK工具包，相比较通用服务，不仅可以解决将消息处理通用化的需求，还可以降低成本</li>
<li>所以本项目确定将对消息表相关的处理做成一个SDK组件，供各微服务使用，如下图<br><img src="https://s1.ax1x.com/2023/03/04/ppAjUCq.png" alt=""></li>
<li>下面对消息SDK的设计内容进行说明：<div class="note blue no-icon flat"><ul>
<li>执行任务应该是SDK包含的功能吗？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>拿课程发布任务举例，执行课程发布任务是要向Redis、索引库等同步数据，其他任务的执行逻辑是不同的，所以执行任务在SDK中不用实现，只需要提供一个抽象方法由具体的执行任务方去实现</li>
</ul>
</div>
<div class="note blue no-icon flat"><p>如何保证任务的幂等性？</p>
</div>
<div class="note pink no-icon flat"><ul>
<li>在视频处理章节介绍的视频处理的幂等性方案，这里可以采用类似方案<ul>
<li>任务执行完成后，从消息表删除</li>
<li>如果消息表的状态是完成或不存在，则无需执行</li>
</ul>
</li>
</ul>
</div>
<div class="note info no-icon flat"><ul>
<li>如何保证任务不重复执行？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>任务调度采用分片广播，根据分片参数去获取处理任务，配置调度过期策略为<code>忽略</code>，配置任务阻塞处理策略为<code>丢弃后续调度</code></li>
</ul>
</div>
<div class="note info no-icon flat"><ul>
<li>根据消息表记录是否存在或消息表中的任务状态去保证任务的幂等性，但是如果一个任务旗下又分为好几个小任务，例如课程发布任务需要执行3个同步操作：存储课程到Redis、存储课程到索引库、存储课程页面到MinIO。如果其中一个小任务已经完成，也不应该去重复执行这个小任务，那么该如何设计呢？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>将小任务作为任务的不同阶段，在消息表中设立阶段状态<br><img src="https://s1.ax1x.com/2023/03/04/ppAxDAJ.png" alt=""></li>
<li>每完成一个阶段，就在对应的阶段状态字段打上标记，即使大任务还没有完成，重新执行大任务时，也会跳过执行完毕了的小任务</li>
<li>这里设立更多个小任务阶段状态字段为冗余字段，以备不时之需（万一你一个大任务下有10个小任务呢）</li>
<li>不过这里4个小任务状态字段就够了</li>
</ul>
</div></li>
<li>综上所述，粗了消息表的增删改查接口外，消息SDK还具有如下接口功能<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MqMessageService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">MqMessage</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扫描消息表记录，采用与扫描视频处理表相同的思路</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count      扫描记录数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List 消息记录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;MqMessage&gt; <span class="title">getMessageList</span><span class="params">(<span class="keyword">int</span> shardIndex, <span class="keyword">int</span> shardTotal, String messageType, <span class="keyword">int</span> count)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> businessKey1 业务id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> businessKey2 业务id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> businessKey3 业务id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.messagesdk.model.po.MqMessage 消息内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">MqMessage <span class="title">addMessage</span><span class="params">(String messageType, String businessKey1, String businessKey2, String businessKey3)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 完成任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 消息id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 更新成功：1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">completed</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 完成阶段任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 消息id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 更新成功：1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">completedStageOne</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">completedStageTwo</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">completedStageThree</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">completedStageFour</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询阶段状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getStageOne</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getStageTwo</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getStageThree</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getStageFour</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>消息SDK提供消息处理抽象类，此抽象类需由使用方去继承，如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息处理抽象类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProcessAbstract</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MqMessageService mqMessageService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mqMessage 执行任务内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean true:处理成功，false处理失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(MqMessage mqMessage)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扫描消息表多线程执行任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex  分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal  分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageType 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count       一次取出任务总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout     预估任务执行时间,到此时间如果任务还没有结束则强制结束 单位秒</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">int</span> shardIndex, <span class="keyword">int</span> shardTotal, String messageType, <span class="keyword">int</span> count, <span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//扫描消息表获取任务清单</span></span><br><span class="line">            List&lt;MqMessage&gt; messageList = mqMessageService.getMessageList(shardIndex, shardTotal, messageType, count);</span><br><span class="line">            <span class="comment">//任务个数</span></span><br><span class="line">            <span class="keyword">int</span> size = messageList.size();</span><br><span class="line">            log.debug(<span class="string">&quot;取出待处理消息&quot;</span> + size + <span class="string">&quot;条&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建线程池</span></span><br><span class="line">            ExecutorService threadPool = Executors.newFixedThreadPool(size);</span><br><span class="line">            <span class="comment">//计数器</span></span><br><span class="line">            CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(size);</span><br><span class="line">            messageList.forEach(message -&gt; &#123;</span><br><span class="line">                threadPool.execute(() -&gt; &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始任务:&#123;&#125;&quot;</span>, message);</span><br><span class="line">                    <span class="comment">//处理任务</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> result = execute(message);</span><br><span class="line">                        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;任务执行成功:&#123;&#125;)&quot;</span>, message);</span><br><span class="line">                            <span class="comment">//更新任务状态,删除消息表记录,添加到历史表</span></span><br><span class="line">                            <span class="keyword">int</span> completed = mqMessageService.completed(message.getId());</span><br><span class="line">                            <span class="keyword">if</span> (completed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                log.debug(<span class="string">&quot;任务执行成功:&#123;&#125;&quot;</span>, message);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                log.debug(<span class="string">&quot;任务执行失败:&#123;&#125;&quot;</span>, message);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        log.debug(<span class="string">&quot;任务出现异常:&#123;&#125;,任务:&#123;&#125;&quot;</span>, e.getMessage(), message);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//计数</span></span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                    log.debug(<span class="string">&quot;结束任务:&#123;&#125;&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span></span><br><span class="line">            countDownLatch.await(timeout, TimeUnit.SECONDS);</span><br><span class="line">            System.out.println(<span class="string">&quot;结束....&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="消息模块SDK测试"><a href="#消息模块SDK测试" class="headerlink" title="消息模块SDK测试"></a>消息模块SDK测试</h3><ol>
<li>在内容管理数据库创建消息表和消息历史表，</li>
<li>拷贝黑马提供的消息处理SDK到项目根目录</li>
</ol>
<ul>
<li>下面测试消息SDK接口<ol>
<li>继承消息处理抽象类<code>MessageProcessAbstract</code>，编写任务执行方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProcessClass</span> <span class="keyword">extends</span> <span class="title">MessageProcessAbstract</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(MqMessage mqMessage)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 从获取任务id</span></span><br><span class="line">        Long id = mqMessage.getId();</span><br><span class="line">        log.debug(<span class="string">&quot;开始执行任务：&#123;&#125;&quot;</span>, id);</span><br><span class="line">        <span class="comment">// 2. 获取1阶段状态</span></span><br><span class="line">        MqMessageService mqMessageService = <span class="keyword">this</span>.getMqMessageService();</span><br><span class="line">        <span class="keyword">int</span> stageOne = mqMessageService.getStageOne(id);</span><br><span class="line">        <span class="keyword">if</span> (stageOne == <span class="number">0</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始执行第一阶段的任务&quot;</span>);</span><br><span class="line">            <span class="comment">// TODO 第一阶段任务逻辑</span></span><br><span class="line">            <span class="comment">// 一阶段任务完成，此方法的逻辑是将stageOne设置为1</span></span><br><span class="line">            <span class="keyword">int</span> i = mqMessageService.completedStageOne(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;完成一阶段任务&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;一阶段任务已经完成，无需再次执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>编写测试类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProcessClassTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageProcessClass messageProcessClass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;开始执行-----》&quot;</span> + LocalDateTime.now());</span><br><span class="line">        messageProcessClass.process(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;test&quot;</span>, <span class="number">2</span>, <span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;结束执行-----》&quot;</span> + LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>准备测试数据<ul>
<li>在消息表中插入一条消息类型为<code>test</code>的信息，并执行测试方法，观察控制台输出</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="集成消息SDK"><a href="#集成消息SDK" class="headerlink" title="集成消息SDK"></a>集成消息SDK</h3><h4 id="课程发布任务处理"><a href="#课程发布任务处理" class="headerlink" title="课程发布任务处理"></a>课程发布任务处理</h4><ul>
<li>下一步在课程发布模块去继承SDK完成课程发布任务处理，首先继承SDK并测试通过，然后再添加各任务的执行逻辑</li>
<li>在内容管理服务添加消息处理SDK的依赖，即可使用它，继承MessageProcessAbstract类，重写execute方法<ol>
<li>在content-service工程中添加SDK依赖，同时也加上xxl-job的依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-message-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>新建一个com.xuecheng.content.service.jobhandler包，编写CoursePublishTask类，使其继承MessageProcessAbstract类，重写其中的execute方法，这里先举一个简单的例子<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoursePublishTask</span> <span class="keyword">extends</span> <span class="title">MessageProcessAbstract</span> </span>&#123;</span><br><span class="line">    <span class="meta">@XxlJob(&quot;CoursePublishJobHandler&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">coursePublishJobHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> shardIndex = XxlJobHelper.getShardIndex();</span><br><span class="line">        <span class="keyword">int</span> shardTotal = XxlJobHelper.getShardTotal();</span><br><span class="line">        process(shardIndex, shardTotal, <span class="string">&quot;course_publish&quot;</span>, <span class="number">5</span>, <span class="number">60</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;测试任务执行中...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(MqMessage mqMessage)</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;开始执行课程发布任务，课程id：&#123;&#125;&quot;</span>, mqMessage.getBusinessKey1());</span><br><span class="line">        <span class="comment">// TODO 将课程信息静态页面上传至MinIO</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 存储到Redis</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 存储到ElasticSearch</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在nacos中为<code>content-service-dev.yaml</code>配置xxl-job的连接信息<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.101.128:18088/xxl-job-admin/</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">course-publish-job</span></span><br><span class="line">      <span class="attr">address:</span></span><br><span class="line">      <span class="attr">ip:</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job-jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure></li>
<li>在content-service中添加XxlJobConfig类，从media-service下复制即可 </li>
<li>在xxl-job-admin控制台添加执行器<ul>
<li>AppName填写我们yml配置中的appname</li>
<li>重启服务，可以在xxl-job控制台看到我们注册的执行器</li>
</ul>
</li>
<li>在xxl-job添加任务<ul>
<li>JobHandler中填写@XxlJob注解中的内容</li>
</ul>
</li>
<li>启动任务测试，控制台可以看到<code>发布任务执行中...</code>字样</li>
</ol>
</li>
</ul>
<h2 id="页面静态化"><a href="#页面静态化" class="headerlink" title="页面静态化"></a>页面静态化</h2><h3 id="什么是页面静态化"><a href="#什么是页面静态化" class="headerlink" title="什么是页面静态化"></a>什么是页面静态化</h3><ul>
<li>根据课程发布的操作流程，执行课程发布后要将课程详情信息页面静态化，生成html页面上传至文件系统<div class="note info no-icon flat"><ul>
<li>什么是页面静态化？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面。这个过程是当客户端请求服务器时，服务器才开始渲染生成html页面，最终响应给浏览器，这个过程支持并发是有限的</li>
<li>页面静态化则强调将生成的html页面的过程提前，提前使用模板引擎技术生成html页面，当客户端请求时，直接请求html页面，由于是静态页面，可以使用nginx、apache等高性能web服务器，并发性能高</li>
</ul>
</div>
<div class="note info no-icon flat"><ul>
<li>什么时候能用页面静态化技术？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>当数据变化不频繁，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化。</li>
<li>因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大</li>
<li>根据课程发布的也无需求，虽然课程发布后仍可以修改课程信息，但是需要经过课程审核，且修改频率不高，所以适合使用页面静态化</li>
</ul>
</div>
</li>
</ul>
<h3 id="静态化测试"><a href="#静态化测试" class="headerlink" title="静态化测试"></a>静态化测试</h3><ul>
<li>下面使用Freemarker技术对页面静态化生成html页面</li>
<li>在content-service工程中添加Freemarker依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>编写测试方法，其实我也不会，但我会问chatGPT<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FreemarkerTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGenerateHtmlByTemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TemplateException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 创建一个FreeMarker配置：</span></span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration(Configuration.getVersion());</span><br><span class="line">        <span class="comment">// 2. 告诉FreeMarker在哪里可以找到模板文件。</span></span><br><span class="line">        String classpath = <span class="keyword">this</span>.getClass().getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(<span class="keyword">new</span> File(classpath + <span class="string">&quot;/templates/&quot;</span>));</span><br><span class="line">        <span class="comment">// 2.1 指定字符编码</span></span><br><span class="line">        configuration.setDefaultEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. 创建一个数据模型，与模板文件中的数据模型类型保持一致，这里是CoursePreviewDto类型</span></span><br><span class="line">        CoursePreviewDto coursePreviewDto = coursePublishService.getCoursePreviewInfo(<span class="number">2L</span>);</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;model&quot;</span>, coursePreviewDto);</span><br><span class="line">        <span class="comment">// 4. 加载模板文件</span></span><br><span class="line">        Template template = configuration.getTemplate(<span class="string">&quot;course_template.ftl&quot;</span>);</span><br><span class="line">        <span class="comment">// 5. 将数据模型应用于模板</span></span><br><span class="line">        String content = FreeMarkerTemplateUtils.processTemplateIntoString(template, map);</span><br><span class="line">        InputStream inputStream = IOUtils.toInputStream(content);</span><br><span class="line">        FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;D:\\test.html&quot;</span>);</span><br><span class="line">        IOUtils.copy(inputStream,fileOutputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>执行测试方法，在D盘根目录可以看到生成的html页面，只不过现在没有css样式</li>
</ul>
<h3 id="上传文件测试"><a href="#上传文件测试" class="headerlink" title="上传文件测试"></a>上传文件测试</h3><ul>
<li><p>静态化生成文件后，需要上传至分布式文件系统，根据微服务的职责划分，媒资管理服务负责维护系统中的文件，所以内容管理服务对页面静态化生成的html文件需要调用媒资管理服务的上传文件接口</p>
</li>
<li><p>微服务之间存在远程调用，在SpringCloud中可以使用Feign进行远程调用</p>
<div class="note info no-icon flat"><ul>
<li>Feign是什么？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>Feign是一个声明式的http客户端，官方地址：<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></li>
<li>其作用就是帮助我们优雅的实现http请求发送，解决上面提到的远程调用问题</li>
</ul>
</div></li>
<li>下面先准备Feign的开发环境，在content-service中添加依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Spring Cloud 微服务远程调用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--feign支持Multipart格式传参--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>在nacos配置feign-dev.yaml公用配置文件，group设置为xuecheng-plus-common<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span> <span class="comment"># default全局的配置</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">BASIC</span> <span class="comment"># 日志级别，BASIC就是基本的请求和响应信息</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启feign对HttpClient的支持</span></span><br><span class="line">    <span class="attr">max-connections:</span> <span class="number">200</span> <span class="comment"># 最大的连接数</span></span><br><span class="line">    <span class="attr">max-connections-per-route:</span> <span class="number">50</span> <span class="comment"># 每个路径的最大连接数</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>在content-service和content-api的bootstrap中引入此配置文件<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">feign-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">  <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li>在content-service中配置feign支持Mulipart，编写MultipartSupportConfig类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.codec.Encoder;</span><br><span class="line"><span class="keyword">import</span> feign.form.spring.SpringFormEncoder;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.http.HttpMessageConverters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.SpringEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Scope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.commons.CommonsMultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultipartSupportConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectFactory&lt;HttpMessageConverters&gt; messageConverters;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span><span class="comment">//注入相同类型的bean时优先使用</span></span><br><span class="line">    <span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Encoder <span class="title">feignEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringFormEncoder(<span class="keyword">new</span> SpringEncoder(messageConverters));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将file转为Multipart</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MultipartFile <span class="title">getMultipartFile</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">        FileItem item = <span class="keyword">new</span> DiskFileItemFactory().createItem(<span class="string">&quot;file&quot;</span>, MediaType.MULTIPART_FORM_DATA_VALUE, <span class="keyword">true</span>, file.getName());</span><br><span class="line">        <span class="keyword">try</span> (FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">             OutputStream outputStream = item.getOutputStream();) &#123;</span><br><span class="line">            IOUtils.copy(inputStream, outputStream);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonsMultipartFile(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>新建com.xuecheng.content.feignclient包，编写feign接口，其接口声明与<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 媒资管理服务远程调用接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;, configuration = MultipartSupportConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MediaServiceClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/media/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    <span class="function">String <span class="title">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="meta">@RequestParam(value = &quot;folder&quot;, required = false)</span> String folder,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="meta">@RequestParam(value = &quot;objectName&quot;, required = false)</span> String objectName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在启动类添加@EnableFeignClients注解<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages=&#123;&quot;com.xuecheng.content.feignclient&quot;&#125;)</span></span><br></pre></td></tr></table></figure></li>
<li>编写测试方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试使用feign远程上传文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignUploadTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaServiceClient mediaServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远程调用，上传文件</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MultipartFile multipartFile = MultipartSupportConfig.getMultipartFile(<span class="keyword">new</span> File(<span class="string">&quot;D:\\test.html&quot;</span>));</span><br><span class="line">        String result = mediaServiceClient.upload(multipartFile, <span class="string">&quot;course&quot;</span>, <span class="string">&quot;test.html&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>执行测试方法，上传文件成功，MinIO中也可以看到对应的文件，访问<a target="_blank" rel="noopener" href="http://localhost:9000/mediafiles/course/test.html">http://localhost:9000/mediafiles/course/test.html</a> 也可以看到html页面</li>
</ul>
<h3 id="熔断降级处理"><a href="#熔断降级处理" class="headerlink" title="熔断降级处理"></a>熔断降级处理</h3><h4 id="什么是熔断降级"><a href="#什么是熔断降级" class="headerlink" title="什么是熔断降级"></a>什么是熔断降级</h4><ul>
<li>当微服务运行不正常，会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理，可能会导致雪崩效应</li>
<li><p>微服务的雪崩效应表现在服务与服务之间调用，当其中一个服务无法提供服务时，可能导致其他服务也挂掉。</p>
<ul>
<li>例如服务C调用服务B，服务B调用服务A，由于服务A异常导致服务B响应缓慢，最终导致服务A和服务B都不可用，而服务B不可用又导致服务C也不可用。</li>
<li>像这样由一个服务所引起的一连串的服务都无法提供服务，就是微服务的雪崩效应<br><img src="https://s1.ax1x.com/2023/03/05/ppE5klj.png" alt=""></li>
</ul>
</li>
<li><p>如何解决由于微服务异常所引起的雪崩效应呢？</p>
<ul>
<li>可以采用熔断、降级的方法去解决</li>
</ul>
</li>
<li>熔断降级的相同点都是为了解决微服务系统崩溃的问题，但它们是两个不同的技术手段，两者又存在联系<ul>
<li>熔断：当下游服务异常时，断开与上游服务的交互。它就相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不受影响</li>
<li>降级：当下游服务异常触发熔断后，上游服务就不再去调用异常的服务，而是执行降级处理逻辑，这个降级处理逻辑可以是本地的一个单独的方法<br><img src="https://s1.ax1x.com/2023/03/05/ppE5KtU.png" alt=""></li>
</ul>
</li>
<li>而这都是为了保护系统，熔断是当下服务异常时一种保护系统的手段，降级是熔断后上游服务处理熔断的方法</li>
</ul>
<h4 id="熔断降级处理-1"><a href="#熔断降级处理-1" class="headerlink" title="熔断降级处理"></a>熔断降级处理</h4><ul>
<li>项目使用Hystrix框架实现熔断、降级处理<ol>
<li>开启feign熔断保护<ul>
<li>在feign-dev.yaml中配置<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>定义降级逻辑<ul>
<li>方式一：fallback。定义一个fallback类MediaServiceClientFallback，此类实现了MediaServiceClient接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 媒资管理服务远程调用接口</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;, configuration = MultipartSupportConfig.class, fallback = MediaServiceClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MediaServiceClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/media/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    <span class="function">String <span class="title">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="meta">@RequestParam(value = &quot;folder&quot;, required = false)</span> String folder,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="meta">@RequestParam(value = &quot;objectName&quot;, required = false)</span> String objectName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>定义的MediaServiceClientFallback类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaServiceClientFallback</span> <span class="keyword">implements</span> <span class="title">MediaServiceClient</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile upload, String folder, String objectName)</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;方式一：熔断处理，无法获取异常&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>方式二：fallbackFactory。由于方式一无法取出熔断所抛出的异常，而方式二定义MediaServiceClientFallbackFactory可以解决这个问题<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 媒资管理服务远程调用接口</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;, configuration = MultipartSupportConfig.class, fallbackFactory = MediaServiceClientFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MediaServiceClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/media/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    <span class="function">String <span class="title">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="meta">@RequestParam(value = &quot;folder&quot;, required = false)</span> String folder,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="meta">@RequestParam(value = &quot;objectName&quot;, required = false)</span> String objectName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>定义的MediaServiceClientFallbackFactory类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaServiceClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title">FallbackFactory</span>&lt;<span class="title">MediaServiceClient</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MediaServiceClient <span class="title">create</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MediaServiceClient() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile upload, String folder, String objectName)</span> </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;方式二：熔断处理，熔断异常：&#123;&#125;&quot;</span>, throwable.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>降级处理逻辑<ul>
<li>返回一个null对象，上游服务请求接口得到一个null，说明执行了降级处理</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="课程静态化开发"><a href="#课程静态化开发" class="headerlink" title="课程静态化开发"></a>课程静态化开发</h3><ul>
<li>课程页面静态化和静态页面远程上传测试通过，下一步开发课程静态化功能，最终是用消息SDK去调度执行</li>
</ul>
<h4 id="添加消息"><a href="#添加消息" class="headerlink" title="添加消息"></a>添加消息</h4><ul>
<li>课程发布操作使用本地事务保存课程发布消息、添加消息表，其中保存课程发布信息的方法我们前面已经写完了，现在来编写添加消息表<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入消息SDK</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MqMessageService mqMessageService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存消息表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveCoursePublishMessage</span><span class="params">(Long courseId)</span> </span>&#123;</span><br><span class="line">    MqMessage mqMessage = mqMessageService.addMessage(<span class="string">&quot;course_publish&quot;</span>, String.valueOf(courseId), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span>(mqMessage == <span class="keyword">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;添加消息记录失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="课程静态化实现"><a href="#课程静态化实现" class="headerlink" title="课程静态化实现"></a>课程静态化实现</h4><ul>
<li>课程静态化包括两部分操作：生成课程静态化页面，上传静态化页面到MinIO文件系统</li>
<li>在课程发布的service编写这两部分内容，然后通过消息去调度执行<ol>
<li>定义课程静态化接口和上传静态化页面接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 课程静态化</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  静态化文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">File <span class="title">generateCourseHtml</span><span class="params">(Long courseId)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传课程静态化页面</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file  静态化文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uploadCourseHtml</span><span class="params">(Long courseId, File file)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li>接口实现<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> File <span class="title">generateCourseHtml</span><span class="params">(Long courseId)</span> </span>&#123;</span><br><span class="line">    File htmlFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建一个Freemarker配置</span></span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration(Configuration.getVersion());</span><br><span class="line">        <span class="comment">// 2. 告诉Freemarker在哪里可以找到模板文件</span></span><br><span class="line">        String classPath = <span class="keyword">this</span>.getClass().getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(<span class="keyword">new</span> File(classPath + <span class="string">&quot;/templates/&quot;</span>));</span><br><span class="line">        configuration.setDefaultEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. 创建一个模型数据，与模板文件中的数据模型保持一致，这里是CoursePreviewDto类型</span></span><br><span class="line">        CoursePreviewDto coursePreviewDto = <span class="keyword">this</span>.getCoursePreviewInfo(courseId);</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;model&quot;</span>, coursePreviewDto);</span><br><span class="line">        <span class="comment">// 4. 加载模板文件</span></span><br><span class="line">        Template template = configuration.getTemplate(<span class="string">&quot;course_template.ftl&quot;</span>);</span><br><span class="line">        <span class="comment">// 5. 将数据模型应用于模板</span></span><br><span class="line">        String content = FreeMarkerTemplateUtils.processTemplateIntoString(template, map);</span><br><span class="line">        <span class="comment">// 5.1 将静态文件内容输出到文件中</span></span><br><span class="line">        InputStream inputStream = IOUtils.toInputStream(content);</span><br><span class="line">        htmlFile = File.createTempFile(<span class="string">&quot;course&quot;</span>, <span class="string">&quot;.html&quot;</span>);</span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(htmlFile);</span><br><span class="line">        IOUtils.copy(inputStream, fos);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;课程静态化失败：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> htmlFile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uploadCourseHtml</span><span class="params">(Long courseId, File file)</span> </span>&#123;</span><br><span class="line">    MultipartFile multipartFile = MultipartSupportConfig.getMultipartFile(file);</span><br><span class="line">    String course = mediaServiceClient.upload(multipartFile, <span class="string">&quot;course&quot;</span>, courseId + <span class="string">&quot;.html&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(course == <span class="keyword">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;远程调用媒资服务上传文件失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>完善课程发布任务CoursePublishTask类的代码<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoursePublishTask</span> <span class="keyword">extends</span> <span class="title">MessageProcessAbstract</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;CoursePublishJobHandler&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">coursePublishJobHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> shardIndex = XxlJobHelper.getShardIndex();</span><br><span class="line">        <span class="keyword">int</span> shardTotal = XxlJobHelper.getShardTotal();</span><br><span class="line">        process(shardIndex, shardTotal, <span class="string">&quot;course_publish&quot;</span>, <span class="number">5</span>, <span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(MqMessage mqMessage)</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;开始执行课程发布任务，课程id：&#123;&#125;&quot;</span>, mqMessage.getBusinessKey1());</span><br><span class="line">        <span class="comment">// TODO 一阶段：将课程信息静态页面上传至MinIO</span></span><br><span class="line">        String courseId = mqMessage.getBusinessKey1();</span><br><span class="line">        generateCourseHtml(mqMessage, Long.valueOf(courseId));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 二阶段：存储到Redis</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 三阶段：存储到ElasticSearch</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 三阶段都成功，返回true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateCourseHtml</span><span class="params">(MqMessage mqMessage, Long courseId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 幂等性判断</span></span><br><span class="line">        <span class="comment">// 1.1 获取消息id</span></span><br><span class="line">        Long id = mqMessage.getId();</span><br><span class="line">        <span class="comment">// 1.2 获取小任务阶段状态</span></span><br><span class="line">        MqMessageService mqMessageService = <span class="keyword">this</span>.getMqMessageService();</span><br><span class="line">        <span class="keyword">int</span> stageOne = mqMessageService.getStageOne(id);</span><br><span class="line">        <span class="comment">// 1.3 判断小任务阶段是否完成</span></span><br><span class="line">        <span class="keyword">if</span> (stageOne == <span class="number">1</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;当前阶段为静态化课程信息任务，已完成，无需再次处理，任务信息：&#123;&#125;&quot;</span>, mqMessage);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. 生成静态页面</span></span><br><span class="line">        File file = coursePublishService.generateCourseHtml(Long.valueOf(courseId));</span><br><span class="line">        <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;课程静态化异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. 将静态页面上传至MinIO</span></span><br><span class="line">        coursePublishService.uploadCourseHtml(Long.valueOf(courseId), file);</span><br><span class="line">        <span class="comment">// 4. 保存第一阶段状态</span></span><br><span class="line">        mqMessageService.completedStageOne(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><ul>
<li>发布一门课程，启动xxl-job调度中心、启动课程发布任务，等待定时调度</li>
<li>观察控制台日志，观察任务是否可以正常处理</li>
<li>处理完进入文件系统，查看mediafiles桶内是否存在以课程id明明的html文件，并在浏览器打开访问</li>
<li>但是现在看不到样式，我们需要配置nginx<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /course/ &#123;  </span><br><span class="line">    proxy_pass http://fileserver/mediafiles/course/;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li>
<li>查看数据库中的mq_message_history表，是否有对应的课程id的数据，且一阶段的stage为1</li>
</ul>
<h2 id="面试-1"><a href="#面试-1" class="headerlink" title="面试"></a>面试</h2><div class="note info no-icon flat"><ul>
<li>什么是分布式事务？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>由多个服务通过网络完成一个事务叫分布式事务</li>
<li>例如：课程发布操作不仅要在本地数据库插入课程信息，还要请求索引服务将课程信息添加到索引库，而且还要请求MinIO将课程静态化并上传静态页面，这里就存在分布式事务</li>
</ul>
</div>
<div class="note info no-icon flat"><ul>
<li>分布式事务控制的方案有哪些？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>首先根据CAP原理决定我们的需求，是要实现CP还是AP</li>
<li>实现CP就是要实现强一致性，可以使用Seata框架基于AT、TCC模式去实现</li>
<li>我们项目中大部分实现的是AP，使用本地消息表加任务调度，保证分布式事务最终数据一致性</li>
</ul>
</div>
<div class="note info no-icon flat"><ul>
<li>如何使用本地消息表加任务调度完成分布式事务控制？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>以发布课程为例进行说明，发布课程需要在内容管理数据库中写课程发布表记录，同时将课程信息同步到Redis、ElasticSearch、MinIO，这里存在分布式事务<ol>
<li>点击发布课程，使用本地事务向发布表写一个课程信息，同时向消息表写一个消息记录（标记发布的是哪门课程）</li>
<li>xxl-job的调度中心使用分片广播模式向执行器下发任务，开始扫描消息表，查询到了待处理消息</li>
<li>根据消息的内容将课程信息同步到Redis、ElasticSearch、MinIO</li>
<li>任务完成，删除消息表记录。整个分布式事务完成，最终保证了一致性</li>
</ol>
</li>
</ul>
</div>
<h1 id="课程搜索"><a href="#课程搜索" class="headerlink" title="课程搜索"></a>课程搜索</h1><ul>
<li>有关ElasticSearch的相关学习资料也在本站内有记录<div class="tag link"><a class="link-card" title="ElasticSearch--分布式搜索引擎" href="https://cyborg2077.github.io/2022/12/24/ElasticSearch/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">ElasticSearch--分布式搜索引擎</p><p class="url">https://cyborg2077.github.io/2022/12/24/ElasticSearch/</p></div></a></div>
</li>
</ul>
<h2 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a>需求分析</h2><h3 id="模块介绍-1"><a href="#模块介绍-1" class="headerlink" title="模块介绍"></a>模块介绍</h3><ul>
<li>搜索功能是一个系统的重要功能，是消息查询的方式。课程搜索是课程展示的渠道</li>
<li>用户通过课程搜索找到课程信息，进一步去查看课程的详细信息，进行选课、支付、学习</li>
<li>本项目的课程搜索支持全文检索技术<div class="note info no-icon flat"><ul>
<li>什么是全文检索?</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>全文检索是指计算机索引程序通过扫描文章中的每一个词，对每一个词简历一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据实现建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程</li>
</ul>
</div></li>
<li>全文检索可以简单理解为通过索引搜索文章</li>
<li>全文检索的速度非常快，早起应用在搜索引擎技术中，例如：百度、谷歌等。现在通常一些大型网站的搜索功能都是采用全文检索技术</li>
<li>课程搜索也要将课程信息建立索引，在课程发布时建立课程索引，索引建立好，用户可通过搜索网页去查询课程信息<br><img src="https://s1.ax1x.com/2023/03/05/ppVErxe.png" alt=""></li>
<li>所以，课程搜索模块包括两部分<ol>
<li>课程索引：将课程信息建立索引</li>
<li>课程搜索：通过前端网页，根据关键字等条件搜索课程</li>
</ol>
</li>
</ul>
<h3 id="业务流程-2"><a href="#业务流程-2" class="headerlink" title="业务流程"></a>业务流程</h3><ul>
<li>根据模块介绍的内容，课程搜索模块包括课程索引、课程搜索两部分<ol>
<li>课程索引：在课程发布操作执行后，通过消息处理方式创建课程索引，本项目使用ElasticSearch作为索引及搜索服务</li>
<li>课程搜索：课程索引创建完成，用户才可以通过前端搜索课程信息，课程搜索可以从首页进入搜索页面，并且可以通过课程分类、课程难度等级等条件进行搜索</li>
</ol>
</li>
</ul>
<h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><h3 id="搭建ElasticSearch"><a href="#搭建ElasticSearch" class="headerlink" title="搭建ElasticSearch"></a>搭建ElasticSearch</h3><ul>
<li><p>详细的部署过程在文章中的1.4小节有详细叙述</p>
<div class="tag link"><a class="link-card" title="ElasticSearch--分布式搜索引擎" href="https://cyborg2077.github.io/2022/12/24/ElasticSearch/"><div class="left"><img src="https://s1.ax1x.com/2023/03/06/ppZ9JIS.png"/></div><div class="right"><p class="text">ElasticSearch--分布式搜索引擎</p><p class="url">https://cyborg2077.github.io/2022/12/24/ElasticSearch/</p></div></a></div>
</li>
<li><p>拉取daocker镜像，这里采用的是ElasticSearch的7.12.1版本镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull elasticsearch:7.12.1</span><br></pre></td></tr></table></figure></li>
<li>运行docker命令，部署单点ES<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --name es \</span><br><span class="line">    -e <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span> \</span><br><span class="line">    -e <span class="string">&quot;discovery.type=single-node&quot;</span> \</span><br><span class="line">    -v es-data:/usr/share/elasticsearch/data \</span><br><span class="line">    -v es-plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">    --privileged \</span><br><span class="line">    --network es-net \</span><br><span class="line">    -p 9200:9200 \</span><br><span class="line">    elasticsearch:7.12.1</span><br></pre></td></tr></table></figure></li>
<li>成功启动后，访问<a target="_blank" rel="noopener" href="http://192.168.101.128:9200/">http://192.168.101.128:9200/</a> 可以看到ElasticSearch的响应结果<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;64d819e15a86&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;cluster_name&quot;</span> : <span class="string">&quot;docker-cluster&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;S2S8sXLZTVSDjN25Qcq7KA&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;number&quot;</span> : <span class="string">&quot;7.12.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build_flavor&quot;</span> : <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build_type&quot;</span> : <span class="string">&quot;docker&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build_hash&quot;</span> : <span class="string">&quot;3186837139b9c6b6d23c3200870651f10d3343b7&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build_date&quot;</span> : <span class="string">&quot;2021-04-20T20:56:39.040728659Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;lucene_version&quot;</span> : <span class="string">&quot;8.8.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;minimum_wire_compatibility_version&quot;</span> : <span class="string">&quot;6.8.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;minimum_index_compatibility_version&quot;</span> : <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>拉取kibana的docker镜像，注意版本需与ElasticSearch的版本一致<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull kibana:7.12.1</span><br></pre></td></tr></table></figure></li>
<li>运行docker命令，部署kibana<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --name kibana \</span><br><span class="line">    -e ELASTICSEARCH_HOSTS=http://es:9200 \</span><br><span class="line">    --network=es-net \</span><br><span class="line">    -p 5601:5601 \</span><br><span class="line">    kibana:7.12.1</span><br></pre></td></tr></table></figure></li>
<li>成功启动后，访问<a target="_blank" rel="noopener" href="http://192.168.101.128:5601/">http://192.168.101.128:5601/</a> 可以看到kibana的初始页面</li>
<li>由于ElasticSearch的默认分词对中文的支持不太好，所以这里我们需要安装IK分词器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器内部</span></span><br><span class="line">docker <span class="built_in">exec</span> -it elasticsearch /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在线下载并安装</span></span><br><span class="line">./bin/elasticsearch-plugin  install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip</span><br><span class="line"></span><br><span class="line"><span class="comment">#退出</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="comment">#重启容器</span></span><br><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><ul>
<li>我们这里要创建course_publish，即课程发布表的索引，表结构如下<br><img src="https://s1.ax1x.com/2023/03/03/ppAJoW9.png" alt=""></li>
<li>根据表中的字段创建索引，其中market、teachplan、teachers、onlineDate、offlineDate没有创建<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">PUT /course-publish</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;companyId&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;companyName&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;users&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;mt&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;mtName&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;st&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;stName&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;grade&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;teachmode&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;pic&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;description&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;createDate&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>, </span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;status&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;remark&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;charge&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;scaled_float&quot;</span>,</span><br><span class="line">        <span class="string">&quot;scaling_factor&quot;</span>: 100</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;originalPrice&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;scaled_float&quot;</span>, </span><br><span class="line">        <span class="string">&quot;scaling_factor&quot;</span>: 100</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;validDays&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="部署搜索工程"><a href="#部署搜索工程" class="headerlink" title="部署搜索工程"></a>部署搜索工程</h3><ul>
<li>拷贝黑马提供的搜索工程到项目根目录</li>
<li>在nacos中新增配置文件<code>search-dev.yaml</code><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/search</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">53080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="attr">hostlist:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.128</span><span class="string">:9200</span>  </span><br><span class="line">  <span class="attr">course:</span></span><br><span class="line">    <span class="attr">index:</span> <span class="string">course-publish</span></span><br><span class="line">    <span class="attr">source_fields:</span> <span class="string">id,companyId,companyName,name,users,grade,mt,mtName,st,stName,charge,pic,price,originalPrice,description,teachmode,validDays,createDate</span></span><br></pre></td></tr></table></figure></li>
<li>修改bootstrap.yml中的配置信息为自己的</li>
<li>现在分析一下提供的代码中都有什么<div class="tabs" id="es搜索工程代码分析"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#es搜索工程代码分析-1">config</button></li><li class="tab"><button type="button" data-href="#es搜索工程代码分析-2">controller</button></li><li class="tab"><button type="button" data-href="#es搜索工程代码分析-3">dto</button></li><li class="tab"><button type="button" data-href="#es搜索工程代码分析-4">service</button></li><li class="tab"><button type="button" data-href="#es搜索工程代码分析-5">serviceImpl</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="es搜索工程代码分析-1"><ul>
<li>config包下只有一个ElasticSearchConfig，主要是提供了一个Java的客户端来操作ES的，将其注册为一个bean<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 从nacos中读取es的地址，不过我这里只部署了单体ES，它这里可能是ES集群</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.hostlist&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String hostlist;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">restHighLevelClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//2. 解析hostlist配置信息</span></span><br><span class="line">        String[] split = hostlist.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="comment">//3. 创建HttpHost数组，其中存放es主机和端口的配置信息</span></span><br><span class="line">        HttpHost[] httpHostArray = <span class="keyword">new</span> HttpHost[split.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; split.length; i++) &#123;</span><br><span class="line">            String item = split[i];</span><br><span class="line">            httpHostArray[i] = <span class="keyword">new</span> HttpHost(item.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>], Integer.parseInt(item.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>]), <span class="string">&quot;http&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4. 创建RestHighLevelClient客户端</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestHighLevelClient(RestClient.builder(httpHostArray));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>不过只部署一个节点的话，可以简化一下代码<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.hostlist&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String hostlist;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">restHighLevelClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestHighLevelClient(RestClient.builder(hostlist));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="es搜索工程代码分析-2"><ul>
<li>定义了两个Controller类<ol>
<li>课程索引接口<ul>
<li>该接口根据课程信息来创建索引<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;课程信息索引接口&quot;, tags = &quot;课程信息索引接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseIndexController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.course.index&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String courseIndexStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    IndexService indexService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;添加课程索引&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;course&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">add</span><span class="params">(<span class="meta">@RequestBody</span> CourseIndex courseIndex)</span> </span>&#123;</span><br><span class="line">        Long id = courseIndex.getId();</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;课程id为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Boolean result = indexService.addCourseIndex(courseIndexStore, String.valueOf(id), courseIndex);</span><br><span class="line">        <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;添加课程索引失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>课程搜索接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;课程搜索接口&quot;, tags = &quot;课程搜索接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseSearchController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseSearchService courseSearchService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;课程搜索列表&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="title">list</span><span class="params">(PageParams pageParams, SearchCourseParamDto searchCourseParamDto)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> courseSearchService.queryCoursePubIndex(pageParams, searchCourseParamDto);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="es搜索工程代码分析-3"><ul>
<li>定义了两个dto类，一个是接收搜索课程参数的<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchCourseParamDto</span> </span>&#123;</span><br><span class="line">    <span class="comment">//关键字</span></span><br><span class="line">    <span class="keyword">private</span> String keywords;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//大分类</span></span><br><span class="line">    <span class="keyword">private</span> String mt;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//小分类</span></span><br><span class="line">    <span class="keyword">private</span> String st;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//难度等级</span></span><br><span class="line">    <span class="keyword">private</span> String grade;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>另一个是网站门户显示的<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchPageResultDto</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">PageResult</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//大分类列表</span></span><br><span class="line">    List&lt;String&gt; mtList;</span><br><span class="line">    <span class="comment">//小分类列表</span></span><br><span class="line">    List&lt;String&gt; stList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SearchPageResultDto</span><span class="params">(List&lt;T&gt; items, <span class="keyword">long</span> counts, <span class="keyword">long</span> page, <span class="keyword">long</span> pageSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(items, counts, page, pageSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="es搜索工程代码分析-4"><ul>
<li>定义了两个Service接口<ol>
<li>课程索引Service，提供了三个接口，添加索引、更新索引、删除索引<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IndexService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> indexName 索引名称</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id        主键</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> object    索引对象</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Boolean true表示成功,false失败</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@description</span> 添加索引</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2022/9/24 22:57</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">addCourseIndex</span><span class="params">(String indexName, String id, Object object)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> indexName 索引名称</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id        主键</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> object    索引对象</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Boolean true表示成功,false失败</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@description</span> 更新索引</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2022/9/25 7:49</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">updateCourseIndex</span><span class="params">(String indexName, String id, Object object)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> indexName 索引名称</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id        主键</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> java.lang.Boolean</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@description</span> 删除索引</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2022/9/25 9:27</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">deleteCourseIndex</span><span class="params">(String indexName, String id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>课程搜索Service<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CourseSearchService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> pageParams           分页参数</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> searchCourseParamDto 搜索条件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> com.xuecheng.base.model.PageResult&lt;com.xuecheng.search.po.CourseIndex&gt; 课程列表</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@description</span> 搜索课程列表</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2022/9/24 22:45</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function">SearchPageResultDto&lt;CourseIndex&gt; <span class="title">queryCoursePubIndex</span><span class="params">(PageParams pageParams, SearchCourseParamDto searchCourseParamDto)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="es搜索工程代码分析-5"><ul>
<li>对应的两个实现类<ol>
<li>课程索引接口实现<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexServiceImpl</span> <span class="keyword">implements</span> <span class="title">IndexService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">addCourseIndex</span><span class="params">(String indexName, String id, Object object)</span> </span>&#123;</span><br><span class="line">        String jsonString = JSON.toJSONString(object);</span><br><span class="line">        IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(indexName).id(id);</span><br><span class="line">        <span class="comment">//指定索引文档内容</span></span><br><span class="line">        indexRequest.source(jsonString, XContentType.JSON);</span><br><span class="line">        <span class="comment">//索引响应对象</span></span><br><span class="line">        IndexResponse indexResponse = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            indexResponse = client.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;添加索引出错:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;添加索引出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String name = indexResponse.getResult().name();</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="keyword">return</span> name.equalsIgnoreCase(<span class="string">&quot;created&quot;</span>) || name.equalsIgnoreCase(<span class="string">&quot;updated&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">updateCourseIndex</span><span class="params">(String indexName, String id, Object object)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String jsonString = JSON.toJSONString(object);</span><br><span class="line">        UpdateRequest updateRequest = <span class="keyword">new</span> UpdateRequest(indexName, id);</span><br><span class="line">        updateRequest.doc(jsonString, XContentType.JSON);</span><br><span class="line">        UpdateResponse updateResponse = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            updateResponse = client.update(updateRequest, RequestOptions.DEFAULT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;更新索引出错:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;更新索引出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        DocWriteResponse.Result result = updateResponse.getResult();</span><br><span class="line">        <span class="keyword">return</span> result.name().equalsIgnoreCase(<span class="string">&quot;updated&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">deleteCourseIndex</span><span class="params">(String indexName, String id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除索引请求对象</span></span><br><span class="line">        DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest(indexName, id);</span><br><span class="line">        <span class="comment">//响应对象</span></span><br><span class="line">        DeleteResponse deleteResponse = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            deleteResponse = client.delete(deleteRequest, RequestOptions.DEFAULT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;删除索引出错:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;删除索引出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取响应结果</span></span><br><span class="line">        DocWriteResponse.Result result = deleteResponse.getResult();</span><br><span class="line">        <span class="keyword">return</span> result.name().equalsIgnoreCase(<span class="string">&quot;deleted&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>课程搜索接口实现<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseSearchServiceImpl</span> <span class="keyword">implements</span> <span class="title">CourseSearchService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.course.index&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String courseIndexStore;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.course.source_fields&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sourceFields;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="title">queryCoursePubIndex</span><span class="params">(PageParams pageParams, SearchCourseParamDto courseSearchParam)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置索引</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(courseIndexStore);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        <span class="comment">//source源字段过虑</span></span><br><span class="line">        String[] sourceFieldsArray = sourceFields.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        searchSourceBuilder.fetchSource(sourceFieldsArray, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        <span class="keyword">if</span> (courseSearchParam == <span class="keyword">null</span>) &#123;</span><br><span class="line">            courseSearchParam = <span class="keyword">new</span> SearchCourseParamDto();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关键字</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getKeywords())) &#123;</span><br><span class="line">            <span class="comment">//匹配关键字</span></span><br><span class="line">            MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(courseSearchParam.getKeywords(), <span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>);</span><br><span class="line">            <span class="comment">//设置匹配占比</span></span><br><span class="line">            multiMatchQueryBuilder.minimumShouldMatch(<span class="string">&quot;70%&quot;</span>);</span><br><span class="line">            <span class="comment">//提升另个字段的Boost值</span></span><br><span class="line">            multiMatchQueryBuilder.field(<span class="string">&quot;name&quot;</span>, <span class="number">10</span>);</span><br><span class="line">            boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//过虑</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getMt())) &#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;mtName&quot;</span>, courseSearchParam.getMt()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getSt())) &#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;stName&quot;</span>, courseSearchParam.getSt()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getGrade())) &#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;grade&quot;</span>, courseSearchParam.getGrade()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分页</span></span><br><span class="line">        Long pageNo = pageParams.getPageNo();</span><br><span class="line">        Long pageSize = pageParams.getPageSize();</span><br><span class="line">        <span class="keyword">int</span> start = (<span class="keyword">int</span>) ((pageNo - <span class="number">1</span>) * pageSize);</span><br><span class="line">        searchSourceBuilder.from(start);</span><br><span class="line">        searchSourceBuilder.size(Math.toIntExact(pageSize));</span><br><span class="line">        <span class="comment">//布尔查询</span></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">        <span class="comment">//高亮设置</span></span><br><span class="line">        HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">        highlightBuilder.preTags(<span class="string">&quot;&lt;font class=&#x27;eslight&#x27;&gt;&quot;</span>);</span><br><span class="line">        highlightBuilder.postTags(<span class="string">&quot;&lt;/font&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">//设置高亮字段</span></span><br><span class="line">        highlightBuilder.fields().add(<span class="keyword">new</span> HighlightBuilder.Field(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">        <span class="comment">//请求搜索</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        <span class="comment">//聚合设置</span></span><br><span class="line">        buildAggregation(searchRequest);</span><br><span class="line">        SearchResponse searchResponse = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">&quot;课程搜索异常：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SearchPageResultDto&lt;CourseIndex&gt;(<span class="keyword">new</span> ArrayList(), <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//结果集处理</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">//记录总数</span></span><br><span class="line">        TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">        <span class="comment">//数据列表</span></span><br><span class="line">        List&lt;CourseIndex&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line"></span><br><span class="line">            String sourceAsString = hit.getSourceAsString();</span><br><span class="line">            CourseIndex courseIndex = JSON.parseObject(sourceAsString, CourseIndex.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//取出source</span></span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//课程id</span></span><br><span class="line">            Long id = courseIndex.getId();</span><br><span class="line">            <span class="comment">//取出名称</span></span><br><span class="line">            String name = courseIndex.getName();</span><br><span class="line">            <span class="comment">//取出高亮字段内容</span></span><br><span class="line">            Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">            <span class="keyword">if</span> (highlightFields != <span class="keyword">null</span>) &#123;</span><br><span class="line">                HighlightField nameField = highlightFields.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (nameField != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Text[] fragments = nameField.getFragments();</span><br><span class="line">                    StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                    <span class="keyword">for</span> (Text str : fragments) &#123;</span><br><span class="line">                        stringBuffer.append(str.string());</span><br><span class="line">                    &#125;</span><br><span class="line">                    name = stringBuffer.toString();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            courseIndex.setId(id);</span><br><span class="line">            courseIndex.setName(name);</span><br><span class="line"></span><br><span class="line">            list.add(courseIndex);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        SearchPageResultDto&lt;CourseIndex&gt; pageResult = <span class="keyword">new</span> SearchPageResultDto&lt;&gt;(list, totalHits.value, pageNo, pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取聚合结果</span></span><br><span class="line">        List&lt;String&gt; mtList = getAggregation(searchResponse.getAggregations(), <span class="string">&quot;mtAgg&quot;</span>);</span><br><span class="line">        List&lt;String&gt; stList = getAggregation(searchResponse.getAggregations(), <span class="string">&quot;stAgg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        pageResult.setMtList(mtList);</span><br><span class="line">        pageResult.setStList(stList);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildAggregation</span><span class="params">(SearchRequest request)</span> </span>&#123;</span><br><span class="line">        request.source().aggregation(AggregationBuilders</span><br><span class="line">                .terms(<span class="string">&quot;mtAgg&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;mtName&quot;</span>)</span><br><span class="line">                .size(<span class="number">100</span>)</span><br><span class="line">        );</span><br><span class="line">        request.source().aggregation(AggregationBuilders</span><br><span class="line">                .terms(<span class="string">&quot;stAgg&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;stName&quot;</span>)</span><br><span class="line">                .size(<span class="number">100</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getAggregation</span><span class="params">(Aggregations aggregations, String aggName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 4.1.根据聚合名称获取聚合结果</span></span><br><span class="line">        Terms brandTerms = aggregations.get(aggName);</span><br><span class="line">        <span class="comment">// 4.2.获取buckets</span></span><br><span class="line">        List&lt;? extends Terms.Bucket&gt; buckets = brandTerms.getBuckets();</span><br><span class="line">        <span class="comment">// 4.3.遍历</span></span><br><span class="line">        List&lt;String&gt; brandList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">            <span class="comment">// 4.4.获取key</span></span><br><span class="line">            String key = bucket.getKeyAsString();</span><br><span class="line">            brandList.add(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> brandList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
</li>
</ul>
<h2 id="索引管理"><a href="#索引管理" class="headerlink" title="索引管理"></a>索引管理</h2><h3 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h3><ul>
<li>索引创建好，就可以向其进行增删改查操作，ElasticSearch会根据所以的mapping配置对对应字段分词<ol>
<li>添加文档：基本语法如下<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /&#123;索引库名&#125;/_doc/&#123;id&#125;</span><br><span class="line">&#123;</span><br><span class="line">    json ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>查询文档，基本语法如下<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /&#123;索引库名&#125;/_doc/&#123;id&#125;</span><br></pre></td></tr></table></figure></li>
<li>修改文档，分为全量修改和增量修改<ul>
<li>全量修改：本质是先根据id删除。在RestClient的API中，全量修改与新增的API完全一致，判断的依据是ID<ul>
<li>若新增时，ID已经存在，则修改(删除再新增)</li>
<li>若新增时，ID不存在，则新增<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /&#123;索引库名&#125;/_doc/&#123;id&#125;</span><br><span class="line">&#123;</span><br><span class="line">    json ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>增量修改：修改文档中的指定字段值<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /&#123;索引库名&#125;/_update/&#123;id&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;doc&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;email&quot;</span>:<span class="string">&quot;BestApex@Apex.net&quot;</span>,</span><br><span class="line">        <span class="string">&quot;info&quot;</span>:<span class="string">&quot;恐怖G7人--马文&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="接口定义-3"><a href="#接口定义-3" class="headerlink" title="接口定义"></a>接口定义</h3><ul>
<li>当课程发布时，请求添加课程接口，添加课程信息到索引</li>
<li>当课程下架时，请求删除课程接口，从索引中删除课程信息</li>
<li>这里先实现添加课程接口<ol>
<li>根据索引的mapping结构构建po类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseIndex</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 主键</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 机构ID</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> Long companyId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 公司名称</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String companyName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 课程名称</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 适用人群</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String users;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 标签</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 大分类</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String mt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 大分类名称</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String mtName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 小分类</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String st;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 小分类名称</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String stName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 课程等级</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String grade;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 教育模式</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String teachmode;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 课程图片</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String pic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 课程介绍</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 发布时间</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@JSONField(format=&quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createDate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 状态</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 备注</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 收费规则，对应数据字典--203</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String charge;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 现价</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> Float price;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 原价</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> Float originalPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 课程有效期天数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> Integer validDays;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>创建添加课程索引接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;课程信息索引接口&quot;, tags = &quot;课程信息索引接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseIndexController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;添加课程索引&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">add</span><span class="params">(<span class="meta">@RequestBody</span> CourseIndex courseIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<h3 id="接口开发-3"><a href="#接口开发-3" class="headerlink" title="接口开发"></a>接口开发</h3><ul>
<li>定义service接口，请求ES添加课程信息<div class="note warning no-icon flat"><ul>
<li>注意：为了适应其他文档信息，需要将添加文档定义为通用的接口，此接口不仅适应添加课程，还适应添加其他信息</li>
</ul>
</div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  课程索引service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IndexService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加索引</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> indexName 索引名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id        主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object    索引对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>          true：添加成功；false：添加失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">addCourseIndex</span><span class="params">(String indexName, String id, Object object)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>对应的接口实现如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">addCourseIndex</span><span class="params">(String indexName, String id, Object object)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建request对象</span></span><br><span class="line">    IndexRequest request = <span class="keyword">new</span> IndexRequest(indexName).id(id);</span><br><span class="line">    <span class="comment">// 2. 准备请求参数，对应DSL语句中的JSON文档，所以要把对象序列化为JSON格式</span></span><br><span class="line">    String jsonString = JSON.toJSONString(object);</span><br><span class="line">    request.source(jsonString, XContentType.JSON);</span><br><span class="line">    IndexResponse response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 3. 发送请求</span></span><br><span class="line">        response = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;添加索引出错：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;添加索引出错&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4. 获取请求结果</span></span><br><span class="line">    String result = response.getResult().name();</span><br><span class="line">    <span class="comment">// 若文档不存在，则为created，若文档存在，则为updated，若两者均不是，就是出错了</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;UPDATED&quot;</span>.equalsIgnoreCase(result) || <span class="string">&quot;CREATED&quot;</span>.equalsIgnoreCase(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note warning no-icon flat"><ul>
<li>注意这里真实响应的<code>UPDATED</code>和<code>CREATED</code>是大写的，我也是DEBUG才发现的</li>
<li>所以建议用equalsIgnoreCase比较，忽略大小写</li>
</ul>
</div>
<img src="https://s1.ax1x.com/2022/12/24/zv0Dlq.png" alt=""></li>
</ul>
<h3 id="接口完善-2"><a href="#接口完善-2" class="headerlink" title="接口完善"></a>接口完善</h3><ul>
<li>完善Controller层，调用Service接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;课程信息索引接口&quot;, tags = &quot;课程信息索引接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseIndexController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IndexService indexService;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.course.index&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String courseIndexName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;添加课程信息文档&quot;)</span>   </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">add</span><span class="params">(<span class="meta">@RequestBody</span> CourseIndex courseIndex)</span> </span>&#123;</span><br><span class="line">        Long id = courseIndex.getId();</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;课程id为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Boolean result = indexService.addCourseIndex(courseIndexName, String.valueOf(id), courseIndex);</span><br><span class="line">        <span class="comment">// 当结果既不是created，又不是updated时，就会报这个错误</span></span><br><span class="line">        <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;添加课程索引失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a>接口测试</h3><ul>
<li>使用HTTP Client或者POSTMAN进行测试<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">### 新增课程文档测试</span><br><span class="line">POST &#123;&#123;search_host&#125;&#125;/search/index/course</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;charge&quot;</span> : <span class="string">&quot;201000&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;companyId&quot;</span> : <span class="number">100000</span>,</span><br><span class="line">  <span class="attr">&quot;companyName&quot;</span> : <span class="string">&quot;测试CompanyName&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;createDate&quot;</span> : <span class="string">&quot;2023-03-07 15:41:44&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;《测试测试测试测试》&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;grade&quot;</span> : <span class="string">&quot;204001&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;id&quot;</span> : <span class="number">102</span>,</span><br><span class="line">  <span class="attr">&quot;mt&quot;</span> : <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;mtName&quot;</span> : <span class="string">&quot;编程开发&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;Java编程思想&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;originalPrice&quot;</span> : <span class="number">200.0</span>,</span><br><span class="line">  <span class="attr">&quot;pic&quot;</span> : <span class="string">&quot;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;price&quot;</span> : <span class="number">100.0</span>,</span><br><span class="line">  <span class="attr">&quot;remark&quot;</span> : <span class="string">&quot;没有备注&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;st&quot;</span> : <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;stName&quot;</span> : <span class="string">&quot;Java语言&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;status&quot;</span> : <span class="string">&quot;203002&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tags&quot;</span> : <span class="string">&quot;没有标签&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;teachmode&quot;</span> : <span class="string">&quot;200002&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;validDays&quot;</span> : <span class="number">222</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h2><h3 id="需求分析-4"><a href="#需求分析-4" class="headerlink" title="需求分析"></a>需求分析</h3><ul>
<li>索引信息维护完成下一步定义搜索接口，搜索课程信息</li>
<li>首先要搞清楚搜索功能的需求，进入学成在线首页的搜索页面<br><img src="https://s1.ax1x.com/2023/03/07/ppeiK6H.png" alt=""></li>
<li>根据搜索页面可知需求如下<ol>
<li>根据一级分类、二级分类搜索课程信息</li>
<li>根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、内容</li>
<li>根据难度等级搜索课程</li>
<li>搜索页面分页显示</li>
</ol>
</li>
<li>技术点<ol>
<li>整体采用布尔查询</li>
<li>根据关键字搜索，采用MultiMatchQuery，搜索name、description字段</li>
<li>根据分类、课程等级搜索采用过滤器实现</li>
<li>分页查询</li>
<li>高亮显示<div class="note info no-icon flat"><ul>
<li>为什么课程分类、课程等级等查询使用过滤器方式？</li>
</ul>
</div>
</li>
</ol>
</li>
</ul>
<div class="note pink no-icon flat"><ul>
<li>使用关键字查询需要计算相关度算分，根据课程分类、课程等级去查询不需要计算相关度得分，使用过滤器实现根据课程分类、课程等级查询的过程不会计算相关度算分、效率更改</li>
</ul>
</div>
<h3 id="接口定义-4"><a href="#接口定义-4" class="headerlink" title="接口定义"></a>接口定义</h3><ol>
<li>定义搜索条件DTO类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchCourseParamDto</span> </span>&#123;</span><br><span class="line">    <span class="comment">//关键字（搜索条件）</span></span><br><span class="line">    <span class="keyword">private</span> String keywords;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//大分类</span></span><br><span class="line">    <span class="keyword">private</span> String mt;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//小分类</span></span><br><span class="line">    <span class="keyword">private</span> String st;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//难度等级</span></span><br><span class="line">    <span class="keyword">private</span> String grade;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>为了适应后期的扩展，定义搜索结果类，让其继承PageResult<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchPageResultDto</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">PageResult</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SearchPageResultDto</span><span class="params">(List&lt;T&gt; items, <span class="keyword">long</span> counts, <span class="keyword">long</span> page, <span class="keyword">long</span> pageSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(items, counts, page, pageSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>定义接口如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;课程搜索接口&quot;, tags = &quot;课程搜索接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseSearchController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseSearchService courseSearchService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;课程搜索列表&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="title">list</span><span class="params">(PageParams pageParams, SearchCourseParamDto searchCourseParamDto)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="接口开发-4"><a href="#接口开发-4" class="headerlink" title="接口开发"></a>接口开发</h3><ul>
<li>定义Service接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  课程搜索service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CourseSearchService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜索课程列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageParams            分页参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchCourseParamDto  搜索条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SearchPageResultDto&lt;CourseIndex&gt; <span class="title">queryCoursePubIndex</span><span class="params">(PageParams pageParams, SearchCourseParamDto searchCourseParamDto)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>接口实现，由于搜索接口的内容比较多，所以这里分几步实现<ol>
<li>实现根据分页搜索<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;elasticsearch.course.index&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String courseIndexName;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;elasticsearch.course.source_fields&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String sourceFields;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="title">queryCoursePubIndex</span><span class="params">(PageParams pageParams, SearchCourseParamDto courseSearchParam)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 准备Request对象</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest(courseIndexName);</span><br><span class="line">    <span class="comment">// 2. 组织DSL参数，这里使用布尔查询</span></span><br><span class="line">    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br><span class="line">    String[] sourceFieldsArray = sourceFields.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// sourceFieldsArray指定要返回的字段，new String[]&#123;&#125;指定不返回的字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(sourceFieldsArray, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">// 3. 分页</span></span><br><span class="line">    Long pageNo = pageParams.getPageNo();</span><br><span class="line">    Long pageSize = pageParams.getPageSize();</span><br><span class="line">    <span class="comment">// 3.1 指定起始查询位置和查询条数</span></span><br><span class="line">    <span class="keyword">int</span> start = (<span class="keyword">int</span>) ((pageNo - <span class="number">1</span>) * pageSize);</span><br><span class="line">    searchSourceBuilder.from(start)</span><br><span class="line">            .size(Math.toIntExact(pageSize));</span><br><span class="line">    <span class="comment">// 4. 布尔查询</span></span><br><span class="line">    searchSourceBuilder.query(boolQuery);</span><br><span class="line">    request.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">// 5. 发送请求，获取响应结果</span></span><br><span class="line">    SearchResponse response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;课程搜索异常：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SearchPageResultDto&lt;&gt;(<span class="keyword">new</span> ArrayList&lt;&gt;(), <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6. 解析响应</span></span><br><span class="line">    SearchHits searchHits = response.getHits();</span><br><span class="line">    <span class="comment">// 6.1 获取总条数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = searchHits.getTotalHits().value;</span><br><span class="line">    <span class="comment">// 6.2 获取文档数组</span></span><br><span class="line">    SearchHit[] hits = searchHits.getHits();</span><br><span class="line">    ArrayList&lt;CourseIndex&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 6.3 遍历</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 获取文档source</span></span><br><span class="line">        String jsonCourseString = hit.getSourceAsString();</span><br><span class="line">        <span class="comment">// 转为CourseIndex对象，加入到集合中</span></span><br><span class="line">        CourseIndex courseIndex = JSON.parseObject(jsonCourseString, CourseIndex.class);</span><br><span class="line">        list.add(courseIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7. 封装结果</span></span><br><span class="line">    SearchPageResultDto&lt;CourseIndex&gt; pageResult = <span class="keyword">new</span> SearchPageResultDto&lt;&gt;(list, totalHits, pageNo, pageSize);</span><br><span class="line">    <span class="keyword">return</span> pageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>代码与DSL语句对应如下 <psw>(偷个懒用以前的文章的图)</psw><br><img src="https://s1.ax1x.com/2023/01/05/pSA8ZHP.png" alt=""></li>
</ul>
<h3 id="基本功能测试"><a href="#基本功能测试" class="headerlink" title="基本功能测试"></a>基本功能测试</h3><div class="note warning no-icon flat"><ul>
<li>如果看不到数据，请检查search模块中bootstrap配置和nacos上网关的配置<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 网关中的服务名应与bootstrap中配置的服务名保持一致</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">search</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://search</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/search/**</span></span><br></pre></td></tr></table></figure></li>
</ul>
</div>
<ul>
<li>当输入查询条件是，会查询全部课程信息，并支持分页查询<br><img src="https://s1.ax1x.com/2023/03/07/ppeVeQU.png" alt=""></li>
</ul>
<h3 id="根据条件搜索"><a href="#根据条件搜索" class="headerlink" title="根据条件搜索"></a>根据条件搜索</h3><ul>
<li>下面实现根据关键字、一级分类、二级分类、难度等级搜索<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public SearchPageResultDto&lt;CourseIndex&gt; queryCoursePubIndex(PageParams pageParams, SearchCourseParamDto courseSearchParam) &#123;</span><br><span class="line">        // 1. 准备Request对象</span><br><span class="line">        SearchRequest request = new SearchRequest(courseIndexName);</span><br><span class="line">        // 2. 组织DSL参数，这里使用布尔查询</span><br><span class="line">        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br><span class="line">        String[] sourceFieldsArray = sourceFields.split(&quot;,&quot;);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br><span class="line">        // sourceFieldsArray指定要返回的字段，new String[]&#123;&#125;指定不返回的字段</span><br><span class="line">        searchSourceBuilder.fetchSource(sourceFieldsArray, new String[]&#123;&#125;);</span><br><span class="line">        // 3. 分页</span><br><span class="line">        Long pageNo = pageParams.getPageNo();</span><br><span class="line">        Long pageSize = pageParams.getPageSize();</span><br><span class="line"><span class="addition">+       // 3.1 指定起始查询位置和查询条数</span></span><br><span class="line"><span class="addition">+       int start = (int) ((pageNo - 1) * pageSize);</span></span><br><span class="line"><span class="addition">+       searchSourceBuilder.from(start)</span></span><br><span class="line"><span class="addition">+               .size(Math.toIntExact(pageSize));</span></span><br><span class="line"><span class="addition">+       // 3.2 指定条件查询</span></span><br><span class="line"><span class="addition">+       if (courseSearchParam == null) &#123;</span></span><br><span class="line"><span class="addition">+           courseSearchParam = new SearchCourseParamDto();</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line"><span class="addition">+       // 3.2.1 匹配关键字</span></span><br><span class="line"><span class="addition">+       if (StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;</span></span><br><span class="line"><span class="addition">+           String keywords = courseSearchParam.getKeywords();</span></span><br><span class="line"><span class="addition">+           boolQuery.must(QueryBuilders</span></span><br><span class="line"><span class="addition">+                   .multiMatchQuery(keywords,&quot;name&quot;, &quot;description&quot;)</span></span><br><span class="line"><span class="addition">+                   .minimumShouldMatch(&quot;70%&quot;)</span></span><br><span class="line"><span class="addition">+                   .field(&quot;name&quot;, 10));</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line"><span class="addition">+       // 3.2.2 匹配大分类</span></span><br><span class="line"><span class="addition">+       if (StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;</span></span><br><span class="line"><span class="addition">+           boolQuery.filter(QueryBuilders</span></span><br><span class="line"><span class="addition">+                   .termQuery(&quot;mtName&quot;, courseSearchParam.getMt()));</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line"><span class="addition">+       // 3.2.3 匹配小分类</span></span><br><span class="line"><span class="addition">+       if (StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;</span></span><br><span class="line"><span class="addition">+           boolQuery.filter(QueryBuilders</span></span><br><span class="line"><span class="addition">+                   .termQuery(&quot;stName&quot;, courseSearchParam.getSt()));</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line"><span class="addition">+       // 3.2.4 匹配难度</span></span><br><span class="line"><span class="addition">+       if (StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;</span></span><br><span class="line"><span class="addition">+           boolQuery.filter(QueryBuilders</span></span><br><span class="line"><span class="addition">+                   .termQuery(&quot;grade&quot;, courseSearchParam.getGrade()));</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line">        // 4. 布尔查询</span><br><span class="line">        searchSourceBuilder.query(boolQuery);</span><br><span class="line">        request.source(searchSourceBuilder);</span><br><span class="line">        // 5. 发送请求，获取响应结果</span><br><span class="line">        SearchResponse response = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.debug(&quot;课程搜索异常：&#123;&#125;&quot;, e.getMessage());</span><br><span class="line">            return new SearchPageResultDto&lt;&gt;(new ArrayList&lt;&gt;(), 0, 0, 0);</span><br><span class="line">        &#125;</span><br><span class="line">        // 6. 解析响应</span><br><span class="line">        SearchHits searchHits = response.getHits();</span><br><span class="line">        // 6.1 获取总条数</span><br><span class="line">        long totalHits = searchHits.getTotalHits().value;</span><br><span class="line">        // 6.2 获取文档数组</span><br><span class="line">        SearchHit[] hits = searchHits.getHits();</span><br><span class="line">        ArrayList&lt;CourseIndex&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        // 6.3 遍历</span><br><span class="line">        for (SearchHit hit : hits) &#123;</span><br><span class="line">            // 获取文档source</span><br><span class="line">            String jsonCourseString = hit.getSourceAsString();</span><br><span class="line">            // 转为CourseIndex对象，加入到集合中</span><br><span class="line">            CourseIndex courseIndex = JSON.parseObject(jsonCourseString, CourseIndex.class);</span><br><span class="line">            list.add(courseIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        // 7. 封装结果</span><br><span class="line">        SearchPageResultDto&lt;CourseIndex&gt; pageResult = new SearchPageResultDto&lt;&gt;(list, totalHits, pageNo, pageSize);</span><br><span class="line">        return pageResult;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="条件搜索测试"><a href="#条件搜索测试" class="headerlink" title="条件搜索测试"></a>条件搜索测试</h3><ul>
<li>进入搜索界面，输入关键字进行测试，点击分类测试</li>
</ul>
<h3 id="聚合搜索"><a href="#聚合搜索" class="headerlink" title="聚合搜索"></a>聚合搜索</h3><ul>
<li>搜索页面上显示的一级分类、二级分类来源于搜索结果，使用聚合搜索实现找到搜索结果中的一级分类、二级分类<ol>
<li>首先在搜索结果DTO类中添加一级分类、二级分类列表<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@ToString</span><br><span class="line">public class SearchPageResultDto&lt;T&gt; extends PageResult &#123;</span><br><span class="line"></span><br><span class="line"><span class="addition">+   //大分类列表</span></span><br><span class="line"><span class="addition">+   List&lt;String&gt; mtList;</span></span><br><span class="line"><span class="addition">+   //小分类列表</span></span><br><span class="line"><span class="addition">+   List&lt;String&gt; stList;</span></span><br><span class="line"></span><br><span class="line">    public SearchPageResultDto(List&lt;T&gt; items, long counts, long page, long pageSize) &#123;</span><br><span class="line">        super(items, counts, page, pageSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>搜索方法如下<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public SearchPageResultDto&lt;CourseIndex&gt; queryCoursePubIndex(PageParams pageParams, SearchCourseParamDto courseSearchParam) &#123;</span><br><span class="line">        // 1. 准备Request对象</span><br><span class="line">        SearchRequest request = new SearchRequest(courseIndexName);</span><br><span class="line">        // 2. 组织DSL参数，这里使用布尔查询</span><br><span class="line">        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br><span class="line">        String[] sourceFieldsArray = sourceFields.split(&quot;,&quot;);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br><span class="line">        // sourceFieldsArray指定要返回的字段，new String[]&#123;&#125;指定不返回的字段</span><br><span class="line">        searchSourceBuilder.fetchSource(sourceFieldsArray, new String[]&#123;&#125;);</span><br><span class="line">        // 3. 分页</span><br><span class="line">        Long pageNo = pageParams.getPageNo();</span><br><span class="line">        Long pageSize = pageParams.getPageSize();</span><br><span class="line">        // 3.1 指定起始查询位置和查询条数</span><br><span class="line">        int start = (int) ((pageNo - 1) * pageSize);</span><br><span class="line">        searchSourceBuilder.from(start)</span><br><span class="line">                .size(Math.toIntExact(pageSize));</span><br><span class="line">        // 3.2 指定条件查询</span><br><span class="line">        if (courseSearchParam == null) &#123;</span><br><span class="line">            courseSearchParam = new SearchCourseParamDto();</span><br><span class="line">        &#125;</span><br><span class="line">        // 3.2.1 匹配关键字</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;</span><br><span class="line">            String keywords = courseSearchParam.getKeywords();</span><br><span class="line">            boolQuery.must(QueryBuilders</span><br><span class="line">                    .multiMatchQuery(keywords,&quot;name&quot;, &quot;description&quot;)</span><br><span class="line">                    .minimumShouldMatch(&quot;70%&quot;)</span><br><span class="line">                    .field(&quot;name&quot;, 10));</span><br><span class="line">        &#125;</span><br><span class="line">        // 3.2.2 匹配大分类</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;</span><br><span class="line">            boolQuery.filter(QueryBuilders</span><br><span class="line">                    .termQuery(&quot;mtName&quot;, courseSearchParam.getMt()));</span><br><span class="line">        &#125;</span><br><span class="line">        // 3.2.3 匹配小分类</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;</span><br><span class="line">            boolQuery.filter(QueryBuilders</span><br><span class="line">                    .termQuery(&quot;stName&quot;, courseSearchParam.getSt()));</span><br><span class="line">        &#125;</span><br><span class="line">        // 3.2.4 匹配难度</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;</span><br><span class="line">            boolQuery.filter(QueryBuilders</span><br><span class="line">                    .termQuery(&quot;grade&quot;, courseSearchParam.getGrade()));</span><br><span class="line">        &#125;</span><br><span class="line">        // 4. 布尔查询</span><br><span class="line">        searchSourceBuilder.query(boolQuery);</span><br><span class="line">        request.source(searchSourceBuilder);</span><br><span class="line"><span class="addition">+       // 聚合设置</span></span><br><span class="line"><span class="addition">+       buildAggregation(request);</span></span><br><span class="line">        // 5. 发送请求，获取响应结果</span><br><span class="line">        SearchResponse response = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.debug(&quot;课程搜索异常：&#123;&#125;&quot;, e.getMessage());</span><br><span class="line">            return new SearchPageResultDto&lt;&gt;(new ArrayList&lt;&gt;(), 0, 0, 0);</span><br><span class="line">        &#125;</span><br><span class="line">        // 6. 解析响应</span><br><span class="line">        SearchHits searchHits = response.getHits();</span><br><span class="line">        // 6.1 获取总条数</span><br><span class="line">        long totalHits = searchHits.getTotalHits().value;</span><br><span class="line">        // 6.2 获取文档数组</span><br><span class="line">        SearchHit[] hits = searchHits.getHits();</span><br><span class="line">        ArrayList&lt;CourseIndex&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        // 6.3 遍历</span><br><span class="line">        for (SearchHit hit : hits) &#123;</span><br><span class="line">            // 获取文档source</span><br><span class="line">            String jsonCourseString = hit.getSourceAsString();</span><br><span class="line">            // 转为CourseIndex对象，加入到集合中</span><br><span class="line">            CourseIndex courseIndex = JSON.parseObject(jsonCourseString, CourseIndex.class);</span><br><span class="line">            list.add(courseIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        // 7. 封装结果</span><br><span class="line"><span class="addition">+       List&lt;String&gt; mtList = getAggregation(response.getAggregations(), &quot;mtAgg&quot;);</span></span><br><span class="line"><span class="addition">+       List&lt;String&gt; stList = getAggregation(response.getAggregations(), &quot;stAgg&quot;);</span></span><br><span class="line">        SearchPageResultDto&lt;CourseIndex&gt; pageResult = new SearchPageResultDto&lt;&gt;(list, totalHits, pageNo, pageSize);</span><br><span class="line"><span class="addition">+       pageResult.setMtList(mtList);</span></span><br><span class="line"><span class="addition">+       pageResult.setStList(stList);</span></span><br><span class="line">        return pageResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="addition">+   private void buildAggregation(SearchRequest request) &#123;</span></span><br><span class="line"><span class="addition">+       request.source().aggregation(AggregationBuilders</span></span><br><span class="line"><span class="addition">+               .terms(&quot;mtAgg&quot;)</span></span><br><span class="line"><span class="addition">+               .field(&quot;mtName&quot;)</span></span><br><span class="line"><span class="addition">+               .size(100)</span></span><br><span class="line"><span class="addition">+       );</span></span><br><span class="line"><span class="addition">+       request.source().aggregation(AggregationBuilders</span></span><br><span class="line"><span class="addition">+               .terms(&quot;stAgg&quot;)</span></span><br><span class="line"><span class="addition">+               .field(&quot;stName&quot;)</span></span><br><span class="line"><span class="addition">+               .size(100)</span></span><br><span class="line"><span class="addition">+       );</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+   /**</span></span><br><span class="line"><span class="addition">+   * 根据聚合名称获取聚合结果</span></span><br><span class="line"><span class="addition">+   * @param aggregations  聚合对象</span></span><br><span class="line"><span class="addition">+   * @param aggName       聚合名称</span></span><br><span class="line"><span class="addition">+   * @return              聚合结果，返回List集合</span></span><br><span class="line"><span class="addition">+   */</span></span><br><span class="line"><span class="addition">+   private List&lt;String&gt; getAggregation(Aggregations aggregations, String aggName) &#123;</span></span><br><span class="line"><span class="addition">+       // 1. 根据聚合名称获取聚合结果</span></span><br><span class="line"><span class="addition">+       Terms brandTerms = aggregations.get(aggName);</span></span><br><span class="line"><span class="addition">+       // 2. 获取buckets</span></span><br><span class="line"><span class="addition">+       List&lt;? extends Terms.Bucket&gt; buckets = brandTerms.getBuckets();</span></span><br><span class="line"><span class="addition">+       // 3. 遍历</span></span><br><span class="line"><span class="addition">+       List&lt;String&gt; brandList = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="addition">+       for (Terms.Bucket bucket : buckets) &#123;</span></span><br><span class="line"><span class="addition">+           // 4. 获取key</span></span><br><span class="line"><span class="addition">+           String key = bucket.getKeyAsString();</span></span><br><span class="line"><span class="addition">+           // 5. 加入到集合中</span></span><br><span class="line"><span class="addition">+           brandList.add(key);</span></span><br><span class="line"><span class="addition">+       &#125;</span></span><br><span class="line"><span class="addition">+       return brandList;</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br></pre></td></tr></table></figure>
<img src="https://s1.ax1x.com/2023/01/07/pSVk1ne.png" alt=""></li>
</ol>
</li>
</ul>
<h3 id="聚合搜索测试"><a href="#聚合搜索测试" class="headerlink" title="聚合搜索测试"></a>聚合搜索测试</h3><ul>
<li>进入搜索界面，观察搜索请求的响应内容中是否存在mtList和stList<br><img src="https://s1.ax1x.com/2023/03/07/ppem1Fs.png" alt=""><div class="note warning no-icon flat"><ul>
<li>注意：当选中一个一级分类时，才会显示二级分类</li>
</ul>
</div>
</li>
</ul>
<h3 id="高亮设置"><a href="#高亮设置" class="headerlink" title="高亮设置"></a>高亮设置</h3><ul>
<li>最后实现关键字在课程名称中高亮显示<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public SearchPageResultDto&lt;CourseIndex&gt; queryCoursePubIndex(PageParams pageParams, SearchCourseParamDto courseSearchParam) &#123;</span><br><span class="line">        log.debug(&quot;ES条件查询并响应分页结果&quot;);</span><br><span class="line">        // 1. 准备Request对象</span><br><span class="line">        SearchRequest request = new SearchRequest(courseIndexName);</span><br><span class="line">        // 2. 组织DSL参数，这里使用布尔查询</span><br><span class="line">        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br><span class="line">        String[] sourceFieldsArray = sourceFields.split(&quot;,&quot;);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br><span class="line">        // sourceFieldsArray指定要返回的字段，new String[]&#123;&#125;指定不返回的字段</span><br><span class="line">        searchSourceBuilder.fetchSource(sourceFieldsArray, new String[]&#123;&#125;);</span><br><span class="line">        // 3. 分页</span><br><span class="line">        Long pageNo = pageParams.getPageNo();</span><br><span class="line">        Long pageSize = pageParams.getPageSize();</span><br><span class="line">        // 3.1 指定起始查询位置和查询条数</span><br><span class="line">        int start = (int) ((pageNo - 1) * pageSize);</span><br><span class="line">        searchSourceBuilder.from(start)</span><br><span class="line">                .size(Math.toIntExact(pageSize));</span><br><span class="line">        // 3.2 指定条件查询</span><br><span class="line">        if (courseSearchParam == null) &#123;</span><br><span class="line">            courseSearchParam = new SearchCourseParamDto();</span><br><span class="line">        &#125;</span><br><span class="line">        // 3.2.1 匹配关键字</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getKeywords())) &#123;</span><br><span class="line">            String keywords = courseSearchParam.getKeywords();</span><br><span class="line">            boolQuery.must(QueryBuilders</span><br><span class="line">                    .multiMatchQuery(keywords, &quot;name&quot;, &quot;description&quot;)</span><br><span class="line">                    .minimumShouldMatch(&quot;70%&quot;)</span><br><span class="line">                    .field(&quot;name&quot;, 10));</span><br><span class="line">        &#125;</span><br><span class="line">        // 3.2.2 匹配大分类</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getMt())) &#123;</span><br><span class="line">            boolQuery.filter(QueryBuilders</span><br><span class="line">                    .termQuery(&quot;mtName&quot;, courseSearchParam.getMt()));</span><br><span class="line">        &#125;</span><br><span class="line">        // 3.2.3 匹配小分类</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getSt())) &#123;</span><br><span class="line">            boolQuery.filter(QueryBuilders</span><br><span class="line">                    .termQuery(&quot;stName&quot;, courseSearchParam.getSt()));</span><br><span class="line">        &#125;</span><br><span class="line">        // 3.2.4 匹配难度</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getGrade())) &#123;</span><br><span class="line">            boolQuery.filter(QueryBuilders</span><br><span class="line">                    .termQuery(&quot;grade&quot;, courseSearchParam.getGrade()));</span><br><span class="line">        &#125;</span><br><span class="line">        // 4. 布尔查询</span><br><span class="line">        searchSourceBuilder.query(boolQuery);</span><br><span class="line"><span class="addition">+       // 高亮</span></span><br><span class="line"><span class="addition">+       searchSourceBuilder.highlighter(new HighlightBuilder()</span></span><br><span class="line"><span class="addition">+               .field(&quot;name&quot;)</span></span><br><span class="line"><span class="addition">+               .preTags(&quot;&lt;font class=&#x27;eslight&#x27;&gt;&quot;)</span></span><br><span class="line"><span class="addition">+               .postTags(&quot;&lt;/font&gt;&quot;));</span></span><br><span class="line">        request.source(searchSourceBuilder);</span><br><span class="line">        // 聚合设置</span><br><span class="line">        buildAggregation(request);</span><br><span class="line">        // 5. 发送请求，获取响应结果</span><br><span class="line">        SearchResponse response = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.debug(&quot;课程搜索异常：&#123;&#125;&quot;, e.getMessage());</span><br><span class="line">            return new SearchPageResultDto&lt;&gt;(new ArrayList&lt;&gt;(), 0, 0, 0);</span><br><span class="line">        &#125;</span><br><span class="line">        // 6. 解析响应</span><br><span class="line">        SearchHits searchHits = response.getHits();</span><br><span class="line">        // 6.1 获取总条数</span><br><span class="line">        long totalHits = searchHits.getTotalHits().value;</span><br><span class="line">        // 6.2 获取文档数组</span><br><span class="line">        SearchHit[] hits = searchHits.getHits();</span><br><span class="line">        ArrayList&lt;CourseIndex&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        // 6.3 遍历</span><br><span class="line">        for (SearchHit hit : hits) &#123;</span><br><span class="line">            // 获取文档source</span><br><span class="line">            String jsonCourseString = hit.getSourceAsString();</span><br><span class="line">            // 转为CourseIndex对象</span><br><span class="line">            CourseIndex courseIndex = JSON.parseObject(jsonCourseString, CourseIndex.class);</span><br><span class="line"><span class="addition">+           // 获取高亮</span></span><br><span class="line"><span class="addition">+           Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span></span><br><span class="line"><span class="addition">+           log.debug(&quot;获取高亮：&#123;&#125;&quot;, highlightFields);</span></span><br><span class="line"><span class="addition">+           String name = courseIndex.getName();</span></span><br><span class="line"><span class="addition">+           // 健壮性判断</span></span><br><span class="line"><span class="addition">+           if (!CollectionUtils.isEmpty(highlightFields)) &#123;</span></span><br><span class="line"><span class="addition">+               // 获取高亮字段结果</span></span><br><span class="line"><span class="addition">+               HighlightField highlightField = highlightFields.get(&quot;name&quot;);</span></span><br><span class="line"><span class="addition">+               log.debug(&quot;成功获取高亮字段&quot;);</span></span><br><span class="line"><span class="addition">+               // 健壮性判断</span></span><br><span class="line"><span class="addition">+               if (highlightField != null) &#123;</span></span><br><span class="line"><span class="addition">+                   log.debug(&quot;取出高亮结果数组的第一个&quot;);</span></span><br><span class="line"><span class="addition">+                   // 取出高亮结果数组的第一个</span></span><br><span class="line"><span class="addition">+                   name = highlightField.getFragments()[0].toString();</span></span><br><span class="line"><span class="addition">+               &#125;</span></span><br><span class="line"><span class="addition">+           &#125;</span></span><br><span class="line"><span class="addition">+           courseIndex.setName(name);</span></span><br><span class="line">            list.add(courseIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        // 7. 封装结果</span><br><span class="line">        List&lt;String&gt; mtList = getAggregation(response.getAggregations(), &quot;mtAgg&quot;);</span><br><span class="line">        List&lt;String&gt; stList = getAggregation(response.getAggregations(), &quot;stAgg&quot;);</span><br><span class="line">        SearchPageResultDto&lt;CourseIndex&gt; pageResult = new SearchPageResultDto&lt;&gt;(list, totalHits, pageNo, pageSize);</span><br><span class="line">        pageResult.setMtList(mtList);</span><br><span class="line">        pageResult.setStList(stList);</span><br><span class="line">        return pageResult;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<img src="https://s1.ax1x.com/2023/01/06/pSAN10A.png" alt=""></li>
</ul>
<h3 id="高亮设置测试"><a href="#高亮设置测试" class="headerlink" title="高亮设置测试"></a>高亮设置测试</h3><ul>
<li>输入关键字，观察搜索结果、标题中是否对关键字进行了高亮显示</li>
<li>输入框搜索Python，查看控制台<br><img src="https://s1.ax1x.com/2023/03/08/ppeHHRP.png" alt=""></li>
</ul>
<h2 id="课程发布任务完善"><a href="#课程发布任务完善" class="headerlink" title="课程发布任务完善"></a>课程发布任务完善</h2><h3 id="需求分析-5"><a href="#需求分析-5" class="headerlink" title="需求分析"></a>需求分析</h3><ul>
<li>执行课程发布操作后，由消息处理机制向ElasticSearch索引保存课程信息</li>
<li>由内容管理服务远程调用搜索服务，添加课程信息索引</li>
<li>搜索服务请求ElasticSearch添加课程信息</li>
</ul>
<h3 id="课程索引任务开发"><a href="#课程索引任务开发" class="headerlink" title="课程索引任务开发"></a>课程索引任务开发</h3><ol>
<li>在内容管理服务中添加FeignClient<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;search&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SearchServiceClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/search/index/course&quot;)</span></span><br><span class="line">    <span class="function">Boolean <span class="title">add</span><span class="params">(<span class="meta">@RequestBody</span> CourseIndex courseIndex)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>编写课程索引任务执行方法，在课程发布Service中定义保存课程索引方法</p>
<ul>
<li>定义Service接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 保存课程索引</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">Boolean <span class="title">saveCourseIndex</span><span class="params">(Long courseId)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li>对应的实现方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">saveCourseIndex</span><span class="params">(Long courseId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 取出课程发布信息</span></span><br><span class="line">    CoursePublish coursePublish = coursePublishMapper.selectById(courseId);</span><br><span class="line">    <span class="comment">// 2. 拷贝至课程索引对象</span></span><br><span class="line">    CourseIndex courseIndex = <span class="keyword">new</span> CourseIndex();</span><br><span class="line">    BeanUtils.copyProperties(coursePublish, courseIndex);</span><br><span class="line">    <span class="comment">// 3. 远程调用搜索服务API，添加课程索引信息</span></span><br><span class="line">    Boolean result = searchServiceClient.add(courseIndex);</span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;添加索引失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>完善CoursePublishTask类中的saveCourseIndex方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveCourseIndex</span><span class="params">(MqMessage mqMessage, Long courseId)</span> </span>&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;正在保存课程信息索引，课程id:&#123;&#125;&quot;</span>, courseId);</span><br><span class="line">    <span class="comment">// 1. 获取消息id</span></span><br><span class="line">    Long id = mqMessage.getId();</span><br><span class="line">    <span class="comment">// 2. 获取小任务阶段状态</span></span><br><span class="line">    MqMessageService mqMessageService = <span class="keyword">this</span>.getMqMessageService();</span><br><span class="line">    <span class="keyword">int</span> stageTwo = mqMessageService.getStageTwo(id);</span><br><span class="line">    <span class="comment">// 3. 当前小任务完成，无需再次处理</span></span><br><span class="line">    <span class="keyword">if</span> (stageTwo == <span class="number">1</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;当前阶段为创建课程索引任务，已完成，无需再次处理，任务信息：&#123;&#125;&quot;</span>, mqMessage);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4. 远程调用保存课程索引接口，将课程信息上传至ElasticSearch</span></span><br><span class="line">    Boolean result = coursePublishService.saveCourseIndex(courseId);</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        mqMessageService.completedStageTwo(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><ul>
<li>发布一门课程，观察该课程信息是否正常添加到索引中<br><img src="https://s1.ax1x.com/2023/03/08/ppebpin.png" alt=""></li>
</ul>
<h2 id="面试-2"><a href="#面试-2" class="headerlink" title="面试"></a>面试</h2><div class="note info no-icon flat"><ul>
<li>ElasticSearch是怎么使用的</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>本项目使用ElasticSearch开发搜索服务，步骤如下<ol>
<li>创建索引（相当于数据库表），将课程信息添加到索引库，对课程信息进行分词，存储到索引库</li>
<li>开发一个搜索服务，编写课程搜索接口，调用ElasticSearch的rest接口根据关键字、课程分类等信息进行搜索</li>
</ol>
</li>
</ul>
</div>
<div class="note info no-icon flat"><ul>
<li>如何保证索引同步？</li>
</ul>
</div>
<div class="note pink no-icon flat"><ul>
<li>本项目时使用本地任务表 + xxl-job任务调度进行索引同步，具体流程如下    <ol>
<li>添加或修改或删除课程的同时，向任务表插入一条记录，这条记录就记录了是添加还是修改还是删除了哪个课程</li>
<li>任务调度定时扫描任务表，根据任务表的内容对课程信息进行同步<ul>
<li>如果添加了课程，将课程添加到索引库</li>
<li>如果修改了课程，就修改索引库的课程</li>
<li>如果是删除了课程，将课程信息从索引库删除</li>
</ul>
</li>
</ol>
</li>
</ul>
</div>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Kyle Violet</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cyborg2077.github.io/2023/02/28/XuechengOnlinePart4/">https://cyborg2077.github.io/2023/02/28/XuechengOnlinePart4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cyborg2077.github.io" target="_blank">Kyle's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a><a class="post-meta__tags" href="/tags/MyBatisPlus/">MyBatisPlus</a><a class="post-meta__tags" href="/tags/xxl-job/">xxl-job</a></div><div class="post_share"><div class="social-share" data-image="https://img2.baidu.com/it/u=595920241,2439700946&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1422&amp;h=800" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">不给糖就捣蛋~</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.svg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.svg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.svg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.svg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></button></div><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/08/XuechengOnlinePart5/"><img class="prev-cover" src="https://img2.baidu.com/it/u=1767752488,2158562887&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=932&amp;h=500" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">学成在线--认证授权模块开发</div></div></a></div><div class="next-post pull-right"><a href="/2023/02/10/XuechengOnlinePart3/"><img class="next-cover" src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fi0.hdslb.com%2Fbfs%2Farticle%2F7195c774995376cbaf3c2868706521746c0e9142.png&amp;refer=http%3A%2F%2Fi0.hdslb.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1645330580&amp;t=7ef089d6818c156c451e5072f53f3597" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">学成在线--媒资管理模块开发</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="cols"><div class="col"><div class="container"><div class="front avatarPanel"><div class="inner"><div class="player-title">Attributes</div><div class="player-avatar"><img src="https://s2.loli.net/2022/04/18/fj4XvrdM5o62hbA.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div></div></div><div class="back attributesPanel"><div class="inner"><div class="player-lv">LV.11</div><div class="player-name">Kyle Violet</div><div class="attributes-value"><div class="attributes-value-item"><a href="/archives/"><div class="attributes">文章</div><div class="value-bar"><div class="value-bar-fill" style="width:52.50%"><div class="value-bar-fill-in" style="background: rgba(89, 230, 54,0.6)"></div></div></div><span>105/200</span></a></div><div class="attributes-value-item"><a href="/tags/"><div class="attributes">标签</div><div class="value-bar"><div class="value-bar-fill" style="width:86.00%"><div class="value-bar-fill-in" style="background: rgba(224, 20, 20, 0.6)"></div></div></div><span>86/100</span></a></div><div class="attributes-value-item"><a href="/categories/"><div class="attributes">分类</div><div class="value-bar"><div class="value-bar-fill" style="width:10.00%"><div class="value-bar-fill-in" style="background: rgba(30, 97, 226, 0.6)"></div></div></div><span>10/100</span></a></div></div></div></div></div></div><div class="col"><div class="container"><div class="front descriptionPanel"><div class="inner"><div class="player_description">The furthest distance in the world <br>ls not between life and death <br>But when l stand in front of you <br> Yet you don't know that l love you</div><div class="play-bottom"></div></div></div><div class="back buttonPanel"><div class="inner"><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Cyborg2077"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Cyborg2077" target="_blank" title="Github"><i class="iconfont icon-github"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=1586385296&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="iconfont icon-QQ"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=608935942" target="_blank" title="网抑云"><i class="iconfont icon-wangyiyunyinleclick"></i></a><a class="social-icon" href="https://space.bilibili.com/160218990" target="_blank" title="Bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://steamcommunity.com/profiles/76561198851566538/" target="_blank" title="Steam"><i class="iconfont icon-steam"></i></a></div><div class="play-bottom"></div></div></div></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">如果在阅读过程中遇到了问题，可以随时联系我，看到了会在第一时间给出回复（不负责DEBUG，除非我真的写的有问题），在上面名片的背面点击QQ图标就可以了哦（免加好友的临时会话）<br><br>评论区现在采用Giscus，需登录Github方能评论<br><br>碎碎念移至生活版块的闲言碎语，使用TimeLine外挂标签替代</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D"><span class="toc-number">1.</span> <span class="toc-text">写在最前</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">模块需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">模块介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">业务流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88"><span class="toc-number">2.2.1.</span> <span class="toc-text">课程预览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%AE%A1%E6%A0%B8"><span class="toc-number">2.2.2.</span> <span class="toc-text">视频审核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83"><span class="toc-number">2.2.3.</span> <span class="toc-text">课程发布</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88-1"><span class="toc-number">3.</span> <span class="toc-text">课程预览</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="toc-number">3.2.</span> <span class="toc-text">模板引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="toc-number">3.2.1.</span> <span class="toc-text">什么是模板引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Freemarker%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text">Freemarker快速入门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%9D%99%E6%80%81%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.3.</span> <span class="toc-text">测试静态页面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E7%BD%91%E7%AB%99%E9%97%A8%E6%88%B7"><span class="toc-number">3.3.1.</span> <span class="toc-text">部署网站门户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E8%AF%A6%E6%83%85%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.3.2.</span> <span class="toc-text">课程详情页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">3.3.3.</span> <span class="toc-text">文件服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.3.4.</span> <span class="toc-text">视频播放页面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">3.4.</span> <span class="toc-text">接口定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.4.1.</span> <span class="toc-text">定义课程预览接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">3.4.2.</span> <span class="toc-text">配置反向代理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">3.5.</span> <span class="toc-text">接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.5.1.</span> <span class="toc-text">数据模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.5.2.</span> <span class="toc-text">Service接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%B1%82%E5%AE%8C%E5%96%84"><span class="toc-number">3.5.3.</span> <span class="toc-text">接口层完善</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83"><span class="toc-number">3.5.4.</span> <span class="toc-text">前后端联调</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.5.5.</span> <span class="toc-text">编写模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E9%A1%B5%E9%9D%A2%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.5.6.</span> <span class="toc-text">视频播放页面接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95"><span class="toc-number">3.6.</span> <span class="toc-text">面试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%AE%A1%E6%A0%B8"><span class="toc-number">4.</span> <span class="toc-text">课程审核</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="toc-number">4.1.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-1"><span class="toc-number">4.1.1.</span> <span class="toc-text">业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B-1"><span class="toc-number">4.1.2.</span> <span class="toc-text">数据模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-number">4.2.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-1"><span class="toc-number">4.3.</span> <span class="toc-text">接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DAO%E5%BC%80%E5%8F%91"><span class="toc-number">4.3.1.</span> <span class="toc-text">DAO开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service%E5%BC%80%E5%8F%91"><span class="toc-number">4.3.2.</span> <span class="toc-text">Service开发</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="toc-number">4.4.</span> <span class="toc-text">接口完善</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-number">4.5.</span> <span class="toc-text">接口测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83-1"><span class="toc-number">5.</span> <span class="toc-text">课程发布</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-2"><span class="toc-number">5.1.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B-2"><span class="toc-number">5.1.1.</span> <span class="toc-text">数据模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98"><span class="toc-number">5.2.</span> <span class="toc-text">分布式事务问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.2.1.</span> <span class="toc-text">什么是分布式事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFCAP%E7%90%86%E8%AE%BA"><span class="toc-number">5.2.2.</span> <span class="toc-text">什么是CAP理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E6%96%B9%E6%A1%88"><span class="toc-number">5.2.3.</span> <span class="toc-text">分布式事务控制方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6"><span class="toc-number">5.2.4.</span> <span class="toc-text">课程发布分布式事务控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.3.</span> <span class="toc-text">课程发布接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="toc-number">5.3.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-2"><span class="toc-number">5.3.2.</span> <span class="toc-text">接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DAO%E5%BC%80%E5%8F%91-1"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">DAO开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%BC%80%E5%8F%91-1"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">Service开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84-1"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">接口完善</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-1"><span class="toc-number">5.3.3.</span> <span class="toc-text">接口测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86SDK"><span class="toc-number">5.4.</span> <span class="toc-text">消息处理SDK</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-number">5.4.1.</span> <span class="toc-text">消息模块技术方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97SDK%E6%B5%8B%E8%AF%95"><span class="toc-number">5.4.2.</span> <span class="toc-text">消息模块SDK测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%B6%88%E6%81%AFSDK"><span class="toc-number">5.4.3.</span> <span class="toc-text">集成消息SDK</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">课程发布任务处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-number">5.5.</span> <span class="toc-text">页面静态化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-number">5.5.1.</span> <span class="toc-text">什么是页面静态化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="toc-number">5.5.2.</span> <span class="toc-text">静态化测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%B5%8B%E8%AF%95"><span class="toc-number">5.5.3.</span> <span class="toc-text">上传文件测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86"><span class="toc-number">5.5.4.</span> <span class="toc-text">熔断降级处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-number">5.5.4.1.</span> <span class="toc-text">什么是熔断降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86-1"><span class="toc-number">5.5.4.2.</span> <span class="toc-text">熔断降级处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E9%9D%99%E6%80%81%E5%8C%96%E5%BC%80%E5%8F%91"><span class="toc-number">5.5.5.</span> <span class="toc-text">课程静态化开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%B6%88%E6%81%AF"><span class="toc-number">5.5.5.1.</span> <span class="toc-text">添加消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E9%9D%99%E6%80%81%E5%8C%96%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.5.5.2.</span> <span class="toc-text">课程静态化实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">5.5.5.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95-1"><span class="toc-number">5.6.</span> <span class="toc-text">面试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E6%90%9C%E7%B4%A2"><span class="toc-number">6.</span> <span class="toc-text">课程搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-3"><span class="toc-number">6.1.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">6.1.1.</span> <span class="toc-text">模块介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-2"><span class="toc-number">6.1.2.</span> <span class="toc-text">业务流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-number">6.2.</span> <span class="toc-text">准备环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAElasticSearch"><span class="toc-number">6.2.1.</span> <span class="toc-text">搭建ElasticSearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">6.2.2.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%90%9C%E7%B4%A2%E5%B7%A5%E7%A8%8B"><span class="toc-number">6.2.3.</span> <span class="toc-text">部署搜索工程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-number">6.3.</span> <span class="toc-text">索引管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#REST-API"><span class="toc-number">6.3.1.</span> <span class="toc-text">REST API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-3"><span class="toc-number">6.3.2.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-3"><span class="toc-number">6.3.3.</span> <span class="toc-text">接口开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84-2"><span class="toc-number">6.3.4.</span> <span class="toc-text">接口完善</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-2"><span class="toc-number">6.3.5.</span> <span class="toc-text">接口测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2"><span class="toc-number">6.4.</span> <span class="toc-text">搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-4"><span class="toc-number">6.4.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-4"><span class="toc-number">6.4.2.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-4"><span class="toc-number">6.4.3.</span> <span class="toc-text">接口开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">6.4.4.</span> <span class="toc-text">基本功能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E6%90%9C%E7%B4%A2"><span class="toc-number">6.4.5.</span> <span class="toc-text">根据条件搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%90%9C%E7%B4%A2%E6%B5%8B%E8%AF%95"><span class="toc-number">6.4.6.</span> <span class="toc-text">条件搜索测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2"><span class="toc-number">6.4.7.</span> <span class="toc-text">聚合搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E6%B5%8B%E8%AF%95"><span class="toc-number">6.4.8.</span> <span class="toc-text">聚合搜索测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E8%AE%BE%E7%BD%AE"><span class="toc-number">6.4.9.</span> <span class="toc-text">高亮设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E8%AE%BE%E7%BD%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">6.4.10.</span> <span class="toc-text">高亮设置测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E4%BB%BB%E5%8A%A1%E5%AE%8C%E5%96%84"><span class="toc-number">6.5.</span> <span class="toc-text">课程发布任务完善</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-5"><span class="toc-number">6.5.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E7%B4%A2%E5%BC%95%E4%BB%BB%E5%8A%A1%E5%BC%80%E5%8F%91"><span class="toc-number">6.5.2.</span> <span class="toc-text">课程索引任务开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-number">6.5.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95-2"><span class="toc-number">6.6.</span> <span class="toc-text">面试</span></a></li></ol></li></ol></div></div><div class="card-widget card-recommend-post"><div class="item-headline"><i class="fas fa-dharmachakra"></i><span>相关推荐</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/02/10/XuechengOnlinePart3/" title="学成在线--媒资管理模块开发"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fi0.hdslb.com%2Fbfs%2Farticle%2F7195c774995376cbaf3c2868706521746c0e9142.png&refer=http%3A%2F%2Fi0.hdslb.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1645330580&t=7ef089d6818c156c451e5072f53f3597" alt="学成在线--媒资管理模块开发"></a><div class="content"><a class="title" href="/2023/02/10/XuechengOnlinePart3/" title="学成在线--媒资管理模块开发">学成在线--媒资管理模块开发</a><time datetime="2023-03-27" title="发表于 2023-03-27">2023-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/29/XuechengOnlinePart1/" title="学成在线--项目基础环境搭建"><img src="https://img1.baidu.com/it/u=2579164449,2431217981&fm=253&fmt=auto&app=138&f=JPEG?w=800&h=500" alt="学成在线--项目基础环境搭建"></a><div class="content"><a class="title" href="/2023/01/29/XuechengOnlinePart1/" title="学成在线--项目基础环境搭建">学成在线--项目基础环境搭建</a><time datetime="2023-03-27" title="发表于 2023-03-27">2023-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/02/XuechengOnlinePart2/" title="学成在线--内容管理模块开发"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic3.zhimg.com%2Fv2-dbe4189cad999946abdcd174fba140ea_r.jpg&refer=http%3A%2F%2Fpic3.zhimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1651217592&t=44946406f8e7b9ed15f483e0495b33c9" alt="学成在线--内容管理模块开发"></a><div class="content"><a class="title" href="/2023/02/02/XuechengOnlinePart2/" title="学成在线--内容管理模块开发">学成在线--内容管理模块开发</a><time datetime="2023-03-27" title="发表于 2023-03-27">2023-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/08/XuechengOnlinePart5/" title="学成在线--认证授权模块开发"><img src="https://img2.baidu.com/it/u=1767752488,2158562887&fm=253&fmt=auto&app=138&f=JPEG?w=932&h=500" alt="学成在线--认证授权模块开发"></a><div class="content"><a class="title" href="/2023/03/08/XuechengOnlinePart5/" title="学成在线--认证授权模块开发">学成在线--认证授权模块开发</a><time datetime="2023-03-27" title="发表于 2023-03-27">2023-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/23/XuechengOnlinePart7/" title="学成在线--项目优化"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fi0.hdslb.com%2Fbfs%2Farticle%2F7195c774995376cbaf3c2868706521746c0e9142.png&refer=http%3A%2F%2Fi0.hdslb.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1645330580&t=7ef089d6818c156c451e5072f53f3597" alt="学成在线--项目优化"></a><div class="content"><a class="title" href="/2023/03/23/XuechengOnlinePart7/" title="学成在线--项目优化">学成在线--项目优化</a><time datetime="2023-03-27" title="发表于 2023-03-27">2023-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/17/XuechengOnlinePart6/" title="学成在线--选课学习模块开发"><img src="https://images.wallpaperscraft.com/image/single/silhouette_night_starry_sky_137292_300x168.jpg" alt="学成在线--选课学习模块开发"></a><div class="content"><a class="title" href="/2023/03/17/XuechengOnlinePart6/" title="学成在线--选课学习模块开发">学成在线--选课学习模块开发</a><time datetime="2023-03-27" title="发表于 2023-03-27">2023-03-27</time></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(135deg,#ace0f9,#a1c4fd)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Kyle Violet</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">The worst way to miss someone is to be sitting right beside her <br> knowing you can't have her.</div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><!--button#darkmode(type="button" title=_p('rightside.night_mode_title'))i.fas.fa-adjust--><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"><span id="percent">0<span>%</span></span></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'Cyborg2077/Cyborg2077.github.io',
    'data-repo-id': 'R_kgDOGflxEw',
    'data-category-id': 'DIC_kwDOGflxE84CRxKp',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !true) {
  if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><div class="aplayer no-destroy" data-id="6831019121" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><script async src="/js/diytitle.js"></script><script src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer data-pjax src="/js/readPercent.js"></script><script>var meting_api='https://api.injahow.cn/meting/?server=netease&type=playlist&id=8103908316'</script><script src="/js/sun_moon.js" async></script><script src="/js/chocolate.js" async></script><script src="/js/universe.js" async></script><canvas id="universe"></canvas><script id="canvas_nest" defer="defer" color="255,192,203" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法制,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-RQZSMGWCQS', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 190px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 160px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(http://p0.itc.cn/images03/20200525/332e1ea10c634cbfaf0dfc5b69d00a3c.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/力扣/&quot;);" href="javascript:void(0);">力扣</a><span class="categoryBar-list-count">12</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(http://p8.itc.cn/images03/20200525/377f4f7044fe49b0bb932f43ef4f4891.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/踩坑日记/&quot;);" href="javascript:void(0);">踩坑日记</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(http://p8.itc.cn/images03/20200525/0ed549edde2c4d5eaecc2824e753ca74.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/实用教程/&quot;);" href="javascript:void(0);">实用教程</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(http://p6.itc.cn/images03/20200525/8dedcdf6ace44a50a1deb6a9743821fe.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/刷题日志/&quot;);" href="javascript:void(0);">刷题日志</a><span class="categoryBar-list-count">14</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(http://p9.itc.cn/images03/20200525/07539bdba160465d80d23b3f16db8620.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/学习笔记/&quot;);" href="javascript:void(0);">学习笔记</a><span class="categoryBar-list-count">61</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(http://p8.itc.cn/images03/20200525/5f6cecf10ea04dec9a5d42bf9c4c3739.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/实战项目/&quot;);" href="javascript:void(0);">实战项目</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(http://p0.itc.cn/images03/20200525/332e1ea10c634cbfaf0dfc5b69d00a3c.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/面经/&quot;);" href="javascript:void(0);">面经</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(http://p8.itc.cn/images03/20200525/377f4f7044fe49b0bb932f43ef4f4891.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/蓝桥杯/&quot;);" href="javascript:void(0);">蓝桥杯</a><span class="categoryBar-list-count">8</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(http://p8.itc.cn/images03/20200525/0ed549edde2c4d5eaecc2824e753ca74.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/学习笔记/实战项目/&quot;);" href="javascript:void(0);">实战项目</a><span class="categoryBar-list-count">7</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(http://p6.itc.cn/images03/20200525/8dedcdf6ace44a50a1deb6a9743821fe.jpeg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/杂谈/&quot;);" href="javascript:void(0);">杂谈</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
      console.log('已挂载butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax>
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-clock/clock/images/weather/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><div id="ghbdages" style="overflow:hidden;max-height:90px;height:auto;text-align:center;margin-top:10px"><div class="swiper-wrapper"><div class="swiper-slide"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v5.4.0"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v4.1.0"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本站项目由Github托管"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a></div><div class="swiper-slide"><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></div></div></div><style>a.github-badge:hover:before {display:none}</style>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-footer-beautify/lib/swiperbdage_init.min.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/11/05/NewFeaturesOfJava8/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://pic2.zhimg.com/v2-d0a0172a71b6bc4ff18cd1f11bfa6b3b_r.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-11-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/11/05/NewFeaturesOfJava8/&quot;);" href="javascript:void(0);" alt="">Java 8新特性</a><div class="blog-slider__text">Java8新特性，之前只是草草看了一下，后来发现stream流操作挺好用的，来补一下票</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/11/05/NewFeaturesOfJava8/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/12/22/MeassageQueue/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://img0.baidu.com/it/u=1415156609,1199509453&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=949&amp;h=500" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-12-22</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/12/22/MeassageQueue/&quot;);" href="javascript:void(0);" alt="">MeassageQueue</a><div class="blog-slider__text">消息队列相关学习记录</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/12/22/MeassageQueue/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/12/21/Docker/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://img2.baidu.com/it/u=4052816064,1042373333&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=889&amp;h=500" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-12-21</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/12/21/Docker/&quot;);" href="javascript:void(0);" alt="">Docker</a><div class="blog-slider__text">Docker实用篇学习笔记</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/12/21/Docker/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/12/24/ElasticSearch/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://img2.baidu.com/it/u=852907915,3528076091&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=PNG?w=889&amp;h=500" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-12-24</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/12/24/ElasticSearch/&quot;);" href="javascript:void(0);" alt="">ElasticSearch</a><div class="blog-slider__text">分布式搜索引擎</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/12/24/ElasticSearch/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/11/08/SpringCloud/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://img1.baidu.com/it/u=2579164449,2431217981&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=800&amp;h=500" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-11-08</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/11/08/SpringCloud/&quot;);" href="javascript:void(0);" alt="">SpringCloud</a><div class="blog-slider__text">SpringCloud学习笔记</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/11/08/SpringCloud/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/09/29/ReggieTakeOut/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://img0.baidu.com/it/u=1144121390,2782791282&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=889&amp;h=500" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-09-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/09/29/ReggieTakeOut/&quot;);" href="javascript:void(0);" alt="">瑞吉外卖</a><div class="blog-slider__text">瑞吉外卖实战项目</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/09/29/ReggieTakeOut/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2022/10/22/RedisPractice/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://img0.baidu.com/it/u=4155835667,974645702&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=PNG?w=889&amp;h=500" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-10-22</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2022/10/22/RedisPractice/&quot;);" href="javascript:void(0);" alt="">Redis实战篇</a><div class="blog-slider__text">Redis实战篇，包含优惠券秒杀，分布式锁，消息队列用户签到等功能</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2022/10/22/RedisPractice/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/issues.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"log":false});</script></body></html>